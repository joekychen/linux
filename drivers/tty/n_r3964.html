<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › n_r3964.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>n_r3964.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* r3964 linediscipline for linux</span>
<span class="cm"> *</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> * Copyright by </span>
<span class="cm"> * Philips Automation Projects</span>
<span class="cm"> * Kassel (Germany)</span>
<span class="cm"> * -----------------------------------------------------------</span>
<span class="cm"> * This software may be used and distributed according to the terms of</span>
<span class="cm"> * the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> * L. Haag</span>
<span class="cm"> *</span>
<span class="cm"> * $Log: n_r3964.c,v $</span>
<span class="cm"> * Revision 1.10  2001/03/18 13:02:24  dwmw2</span>
<span class="cm"> * Fix timer usage, use spinlocks properly.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.9  2001/03/18 12:52:14  dwmw2</span>
<span class="cm"> * Merge changes in 2.4.2</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.8  2000/03/23 14:14:54  dwmw2</span>
<span class="cm"> * Fix race in sleeping in r3964_read()</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.7  1999/28/08 11:41:50  dwmw2</span>
<span class="cm"> * Port to 2.3 kernel</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.6  1998/09/30 00:40:40  dwmw2</span>
<span class="cm"> * Fixed compilation on 2.0.x kernels</span>
<span class="cm"> * Updated to newly registered tty-ldisc number 9</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.5  1998/09/04 21:57:36  dwmw2</span>
<span class="cm"> * Signal handling bug fixes, port to 2.1.x.</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.4  1998/04/02 20:26:59  lhaag</span>
<span class="cm"> * select, blocking, ...</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.3  1998/02/12 18:58:43  root</span>
<span class="cm"> * fixed some memory leaks</span>
<span class="cm"> * calculation of checksum characters</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.2  1998/02/07 13:03:34  root</span>
<span class="cm"> * ioctl read_telegram</span>
<span class="cm"> *</span>
<span class="cm"> * Revision 1.1  1998/02/06 19:21:03  root</span>
<span class="cm"> * Initial revision</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;	</span><span class="cm">/* used in new tty drivers */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/signal.h&gt;	</span><span class="cm">/* used in new tty drivers */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/n_r3964.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/*#define DEBUG_QUEUE*/</span>

<span class="cm">/* Log successful handshake and protocol operations  */</span>
<span class="cm">/*#define DEBUG_PROTO_S*/</span>

<span class="cm">/* Log handshake and protocol errors: */</span>
<span class="cm">/*#define DEBUG_PROTO_E*/</span>

<span class="cm">/* Log Linediscipline operations (open, close, read, write...): */</span>
<span class="cm">/*#define DEBUG_LDISC*/</span>

<span class="cm">/* Log module and memory operations (init, cleanup; kmalloc, kfree): */</span>
<span class="cm">/*#define DEBUG_MODUL*/</span>

<span class="cm">/* Macro helpers for debug output: */</span>
<span class="cp">#define TRACE(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>

<span class="cp">#ifdef DEBUG_MODUL</span>
<span class="cp">#define TRACE_M(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define TRACE_M(fmt, arg...) do {} while (0)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG_PROTO_S</span>
<span class="cp">#define TRACE_PS(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define TRACE_PS(fmt, arg...) do {} while (0)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG_PROTO_E</span>
<span class="cp">#define TRACE_PE(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define TRACE_PE(fmt, arg...) do {} while (0)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG_LDISC</span>
<span class="cp">#define TRACE_L(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define TRACE_L(fmt, arg...) do {} while (0)</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG_QUEUE</span>
<span class="cp">#define TRACE_Q(format, args...) printk(&quot;r3964: &quot; format &quot;\n&quot; , ## args)</span>
<span class="cp">#else</span>
<span class="cp">#define TRACE_Q(fmt, arg...) do {} while (0)</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_from_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">trigger_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">retry_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">transmit_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">receive_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">receive_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">on_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_telegram</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pBlock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">remove_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_client_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">r3964_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">r3964_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">r3964_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">r3964_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">r3964_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">r3964_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r3964_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">r3964_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">tty_ldisc_N_R3964</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;R3964&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">r3964_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">r3964_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">r3964_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">r3964_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">r3964_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">r3964_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">r3964_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf</span> <span class="o">=</span> <span class="n">r3964_receive_buf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_block</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">linebuf</span><span class="p">[</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">linebuf</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">block</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">linebuf</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">linebuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> * Driver initialisation</span>
<span class="cm"> *************************************************************/</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> * Module support routines</span>
<span class="cm"> *************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">r3964_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;cleanup_module()&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">tty_unregister_ldisc</span><span class="p">(</span><span class="n">N_R3964</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964: error unregistering linediscipline: &quot;</span>
				<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;linediscipline successfully unregistered&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">r3964_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r3964: Philips r3964 Driver $Revision: 1.10 $</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the tty line discipline</span>
<span class="cm">	 */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">tty_register_ldisc</span><span class="p">(</span><span class="n">N_R3964</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty_ldisc_N_R3964</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;line discipline %d registered&quot;</span><span class="p">,</span> <span class="n">N_R3964</span><span class="p">);</span>
		<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;flags=%x num=%x&quot;</span><span class="p">,</span> <span class="n">tty_ldisc_N_R3964</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
			<span class="n">tty_ldisc_N_R3964</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
		<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;open=%p&quot;</span><span class="p">,</span> <span class="n">tty_ldisc_N_R3964</span><span class="p">.</span><span class="n">open</span><span class="p">);</span>
		<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;tty_ldisc_N_R3964 = %p&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty_ldisc_N_R3964</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964: error registering line discipline: &quot;</span>
				<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">r3964_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">r3964_exit</span><span class="p">);</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> * Protocol implementation routines</span>
<span class="cm"> *************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;add_tx_queue %p, length %d, tx_first = %p&quot;</span><span class="p">,</span>
		<span class="n">pHeader</span><span class="p">,</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_from_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_QUEUE</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pDump</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pHeader</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHeader</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_QUEUE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r3964: remove_from_tx_queue: %p, length %u - &quot;</span><span class="p">,</span>
		<span class="n">pHeader</span><span class="p">,</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pDump</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span> <span class="n">pDump</span><span class="p">;</span> <span class="n">pDump</span> <span class="o">=</span> <span class="n">pDump</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%p &quot;</span><span class="p">,</span> <span class="n">pDump</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_msg</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">R3964_MSG_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">error_code</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">add_msg</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">R3964_MSG_ACK</span><span class="p">,</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				<span class="n">error_code</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">=</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pHeader</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;remove_from_tx_queue - kfree %p&quot;</span><span class="p">,</span> <span class="n">pHeader</span><span class="p">);</span>

	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;remove_from_tx_queue: tx_first = %p, tx_last = %p&quot;</span><span class="p">,</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="n">pHeader</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;add_rx_queue: %p, length = %d, rx_first = %p, count = %d&quot;</span><span class="p">,</span>
		<span class="n">pHeader</span><span class="p">,</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_from_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pFind</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pHeader</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;remove_from_rx_queue: rx_first = %p, rx_last = %p, count = %d&quot;</span><span class="p">,</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="p">);</span>
	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;remove_from_rx_queue: %p, length %u&quot;</span><span class="p">,</span>
		<span class="n">pHeader</span><span class="p">,</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">==</span> <span class="n">pHeader</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Remove the first block in the linked list: */</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">=</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Find block to remove: */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pFind</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span><span class="p">;</span> <span class="n">pFind</span><span class="p">;</span> <span class="n">pFind</span> <span class="o">=</span> <span class="n">pFind</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pFind</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">pHeader</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Got it. */</span>
				<span class="n">pFind</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pFind</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Oh, removed the last one! */</span>
					<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="n">pFind</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pHeader</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;remove_from_rx_queue - kfree %p&quot;</span><span class="p">,</span> <span class="n">pHeader</span><span class="p">);</span>

	<span class="n">TRACE_Q</span><span class="p">(</span><span class="s">&quot;remove_from_rx_queue: rx_first = %p, rx_last = %p, count = %d&quot;</span><span class="p">,</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>
	<span class="cm">/* FIXME: put_char should not be called from an IRQ */</span>
	<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">^=</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trigger_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">R3964_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_TX_REQUEST</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R3964_ERROR</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_QVZ</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;trigger_transmit - sent STX&quot;</span><span class="p">);</span>

		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">STX</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>

		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">retry_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">&lt;</span> <span class="n">R3964_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;transmission failed. Retry #%d&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">STX</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_TX_REQUEST</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_QVZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;transmission failed after %d retries&quot;</span><span class="p">,</span>
			 <span class="n">R3964_MAX_RETRIES</span><span class="p">);</span>

		<span class="n">remove_from_tx_queue</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">R3964_TX_FAIL</span><span class="p">);</span>

		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>

		<span class="n">trigger_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmit_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pBlock</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pBlock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">room</span> <span class="o">=</span> <span class="n">tty_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;transmit_block %p, room %d, length %d&quot;</span><span class="p">,</span>
		 <span class="n">pBlock</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span> <span class="o">&lt;</span> <span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span><span class="p">]</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send additional DLE char: */</span>
			<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">DLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span><span class="o">++</span><span class="p">]);</span>

		<span class="n">room</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span> <span class="o">==</span> <span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">room</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">DLE</span><span class="p">);</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">ETX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_BCC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_WAIT_FOR_TX_ACK</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_QVZ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">on_receive_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pBlock</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span><span class="p">;</span>

	<span class="cm">/* compare byte checksum characters: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_BCC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">!=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;checksum error - got %x but expected %x&quot;</span><span class="p">,</span>
				 <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span><span class="p">);</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_CHECKSUM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check for errors (parity, overrun,...): */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;on_receive_block - transmission failed error %x&quot;</span><span class="p">,</span>
			 <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_ERROR</span><span class="p">);</span>

		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">&lt;</span> <span class="n">R3964_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_WAIT_FOR_RX_REPEAT</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_RX_PANIC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;on_receive_block - failed after max retries&quot;</span><span class="p">);</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* received block; submit DLE: */</span>
	<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">DLE</span><span class="p">);</span>
	<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">);</span>
	<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot; rx success: got %d chars&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* prepare struct r3964_block_header: */</span>
	<span class="n">pBlock</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_block_header</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;on_receive_block - kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pBlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pBlock</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pBlock</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_block_header</span><span class="p">);</span>
	<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">locks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* queue block into rx_queue: */</span>
	<span class="n">add_rx_queue</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pBlock</span><span class="p">);</span>

	<span class="cm">/* notify attached client processes: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pClient</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span><span class="p">;</span> <span class="n">pClient</span><span class="p">;</span> <span class="n">pClient</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">sig_flags</span> <span class="o">&amp;</span> <span class="n">R3964_SIG_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_msg</span><span class="p">(</span><span class="n">pClient</span><span class="p">,</span> <span class="n">R3964_MSG_DATA</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">R3964_OK</span><span class="p">,</span>
				<span class="n">pBlock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>

	<span class="n">trigger_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">R3964_TX_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;TX_REQUEST - got DLE&quot;</span><span class="p">);</span>

			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_TRANSMITTING</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">transmit_block</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">STX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TX_REQUEST - init conflict&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">==</span> <span class="n">R3964_SLAVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">start_receiving</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TX_REQUEST - secondary init &quot;</span>
					<span class="s">&quot;conflict!? Switching to SLAVE mode &quot;</span>
					<span class="s">&quot;for next rx.&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">start_receiving</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TX_REQUEST - char != DLE: %x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_TRANSMITTING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">NAK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TRANSMITTING - got NAK&quot;</span><span class="p">);</span>
			<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TRANSMITTING - got invalid char&quot;</span><span class="p">);</span>

			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_WAIT_ZVZ_BEFORE_TX_RETRY</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_ZVZ</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_TX_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;WAIT_FOR_TX_ACK - got DLE&quot;</span><span class="p">);</span>
			<span class="n">remove_from_tx_queue</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">R3964_OK</span><span class="p">);</span>

			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
			<span class="n">trigger_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_RX_REPEAT</span>:
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">R3964_IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">STX</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Prevent rx_queue from overflow: */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span> <span class="o">&gt;=</span>
			    <span class="n">R3964_MAX_BLOCKS_IN_RX_QUEUE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;IDLE - got STX but no space in &quot;</span>
						<span class="s">&quot;rx_queue!&quot;</span><span class="p">);</span>
				<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_WAIT_FOR_RX_BUF</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span>
					  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_NO_BUF</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="nl">start_receiving:</span>
			<span class="cm">/* Ok, start receiving: */</span>
			<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;IDLE - got STX&quot;</span><span class="p">);</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R3964_ERROR</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_RECEIVING</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_ZVZ</span><span class="p">);</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">DLE</span><span class="p">);</span>
			<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_RECEIVING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span> <span class="o">&lt;</span> <span class="n">RX_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">bcc</span> <span class="o">^=</span> <span class="n">c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">char_to_buf</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">DLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">==</span> <span class="n">ETX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_BCC</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_WAIT_FOR_BCC</span><span class="p">;</span>
					<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span>
						  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_ZVZ</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">on_receive_block</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="nl">char_to_buf:</span>
				<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">R3964_TO_ZVZ</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* else: overflow-msg? BUF_SIZE&gt;MTU; should not happen? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_BCC</span>:
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">on_receive_block</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTY_NORMAL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTY_BREAK</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;received break&quot;</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_BREAK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTY_PARITY</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;parity error&quot;</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_PARITY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTY_FRAME</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;frame error&quot;</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_FRAME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTY_OVERRUN</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;frame overrun&quot;</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_OVERRUN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;receive_error - unknown flag %d&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">on_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">R3964_TX_REQUEST</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;TX_REQUEST - timeout&quot;</span><span class="p">);</span>
		<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_ZVZ_BEFORE_TX_RETRY</span>:
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_TX_ACK</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;WAIT_FOR_TX_ACK - timeout&quot;</span><span class="p">);</span>
		<span class="n">retry_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_RX_BUF</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;WAIT_FOR_RX_BUF - timeout&quot;</span><span class="p">);</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_RECEIVING</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;RECEIVING - timeout after %d chars&quot;</span><span class="p">,</span>
			 <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span><span class="p">);</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_RX_REPEAT</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;WAIT_FOR_RX_REPEAT - timeout&quot;</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_WAIT_FOR_BCC</span>:
		<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;WAIT_FOR_BCC - timeout&quot;</span><span class="p">);</span>
		<span class="n">put_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">NAK</span><span class="p">);</span>
		<span class="n">flush</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="nf">findClient</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pClient</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span><span class="p">;</span> <span class="n">pClient</span><span class="p">;</span> <span class="n">pClient</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">pClient</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_signals</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">**</span><span class="n">ppClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">R3964_SIG_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Remove client from client list */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ppClient</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span><span class="p">;</span> <span class="o">*</span><span class="n">ppClient</span><span class="p">;</span>
		     <span class="n">ppClient</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">ppClient</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pClient</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppClient</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;removing client %d from client list&quot;</span><span class="p">,</span>
					 <span class="n">pid_nr</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
				<span class="o">*</span><span class="n">ppClient</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pMsg</span> <span class="o">=</span> <span class="n">remove_msg</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">kfree</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span>
						<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;enable_signals - msg &quot;</span>
							<span class="s">&quot;kfree %p&quot;</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">put_pid</span><span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pClient</span><span class="p">);</span>
				<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;enable_signals - kfree %p&quot;</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pClient</span> <span class="o">=</span> <span class="n">findClient</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* update signal options */</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">sig_flags</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* add client to client list */</span>
			<span class="n">pClient</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_client_info</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;enable_signals - kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;add client %d to client list&quot;</span><span class="p">,</span> <span class="n">pid_nr</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">sig_flags</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">get_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next_block_to_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span> <span class="o">=</span> <span class="n">pClient</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_telegram</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">pid</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pClient</span> <span class="o">=</span> <span class="n">findClient</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next_block_to_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">remove_client_block</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pBlock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span> <span class="o">&lt;</span> <span class="n">R3964_MAX_MSG_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">queue_the_message:</span>

		<span class="n">pMsg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_message</span><span class="p">),</span>
				<span class="n">error_code</span> <span class="o">?</span> <span class="n">GFP_ATOMIC</span> <span class="o">:</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;add_msg - kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg_id</span><span class="p">;</span>
		<span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span><span class="p">;</span>
		<span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">block</span> <span class="o">=</span> <span class="n">pBlock</span><span class="p">;</span>
		<span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span> <span class="o">=</span> <span class="n">pMsg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pMsg</span><span class="p">;</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span> <span class="o">=</span> <span class="n">pMsg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pBlock</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pBlock</span><span class="o">-&gt;</span><span class="n">locks</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">==</span> <span class="n">R3964_MSG_ACK</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span><span class="o">-&gt;</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">R3964_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span><span class="o">-&gt;</span><span class="n">arg</span><span class="o">++</span><span class="p">;</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;add_msg - inc prev OVERFLOW-msg&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msg_id</span> <span class="o">=</span> <span class="n">R3964_MSG_ACK</span><span class="p">;</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">error_code</span> <span class="o">=</span> <span class="n">R3964_OVERFLOW</span><span class="p">;</span>
			<span class="n">pBlock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">TRACE_PE</span><span class="p">(</span><span class="s">&quot;add_msg - queue OVERFLOW-msg&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">queue_the_message</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Send SIGIO signal to client process: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">sig_flags</span> <span class="o">&amp;</span> <span class="n">R3964_USE_SIGIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kill_pid</span><span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="nf">remove_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">pMsg</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span><span class="p">;</span>
		<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span> <span class="o">=</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">last_msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_client_block</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
			<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next_block_to_read</span> <span class="o">=</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pMsg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_client_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;remove_client_block PID %d&quot;</span><span class="p">,</span> <span class="n">pid_nr</span><span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">));</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next_block_to_read</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block</span><span class="o">-&gt;</span><span class="n">locks</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">locks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">remove_from_rx_queue</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next_block_to_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> * Line discipline routines</span>
<span class="cm"> *************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r3964_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">;</span>

	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">);</span>
	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;tty=%p, PID=%d, disc_data=%p&quot;</span><span class="p">,</span>
		<span class="n">tty</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">);</span>

	<span class="n">pInfo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - info kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pInfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964: failed to alloc info structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RX_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - rx_buf kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964: failed to alloc receive buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - info kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">TX_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - tx_buf kmalloc %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964: failed to alloc transmit buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - rx_buf kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_open - info kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">R3964_MASTER</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_first</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">blocks_in_rx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">R3964_IDLE</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">R3964_DEBUG</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nRetry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="n">pInfo</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">,</span> <span class="n">on_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pInfo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r3964_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">,</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">,</span> <span class="o">*</span><span class="n">pNextHeader</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that our task queue isn&#39;t activated.  If it</span>
<span class="cm">	 * is, take it out of the linked list.</span>
<span class="cm">	 */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tmr</span><span class="p">);</span>

	<span class="cm">/* Remove client-structs and message queues: */</span>
	<span class="n">pClient</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">firstClient</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pClient</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pNext</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">msg_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pMsg</span> <span class="o">=</span> <span class="n">remove_msg</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span>
				<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_close - msg kfree %p&quot;</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">put_pid</span><span class="p">(</span><span class="n">pClient</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pClient</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_close - client kfree %p&quot;</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
		<span class="n">pClient</span> <span class="o">=</span> <span class="n">pNext</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Remove jobs from tx_queue: */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pHeader</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span><span class="p">;</span>
	<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_first</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pHeader</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pNextHeader</span> <span class="o">=</span> <span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pHeader</span><span class="p">);</span>
		<span class="n">pHeader</span> <span class="o">=</span> <span class="n">pNextHeader</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free buffers: */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_close - rx_buf kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_close - tx_buf kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_close - info kfree %p&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">r3964_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_message</span> <span class="n">theMsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;read()&quot;</span><span class="p">);</span>

	<span class="n">tty_lock</span><span class="p">();</span>

	<span class="n">pClient</span> <span class="o">=</span> <span class="n">findClient</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pMsg</span> <span class="o">=</span> <span class="n">remove_msg</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no messages available. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* block until there is a message: */</span>
			<span class="n">wait_event_interruptible_tty</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span>
					<span class="p">(</span><span class="n">pMsg</span> <span class="o">=</span> <span class="n">remove_msg</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pClient</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="cm">/* If we still haven&#39;t got a message, we must have been signalled */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pMsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* deliver msg to client process: */</span>
		<span class="n">theMsg</span><span class="p">.</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">msg_id</span><span class="p">;</span>
		<span class="n">theMsg</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="n">theMsg</span><span class="p">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_client_message</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span>
		<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_read - msg kfree %p&quot;</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">theMsg</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">TRACE_PS</span><span class="p">(</span><span class="s">&quot;read - return %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="nl">unlock:</span>
	<span class="n">tty_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">r3964_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="n">pHeader</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_data</span><span class="p">;</span>

	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;write request, %d characters&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cm">/* </span>
<span class="cm"> * Verify the pointers </span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pInfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Ensure that the caller does not wish to send too much.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">R3964_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_DEBUG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_L</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;r3964_write: truncating user &quot;</span>
				<span class="s">&quot;packet from %u to mtu %d&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">R3964_MTU</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">R3964_MTU</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Allocate a buffer for the data and copy it from the buffer with header prepended</span>
<span class="cm"> */</span>
	<span class="n">new_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_block_header</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">TRACE_M</span><span class="p">(</span><span class="s">&quot;r3964_write - kmalloc %p&quot;</span><span class="p">,</span> <span class="n">new_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_DEBUG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;r3964_write: no memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pHeader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r3964_block_header</span> <span class="o">*</span><span class="p">)</span><span class="n">new_data</span><span class="p">;</span>
	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">new_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">r3964_block_header</span><span class="p">);</span>
	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">locks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tty_lock</span><span class="p">();</span>

	<span class="n">pClient</span> <span class="o">=</span> <span class="n">findClient</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">pClient</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>	<span class="cm">/* We already verified this */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">R3964_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_block</span><span class="p">(</span><span class="n">pHeader</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add buffer to transmit-queue:</span>
<span class="cm"> */</span>
	<span class="n">add_tx_queue</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">pHeader</span><span class="p">);</span>
	<span class="n">trigger_transmit</span><span class="p">(</span><span class="n">pInfo</span><span class="p">);</span>

	<span class="n">tty_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r3964_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">R3964_ENABLE_SIGNALS</span>:
		<span class="k">return</span> <span class="n">enable_signals</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">R3964_SETPRIORITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">R3964_MASTER</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">&gt;</span> <span class="n">R3964_SLAVE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_USE_BCC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">R3964_BCC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R3964_BCC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R3964_READ_TELEGRAM</span>:
		<span class="k">return</span> <span class="n">read_telegram</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r3964_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;set_termios&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called without the kernel lock held - fine */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">r3964_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_client_info</span> <span class="o">*</span><span class="n">pClient</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r3964_message</span> <span class="o">*</span><span class="n">pMsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">POLLOUT</span><span class="p">;</span>

	<span class="n">TRACE_L</span><span class="p">(</span><span class="s">&quot;POLL&quot;</span><span class="p">);</span>

	<span class="n">pClient</span> <span class="o">=</span> <span class="n">findClient</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">task_pid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pClient</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pMsg</span> <span class="o">=</span> <span class="n">pClient</span><span class="o">-&gt;</span><span class="n">first_msg</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pMsg</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r3964_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r3964_info</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">cp</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">f</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="n">TTY_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">receive_char</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">receive_error</span><span class="p">(</span><span class="n">pInfo</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_LDISC</span><span class="p">(</span><span class="n">N_R3964</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
