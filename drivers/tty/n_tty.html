<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › n_tty.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>n_tty.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * n_tty.c --- implements the N_TTY line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * This code used to be in tty_io.c, but things are getting hairy</span>
<span class="cm"> * enough that it made sense to split things off.  (The N_TTY</span>
<span class="cm"> * processing has changed so much that it&#39;s hardly recognizable,</span>
<span class="cm"> * anyway...)</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the open routine for N_TTY is guaranteed never to return</span>
<span class="cm"> * an error.  This is because Linux will fall back to setting a line</span>
<span class="cm"> * to N_TTY if it can not switch to any other line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Theodore Ts&#39;o, Copyright 1994.</span>
<span class="cm"> *</span>
<span class="cm"> * This file also contains code originally written by Linus Torvalds,</span>
<span class="cm"> * Copyright 1991, 1992, 1993, and by Julian Cowley, Copyright 1994.</span>
<span class="cm"> *</span>
<span class="cm"> * This file may be redistributed under the terms of the GNU General Public</span>
<span class="cm"> * License.</span>
<span class="cm"> *</span>
<span class="cm"> * Reduced memory usage for older ARM systems  - Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/01/20   Fixed SMP locking on put_tty_queue using bits of</span>
<span class="cm"> *		the patch by Andrew J. Kroll &lt;ag784@freenet.buffalo.edu&gt;</span>
<span class="cm"> *		who actually finally proved there really was a race.</span>
<span class="cm"> *</span>
<span class="cm"> * 2002/03/18   Implemented n_tty_wakeup to send SIGIO POLL_OUTs to</span>
<span class="cm"> *		waiting writing processes-Sapan Bhatia &lt;sapan@corewars.org&gt;.</span>
<span class="cm"> *		Also fixed a bug in BLOCKING mode where n_tty_write returns</span>
<span class="cm"> *		EAGAIN</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>


<span class="cm">/* number of characters left in xmit buffer before select has we have room */</span>
<span class="cp">#define WAKEUP_CHARS 256</span>

<span class="cm">/*</span>
<span class="cm"> * This defines the low- and high-watermarks for throttling and</span>
<span class="cm"> * unthrottling the TTY driver.  These watermarks are used for</span>
<span class="cm"> * controlling the space in the read buffer.</span>
<span class="cm"> */</span>
<span class="cp">#define TTY_THRESHOLD_THROTTLE		128 </span><span class="cm">/* now based on remaining room */</span><span class="cp"></span>
<span class="cp">#define TTY_THRESHOLD_UNTHROTTLE	128</span>

<span class="cm">/*</span>
<span class="cm"> * Special byte codes used in the echo buffer to represent operations</span>
<span class="cm"> * or special handling of characters.  Bytes in the echo buffer that</span>
<span class="cm"> * are not part of such special blocks are treated as normal character</span>
<span class="cm"> * codes.</span>
<span class="cm"> */</span>
<span class="cp">#define ECHO_OP_START 0xff</span>
<span class="cp">#define ECHO_OP_MOVE_BACK_COL 0x80</span>
<span class="cp">#define ECHO_OP_SET_CANON_COL 0x81</span>
<span class="cp">#define ECHO_OP_ERASE_TAB 0x82</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tty_put_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty_audit_add_data</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_set__room	-	receive space</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Called by the driver to find out how much data it is</span>
<span class="cm"> *	permitted to feed to the line discipline without any being lost</span>
<span class="cm"> *	and thus to manage flow control. Not serialized. Answers for the</span>
<span class="cm"> *	&quot;instant&quot;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_set_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* tty-&gt;read_cnt is not read locked ? */</span>
	<span class="kt">int</span>	<span class="n">left</span> <span class="o">=</span> <span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_left</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are doing input canonicalization, and there are no</span>
<span class="cm">	 * pending newlines, let characters through without limit, so</span>
<span class="cm">	 * that erase characters will be handled.  Other excess</span>
<span class="cm">	 * characters will be beeped.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span><span class="p">;</span>
	<span class="n">old_left</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

	<span class="cm">/* Did this open up the receive buffer? We may need to flip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">old_left</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_tty_queue_nolock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&lt;</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	put_tty_queue		-	add character to tty</span>
<span class="cm"> *	@c: character</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *</span>
<span class="cm"> *	Add a character to the tty read_buf queue. This is done under the</span>
<span class="cm"> *	read_lock to serialize character addition and also to protect us</span>
<span class="cm"> *	against parallel reads or flushes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_tty_queue</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 *	The problem of stomping on the buffers ends here.</span>
<span class="cm">	 *	Why didn&#39;t anyone see this one coming? --AJK</span>
<span class="cm">	*/</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">put_tty_queue_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	check_unthrottle	-	allow new receive data</span>
<span class="cm"> *	@tty; tty device</span>
<span class="cm"> *</span>
<span class="cm"> *	Check whether to call the driver unthrottle functions</span>
<span class="cm"> *</span>
<span class="cm"> *	Can sleep, may be called under the atomic_read_lock mutex but</span>
<span class="cm"> *	this is not guaranteed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="n">tty_unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	reset_buffer_flags	-	reset buffer state</span>
<span class="cm"> *	@tty: terminal to reset</span>
<span class="cm"> *</span>
<span class="cm"> *	Reset the read buffer counters, clear the flags,</span>
<span class="cm"> *	and make sure the driver is unthrottled. Called</span>
<span class="cm"> *	from n_tty_open() and n_tty_flush_buffer().</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: tty_read_lock for read fields.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_buffer_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">);</span>
	<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_flush_buffer	-	clean input queue</span>
<span class="cm"> *	@tty:	terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Flush the input buffer. Called when the line discipline is</span>
<span class="cm"> *	being closed, when the tty layer wants the buffer flushed (eg</span>
<span class="cm"> *	at hangup) or when the N_TTY line discipline internally has to</span>
<span class="cm"> *	clean the pending queue (for example some signals).</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: ctrl_lock, read_lock.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* clear everything and unthrottle the driver */</span>
	<span class="n">reset_buffer_flags</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">|=</span> <span class="n">TIOCPKT_FLUSHREAD</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_chars_in_buffer	-	report available bytes</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *</span>
<span class="cm"> *	Report the number of characters buffered to be delivered to user</span>
<span class="cm"> *	at this instant in time.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: read_lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">n_tty_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">&gt;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span> <span class="o">:</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">+</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	is_utf8_continuation	-	utf8 multibyte check</span>
<span class="cm"> *	@c: byte to check</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns true if the utf8 character &#39;c&#39; is a multibyte continuation</span>
<span class="cm"> *	character. We use this to correctly compute the on screen size</span>
<span class="cm"> *	of the character when printing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_utf8_continuation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	is_continuation		-	multibyte check</span>
<span class="cm"> *	@c: byte to check</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns true if the utf8 character &#39;c&#39; is a multibyte continuation</span>
<span class="cm"> *	character and the terminal is in unicode mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_continuation</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I_IUTF8</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_utf8_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	do_output_char			-	output one character</span>
<span class="cm"> *	@c: character (or partial unicode symbol)</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@space: space available in tty driver write buffer</span>
<span class="cm"> *</span>
<span class="cm"> *	This is a helper function that handles one output character</span>
<span class="cm"> *	(including special characters like TAB, CR, LF, etc.),</span>
<span class="cm"> *	doing OPOST processing and putting the results in the</span>
<span class="cm"> *	tty driver&#39;s write buffer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note that Linux currently ignores TABDLY, CRDLY, VTDLY, FFDLY</span>
<span class="cm"> *	and NLDLY.  They simply aren&#39;t relevant in the world today.</span>
<span class="cm"> *	If you ever need them, add them here.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the number of bytes of buffer space used or -1 if</span>
<span class="cm"> *	no space left.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: should be called under the output_lock to protect</span>
<span class="cm"> *		 the column state and space left in the buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_output_char</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">spaces</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">space</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">O_ONLRET</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">O_ONLCR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">O_ONOCR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">O_OCRNL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">O_ONLRET</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;\t&#39;</span>:
		<span class="n">spaces</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">O_TABDLY</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">==</span> <span class="n">XTABS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="n">spaces</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="n">spaces</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="s">&quot;        &quot;</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">spaces</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="n">spaces</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;\b&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">O_OLCUC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">))</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	process_output			-	output post processor</span>
<span class="cm"> *	@c: character (or partial unicode symbol)</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Output one character with OPOST processing.</span>
<span class="cm"> *	Returns -1 when the output device is full and the character</span>
<span class="cm"> *	must be retried.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: output_lock to protect column state and space left</span>
<span class="cm"> *		 (also, this is called from n_tty_write under the</span>
<span class="cm"> *		  tty layer write lock)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_output</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">space</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>

	<span class="n">space</span> <span class="o">=</span> <span class="n">tty_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">do_output_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	process_output_block		-	block post processor</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@buf: character buffer</span>
<span class="cm"> *	@nr: number of bytes to output</span>
<span class="cm"> *</span>
<span class="cm"> *	Output a block of characters with OPOST processing.</span>
<span class="cm"> *	Returns the number of characters output.</span>
<span class="cm"> *</span>
<span class="cm"> *	This path is used to speed up block console writes, among other</span>
<span class="cm"> *	things when processing blocks of output data. It handles only</span>
<span class="cm"> *	the simple cases normally found and helps to generate blocks of</span>
<span class="cm"> *	symbols for the console driver and thus improve performance.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: output_lock to protect column state and space left</span>
<span class="cm"> *		 (also, this is called from n_tty_write under the</span>
<span class="cm"> *		  tty layer write lock)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">process_output_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">space</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>

	<span class="n">space</span> <span class="o">=</span> <span class="n">tty_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">space</span><span class="p">)</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">space</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">O_ONLRET</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">O_ONLCR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">O_ONOCR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">O_OCRNL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\t&#39;</span>:
			<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\b&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">O_OLCUC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">))</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">break_out:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	process_echoes	-	write pending echo characters</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Write previously buffered echo (and other ldisc-generated)</span>
<span class="cm"> *	characters to the tty.</span>
<span class="cm"> *</span>
<span class="cm"> *	Characters generated by the ldisc (including echoes) need to</span>
<span class="cm"> *	be buffered because the driver&#39;s write buffer can fill during</span>
<span class="cm"> *	heavy program output.  Echoing straight to the driver will</span>
<span class="cm"> *	often fail under these conditions, causing lost characters and</span>
<span class="cm"> *	resulting mismatches of ldisc state information.</span>
<span class="cm"> *</span>
<span class="cm"> *	Since the ldisc state must represent the characters actually sent</span>
<span class="cm"> *	to the driver at the time of the write, operations like certain</span>
<span class="cm"> *	changes in column state are also saved in the buffer and executed</span>
<span class="cm"> *	here.</span>
<span class="cm"> *</span>
<span class="cm"> *	A circular fifo buffer is used so that the most recent characters</span>
<span class="cm"> *	are prioritized.  Also, when control characters are echoed with a</span>
<span class="cm"> *	prefixed &quot;^&quot;, the pair is treated atomically and thus not separated.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: output_lock to protect column state and space left,</span>
<span class="cm"> *		 echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_echoes</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">space</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">buf_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="n">space</span> <span class="o">=</span> <span class="n">tty_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">buf_end</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span> <span class="o">+</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">;</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span><span class="p">;</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">ECHO_OP_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">op</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">no_space_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If the buffer byte is the start of a multi-byte</span>
<span class="cm">			 * operation, get the next byte, which is either the</span>
<span class="cm">			 * op code or a control character value.</span>
<span class="cm">			 */</span>
			<span class="n">opp</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">==</span> <span class="n">buf_end</span><span class="p">)</span>
				<span class="n">opp</span> <span class="o">-=</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">;</span>
			<span class="n">op</span> <span class="o">=</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_chars</span><span class="p">,</span> <span class="n">num_bs</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ECHO_OP_ERASE_TAB</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">opp</span> <span class="o">==</span> <span class="n">buf_end</span><span class="p">)</span>
					<span class="n">opp</span> <span class="o">-=</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">;</span>
				<span class="n">num_chars</span> <span class="o">=</span> <span class="o">*</span><span class="n">opp</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Determine how many columns to go back</span>
<span class="cm">				 * in order to erase the tab.</span>
<span class="cm">				 * This depends on the number of columns</span>
<span class="cm">				 * used by other characters within the tab</span>
<span class="cm">				 * area.  If this (modulo 8) count is from</span>
<span class="cm">				 * the start of input rather than from a</span>
<span class="cm">				 * previous tab, we offset by canon column.</span>
<span class="cm">				 * Otherwise, tab spacing is normal.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">num_chars</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
					<span class="n">num_chars</span> <span class="o">+=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span><span class="p">;</span>
				<span class="n">num_bs</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_chars</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">num_bs</span> <span class="o">&gt;</span> <span class="n">space</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">no_space_left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">space</span> <span class="o">-=</span> <span class="n">num_bs</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">num_bs</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="sc">&#39;\b&#39;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ECHO_OP_SET_CANON_COL</span>:
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_column</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ECHO_OP_MOVE_BACK_COL</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">--</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ECHO_OP_START</span>:
				<span class="cm">/* This is an escaped echo op start code */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">space</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">no_space_left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ECHO_OP_START</span><span class="p">);</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span><span class="o">++</span><span class="p">;</span>
				<span class="n">space</span><span class="o">--</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="cm">/*</span>
<span class="cm">				 * If the op is not a special byte code,</span>
<span class="cm">				 * it is a ctrl char tagged to be echoed</span>
<span class="cm">				 * as &quot;^X&quot; (where X is the letter</span>
<span class="cm">				 * representing the control char).</span>
<span class="cm">				 * Note that we must ensure there is</span>
<span class="cm">				 * enough space for the whole ctrl pair.</span>
<span class="cm">				 *</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">no_space_left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="sc">&#39;^&#39;</span><span class="p">);</span>
				<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">op</span> <span class="o">^</span> <span class="mo">0100</span><span class="p">);</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">space</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">no_space_left</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">O_OPOST</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_HW_COOK_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">do_output_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">space</span> <span class="o">-=</span> <span class="n">retval</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">space</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">tty_put_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
				<span class="n">space</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nr</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* When end of circular buffer reached, wrap around */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">&gt;=</span> <span class="n">buf_end</span><span class="p">)</span>
			<span class="n">cp</span> <span class="o">-=</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num_processed</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">-</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">+=</span> <span class="n">num_processed</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">&amp;=</span> <span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_processed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">output_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	add_echo_byte	-	add a byte to the echo buffer</span>
<span class="cm"> *	@c: unicode byte to echo</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Add a character or operation byte to the echo buffer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Should be called under the echo lock to protect the echo buffer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_echo_byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">new_byte_pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">==</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Circular buffer is already at capacity */</span>
		<span class="n">new_byte_pos</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Since the buffer start position needs to be advanced,</span>
<span class="cm">		 * be sure to step by a whole operation byte group.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">ECHO_OP_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">[(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					  <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">==</span>
						<span class="n">ECHO_OP_ERASE_TAB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">&amp;=</span> <span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_overrun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new_byte_pos</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_pos</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span><span class="p">;</span>
		<span class="n">new_byte_pos</span> <span class="o">&amp;=</span> <span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">[</span><span class="n">new_byte_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	echo_move_back_col	-	add operation to move back a column</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Add an operation to the echo buffer to move back one column.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">echo_move_back_col</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_MOVE_BACK_COL</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	echo_set_canon_col	-	add operation to set the canon column</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Add an operation to the echo buffer to set the canon column</span>
<span class="cm"> *	to the current column.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">echo_set_canon_col</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_SET_CANON_COL</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	echo_erase_tab	-	add operation to erase a tab</span>
<span class="cm"> *	@num_chars: number of character columns already used</span>
<span class="cm"> *	@after_tab: true if num_chars starts after a previous tab</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Add an operation to the echo buffer to erase a tab.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called by the eraser function, which knows how many character</span>
<span class="cm"> *	columns have been used since either a previous tab or the start</span>
<span class="cm"> *	of input.  This information will be used later, along with</span>
<span class="cm"> *	canon column (if applicable), to go back the correct number</span>
<span class="cm"> *	of columns.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">echo_erase_tab</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_chars</span><span class="p">,</span> <span class="kt">int</span> <span class="n">after_tab</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_ERASE_TAB</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* We only need to know this modulo 8 (tab spacing) */</span>
	<span class="n">num_chars</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="cm">/* Set the high bit as a flag if num_chars is after a previous tab */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">after_tab</span><span class="p">)</span>
		<span class="n">num_chars</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">num_chars</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	echo_char_raw	-	echo a character raw</span>
<span class="cm"> *	@c: unicode byte to echo</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Echo user input back onto the screen. This must be called only when</span>
<span class="cm"> *	L_ECHO(tty) is true. Called from the driver receive_buf path.</span>
<span class="cm"> *</span>
<span class="cm"> *	This variant does not treat control characters specially.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">echo_char_raw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">ECHO_OP_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	echo_char	-	echo a character</span>
<span class="cm"> *	@c: unicode byte to echo</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Echo user input back onto the screen. This must be called only when</span>
<span class="cm"> *	L_ECHO(tty) is true. Called from the driver receive_buf path.</span>
<span class="cm"> *</span>
<span class="cm"> *	This variant tags control characters to be echoed as &quot;^X&quot;</span>
<span class="cm"> *	(where X is the letter representing the control char).</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: echo_lock to protect the echo buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">echo_char</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">ECHO_OP_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHOCTL</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span>
			<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">ECHO_OP_START</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">add_echo_byte</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	finish_erasing		-	complete erase</span>
<span class="cm"> *	@tty: tty doing the erase</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">finish_erasing</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	eraser		-	handle erase function</span>
<span class="cm"> *	@c: character input</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform erase and necessary output when an erase character is</span>
<span class="cm"> *	present in the stream from the driver layer. Handles the complexities</span>
<span class="cm"> *	of UTF-8 multibyte symbols.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: read_lock for tty buffers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eraser</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">ERASE</span><span class="p">,</span> <span class="n">WERASE</span><span class="p">,</span> <span class="n">KILL</span> <span class="p">}</span> <span class="n">kill_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="n">seen_alnums</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* FIXME: locking needed ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">==</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* process_output(&#39;\a&#39;, tty); */</span> <span class="cm">/* what do you think? */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">ERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">kill_type</span> <span class="o">=</span> <span class="n">ERASE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">WERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">kill_type</span> <span class="o">=</span> <span class="n">WERASE</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">-=</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">)</span> <span class="o">&amp;</span>
					  <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">L_ECHOK</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">L_ECHOKE</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">L_ECHOE</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">-=</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">)</span> <span class="o">&amp;</span>
					  <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">echo_char</span><span class="p">(</span><span class="n">KILL_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="p">);</span>
			<span class="cm">/* Add a newline if ECHOK is on and ECHOKE is off. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHOK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kill_type</span> <span class="o">=</span> <span class="n">KILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seen_alnums</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* FIXME: Locking ?? */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">;</span>

		<span class="cm">/* erase a single possibly multibyte character */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">is_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">head</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">);</span>

		<span class="cm">/* do not partially erase */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kill_type</span> <span class="o">==</span> <span class="n">WERASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Equivalent to BSD&#39;s ALTWERASE. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
				<span class="n">seen_alnums</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seen_alnums</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">-</span> <span class="n">head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHOPRT</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\\&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* if cnt &gt; 1, output a multi-byte character */</span>
				<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">head</span><span class="p">],</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_move_back_col</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kill_type</span> <span class="o">==</span> <span class="n">ERASE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">L_ECHOE</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">echo_char</span><span class="p">(</span><span class="n">ERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">after_tab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Count the columns used for characters</span>
<span class="cm">				 * since the start of input or after a</span>
<span class="cm">				 * previous tab.</span>
<span class="cm">				 * This info is used to go back the correct</span>
<span class="cm">				 * number of columns.</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">tail</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
					<span class="n">c</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tail</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">after_tab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHOCTL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
							<span class="n">num_chars</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_continuation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">num_chars</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">echo_erase_tab</span><span class="p">(</span><span class="n">num_chars</span><span class="p">,</span> <span class="n">after_tab</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_ECHOCTL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">L_ECHOCTL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kill_type</span> <span class="o">==</span> <span class="n">ERASE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">==</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">&amp;&amp;</span> <span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	isig		-	handle the ISIG optio</span>
<span class="cm"> *	@sig: signal</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *	@flush: force flush</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when a signal is being sent due to terminal input. This</span>
<span class="cm"> *	may caus terminal flushing to take place according to the termios</span>
<span class="cm"> *	settings and character used. Called from the driver receive_buf</span>
<span class="cm"> *	path so serialized.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: ctrl_lock, read_lock (both via flush buffer)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">isig</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">)</span>
		<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span> <span class="o">||</span> <span class="o">!</span><span class="n">L_NOFLSH</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">n_tty_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_driver_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_receive_break	-	handle break</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	An RS232 break event has been hit in the incoming bitstream. This</span>
<span class="cm"> *	can cause a variety of events depending upon the termios settings.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called from the receive_buf path so single threaded.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">n_tty_receive_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isig</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\377&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_receive_overrun	-	handle overrun reporting</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Data arrived faster than we could process it. While the tty</span>
<span class="cm"> *	driver has flagged this the bits that were missed are gone</span>
<span class="cm"> *	forever.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called from the receive_buf path so single threaded. Does not</span>
<span class="cm"> *	need locking as num_overrun and overrun_time are function</span>
<span class="cm"> *	private.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">n_tty_receive_overrun</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">num_overrun</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">overrun_time</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">time_after</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">overrun_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %d input overrun(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">num_overrun</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">overrun_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">num_overrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_receive_parity_error	-	error notifier</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@c: character</span>
<span class="cm"> *</span>
<span class="cm"> *	Process a parity error and queue the right data to indicate</span>
<span class="cm"> *	the error case if necessary. Locking as per n_tty_receive_buf.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">n_tty_receive_parity_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\377&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_receive_char	-	perform processing</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@c: character</span>
<span class="cm"> *</span>
<span class="cm"> *	Process an individual character of input received from the driver.</span>
<span class="cm"> *	This is serialized with respect to itself by the rules for the</span>
<span class="cm"> *	driver above.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">n_tty_receive_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">parmrk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_ISTRIP</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">c</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IUCLC</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L_EXTPROC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flow_stopped</span> <span class="o">&amp;&amp;</span> <span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">I_IXANY</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">c</span> <span class="o">!=</span> <span class="n">INTR_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">QUIT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">SUSP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">stop_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the previous character was LNEXT, or we know that this</span>
<span class="cm">	 * character is not one of the characters that we&#39;ll have to</span>
<span class="cm">	 * handle specially, do shortcut processing to speed things</span>
<span class="cm">	 * up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">)</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">lnext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">lnext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parmrk</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="sc">&#39;\377&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">parmrk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* beep if no space */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">process_output</span><span class="p">(</span><span class="sc">&#39;\a&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="cm">/* Record the column of first canon char. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">==</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">)</span>
				<span class="n">echo_set_canon_col</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parmrk</span><span class="p">)</span>
			<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stop_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">L_ISIG</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">signal</span><span class="p">;</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="n">SIGINT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">INTR_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">send_signal</span><span class="p">;</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="n">SIGQUIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">QUIT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">send_signal</span><span class="p">;</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="n">SIGTSTP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">SUSP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">send_signal:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note that we do not use isig() here because we want</span>
<span class="cm">			 * the order to be:</span>
<span class="cm">			 * 1) flush, 2) echo, 3) signal</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">L_NOFLSH</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">n_tty_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">tty_driver_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">)</span>
				<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNCR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_ICRNL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">I_INLCR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">ERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">KILL_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">WERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">eraser</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">LNEXT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">lnext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHOCTL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;^&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\b&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
					<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">REPRINT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">;</span>

			<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">tail</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">echo_char</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tail</span><span class="p">],</span> <span class="n">tty</span><span class="p">);</span>
				<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
					<span class="n">process_output</span><span class="p">(</span><span class="sc">&#39;\a&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">L_ECHONL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">handle_newline</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOF_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="n">N_TTY_BUF_SIZE</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_PUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">__DISABLED_CHAR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">handle_newline</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOL_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">EOL2_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">parmrk</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="sc">&#39;\377&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
				 <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">parmrk</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
					<span class="n">process_output</span><span class="p">(</span><span class="sc">&#39;\a&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX are EOL_CHAR and EOL2_CHAR echoed?!?</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Record the column of first canon char. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">==</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">)</span>
					<span class="n">echo_set_canon_col</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
				<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX does PARMRK doubling happen for</span>
<span class="cm">			 * EOL_CHAR and EOL2_CHAR?</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parmrk</span><span class="p">)</span>
				<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

<span class="nl">handle_newline:</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">);</span>
			<span class="n">put_tty_queue_nolock</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">))</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">parmrk</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="sc">&#39;\377&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">parmrk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* beep if no space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">process_output</span><span class="p">(</span><span class="sc">&#39;\a&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">finish_erasing</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">echo_char_raw</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Record the column of first canon char. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">==</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">)</span>
				<span class="n">echo_set_canon_col</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">echo_char</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parmrk</span><span class="p">)</span>
		<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="n">put_tty_queue</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	n_tty_write_wakeup	-	asynchronous I/O notifier</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *</span>
<span class="cm"> *	Required for the ptys, serial driver etc. since processes</span>
<span class="cm"> *	that attach themselves to the master and rely on ASYNC</span>
<span class="cm"> *	IO must be woken up</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_write_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">fasync</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_receive_buf	-	data receive</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@cp: buffer</span>
<span class="cm"> *	@fp: flag buffer</span>
<span class="cm"> *	@count: characters</span>
<span class="cm"> *</span>
<span class="cm"> *	Called by the terminal driver when a block of characters has</span>
<span class="cm"> *	been received. This function must be called from soft contexts</span>
<span class="cm"> *	not from interrupt context. The driver is responsible for making</span>
<span class="cm"> *	calls one at a time and in order (or using flush_to_ldisc)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpuflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">real_raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">cpuflags</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span>
			<span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cp</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span>
			<span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">+</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_head</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">cpuflags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">cp</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
				<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">f</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TTY_NORMAL</span>:
				<span class="n">n_tty_receive_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TTY_BREAK</span>:
				<span class="n">n_tty_receive_break</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TTY_PARITY</span>:
			<span class="k">case</span> <span class="n">TTY_FRAME</span>:
				<span class="n">n_tty_receive_parity_error</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TTY_OVERRUN</span>:
				<span class="n">n_tty_receive_overrun</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unknown flag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span><span class="p">))</span> <span class="o">||</span>
		<span class="n">L_EXTPROC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">))</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the remaining room for the input canonicalization</span>
<span class="cm">	 * mode.  We don&#39;t want to throttle the driver if we&#39;re in</span>
<span class="cm">	 * canonical mode and don&#39;t have a newline yet!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span> <span class="o">&lt;</span> <span class="n">TTY_THRESHOLD_THROTTLE</span><span class="p">)</span>
		<span class="n">tty_throttle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_ignored</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sigismember</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">[</span><span class="n">sig</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">==</span> <span class="n">SIG_IGN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_set_termios	-	termios data changed</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *	@old: previous data</span>
<span class="cm"> *</span>
<span class="cm"> *	Called by the tty layer when the user changes termios flags so</span>
<span class="cm"> *	that the line discipline can plan ahead. This function cannot sleep</span>
<span class="cm"> *	and is protected from re-entry by the tty layer. The user is</span>
<span class="cm"> *	guaranteed that this function will not be re-entered or in progress</span>
<span class="cm"> *	when the ldisc is closed.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller holds tty-&gt;termios_mutex</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">canon_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span>
		<span class="n">canon_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">^</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICANON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">canon_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">erasing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">canon_change</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">=</span> <span class="p">(</span><span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_HW_COOK_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">real_raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_ISTRIP</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_IUCLC</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_IGNCR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">I_ICRNL</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_INLCR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">L_ISIG</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNCR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_ICRNL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="sc">&#39;\r&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_INLCR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KILL_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">EOF_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">EOL_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">L_IEXTEN</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">WERASE_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">LNEXT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">EOL2_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">L_ECHO</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">REPRINT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span>
						<span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ISIG</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">INTR_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QUIT_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">SUSP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__DISABLED_CHAR</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">process_char_map</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">real_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">real_raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">real_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="cm">/* The termios change make the tty ready for I/O */</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_close		-	close the ldisc for this tty</span>
<span class="cm"> *	@tty: device</span>
<span class="cm"> *</span>
<span class="cm"> *	Called from the terminal layer when this line discipline is</span>
<span class="cm"> *	being shut down, either because of a close or becsuse of a</span>
<span class="cm"> *	discipline change. The function will not be called while other</span>
<span class="cm"> *	ldisc methods are in progress.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">n_tty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">n_tty_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_open		-	open an ldisc</span>
<span class="cm"> *	@tty: terminal to open</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when this line discipline is being attached to the</span>
<span class="cm"> *	terminal device. Can sleep. Called serialized so that no</span>
<span class="cm"> *	other events will occur in parallel. No further open will occur</span>
<span class="cm"> *	until a close.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">n_tty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* These are ugly. Currently a malloc failure here can panic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">echo_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reset_buffer_flags</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n_tty_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">input_available_p</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">amt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty_flush_to_ldisc</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">L_EXTPROC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">amt</span> <span class="o">?</span> <span class="n">amt</span> <span class="o">:</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	copy_from_read_buf	-	copy read data directly</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@b: user data</span>
<span class="cm"> *	@nr: size of data</span>
<span class="cm"> *</span>
<span class="cm"> *	Helper function to speed up n_tty_read.  It is only called when</span>
<span class="cm"> *	ICANON is off; it copies characters straight from the tty queue to</span>
<span class="cm"> *	user space directly.  It can be profitably called twice; once to</span>
<span class="cm"> *	drain the space from the tail pointer to the (physical) end of the</span>
<span class="cm"> *	buffer, and once to drain the space from the (physical) beginning of</span>
<span class="cm"> *	the buffer to head pointer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called under the tty-&gt;atomic_read_lock sem</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">**</span><span class="n">b</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="o">*</span><span class="n">nr</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_eof</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span> <span class="n">N_TTY_BUF_SIZE</span> <span class="o">-</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">nr</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">is_eof</span> <span class="o">=</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">]</span> <span class="o">==</span> <span class="n">EOF_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_audit_add_data</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
		<span class="cm">/* Turn single EOF into zero-length read */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_EXTPROC</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">&amp;&amp;</span> <span class="n">is_eof</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="o">*</span><span class="n">b</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nr</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">ssize_t</span> <span class="n">redirected_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span>
							<span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	job_control		-	check job control</span>
<span class="cm"> *	@tty: tty</span>
<span class="cm"> *	@file: file handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform job control management checks on this file/tty descriptor</span>
<span class="cm"> *	and if appropriate send any needed signals and return a negative</span>
<span class="cm"> *	error code if action should be taken.</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXME:</span>
<span class="cm"> *	Locking: None - redirected write test is safe, testing</span>
<span class="cm"> *	current-&gt;signal should possibly lock current-&gt;sighand</span>
<span class="cm"> *	pgrp locking ?</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">job_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Job control check -- must be done at start and after</span>
<span class="cm">	   every sleep (POSIX.1 7.1.1.4). */</span>
	<span class="cm">/* NOTE: not yet done after every sleep pending a thorough</span>
<span class="cm">	   check of the logic of this change. -- jlc */</span>
	<span class="cm">/* don&#39;t stop on /dev/console */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">!=</span> <span class="n">redirected_tty_write</span> <span class="o">&amp;&amp;</span>
	    <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">==</span> <span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;n_tty_read: no tty-&gt;pgrp!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task_pgrp</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">pgrp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_ignored</span><span class="p">(</span><span class="n">SIGTTIN</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">is_current_pgrp_orphaned</span><span class="p">())</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">kill_pgrp</span><span class="p">(</span><span class="n">task_pgrp</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">SIGTTIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_thread_flag</span><span class="p">(</span><span class="n">TIF_SIGPENDING</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	n_tty_read		-	read function for tty</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *	@file: file object</span>
<span class="cm"> *	@buf: userspace buffer pointer</span>
<span class="cm"> *	@nr: size of I/O</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform reads for the line discipline. We are guaranteed that the</span>
<span class="cm"> *	line discipline will not be closed under us but we may get multiple</span>
<span class="cm"> *	parallel readers and must handle this ourselves. We may also get</span>
<span class="cm"> *	a hangup. Always called in user context, may sleep.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code must be sure never to sleep through a hangup.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">n_tty_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minimum</span><span class="p">,</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">packet</span><span class="p">;</span>

<span class="nl">do_it_again:</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">job_control</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">minimum</span> <span class="o">=</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">TIME_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">minimum</span> <span class="o">=</span> <span class="n">MIN_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">minimum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">)</span> <span class="o">||</span>
				 <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">&gt;</span> <span class="n">minimum</span><span class="p">))</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
				<span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="n">minimum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Internal serialization of reads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">atomic_read_lock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">atomic_read_lock</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First test for status change. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cs</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty_put_user</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">b</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">b</span><span class="o">--</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* This statement must be first before checking for input</span>
<span class="cm">		   so that any interrupt will set the state back to</span>
<span class="cm">		   TASK_RUNNING. */</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">minimum</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">minimum</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="p">(</span><span class="n">minimum</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_available_p</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* FIXME: does n_tty_set_room need locking ? */</span>
			<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="cm">/* Deal with packet mode. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty_put_user</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">TIOCPKT_DATA</span><span class="p">,</span> <span class="n">b</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">b</span><span class="o">--</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">icanon</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">L_EXTPROC</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* N.B. avoid overrun if nr == 0 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">eol</span><span class="p">;</span>

				<span class="n">eol</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">,</span>
						<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">);</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">];</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span> <span class="o">=</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
						  <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">eol</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* this test should be redundant:</span>
<span class="cm">					 * we shouldn&#39;t be reading data if</span>
<span class="cm">					 * canon_data is 0</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eol</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">__DISABLED_CHAR</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tty_put_user</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
						<span class="n">b</span><span class="o">--</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">eol</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty_audit_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">uncopied</span><span class="p">;</span>
			<span class="cm">/* The copy function takes the read lock and handles</span>
<span class="cm">			   locking internally for this case */</span>
			<span class="n">uncopied</span> <span class="o">=</span> <span class="n">copy_from_read_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">);</span>
			<span class="n">uncopied</span> <span class="o">+=</span> <span class="n">copy_from_read_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uncopied</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If there is enough space in the read buffer now, let the</span>
<span class="cm">		 * low-level driver know. We use n_tty_chars_in_buffer() to</span>
<span class="cm">		 * check the buffer, as it now knows about canonical mode.</span>
<span class="cm">		 * Otherwise, if the driver is throttled and the line is</span>
<span class="cm">		 * longer than TTY_THRESHOLD_UNTHROTTLE in canonical mode,</span>
<span class="cm">		 * we won&#39;t get any more characters.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TTY_THRESHOLD_UNTHROTTLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">check_unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">&gt;=</span> <span class="n">minimum</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">atomic_read_lock</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">))</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">;</span>

	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_PUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">TTY_PUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">do_it_again</span><span class="p">;</span>

	<span class="n">n_tty_set_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_write		-	write function for tty</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *	@file: file object</span>
<span class="cm"> *	@buf: userspace buffer pointer</span>
<span class="cm"> *	@nr: size of I/O</span>
<span class="cm"> *</span>
<span class="cm"> *	Write function of the terminal device.  This is serialized with</span>
<span class="cm"> *	respect to other write callers but not to termios changes, reads</span>
<span class="cm"> *	and other such events.  Since the receive code will echo characters,</span>
<span class="cm"> *	thus calling driver write methods, the output_lock is used in</span>
<span class="cm"> *	the output processing functions called here as well as in the</span>
<span class="cm"> *	echo processing function to protect the column state and space</span>
<span class="cm"> *	left in the buffer.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code must be sure never to sleep through a hangup.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: output_lock to protect column state and space left</span>
<span class="cm"> *		 (note that the process_output*() functions take this</span>
<span class="cm"> *		  lock themselves)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">n_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Job control check -- must be done at start (POSIX.1 7.1.1.4). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">L_TOSTOP</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">!=</span> <span class="n">redirected_tty_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write out any echoed characters that are still pending */</span>
	<span class="n">process_echoes</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">O_OPOST</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_HW_COOK_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">ssize_t</span> <span class="n">num</span> <span class="o">=</span> <span class="n">process_output_block</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">b</span> <span class="o">+=</span> <span class="n">num</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="n">num</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">process_output</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tty</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">b</span><span class="o">++</span><span class="p">;</span> <span class="n">nr</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_chars</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">break_out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">b</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">nr</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
<span class="nl">break_out:</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">!=</span> <span class="n">nr</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">fasync</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">?</span> <span class="n">b</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">:</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_poll		-	poll method for N_TTY</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@file: file accessing it</span>
<span class="cm"> *	@wait: poll table</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the line discipline is asked to poll() for data or</span>
<span class="cm"> *	for special events. This code is not serialized with respect to</span>
<span class="cm"> *	other events save open/close.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code must be sure never to sleep through a hangup.</span>
<span class="cm"> *	Called without the kernel lock held - fine</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">n_tty_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
							<span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_available_p</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">TIME_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MIN_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLPRI</span> <span class="o">|</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_OTHER_CLOSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLHUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLHUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLHUP</span> <span class="o">|</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MIN_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">TIME_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="n">MIN_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">minimum_to_wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty_is_writelocked</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span> <span class="o">&amp;&amp;</span>
			<span class="n">tty_write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">inq_canon</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">canon_head</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_tail</span><span class="p">;</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">tail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Skip EOF-chars.. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_buf</span><span class="p">[</span><span class="n">tail</span><span class="p">]</span> <span class="o">==</span> <span class="n">__DISABLED_CHAR</span><span class="p">)</span>
			<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_TTY_BUF_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">n_tty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCOUTQ</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCINQ</span>:
		<span class="cm">/* FIXME: Locking */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">L_ICANON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">inq_canon</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">n_tty_ioctl_helper</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">tty_ldisc_N_TTY</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">magic</span>           <span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>            <span class="o">=</span> <span class="s">&quot;n_tty&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>            <span class="o">=</span> <span class="n">n_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>           <span class="o">=</span> <span class="n">n_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span>    <span class="o">=</span> <span class="n">n_tty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">n_tty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>            <span class="o">=</span> <span class="n">n_tty_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>           <span class="o">=</span> <span class="n">n_tty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>           <span class="o">=</span> <span class="n">n_tty_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>     <span class="o">=</span> <span class="n">n_tty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>            <span class="o">=</span> <span class="n">n_tty_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf</span>     <span class="o">=</span> <span class="n">n_tty_receive_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span>    <span class="o">=</span> <span class="n">n_tty_write_wakeup</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	n_tty_inherit_ops	-	inherit N_TTY methods</span>
<span class="cm"> *	@ops: struct tty_ldisc_ops where to save N_TTY methods</span>
<span class="cm"> *</span>
<span class="cm"> *	Used by a generic struct tty_ldisc_ops to easily inherit N_TTY</span>
<span class="cm"> *	methods.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">n_tty_inherit_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">tty_ldisc_N_TTY</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">n_tty_inherit_ops</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
