<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › tty_buffer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tty_buffer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Tty buffer allocation management</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_free_all		-	free buffers used by a tty</span>
<span class="cm"> *	@tty: tty to free from</span>
<span class="cm"> *</span>
<span class="cm"> *	Remove all the buffers pending on a tty whether queued with data</span>
<span class="cm"> *	or in the free ring. Must be called when the tty is no longer in use</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_buffer_free_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">thead</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">thead</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">thead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">thead</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">thead</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">thead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">thead</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_alloc	-	allocate a tty buffer</span>
<span class="cm"> *	@tty: tty device</span>
<span class="cm"> *	@size: desired size (characters)</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate a new tty buffer to hold the desired number of characters.</span>
<span class="cm"> *	Return NULL if out of memory or the allocation would exceed the</span>
<span class="cm"> *	per device queue</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller must hold tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="nf">tty_buffer_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_free		-	free a tty buffer</span>
<span class="cm"> *	@tty: tty owning the buffer</span>
<span class="cm"> *	@b: the buffer to free</span>
<span class="cm"> *</span>
<span class="cm"> *	Free a tty buffer, or add it to the free list according to our</span>
<span class="cm"> *	internal strategy</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller must hold tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tty_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Dumb strategy for now - should keep some stats */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">-=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span><span class="p">;</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	__tty_buffer_flush		-	flush full tty buffers</span>
<span class="cm"> *	@tty: tty to flush</span>
<span class="cm"> *</span>
<span class="cm"> *	flush all the buffers containing receive data. Caller must</span>
<span class="cm"> *	hold the buffer lock and must have ensured no parallel flush to</span>
<span class="cm"> *	ldisc is running.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller must hold tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tty_buffer_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">thead</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">thead</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">thead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">tty_buffer_free</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">thead</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_flush		-	flush full tty buffers</span>
<span class="cm"> *	@tty: tty to flush</span>
<span class="cm"> *</span>
<span class="cm"> *	flush all the buffers containing receive data. If the buffer is</span>
<span class="cm"> *	being processed by flush_to_ldisc then we defer the processing</span>
<span class="cm"> *	to that function</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_buffer_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If the data is being pushed to the tty layer then we can&#39;t</span>
<span class="cm">	   process it here. Instead set a flag and the flush_to_ldisc</span>
<span class="cm">	   path will process the flush request before it exits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_FLUSHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_FLUSHPENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">,</span>
				<span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_FLUSHPENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">__tty_buffer_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_find		-	find a free tty buffer</span>
<span class="cm"> *	@tty: tty owning the buffer</span>
<span class="cm"> *	@size: characters wanted</span>
<span class="cm"> *</span>
<span class="cm"> *	Locate an existing suitable tty buffer or if we are lacking one then</span>
<span class="cm"> *	allocate a new one. We round our buffers off in 256 character chunks</span>
<span class="cm"> *	to get better allocation behaviour.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller must hold tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="nf">tty_buffer_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">**</span><span class="n">tbh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">tbh</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">tbh</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tbh</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tbh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="n">tbh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Round the buffer size out */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tty_buffer_alloc</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="cm">/* Should possibly check if this fails for the largest buffer we</span>
<span class="cm">	   have queued and recycle that ? */</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> *	__tty_buffer_request_room		-	grow tty buffer if needed</span>
<span class="cm"> *	@tty: tty structure</span>
<span class="cm"> *	@size: size desired</span>
<span class="cm"> *</span>
<span class="cm"> *	Make at least size bytes of linear space available for the tty</span>
<span class="cm"> *	buffer. If we fail return the size we managed to find.</span>
<span class="cm"> *      Locking: Caller must hold tty-&gt;buf.lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__tty_buffer_request_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
	<span class="cm">/* OPTIMISATION: We could keep a per tty &quot;zero&quot; sized buffer to</span>
<span class="cm">	   remove this conditional if its worth it. This would be invisible</span>
<span class="cm">	   to the callers */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the slow path - looking for new buffers to use */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">tty_buffer_find</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">b</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_request_room		-	grow tty buffer if needed</span>
<span class="cm"> *	@tty: tty structure</span>
<span class="cm"> *	@size: size desired</span>
<span class="cm"> *</span>
<span class="cm"> *	Make at least size bytes of linear space available for the tty</span>
<span class="cm"> *	buffer. If we fail return the size we managed to find.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Takes tty-&gt;buf.lock</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tty_buffer_request_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">__tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_buffer_request_room</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_insert_flip_string_fixed_flag - Add characters to the tty buffer</span>
<span class="cm"> *	@tty: tty structure</span>
<span class="cm"> *	@chars: characters</span>
<span class="cm"> *	@flag: flag value for each character</span>
<span class="cm"> *	@size: size</span>
<span class="cm"> *</span>
<span class="cm"> *	Queue a series of bytes to the tty buffering. All the characters</span>
<span class="cm"> *	passed are marked with the supplied flag. Returns the number added.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Called functions may take tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_insert_flip_string_fixed_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">,</span> <span class="kt">char</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">,</span> <span class="n">TTY_BUFFER_PAGE</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">space</span> <span class="o">=</span> <span class="n">__tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">goal</span><span class="p">);</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
		<span class="cm">/* If there is no space then tb may be NULL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="n">chars</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="cm">/* There is a small chance that we need to split the data over</span>
<span class="cm">		   several buffers. If this is the case we must loop */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">copied</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_insert_flip_string_fixed_flag</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_insert_flip_string_flags	-	Add characters to the tty buffer</span>
<span class="cm"> *	@tty: tty structure</span>
<span class="cm"> *	@chars: characters</span>
<span class="cm"> *	@flags: flag bytes</span>
<span class="cm"> *	@size: size</span>
<span class="cm"> *</span>
<span class="cm"> *	Queue a series of bytes to the tty buffering. For each character</span>
<span class="cm"> *	the flags array indicates the status of the character. Returns the</span>
<span class="cm"> *	number added.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Called functions may take tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_insert_flip_string_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">copied</span><span class="p">,</span> <span class="n">TTY_BUFFER_PAGE</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__flags</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">__flags</span><span class="p">);</span>
		<span class="n">space</span> <span class="o">=</span> <span class="n">__tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">goal</span><span class="p">);</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
		<span class="cm">/* If there is no space then tb may be NULL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">__flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">__flags</span><span class="p">);</span>
		<span class="n">copied</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="n">chars</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
		<span class="cm">/* There is a small chance that we need to split the data over</span>
<span class="cm">		   several buffers. If this is the case we must loop */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">copied</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">copied</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_insert_flip_string_flags</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_schedule_flip	-	push characters to ldisc</span>
<span class="cm"> *	@tty: tty to push from</span>
<span class="cm"> *</span>
<span class="cm"> *	Takes any pending buffers and transfers their ownership to the</span>
<span class="cm"> *	ldisc side of the queue. It then schedules those characters for</span>
<span class="cm"> *	processing by the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Takes tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_schedule_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_schedule_flip</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_prepare_flip_string		-	make room for characters</span>
<span class="cm"> *	@tty: tty</span>
<span class="cm"> *	@chars: return pointer for character write area</span>
<span class="cm"> *	@size: desired size</span>
<span class="cm"> *</span>
<span class="cm"> *	Prepare a block of space in the buffer for data. Returns the length</span>
<span class="cm"> *	available and buffer pointer to the space which is now allocated and</span>
<span class="cm"> *	accounted for as ready for normal characters. This is used for drivers</span>
<span class="cm"> *	that need their own block copy routines into the buffer. There is no</span>
<span class="cm"> *	guarantee the buffer is a DMA target!</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: May call functions taking tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_prepare_flip_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">chars</span><span class="p">,</span>
								<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">__tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">space</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">chars</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">space</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_prepare_flip_string</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_prepare_flip_string_flags	-	make room for characters</span>
<span class="cm"> *	@tty: tty</span>
<span class="cm"> *	@chars: return pointer for character write area</span>
<span class="cm"> *	@flags: return pointer for status flag write area</span>
<span class="cm"> *	@size: desired size</span>
<span class="cm"> *</span>
<span class="cm"> *	Prepare a block of space in the buffer for data. Returns the length</span>
<span class="cm"> *	available and buffer pointer to the space which is now allocated and</span>
<span class="cm"> *	accounted for as ready for characters. This is used for drivers</span>
<span class="cm"> *	that need their own block copy routines into the buffer. There is no</span>
<span class="cm"> *	guarantee the buffer is a DMA target!</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: May call functions taking tty-&gt;buf.lock</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_prepare_flip_string_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">chars</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">flags</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">tb</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">__flags</span><span class="p">);</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">__tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">space</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">chars</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">+</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">+=</span> <span class="n">space</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">__flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">space</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_prepare_flip_string_flags</span><span class="p">);</span>



<span class="cm">/**</span>
<span class="cm"> *	flush_to_ldisc</span>
<span class="cm"> *	@work: tty structure passed from work queue.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is called out of the software interrupt to flush data</span>
<span class="cm"> *	from the buffer chain to the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: holds tty-&gt;buf.lock to guard buffer list. Drops the lock</span>
<span class="cm"> *	while invoking the line discipline receive_buf method. The</span>
<span class="cm"> *	receive_buf method is single threaded for each tty instance.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_to_ldisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> 	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">disc</span><span class="p">;</span>

	<span class="n">disc</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/*  !TTY_LDISC */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">TTY_FLUSHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_buffer</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">head</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">char_buf</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flag_buf</span><span class="p">;</span>

			<span class="n">count</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">-</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">tty_buffer_free</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Ldisc or user is trying to flush the buffers</span>
<span class="cm">			   we are feeding to the ldisc, stop feeding the</span>
<span class="cm">			   line discipline as we want to empty the queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_FLUSHPENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span><span class="p">;</span>
			<span class="n">char_buf</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">char_buf_ptr</span> <span class="o">+</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
			<span class="n">flag_buf</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">flag_buf_ptr</span> <span class="o">+</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">disc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">receive_buf</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">char_buf</span><span class="p">,</span>
							<span class="n">flag_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_FLUSHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We may have a deferred request to flush the input buffer,</span>
<span class="cm">	   if so pull the chain under the lock and empty the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_FLUSHPENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__tty_buffer_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_FLUSHPENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">disc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_flush_to_ldisc</span>
<span class="cm"> *	@tty: tty to push</span>
<span class="cm"> *</span>
<span class="cm"> *	Push the terminal flip buffers to the line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> *	Must not be called from IRQ context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tty_flush_to_ldisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_flip_buffer_push	-	terminal</span>
<span class="cm"> *	@tty: tty to push</span>
<span class="cm"> *</span>
<span class="cm"> *	Queue a push of the terminal flip buffers to the line discipline. This</span>
<span class="cm"> *	function must not be called from IRQ context if tty-&gt;low_latency is set.</span>
<span class="cm"> *</span>
<span class="cm"> *	In the event of the queue being busy for flipping the work will be</span>
<span class="cm"> *	held off and retried later.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: tty buffer lock. Driver locks in low latency mode.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_flip_buffer_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">commit</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">low_latency</span><span class="p">)</span>
		<span class="n">flush_to_ldisc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_flip_buffer_push</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_buffer_init		-	prepare a tty buffer structure</span>
<span class="cm"> *	@tty: tty to initialise</span>
<span class="cm"> *</span>
<span class="cm"> *	Set up the initial state of the buffer management for a tty device.</span>
<span class="cm"> *	Must be called before the other tty buffer functions are used.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_buffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">memory_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">flush_to_ldisc</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
