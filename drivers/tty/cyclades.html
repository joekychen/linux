<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › cyclades.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cyclades.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#undef	BLOCKMOVE</span>
<span class="cp">#define	Z_WAKE</span>
<span class="cp">#undef	Z_EXT_CHARS_IN_BUFFER</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains the driver for the Cyclades async multiport</span>
<span class="cm"> * serial boards.</span>
<span class="cm"> *</span>
<span class="cm"> * Initially written by Randolph Bentson &lt;bentson@grieg.seaslug.org&gt;.</span>
<span class="cm"> * Modified and maintained by Marcio Saito &lt;marcio@cyclades.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2009 Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Much of the design and some of the code came from serial.c</span>
<span class="cm"> * which was copyright (C) 1991, 1992  Linus Torvalds.  It was</span>
<span class="cm"> * extensively rewritten by Theodore Ts&#39;o, 8/16/92 -- 9/14/92,</span>
<span class="cm"> * and then fixed as suggested by Michael K. Johnson 12/12/92.</span>
<span class="cm"> * Converted to pci probing and cleaned up by Jiri Slaby.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define CY_VERSION	&quot;2.6&quot;</span>

<span class="cm">/* If you need to install more boards than NR_CARDS, change the constant</span>
<span class="cm">   in the definition below. No other change is necessary to support up to</span>
<span class="cm">   eight boards. Beyond that you&#39;ll have to extend cy_isa_addresses. */</span>

<span class="cp">#define NR_CARDS	4</span>

<span class="cm">/*</span>
<span class="cm">   If the total number of ports is larger than NR_PORTS, change this</span>
<span class="cm">   constant in the definition below. No other change is necessary to</span>
<span class="cm">   support more boards/ports. */</span>

<span class="cp">#define NR_PORTS	256</span>

<span class="cp">#define ZO_V1	0</span>
<span class="cp">#define ZO_V2	1</span>
<span class="cp">#define ZE_V1	2</span>

<span class="cp">#define	SERIAL_PARANOIA_CHECK</span>
<span class="cp">#undef	CY_DEBUG_OPEN</span>
<span class="cp">#undef	CY_DEBUG_THROTTLE</span>
<span class="cp">#undef	CY_DEBUG_OTHER</span>
<span class="cp">#undef	CY_DEBUG_IO</span>
<span class="cp">#undef	CY_DEBUG_COUNT</span>
<span class="cp">#undef	CY_DEBUG_DTR</span>
<span class="cp">#undef	CY_DEBUG_INTERRUPTS</span>
<span class="cp">#undef	CY_16Y_HACK</span>
<span class="cp">#undef	CY_ENABLE_MONITORING</span>
<span class="cp">#undef	CY_PCI_DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * Include section</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/cyclades.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cy_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">);</span>

<span class="cp">#ifndef SERIAL_XMIT_SIZE</span>
<span class="cp">#define	SERIAL_XMIT_SIZE	(min(PAGE_SIZE, 4096))</span>
<span class="cp">#endif</span>

<span class="cp">#define STD_COM_FLAGS (0)</span>

<span class="cm">/* firmware stuff */</span>
<span class="cp">#define ZL_MAX_BLOCKS	16</span>
<span class="cp">#define DRIVER_VERSION	0x02010203</span>
<span class="cp">#define RAM_SIZE 0x80000</span>

<span class="k">enum</span> <span class="n">zblock_type</span> <span class="p">{</span>
	<span class="n">ZBLOCK_PRG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ZBLOCK_FPGA</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">zfile_header</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">date</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">aux</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">n_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">config_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n_blocks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">block_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">zfile_config</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">mailbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">n_blocks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">block_list</span><span class="p">[</span><span class="n">ZL_MAX_BLOCKS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">zfile_block</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">file_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ram_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">cy_serial_driver</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="cm">/* This is the address lookup table. The driver will probe for</span>
<span class="cm">   Cyclom-Y/ISA boards at all addresses in here. If you want the</span>
<span class="cm">   driver to probe addresses at a different address, add it to</span>
<span class="cm">   this table.  If the driver is probing some other board and</span>
<span class="cm">   causing problems, remove the offending address from this table.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cy_isa_addresses</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xD0000</span><span class="p">,</span>
	<span class="mh">0xD2000</span><span class="p">,</span>
	<span class="mh">0xD4000</span><span class="p">,</span>
	<span class="mh">0xD6000</span><span class="p">,</span>
	<span class="mh">0xD8000</span><span class="p">,</span>
	<span class="mh">0xDA000</span><span class="p">,</span>
	<span class="mh">0xDC000</span><span class="p">,</span>
	<span class="mh">0xDE000</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#define NR_ISA_ADDRS ARRAY_SIZE(cy_isa_addresses)</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">maddr</span><span class="p">[</span><span class="n">NR_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">NR_CARDS</span><span class="p">];</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">maddr</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cm">/* This is the per-card data structure containing address, irq, number of</span>
<span class="cm">   channels, etc. This driver supports a maximum of NR_CARDS cards.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cyclades_card</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">NR_CARDS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cy_next_channel</span><span class="p">;</span>	<span class="cm">/* next minor available */</span>

<span class="cm">/*</span>
<span class="cm"> * This is used to look up the divisor speeds and the timeouts</span>
<span class="cm"> * We&#39;re normally limited to 15 distinct baud rates.  The extra</span>
<span class="cm"> * are accessed via settings in info-&gt;port.flags.</span>
<span class="cm"> *      0,     1,     2,     3,     4,     5,     6,     7,     8,     9,</span>
<span class="cm"> *     10,    11,    12,    13,    14,    15,    16,    17,    18,    19,</span>
<span class="cm"> *                                               HI            VHI</span>
<span class="cm"> *     20</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span>
	<span class="mi">1800</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">38400</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span> <span class="mi">76800</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">150000</span><span class="p">,</span>
	<span class="mi">230400</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">baud_co_25</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* 25 MHz clock option table */</span>
	<span class="cm">/* value =&gt;    00    01   02    03    04 */</span>
	<span class="cm">/* divide by    8    32   128   512  2048 */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">baud_bpr_25</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* 25 MHz baud rate period table */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span>
	<span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x15</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">baud_co_60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* 60 MHz clock option table (CD1400 J) */</span>
	<span class="cm">/* value =&gt;    00    01   02    03    04 */</span>
	<span class="cm">/* divide by    8    32   128   512  2048 */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">baud_bpr_60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* 60 MHz baud rate period table (CD1400 J) */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span>
	<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
	<span class="mh">0x21</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">baud_cor3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* receive threshold */</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x07</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The Cyclades driver implements HW flow control as any serial driver.</span>
<span class="cm"> * The cyclades_port structure member rflow and the vector rflow_thr</span>
<span class="cm"> * allows us to take advantage of a special feature in the CD1400 to avoid</span>
<span class="cm"> * data loss even when the system interrupt latency is too high. These flags</span>
<span class="cm"> * are to be used only with very special applications. Setting these flags</span>
<span class="cm"> * requires the use of a special cable (DTR and RTS reversed). In the new</span>
<span class="cm"> * CD1400-based boards (rev. 6.00 or later), there is no need for special</span>
<span class="cm"> * cables.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">rflow_thr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* rflow threshold */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x0a</span>
<span class="p">};</span>

<span class="cm">/*  The Cyclom-Ye has placed the sequential chips in non-sequential</span>
<span class="cm"> *  address order.  This look-up table overcomes that problem.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cy_chip_offset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="mh">0x0400</span><span class="p">,</span>
	<span class="mh">0x0800</span><span class="p">,</span>
	<span class="mh">0x0C00</span><span class="p">,</span>
	<span class="mh">0x0200</span><span class="p">,</span>
	<span class="mh">0x0600</span><span class="p">,</span>
	<span class="mh">0x0A00</span><span class="p">,</span>
	<span class="mh">0x0E00</span>
<span class="p">};</span>

<span class="cm">/* PCI related definitions */</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">cy_pci_dev_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PCI &lt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Lo</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* PCI &gt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Hi</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* 4Y PCI &lt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_4Y_Lo</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* 4Y PCI &gt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_4Y_Hi</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* 8Y PCI &lt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_8Y_Lo</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* 8Y PCI &gt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_8Y_Hi</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Z PCI &lt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Z_Lo</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Z PCI &gt; 1Mb */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CYCLADES</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Z_Hi</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>			<span class="cm">/* end of table */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">cy_pci_dev_id</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cy_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cy_set_line_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="p">,</span> <span class="n">__u32</span><span class="p">,</span> <span class="n">__u8</span><span class="p">,</span> <span class="n">__u32</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">detect_isa_irq</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cyz_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="cm">/* The Cyclades-Z polling cycle is defined by this variable */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">cyz_polling_cycle</span> <span class="o">=</span> <span class="n">CZ_DEF_POLL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">cyz_timerlist</span><span class="p">,</span> <span class="n">cyz_poll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#else				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cyz_rx_restart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">cyz_rx_full_timer</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cyy_writeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyy</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">cyy_readb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyy</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">cy_is_Z</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">num_chips</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__cyz_fpga_loaded</span><span class="p">(</span><span class="k">struct</span> <span class="n">RUNTIME_9060</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctl_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">cyz_fpga_loaded</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">cyz_is_loaded</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">FIRM_ID</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw_ver</span> <span class="o">==</span> <span class="n">ZO_V1</span> <span class="o">||</span> <span class="n">cyz_fpga_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_id</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFIRM_ID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">serial_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SERIAL_PARANOIA_CHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cyc Warning: null cyclades_port for (%s) &quot;</span>
				<span class="s">&quot;in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">CYCLADES_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cyc Warning: bad magic number for serial &quot;</span>
				<span class="s">&quot;struct (%s) in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************/</span>
<span class="cm">/********* Start of block of Cyclom-Y specific code ********/</span>

<span class="cm">/* This routine waits up to 1000 micro-seconds for the previous</span>
<span class="cm">   command to the Cirrus chip to complete and then issues the</span>
<span class="cm">   new command.  An error is returned if the previous command</span>
<span class="cm">   didn&#39;t finish within the time limit.</span>

<span class="cm">   This function is only called from inside spinlock-protected code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__cyy_issue_cmd</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ccr</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check to see that the previous command has completed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">ccr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10L</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* if the CCR never cleared, the previous command</span>
<span class="cm">	   didn&#39;t finish within the &quot;reasonable time&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Issue the new command */</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">ccr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cyy_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__cyy_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyy</span><span class="p">.</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="cm">/* ISA interrupt detection code */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">detect_isa_irq</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqs</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">save_xir</span><span class="p">,</span> <span class="n">save_car</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* IRQ probing is only for ISA */</span>

	<span class="cm">/* forget possible initially masked and pending IRQ */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">probe_irq_on</span><span class="p">());</span>

	<span class="cm">/* Clear interrupts on the board first */</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cy_ClrIntr</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Cy_ClrIntr is 0x1800 */</span>

	<span class="n">irqs</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>
	<span class="cm">/* Wait ... */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Enable the Tx interrupts on the CD1400 */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__cyy_issue_cmd</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">CyCHAN_CTL</span> <span class="o">|</span> <span class="n">CyENB_XMTR</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CySRER</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span>
		  <span class="n">readb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CySRER</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">|</span> <span class="n">CyTxRdy</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Wait ... */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Check which interrupt is in use */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irqs</span><span class="p">);</span>

	<span class="cm">/* Clean up */</span>
	<span class="n">save_xir</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyTIR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">save_car</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="p">(</span><span class="n">save_xir</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">));</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CySRER</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span>
		  <span class="n">readb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CySRER</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyTIR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="p">(</span><span class="n">save_xir</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="p">(</span><span class="n">save_car</span><span class="p">));</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cy_ClrIntr</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Cy_ClrIntr is 0x1800 */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">irq</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_chip_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ivr</span><span class="p">,</span> <span class="n">save_xir</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">save_car</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">char_count</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyy_interrupt: rcvd intr, chip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* determine the channel &amp; change to that context */</span>
	<span class="n">save_xir</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyRIR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="n">CyIRChannel</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">channel</span> <span class="o">+</span> <span class="n">chip</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">save_car</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">save_xir</span><span class="p">);</span>
	<span class="n">ivr</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRIVR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CyIVRMask</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* if there is nowhere to put the data, discard it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivr</span> <span class="o">==</span> <span class="n">CyIVRRxEx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* exception */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* normal character reception */</span>
			<span class="n">char_count</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDCR</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">char_count</span><span class="o">--</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* there is an open port for this data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivr</span> <span class="o">==</span> <span class="n">CyIVRRxEx</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* exception */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">);</span>

		<span class="cm">/* For statistics only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyBREAK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyFRAME</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyPARITY</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyOVERRUN</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyBREAK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
						<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">),</span>
						<span class="n">TTY_BREAK</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SAK</span><span class="p">)</span>
						<span class="n">do_SAK</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyFRAME</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
						<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">),</span>
						<span class="n">TTY_FRAME</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">frame_errs</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyPARITY</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Pieces of seven... */</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
						<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">),</span>
						<span class="n">TTY_PARITY</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">parity_errs</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">CyOVERRUN</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">TTY_OVERRUN</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
					<span class="cm">/* If the flip buffer itself is</span>
<span class="cm">					   overflowing, we still lose</span>
<span class="cm">					   the next incoming character.</span>
<span class="cm">					 */</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span>
						<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">),</span>
						<span class="n">TTY_FRAME</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">overruns</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* These two conditions may imply */</span>
				<span class="cm">/* a normal read should be done. */</span>
				<span class="cm">/* } else if(data &amp; CyTIMEOUT) { */</span>
				<span class="cm">/* } else if(data &amp; CySPECHAR) { */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">TTY_NORMAL</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* there was a software buffer overrun and nothing</span>
<span class="cm">			 * could be done about it!!! */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">buf_overrun</span><span class="o">++</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">overruns</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* normal character reception */</span>
		<span class="cm">/* load # chars available from the chip */</span>
		<span class="n">char_count</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDCR</span><span class="p">);</span>

<span class="cp">#ifdef CY_ENABLE_MONITORING</span>
		<span class="o">++</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">int_count</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_count</span> <span class="o">+=</span> <span class="n">char_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_max</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_max</span> <span class="o">=</span> <span class="n">char_count</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_last</span> <span class="o">=</span> <span class="n">char_count</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">char_count</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRDSR</span><span class="p">);</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_bytes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CY_16Y_HACK</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10L</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_idle</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="cm">/* end of service */</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRIR</span><span class="p">,</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">save_car</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_chip_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">char_count</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">save_xir</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">save_car</span><span class="p">,</span> <span class="n">outch</span><span class="p">;</span>

	<span class="cm">/* Since we only get here when the transmit buffer</span>
<span class="cm">	   is empty, we know we can always stuff a dozen</span>
<span class="cm">	   characters. */</span>
<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyy_interrupt: xmit intr, chip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* determine the channel &amp; change to that context */</span>
	<span class="n">save_xir</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyTIR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="n">CyIRChannel</span><span class="p">;</span>
	<span class="n">save_car</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCAR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="n">save_xir</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">channel</span> <span class="o">+</span> <span class="n">chip</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* load the on-chip space for outbound data */</span>
	<span class="n">char_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* send special char */</span>
		<span class="n">outch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">;</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="n">outch</span><span class="p">);</span>
		<span class="n">char_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">char_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">char_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">char_count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CyTxMpty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span>
					<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxMpty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">CyTxMpty</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span>
				<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span>
				<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Because the Embedded Transmit Commands have been enabled,</span>
<span class="cm">		 * we must check to see if the escape character, NULL, is being</span>
<span class="cm">		 * sent. If it is, we must ensure that there is room for it to</span>
<span class="cm">		 * be doubled in the output stream.  Therefore we no longer</span>
<span class="cm">		 * advance the pointer when the character is fetched, but</span>
<span class="cm">		 * rather wait until after the check for a NULL output</span>
<span class="cm">		 * character. This is necessary because there may not be room</span>
<span class="cm">		 * for the two chars needed to send a NULL.)</span>
<span class="cm">		 */</span>
		<span class="n">outch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="n">outch</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="n">outch</span><span class="p">);</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
				<span class="n">char_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="cm">/* end of service */</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTIR</span><span class="p">,</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">save_car</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_chip_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">save_xir</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">save_car</span><span class="p">,</span> <span class="n">mdm_change</span><span class="p">,</span> <span class="n">mdm_status</span><span class="p">;</span>

	<span class="cm">/* determine the channel &amp; change to that context */</span>
	<span class="n">save_xir</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyMIR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="n">CyIRChannel</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">channel</span> <span class="o">+</span> <span class="n">chip</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">save_car</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">save_xir</span><span class="p">);</span>

	<span class="n">mdm_change</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMISR</span><span class="p">);</span>
	<span class="n">mdm_status</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR1</span><span class="p">);</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyANY_DELTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For statistics only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyDCD</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyCTS</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyDSR</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyRI</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>

		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyDCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdm_status</span> <span class="o">&amp;</span> <span class="n">CyDCD</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mdm_change</span> <span class="o">&amp;</span> <span class="n">CyCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdm_status</span> <span class="o">&amp;</span> <span class="n">CyCTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* cy_start isn&#39;t used</span>
<span class="cm">				   because... !!! */</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span>
					<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CyTxRdy</span><span class="p">);</span>
				<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mdm_status</span> <span class="o">&amp;</span> <span class="n">CyCTS</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* cy_stop isn&#39;t used</span>
<span class="cm">				   because ... !!! */</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span>
					<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*	if (mdm_change &amp; CyDSR) {</span>
<span class="cm">	}</span>
<span class="cm">	if (mdm_change &amp; CyRI) {</span>
<span class="cm">	}*/</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">end:</span>
	<span class="cm">/* end of service */</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMIR</span><span class="p">,</span> <span class="n">save_xir</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">save_car</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The real interrupt service routine is called</span>
<span class="cm">   whenever the card wants its hand held--chars</span>
<span class="cm">   received, out buffer empty, modem change, etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cyy_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">card_base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">too_many</span><span class="p">,</span> <span class="n">had_work</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cinfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyy_interrupt: spurious interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* spurious interrupt */</span>
	<span class="p">}</span>

	<span class="n">card_base_addr</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">;</span>

	<span class="cm">/* card was not initialized yet (e.g. DEBUG_SHIRQ) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">card_base_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* This loop checks all chips in the card.  Make a note whenever</span>
<span class="cm">	   _any_ chip had some work to do, as this is considered an</span>
<span class="cm">	   indication that there will be more to do.  Only when no chip</span>
<span class="cm">	   has any work does this outermost loop exit.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">had_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">num_chips</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base_addr</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">cy_chip_offset</span><span class="p">[</span><span class="n">chip</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">too_many</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">CySVRR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)))</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">had_work</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* The purpose of the following test is to ensure that</span>
<span class="cm">			   no chip can monopolize the driver.  This forces the</span>
<span class="cm">			   chips to be checked in a round-robin fashion (after</span>
<span class="cm">			   draining each of a bunch (1000) of characters).</span>
<span class="cm">			 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">&lt;</span> <span class="n">too_many</span><span class="o">++</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CySRReceive</span><span class="p">)</span> <span class="cm">/* rx intr */</span>
					<span class="n">cyy_chip_rx</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CySRTransmit</span><span class="p">)</span> <span class="cm">/* tx intr */</span>
					<span class="n">cyy_chip_tx</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CySRModem</span><span class="p">)</span> <span class="cm">/* modem intr */</span>
					<span class="n">cyy_chip_modem</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">had_work</span><span class="p">);</span>

	<span class="cm">/* clear interrupts */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">card_base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cy_ClrIntr</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Cy_ClrIntr is 0x1800 */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cyy_interrupt */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_change_rts_dtr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rts</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">msvrr</span><span class="p">,</span> <span class="n">msvrd</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msvrr</span> <span class="o">=</span> <span class="n">CyMSVR2</span><span class="p">;</span>
		<span class="n">msvrd</span> <span class="o">=</span> <span class="n">CyMSVR1</span><span class="p">;</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="n">CyDTR</span><span class="p">;</span>
		<span class="n">dtr</span> <span class="o">=</span> <span class="n">CyRTS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msvrr</span> <span class="o">=</span> <span class="n">CyMSVR1</span><span class="p">;</span>
		<span class="n">msvrd</span> <span class="o">=</span> <span class="n">CyMSVR2</span><span class="p">;</span>
		<span class="n">rts</span> <span class="o">=</span> <span class="n">CyRTS</span><span class="p">;</span>
		<span class="n">dtr</span> <span class="o">=</span> <span class="n">CyDTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">msvrr</span><span class="p">,</span> <span class="n">rts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">msvrr</span><span class="p">,</span> <span class="o">~</span><span class="n">rts</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">msvrd</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_modem_info raising DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;     status: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR1</span><span class="p">),</span>
			<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR2</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">msvrd</span><span class="p">,</span> <span class="o">~</span><span class="n">dtr</span><span class="p">);</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_modem_info dropping DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;     status: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR1</span><span class="p">),</span>
			<span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR2</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************************************************/</span>
<span class="cm">/********* End of block of Cyclom-Y specific code **********/</span>
<span class="cm">/******** Start of block of Cyclades-Z specific code *******/</span>
<span class="cm">/***********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cyz_fetch_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BOARD_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">board_ctrl</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loc_doorbell</span><span class="p">;</span>

	<span class="n">loc_doorbell</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span><span class="n">loc_doorbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loc_doorbell</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">loc_doorbell</span><span class="p">);</span>
		<span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_ctrl</span><span class="o">-&gt;</span><span class="n">fwcmd_channel</span><span class="p">);</span>
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_ctrl</span><span class="o">-&gt;</span><span class="n">fwcmd_param</span><span class="p">);</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span><span class="n">loc_doorbell</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cyz_fetch_msg */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cyz_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="n">channel</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BOARD_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">board_ctrl</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pci_doorbell</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_doorbell</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span><span class="n">pci_doorbell</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pci_doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="o">++</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">readl</span><span class="p">(</span><span class="n">pci_doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50L</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_ctrl</span><span class="o">-&gt;</span><span class="n">hcmd_channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_ctrl</span><span class="o">-&gt;</span><span class="n">hcmd_param</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="n">pci_doorbell</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cyz_issue_cmd */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_handle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BUF_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">buf_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">char_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="cp">#ifdef BLOCKMOVE</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__u32</span> <span class="n">rx_put</span><span class="p">,</span> <span class="n">rx_get</span><span class="p">,</span> <span class="n">new_rx_get</span><span class="p">,</span> <span class="n">rx_bufsize</span><span class="p">,</span> <span class="n">rx_bufaddr</span><span class="p">;</span>

	<span class="n">rx_get</span> <span class="o">=</span> <span class="n">new_rx_get</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_get</span><span class="p">);</span>
	<span class="n">rx_put</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="p">);</span>
	<span class="n">rx_bufsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">);</span>
	<span class="n">rx_bufaddr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_bufaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_put</span> <span class="o">&gt;=</span> <span class="n">rx_get</span><span class="p">)</span>
		<span class="n">char_count</span> <span class="o">=</span> <span class="n">rx_put</span> <span class="o">-</span> <span class="n">rx_get</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">char_count</span> <span class="o">=</span> <span class="n">rx_put</span> <span class="o">-</span> <span class="n">rx_get</span> <span class="o">+</span> <span class="n">rx_bufsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CY_ENABLE_MONITORING</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">int_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_count</span> <span class="o">+=</span> <span class="n">char_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_max</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_max</span> <span class="o">=</span> <span class="n">char_count</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">.</span><span class="n">char_last</span> <span class="o">=</span> <span class="n">char_count</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* flush received characters */</span>
			<span class="n">new_rx_get</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_rx_get</span> <span class="o">+</span> <span class="n">char_count</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">rx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rflush_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef BLOCKMOVE</span>
		<span class="cm">/* we&#39;d like to use memcpy(t, f, n) and memset(s, c, count)</span>
<span class="cm">		   for performance, but because of buffer boundaries, there</span>
<span class="cm">		   may be several steps to the operation */</span>
			<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">tty_prepare_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
						<span class="n">char_count</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">char_count</span><span class="p">),</span>
						<span class="n">rx_bufsize</span> <span class="o">-</span> <span class="n">new_rx_get</span><span class="p">);</span>

				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
						<span class="n">rx_bufaddr</span> <span class="o">+</span> <span class="n">new_rx_get</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

				<span class="n">new_rx_get</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_rx_get</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">rx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">char_count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">char_count</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">rx_bufaddr</span> <span class="o">+</span>
						<span class="n">new_rx_get</span><span class="p">);</span>
				<span class="n">new_rx_get</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_rx_get</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="n">rx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_bytes</span><span class="o">++</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="cm">/* Recalculate the number of chars in the RX buffer and issue</span>
<span class="cm">		   a cmd in case it&#39;s higher than the RX high water mark */</span>
			<span class="n">rx_put</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_put</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_put</span> <span class="o">&gt;=</span> <span class="n">rx_get</span><span class="p">)</span>
				<span class="n">char_count</span> <span class="o">=</span> <span class="n">rx_put</span> <span class="o">-</span> <span class="n">rx_get</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">char_count</span> <span class="o">=</span> <span class="n">rx_put</span> <span class="o">-</span> <span class="n">rx_get</span> <span class="o">+</span> <span class="n">rx_bufsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&gt;=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_threshold</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_rx_full_timer</span><span class="p">[</span>
							<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">]))</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_rx_full_timer</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">],</span>
						<span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_idle</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Update rx_get */</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">rx_get</span><span class="p">,</span> <span class="n">new_rx_get</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_handle_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BUF_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">buf_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">char_count</span><span class="p">;</span>
<span class="cp">#ifdef BLOCKMOVE</span>
	<span class="kt">int</span> <span class="n">small_count</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">__u32</span> <span class="n">tx_put</span><span class="p">,</span> <span class="n">tx_get</span><span class="p">,</span> <span class="n">tx_bufsize</span><span class="p">,</span> <span class="n">tx_bufaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Nothing to transmit */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tx_get</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="p">);</span>
	<span class="n">tx_put</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">);</span>
	<span class="n">tx_bufsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_bufsize</span><span class="p">);</span>
	<span class="n">tx_bufaddr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_bufaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_put</span> <span class="o">&gt;=</span> <span class="n">tx_get</span><span class="p">)</span>
		<span class="n">char_count</span> <span class="o">=</span> <span class="n">tx_get</span> <span class="o">-</span> <span class="n">tx_put</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">tx_bufsize</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">char_count</span> <span class="o">=</span> <span class="n">tx_get</span> <span class="o">-</span> <span class="n">tx_put</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">char_count</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ztxdone</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* send special char */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">;</span>

			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">tx_bufaddr</span> <span class="o">+</span> <span class="n">tx_put</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">tx_put</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_put</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">char_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef BLOCKMOVE</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">small_count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
				<span class="n">tx_bufsize</span> <span class="o">-</span> <span class="n">tx_put</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
					<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">),</span>
					<span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">,</span>
						<span class="n">char_count</span><span class="p">)))))</span> <span class="p">{</span>

			<span class="n">memcpy_toio</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">tx_bufaddr</span> <span class="o">+</span>
					<span class="n">tx_put</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">],</span>
					<span class="n">small_count</span><span class="p">);</span>

			<span class="n">tx_put</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_put</span> <span class="o">+</span> <span class="n">small_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">char_count</span> <span class="o">-=</span> <span class="n">small_count</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">small_count</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-=</span> <span class="n">small_count</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+</span> <span class="n">small_count</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="n">char_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">];</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">tx_bufaddr</span> <span class="o">+</span> <span class="n">tx_put</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">tx_put</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_put</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx_bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">char_count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="nl">ztxdone:</span>
		<span class="cm">/* Update tx_put */</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">,</span> <span class="n">tx_put</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_handle_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BOARD_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">board_ctrl</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">channel</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">fw_ver</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">special_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta_count</span><span class="p">;</span>

	<span class="n">fw_ver</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">board_ctrl</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cyz_fetch_msg</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">special_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">delta_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">C_CM_PR_ERROR</span>:
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_PARITY</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">special_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_FR_ERROR</span>:
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_FRAME</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">special_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_RXBRK</span>:
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_BREAK</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">special_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_MDCD</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
			<span class="n">delta_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">dcd</span> <span class="o">=</span> <span class="n">fw_ver</span> <span class="o">&gt;</span> <span class="mi">241</span> <span class="o">?</span> <span class="n">param</span> <span class="o">:</span>
					<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dcd</span> <span class="o">&amp;</span> <span class="n">C_RS_DCD</span><span class="p">)</span>
					<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_MCTS</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">delta_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_MRI</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
			<span class="n">delta_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_MDSR</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">delta_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef Z_WAKE</span>
		<span class="k">case</span> <span class="n">C_CM_IOCTLW</span>:
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="k">case</span> <span class="n">C_CM_RXHIWM</span>:
		<span class="k">case</span> <span class="n">C_CM_RXNNDT</span>:
		<span class="k">case</span> <span class="n">C_CM_INTBACK2</span>:
			<span class="cm">/* Reception Interrupt */</span>
<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyz_interrupt: rcvd intr, card %d, &quot;</span>
					<span class="s">&quot;port %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">cyz_handle_rx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C_CM_TXBEMPTY</span>:
		<span class="k">case</span> <span class="n">C_CM_TXLOWWM</span>:
		<span class="k">case</span> <span class="n">C_CM_INTBACK</span>:
			<span class="cm">/* Transmission Interrupt */</span>
<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyz_interrupt: xmit intr, card %d, &quot;</span>
					<span class="s">&quot;port %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">cyz_handle_tx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
		<span class="k">case</span> <span class="n">C_CM_FATAL</span>:
			<span class="cm">/* should do something with this !!! */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta_count</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">special_count</span><span class="p">)</span>
			<span class="n">tty_schedule_flip</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">cyz_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef CY_DEBUG_INTERRUPTS</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyz_interrupt: board not yet loaded &quot;</span>
				<span class="s">&quot;(IRQ%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle the interrupts */</span>
	<span class="n">cyz_handle_cmd</span><span class="p">(</span><span class="n">cinfo</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cyz_interrupt */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_rx_restart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_INTBACK2</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:cyz_rx_restart retval on ttyC%d was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">card</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">card</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">card</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

	<span class="cm">/* Skip first polling cycle to avoid racing conditions with the FW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">intr_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">intr_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cyz_handle_cmd</span><span class="p">(</span><span class="n">cinfo</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

			<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="cm">/* OK to pass NULL to the handle functions below.</span>
<span class="cm">			   They need to drop the data in that case. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">)</span>
				<span class="n">cyz_handle_rx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">cyz_handle_tx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
			<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* poll every &#39;cyz_polling_cycle&#39; period */</span>
		<span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">cyz_polling_cycle</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_timerlist</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* cyz_poll */</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>

<span class="cm">/********** End of block of Cyclades-Z specific code *********/</span>
<span class="cm">/***********************************************************/</span>

<span class="cm">/* This is called whenever a port becomes active;</span>
<span class="cm">   interrupts are enabled and DTR &amp; RTS are turned on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">page</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cy_set_line_char</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">channel</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRTPR</span><span class="p">,</span>
			<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">));</span>
		<span class="cm">/* 10ms rx timeout */</span>

		<span class="n">cyy_issue_cmd</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCHAN_CTL</span> <span class="o">|</span> <span class="n">CyENB_RCVR</span> <span class="o">|</span> <span class="n">CyENB_XMTR</span><span class="p">);</span>

		<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CyRxData</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">CH_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc startup Z card %d, channel %d, &quot;</span>
			<span class="s">&quot;base_addr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">,</span> <span class="n">C_CH_ENABLE</span><span class="p">);</span>
<span class="cp">#ifdef Z_WAKE</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span>
			  <span class="n">C_IN_TXBEMPTY</span> <span class="o">|</span> <span class="n">C_IN_TXLOWWM</span> <span class="o">|</span> <span class="n">C_IN_RXHIWM</span> <span class="o">|</span>
			  <span class="n">C_IN_RXNNDT</span> <span class="o">|</span> <span class="n">C_IN_IOCTLW</span> <span class="o">|</span> <span class="n">C_IN_MDCD</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span>
			  <span class="n">C_IN_IOCTLW</span> <span class="o">|</span> <span class="n">C_IN_MDCD</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span>
			  <span class="n">C_IN_TXBEMPTY</span> <span class="o">|</span> <span class="n">C_IN_TXLOWWM</span> <span class="o">|</span> <span class="n">C_IN_RXHIWM</span> <span class="o">|</span>
			  <span class="n">C_IN_RXNNDT</span> <span class="o">|</span> <span class="n">C_IN_MDCD</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">intr_enable</span><span class="p">,</span> <span class="n">C_IN_MDCD</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
<span class="cp">#endif				</span><span class="cm">/* Z_WAKE */</span><span class="cp"></span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:startup(1) retval on ttyC%d was &quot;</span>
				<span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Flush RX buffers before raising DTR and RTS */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_FLUSH_RX</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:startup(2) retval on ttyC%d was &quot;</span>
				<span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set timeout !!! */</span>
		<span class="cm">/* set RTS and DTR !!! */</span>
		<span class="n">tty_port_raise_dtr_rts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

		<span class="cm">/* enable send, recv, modem !!! */</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">in_use</span> <span class="o">=</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_idle</span> <span class="o">=</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_idle</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CY_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc startup done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* startup */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CyTxRdy</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_INTBACK</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:start_xmit retval on ttyC%d was &quot;</span>
				<span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#else				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
		<span class="cm">/* Don&#39;t have to do anything at this time */</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* start_xmit */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine shuts down a serial port; interrupts are disabled,</span>
<span class="cm"> * and DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Clear delta_msr_wait queue to avoid mem leaks. */</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span>
			<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>

		<span class="n">cyy_issue_cmd</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCHAN_CTL</span> <span class="o">|</span> <span class="n">CyDIS_RCVR</span><span class="p">);</span>
		<span class="cm">/* it may be appropriate to clear _XMIT at</span>
<span class="cm">		   some later date (after testing)!!! */</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CY_DEBUG_OPEN</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc shutdown Z card %d, channel %d, &quot;</span>
			<span class="s">&quot;base_addr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">)</span>
			<span class="n">tty_port_lower_dtr_rts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CY_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc shutdown done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>				<span class="cm">/* shutdown */</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * cy_open() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.  It</span>
<span class="cm"> * performs the serial-specific initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first_line</span> <span class="o">+</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nports</span> <span class="o">&amp;&amp;</span>
				<span class="n">line</span> <span class="o">&gt;=</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first_line</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">NR_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">line</span> <span class="o">-</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first_line</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* If the card&#39;s firmware hasn&#39;t been loaded,</span>
<span class="cm">	   treat it as absent from the system.  This</span>
<span class="cm">	   will make the user pay attention.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">FIRM_ID</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">firm_id</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">hw_ver</span> <span class="o">==</span> <span class="n">ZE_V1</span> <span class="o">&amp;&amp;</span> <span class="n">cyz_fpga_loaded</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firm_id</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">ZFIRM_HLT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:Cyclades-Z Error: you &quot;</span>
					<span class="s">&quot;need an external power supply for &quot;</span>
					<span class="s">&quot;this number of ports.</span><span class="se">\n</span><span class="s">Firmware &quot;</span>
					<span class="s">&quot;halted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:Cyclades-Z firmware not &quot;</span>
					<span class="s">&quot;yet loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* In case this Z board is operating in interrupt mode, its</span>
<span class="cm">		   interrupts should be enabled as soon as the first open</span>
<span class="cm">		   happens to one of its ports. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">intr_enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">intr</span><span class="p">;</span>

				<span class="cm">/* Enable interrupts on the PLX chip */</span>
				<span class="n">intr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span>
						<span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0900</span><span class="p">;</span>
				<span class="n">cy_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span>
						<span class="n">intr_ctrl_stat</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
				<span class="cm">/* Enable interrupts on the FW */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">C_CM_IRQ_ENBL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:IRQ enable retval &quot;</span>
						<span class="s">&quot;was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">intr_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
		<span class="cm">/* Make sure this Z port really exists in hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span> <span class="o">+</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_open ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_open ttyC%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CY_DEBUG_COUNT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_open (%d): incrementing count to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the port is the middle of closing, bail out now</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wait_event_interruptible_tty</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_wait</span><span class="p">,</span>
				<span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start up serial port</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cy_startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CY_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_open returning after block_til_ready &quot;</span>
			<span class="s">&quot;with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

<span class="cp">#ifdef CY_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_open done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_open */</span>

<span class="cm">/*</span>
<span class="cm"> * cy_wait_until_sent() --- wait until the transmitter is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">char_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Just in case.... */</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the check interval to be 1/5 of the estimated time to</span>
<span class="cm">	 * send a single character, and make it at least 1.  The check</span>
<span class="cm">	 * interval should also be less than the timeout.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: we have to use pretty tight timings here to satisfy</span>
<span class="cm">	 * the NIST-PCTS.</span>
<span class="cm">	 */</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">-</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span><span class="p">;</span>
	<span class="n">char_time</span> <span class="o">=</span> <span class="n">char_time</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">char_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">char_time</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">char_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the transmitter hasn&#39;t cleared in twice the approximate</span>
<span class="cm">	 * amount of time to send the entire FIFO, it probably won&#39;t</span>
<span class="cm">	 * ever clear.  This assumes the UART isn&#39;t doing flow</span>
<span class="cm">	 * control, which is currently the case.  Hence, if it ever</span>
<span class="cm">	 * takes longer than info-&gt;timeout, this is probably due to a</span>
<span class="cm">	 * UART bug of some kind.  So, we clamp the timeout parameter at</span>
<span class="cm">	 * 2*info-&gt;timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CyTxRdy</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">orig_jiffies</span> <span class="o">+</span>
					<span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Run one more char cycle */</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">char_time</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_flush_buffer ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* If it is a Z card, flush the on-board</span>
<span class="cm">					   buffers as well */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_FLUSH_TX</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc: flush_buffer retval on ttyC%d &quot;</span>
				<span class="s">&quot;was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* cy_flush_buffer */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_do_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cyclades_port</span><span class="p">,</span>
								<span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stop accepting input */</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyRxData</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Waiting for on-board buffers to be empty before</span>
<span class="cm">			   closing the port */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cy_wait_until_sent</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef Z_WAKE</span>
		<span class="cm">/* Waiting for on-board buffers to be empty before closing</span>
<span class="cm">		   the port */</span>
		<span class="k">struct</span> <span class="n">CH_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">flow_status</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_FS_TXIDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTLW</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_close retval on &quot;</span>
					<span class="s">&quot;ttyC%d was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cy_shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called when a particular tty device is closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty_port_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* cy_close */</span>

<span class="cm">/* This routine gets called when tty_write has put something into</span>
<span class="cm"> * the write_queue.  The characters may come from user space or</span>
<span class="cm"> * kernel space.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will return the number of characters actually</span>
<span class="cm"> * accepted for writing.</span>
<span class="cm"> *</span>
<span class="cm"> * If the port is not already transmitting stuff, start it off by</span>
<span class="cm"> * enabling interrupts.  The interrupt service routine will then</span>
<span class="cm"> * ensure that the characters are sent.</span>
<span class="cm"> * If the port is already active, there is no need to kick it.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_write ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_bytes</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_idle</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
		<span class="n">start_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_write */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by the kernel to write a single</span>
<span class="cm"> * character to the tty device.  If the kernel uses this routine,</span>
<span class="cm"> * it must call the flush_chars() routine (if defined) when it is</span>
<span class="cm"> * done stuffing characters into the driver.  If there is no room</span>
<span class="cm"> * in the queue, the character is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_put_char ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">&amp;=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_bytes</span><span class="o">++</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_idle</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_put_char */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by the kernel after it has written a</span>
<span class="cm"> * series of characters to the tty device using put_char().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_flush_chars ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">start_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* cy_flush_chars */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine returns the numbers of characters the tty driver</span>
<span class="cm"> * will accept for queuing to be written.  This number is subject</span>
<span class="cm"> * to change as output buffers get emptied, or if the output flow</span>
<span class="cm"> * control is activated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_IO</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_write_room ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">SERIAL_XMIT_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_write_room */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef Z_EXT_CHARS_IN_BUFFER</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#endif				</span><span class="cm">/* Z_EXT_CHARS_IN_BUFFER */</span><span class="cp"></span>
<span class="cp">#ifdef CY_DEBUG_IO</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_chars_in_buffer ttyC%d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
<span class="cp">#ifdef Z_EXT_CHARS_IN_BUFFER</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">BUF_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">buf_ctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">char_count</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">tx_put</span><span class="p">,</span> <span class="n">tx_get</span><span class="p">,</span> <span class="n">tx_bufsize</span><span class="p">;</span>

		<span class="n">tx_get</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_get</span><span class="p">);</span>
		<span class="n">tx_put</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_put</span><span class="p">);</span>
		<span class="n">tx_bufsize</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf_ctrl</span><span class="o">-&gt;</span><span class="n">tx_bufsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_put</span> <span class="o">&gt;=</span> <span class="n">tx_get</span><span class="p">)</span>
			<span class="n">char_count</span> <span class="o">=</span> <span class="n">tx_put</span> <span class="o">-</span> <span class="n">tx_get</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">char_count</span> <span class="o">=</span> <span class="n">tx_put</span> <span class="o">-</span> <span class="n">tx_get</span> <span class="o">+</span> <span class="n">tx_bufsize</span><span class="p">;</span>
<span class="cp">#ifdef CY_DEBUG_IO</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_chars_in_buffer ttyC%d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+</span> <span class="n">char_count</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+</span> <span class="n">char_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* Z_EXT_CHARS_IN_BUFFER */</span><span class="cp"></span>
<span class="p">}</span>				<span class="cm">/* cy_chars_in_buffer */</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * cy_ioctl() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_baud_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">co</span><span class="p">,</span> <span class="n">co_val</span><span class="p">,</span> <span class="n">bpr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cy_clock</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;=</span> <span class="n">CD1400_REV_J</span><span class="p">)</span> <span class="o">?</span> <span class="mi">60000000</span> <span class="o">:</span>
			<span class="mi">25000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine which prescaler to use */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">co</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">co_val</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="n">co</span><span class="p">;</span> <span class="n">co</span><span class="o">--</span><span class="p">,</span> <span class="n">co_val</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_clock</span> <span class="o">/</span> <span class="n">co_val</span> <span class="o">/</span> <span class="n">baud</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy_clock</span> <span class="o">/</span> <span class="n">co_val</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">baud</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpr</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">bpr</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">bpr</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="n">co</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine finds or computes the various line characteristics.</span>
<span class="cm"> * It used to be called config_setup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_set_line_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">,</span> <span class="n">iflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span> <span class="cm">/* XXX can this happen at all? */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>
	<span class="n">iflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the tty-&gt;alt_speed kludge</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_HI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_VHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_SHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASYNC_SPD_WARP</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cflags</span><span class="p">;</span>

		<span class="cm">/* baud rate */</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">)</span>
				<span class="n">baud_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">baud_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="n">CD1400_MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="n">CD1400_MAX_SPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* find the baud index */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>	<span class="cm">/* CD1400_MAX_SPEED */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cyy_baud_calc</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">baud_rate</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;=</span> <span class="n">CD1400_REV_J</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* It is a CD1400 rev. J or later */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">baud_bpr_60</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Tx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">baud_co_60</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Tx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">baud_bpr_60</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Rx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="n">baud_co_60</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Rx CO */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">baud_bpr_25</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Tx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">baud_co_25</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Tx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">baud_bpr_25</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Rx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="n">baud_co_25</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>	<span class="cm">/* Rx CO */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get it right for 134.5 baud */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">/</span> <span class="mi">269</span><span class="p">)</span> <span class="o">+</span>
					<span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">/</span>
					<span class="n">baud_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">/</span>
					<span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* this needs to be propagated into the card info */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* By tradition (is it a standard?) a baud rate of zero</span>
<span class="cm">		   implies the line should be/has been closed.  A bit</span>
<span class="cm">		   later in this routine such a test is performed. */</span>

		<span class="cm">/* byte size and parity */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* receive threshold */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_threshold</span> <span class="o">?</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_threshold</span> <span class="o">:</span> <span class="n">baud_cor3</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor2</span> <span class="o">=</span> <span class="n">CyETC</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS5</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">=</span> <span class="n">Cy_5_BITS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS6</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">=</span> <span class="n">Cy_6_BITS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS7</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">=</span> <span class="n">Cy_7_BITS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS8</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">=</span> <span class="n">Cy_8_BITS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">|=</span> <span class="n">Cy_2_STOP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">|=</span> <span class="n">CyPARITY_O</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">|=</span> <span class="n">CyPARITY_E</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">|=</span> <span class="n">CyPARITY_NONE</span><span class="p">;</span>

		<span class="cm">/* CTS flow control flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor2</span> <span class="o">|=</span> <span class="n">CyCtsAE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CyCtsAE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>

	 <span class="cm">/***********************************************</span>
<span class="cm">	    The hardware option, CyRtsAO, presents RTS when</span>
<span class="cm">	    the chip has characters to send.  Since most modems</span>
<span class="cm">	    use RTS as reverse (inbound) flow control, this</span>
<span class="cm">	    option is not used.  If inbound flow control is</span>
<span class="cm">	    necessary, DTR can be programmed to provide the</span>
<span class="cm">	    appropriate signals for use with a non-standard</span>
<span class="cm">	    cable.  Contact Marcio Saito for details.</span>
<span class="cm">	 ***********************************************/</span>

		<span class="n">channel</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

		<span class="cm">/* tx and rx baud rate */</span>

		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTCOR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyTBPR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRCOR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRBPR</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span><span class="p">);</span>

		<span class="cm">/* set line characteristics  according configuration */</span>

		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySCHR1</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySCHR2</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR2</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor2</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR3</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR4</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor4</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR5</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor5</span><span class="p">);</span>

		<span class="n">cyy_issue_cmd</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR_CHANGE</span> <span class="o">|</span> <span class="n">CyCOR1ch</span> <span class="o">|</span> <span class="n">CyCOR2ch</span> <span class="o">|</span>
				<span class="n">CyCOR3ch</span><span class="p">);</span>

		<span class="cm">/* !!! Is this needed? */</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRTPR</span><span class="p">,</span>
			<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span> <span class="o">?</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">));</span>
		<span class="cm">/* 10ms rx timeout */</span>

		<span class="n">cflags</span> <span class="o">=</span> <span class="n">CyCTS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">C_CLOCAL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">cflags</span> <span class="o">|=</span> <span class="n">CyDSR</span> <span class="o">|</span> <span class="n">CyRI</span> <span class="o">|</span> <span class="n">CyDCD</span><span class="p">;</span>
		<span class="cm">/* without modem intr */</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CyMdmCh</span><span class="p">);</span>
		<span class="cm">/* act on 1-&gt;0 modem transitions */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rflow</span><span class="p">)</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMCOR1</span><span class="p">,</span> <span class="n">cflags</span> <span class="o">|</span> <span class="n">rflow_thr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMCOR1</span><span class="p">,</span> <span class="n">cflags</span><span class="p">);</span>
		<span class="cm">/* act on 0-&gt;1 modem transitions */</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMCOR2</span><span class="p">,</span> <span class="n">cflags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* baud rate is zero, turn off line */</span>
			<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIOCM_DTR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">CH_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">sw_flow</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* baud rate */</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">)</span>
				<span class="n">baud_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">baud_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="n">CYZ_MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="n">CYZ_MAX_SPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get it right for 134.5 baud */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">/</span> <span class="mi">269</span><span class="p">)</span> <span class="o">+</span>
					<span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_SPD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">ASYNC_SPD_CUST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">/</span>
					<span class="n">baud_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">/</span>
					<span class="n">baud</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* this needs to be propagated into the card info */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* byte size and parity */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CS5</span>:
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span> <span class="n">C_DL_CS5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS6</span>:
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span> <span class="n">C_DL_CS6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS7</span>:
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span> <span class="n">C_DL_CS7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CS8</span>:
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span> <span class="n">C_DL_CS8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span>
				  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">)</span> <span class="o">|</span> <span class="n">C_DL_2STOP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">,</span>
				  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_data_l</span><span class="p">)</span> <span class="o">|</span> <span class="n">C_DL_1STOP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span>
				<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_parity</span><span class="p">,</span> <span class="n">C_PR_ODD</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_parity</span><span class="p">,</span> <span class="n">C_PR_EVEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">comm_parity</span><span class="p">,</span> <span class="n">C_PR_NONE</span><span class="p">);</span>

		<span class="cm">/* CTS flow control flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">hw_flow</span><span class="p">,</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">hw_flow</span><span class="p">)</span> <span class="o">|</span> <span class="n">C_RS_CTS</span> <span class="o">|</span> <span class="n">C_RS_RTS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">hw_flow</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">hw_flow</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="p">(</span><span class="n">C_RS_CTS</span> <span class="o">|</span> <span class="n">C_RS_RTS</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* As the HW flow control is done in firmware, the driver</span>
<span class="cm">		   doesn&#39;t need to care about it */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>

		<span class="cm">/* XON/XOFF/XANY flow control flags */</span>
		<span class="n">sw_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sw_flow</span> <span class="o">|=</span> <span class="n">C_FL_OXX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iflag</span> <span class="o">&amp;</span> <span class="n">IXANY</span><span class="p">)</span>
				<span class="n">sw_flow</span> <span class="o">|=</span> <span class="n">C_FL_OIXANY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">sw_flow</span><span class="p">,</span> <span class="n">sw_flow</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTL</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:set_line_char retval on ttyC%d &quot;</span>
				<span class="s">&quot;was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* CD sensitivity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* baud rate is zero, turn off line */</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">,</span>
				  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">C_RS_DTR</span><span class="p">);</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_line_char dropping Z DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">,</span>
				  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">)</span> <span class="o">|</span> <span class="n">C_RS_DTR</span><span class="p">);</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_line_char raising Z DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTLM</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:set_line_char(2) retval on ttyC%d &quot;</span>
				<span class="s">&quot;was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* set_line_char */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_get_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">-</span> <span class="n">cy_card</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
		<span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span><span class="p">,</span>
		<span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">,</span>
		<span class="p">.</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">,</span>
		<span class="p">.</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hub6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/*!!! */</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cy_set_serial_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serial_struct</span> <span class="n">new_serial</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">||</span>
				<span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">!=</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_USR_MASK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_USR_MASK</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">check_and_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, past this point, all the error checking has been done.</span>
<span class="cm">	 * At this point, we start making changes.....</span>
<span class="cm">	 */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">baud_base</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">custom_divisor</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">custom_divisor</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ASYNC_FLAGS</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_FLAGS</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

<span class="nl">check_and_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cy_set_line_char</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cy_startup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* set_serial_info */</span>

<span class="cm">/*</span>
<span class="cm"> * get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> *	    is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> *	    release the bus after transmitting. This must be done when</span>
<span class="cm"> *	    the transmit shift register is empty, not be done when the</span>
<span class="cm"> *	    transmit holding register is empty.  This functionality</span>
<span class="cm"> *	    allows an RS485 driver to be written in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lsr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CyTxRdy</span> <span class="o">|</span> <span class="n">CyTxMpty</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCSER_TEMT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Not supported yet */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR1</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR2</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyRTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyDTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyRTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyDTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyDCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyRI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyDSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CyCTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lstatus</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lstatus</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_status</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_RI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">lstatus</span> <span class="o">&amp;</span> <span class="n">C_RS_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">end:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_tiomget */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cy_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">CH_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cyz_is_loaded</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
			<span class="n">rs</span> <span class="o">|=</span> <span class="n">C_RS_RTS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
			<span class="n">rs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">C_RS_RTS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span> <span class="o">|=</span> <span class="n">C_RS_DTR</span><span class="p">;</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_modem_info raising Z DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">C_RS_DTR</span><span class="p">;</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:set_modem_info clearing &quot;</span>
				<span class="s">&quot;Z DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTLM</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:set_modem_info retval on ttyC%d &quot;</span>
				<span class="s">&quot;was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cy_break() --- routine which turns the break handling on or off</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Let the transmit ISR take care of this (since it</span>
<span class="cm">		   requires stuffing characters into the output stream).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">breakon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">start_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">breakoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">start_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">,</span>
				<span class="n">C_CM_SET_BREAK</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cyc:cy_break (set) retval on &quot;</span>
					<span class="s">&quot;ttyC%d was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">,</span>
				<span class="n">C_CM_CLR_BREAK</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_break (clr) retval &quot;</span>
					<span class="s">&quot;on ttyC%d was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
					<span class="n">retval</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_break */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CyREC_FIFO</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span> <span class="o">|=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="n">CyREC_FIFO</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR3</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span><span class="p">);</span>
		<span class="n">cyy_issue_cmd</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR_CHANGE</span> <span class="o">|</span> <span class="n">CyCOR3ch</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* set_threshold */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCOR3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CyREC_FIFO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* get_threshold */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRTPR</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* set_timeout */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyRTPR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* get_timeout */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_cflags_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cyclades_icount</span> <span class="o">*</span><span class="n">cprev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_icount</span> <span class="n">cnow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>	<span class="cm">/* atomic copy */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>	<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_RNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">rng</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_DSR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CD</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnow</span><span class="p">.</span><span class="n">cts</span> <span class="o">!=</span> <span class="n">cprev</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">));</span>

	<span class="o">*</span><span class="n">cprev</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine allows the tty driver to implement device-</span>
<span class="cm"> * specific ioctl&#39;s.  If the ioctl number passed in cmd is</span>
<span class="cm"> * not recognized by the driver, it should return ENOIOCTLCMD.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cy_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_icount</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* kernel counter temps */</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_ioctl ttyC%d, cmd = %x arg = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CYGETMON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mon</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETTHRESH</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">get_threshold</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETTHRESH</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">set_threshold</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETDEFTHRESH</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_threshold</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETDEFTHRESH</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_threshold</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETTIMEOUT</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">get_timeout</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETTIMEOUT</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">set_timeout</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETDEFTIMEOUT</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETDEFTIMEOUT</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_timeout</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETRFLOW</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rflow</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETRFLOW</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rflow</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYSETRTSDTR_INV</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETRTSDTR_INV</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETCD1400VER</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_rev</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
	<span class="k">case</span> <span class="n">CYZSETPOLLCYCLE</span>:
		<span class="n">cyz_polling_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYZGETPOLLCYCLE</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">cyz_polling_cycle</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
	<span class="k">case</span> <span class="n">CYSETWAIT</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">arg</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CYGETWAIT</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">/</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCGSERIAL</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cy_get_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSERIAL</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">cy_set_serial_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>:	<span class="cm">/* Get line status register */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait for any of the 4 modem inputs (DCD,RI,DSR,CTS) to change</span>
<span class="cm">		 * - mask passed in arg for lines of interest</span>
<span class="cm">		 *   (use |&#39;ed TIOCM_RNG/DSR/CD/CTS for masking)</span>
<span class="cm">		 * Caller should use TIOCGICOUNT to see which one it was</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">TIOCMIWAIT</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* note the counters on entry */</span>
		<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">delta_msr_wait</span><span class="p">,</span>
				<span class="n">cy_cflags_changed</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnow</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)</span>
<span class="cm">		 * Return: write counters to the user passed counter struct</span>
<span class="cm">		 * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for</span>
<span class="cm">		 *     RI where only 0-&gt;1 is counted.</span>
<span class="cm">		 */</span>
	<span class="nl">default:</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_ioctl done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_ioctl */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cy_get_icount</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serial_icounter_struct</span> <span class="o">*</span><span class="n">sic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_icount</span> <span class="n">cnow</span><span class="p">;</span>	<span class="cm">/* Used to snapshot */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cnow</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">cts</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">cts</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dsr</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">rng</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rng</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">dcd</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">overrun</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">parity</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">brk</span><span class="p">;</span>
	<span class="n">sic</span><span class="o">-&gt;</span><span class="n">buf_overrun</span> <span class="o">=</span> <span class="n">cnow</span><span class="p">.</span><span class="n">buf_overrun</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine allows the tty driver to be notified when</span>
<span class="cm"> * device&#39;s termios settings have changed.  Note that a</span>
<span class="cm"> * well-designed tty driver should be prepared to accept the case</span>
<span class="cm"> * where old == NULL, and try to do something rational.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_set_termios ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">cy_set_line_char</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cy_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * No need to wake up processes in open wait, since they</span>
<span class="c">	 * sample the CLOCAL flag once, and don&#39;t recheck it.</span>
<span class="c">	 * XXX  It&#39;s not clear whether the current behavior is correct</span>
<span class="c">	 * or not.  Hence, this may change.....</span>
<span class="c">	 */</span>
<span class="c">	if (!(old_termios-&gt;c_cflag &amp; CLOCAL) &amp;&amp;</span>
<span class="c">	    (tty-&gt;termios-&gt;c_cflag &amp; CLOCAL))</span>
<span class="c">		wake_up_interruptible(&amp;info-&gt;port.open_wait);</span>
<span class="cp">#endif</span>
<span class="p">}</span>				<span class="cm">/* cy_set_termios */</span>

<span class="cm">/* This function is used to send a high-priority XON/XOFF character to</span>
<span class="cm">   the device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_send_xchar&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="n">cy_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_SENDXOFF</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_SENDXON</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This routine is called by the upper-layer tty layer to signal</span>
<span class="cm">   that incoming characters should be throttled because the input</span>
<span class="cm">   buffers are close to full.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_THROTTLE</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:throttle %s: %ld...ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">cy_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* cy_throttle */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine notifies the tty driver that it should signal</span>
<span class="cm"> * that characters can now be sent to the tty without fear of</span>
<span class="cm"> * overrunning the input buffers of the line disciplines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_THROTTLE</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:unthrottle %s: %ld...ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">),</span> <span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cy_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">TIOCM_RTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">throttle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* cy_unthrottle */</span>

<span class="cm">/* cy_start and cy_stop provide software output flow control as a</span>
<span class="cm">   function of XON/XOFF, software CTS, and other such stuff.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_stop ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_stop&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CyTxRdy</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* cy_stop */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_start ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_start&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">,</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CySRER</span><span class="p">)</span> <span class="o">|</span> <span class="n">CyTxRdy</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>				<span class="cm">/* cy_start */</span>

<span class="cm">/*</span>
<span class="cm"> * cy_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cy_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef CY_DEBUG_OTHER</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cyc:cy_hangup ttyC%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serial_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cy_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cy_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">cy_shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>				<span class="cm">/* cy_hangup */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cyy_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cyclades_port</span><span class="p">,</span>
			<span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cyy_writeb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyCAR</span><span class="p">,</span> <span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">cd</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyMSVR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CyDCD</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyy_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cyclades_port</span><span class="p">,</span>
			<span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cyy_change_rts_dtr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">raise</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">raise</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cyz_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cyclades_port</span><span class="p">,</span>
			<span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">C_RS_DCD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cyz_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cyclades_port</span><span class="p">,</span>
			<span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CH_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">-</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rs</span><span class="p">;</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raise</span><span class="p">)</span>
		<span class="n">rs</span> <span class="o">|=</span> <span class="n">C_RS_RTS</span> <span class="o">|</span> <span class="n">C_RS_DTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">C_RS_RTS</span> <span class="o">|</span> <span class="n">C_RS_DTR</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_ctrl</span><span class="o">-&gt;</span><span class="n">rs_control</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cyz_issue_cmd</span><span class="p">(</span><span class="n">cinfo</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">C_CM_IOCTLM</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: retval on ttyC%d was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#ifdef CY_DEBUG_DTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: raising Z DTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">cyy_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">cyy_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">cyy_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">cy_do_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">cyz_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">cyz_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">cyz_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">cy_do_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> * cy_init() and friends</span>
<span class="cm"> *</span>
<span class="cm"> * cy_init() is called at boot-time to initialize the serial driver.</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cy_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">intr_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclades: cannot allocate ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span>
			<span class="n">channel</span><span class="o">++</span><span class="p">,</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">CYCLADES_MAGIC</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">cinfo</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">CLOSING_WAIT_DELAY</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">STD_COM_FLAGS</span><span class="p">;</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">shutdown_wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">FIRM_ID</span> <span class="o">*</span><span class="n">firm_id</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ZFW_CTRL</span> <span class="o">*</span><span class="n">zfw_ctrl</span><span class="p">;</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cyz_port_ops</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_STARTECH</span><span class="p">;</span>

			<span class="n">zfw_ctrl</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firm_id</span><span class="o">-&gt;</span><span class="n">zfwctrl_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">ch_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfw_ctrl</span><span class="o">-&gt;</span><span class="n">ch_ctrl</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyz</span><span class="p">.</span><span class="n">buf_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfw_ctrl</span><span class="o">-&gt;</span><span class="n">buf_ctrl</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">hw_ver</span> <span class="o">==</span> <span class="n">ZO_V1</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">CYZ_FIFO_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">CYZ_FIFO_SIZE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
			<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_rx_full_timer</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				<span class="n">cyz_rx_restart</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">chip_number</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">;</span>

			<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cyy_port_ops</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_CIRRUS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_size</span> <span class="o">=</span> <span class="n">CyMAX_CHAR_FIFO</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor1</span> <span class="o">=</span> <span class="n">CyPARITY_NONE</span> <span class="o">|</span> <span class="n">Cy_1_STOP</span> <span class="o">|</span> <span class="n">Cy_8_BITS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor2</span> <span class="o">=</span> <span class="n">CyETC</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cor3</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* _very_ small rcv threshold */</span>

			<span class="n">chip_number</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">/</span> <span class="n">CyPORTS_PER_CHIP</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cyy</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">cy_chip_offset</span><span class="p">[</span><span class="n">chip_number</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">=</span> <span class="n">cyy_readb</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">CyGFRCR</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">&gt;=</span> <span class="n">CD1400_REV_J</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* It is a CD1400 rev. J or later */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">baud_bpr_60</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Tx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">baud_co_60</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Tx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">baud_bpr_60</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Rx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="n">baud_co_60</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Rx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tbpr</span> <span class="o">=</span> <span class="n">baud_bpr_25</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Tx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">baud_co_25</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Tx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rbpr</span> <span class="o">=</span> <span class="n">baud_bpr_25</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Rx BPR */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rco</span> <span class="o">=</span> <span class="n">baud_co_25</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>	<span class="cm">/* Rx CO */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rtsdtr_inv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">CyTIMEOUT</span> <span class="o">|</span> <span class="n">CySPECHAR</span> <span class="o">|</span>
				<span class="n">CyBREAK</span> <span class="o">|</span> <span class="n">CyPARITY</span> <span class="o">|</span> <span class="n">CyFRAME</span> <span class="o">|</span> <span class="n">CyOVERRUN</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_timerlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_timerlist</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CY_PCI_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Cyclades-Z polling initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize chips on Cyclom-Y card -- return number of valid</span>
<span class="cm">   chips (which is number of ports/4) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">__devinit</span> <span class="nf">cyy_init_card</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">true_base_addr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_number</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">true_base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cy_HwReset</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Cy_HwReset is 0x1400 */</span>
	<span class="n">cy_writeb</span><span class="p">(</span><span class="n">true_base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cy_ClrIntr</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Cy_ClrIntr is 0x1800 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500L</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chip_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip_number</span> <span class="o">&lt;</span> <span class="n">CyMAX_CHIPS_PER_CARD</span><span class="p">;</span>
							<span class="n">chip_number</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base_addr</span> <span class="o">=</span>
		    <span class="n">true_base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_chip_offset</span><span class="p">[</span><span class="n">chip_number</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*************</span>
<span class="cm">			printk(&quot; chip #%d at %#6lx is never idle (CCR != 0)\n&quot;,</span>
<span class="cm">			chip_number, (unsigned long)base_addr);</span>
<span class="cm">			*************/</span>
			<span class="k">return</span> <span class="n">chip_number</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyGFRCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10L</span><span class="p">);</span>

		<span class="cm">/* The Cyclom-16Y does not decode address bit 9 and therefore</span>
<span class="cm">		   cannot distinguish between references to chip 0 and a non-</span>
<span class="cm">		   existent chip 4.  If the preceding clearing of the supposed</span>
<span class="cm">		   chip 4 GFRCR register appears at chip 0, there is no chip 4</span>
<span class="cm">		   and this must be a Cyclom-16Y, not a Cyclom-32Ye.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip_number</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">readb</span><span class="p">(</span><span class="n">true_base_addr</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">cy_chip_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">CyGFRCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">chip_number</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyCCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="n">CyCHIP_RESET</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyGFRCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			   printk(&quot; chip #%d at %#6lx is not responding &quot;,</span>
<span class="cm">			   chip_number, (unsigned long)base_addr);</span>
<span class="cm">			   printk(&quot;(GFRCR stayed 0)\n&quot;,</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">chip_number</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="mh">0xf0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyGFRCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))))</span> <span class="o">!=</span>
				<span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			printk(&quot; chip #%d at %#6lx is not valid (GFRCR == &quot;</span>
<span class="cm">					&quot;%#2x)\n&quot;,</span>
<span class="cm">					chip_number, (unsigned long)base_addr,</span>
<span class="cm">					base_addr[CyGFRCR&lt;&lt;index]);</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">chip_number</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyGCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="n">CyCH0_SERIAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyGFRCR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">CD1400_REV_J</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* It is a CD1400 rev. J or later */</span>
			<span class="cm">/* Impossible to reach 5ms with this chip.</span>
<span class="cm">			   Changed to 2ms instead (f = 500 Hz). */</span>
			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyPPR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="n">CyCLOCK_60_2MS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* f = 200 Hz */</span>
			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyPPR</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">),</span> <span class="n">CyCLOCK_25_5MS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		   printk(&quot; chip #%d at %#6lx is rev 0x%2x\n&quot;,</span>
<span class="cm">		   chip_number, (unsigned long)base_addr,</span>
<span class="cm">		   readb(base_addr+(CyGFRCR&lt;&lt;index)));</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">chip_number</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cyy_init_card */</span>

<span class="cm">/*</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> * cy_detect_isa() - Probe for Cyclom-Y/ISA boards.</span>
<span class="cm"> * sets global variables and return the number of ISA boards found.</span>
<span class="cm"> * ---------------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cy_detect_isa</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISA</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cy_isa_irq</span><span class="p">,</span> <span class="n">nboard</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cy_isa_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cy_isa_nchan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isparam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nboard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for module parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isparam</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cy_isa_addresses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">maddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maddr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* scan the address table probing for Cyclom-Y/ISA boards */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_ISA_ADDRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isa_address</span> <span class="o">=</span> <span class="n">cy_isa_addresses</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isa_address</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">nboard</span><span class="p">;</span>

		<span class="cm">/* probe for CD1400... */</span>
		<span class="n">cy_isa_address</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">isa_address</span><span class="p">,</span> <span class="n">CyISA_Ywin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_isa_address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclom-Y/ISA: can&#39;t remap base &quot;</span>
					<span class="s">&quot;address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cy_isa_nchan</span> <span class="o">=</span> <span class="n">CyPORTS_PER_CHIP</span> <span class="o">*</span>
			<span class="n">cyy_init_card</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_isa_nchan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isparam</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">cy_isa_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="cm">/* find out the board&#39;s irq by probing */</span>
			<span class="n">cy_isa_irq</span> <span class="o">=</span> <span class="n">detect_isa_irq</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_isa_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclom-Y/ISA found at 0x%lx, but the &quot;</span>
				<span class="s">&quot;IRQ could not be detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cy_next_channel</span> <span class="o">+</span> <span class="n">cy_isa_nchan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NR_PORTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclom-Y/ISA found at 0x%lx, but no &quot;</span>
				<span class="s">&quot;more channels are available. Change NR_PORTS &quot;</span>
				<span class="s">&quot;in cyclades.c and recompile kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nboard</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fill the next cy_card structure available */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">NR_CARDS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no more cy_cards available */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclom-Y/ISA found at 0x%lx, but no &quot;</span>
				<span class="s">&quot;more cards can be used. Change NR_CARDS in &quot;</span>
				<span class="s">&quot;cyclades.c and recompile kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nboard</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* allocate IRQ */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">cy_isa_irq</span><span class="p">,</span> <span class="n">cyy_interrupt</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Cyclom-Y&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cyclom-Y/ISA found at 0x%lx, but &quot;</span>
				<span class="s">&quot;could not allocate IRQ#%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cy_isa_address</span><span class="p">,</span> <span class="n">cy_isa_irq</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">nboard</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set cy_card */</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">cy_isa_address</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cy_isa_irq</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bus_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">first_line</span> <span class="o">=</span> <span class="n">cy_next_channel</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">num_chips</span> <span class="o">=</span> <span class="n">cy_isa_nchan</span> <span class="o">/</span> <span class="n">CyPORTS_PER_CHIP</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">nports</span> <span class="o">=</span> <span class="n">cy_isa_nchan</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_init_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">cy_isa_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">cy_isa_address</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nboard</span><span class="o">++</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Cyclom-Y/ISA #%d: 0x%lx-0x%lx, IRQ%d found: &quot;</span>
			<span class="s">&quot;%d channels starting from port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cy_isa_address</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">cy_isa_address</span> <span class="o">+</span> <span class="p">(</span><span class="n">CyISA_Ywin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
			<span class="n">cy_isa_irq</span><span class="p">,</span> <span class="n">cy_isa_nchan</span><span class="p">,</span> <span class="n">cy_next_channel</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">cy_next_channel</span><span class="p">;</span>
				<span class="n">j</span> <span class="o">&lt;</span> <span class="n">cy_next_channel</span> <span class="o">+</span> <span class="n">cy_isa_nchan</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tty_register_device</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">cy_next_channel</span> <span class="o">+=</span> <span class="n">cy_isa_nchan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nboard</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>
<span class="p">}</span>				<span class="cm">/* cy_detect_isa */</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cyc_isfwstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">,</span> <span class="n">str</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">,</span> <span class="n">str</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">cyz_fpga_copy</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fpga</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">plx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">RUNTIME_9060</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset PLX */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100L</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">);</span>

	<span class="cm">/* Reload Config. Registers from EEPROM */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100L</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">init_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20000000</span><span class="p">);</span>

	<span class="cm">/* For some yet unknown reason, once the PLX9060 reloads the EEPROM,</span>
<span class="cm">	 * the IRQ is lost and, thus, we have to re-write it to the PCI config.</span>
<span class="cm">	 * registers. This will remain here until we find a permanent fix.</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">__cyz_load_fw</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">mailbox</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fpga</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zfile_header</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zfile_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zfile_block</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">bs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="cp">#define BAD_FW KERN_ERR &quot;Bad firmware: &quot;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;too short: %u&lt;%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">h</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">config_offset</span><span class="p">;</span>
	<span class="n">bs</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">block_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_config</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">||</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">bs</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_blocks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;too short&quot;</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cyc_isfwstr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="o">||</span>
			<span class="n">cyc_isfwstr</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;bad formatted header string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;bad name &#39;%s&#39; (expected &#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_config</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">n_blocks</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">block_list</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_blocks</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;bad block ref number in cfgs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">mailbox</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* 0 is normal */</span>
			<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;nothing appropriate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">bs</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_blocks</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">file_offset</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">BAD_FW</span> <span class="s">&quot;bad block data offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* everything is OK, let&#39;s seek&#39;n&#39;load it */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">cs</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">n_config</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">mailbox</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">n_blocks</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bs</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">block_list</span><span class="p">[</span><span class="n">a</span><span class="p">]];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ZBLOCK_FPGA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fpga</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">cyz_fpga_copy</span><span class="p">(</span><span class="n">fpga</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">file_offset</span><span class="p">,</span>
						<span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ram_offset</span><span class="p">,</span>
					       <span class="n">ptr</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">file_offset</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#undef BAD_FW</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cyz_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">RUNTIME_9060</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctl_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FIRM_ID</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fid</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CUSTOM_REG</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cust</span> <span class="o">=</span> <span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ZFW_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pt_zfwctrl</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">nchan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="s">&quot;cyzfirm.bin&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check whether the firmware is already loaded and running. If</span>
<span class="cm">	   positive, skip this board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">ctl_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZFIRM_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cntval</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x190</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cntval</span> <span class="o">!=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x190</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FW counter is working, FW is running */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-Z FW already loaded. &quot;</span>
					<span class="s">&quot;Skipping board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_rel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* start boot */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="mh">0x00030800UL</span><span class="p">);</span>

	<span class="n">mailbox</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">mail_box_0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">ctl_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* stops CPU and set window to beginning of RAM */</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_CREG</span><span class="p">);</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cust</span><span class="o">-&gt;</span><span class="n">cpu_stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">plx_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ctl_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* load FPGA */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">__cyz_load_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="s">&quot;Cyclom-Z&quot;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">base_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_rel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">ctl_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fw upload successful, but fw is &quot;</span>
					<span class="s">&quot;not loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_rel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* stops CPU and set window to beginning of RAM */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_CREG</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cust</span><span class="o">-&gt;</span><span class="n">cpu_stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* clear memory */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">base_addr</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">RAM_SIZE</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cy_writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set window to last 512K of RAM */</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span> <span class="o">+</span> <span class="n">RAM_SIZE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">base_addr</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">RAM_SIZE</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
		<span class="cm">/* set window to beginning of RAM */</span>
		<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__cyz_load_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="s">&quot;Cyclom-Z&quot;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* finish boot and start boards */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_CREG</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cust</span><span class="o">-&gt;</span><span class="n">cpu_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ZFIRM_ID</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ZFIRM_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ZFIRM_HLT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;you need an external power supply &quot;</span>
				<span class="s">&quot;for this number of ports. Firmware halted and &quot;</span>
				<span class="s">&quot;board reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fid-&gt;signature = 0x%x... Waiting &quot;</span>
				<span class="s">&quot;some more time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ZFIRM_ID</span> <span class="o">&amp;&amp;</span>
				<span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">ZFIRM_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board not started in 20 seconds! &quot;</span>
					<span class="s">&quot;Giving up. (fid-&gt;signature = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;*** Warning ***: if you are &quot;</span>
				<span class="s">&quot;upgrading the FW, please power cycle the &quot;</span>
				<span class="s">&quot;system before loading the new FW to the &quot;</span>
				<span class="s">&quot;Cyclades-Z.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">ctl_addr</span><span class="p">))</span>
				<span class="n">plx_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ctl_addr</span><span class="p">);</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware started after %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pt_zfwctrl</span> <span class="o">=</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">zfwctrl_addr</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fid=&gt; %p, zfwctrl_addr=&gt; %x, npt_zfwctrl=&gt; %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">base_addr</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">zfwctrl_addr</span><span class="p">),</span>
			<span class="n">base_addr</span> <span class="o">+</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fid</span><span class="o">-&gt;</span><span class="n">zfwctrl_addr</span><span class="p">));</span>

	<span class="n">nchan</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt_zfwctrl</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">.</span><span class="n">n_channel</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-Z FW loaded: version = %x, ports = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt_zfwctrl</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">.</span><span class="n">fw_version</span><span class="p">),</span> <span class="n">nchan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no Cyclades-Z ports were found. Please &quot;</span>
			<span class="s">&quot;check the connection between the Z host card and the &quot;</span>
			<span class="s">&quot;serial expanders.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__cyz_fpga_loaded</span><span class="p">(</span><span class="n">ctl_addr</span><span class="p">))</span>
			<span class="n">plx_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ctl_addr</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Null number of ports detected. Board &quot;</span>
				<span class="s">&quot;reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt_zfwctrl</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">.</span><span class="n">op_system</span><span class="p">,</span> <span class="n">C_OS_LINUX</span><span class="p">);</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt_zfwctrl</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">.</span><span class="n">dr_version</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	   Early firmware failed to start looking for commands.</span>
<span class="cm">	   This enables firmware interrupts for those commands.</span>
<span class="cm">	 */</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">));</span>
	<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">|</span>
			<span class="mh">0x00030800UL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nchan</span><span class="p">;</span>
<span class="nl">err_rel:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cy_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">addr2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">mailbox</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">nchan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card_no</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">plx_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read PCI configuration area */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_DEVICE_ID_MASK</span><span class="p">;</span>

<span class="cp">#if defined(__alpha__)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Lo</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* below 1M? */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclom-Y/PCI not supported for low &quot;</span>
			<span class="s">&quot;addresses on Alpha systems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dis</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Z_Lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-Z/PCI not supported for low &quot;</span>
			<span class="s">&quot;addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dis</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI I/O bit incorrectly set. Ignoring &quot;</span>
				<span class="s">&quot;it...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IORESOURCE_IO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;cyclades&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to reserve resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dis</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Lo</span> <span class="o">||</span>
			<span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;Cyclom-Y&quot;</span><span class="p">;</span>

		<span class="n">addr0</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">CyPCI_Yctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t remap ctl region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr2</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">CyPCI_Ywin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t remap base region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nchan</span> <span class="o">=</span> <span class="n">CyPORTS_PER_CHIP</span> <span class="o">*</span> <span class="n">cyy_init_card</span><span class="p">(</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclom-Y PCI host card with no &quot;</span>
					<span class="s">&quot;Serial-Modules</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Z_Hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">RUNTIME_9060</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctl_addr</span><span class="p">;</span>

		<span class="n">ctl_addr</span> <span class="o">=</span> <span class="n">addr0</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">CyPCI_Zctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t remap ctl region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Disable interrupts on the PLX before resetting it */</span>
		<span class="n">cy_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span>
				<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0900</span><span class="p">);</span>

		<span class="n">plx_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">addr0</span><span class="p">);</span>

		<span class="n">mailbox</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">mail_box_0</span><span class="p">);</span>

		<span class="n">addr2</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">mailbox</span> <span class="o">==</span> <span class="n">ZE_V1</span> <span class="o">?</span> <span class="n">CyPCI_Ze_win</span> <span class="o">:</span> <span class="n">CyPCI_Zwin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t remap base region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">ZE_V1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;Cyclades-Ze&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;Cyclades-8Zo&quot;</span><span class="p">;</span>
<span class="cp">#ifdef CY_PCI_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">ZO_V1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_CREG</span><span class="p">);</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-8Zo/PCI: FPGA &quot;</span>
					<span class="s">&quot;id %lx, ver %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="mh">0xff</span> <span class="o">&amp;</span>
					<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">CUSTOM_REG</span> <span class="o">*</span><span class="p">)</span><span class="n">addr2</span><span class="p">)</span><span class="o">-&gt;</span>
						<span class="n">fpga_id</span><span class="p">)),</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)(</span><span class="mh">0xff</span> <span class="o">&amp;</span>
					<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">CUSTOM_REG</span> <span class="o">*</span><span class="p">)</span><span class="n">addr2</span><span class="p">)</span><span class="o">-&gt;</span>
						<span class="n">fpga_version</span><span class="p">)));</span>
				<span class="n">cy_writel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">loc_addr_base</span><span class="p">,</span> <span class="n">WIN_RAM</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-Z/PCI: New &quot;</span>
					<span class="s">&quot;Cyclades-Z board.  FPGA not loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="cm">/* The following clears the firmware id word.  This</span>
<span class="cm">			   ensures that the driver will not attempt to talk to</span>
<span class="cm">			   the board until it has been properly initialized.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">ZO_V1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mailbox</span> <span class="o">==</span> <span class="n">ZO_V2</span><span class="p">))</span>
				<span class="n">cy_writel</span><span class="p">(</span><span class="n">addr2</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">cyz_load_fw</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">addr2</span><span class="p">,</span> <span class="n">addr0</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
		<span class="n">nchan</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cy_next_channel</span> <span class="o">+</span> <span class="n">nchan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NR_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-8Zo/PCI found, but no &quot;</span>
			<span class="s">&quot;channels are available. Change NR_PORTS in &quot;</span>
			<span class="s">&quot;cyclades.c and recompile kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* fill the next cy_card structure available */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">card_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">card_no</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">card_no</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_no</span> <span class="o">==</span> <span class="n">NR_CARDS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no more cy_cards available */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cyclades-8Zo/PCI found, but no &quot;</span>
			<span class="s">&quot;more cards can be used. Change NR_CARDS in &quot;</span>
			<span class="s">&quot;cyclades.c and recompile kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Lo</span> <span class="o">||</span>
			<span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* allocate IRQ */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">cyy_interrupt</span><span class="p">,</span>
				<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Cyclom-Y&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">num_chips</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">/</span> <span class="n">CyPORTS_PER_CHIP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">FIRM_ID</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">firm_id</span> <span class="o">=</span> <span class="n">addr2</span> <span class="o">+</span> <span class="n">ID_ADDRESS</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ZFW_CTRL</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">zfw_ctrl</span><span class="p">;</span>

		<span class="n">zfw_ctrl</span> <span class="o">=</span> <span class="n">addr2</span> <span class="o">+</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firm_id</span><span class="o">-&gt;</span><span class="n">zfwctrl_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">);</span>

		<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">hw_ver</span> <span class="o">=</span> <span class="n">mailbox</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">num_chips</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">board_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zfw_ctrl</span><span class="o">-&gt;</span><span class="n">board_ctrl</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CYZ_INTR</span>
		<span class="cm">/* allocate IRQ only if board has an IRQ */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">cyz_interrupt</span><span class="p">,</span>
					<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Cyclades-Z&quot;</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="cm">/* set cy_card */</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">addr2</span><span class="p">;</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span> <span class="o">=</span> <span class="n">addr0</span><span class="p">;</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">bus_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">first_line</span> <span class="o">=</span> <span class="n">cy_next_channel</span><span class="p">;</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">nports</span> <span class="o">=</span> <span class="n">nchan</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">cy_init_card</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_null</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Lo</span> <span class="o">||</span>
			<span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_CYCLOM_Y_Hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable interrupts in the PCI interface */</span>
		<span class="n">plx_ver</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr2</span> <span class="o">+</span> <span class="n">CyPLX_VER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plx_ver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PLX_9050</span>:
			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">addr0</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PLX_9060</span>:
		<span class="k">case</span> <span class="n">PLX_9080</span>:
		<span class="nl">default:</span>	<span class="cm">/* Old boards, use PLX_9060 */</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">RUNTIME_9060</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctl_addr</span> <span class="o">=</span> <span class="n">addr0</span><span class="p">;</span>
			<span class="n">plx_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ctl_addr</span><span class="p">);</span>
			<span class="n">cy_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span>
				<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl_addr</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0900</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s/PCI #%d found: %d channels starting from &quot;</span>
		<span class="s">&quot;port %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card_name</span><span class="p">,</span> <span class="n">card_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">cy_next_channel</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cy_next_channel</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cy_next_channel</span> <span class="o">+</span> <span class="n">nchan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tty_register_device</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cy_next_channel</span> <span class="o">+=</span> <span class="n">nchan</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_null:</span>
	<span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">].</span><span class="n">base_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">card_no</span><span class="p">]);</span>
<span class="nl">err_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">addr0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">addr2</span><span class="p">);</span>
<span class="nl">err_reg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_dis:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">cy_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">cinfo</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* non-Z with old PLX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CyPLX_VER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">PLX_9050</span><span class="p">)</span>
		<span class="n">cy_writeb</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span> <span class="o">+</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span>
<span class="cp">#endif</span>
		<span class="n">cy_writew</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">,</span>
			<span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9060</span><span class="o">-&gt;</span><span class="n">intr_ctrl_stat</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="mh">0x0900</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">irq</span>
<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
		<span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cinfo</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">first_line</span> <span class="o">+</span>
			<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cinfo</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">cy_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cyclades&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cy_pci_dev_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">cy_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cy_pci_remove</span><span class="p">)</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cyclades_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">cur_jifs</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Dev TimeOpen   BytesOut  IdleOut    BytesIn   &quot;</span>
			<span class="s">&quot;IdleIn  Overruns  Ldisc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Output one line for each known port */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nports</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* XXX is the ldisc num worth this? */</span>
				<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">num</span> <span class="o">=</span> <span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
						<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%3d %8lu %10lu %8lu &quot;</span>
					<span class="s">&quot;%10lu %8lu %9lu %6d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
					<span class="p">(</span><span class="n">cur_jifs</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">in_use</span><span class="p">)</span> <span class="o">/</span>
					<span class="n">HZ</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_bytes</span><span class="p">,</span>
					<span class="p">(</span><span class="n">cur_jifs</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">xmit_idle</span><span class="p">)</span><span class="o">/</span>
					<span class="n">HZ</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_bytes</span><span class="p">,</span>
					<span class="p">(</span><span class="n">cur_jifs</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">recv_idle</span><span class="p">)</span><span class="o">/</span>
					<span class="n">HZ</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idle_stats</span><span class="p">.</span><span class="n">overruns</span><span class="p">,</span>
					<span class="n">num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%3d %8lu %10lu %8lu &quot;</span>
					<span class="s">&quot;%10lu %8lu %9lu %6ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cyclades_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cyclades_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cyclades_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">cyclades_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The serial driver boot-time initialization code!</span>
<span class="cm">    Hardware I/O ports are mapped to character special devices on a</span>
<span class="cm">    first found, first allocated manner.  That is, this code searches</span>
<span class="cm">    for Cyclom cards in the system.  As each is found, it is probed</span>
<span class="cm">    to discover how many chips (and thus how many ports) are present.</span>
<span class="cm">    These ports are mapped to the tty ports 32 and upward in monotonic</span>
<span class="cm">    fashion.  If an 8-port card is replaced with a 16-port card, the</span>
<span class="cm">    port mapping on a following card will shift.</span>

<span class="cm">    This approach is different from what is used in the other serial</span>
<span class="cm">    device driver because the Cyclom is more properly a multiplexer,</span>
<span class="cm">    not just an aggregation of serial ports on one card.</span>

<span class="cm">    If there are more cards with more ports than have been</span>
<span class="cm">    statically allocated above, a warning is printed and the</span>
<span class="cm">    extra ports are ignored.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">cy_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cy_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">cy_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">cy_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">cy_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">cy_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">cy_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">cy_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">cy_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">cy_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">cy_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">cy_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">cy_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">cy_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">cy_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">cy_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">cy_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">cy_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">cy_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">cy_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_icount</span> <span class="o">=</span> <span class="n">cy_get_icount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cyclades_proc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cy_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nboards</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cy_serial_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">NR_PORTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cy_serial_driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Cyclades driver &quot;</span> <span class="n">CY_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize the tty_driver structure */</span>

	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;cyclades&quot;</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyC&quot;</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">CYCLADES_MAJOR</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
	    <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">cy_serial_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cy_ops</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t register Cyclades serial driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_frtty</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the code below is responsible to find the boards. Each different</span>
<span class="cm">	   type of board has its own detection routine. If a board is found,</span>
<span class="cm">	   the next cy_card structure available is set by the detection</span>
<span class="cm">	   routine. These functions are responsible for checking the</span>
<span class="cm">	   availability of cy_card and cy_port data structures and updating</span>
<span class="cm">	   the cy_next_channel. */</span>

	<span class="cm">/* look for isa boards */</span>
	<span class="n">nboards</span> <span class="o">=</span> <span class="n">cy_detect_isa</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="cm">/* look for pci boards */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cy_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nboards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_frtty</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_frtty:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>				<span class="cm">/* cy_init */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cy_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cyclades_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">e1</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cyz_timerlist</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>

	<span class="n">e1</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;failed to unregister Cyclades serial &quot;</span>
				<span class="s">&quot;driver(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cy_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cy_card</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear interrupt */</span>
			<span class="n">cy_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">Cy_ClrIntr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">.</span><span class="n">p9050</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span>
<span class="cp">#ifndef CONFIG_CYZ_INTR</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cy_is_Z</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CYZ_INTR */</span><span class="cp"></span>
				<span class="p">)</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">e1</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span><span class="p">;</span> <span class="n">e1</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">first_line</span> <span class="o">+</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">e1</span><span class="o">++</span><span class="p">)</span>
				<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">,</span> <span class="n">e1</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">cy_serial_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* cy_cleanup_module */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cy_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cy_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">CY_VERSION</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_CHARDEV_MAJOR</span><span class="p">(</span><span class="n">CYCLADES_MAJOR</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;cyzfirm.bin&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
