<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › sysrq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sysrq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Linux Magic System Request Key Hacks</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) 1997 Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;</span>
<span class="cm"> *	based on ideas by Pavel Machek &lt;pavel@atrey.karlin.mff.cuni.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	(c) 2000 Crutcher Dunnavant &lt;crutcher+kernel@datastacks.com&gt;</span>
<span class="cm"> *	overhauled to use key registration</span>
<span class="cm"> *	based upon discusions in irc://irc.openprojects.net/#kernelnewbies</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2010 Dmitry Torokhov</span>
<span class="cm"> *	Input handler conversion</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/kbd_kern.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/perf_event.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &lt;linux/writeback.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/oom.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>

<span class="cm">/* Whether we react on sysrq keys or just ignore them */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__read_mostly</span> <span class="n">sysrq_enabled</span> <span class="o">=</span> <span class="n">SYSRQ_DEFAULT_ENABLE</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__read_mostly</span> <span class="n">sysrq_always_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sysrq_on</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysrq_enabled</span> <span class="o">||</span> <span class="n">sysrq_always_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A value of 1 means &#39;all&#39;, other nonzero values are an op mask:</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">sysrq_on_mask</span><span class="p">(</span><span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysrq_always_enabled</span> <span class="o">||</span>
	       <span class="n">sysrq_enabled</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">sysrq_enabled</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sysrq_always_enabled_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysrq_always_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sysrq always enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;sysrq_always_enabled&quot;</span><span class="p">,</span> <span class="n">sysrq_always_enabled_setup</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_loglevel</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">key</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Loglevel set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_loglevel_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_loglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;loglevel(0-9)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Changing Loglevel&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_LOG</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_VT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_SAK</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">SAK_work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">SAK_work</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="n">SAK_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_SAK_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_SAK</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;saK&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;SAK&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_KEYBOARD</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define sysrq_SAK_op (*(struct sysrq_key_op *)NULL)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_VT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_unraw</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vt_reset_unicode</span><span class="p">(</span><span class="n">fg_console</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_unraw_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_unraw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;unRaw&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Keyboard mode set to system default&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_KEYBOARD</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define sysrq_unraw_op (*(struct sysrq_key_op *)NULL)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_crash</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">killer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">panic_on_oops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* force panic */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="o">*</span><span class="n">killer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_crash_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_crash</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;Crash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Trigger a crash&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_reboot</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_off</span><span class="p">();</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="n">emergency_restart</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_reboot_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_reboot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;reBoot&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Resetting&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_BOOT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_sync</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emergency_sync</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_sync_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;Sync&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Emergency Sync&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_SYNC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_show_timers</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysrq_timer_list_show</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_show_timers_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_show_timers</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-all-timers(Q)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show clockevent devices &amp; pending hrtimers (no others)&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_mountro</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emergency_remount</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_mountro_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_mountro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;Unmount&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Emergency Remount R/O&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_REMOUNT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_LOCKDEP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showlocks</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug_show_all_locks</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showlocks_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showlocks</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-all-locks(D)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show Locks Held&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define sysrq_showlocks_op (*(struct sysrq_key_op *)NULL)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">show_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">showacpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Idle CPUs have no interesting backtrace. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idle_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">()))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">show_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">show_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_showregs_othercpus</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smp_call_function</span><span class="p">(</span><span class="n">showacpu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">sysrq_showallcpus</span><span class="p">,</span> <span class="n">sysrq_showregs_othercpus</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showallcpus</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Fall back to the workqueue based printing if the</span>
<span class="cm">	 * backtrace printing did not succeed or the</span>
<span class="cm">	 * architecture has no support for it:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trigger_all_cpu_backtrace</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">get_irq_regs</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CPU%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
			<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_showallcpus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showallcpus_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showallcpus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-backtrace-all-active-cpus(L)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show backtrace of all active CPUs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showregs</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">get_irq_regs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">perf_event_print_debug</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showregs_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showregs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-registers(P)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show Regs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showstate</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_state</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showstate_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showstate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-task-states(T)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show State&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showstate_blocked</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_state_filter</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showstate_blocked_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showstate_blocked</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-blocked-tasks(W)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show Blocked State&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_TRACING</span>
<span class="cp">#include &lt;linux/ftrace.h&gt;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_ftrace_dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ftrace_dump</span><span class="p">(</span><span class="n">DUMP_ALL</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_ftrace_dump_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_ftrace_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;dump-ftrace-buffer(Z)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Dump ftrace buffer&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#define sysrq_ftrace_dump_op (*(struct sysrq_key_op *)NULL)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_showmem</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_mem</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_showmem_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_showmem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;show-memory-usage(M)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Show Memory&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_DUMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Signal sysrq helper function.  Sends a signal to all user processes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_sig_all</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
	<span class="n">for_each_process</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_KTHREAD</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_global_init</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">do_send_sig_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">SEND_SIG_FORCED</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_term</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">send_sig_all</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">);</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_term_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_term</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;terminate-all-tasks(E)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Terminate All Tasks&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_SIGNAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">moom_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_of_memory</span><span class="p">(</span><span class="n">node_zonelist</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">moom_work</span><span class="p">,</span> <span class="n">moom_callback</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_moom</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moom_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_moom_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_moom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;memory-full-oom-kill(F)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Manual OOM execution&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_SIGNAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_BLOCK</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_thaw</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">emergency_thaw_all</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_thaw_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;thaw-filesystems(J)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Emergency Thaw of all frozen filesystems&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_SIGNAL</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_kill</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">send_sig_all</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">);</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_kill_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_kill</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;kill-all-tasks(I)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Kill All Tasks&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_SIGNAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_unrt</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">normalize_rt_tasks</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_unrt_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span>	<span class="o">=</span> <span class="n">sysrq_handle_unrt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span>	<span class="o">=</span> <span class="s">&quot;nice-all-RT-tasks(N)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span>	<span class="o">=</span> <span class="s">&quot;Nice All RT Tasks&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mask</span>	<span class="o">=</span> <span class="n">SYSRQ_ENABLE_RTNICE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Key Operations table and lock */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">sysrq_key_table_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">sysrq_key_table</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 0 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 1 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 2 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 3 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 4 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 5 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 6 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 7 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 8 */</span>
	<span class="o">&amp;</span><span class="n">sysrq_loglevel_op</span><span class="p">,</span>		<span class="cm">/* 9 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * a: Don&#39;t use for system provided sysrqs, it is handled specially on</span>
<span class="cm">	 * sparc and will never arrive.</span>
<span class="cm">	 */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* a */</span>
	<span class="o">&amp;</span><span class="n">sysrq_reboot_op</span><span class="p">,</span>		<span class="cm">/* b */</span>
	<span class="o">&amp;</span><span class="n">sysrq_crash_op</span><span class="p">,</span>		<span class="cm">/* c &amp; ibm_emac driver debug */</span>
	<span class="o">&amp;</span><span class="n">sysrq_showlocks_op</span><span class="p">,</span>		<span class="cm">/* d */</span>
	<span class="o">&amp;</span><span class="n">sysrq_term_op</span><span class="p">,</span>			<span class="cm">/* e */</span>
	<span class="o">&amp;</span><span class="n">sysrq_moom_op</span><span class="p">,</span>			<span class="cm">/* f */</span>
	<span class="cm">/* g: May be registered for the kernel debugger */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* g */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* h - reserved for help */</span>
	<span class="o">&amp;</span><span class="n">sysrq_kill_op</span><span class="p">,</span>			<span class="cm">/* i */</span>
<span class="cp">#ifdef CONFIG_BLOCK</span>
	<span class="o">&amp;</span><span class="n">sysrq_thaw_op</span><span class="p">,</span>			<span class="cm">/* j */</span>
<span class="cp">#else</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* j */</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">sysrq_SAK_op</span><span class="p">,</span>			<span class="cm">/* k */</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="o">&amp;</span><span class="n">sysrq_showallcpus_op</span><span class="p">,</span>		<span class="cm">/* l */</span>
<span class="cp">#else</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* l */</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">sysrq_showmem_op</span><span class="p">,</span>		<span class="cm">/* m */</span>
	<span class="o">&amp;</span><span class="n">sysrq_unrt_op</span><span class="p">,</span>			<span class="cm">/* n */</span>
	<span class="cm">/* o: This will often be registered as &#39;Off&#39; at init time */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* o */</span>
	<span class="o">&amp;</span><span class="n">sysrq_showregs_op</span><span class="p">,</span>		<span class="cm">/* p */</span>
	<span class="o">&amp;</span><span class="n">sysrq_show_timers_op</span><span class="p">,</span>		<span class="cm">/* q */</span>
	<span class="o">&amp;</span><span class="n">sysrq_unraw_op</span><span class="p">,</span>		<span class="cm">/* r */</span>
	<span class="o">&amp;</span><span class="n">sysrq_sync_op</span><span class="p">,</span>			<span class="cm">/* s */</span>
	<span class="o">&amp;</span><span class="n">sysrq_showstate_op</span><span class="p">,</span>		<span class="cm">/* t */</span>
	<span class="o">&amp;</span><span class="n">sysrq_mountro_op</span><span class="p">,</span>		<span class="cm">/* u */</span>
	<span class="cm">/* v: May be registered for frame buffer console restore */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* v */</span>
	<span class="o">&amp;</span><span class="n">sysrq_showstate_blocked_op</span><span class="p">,</span>	<span class="cm">/* w */</span>
	<span class="cm">/* x: May be registered on ppc/powerpc for xmon */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* x */</span>
	<span class="cm">/* y: May be registered on sparc64 for global register dump */</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* y */</span>
	<span class="o">&amp;</span><span class="n">sysrq_ftrace_dump_op</span><span class="p">,</span>		<span class="cm">/* z */</span>
<span class="p">};</span>

<span class="cm">/* key2index calculation, -1 on invalid index */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sysrq_key_table_key2index</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">key</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">&gt;=</span> <span class="sc">&#39;a&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get and put functions for the table, exposed to modules.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="nf">__sysrq_get_key_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">sysrq_key_table_key2index</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	        <span class="n">op_p</span> <span class="o">=</span> <span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="k">return</span> <span class="n">op_p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sysrq_put_key_op</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op_p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">sysrq_key_table_key2index</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_p</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__handle_sysrq</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="n">bool</span> <span class="n">check_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_log_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_key_table_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Raise the apparent loglevel to maximum so that the sysrq header</span>
<span class="cm">	 * is shown to provide the user with positive feedback.  We do not</span>
<span class="cm">	 * simply emit this at KERN_EMERG as that would change message</span>
<span class="cm">	 * routing in the consumers of /proc/kmsg.</span>
<span class="cm">	 */</span>
	<span class="n">orig_log_level</span> <span class="o">=</span> <span class="n">console_loglevel</span><span class="p">;</span>
	<span class="n">console_loglevel</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SysRq : &quot;</span><span class="p">);</span>

        <span class="n">op_p</span> <span class="o">=</span> <span class="n">__sysrq_get_key_op</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">op_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Should we check for enabled operations (/proc/sysrq-trigger</span>
<span class="cm">		 * should not) and is the invoked operation enabled?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_mask</span> <span class="o">||</span> <span class="n">sysrq_on_mask</span><span class="p">(</span><span class="n">op_p</span><span class="o">-&gt;</span><span class="n">enable_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">op_p</span><span class="o">-&gt;</span><span class="n">action_msg</span><span class="p">);</span>
			<span class="n">console_loglevel</span> <span class="o">=</span> <span class="n">orig_log_level</span><span class="p">;</span>
			<span class="n">op_p</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;This sysrq operation is disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;HELP : &quot;</span><span class="p">);</span>
		<span class="cm">/* Only print the help msg once per handler */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sysrq_key_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span>
						<span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">sysrq_key_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">help_msg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">console_loglevel</span> <span class="o">=</span> <span class="n">orig_log_level</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_key_table_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">handle_sysrq</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysrq_on</span><span class="p">())</span>
		<span class="n">__handle_sysrq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">handle_sysrq</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INPUT</span>

<span class="cm">/* Simple translation table for the SysRq keys */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sysrq_xlate</span><span class="p">[</span><span class="n">KEY_CNT</span><span class="p">]</span> <span class="o">=</span>
        <span class="s">&quot;</span><span class="se">\000\033</span><span class="s">1234567890-=</span><span class="se">\177\t</span><span class="s">&quot;</span>                    <span class="cm">/* 0x00 - 0x0f */</span>
        <span class="s">&quot;qwertyuiop[]</span><span class="se">\r\000</span><span class="s">as&quot;</span>                          <span class="cm">/* 0x10 - 0x1f */</span>
        <span class="s">&quot;dfghjkl;&#39;`</span><span class="se">\000\\</span><span class="s">zxcv&quot;</span>                          <span class="cm">/* 0x20 - 0x2f */</span>
        <span class="s">&quot;bnm,./</span><span class="se">\000</span><span class="s">*</span><span class="se">\000</span><span class="s"> </span><span class="se">\000\201\202\203\204\205</span><span class="s">&quot;</span>      <span class="cm">/* 0x30 - 0x3f */</span>
        <span class="s">&quot;</span><span class="se">\206\207\210\211\212\000\000</span><span class="s">789-456+1&quot;</span>         <span class="cm">/* 0x40 - 0x4f */</span>
        <span class="s">&quot;230</span><span class="se">\177\000\000\213\214\000\000\000\000\000\000\000\000\000\000</span><span class="s">&quot;</span> <span class="cm">/* 0x50 - 0x5f */</span>
        <span class="s">&quot;</span><span class="se">\r\000</span><span class="s">/&quot;</span><span class="p">;</span>                                      <span class="cm">/* 0x60 - 0x6f */</span>

<span class="k">struct</span> <span class="n">sysrq_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">reinject_work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key_down</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">KEY_CNT</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alt_use</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">need_reinject</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reinjecting</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_reinject_alt_sysrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysrq_state</span> <span class="o">*</span><span class="n">sysrq</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sysrq_state</span><span class="p">,</span> <span class="n">reinject_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alt_code</span> <span class="o">=</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt_use</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">need_reinject</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we do not want the assignment to be reordered */</span>
		<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinjecting</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="cm">/* Simulate press and release of Alt + SysRq */</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">alt_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">KEY_SYSRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_SYN</span><span class="p">,</span> <span class="n">SYN_REPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">KEY_SYSRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">alt_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_inject_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">EV_SYN</span><span class="p">,</span> <span class="n">SYN_REPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">mb</span><span class="p">();</span>
		<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinjecting</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">sysrq_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysrq_state</span> <span class="o">*</span><span class="n">sysrq</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">was_active</span> <span class="o">=</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">suppress</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not filter anything if we are in the process of re-injecting</span>
<span class="cm">	 * Alt+SysRq combination.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinjecting</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">EV_SYN</span>:
		<span class="n">suppress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EV_KEY</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">KEY_LEFTALT</span>:
		<span class="k">case</span> <span class="n">KEY_RIGHTALT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* One of ALTs is being released */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">==</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt_use</span><span class="p">)</span>
					<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">need_reinject</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">KEY_SYSRQ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt_use</span> <span class="o">=</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * If nothing else will be pressed we&#39;ll need</span>
<span class="cm">				 * to re-inject Alt-SysRq keysroke.</span>
<span class="cm">				 */</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">need_reinject</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Pretend that sysrq was never pressed at all. This</span>
<span class="cm">			 * is needed to properly handle KGDB which will try</span>
<span class="cm">			 * to release all keys after exiting debugger. If we</span>
<span class="cm">			 * do not clear key bit it KGDB will end up sending</span>
<span class="cm">			 * release events for Alt and SysRq, potentially</span>
<span class="cm">			 * triggering print screen function.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">KEY_SYSRQ</span><span class="p">,</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">need_reinject</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">__handle_sysrq</span><span class="p">(</span><span class="n">sysrq_xlate</span><span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">suppress</span> <span class="o">=</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we are not suppressing key presses keep track of</span>
<span class="cm">			 * keyboard state so we can release keys that have been</span>
<span class="cm">			 * pressed before entering SysRq mode.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">key_down</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">key_down</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">was_active</span><span class="p">)</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinject_work</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">key_down</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Pass on release events for keys that was pressed before</span>
<span class="cm">			 * entering SysRq mode.</span>
<span class="cm">			 */</span>
			<span class="n">suppress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">suppress</span> <span class="o">=</span> <span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">suppress</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sysrq_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysrq_state</span> <span class="o">*</span><span class="n">sysrq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">sysrq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sysrq_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sysrq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinject_work</span><span class="p">,</span> <span class="n">sysrq_reinject_alt_sysrq</span><span class="p">);</span>

	<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sysrq&quot;</span><span class="p">;</span>
	<span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">sysrq</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register input sysrq handler, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_open_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to open input device, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_unregister:</span>
	<span class="n">input_unregister_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
 <span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sysrq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sysrq_state</span> <span class="o">*</span><span class="n">sysrq</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">input_close_device</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq</span><span class="o">-&gt;</span><span class="n">reinject_work</span><span class="p">);</span>
	<span class="n">input_unregister_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sysrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We are matching on KEY_LEFTALT instead of KEY_SYSRQ because not all</span>
<span class="cm"> * keyboards have SysRq key predefined and so user may add it to keymap</span>
<span class="cm"> * later, but we expect all such keyboards to have left alt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_device_id</span> <span class="n">sysrq_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">INPUT_DEVICE_ID_MATCH_EVBIT</span> <span class="o">|</span>
				<span class="n">INPUT_DEVICE_ID_MATCH_KEYBIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">evbit</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">keybit</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">KEY_LEFTALT</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_handler</span> <span class="n">sysrq_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">filter</span>		<span class="o">=</span> <span class="n">sysrq_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">sysrq_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">sysrq_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sysrq&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sysrq_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">sysrq_handler_registered</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sysrq_register_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register input handler, error %d&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sysrq_handler_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sysrq_unregister_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysrq_handler_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_unregister_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_handler</span><span class="p">);</span>
		<span class="n">sysrq_handler_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sysrq_register_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sysrq_unregister_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_INPUT */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">sysrq_toggle_support</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">was_enabled</span> <span class="o">=</span> <span class="n">sysrq_on</span><span class="p">();</span>

	<span class="n">sysrq_enabled</span> <span class="o">=</span> <span class="n">enable_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_enabled</span> <span class="o">!=</span> <span class="n">sysrq_on</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysrq_on</span><span class="p">())</span>
			<span class="n">sysrq_register_handler</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">sysrq_unregister_handler</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__sysrq_swap_key_ops</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">insert_op_p</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">remove_op_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_key_table_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__sysrq_get_key_op</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">remove_op_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__sysrq_put_key_op</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">insert_op_p</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysrq_key_table_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">register_sysrq_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__sysrq_swap_key_ops</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">op_p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_sysrq_key</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">unregister_sysrq_key</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__sysrq_swap_key_ops</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">op_p</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_sysrq_key</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cm">/*</span>
<span class="cm"> * writing &#39;C&#39; to /proc/sysrq-trigger is like sysrq-C</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">write_sysrq_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">__handle_sysrq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_sysrq_trigger_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">write_sysrq_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_init_procfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;sysrq-trigger&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">proc_sysrq_trigger_operations</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register proc interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sysrq_init_procfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sysrq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysrq_init_procfs</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sysrq_on</span><span class="p">())</span>
		<span class="n">sysrq_register_handler</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sysrq_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
