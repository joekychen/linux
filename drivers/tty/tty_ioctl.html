<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › tty_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tty_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1991, 1992, 1993, 1994  Linus Torvalds</span>
<span class="cm"> *</span>
<span class="cm"> * Modified by Fred N. van Kempen, 01/29/93, to add line disciplines</span>
<span class="cm"> * which can be dynamically activated and de-activated by the line</span>
<span class="cm"> * discipline handling modules (like SLIP).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#undef TTY_DEBUG_WAIT_UNTIL_SENT</span>

<span class="cp">#undef	DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * Internal flag options for termios setting behavior</span>
<span class="cm"> */</span>
<span class="cp">#define TERMIOS_FLUSH	1</span>
<span class="cp">#define TERMIOS_WAIT	2</span>
<span class="cp">#define TERMIOS_TERMIO	4</span>
<span class="cp">#define TERMIOS_OLD	8</span>


<span class="cm">/**</span>
<span class="cm"> *	tty_chars_in_buffer	-	characters pending</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the number of bytes of data in the device private</span>
<span class="cm"> *	output queue. If no private method is supplied there is assumed</span>
<span class="cm"> *	to be no queue on the device.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">chars_in_buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_chars_in_buffer</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_write_room		-	write queue space</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Return the number of bytes that can be queued to this device</span>
<span class="cm"> *	at the present time. The result should be treated as a guarantee</span>
<span class="cm"> *	and the driver cannot offer a value it later shrinks by more than</span>
<span class="cm"> *	the number of bytes written. If no method is provided 2K is always</span>
<span class="cm"> *	returned and data may be lost as there will be no flow control.</span>
<span class="cm"> */</span>
 
<span class="kt">int</span> <span class="nf">tty_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_room</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_room</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">2048</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_write_room</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_driver_flush_buffer	-	discard internal buffer</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Discard the internal output buffer for this device. If no method</span>
<span class="cm"> *	is provided then either the buffer cannot be hardware flushed or</span>
<span class="cm"> *	there is no buffer driver side.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">tty_driver_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_driver_flush_buffer</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_throttle		-	flow control</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Indicate that a tty should stop transmitting data down the stack.</span>
<span class="cm"> *	Takes the termios mutex to protect against parallel throttle/unthrottle</span>
<span class="cm"> *	and also to ensure the driver can consistently reference its own</span>
<span class="cm"> *	termios data at this point when implementing software flow control.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="cm">/* check TTY_THROTTLED first so it indicates our state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_throttle</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_unthrottle		-	flow control</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *</span>
<span class="cm"> *	Indicate that a tty may continue transmitting data down the stack.</span>
<span class="cm"> *	Takes the termios mutex to protect against parallel throttle/unthrottle</span>
<span class="cm"> *	and also to ensure the driver can consistently reference its own</span>
<span class="cm"> *	termios data at this point when implementing software flow control.</span>
<span class="cm"> *</span>
<span class="cm"> *	Drivers should however remember that the stack can issue a throttle,</span>
<span class="cm"> *	then change flow control method, then unthrottle.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unthrottle</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_unthrottle</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_wait_until_sent	-	wait for I/O to finish</span>
<span class="cm"> *	@tty: tty we are waiting for</span>
<span class="cm"> *	@timeout: how long we will wait</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait for characters pending in a tty driver to hit the wire, or</span>
<span class="cm"> *	for a timeout to occur (eg due to flow control)</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef TTY_DEBUG_WAIT_UNTIL_SENT</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s wait until sent...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty_name</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">buf</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">write_wait</span><span class="p">,</span>
			<span class="o">!</span><span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">),</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">wait_until_sent</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_wait_until_sent</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *		Termios Helper Methods</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">unset_locked_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">locked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

<span class="cp">#define NOSET_MASK(x, y, z) (x = ((x) &amp; ~(z)) | ((y) &amp; (z)))</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning?!? termios_locked is NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NOSET_MASK</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">,</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>
	<span class="n">NOSET_MASK</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">,</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">);</span>
	<span class="n">NOSET_MASK</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">);</span>
	<span class="n">NOSET_MASK</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">,</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">);</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_line</span> <span class="o">=</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_line</span> <span class="o">?</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_line</span> <span class="o">:</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">locked</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span>
			<span class="n">old</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="cm">/* FIXME: What should we do for i/ospeed */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Routine which returns the baud rate of the tty</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the baud_table needs to be kept in sync with the</span>
<span class="cm"> * include/asm/termbits.h file.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">speed_t</span> <span class="n">baud_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">2400</span><span class="p">,</span> <span class="mi">4800</span><span class="p">,</span>
	<span class="mi">9600</span><span class="p">,</span> <span class="mi">19200</span><span class="p">,</span> <span class="mi">38400</span><span class="p">,</span> <span class="mi">57600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">230400</span><span class="p">,</span> <span class="mi">460800</span><span class="p">,</span>
<span class="cp">#ifdef __sparc__</span>
	<span class="mi">76800</span><span class="p">,</span> <span class="mi">153600</span><span class="p">,</span> <span class="mi">307200</span><span class="p">,</span> <span class="mi">614400</span><span class="p">,</span> <span class="mi">921600</span>
<span class="cp">#else</span>
	<span class="mi">500000</span><span class="p">,</span> <span class="mi">576000</span><span class="p">,</span> <span class="mi">921600</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">1152000</span><span class="p">,</span> <span class="mi">1500000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">,</span>
	<span class="mi">2500000</span><span class="p">,</span> <span class="mi">3000000</span><span class="p">,</span> <span class="mi">3500000</span><span class="p">,</span> <span class="mi">4000000</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifndef __sparc__</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">tcflag_t</span> <span class="n">baud_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">B0</span><span class="p">,</span> <span class="n">B50</span><span class="p">,</span> <span class="n">B75</span><span class="p">,</span> <span class="n">B110</span><span class="p">,</span> <span class="n">B134</span><span class="p">,</span> <span class="n">B150</span><span class="p">,</span> <span class="n">B200</span><span class="p">,</span> <span class="n">B300</span><span class="p">,</span> <span class="n">B600</span><span class="p">,</span>
	<span class="n">B1200</span><span class="p">,</span> <span class="n">B1800</span><span class="p">,</span> <span class="n">B2400</span><span class="p">,</span> <span class="n">B4800</span><span class="p">,</span> <span class="n">B9600</span><span class="p">,</span> <span class="n">B19200</span><span class="p">,</span> <span class="n">B38400</span><span class="p">,</span>
	<span class="n">B57600</span><span class="p">,</span> <span class="n">B115200</span><span class="p">,</span> <span class="n">B230400</span><span class="p">,</span> <span class="n">B460800</span><span class="p">,</span> <span class="n">B500000</span><span class="p">,</span> <span class="n">B576000</span><span class="p">,</span>
	<span class="n">B921600</span><span class="p">,</span> <span class="n">B1000000</span><span class="p">,</span> <span class="n">B1152000</span><span class="p">,</span> <span class="n">B1500000</span><span class="p">,</span> <span class="n">B2000000</span><span class="p">,</span> <span class="n">B2500000</span><span class="p">,</span>
	<span class="n">B3000000</span><span class="p">,</span> <span class="n">B3500000</span><span class="p">,</span> <span class="n">B4000000</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">tcflag_t</span> <span class="n">baud_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">B0</span><span class="p">,</span> <span class="n">B50</span><span class="p">,</span> <span class="n">B75</span><span class="p">,</span> <span class="n">B110</span><span class="p">,</span> <span class="n">B134</span><span class="p">,</span> <span class="n">B150</span><span class="p">,</span> <span class="n">B200</span><span class="p">,</span> <span class="n">B300</span><span class="p">,</span> <span class="n">B600</span><span class="p">,</span>
	<span class="n">B1200</span><span class="p">,</span> <span class="n">B1800</span><span class="p">,</span> <span class="n">B2400</span><span class="p">,</span> <span class="n">B4800</span><span class="p">,</span> <span class="n">B9600</span><span class="p">,</span> <span class="n">B19200</span><span class="p">,</span> <span class="n">B38400</span><span class="p">,</span>
	<span class="n">B57600</span><span class="p">,</span> <span class="n">B115200</span><span class="p">,</span> <span class="n">B230400</span><span class="p">,</span> <span class="n">B460800</span><span class="p">,</span> <span class="n">B76800</span><span class="p">,</span> <span class="n">B153600</span><span class="p">,</span>
	<span class="n">B307200</span><span class="p">,</span> <span class="n">B614400</span><span class="p">,</span> <span class="n">B921600</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">n_baud_table</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">baud_table</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_termios_baud_rate</span>
<span class="cm"> *	@termios: termios structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Convert termios baud rate data into a speed. This should be called</span>
<span class="cm"> *	with the termios lock held if this termios is a terminal termios</span>
<span class="cm"> *	structure. May change the termios data. Device drivers can call this</span>
<span class="cm"> *	function but should use -&gt;c_[io]speed directly as they are updated.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="n">speed_t</span> <span class="nf">tty_termios_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbaud</span><span class="p">;</span>

	<span class="n">cbaud</span> <span class="o">=</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">;</span>

<span class="cp">#ifdef BOTHER</span>
	<span class="cm">/* Magic token for arbitrary speed via c_ispeed/c_ospeed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">==</span> <span class="n">BOTHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cbaud</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cbaud</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">&gt;</span> <span class="n">n_baud_table</span><span class="p">)</span>
			<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cbaud</span> <span class="o">+=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">cbaud</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_termios_baud_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_termios_input_baud_rate</span>
<span class="cm"> *	@termios: termios structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Convert termios baud rate data into a speed. This should be called</span>
<span class="cm"> *	with the termios lock held if this termios is a terminal termios</span>
<span class="cm"> *	structure. May change the termios data. Device drivers can call this</span>
<span class="cm"> *	function but should use -&gt;c_[io]speed directly as they are updated.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="n">speed_t</span> <span class="nf">tty_termios_input_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef IBSHIFT</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbaud</span> <span class="o">=</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&gt;&gt;</span> <span class="n">IBSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">==</span> <span class="n">B0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">);</span>

	<span class="cm">/* Magic token for arbitrary speed via c_ispeed*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">==</span> <span class="n">BOTHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cbaud</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cbaud</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cbaud</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">&gt;</span> <span class="n">n_baud_table</span><span class="p">)</span>
			<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CBAUDEX</span> <span class="o">&lt;&lt;</span> <span class="n">IBSHIFT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cbaud</span> <span class="o">+=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">cbaud</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_termios_input_baud_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_termios_encode_baud_rate</span>
<span class="cm"> *	@termios: ktermios structure holding user requested state</span>
<span class="cm"> *	@ispeed: input speed</span>
<span class="cm"> *	@ospeed: output speed</span>
<span class="cm"> *</span>
<span class="cm"> *	Encode the speeds set into the passed termios structure. This is</span>
<span class="cm"> *	used as a library helper for drivers so that they can report back</span>
<span class="cm"> *	the actual speed selected when it differs from the speed requested</span>
<span class="cm"> *</span>
<span class="cm"> *	For maximal back compatibility with legacy SYS5/POSIX *nix behaviour</span>
<span class="cm"> *	we need to carefully set the bits when the user does not get the</span>
<span class="cm"> *	desired speed. We allow small margins and preserve as much of possible</span>
<span class="cm"> *	of the input intent to keep compatibility.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: Caller should hold termios lock. This is already held</span>
<span class="cm"> *	when calling this function from the driver termios handler.</span>
<span class="cm"> *</span>
<span class="cm"> *	The ifdefs deal with platforms whose owners have yet to update them</span>
<span class="cm"> *	and will all go away once this is done.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
				  <span class="n">speed_t</span> <span class="n">ibaud</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">obaud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ifound</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ofound</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iclose</span> <span class="o">=</span> <span class="n">ibaud</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="n">oclose</span> <span class="o">=</span> <span class="n">obaud</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ibinput</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obaud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>			<span class="cm">/* CD dropped 		  */</span>
		<span class="n">ibaud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Clear ibaud to be sure */</span>

	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="n">ibaud</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="n">obaud</span><span class="p">;</span>

<span class="cp">#ifdef BOTHER</span>
	<span class="cm">/* If the user asked for a precise weird speed give a precise weird</span>
<span class="cm">	   answer. If they asked for a Bfoo speed they many have problems</span>
<span class="cm">	   digesting non-exact replies so fuzz a bit */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">BOTHER</span><span class="p">)</span>
		<span class="n">oclose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&gt;&gt;</span> <span class="n">IBSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">==</span> <span class="n">BOTHER</span><span class="p">)</span>
		<span class="n">iclose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&gt;&gt;</span> <span class="n">IBSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">ibinput</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* An input speed was specified */</span>
<span class="cp">#endif</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Our goal is to find a close match to the standard baud rate</span>
<span class="cm">	 *	returned. Walk the baud rate table and if we get a very close</span>
<span class="cm">	 *	match then report back the speed as a POSIX Bxxxx value by</span>
<span class="cm">	 *	preference</span>
<span class="cm">	 */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obaud</span> <span class="o">-</span> <span class="n">oclose</span> <span class="o">&lt;=</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">obaud</span> <span class="o">+</span> <span class="n">oclose</span> <span class="o">&gt;=</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">baud_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ofound</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibaud</span> <span class="o">-</span> <span class="n">iclose</span> <span class="o">&lt;=</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ibaud</span> <span class="o">+</span> <span class="n">iclose</span> <span class="o">&gt;=</span> <span class="n">baud_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* For the case input == output don&#39;t set IBAUD bits</span>
<span class="cm">			   if the user didn&#39;t do so */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ofound</span> <span class="o">==</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ibinput</span><span class="p">)</span>
				<span class="n">ifound</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef IBSHIFT</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">ifound</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">baud_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">IBSHIFT</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_baud_table</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	If we found no match then use BOTHER if provided or warn</span>
<span class="cm">	 *	the user their platform maintainer needs to wake up if not.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef BOTHER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofound</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">BOTHER</span><span class="p">;</span>
	<span class="cm">/* Set exact input bits only if the input and output differ or the</span>
<span class="cm">	   user already did */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifound</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ibaud</span> <span class="o">!=</span> <span class="n">obaud</span> <span class="o">||</span> <span class="n">ibinput</span><span class="p">))</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BOTHER</span> <span class="o">&lt;&lt;</span> <span class="n">IBSHIFT</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifound</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ofound</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;tty: Unable to return correct &quot;</span>
			  <span class="s">&quot;speed data as your architecture needs updating.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_termios_encode_baud_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_encode_baud_rate		-	set baud rate of the tty</span>
<span class="cm"> *	@ibaud: input baud rate</span>
<span class="cm"> *	@obad: output baud rate</span>
<span class="cm"> *</span>
<span class="cm"> *	Update the current termios data for the tty with the new speed</span>
<span class="cm"> *	settings. The caller must hold the termios_mutex for the tty in</span>
<span class="cm"> *	question.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_encode_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">ibaud</span><span class="p">,</span> <span class="n">speed_t</span> <span class="n">obaud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="n">ibaud</span><span class="p">,</span> <span class="n">obaud</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_encode_baud_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_get_baud_rate	-	get tty bit rates</span>
<span class="cm"> *	@tty: tty to query</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the baud rate as an integer for this terminal. The</span>
<span class="cm"> *	termios lock must be held by the caller and the terminal bit</span>
<span class="cm"> *	flags may be updated.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none</span>
<span class="cm"> */</span>

<span class="n">speed_t</span> <span class="nf">tty_get_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">speed_t</span> <span class="n">baud</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">38400</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">warned</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Use of setserial/setrocket to &quot;</span>
					    <span class="s">&quot;set SPD_* flags is deprecated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">warned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">baud</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_get_baud_rate</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_termios_copy_hw	-	copy hardware settings</span>
<span class="cm"> *	@new: New termios</span>
<span class="cm"> *	@old: Old termios</span>
<span class="cm"> *</span>
<span class="cm"> *	Propagate the hardware specific terminal setting bits from</span>
<span class="cm"> *	the old termios structure to the new one. This is used in cases</span>
<span class="cm"> *	where the hardware does not support reconfiguration or as a helper</span>
<span class="cm"> *	in some cases where only minimal reconfiguration is supported</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">tty_termios_copy_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The bits a dumb device handles in software. Smart devices need</span>
<span class="cm">	   to always provide a set_termios method */</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_ispeed</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_termios_copy_hw</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_termios_hw_change	-	check for setting change</span>
<span class="cm"> *	@a: termios</span>
<span class="cm"> *	@b: termios to compare</span>
<span class="cm"> *</span>
<span class="cm"> *	Check if any of the bits that affect a dumb device have changed</span>
<span class="cm"> *	between the two termios structures, or a speed change is needed.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_termios_hw_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">^</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tty_termios_hw_change</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_set_termios		-	update termios values</span>
<span class="cm"> *	@tty: tty to update</span>
<span class="cm"> *	@new_termios: desired new value</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform updates to the termios values set on this terminal. There</span>
<span class="cm"> *	is a bit of layering violation here with n_tty in terms of the</span>
<span class="cm"> *	internal knowledge of this function.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: termios_mutex</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">new_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">old_termios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Perform the actual termios internal changes under lock.</span>
<span class="cm">	 */</span>


	<span class="cm">/* FIXME: we need to decide on some locking/ordering semantics</span>
<span class="cm">	   for the set_termios notification eventually */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">old_termios</span> <span class="o">=</span> <span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_termios</span><span class="p">;</span>
	<span class="n">unset_locked_termios</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_termios</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span><span class="p">);</span>

	<span class="cm">/* See if packet mode change of state. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">extproc</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_termios</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">EXTPROC</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">EXTPROC</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">old_flow</span> <span class="o">=</span> <span class="p">((</span><span class="n">old_termios</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IXON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">old_termios</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\023&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">old_termios</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\021&#39;</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">new_flow</span> <span class="o">=</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\023&#39;</span> <span class="o">&amp;&amp;</span>
				<span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\021&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">old_flow</span> <span class="o">!=</span> <span class="n">new_flow</span><span class="p">)</span> <span class="o">||</span> <span class="n">extproc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_flow</span> <span class="o">!=</span> <span class="n">new_flow</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TIOCPKT_DOSTOP</span> <span class="o">|</span> <span class="n">TIOCPKT_NOSTOP</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_flow</span><span class="p">)</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">|=</span> <span class="n">TIOCPKT_DOSTOP</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">|=</span> <span class="n">TIOCPKT_NOSTOP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extproc</span><span class="p">)</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">|=</span> <span class="n">TIOCPKT_IOCTL</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">read_wait</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">)(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_termios</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tty_termios_copy_hw</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_termios</span><span class="p">);</span>

	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">)</span>
			<span class="p">(</span><span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">)(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_termios</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_set_termios</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	set_termios		-	set termios values for a tty</span>
<span class="cm"> *	@tty: terminal device</span>
<span class="cm"> *	@arg: user data</span>
<span class="cm"> *	@opt: option information</span>
<span class="cm"> *</span>
<span class="cm"> *	Helper function to prepare termios data and run necessary other</span>
<span class="cm"> *	functions before using tty_set_termios to do the actual changes.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking:</span>
<span class="cm"> *		Called functions take ldisc and termios_mutex locks</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">tmp_termios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_TERMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_termio_to_kernel_termios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">termio</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="cp">#ifdef TCGETS2</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_OLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_termios_to_kernel_termios_1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_termios_to_kernel_termios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">,</span>
						<span class="p">(</span><span class="k">struct</span> <span class="n">termios2</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_termios_to_kernel_termios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* If old style Bfoo values are used then load c_ispeed/c_ospeed</span>
<span class="cm">	 * with the real speed so its unconditionally usable */</span>
	<span class="n">tmp_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="n">tty_termios_input_baud_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">);</span>
	<span class="n">tmp_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">);</span>

	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_FLUSH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_termios</span><span class="p">);</span>

	<span class="cm">/* FIXME: Arguably if tmp_termios == tty-&gt;termios AND the</span>
<span class="cm">	   actual requested termios was not tmp_termios then we may</span>
<span class="cm">	   want to return an error as no user requested change has</span>
<span class="cm">	   succeeded */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">copy_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">kterm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kterm</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">copy_termios_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">kterm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kterm</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_termio</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">termio</span> <span class="n">__user</span> <span class="o">*</span><span class="n">termio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">kterm</span><span class="p">;</span>
	<span class="n">copy_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termio</span><span class="p">(</span><span class="n">termio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef TCGETX</span>

<span class="cm">/**</span>
<span class="cm"> *	set_termiox	-	set termiox fields if possible</span>
<span class="cm"> *	@tty: terminal</span>
<span class="cm"> *	@arg: termiox structure from user</span>
<span class="cm"> *	@opt: option flags for ioctl type</span>
<span class="cm"> *</span>
<span class="cm"> *	Implement the device calling points for the SYS5 termiox ioctl</span>
<span class="cm"> *	interface in Linux</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">set_termiox</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">termiox</span> <span class="n">tnew</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termiox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnew</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">termiox</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ld</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_FLUSH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span> <span class="o">&amp;</span> <span class="n">TERMIOS_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termiox</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termiox</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tnew</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="cp">#ifdef TIOCGETP</span>
<span class="cm">/*</span>
<span class="cm"> * These are deprecated, but there is limited support..</span>
<span class="cm"> *</span>
<span class="cm"> * The &quot;sg_flags&quot; translation is a joke..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_sgflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ICANON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ISIG</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>		<span class="cm">/* cbreak */</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>		<span class="cm">/* raw */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ECHO</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>			<span class="cm">/* echo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span> <span class="o">&amp;</span> <span class="n">OPOST</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span> <span class="o">&amp;</span> <span class="n">ONLCR</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>		<span class="cm">/* crmod */</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_sgttyb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sgttyb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">sg_ispeed</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">sg_ospeed</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">sg_erase</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VERASE</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">sg_kill</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VKILL</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">sg_flags</span> <span class="o">=</span> <span class="n">get_sgflags</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">sgttyb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">set_sgflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">=</span> <span class="n">ISIG</span> <span class="o">|</span> <span class="n">ICANON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cbreak */</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICANON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* echo */</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">|=</span> <span class="n">ECHO</span> <span class="o">|</span> <span class="n">ECHOE</span> <span class="o">|</span> <span class="n">ECHOK</span> <span class="o">|</span>
				    <span class="n">ECHOCTL</span> <span class="o">|</span> <span class="n">ECHOKE</span> <span class="o">|</span> <span class="n">IEXTEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* crmod */</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_oflag</span> <span class="o">|=</span> <span class="n">OPOST</span> <span class="o">|</span> <span class="n">ONLCR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* raw */</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISIG</span> <span class="o">|</span> <span class="n">ICANON</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ICANON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	set_sgttyb		-	set legacy terminal values</span>
<span class="cm"> *	@tty: tty structure</span>
<span class="cm"> *	@sgttyb: pointer to old style terminal structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Updates a terminal from the legacy BSD style terminal information</span>
<span class="cm"> *	structure.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: termios_mutex</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">set_sgttyb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sgttyb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">termios</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sgttyb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">termios</span> <span class="o">=</span> <span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="n">termios</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VERASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sg_erase</span><span class="p">;</span>
	<span class="n">termios</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VKILL</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sg_kill</span><span class="p">;</span>
	<span class="n">set_sgflags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">termios</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">sg_flags</span><span class="p">);</span>
	<span class="cm">/* Try and encode into Bfoo format */</span>
<span class="cp">#ifdef BOTHER</span>
	<span class="n">tty_termios_encode_baud_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">termios</span><span class="p">,</span> <span class="n">termios</span><span class="p">.</span><span class="n">c_ispeed</span><span class="p">,</span>
						<span class="n">termios</span><span class="p">.</span><span class="n">c_ospeed</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tty_set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">termios</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef TIOCGETC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_tchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tchars</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tchars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tchars</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_intrc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VINTR</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_quitc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VQUIT</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_startc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_stopc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_eofc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOF</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_brkc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOL2</span><span class="p">];</span>	<span class="cm">/* what is brkc anyway? */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">tchars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">set_tchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tchars</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tchars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tchars</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tchars</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VINTR</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_intrc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VQUIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_quitc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTART</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_startc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSTOP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_stopc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOF</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_eofc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOL2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_brkc</span><span class="p">;</span>	<span class="cm">/* what is brkc anyway? */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef TIOCGLTC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_ltchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ltchars</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ltchars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ltchars</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_suspc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSUSP</span><span class="p">];</span>
	<span class="cm">/* what is dsuspc anyway? */</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_dsuspc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSUSP</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_rprntc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VREPRINT</span><span class="p">];</span>
	<span class="cm">/* what is flushc anyway? */</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_flushc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOL2</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_werasc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VWERASE</span><span class="p">];</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">t_lnextc</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VLNEXT</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ltchars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">set_ltchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ltchars</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ltchars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ltchars</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ltchars</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VSUSP</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_suspc</span><span class="p">;</span>
	<span class="cm">/* what is dsuspc anyway? */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOL2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_dsuspc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VREPRINT</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_rprntc</span><span class="p">;</span>
	<span class="cm">/* what is flushc anyway? */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VEOL2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_flushc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VWERASE</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_werasc</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VLNEXT</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">t_lnextc</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *	send_prio_char		-	send priority character</span>
<span class="cm"> *</span>
<span class="cm"> *	Send a high priority character to the tty even if stopped</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking: none for xchar method, write ordering for write method.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">send_prio_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">was_stopped</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_xchar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_write_lock</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_stopped</span><span class="p">)</span>
		<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">was_stopped</span><span class="p">)</span>
		<span class="n">stop_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_write_unlock</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_change_softcar	-	carrier change ioctl helper</span>
<span class="cm"> *	@tty: tty to update</span>
<span class="cm"> *	@arg: enable/disable CLOCAL</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform a change to the CLOCAL state and call into the driver</span>
<span class="cm"> *	layer to make it visible. All done with the termios mutex</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tty_change_softcar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">?</span> <span class="n">CLOCAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="o">*</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_termios</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bit</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	tty_mode_ioctl		-	mode related ioctls</span>
<span class="cm"> *	@tty: tty for the ioctl</span>
<span class="cm"> *	@file: file pointer for the tty</span>
<span class="cm"> *	@cmd: command</span>
<span class="cm"> *	@arg: ioctl argument</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform non line discipline specific mode control ioctls. This</span>
<span class="cm"> *	is designed to be called by line disciplines to ensure they provide</span>
<span class="cm"> *	consistent mode setting.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">tty_mode_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">real_tty</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="n">kterm</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TTY_DRIVER_TYPE_PTY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span>
		<span class="n">real_tty</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">real_tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef TIOCGETP</span>
	<span class="k">case</span> <span class="n">TIOCGETP</span>:
		<span class="k">return</span> <span class="n">get_sgttyb</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSETP</span>:
	<span class="k">case</span> <span class="n">TIOCSETN</span>:
		<span class="k">return</span> <span class="n">set_sgttyb</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgttyb</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef TIOCGETC</span>
	<span class="k">case</span> <span class="n">TIOCGETC</span>:
		<span class="k">return</span> <span class="n">get_tchars</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSETC</span>:
		<span class="k">return</span> <span class="n">set_tchars</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef TIOCGLTC</span>
	<span class="k">case</span> <span class="n">TIOCGLTC</span>:
		<span class="k">return</span> <span class="n">get_ltchars</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCSLTC</span>:
		<span class="k">return</span> <span class="n">set_ltchars</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">TCSETSF</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>  <span class="n">TERMIOS_FLUSH</span> <span class="o">|</span> <span class="n">TERMIOS_WAIT</span> <span class="o">|</span> <span class="n">TERMIOS_OLD</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETSW</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_WAIT</span> <span class="o">|</span> <span class="n">TERMIOS_OLD</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETS</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_OLD</span><span class="p">);</span>
<span class="cp">#ifndef TCGETS2</span>
	<span class="k">case</span> <span class="n">TCGETS</span>:
		<span class="n">copy_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termios</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">TCGETS</span>:
		<span class="n">copy_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termios_1</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCGETS2</span>:
		<span class="n">copy_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termios</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios2</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCSETSF2</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>  <span class="n">TERMIOS_FLUSH</span> <span class="o">|</span> <span class="n">TERMIOS_WAIT</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETSW2</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_WAIT</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETS2</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">TCGETA</span>:
		<span class="k">return</span> <span class="n">get_termio</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETAF</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_FLUSH</span> <span class="o">|</span> <span class="n">TERMIOS_WAIT</span> <span class="o">|</span> <span class="n">TERMIOS_TERMIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETAW</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_WAIT</span> <span class="o">|</span> <span class="n">TERMIOS_TERMIO</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETA</span>:
		<span class="k">return</span> <span class="n">set_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_TERMIO</span><span class="p">);</span>
<span class="cp">#ifndef TCGETS2</span>
	<span class="k">case</span> <span class="n">TIOCGLCKTRMIOS</span>:
		<span class="n">copy_termios_locked</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termios</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSLCKTRMIOS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">copy_termios_locked</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_termios_to_kernel_termios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kterm</span><span class="p">,</span>
					       <span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">TIOCGLCKTRMIOS</span>:
		<span class="n">copy_termios_locked</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kernel_termios_to_user_termios_1</span><span class="p">((</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSLCKTRMIOS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">copy_termios_locked</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_termios_to_kernel_termios_1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kterm</span><span class="p">,</span>
					       <span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_locked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ktermios</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef TCGETX</span>
	<span class="k">case</span> <span class="n">TCGETX</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">termiox</span> <span class="n">ktermx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termiox</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktermx</span><span class="p">,</span> <span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termiox</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">termiox</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">real_tty</span><span class="o">-&gt;</span><span class="n">termios_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ktermx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">termiox</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">TCSETX</span>:
		<span class="k">return</span> <span class="n">set_termiox</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETXW</span>:
		<span class="k">return</span> <span class="n">set_termiox</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_WAIT</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TCSETXF</span>:
		<span class="k">return</span> <span class="n">set_termiox</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TERMIOS_FLUSH</span><span class="p">);</span>
<span class="cp">#endif		</span>
	<span class="k">case</span> <span class="n">TIOCGSOFTCAR</span>:
		<span class="n">copy_termios</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kterm</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">((</span><span class="n">kterm</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSSOFTCAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">tty_change_softcar</span><span class="p">(</span><span class="n">real_tty</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_mode_ioctl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tty_perform_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_ldisc</span> <span class="o">*</span><span class="n">ld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">ld</span> <span class="o">=</span> <span class="n">tty_ldisc_ref_wait</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCIFLUSH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span> <span class="o">&amp;&amp;</span> <span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCIOFLUSH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ld</span> <span class="o">&amp;&amp;</span> <span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">)</span>
			<span class="n">ld</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">TCOFLUSH</span>:
		<span class="n">tty_driver_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty_ldisc_deref</span><span class="p">(</span><span class="n">ld</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">tty_perform_flush</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">n_tty_ioctl_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCXONC</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCOOFF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flow_stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">flow_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">stop_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCOON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flow_stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">flow_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">start_tty</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCIOFF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">!=</span> <span class="n">__DISABLED_CHAR</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">send_prio_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">!=</span> <span class="n">__DISABLED_CHAR</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">send_prio_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCFLSH</span>:
		<span class="k">return</span> <span class="n">tty_perform_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">TIOCPKT</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pktmode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TTY_DRIVER_TYPE_PTY</span> <span class="o">||</span>
		    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">!=</span> <span class="n">PTY_TYPE_MASTER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">pktmode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pktmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ctrl_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="cm">/* Try the mode commands */</span>
		<span class="k">return</span> <span class="n">tty_mode_ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">n_tty_ioctl_helper</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="kt">long</span> <span class="nf">n_tty_compat_ioctl_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIOCGLCKTRMIOS</span>:
	<span class="k">case</span> <span class="n">TIOCSLCKTRMIOS</span>:
		<span class="k">return</span> <span class="n">tty_mode_ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">n_tty_compat_ioctl_helper</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
