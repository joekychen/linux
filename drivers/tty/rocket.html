<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › tty › rocket.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>rocket.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * RocketPort device driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Theodore Ts&#39;o, 1995, 1996, 1997, 1998, 1999, 2000.</span>
<span class="cm"> * </span>
<span class="cm"> * Copyright (C) 1995, 1996, 1997, 1998, 1999, 2000, 2003 by Comtrol, Inc.</span>
<span class="cm"> * </span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> * </span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> * </span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Kernel Synchronization:</span>
<span class="cm"> *</span>
<span class="cm"> * This driver has 2 kernel control paths - exception handlers (calls into the driver</span>
<span class="cm"> * from user mode) and the timer bottom half (tasklet).  This is a polled driver, interrupts</span>
<span class="cm"> * are not used.</span>
<span class="cm"> *</span>
<span class="cm"> * Critical data: </span>
<span class="cm"> * -  rp_table[], accessed through passed &quot;info&quot; pointers, is a global (static) array of </span>
<span class="cm"> *    serial port state information and the xmit_buf circular buffer.  Protected by </span>
<span class="cm"> *    a per port spinlock.</span>
<span class="cm"> * -  xmit_flags[], an array of ints indexed by line (port) number, indicating that there</span>
<span class="cm"> *    is data to be transmitted.  Protected by atomic bit operations.</span>
<span class="cm"> * -  rp_num_ports, int indicating number of open ports, protected by atomic operations.</span>
<span class="cm"> * </span>
<span class="cm"> * rp_write() and rp_write_char() functions use a per port semaphore to protect against</span>
<span class="cm"> * simultaneous access to the same port by more than one process.</span>
<span class="cm"> */</span>

<span class="cm">/****** Defines ******/</span>
<span class="cp">#define ROCKET_PARANOIA_CHECK</span>
<span class="cp">#define ROCKET_DISABLE_SIMUSAGE</span>

<span class="cp">#undef ROCKET_SOFT_FLOW</span>
<span class="cp">#undef ROCKET_DEBUG_OPEN</span>
<span class="cp">#undef ROCKET_DEBUG_INTR</span>
<span class="cp">#undef ROCKET_DEBUG_WRITE</span>
<span class="cp">#undef ROCKET_DEBUG_FLOW</span>
<span class="cp">#undef ROCKET_DEBUG_THROTTLE</span>
<span class="cp">#undef ROCKET_DEBUG_WAIT_UNTIL_SENT</span>
<span class="cp">#undef ROCKET_DEBUG_RECEIVE</span>
<span class="cp">#undef ROCKET_DEBUG_HANGUP</span>
<span class="cp">#undef REV_PCI_ORDER</span>
<span class="cp">#undef ROCKET_DEBUG_IO</span>

<span class="cp">#define POLL_PERIOD HZ/100	</span><span class="cm">/*  Polling period .01 seconds (10ms) */</span><span class="cp"></span>

<span class="cm">/****** Kernel includes ******/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_driver.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cm">/****** RocketPort includes ******/</span>

<span class="cp">#include &quot;rocket_int.h&quot;</span>
<span class="cp">#include &quot;rocket.h&quot;</span>

<span class="cp">#define ROCKET_VERSION &quot;2.09&quot;</span>
<span class="cp">#define ROCKET_DATE &quot;12-June-2003&quot;</span>

<span class="cm">/****** RocketPort Local Variables ******/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rp_do_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">rocket_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rocket_version</span> <span class="n">driver_version</span> <span class="o">=</span> <span class="p">{</span>	
	<span class="n">ROCKET_VERSION</span><span class="p">,</span> <span class="n">ROCKET_DATE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">rp_table</span><span class="p">[</span><span class="n">MAX_RP_PORTS</span><span class="p">];</span>	       <span class="cm">/*  The main repository of serial port state information. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xmit_flags</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>	       <span class="cm">/*  Bit significant, indicates port had data to transmit. */</span>
						       <span class="cm">/*  eg.  Bit 0 indicates port 0 has xmit data, ...        */</span>
<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">rp_num_ports_open</span><span class="p">;</span>	               <span class="cm">/*  Number of serial ports open                           */</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">rocket_timer</span><span class="p">,</span> <span class="n">rp_do_poll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board1</span><span class="p">;</span>	                       <span class="cm">/* ISA addresses, retrieved from rocketport.conf          */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board3</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board4</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">controller</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">support_low_speed</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">modem1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">modem2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">modem3</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">modem4</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc104_1</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc104_2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc104_3</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc104_4</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pc104</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">pc104_1</span><span class="p">,</span> <span class="n">pc104_2</span><span class="p">,</span> <span class="n">pc104_3</span><span class="p">,</span> <span class="n">pc104_4</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rp_baud_base</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>	               <span class="cm">/*  Board config info (Someday make a per-board structure)  */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">is_PCI</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">rocketModel_t</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">NUM_BOARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_board</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">rocket_port_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The following arrays define the interrupt bits corresponding to each AIOP.</span>
<span class="cm"> * These bits are different between the ISA and regular PCI boards and the</span>
<span class="cm"> * Universal PCI boards.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">Word_t</span> <span class="n">aiop_intr_bits</span><span class="p">[</span><span class="n">AIOP_CTL_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AIOP_INTR_BIT_0</span><span class="p">,</span>
	<span class="n">AIOP_INTR_BIT_1</span><span class="p">,</span>
	<span class="n">AIOP_INTR_BIT_2</span><span class="p">,</span>
	<span class="n">AIOP_INTR_BIT_3</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">Word_t</span> <span class="n">upci_aiop_intr_bits</span><span class="p">[</span><span class="n">AIOP_CTL_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">UPCI_AIOP_INTR_BIT_0</span><span class="p">,</span>
	<span class="n">UPCI_AIOP_INTR_BIT_1</span><span class="p">,</span>
	<span class="n">UPCI_AIOP_INTR_BIT_2</span><span class="p">,</span>
	<span class="n">UPCI_AIOP_INTR_BIT_3</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">RData</span><span class="p">[</span><span class="n">RDATASIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
	<span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span>
	<span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">RRegData</span><span class="p">[</span><span class="n">RREGDATASIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span>	<span class="cm">/* 00: Stop Rx processor */</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span>	<span class="cm">/* 04: Tx software flow control */</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>	<span class="cm">/* 08: XON char */</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>	<span class="cm">/* 0c: XANY */</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* 10: Rx mask char */</span>
	<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 14: Compare/Ignore #0 */</span>
	<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span>	<span class="cm">/* 18: Compare #1 */</span>
	<span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span>	<span class="cm">/* 1c: Compare #2 */</span>
	<span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>	<span class="cm">/* 20: Interrupt #1 */</span>
	<span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span>	<span class="cm">/* 24: Ignore/Replace #1 */</span>
	<span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>	<span class="cm">/* 28: Interrupt #2 */</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span>	<span class="cm">/* 2c: Ignore/Replace #2 */</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0a</span>	<span class="cm">/* 30: Rx FIFO Enable */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">CONTROLLER_T</span> <span class="n">sController</span><span class="p">[</span><span class="n">CTL_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">sBitMapClrTbl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x7f</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">sBitMapSetTbl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  Line number is the ttySIx number (x), the Minor number.  We </span>
<span class="cm"> *  assign them sequentially, starting at zero.  The following </span>
<span class="cm"> *  array keeps track of the line number assigned to a given board/aiop/channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lineNumbers</span><span class="p">[</span><span class="n">MAX_RP_PORTS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextLineNumber</span><span class="p">;</span>

<span class="cm">/*****  RocketPort Static Prototypes   *********/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">init_ISA</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rp_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rp_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rmSpeakerReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">model</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">GetLineNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SetLineNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sInitChan</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopNum</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">ChanNum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sFlushRxFIFO</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sFlushTxFIFO</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sEnInterrupts</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Word_t</span> <span class="n">Flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sDisInterrupts</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Word_t</span> <span class="n">Flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sModemReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sPCIModemReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sWriteTxPrioByte</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sPCIInitController</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">CtlNum</span><span class="p">,</span>
			      <span class="n">ByteIO_t</span> <span class="o">*</span> <span class="n">AiopIOList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopIOListSize</span><span class="p">,</span>
			      <span class="n">WordIO_t</span> <span class="n">ConfigIO</span><span class="p">,</span> <span class="kt">int</span> <span class="n">IRQNum</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Frequency</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">PeriodicOnly</span><span class="p">,</span> <span class="kt">int</span> <span class="n">altChanRingIndicator</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">UPCIRingInd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sInitController</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">CtlNum</span><span class="p">,</span> <span class="n">ByteIO_t</span> <span class="n">MudbacIO</span><span class="p">,</span>
			   <span class="n">ByteIO_t</span> <span class="o">*</span> <span class="n">AiopIOList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopIOListSize</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">IRQNum</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Frequency</span><span class="p">,</span> <span class="kt">int</span> <span class="n">PeriodicOnly</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sReadAiopID</span><span class="p">(</span><span class="n">ByteIO_t</span> <span class="n">io</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sReadAiopNumChan</span><span class="p">(</span><span class="n">WordIO_t</span> <span class="n">io</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Theodore Ts&#39;o&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Comtrol RocketPort driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">board1</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">board1</span><span class="p">,</span> <span class="s">&quot;I/O port for (ISA) board #1&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">board2</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">board2</span><span class="p">,</span> <span class="s">&quot;I/O port for (ISA) board #2&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">board3</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">board3</span><span class="p">,</span> <span class="s">&quot;I/O port for (ISA) board #3&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">board4</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">board4</span><span class="p">,</span> <span class="s">&quot;I/O port for (ISA) board #4&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="s">&quot;I/O port for (ISA) rocketport controller&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">support_low_speed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">support_low_speed</span><span class="p">,</span> <span class="s">&quot;1 means support 50 baud, 0 means support 460400 baud&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">modem1</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">modem1</span><span class="p">,</span> <span class="s">&quot;1 means (ISA) board #1 is a RocketModem&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">modem2</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">modem2</span><span class="p">,</span> <span class="s">&quot;1 means (ISA) board #2 is a RocketModem&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">modem3</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">modem3</span><span class="p">,</span> <span class="s">&quot;1 means (ISA) board #3 is a RocketModem&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">modem4</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">modem4</span><span class="p">,</span> <span class="s">&quot;1 means (ISA) board #4 is a RocketModem&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pc104_1</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pc104_1</span><span class="p">,</span> <span class="s">&quot;set interface types for ISA(PC104) board #1 (e.g. pc104_1=232,232,485,485,...&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pc104_2</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pc104_2</span><span class="p">,</span> <span class="s">&quot;set interface types for ISA(PC104) board #2 (e.g. pc104_2=232,232,485,485,...&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pc104_3</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pc104_3</span><span class="p">,</span> <span class="s">&quot;set interface types for ISA(PC104) board #3 (e.g. pc104_3=232,232,485,485,...&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">pc104_4</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pc104_4</span><span class="p">,</span> <span class="s">&quot;set interface types for ISA(PC104) board #4 (e.g. pc104_4=232,232,485,485,...&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rp_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rp_cleanup_module</span><span class="p">);</span>


<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="cm">/*************************************************************************/</span>
<span class="cm">/*                     Module code starts here                           */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rocket_paranoia_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef ROCKET_PARANOIA_CHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">RPORT_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: bad magic number for rocketport &quot;</span>
				<span class="s">&quot;struct in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*  Serial port receive data function.  Called (from timer poll) when an AIOPIC signals </span>
<span class="cm"> *  that receive data is present on a serial port.  Pulls data from FIFO, moves it into the </span>
<span class="cm"> *  tty layer.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_do_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			  <span class="n">CHANNEL_t</span> <span class="o">*</span> <span class="n">cp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ChanStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CharNStat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ToRecv</span><span class="p">,</span> <span class="n">wRecv</span><span class="p">,</span> <span class="n">space</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cbuf</span><span class="p">;</span>

	<span class="n">ToRecv</span> <span class="o">=</span> <span class="n">sGetRxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_do_receive(%d)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ToRecv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ToRecv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if status indicates there are errored characters in the</span>
<span class="cm">	 * FIFO, then enter status mode (a word in FIFO holds</span>
<span class="cm">	 * character and status).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXFOVERFL</span> <span class="o">|</span> <span class="n">RXBREAK</span> <span class="o">|</span> <span class="n">RXFRAME</span> <span class="o">|</span> <span class="n">RXPARITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">STATMODE</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_RECEIVE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Entering STATMODE...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">ChanStatus</span> <span class="o">|=</span> <span class="n">STATMODE</span><span class="p">;</span>
			<span class="n">sEnRxStatusMode</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm">	 * if we previously entered status mode, then read down the</span>
<span class="cm">	 * FIFO one word at a time, pulling apart the character and</span>
<span class="cm">	 * the status.  Update error counters depending on status</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">STATMODE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_RECEIVE</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Ignore %x, read %x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ToRecv</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">flag</span><span class="p">;</span>

			<span class="n">CharNStat</span> <span class="o">=</span> <span class="n">sInW</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
<span class="cp">#ifdef ROCKET_DEBUG_RECEIVE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CharNStat</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">STMBREAKH</span><span class="p">)</span>
				<span class="n">CharNStat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">STMFRAMEH</span> <span class="o">|</span> <span class="n">STMPARITYH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ToRecv</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">CharNStat</span> <span class="o">&amp;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">STMBREAKH</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">STMPARITYH</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">STMFRAMEH</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="n">STMRCVROVRH</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_OVERRUN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">CharNStat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">ToRecv</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * after we&#39;ve emptied the FIFO in status mode, turn</span>
<span class="cm">		 * status mode back off</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sGetRxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_RECEIVE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Status mode off.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">sDisRxStatusMode</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we aren&#39;t in status mode, so read down the FIFO two</span>
<span class="cm">		 * characters at time by doing repeated word IO</span>
<span class="cm">		 * transfer.</span>
<span class="cm">		 */</span>
		<span class="n">space</span> <span class="o">=</span> <span class="n">tty_prepare_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">ToRecv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="n">ToRecv</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_RECEIVE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_do_receive:insufficient space ToRecv=%d space=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ToRecv</span><span class="p">,</span> <span class="n">space</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">ToRecv</span> <span class="o">=</span> <span class="n">space</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wRecv</span> <span class="o">=</span> <span class="n">ToRecv</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wRecv</span><span class="p">)</span>
			<span class="n">sInStrW</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">cbuf</span><span class="p">,</span> <span class="n">wRecv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ToRecv</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">cbuf</span><span class="p">[</span><span class="n">ToRecv</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/*  Push the data up to the tty layer */</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Serial port transmit data function.  Called from the timer polling loop as a </span>
<span class="cm"> *  result of a bit set in xmit_flags[], indicating data (from the tty layer) is ready</span>
<span class="cm"> *  to be sent out the serial port.  Data is buffered in rp_table[line].xmit_buf, it is </span>
<span class="cm"> *  moved to the port&#39;s xmit FIFO.  *info is critical data, protected by spinlocks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_do_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;rp: WARNING %s called with tty==NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">=</span> <span class="n">TXFIFO_SIZE</span> <span class="o">-</span> <span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

	<span class="cm">/*  Loop sending data to FIFO until done or FIFO full */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sOutStrW</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">),</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sOutB</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">&amp;=</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tx %d chars...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="cp">#ifdef ROCKETPORT_HAVE_POLL_WAIT</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;(%d,%d,%d,%d)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Called when a serial port signals it has read data in it&#39;s RX FIFO.</span>
<span class="cm"> *  It checks what interrupts are pending and services them, including</span>
<span class="cm"> *  receiving serial data.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_handle_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IntMask</span><span class="p">,</span> <span class="n">ChanStatus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;rp: WARNING: rp_handle_port called with &quot;</span>
				<span class="s">&quot;info-&gt;flags &amp; NOT_INIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;rp: WARNING: rp_handle_port called with &quot;</span>
				<span class="s">&quot;tty==NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">IntMask</span> <span class="o">=</span> <span class="n">sGetChanIntID</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_interrupt %02x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IntMask</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ChanStatus</span> <span class="o">=</span> <span class="n">sGetChanStatus</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IntMask</span> <span class="o">&amp;</span> <span class="n">RXF_TRIG</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Rx FIFO trigger level */</span>
		<span class="n">rp_do_receive</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">ChanStatus</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IntMask</span> <span class="o">&amp;</span> <span class="n">DELTA_CD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* CD change  */</span>
<span class="cp">#if (defined(ROCKET_DEBUG_OPEN) || defined(ROCKET_DEBUG_INTR) || defined(ROCKET_DEBUG_HANGUP))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ttyR%d CD now %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_HANGUP</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CD drop, calling hangup.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef ROCKET_DEBUG_INTR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IntMask</span> <span class="o">&amp;</span> <span class="n">DELTA_CTS</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* CTS change */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;CTS change...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IntMask</span> <span class="o">&amp;</span> <span class="n">DELTA_DSR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* DSR change */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DSR change...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  The top level polling routine.  Repeats every 1/100 HZ (10ms).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_do_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONTROLLER_t</span> <span class="o">*</span><span class="n">ctlp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xmitmask</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CtlMask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">AiopMask</span><span class="p">;</span>
	<span class="n">Word_t</span> <span class="n">bit</span><span class="p">;</span>

	<span class="cm">/*  Walk through all the boards (ctrl&#39;s) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctrl</span> <span class="o">&lt;</span> <span class="n">max_board</span><span class="p">;</span> <span class="n">ctrl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">ctrl</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*  Get a ptr to the board&#39;s control struct */</span>
		<span class="n">ctlp</span> <span class="o">=</span> <span class="n">sCtlNumToCtlPtr</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/*  Get the interrupt status from the board */</span>
<span class="cp">#ifdef CONFIG_PCI</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">BusType</span> <span class="o">==</span> <span class="n">isPCI</span><span class="p">)</span>
			<span class="n">CtlMask</span> <span class="o">=</span> <span class="n">sPCIGetControllerIntStatus</span><span class="p">(</span><span class="n">ctlp</span><span class="p">);</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">CtlMask</span> <span class="o">=</span> <span class="n">sGetControllerIntStatus</span><span class="p">(</span><span class="n">ctlp</span><span class="p">);</span>

		<span class="cm">/*  Check if any AIOP read bits are set */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">CtlMask</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">AiopIntrBits</span><span class="p">[</span><span class="n">aiop</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CtlMask</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">CtlMask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
				<span class="n">AiopMask</span> <span class="o">=</span> <span class="n">sGetAiopIntStatus</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">aiop</span><span class="p">);</span>

				<span class="cm">/*  Check if any port read bits are set */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">AiopMask</span><span class="p">;</span>  <span class="n">AiopMask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">AiopMask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

						<span class="cm">/*  Get the line number (/dev/ttyRx number). */</span>
						<span class="cm">/*  Read the data from the port. */</span>
						<span class="n">line</span> <span class="o">=</span> <span class="n">GetLineNumber</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
						<span class="n">rp_handle_port</span><span class="p">(</span><span class="n">rp_table</span><span class="p">[</span><span class="n">line</span><span class="p">]);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">xmitmask</span> <span class="o">=</span> <span class="n">xmit_flags</span><span class="p">[</span><span class="n">ctrl</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 *  xmit_flags contains bit-significant flags, indicating there is data</span>
<span class="cm">		 *  to xmit on the port. Bit 0 is port 0 on this board, bit 1 is port </span>
<span class="cm">		 *  1, ... (32 total possible).  The variable i has the aiop and ch </span>
<span class="cm">		 *  numbers encoded in it (port 0-7 are aiop0, 8-15 are aiop1, etc).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xmitmask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">ctrl</span><span class="p">].</span><span class="n">numPorts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xmitmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">aiop</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
					<span class="n">line</span> <span class="o">=</span> <span class="n">GetLineNumber</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
					<span class="n">rp_do_transmit</span><span class="p">(</span><span class="n">rp_table</span><span class="p">[</span><span class="n">line</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the timer so we get called at the next clock tick (10ms).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rocket_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_PERIOD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Initializes the r_port structure for a port, as well as enabling the port on </span>
<span class="cm"> *  the board.  </span>
<span class="cm"> *  Inputs:  board, aiop, chan numbers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_r_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">board</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">rocketMode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">CONTROLLER_T</span> <span class="o">*</span><span class="n">ctlp</span><span class="p">;</span>

	<span class="cm">/*  Get the next available line number */</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">SetLineNumber</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">ctlp</span> <span class="o">=</span> <span class="n">sCtlNumToCtlPtr</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>

	<span class="cm">/*  Get a r_port struct for the port, fill it in and save it globally, indexed by line number */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t allocate info struct for line #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">line</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">RPORT_MAGIC</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ctlp</span> <span class="o">=</span> <span class="n">ctlp</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">=</span> <span class="n">aiop</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rocket_port_ops</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ROCKET_MODE_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pc104</span><span class="p">[</span><span class="n">board</span><span class="p">][</span><span class="n">line</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">422</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ROCKET_MODE_RS422</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">485</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ROCKET_MODE_RS485</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">232</span>:
	<span class="nl">default:</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ROCKET_MODE_RS232</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">=</span> <span class="n">RXF_TRIG</span> <span class="o">|</span> <span class="n">TXFIFO_MT</span> <span class="o">|</span> <span class="n">SRC_INT</span> <span class="o">|</span> <span class="n">DELTA_CD</span> <span class="o">|</span> <span class="n">DELTA_CTS</span> <span class="o">|</span> <span class="n">DELTA_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sInitChan</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RocketPort sInitChan(%d, %d, %d) failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">board</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rocketMode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_MODE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_RTS_TOGGLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rocketMode</span> <span class="o">==</span> <span class="n">ROCKET_MODE_RS485</span><span class="p">))</span>
		<span class="n">sEnRTSToggle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sDisRTSToggle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_PC104</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rocketMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS485</span>:
			<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">InterfaceModeRS485</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS422</span>:
			<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">InterfaceModeRS422</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS232</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_RTS_TOGGLE</span><span class="p">)</span>
				<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">InterfaceModeRS232T</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">InterfaceModeRS232</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_mtx</span><span class="p">);</span>
	<span class="n">rp_table</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">tty_register_device</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">pci_dev</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span>
			<span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Configures a rocketport port according to its termio settings.  Called from </span>
<span class="cm"> *  user mode into the driver (exception handler).  *info CD manipulation is spinlock protected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">configure_r_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rocketMode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">cflag</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/* Byte size and parity */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sSetData8</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sSetData7</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sSetStop2</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sSetStop1</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sEnParity</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sSetOddParity</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sSetEvenParity</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sDisParity</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* baud rate */</span>
	<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_get_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">divisor</span> <span class="o">=</span> <span class="p">((</span><span class="n">rp_baud_base</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">baud</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">divisor</span> <span class="o">&gt;=</span> <span class="mi">8192</span> <span class="o">||</span> <span class="n">divisor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old_termios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">old_termios</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">baud</span><span class="p">)</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp_baud_base</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]</span> <span class="o">/</span> <span class="n">baud</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;=</span> <span class="mi">8192</span> <span class="o">||</span> <span class="n">divisor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp_baud_base</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]</span> <span class="o">/</span> <span class="n">baud</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="n">baud</span> <span class="o">/</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">sSetBaud</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">divisor</span><span class="p">);</span>

	<span class="cm">/* FIXME: Should really back compute a baud rate from the divisor */</span>
	<span class="n">tty_encode_baud_rate</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">|=</span> <span class="n">DELTA_CTS</span><span class="p">;</span>
		<span class="n">sEnCTSFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DELTA_CTS</span><span class="p">;</span>
		<span class="n">sDisCTSFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DELTA_CD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sGetChanStatus</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">|=</span> <span class="n">DELTA_CD</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle software flow control in the board</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef ROCKET_SOFT_FLOW</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXON</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sEnTxSoftFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IXANY</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sEnIXANY</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sDisIXANY</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sSetTxXONChar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
		<span class="n">sSetTxXOFFChar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sDisTxSoftFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sDisIXANY</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sClrTxXOFF</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up ignore/read mask words</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">STMRCVROVRH</span> <span class="o">|</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_INPCK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">STMFRAMEH</span> <span class="o">|</span> <span class="n">STMPARITYH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_BRKINT</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">I_PARMRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">STMBREAKH</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characters to ignore</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">STMFRAMEH</span> <span class="o">|</span> <span class="n">STMPARITYH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNBRK</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">STMBREAKH</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns too.  (For real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I_IGNPAR</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">STMRCVROVRH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rocketMode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_MODE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_RTS_TOGGLE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">rocketMode</span> <span class="o">==</span> <span class="n">ROCKET_MODE_RS485</span><span class="p">))</span>
		<span class="n">sEnRTSToggle</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sDisRTSToggle</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

	<span class="n">sSetRTS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_PC104</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rocketMode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS485</span>:
			<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">InterfaceModeRS485</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS422</span>:
			<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">InterfaceModeRS422</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROCKET_MODE_RS232</span>:
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_RTS_TOGGLE</span><span class="p">)</span>
				<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">InterfaceModeRS232T</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sSetInterfaceMode</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">InterfaceModeRS232</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sGetChanStatusLo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sSetDTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">sSetRTS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sClrDTR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">sClrRTS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Exception handler that opens a serial port.  Creates xmit_buf storage, fills in </span>
<span class="cm"> *  port&#39;s r_port struct.  Initializes the port hardware.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">rp_table</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	
	<span class="n">page</span> <span class="o">=</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_HUP_NOTIFY</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must not sleep from here until the port is marked fully in use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">);</span>

<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rocket mod++ = %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_open ttyR%d, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Info-&gt;count is now 1; so it&#39;s safe to sleep now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">sSetRxTrigger</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">TRIG_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sGetChanStatus</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sDisRxStatusMode</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sFlushRxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sFlushTxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

		<span class="n">sEnInterrupts</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">(</span><span class="n">TXINT_EN</span> <span class="o">|</span> <span class="n">MCINT_EN</span> <span class="o">|</span> <span class="n">RXINT_EN</span> <span class="o">|</span> <span class="n">SRCINT_EN</span> <span class="o">|</span> <span class="n">CHANINT_EN</span><span class="p">));</span>
		<span class="n">sSetRxTrigger</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">TRIG_1</span><span class="p">);</span>

		<span class="n">sGetChanStatus</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sDisRxStatusMode</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sClrTxXOFF</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

		<span class="n">sDisCTSFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sDisTxSoftFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

		<span class="n">sEnRxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sEnTransmit</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set up the tty-&gt;alt_speed kludge</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_HI</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_VHI</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_SHI</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_WARP</span><span class="p">)</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>

		<span class="n">configure_r_port</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sSetDTR</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
			<span class="n">sSetRTS</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*  Starts (or resets) the maint polling loop */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rocket_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">POLL_PERIOD</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_open returning after block_til_ready with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Exception handler that closes a serial port. info-&gt;port.count is considered critical.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_close ttyR%d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty_port_close_start</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Before we drop DTR, make sure the UART transmitter</span>
<span class="cm">	 * has completely drained; this is especially</span>
<span class="cm">	 * important if there is a transmit FIFO!</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rp_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>

	<span class="n">sDisTransmit</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sDisInterrupts</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">(</span><span class="n">TXINT_EN</span> <span class="o">|</span> <span class="n">MCINT_EN</span> <span class="o">|</span> <span class="n">RXINT_EN</span> <span class="o">|</span> <span class="n">SRCINT_EN</span> <span class="o">|</span> <span class="n">CHANINT_EN</span><span class="p">));</span>
	<span class="n">sDisCTSFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sDisTxSoftFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sClrTxXOFF</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sFlushRxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sFlushTxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sClrRTS</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">C_HUPCL</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">sClrDTR</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

	<span class="n">rp_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>

	<span class="cm">/* We can&#39;t yet use tty_port_close_end as the buffer handling in this</span>
<span class="cm">	   driver is a bit different to the usual */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">blocked_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_delay</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ASYNC_INITIALIZED</span> <span class="o">|</span> <span class="n">ASYNC_CLOSING</span> <span class="o">|</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">tty_port_tty_set</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">);</span>

<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rocket mod-- = %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_close ttyR%d complete shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_set_termios&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This driver doesn&#39;t support CS5 or CS6</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS5</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS6</span><span class="p">))</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSIZE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">));</span>
	<span class="cm">/* Or CMSPAR */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMSPAR</span><span class="p">;</span>

	<span class="n">configure_r_port</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sClrDTR</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sClrRTS</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span>
			<span class="n">sSetRTS</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="n">sSetDTR</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp_start</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_break</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_break&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">sSendBreak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sClrBreak</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sGetChanRI used to be a macro in rocket_int.h. When the functionality for</span>
<span class="cm"> * the UPCI boards was added, it was decided to make this a function because</span>
<span class="cm"> * the macro was getting too complicated. All cases except the first one</span>
<span class="cm"> * (UPCIRingInd) are taken directly from the original macro.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sGetChanRI</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONTROLLER_t</span> <span class="o">*</span><span class="n">CtlP</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">CtlP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ChanNum</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">RingInd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">UPCIRingInd</span><span class="p">)</span>
		<span class="n">RingInd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sInB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">UPCIRingInd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sBitMapSetTbl</span><span class="p">[</span><span class="n">ChanNum</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AltChanRingIndicator</span><span class="p">)</span>
		<span class="n">RingInd</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">((</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanStat</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DSR_ACT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_PC104</span><span class="p">)</span>
		<span class="n">RingInd</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sInB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">sBitMapSetTbl</span><span class="p">[</span><span class="n">ChanNum</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">RingInd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************************/</span>
<span class="cm">/*  Here are the routines used by rp_ioctl.  These are all called from exception handlers.  */</span>

<span class="cm">/*</span>
<span class="cm"> *  Returns the state of the serial modem control lines.  These next 2 functions </span>
<span class="cm"> *  are the way kernel versions &gt; 2.5 handle modem control lines rather than IOCTLs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ChanStatus</span><span class="p">;</span>

	<span class="n">ChanStatus</span> <span class="o">=</span> <span class="n">sGetChanStatusLo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SET_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> 
		<span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">SET_DTR</span><span class="p">)</span> <span class="o">?</span>  <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">CD_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">sGetChanRI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">DSR_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">ChanStatus</span> <span class="o">&amp;</span> <span class="n">CTS_ACT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> *  Sets the modem control lines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SET_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SET_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SET_DTR</span><span class="p">;</span>

	<span class="n">out32</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">.</span><span class="n">TxControl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rocket_config</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rocket_config</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retinfo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">retinfo</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rocket_config</span> <span class="n">__user</span> <span class="o">*</span><span class="n">new_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rocket_config</span> <span class="n">new_serial</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_serial</span><span class="p">,</span> <span class="n">new_info</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ROCKET_USR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ROCKET_USR_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ROCKET_USR_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_USR_MASK</span><span class="p">));</span>
		<span class="n">configure_r_port</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ROCKET_FLAGS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">new_serial</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_FLAGS</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">close_delay</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">close_delay</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">closing_wait</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">.</span><span class="n">closing_wait</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_HI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">57600</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_VHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_SHI</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ROCKET_SPD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROCKET_SPD_WARP</span><span class="p">)</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">alt_speed</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">configure_r_port</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This function fills in a rocket_ports struct with information</span>
<span class="cm"> *  about what boards/ports are in the system.  This info is passed</span>
<span class="cm"> *  to user space.  See setrocket.c where the info is used to create</span>
<span class="cm"> *  the /dev/ttyRx ports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rocket_ports</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rocket_ports</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retports</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">tty_major</span> <span class="o">=</span> <span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">board</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">board</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">board</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">model</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">modelString</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">numPorts</span><span class="p">;</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">loadrm2</span> <span class="o">=</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">loadrm2</span><span class="p">;</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">startingPortNumber</span> <span class="o">=</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">board</span><span class="p">].</span><span class="n">startingPortNumber</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retports</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">retports</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_rm2</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reset</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ROCKET_TYPE_MODEMII</span> <span class="o">&amp;&amp;</span>
            <span class="n">rcktpt_type</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ROCKET_TYPE_MODEMIII</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">BusType</span> <span class="o">==</span> <span class="n">isISA</span><span class="p">)</span>
		<span class="n">sModemReset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sPCIModemReset</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rocket_version</span> <span class="n">__user</span> <span class="o">*</span><span class="n">retvers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">retvers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_version</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">retvers</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  IOCTL call handler into the driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">RCKP_GET_PORTS</span> <span class="o">&amp;&amp;</span> <span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RCKP_GET_STRUCT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r_port</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RCKP_GET_CONFIG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RCKP_SET_CONFIG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_config</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RCKP_GET_PORTS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_ports</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RCKP_RESET_RM2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">reset_rm2</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RCKP_GET_VERSION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_send_xchar&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>
		<span class="n">sWriteTxPrioByte</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sWriteTxByte</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_THROTTLE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;throttle %s: %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">rp_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

	<span class="n">sClrRTS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_THROTTLE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;unthrottle %s: %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ldisc</span><span class="p">.</span><span class="n">chars_in_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">rp_send_xchar</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">));</span>

	<span class="n">sSetRTS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * rp_stop() and rp_start()</span>
<span class="cm"> *</span>
<span class="cm"> * This routines are called before setting or resetting tty-&gt;stopped.</span>
<span class="cm"> * They enable or disable transmitter interrupts, as necessary.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_FLOW</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;stop %s: %d %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_stop&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sGetTxCnt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">))</span>
		<span class="n">sDisTransmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_FLOW</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;start %s: %d %d....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_stop&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sEnTransmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rp_wait_until_sent() --- wait until the transmitter is empty</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_wait_until_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">orig_jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check_time</span><span class="p">,</span> <span class="n">exit_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txcnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_wait_until_sent&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">orig_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_WAIT_UNTIL_SENT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;In RP_wait_until_sent(%d) (jiff=%lu)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
	       <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cps=%d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txcnt</span> <span class="o">=</span> <span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txcnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sGetChanStatusLo</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXSHRMT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">check_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">check_time</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">txcnt</span> <span class="o">/</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exit_time</span> <span class="o">=</span> <span class="n">orig_jiffies</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exit_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exit_time</span> <span class="o">&lt;</span> <span class="n">check_time</span><span class="p">)</span>
				<span class="n">check_time</span> <span class="o">=</span> <span class="n">exit_time</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">check_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_WAIT_UNTIL_SENT</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;txcnt = %d (jiff=%lu,check=%d)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txcnt</span><span class="p">,</span>
				<span class="n">jiffies</span><span class="p">,</span> <span class="n">check_time</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">check_time</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
<span class="cp">#ifdef ROCKET_DEBUG_WAIT_UNTIL_SENT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;txcnt = %d (jiff=%lu)...done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txcnt</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rp_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if (defined(ROCKET_DEBUG_OPEN) || defined(ROCKET_DEBUG_HANGUP))</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_hangup of ttyR%d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">rp_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rp_num_ports_open</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">sDisRxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sDisTransmit</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sDisInterrupts</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">(</span><span class="n">TXINT_EN</span> <span class="o">|</span> <span class="n">MCINT_EN</span> <span class="o">|</span> <span class="n">RXINT_EN</span> <span class="o">|</span> <span class="n">SRCINT_EN</span> <span class="o">|</span> <span class="n">CHANINT_EN</span><span class="p">));</span>
	<span class="n">sDisCTSFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sDisTxSoftFlowCtl</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">sClrTxXOFF</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ASYNCB_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Exception handler - write char routine.  The RocketPort driver uses a</span>
<span class="cm"> *  double-buffering strategy, with the twist that if the in-memory CPU</span>
<span class="cm"> *  buffer is empty, and there&#39;s space in the transmit FIFO, the</span>
<span class="cm"> *  writing routines will write directly to transmit FIFO.</span>
<span class="cm"> *  Write buffer and counters protected by spinlocks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_put_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_put_char&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab the port write mutex, locking out other processes that try to</span>
<span class="cm">	 * write to this port</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_mtx</span><span class="p">);</span>

<span class="cp">#ifdef ROCKET_DEBUG_WRITE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_put_char %c...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">=</span> <span class="n">TXFIFO_SIZE</span> <span class="o">-</span> <span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">&amp;=</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Exception handler - write routine, called when user app writes to the device.</span>
<span class="cm"> *  A per port write mutex is used to protect from another process writing to</span>
<span class="cm"> *  this port at the same time.  This other process could be running on the other CPU</span>
<span class="cm"> *  or get control of the CPU if the copy_from_user() blocks due to a page fault (swapped out). </span>
<span class="cm"> *  Spinlocks protect the info xmit members.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_mtx</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_WRITE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_write %d chars...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">=</span> <span class="n">TXFIFO_SIZE</span> <span class="o">-</span> <span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">	 *  If the write queue for the port is empty, and there is FIFO space, stuff bytes </span>
<span class="cm">	 *  into FIFO.  Use the write queue for temp storage.</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span><span class="p">);</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="cm">/*  Push data into FIFO, 2 bytes at a time */</span>
		<span class="n">sOutStrW</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/*  If there is a byte remaining, write it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sOutB</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">cp</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

		<span class="n">retval</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_fifo_room</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If count is zero, we wrote it all and are done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/*  Write remaining data into the port&#39;s xmit_buf */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hung up ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ASYNCB_NORMAL_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_buf</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">aiop</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">xmit_flags</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">]);</span>
	
<span class="nl">end:</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="cp">#ifdef ROCKETPORT_HAVE_POLL_WAIT</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">write_mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the number of characters that can be sent.  We estimate</span>
<span class="cm"> * only using the in-memory transmit buffer only, and ignore the</span>
<span class="cm"> * potential space in the transmit FIFO.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">XMIT_BUF_SIZE</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_DEBUG_WRITE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_write_room returns %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the number of characters in the buffer.  Again, this only</span>
<span class="cm"> * counts those characters in the in-memory transmit buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rp_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef ROCKET_DEBUG_WRITE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;rp_chars_in_buffer returns %d...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Flushes the TX fifo for a port, deletes data in the xmit_buf stored in the</span>
<span class="cm"> *  r_port struct for the port.  Note that spinlock are used to protect info members,</span>
<span class="cm"> *  do not call this function if the spinlock is already held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r_port</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">CHANNEL_t</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rocket_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;rp_flush_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_head</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef ROCKETPORT_HAVE_POLL_WAIT</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">sFlushTxFIFO</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">__devinitdata</span> <span class="n">__used</span> <span class="n">rocket_pci_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_RP</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rocket_pci_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Called when a PCI card is found.  Retrieves and stores model information,</span>
<span class="cm"> *  init&#39;s aiopic and serial port hardware.</span>
<span class="cm"> *  Inputs:  i is the board number (0-n)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">register_PCI</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_aiops</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">max_num_aiops</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aiopio</span><span class="p">[</span><span class="n">MAX_AIOPS_PER_BOARD</span><span class="p">];</span>
	<span class="n">CONTROLLER_t</span> <span class="o">*</span><span class="n">ctlp</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">fast_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">altChanRingIndicator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">WordIO_t</span> <span class="n">ConfigIO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ByteIO_t</span> <span class="n">UPCIRingInd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">loadrm2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span> <span class="o">=</span> <span class="n">nextLineNumber</span><span class="p">;</span>

	<span class="cm">/*  Depending on the model, set up some config variables */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP4QUAD</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP4QUAD</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 4 port w/quad cable&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP8OCTA</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP8OCTA</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 8 port w/octa cable&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP8OCTA</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RP8OCTA</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort UPCI 8 port w/octa cable&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP8INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP8INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 8 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP8INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RP8INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort UPCI 8 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP8J</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP8J</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 8 port w/RJ11 connectors&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP4J</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP4J</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 4 port w/RJ45 connectors&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP8SNI</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP8SNI</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 8 port w/ custom DB78&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP16SNI</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP16SNI</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 16 port w/ custom DB78&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP16INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP16INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 16 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP16INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RP16INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort UPCI 16 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_CRP16INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_CPCI_RP16INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort Compact PCI 16 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP32INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP32INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort 32 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP32INTF</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RP32INTF</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort UPCI 32 port w/external I/F&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RPP4</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">altChanRingIndicator</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fast_clock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RPP4</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort Plus 4 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RPP8</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">altChanRingIndicator</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fast_clock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RPP8</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort Plus 8 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP2_232</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">altChanRingIndicator</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fast_clock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP2_232</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort Plus 2 port RS232&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP2_422</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">altChanRingIndicator</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fast_clock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP2_422</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort Plus 2 port RS422&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP6M</span>:

		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="cm">/*  If revision is 1, the rocketmodem flash must be loaded.</span>
<span class="cm">		 *  If it is 2 it is a &quot;socketed&quot; version. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEMII</span><span class="p">;</span>
			<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">loadrm2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP6M</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketModem 6 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_RP4M</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEMII</span><span class="p">;</span>
			<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">loadrm2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_RP4M</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketModem 4 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for UPCI boards.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP32INTF</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP8INTF</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP16INTF</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_CRP16INTF</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_URP8OCTA</span>:
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ConfigIO</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_URP8OCTA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UPCIRingInd</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">_PCI_9030_RING_IND</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Check for octa or quad cable.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
			    <span class="p">(</span><span class="n">sInW</span><span class="p">(</span><span class="n">ConfigIO</span> <span class="o">+</span> <span class="n">_PCI_9030_GPIO_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">PCI_GPIO_CTRL_8PORT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ports_per_aiop</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_UPCI_RM3_8PORT</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RM3_8PORT</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketModem III 8 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">UPCIRingInd</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">_PCI_9030_RING_IND</span><span class="p">;</span>
		<span class="n">ConfigIO</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEMIII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_UPCI_RM3_4PORT</span>:
		<span class="n">max_num_aiops</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_UPCI_RM3_4PORT</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketModem III 4 port&quot;</span><span class="p">);</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">UPCIRingInd</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">_PCI_9030_RING_IND</span><span class="p">;</span>
		<span class="n">ConfigIO</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROCKET_TYPE_MODEMIII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fast_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>	<span class="cm">/* mod 2 (divide by 3) */</span>
		<span class="n">rp_baud_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">921600</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If support_low_speed is set, use the slow clock</span>
<span class="cm">		 * prescale, which supports 50 bps</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">support_low_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mod 9 (divide by 10) prescale */</span>
			<span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>
			<span class="n">rp_baud_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* mod 4 (divide by 5) prescale */</span>
			<span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
			<span class="n">rp_baud_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aiop</span> <span class="o">&lt;</span> <span class="n">max_num_aiops</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aiopio</span><span class="p">[</span><span class="n">aiop</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">*</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">ctlp</span> <span class="o">=</span> <span class="n">sCtlNumToCtlPtr</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">num_aiops</span> <span class="o">=</span> <span class="n">sPCIInitController</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">aiopio</span><span class="p">,</span> <span class="n">max_num_aiops</span><span class="p">,</span> <span class="n">ConfigIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FREQ_DIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">altChanRingIndicator</span><span class="p">,</span> <span class="n">UPCIRingInd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aiop</span> <span class="o">&lt;</span> <span class="n">max_num_aiops</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">AiopNumChan</span><span class="p">[</span><span class="n">aiop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ports_per_aiop</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;comtrol PCI controller #%d found at &quot;</span>
		<span class="s">&quot;address %04lx, %d AIOP(s) (%s), creating ttyR%d - %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_aiops</span><span class="p">,</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span><span class="p">,</span>
		<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span> <span class="o">+</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_aiops</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">is_PCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*  Reset the AIOPIC, init the serial ports */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aiop</span> <span class="o">&lt;</span> <span class="n">num_aiops</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sResetAiopByNum</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">aiop</span><span class="p">);</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">ports_per_aiop</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">init_r_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Rocket modems must be reset */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_MODEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_MODEMII</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_MODEMIII</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">ports_per_aiop</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sPCIModemReset</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sPCIModemReset</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">rmSpeakerReset</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Probes for PCI cards, inits them if found</span>
<span class="cm"> *  Input:   board_found = number of ISA boards already found, or the</span>
<span class="cm"> *           starting board number</span>
<span class="cm"> *  Returns: Number of PCI boards found</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_PCI</span><span class="p">(</span><span class="kt">int</span> <span class="n">boards_found</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  Work through the PCI device list, pulling out ours */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_RP</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_PCI</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">boards_found</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Probes for ISA cards</span>
<span class="cm"> *  Input:   i = the board number to look for</span>
<span class="cm"> *  Returns: 1 if board found, 0 else</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ISA</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_aiops</span><span class="p">,</span> <span class="n">num_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_num_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aiopio</span><span class="p">[</span><span class="n">MAX_AIOPS_PER_BOARD</span><span class="p">];</span>
	<span class="n">CONTROLLER_t</span> <span class="o">*</span><span class="n">ctlp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type_string</span><span class="p">;</span>

	<span class="cm">/*  If io_addr is zero, no board configured */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*  Reserve the IO region */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;Comtrol RocketPort&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to reserve IO region for configured &quot;</span>
				<span class="s">&quot;ISA RocketPort at address 0x%lx, board not &quot;</span>
				<span class="s">&quot;installed...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctlp</span> <span class="o">=</span> <span class="n">sCtlNumToCtlPtr</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">=</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ROCKET_TYPE_PC104</span>:
		<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;(PC104)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ROCKET_TYPE_MODEM</span>:
		<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;(RocketModem)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ROCKET_TYPE_MODEMII</span>:
		<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;(RocketModem II)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type_string</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If support_low_speed is set, use the slow clock prescale,</span>
<span class="cm">	 * which supports 50 bps</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">support_low_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x19</span><span class="p">;</span>	<span class="cm">/* mod 9 (divide by 10) prescale */</span>
		<span class="n">rp_baud_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">230400</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sClockPrescale</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>	<span class="cm">/* mod 4 (divide by 5) prescale */</span>
		<span class="n">rp_baud_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">460800</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aiop</span> <span class="o">&lt;</span> <span class="n">MAX_AIOPS_PER_BOARD</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span>
		<span class="n">aiopio</span><span class="p">[</span><span class="n">aiop</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">);</span>

	<span class="n">num_aiops</span> <span class="o">=</span> <span class="n">sInitController</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">controller</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">),</span> <span class="n">aiopio</span><span class="p">,</span>  <span class="n">MAX_AIOPS_PER_BOARD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FREQ_DIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctlp</span><span class="o">-&gt;</span><span class="n">boardType</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_PC104</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sEnAiop</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* only one AIOPIC, but these */</span>
		<span class="n">sEnAiop</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* CSels used for other stuff */</span>
	<span class="p">}</span>

	<span class="cm">/*  If something went wrong initing the AIOP&#39;s release the ISA IO memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_aiops</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
  
	<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span> <span class="o">=</span> <span class="n">nextLineNumber</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">aiop</span> <span class="o">&lt;</span> <span class="n">num_aiops</span><span class="p">;</span> <span class="n">aiop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sResetAiopByNum</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">aiop</span><span class="p">);</span>
		<span class="n">sEnAiop</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">aiop</span><span class="p">);</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">sGetAiopNumChan</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">aiop</span><span class="p">);</span>
		<span class="n">total_num_chan</span> <span class="o">+=</span> <span class="n">num_chan</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">init_r_port</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">aiop</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">is_PCI</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_MODEM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rcktpt_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ROCKET_TYPE_MODEMII</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">num_chan</span> <span class="o">=</span> <span class="n">sGetAiopNumChan</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">total_num_chan</span> <span class="o">=</span> <span class="n">num_chan</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sModemReset</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">num_chan</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sModemReset</span><span class="p">(</span><span class="n">ctlp</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketModem ISA&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span> <span class="s">&quot;RocketPort ISA&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">=</span> <span class="n">total_num_chan</span><span class="p">;</span>
	<span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_ISA</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RocketPort ISA card #%d found at 0x%lx - %d AIOPs %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	       <span class="n">i</span><span class="p">,</span> <span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_aiops</span><span class="p">,</span> <span class="n">type_string</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Installing %s, creating /dev/ttyR%d - %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modelString</span><span class="p">,</span>
	       <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span><span class="p">,</span>
	       <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">startingPortNumber</span> <span class="o">+</span>
	       <span class="n">rocketModel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numPorts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">rocket_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">rp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">rp_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">rp_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_char</span> <span class="o">=</span> <span class="n">rp_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">rp_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">rp_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">rp_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">rp_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">rp_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">rp_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">rp_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">rp_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">rp_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">rp_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span> <span class="o">=</span> <span class="n">rp_break</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span> <span class="o">=</span> <span class="n">rp_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_until_sent</span> <span class="o">=</span> <span class="n">rp_wait_until_sent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">rp_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">rp_tiocmset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">rocket_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">dtr_rts</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The module &quot;startup&quot; routine; it&#39;s run when the module is loaded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">pci_boards_found</span><span class="p">,</span> <span class="n">isa_boards_found</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RocketPort device driver module, version %s, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ROCKET_VERSION</span><span class="p">,</span> <span class="n">ROCKET_DATE</span><span class="p">);</span>

	<span class="n">rocket_driver</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">MAX_RP_PORTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rocket_driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If board 1 is non-zero, there is at least one ISA configured.  If controller is </span>
<span class="cm">	 *  zero, use the default controller IO address of board1 + 0x40.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controller</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">controller</span> <span class="o">=</span> <span class="n">board1</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/*  Used as a flag, meaning no ISA boards */</span>
	<span class="p">}</span>

	<span class="cm">/*  If an ISA card is configured, reserve the 4 byte IO space for the Mudbac controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Comtrol RocketPort&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to reserve IO region for first &quot;</span>
			<span class="s">&quot;configured ISA RocketPort controller 0x%lx.  &quot;</span>
			<span class="s">&quot;Driver exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">controller</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_tty</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Store ISA variable retrieved from command line or .conf file. */</span>
	<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">board1</span><span class="p">;</span>
	<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">board2</span><span class="p">;</span>
	<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">board3</span><span class="p">;</span>
	<span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">board4</span><span class="p">;</span>

	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">modem1</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_MODEM</span> <span class="o">:</span> <span class="n">ROCKET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc104_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_PC104</span> <span class="o">:</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">modem2</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_MODEM</span> <span class="o">:</span> <span class="n">ROCKET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc104_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_PC104</span> <span class="o">:</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">modem3</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_MODEM</span> <span class="o">:</span> <span class="n">ROCKET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc104_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_PC104</span> <span class="o">:</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">modem4</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_MODEM</span> <span class="o">:</span> <span class="n">ROCKET_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc104_4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">ROCKET_TYPE_PC104</span> <span class="o">:</span> <span class="n">rcktpt_type</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the tty driver structure and then register this</span>
<span class="cm">	 * driver with the tty layer.</span>
<span class="cm">	 */</span>

	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyR&quot;</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;Comtrol RocketPort&quot;</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">TTY_ROCKET_MAJOR</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span>
	    <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
<span class="cp">#ifdef ROCKET_SOFT_FLOW</span>
	<span class="n">rocket_driver</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TTY_DRIVER_REAL_RAW</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rocket_ops</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t install tty RocketPort driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_controller</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef ROCKET_DEBUG_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;RocketPort driver is major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rocket_driver</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *  OK, let&#39;s probe each of the controllers looking for boards.  Any boards found</span>
<span class="cm">         *  will be initialized here.</span>
<span class="cm">	 */</span>
	<span class="n">isa_boards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_boards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_ISA</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">isa_boards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isa_boards_found</span> <span class="o">&lt;</span> <span class="n">NUM_BOARDS</span><span class="p">)</span>
		<span class="n">pci_boards_found</span> <span class="o">=</span> <span class="n">init_PCI</span><span class="p">(</span><span class="n">isa_boards_found</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">max_board</span> <span class="o">=</span> <span class="n">pci_boards_found</span> <span class="o">+</span> <span class="n">isa_boards_found</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_board</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No rocketport ports found; unloading driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ttyu</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_ttyu:</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">);</span>
<span class="nl">err_controller:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="nl">err_tty:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rp_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rocket_timer</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error %d while trying to unregister &quot;</span>
		       <span class="s">&quot;rocketport driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">retval</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RP_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">rocket_driver</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BOARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">is_PCI</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">rcktpt_io_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controller</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sInitController</span>
<span class="cm">Purpose:  Initialization of controller global registers and controller</span>
<span class="cm">          structure.</span>
<span class="cm">Call:     sInitController(CtlP,CtlNum,MudbacIO,AiopIOList,AiopIOListSize,</span>
<span class="cm">                          IRQNum,Frequency,PeriodicOnly)</span>
<span class="cm">          CONTROLLER_T *CtlP; Ptr to controller structure</span>
<span class="cm">          int CtlNum; Controller number</span>
<span class="cm">          ByteIO_t MudbacIO; Mudbac base I/O address.</span>
<span class="cm">          ByteIO_t *AiopIOList; List of I/O addresses for each AIOP.</span>
<span class="cm">             This list must be in the order the AIOPs will be found on the</span>
<span class="cm">             controller.  Once an AIOP in the list is not found, it is</span>
<span class="cm">             assumed that there are no more AIOPs on the controller.</span>
<span class="cm">          int AiopIOListSize; Number of addresses in AiopIOList</span>
<span class="cm">          int IRQNum; Interrupt Request number.  Can be any of the following:</span>
<span class="cm">                         0: Disable global interrupts</span>
<span class="cm">                         3: IRQ 3</span>
<span class="cm">                         4: IRQ 4</span>
<span class="cm">                         5: IRQ 5</span>
<span class="cm">                         9: IRQ 9</span>
<span class="cm">                         10: IRQ 10</span>
<span class="cm">                         11: IRQ 11</span>
<span class="cm">                         12: IRQ 12</span>
<span class="cm">                         15: IRQ 15</span>
<span class="cm">          Byte_t Frequency: A flag identifying the frequency</span>
<span class="cm">                   of the periodic interrupt, can be any one of the following:</span>
<span class="cm">                      FREQ_DIS - periodic interrupt disabled</span>
<span class="cm">                      FREQ_137HZ - 137 Hertz</span>
<span class="cm">                      FREQ_69HZ - 69 Hertz</span>
<span class="cm">                      FREQ_34HZ - 34 Hertz</span>
<span class="cm">                      FREQ_17HZ - 17 Hertz</span>
<span class="cm">                      FREQ_9HZ - 9 Hertz</span>
<span class="cm">                      FREQ_4HZ - 4 Hertz</span>
<span class="cm">                   If IRQNum is set to 0 the Frequency parameter is</span>
<span class="cm">                   overidden, it is forced to a value of FREQ_DIS.</span>
<span class="cm">          int PeriodicOnly: 1 if all interrupts except the periodic</span>
<span class="cm">                               interrupt are to be blocked.</span>
<span class="cm">                            0 is both the periodic interrupt and</span>
<span class="cm">                               other channel interrupts are allowed.</span>
<span class="cm">                            If IRQNum is set to 0 the PeriodicOnly parameter is</span>
<span class="cm">                               overidden, it is forced to a value of 0.</span>
<span class="cm">Return:   int: Number of AIOPs on the controller, or CTLID_NULL if controller</span>
<span class="cm">               initialization failed.</span>

<span class="cm">Comments:</span>
<span class="cm">          If periodic interrupts are to be disabled but AIOP interrupts</span>
<span class="cm">          are allowed, set Frequency to FREQ_DIS and PeriodicOnly to 0.</span>

<span class="cm">          If interrupts are to be completely disabled set IRQNum to 0.</span>

<span class="cm">          Setting Frequency to FREQ_DIS and PeriodicOnly to 1 is an</span>
<span class="cm">          invalid combination.</span>

<span class="cm">          This function performs initialization of global interrupt modes,</span>
<span class="cm">          but it does not actually enable global interrupts.  To enable</span>
<span class="cm">          and disable global interrupts use functions sEnGlobalInt() and</span>
<span class="cm">          sDisGlobalInt().  Enabling of global interrupts is normally not</span>
<span class="cm">          done until all other initializations are complete.</span>

<span class="cm">          Even if interrupts are globally enabled, they must also be</span>
<span class="cm">          individually enabled for each channel that is to generate</span>
<span class="cm">          interrupts.</span>

<span class="cm">Warnings: No range checking on any of the parameters is done.</span>

<span class="cm">          No context switches are allowed while executing this function.</span>

<span class="cm">          After this function all AIOPs on the controller are disabled,</span>
<span class="cm">          they can be enabled with sEnAiop().</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sInitController</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">CtlNum</span><span class="p">,</span> <span class="n">ByteIO_t</span> <span class="n">MudbacIO</span><span class="p">,</span>
			   <span class="n">ByteIO_t</span> <span class="o">*</span> <span class="n">AiopIOList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopIOListSize</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">IRQNum</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Frequency</span><span class="p">,</span> <span class="kt">int</span> <span class="n">PeriodicOnly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ByteIO_t</span> <span class="n">io</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIntrBits</span> <span class="o">=</span> <span class="n">aiop_intr_bits</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AltChanRingIndicator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">CtlNum</span> <span class="o">=</span> <span class="n">CtlNum</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">CtlID</span> <span class="o">=</span> <span class="n">CTLID_0001</span><span class="p">;</span>	<span class="cm">/* controller release 1 */</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">BusType</span> <span class="o">=</span> <span class="n">isISA</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MBaseIO</span> <span class="o">=</span> <span class="n">MudbacIO</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg1IO</span> <span class="o">=</span> <span class="n">MudbacIO</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2IO</span> <span class="o">=</span> <span class="n">MudbacIO</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3IO</span> <span class="o">=</span> <span class="n">MudbacIO</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#if 1</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt disable */</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no periodic interrupts */</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sIRQMap</span><span class="p">[</span><span class="n">IRQNum</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* interrupts globally disabled */</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt disable */</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no periodic interrupts */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2</span> <span class="o">=</span> <span class="n">sIRQMap</span><span class="p">[</span><span class="n">IRQNum</span><span class="p">];</span>	<span class="cm">/* set IRQ number */</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3</span> <span class="o">=</span> <span class="n">Frequency</span><span class="p">;</span>	<span class="cm">/* set frequency */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PeriodicOnly</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* periodic interrupt only */</span>
			<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3</span> <span class="o">|=</span> <span class="n">PERIODIC_ONLY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2IO</span><span class="p">,</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2</span><span class="p">);</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3IO</span><span class="p">,</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3</span><span class="p">);</span>
	<span class="n">sControllerEOI</span><span class="p">(</span><span class="n">CtlP</span><span class="p">);</span>	<span class="cm">/* clear EOI if warm init */</span>
	<span class="cm">/* Init AIOPs */</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AiopIOListSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">AiopIOList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIntChanIO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span> <span class="o">+</span> <span class="n">_INT_CHAN</span><span class="p">;</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2IO</span><span class="p">,</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>	<span class="cm">/* AIOP index */</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">MudbacIO</span><span class="p">,</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>	<span class="cm">/* set up AIOP I/O in MUDBAC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sEnAiop</span><span class="p">(</span><span class="n">CtlP</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* enable the AIOP */</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sReadAiopID</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>	<span class="cm">/* read AIOP ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">AIOPID_NULL</span><span class="p">)</span>	<span class="cm">/* if AIOP does not exist */</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* done looking for AIOPs */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopNumChan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sReadAiopNumChan</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span><span class="p">);</span>	<span class="cm">/* num channels in AIOP */</span>
			<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">,</span> <span class="n">_CLK_PRE</span><span class="p">);</span>	<span class="cm">/* clock prescaler */</span>
			<span class="n">sOutB</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_DATA</span><span class="p">,</span> <span class="n">sClockPrescale</span><span class="p">);</span>
			<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* bump count of AIOPs */</span>
		<span class="p">}</span>
		<span class="n">sDisAiop</span><span class="p">(</span><span class="n">CtlP</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* disable AIOP */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sPCIInitController</span>
<span class="cm">Purpose:  Initialization of controller global registers and controller</span>
<span class="cm">          structure.</span>
<span class="cm">Call:     sPCIInitController(CtlP,CtlNum,AiopIOList,AiopIOListSize,</span>
<span class="cm">                          IRQNum,Frequency,PeriodicOnly)</span>
<span class="cm">          CONTROLLER_T *CtlP; Ptr to controller structure</span>
<span class="cm">          int CtlNum; Controller number</span>
<span class="cm">          ByteIO_t *AiopIOList; List of I/O addresses for each AIOP.</span>
<span class="cm">             This list must be in the order the AIOPs will be found on the</span>
<span class="cm">             controller.  Once an AIOP in the list is not found, it is</span>
<span class="cm">             assumed that there are no more AIOPs on the controller.</span>
<span class="cm">          int AiopIOListSize; Number of addresses in AiopIOList</span>
<span class="cm">          int IRQNum; Interrupt Request number.  Can be any of the following:</span>
<span class="cm">                         0: Disable global interrupts</span>
<span class="cm">                         3: IRQ 3</span>
<span class="cm">                         4: IRQ 4</span>
<span class="cm">                         5: IRQ 5</span>
<span class="cm">                         9: IRQ 9</span>
<span class="cm">                         10: IRQ 10</span>
<span class="cm">                         11: IRQ 11</span>
<span class="cm">                         12: IRQ 12</span>
<span class="cm">                         15: IRQ 15</span>
<span class="cm">          Byte_t Frequency: A flag identifying the frequency</span>
<span class="cm">                   of the periodic interrupt, can be any one of the following:</span>
<span class="cm">                      FREQ_DIS - periodic interrupt disabled</span>
<span class="cm">                      FREQ_137HZ - 137 Hertz</span>
<span class="cm">                      FREQ_69HZ - 69 Hertz</span>
<span class="cm">                      FREQ_34HZ - 34 Hertz</span>
<span class="cm">                      FREQ_17HZ - 17 Hertz</span>
<span class="cm">                      FREQ_9HZ - 9 Hertz</span>
<span class="cm">                      FREQ_4HZ - 4 Hertz</span>
<span class="cm">                   If IRQNum is set to 0 the Frequency parameter is</span>
<span class="cm">                   overidden, it is forced to a value of FREQ_DIS.</span>
<span class="cm">          int PeriodicOnly: 1 if all interrupts except the periodic</span>
<span class="cm">                               interrupt are to be blocked.</span>
<span class="cm">                            0 is both the periodic interrupt and</span>
<span class="cm">                               other channel interrupts are allowed.</span>
<span class="cm">                            If IRQNum is set to 0 the PeriodicOnly parameter is</span>
<span class="cm">                               overidden, it is forced to a value of 0.</span>
<span class="cm">Return:   int: Number of AIOPs on the controller, or CTLID_NULL if controller</span>
<span class="cm">               initialization failed.</span>

<span class="cm">Comments:</span>
<span class="cm">          If periodic interrupts are to be disabled but AIOP interrupts</span>
<span class="cm">          are allowed, set Frequency to FREQ_DIS and PeriodicOnly to 0.</span>

<span class="cm">          If interrupts are to be completely disabled set IRQNum to 0.</span>

<span class="cm">          Setting Frequency to FREQ_DIS and PeriodicOnly to 1 is an</span>
<span class="cm">          invalid combination.</span>

<span class="cm">          This function performs initialization of global interrupt modes,</span>
<span class="cm">          but it does not actually enable global interrupts.  To enable</span>
<span class="cm">          and disable global interrupts use functions sEnGlobalInt() and</span>
<span class="cm">          sDisGlobalInt().  Enabling of global interrupts is normally not</span>
<span class="cm">          done until all other initializations are complete.</span>

<span class="cm">          Even if interrupts are globally enabled, they must also be</span>
<span class="cm">          individually enabled for each channel that is to generate</span>
<span class="cm">          interrupts.</span>

<span class="cm">Warnings: No range checking on any of the parameters is done.</span>

<span class="cm">          No context switches are allowed while executing this function.</span>

<span class="cm">          After this function all AIOPs on the controller are disabled,</span>
<span class="cm">          they can be enabled with sEnAiop().</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sPCIInitController</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">CtlNum</span><span class="p">,</span>
			      <span class="n">ByteIO_t</span> <span class="o">*</span> <span class="n">AiopIOList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopIOListSize</span><span class="p">,</span>
			      <span class="n">WordIO_t</span> <span class="n">ConfigIO</span><span class="p">,</span> <span class="kt">int</span> <span class="n">IRQNum</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Frequency</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">PeriodicOnly</span><span class="p">,</span> <span class="kt">int</span> <span class="n">altChanRingIndicator</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">UPCIRingInd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ByteIO_t</span> <span class="n">io</span><span class="p">;</span>

	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AltChanRingIndicator</span> <span class="o">=</span> <span class="n">altChanRingIndicator</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">UPCIRingInd</span> <span class="o">=</span> <span class="n">UPCIRingInd</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">CtlNum</span> <span class="o">=</span> <span class="n">CtlNum</span><span class="p">;</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">CtlID</span> <span class="o">=</span> <span class="n">CTLID_0001</span><span class="p">;</span>	<span class="cm">/* controller release 1 */</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">BusType</span> <span class="o">=</span> <span class="n">isPCI</span><span class="p">;</span>	<span class="cm">/* controller release 1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ConfigIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">isUPCI</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">PCIIO</span> <span class="o">=</span> <span class="n">ConfigIO</span> <span class="o">+</span> <span class="n">_PCI_9030_INT_CTRL</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">PCIIO2</span> <span class="o">=</span> <span class="n">ConfigIO</span> <span class="o">+</span> <span class="n">_PCI_9030_GPIO_CTRL</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIntrBits</span> <span class="o">=</span> <span class="n">upci_aiop_intr_bits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">isUPCI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">PCIIO</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">AiopIOList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_PCI_INT_FUNC</span><span class="p">);</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIntrBits</span> <span class="o">=</span> <span class="n">aiop_intr_bits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sPCIControllerEOI</span><span class="p">(</span><span class="n">CtlP</span><span class="p">);</span>	<span class="cm">/* clear EOI if warm init */</span>
	<span class="cm">/* Init AIOPs */</span>
	<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AiopIOListSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span> <span class="o">=</span> <span class="n">AiopIOList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span><span class="p">;</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIntChanIO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span> <span class="o">+</span> <span class="n">_INT_CHAN</span><span class="p">;</span>

		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sReadAiopID</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>	<span class="cm">/* read AIOP ID */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">AIOPID_NULL</span><span class="p">)</span>	<span class="cm">/* if AIOP does not exist */</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* done looking for AIOPs */</span>

		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopNumChan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sReadAiopNumChan</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span><span class="p">);</span>	<span class="cm">/* num channels in AIOP */</span>
		<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">,</span> <span class="n">_CLK_PRE</span><span class="p">);</span>	<span class="cm">/* clock prescaler */</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_DATA</span><span class="p">,</span> <span class="n">sClockPrescale</span><span class="p">);</span>
		<span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* bump count of AIOPs */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">NumAiop</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sReadAiopID</span>
<span class="cm">Purpose:  Read the AIOP idenfication number directly from an AIOP.</span>
<span class="cm">Call:     sReadAiopID(io)</span>
<span class="cm">          ByteIO_t io: AIOP base I/O address</span>
<span class="cm">Return:   int: Flag AIOPID_XXXX if a valid AIOP is found, where X</span>
<span class="cm">                 is replace by an identifying number.</span>
<span class="cm">          Flag AIOPID_NULL if no valid AIOP is found</span>
<span class="cm">Warnings: No context switches are allowed while executing this function.</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sReadAiopID</span><span class="p">(</span><span class="n">ByteIO_t</span> <span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Byte_t</span> <span class="n">AiopID</span><span class="p">;</span>		<span class="cm">/* ID byte from AIOP */</span>

	<span class="n">sOutB</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_CMD_REG</span><span class="p">,</span> <span class="n">RESET_ALL</span><span class="p">);</span>	<span class="cm">/* reset AIOP */</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_CMD_REG</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">AiopID</span> <span class="o">=</span> <span class="n">sInW</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_CHN_STAT0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AiopID</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* AIOP does not exist */</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sReadAiopNumChan</span>
<span class="cm">Purpose:  Read the number of channels available in an AIOP directly from</span>
<span class="cm">          an AIOP.</span>
<span class="cm">Call:     sReadAiopNumChan(io)</span>
<span class="cm">          WordIO_t io: AIOP base I/O address</span>
<span class="cm">Return:   int: The number of channels available</span>
<span class="cm">Comments: The number of channels is determined by write/reads from identical</span>
<span class="cm">          offsets within the SRAM address spaces for channels 0 and 4.</span>
<span class="cm">          If the channel 4 space is mirrored to channel 0 it is a 4 channel</span>
<span class="cm">          AIOP, otherwise it is an 8 channel.</span>
<span class="cm">Warnings: No context switches are allowed while executing this function.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sReadAiopNumChan</span><span class="p">(</span><span class="n">WordIO_t</span> <span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Word_t</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">R</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span> <span class="p">};</span>

	<span class="cm">/* write to chan 0 SRAM */</span>
	<span class="n">out32</span><span class="p">((</span><span class="n">DWordIO_t</span><span class="p">)</span> <span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* read from SRAM, chan 0 */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">sInW</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_DATA</span><span class="p">);</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>	<span class="cm">/* read from SRAM, chan 4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">sInW</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="n">_INDX_DATA</span><span class="p">))</span>	<span class="cm">/* if different must be 8 chan */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sInitChan</span>
<span class="cm">Purpose:  Initialization of a channel and channel structure</span>
<span class="cm">Call:     sInitChan(CtlP,ChP,AiopNum,ChanNum)</span>
<span class="cm">          CONTROLLER_T *CtlP; Ptr to controller structure</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">          int AiopNum; AIOP number within controller</span>
<span class="cm">          int ChanNum; Channel number within AIOP</span>
<span class="cm">Return:   int: 1 if initialization succeeded, 0 if it fails because channel</span>
<span class="cm">               number exceeds number of channels available in AIOP.</span>
<span class="cm">Comments: This function must be called before a channel can be used.</span>
<span class="cm">Warnings: No range checking on any of the parameters is done.</span>

<span class="cm">          No context switches are allowed while executing this function.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sInitChan</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">AiopNum</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">ChanNum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">WordIO_t</span> <span class="n">AiopIO</span><span class="p">;</span>
	<span class="n">WordIO_t</span> <span class="n">ChIOOff</span><span class="p">;</span>
	<span class="n">Byte_t</span> <span class="o">*</span><span class="n">ChR</span><span class="p">;</span>
	<span class="n">Word_t</span> <span class="n">ChOff</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">Byte_t</span> <span class="n">R</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">brd9600</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ChanNum</span> <span class="o">&gt;=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopNumChan</span><span class="p">[</span><span class="n">AiopNum</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* exceeds num chans in AIOP */</span>

	<span class="cm">/* Channel, AIOP, and controller identifiers */</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">CtlP</span> <span class="o">=</span> <span class="n">CtlP</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanID</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopID</span><span class="p">[</span><span class="n">AiopNum</span><span class="p">];</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">AiopNum</span> <span class="o">=</span> <span class="n">AiopNum</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span> <span class="o">=</span> <span class="n">ChanNum</span><span class="p">;</span>

	<span class="cm">/* Global direct addresses */</span>
	<span class="n">AiopIO</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="n">AiopNum</span><span class="p">];</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">_CMD_REG</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntChan</span> <span class="o">=</span> <span class="p">(</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">_INT_CHAN</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">_INT_MASK</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWordIO_t</span><span class="p">)</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">_INDX_ADDR</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span> <span class="o">=</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">_INDX_DATA</span><span class="p">;</span>

	<span class="cm">/* Channel direct addresses */</span>
	<span class="n">ChIOOff</span> <span class="o">=</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxRxData</span> <span class="o">=</span> <span class="n">ChIOOff</span> <span class="o">+</span> <span class="n">_TD0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanStat</span> <span class="o">=</span> <span class="n">ChIOOff</span> <span class="o">+</span> <span class="n">_CHN_STAT0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxRxCount</span> <span class="o">=</span> <span class="n">ChIOOff</span> <span class="o">+</span> <span class="n">_FIFO_CNT0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntID</span> <span class="o">=</span> <span class="p">(</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">AiopIO</span> <span class="o">+</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span> <span class="o">+</span> <span class="n">_INT_ID0</span><span class="p">;</span>

	<span class="cm">/* Initialize the channel from the RData array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RDATASIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RData</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">ChanNum</span><span class="p">;</span>
		<span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
		<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ChR</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RREGDATASIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ChR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RRegData</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ChR</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RRegData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">*</span> <span class="n">ChanNum</span><span class="p">;</span>
		<span class="n">ChR</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RRegData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">ChR</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">RRegData</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Indexed registers */</span>
	<span class="n">ChOff</span> <span class="o">=</span> <span class="p">(</span><span class="n">Word_t</span><span class="p">)</span> <span class="n">ChanNum</span> <span class="o">*</span><span class="mh">0x1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sClockPrescale</span> <span class="o">==</span> <span class="mh">0x14</span><span class="p">)</span>
		<span class="n">brd9600</span> <span class="o">=</span> <span class="mi">47</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">brd9600</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">BaudDiv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_BAUD</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">BaudDiv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_BAUD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">BaudDiv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">brd9600</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">BaudDiv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">brd9600</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">BaudDiv</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TX_CTRL</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TX_CTRL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_RX_CTRL</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_RX_CTRL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxEnables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TX_ENBLS</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxEnables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TX_ENBLS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxEnables</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxEnables</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxEnables</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxCompare</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXCMP1</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxCompare</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXCMP1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxCompare</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxCompare</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxCompare</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXREP1B1</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXREP1B1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace1</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">(</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXREP2</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="p">((</span><span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXREP2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxReplace2</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxFIFOPtrs</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXF_OUTP</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxFIFO</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TX_FIFO</span><span class="p">;</span>

	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">ChanNum</span> <span class="o">|</span> <span class="n">RESTXFCNT</span><span class="p">);</span>	<span class="cm">/* apply reset Tx FIFO count */</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">ChanNum</span><span class="p">);</span>	<span class="cm">/* remove reset Tx FIFO count */</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxFIFOPtrs</span><span class="p">);</span>	<span class="cm">/* clear Tx in/out ptrs */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFOPtrs</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_RXF_OUTP</span><span class="p">;</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFO</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_RX_FIFO</span><span class="p">;</span>

	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">ChanNum</span> <span class="o">|</span> <span class="n">RESRXFCNT</span><span class="p">);</span>	<span class="cm">/* apply reset Rx FIFO count */</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">ChanNum</span><span class="p">);</span>	<span class="cm">/* remove reset Rx FIFO count */</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFOPtrs</span><span class="p">);</span>	<span class="cm">/* clear Rx out ptr */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFOPtrs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* clear Rx in ptr */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioCnt</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXP_CNT</span><span class="p">;</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioCnt</span><span class="p">);</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioPtr</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXP_PNTR</span><span class="p">;</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioPtr</span><span class="p">);</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioBuf</span> <span class="o">=</span> <span class="n">ChOff</span> <span class="o">+</span> <span class="n">_TXP_BUF</span><span class="p">;</span>
	<span class="n">sEnRxProcessor</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* start the Rx processor */</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sStopRxProcessor</span>
<span class="cm">Purpose:  Stop the receive processor from processing a channel.</span>
<span class="cm">Call:     sStopRxProcessor(ChP)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>

<span class="cm">Comments: The receive processor can be started again with sStartRxProcessor().</span>
<span class="cm">          This function causes the receive processor to skip over the</span>
<span class="cm">          stopped channel.  It does not stop it from processing other channels.</span>

<span class="cm">Warnings: No context switches are allowed while executing this function.</span>

<span class="cm">          Do not leave the receive processor stopped for more than one</span>
<span class="cm">          character time.</span>

<span class="cm">          After calling this function a delay of 4 uS is required to ensure</span>
<span class="cm">          that the receive processor is no longer processing this channel.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sStopRxProcessor</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Byte_t</span> <span class="n">R</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
	<span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sFlushRxFIFO</span>
<span class="cm">Purpose:  Flush the Rx FIFO</span>
<span class="cm">Call:     sFlushRxFIFO(ChP)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">Return:   void</span>
<span class="cm">Comments: To prevent data from being enqueued or dequeued in the Tx FIFO</span>
<span class="cm">          while it is being flushed the receive processor is stopped</span>
<span class="cm">          and the transmitter is disabled.  After these operations a</span>
<span class="cm">          4 uS delay is done before clearing the pointers to allow</span>
<span class="cm">          the receive processor to stop.  These items are handled inside</span>
<span class="cm">          this function.</span>
<span class="cm">Warnings: No context switches are allowed while executing this function.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sFlushRxFIFO</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Byte_t</span> <span class="n">Ch</span><span class="p">;</span>		<span class="cm">/* channel number within AIOP */</span>
	<span class="kt">int</span> <span class="n">RxFIFOEnabled</span><span class="p">;</span>	<span class="cm">/* 1 if Rx FIFO enabled */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sGetRxCnt</span><span class="p">(</span><span class="n">ChP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Rx FIFO empty */</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* don&#39;t need to flush */</span>

	<span class="n">RxFIFOEnabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="mh">0x32</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Rx FIFO is enabled */</span>
		<span class="n">RxFIFOEnabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sDisRxFIFO</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* disable it */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span> <span class="o">/</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* delay 2 uS to allow proc to disable FIFO */</span>
			<span class="n">sInB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntChan</span><span class="p">);</span>	<span class="cm">/* depends on bus i/o timing */</span>
	<span class="p">}</span>
	<span class="n">sGetChanStatus</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* clear any pending Rx errors in chan stat */</span>
	<span class="n">Ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">sGetChanNum</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="n">Ch</span> <span class="o">|</span> <span class="n">RESRXFCNT</span><span class="p">);</span>	<span class="cm">/* apply reset Rx FIFO count */</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="n">Ch</span><span class="p">);</span>	<span class="cm">/* remove reset Rx FIFO count */</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFOPtrs</span><span class="p">);</span>	<span class="cm">/* clear Rx out ptr */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxFIFOPtrs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* clear Rx in ptr */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RxFIFOEnabled</span><span class="p">)</span>
		<span class="n">sEnRxFIFO</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* enable Rx FIFO */</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sFlushTxFIFO</span>
<span class="cm">Purpose:  Flush the Tx FIFO</span>
<span class="cm">Call:     sFlushTxFIFO(ChP)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">Return:   void</span>
<span class="cm">Comments: To prevent data from being enqueued or dequeued in the Tx FIFO</span>
<span class="cm">          while it is being flushed the receive processor is stopped</span>
<span class="cm">          and the transmitter is disabled.  After these operations a</span>
<span class="cm">          4 uS delay is done before clearing the pointers to allow</span>
<span class="cm">          the receive processor to stop.  These items are handled inside</span>
<span class="cm">          this function.</span>
<span class="cm">Warnings: No context switches are allowed while executing this function.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sFlushTxFIFO</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">Byte_t</span> <span class="n">Ch</span><span class="p">;</span>		<span class="cm">/* channel number within AIOP */</span>
	<span class="kt">int</span> <span class="n">TxEnabled</span><span class="p">;</span>		<span class="cm">/* 1 if transmitter enabled */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">ChP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Tx FIFO empty */</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* don&#39;t need to flush */</span>

	<span class="n">TxEnabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TX_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TxEnabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sDisTransmit</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* disable transmitter */</span>
	<span class="p">}</span>
	<span class="n">sStopRxProcessor</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* stop Rx processor */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4000</span> <span class="o">/</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* delay 4 uS to allow proc to stop */</span>
		<span class="n">sInB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntChan</span><span class="p">);</span>	<span class="cm">/* depends on bus i/o timing */</span>
	<span class="n">Ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">sGetChanNum</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="n">Ch</span> <span class="o">|</span> <span class="n">RESTXFCNT</span><span class="p">);</span>	<span class="cm">/* apply reset Tx FIFO count */</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">Cmd</span><span class="p">,</span> <span class="n">Ch</span><span class="p">);</span>	<span class="cm">/* remove reset Tx FIFO count */</span>
	<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxFIFOPtrs</span><span class="p">);</span>	<span class="cm">/* clear Tx in/out ptrs */</span>
	<span class="n">sOutW</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TxEnabled</span><span class="p">)</span>
		<span class="n">sEnTransmit</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* enable transmitter */</span>
	<span class="n">sStartRxProcessor</span><span class="p">(</span><span class="n">ChP</span><span class="p">);</span>	<span class="cm">/* restart Rx processor */</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sWriteTxPrioByte</span>
<span class="cm">Purpose:  Write a byte of priority transmit data to a channel</span>
<span class="cm">Call:     sWriteTxPrioByte(ChP,Data)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">          Byte_t Data; The transmit data byte</span>

<span class="cm">Return:   int: 1 if the bytes is successfully written, otherwise 0.</span>

<span class="cm">Comments: The priority byte is transmitted before any data in the Tx FIFO.</span>

<span class="cm">Warnings: No context switches are allowed while executing this function.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sWriteTxPrioByte</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">Data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Byte_t</span> <span class="n">DWBuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* buffer for double word writes */</span>
	<span class="n">Word_t</span> <span class="o">*</span><span class="n">WordPtr</span><span class="p">;</span>	<span class="cm">/* must be far because Win SS != DS */</span>
	<span class="k">register</span> <span class="n">DWordIO_t</span> <span class="n">IndexAddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sGetTxCnt</span><span class="p">(</span><span class="n">ChP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* write it to Tx priority buffer */</span>
		<span class="n">IndexAddr</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">;</span>
		<span class="n">sOutW</span><span class="p">((</span><span class="n">WordIO_t</span><span class="p">)</span> <span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioCnt</span><span class="p">);</span>	<span class="cm">/* get priority buffer status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sInB</span><span class="p">((</span><span class="n">ByteIO_t</span><span class="p">)</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRI_PEND</span><span class="p">)</span>	<span class="cm">/* priority buffer busy */</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* nothing sent */</span>

		<span class="n">WordPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Word_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">DWBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">WordPtr</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioBuf</span><span class="p">;</span>	<span class="cm">/* data byte address */</span>

		<span class="n">DWBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>	<span class="cm">/* data byte value */</span>
		<span class="n">out32</span><span class="p">(</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">DWBuf</span><span class="p">);</span>	<span class="cm">/* write it out */</span>

		<span class="o">*</span><span class="n">WordPtr</span> <span class="o">=</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxPrioCnt</span><span class="p">;</span>	<span class="cm">/* Tx priority count address */</span>

		<span class="n">DWBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRI_PEND</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* indicate 1 byte pending */</span>
		<span class="n">DWBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* priority buffer pointer */</span>
		<span class="n">out32</span><span class="p">(</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">DWBuf</span><span class="p">);</span>	<span class="cm">/* write it out */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* write it to Tx FIFO */</span>

		<span class="n">sWriteTxByte</span><span class="p">(</span><span class="n">sGetTxRxDataIO</span><span class="p">(</span><span class="n">ChP</span><span class="p">),</span> <span class="n">Data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* 1 byte sent */</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sEnInterrupts</span>
<span class="cm">Purpose:  Enable one or more interrupts for a channel</span>
<span class="cm">Call:     sEnInterrupts(ChP,Flags)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">          Word_t Flags: Interrupt enable flags, can be any combination</span>
<span class="cm">             of the following flags:</span>
<span class="cm">                TXINT_EN:   Interrupt on Tx FIFO empty</span>
<span class="cm">                RXINT_EN:   Interrupt on Rx FIFO at trigger level (see</span>
<span class="cm">                            sSetRxTrigger())</span>
<span class="cm">                SRCINT_EN:  Interrupt on SRC (Special Rx Condition)</span>
<span class="cm">                MCINT_EN:   Interrupt on modem input change</span>
<span class="cm">                CHANINT_EN: Allow channel interrupt signal to the AIOP&#39;s</span>
<span class="cm">                            Interrupt Channel Register.</span>
<span class="cm">Return:   void</span>
<span class="cm">Comments: If an interrupt enable flag is set in Flags, that interrupt will be</span>
<span class="cm">          enabled.  If an interrupt enable flag is not set in Flags, that</span>
<span class="cm">          interrupt will not be changed.  Interrupts can be disabled with</span>
<span class="cm">          function sDisInterrupts().</span>

<span class="cm">          This function sets the appropriate bit for the channel in the AIOP&#39;s</span>
<span class="cm">          Interrupt Mask Register if the CHANINT_EN flag is set.  This allows</span>
<span class="cm">          this channel&#39;s bit to be set in the AIOP&#39;s Interrupt Channel Register.</span>

<span class="cm">          Interrupts must also be globally enabled before channel interrupts</span>
<span class="cm">          will be passed on to the host.  This is done with function</span>
<span class="cm">          sEnGlobalInt().</span>

<span class="cm">          In some cases it may be desirable to disable interrupts globally but</span>
<span class="cm">          enable channel interrupts.  This would allow the global interrupt</span>
<span class="cm">          status register to be used to determine which AIOPs need service.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sEnInterrupts</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Word_t</span> <span class="n">Flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Byte_t</span> <span class="n">Mask</span><span class="p">;</span>		<span class="cm">/* Interrupt Mask Register */</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXINT_EN</span> <span class="o">|</span> <span class="n">SRCINT_EN</span> <span class="o">|</span> <span class="n">MCINT_EN</span><span class="p">));</span>

	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">);</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">TXINT_EN</span><span class="p">);</span>

	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">CHANINT_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Mask</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">)</span> <span class="o">|</span> <span class="n">sBitMapSetTbl</span><span class="p">[</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span><span class="p">];</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">Mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">Function: sDisInterrupts</span>
<span class="cm">Purpose:  Disable one or more interrupts for a channel</span>
<span class="cm">Call:     sDisInterrupts(ChP,Flags)</span>
<span class="cm">          CHANNEL_T *ChP; Ptr to channel structure</span>
<span class="cm">          Word_t Flags: Interrupt flags, can be any combination</span>
<span class="cm">             of the following flags:</span>
<span class="cm">                TXINT_EN:   Interrupt on Tx FIFO empty</span>
<span class="cm">                RXINT_EN:   Interrupt on Rx FIFO at trigger level (see</span>
<span class="cm">                            sSetRxTrigger())</span>
<span class="cm">                SRCINT_EN:  Interrupt on SRC (Special Rx Condition)</span>
<span class="cm">                MCINT_EN:   Interrupt on modem input change</span>
<span class="cm">                CHANINT_EN: Disable channel interrupt signal to the</span>
<span class="cm">                            AIOP&#39;s Interrupt Channel Register.</span>
<span class="cm">Return:   void</span>
<span class="cm">Comments: If an interrupt flag is set in Flags, that interrupt will be</span>
<span class="cm">          disabled.  If an interrupt flag is not set in Flags, that</span>
<span class="cm">          interrupt will not be changed.  Interrupts can be enabled with</span>
<span class="cm">          function sEnInterrupts().</span>

<span class="cm">          This function clears the appropriate bit for the channel in the AIOP&#39;s</span>
<span class="cm">          Interrupt Mask Register if the CHANINT_EN flag is set.  This blocks</span>
<span class="cm">          this channel&#39;s bit from being set in the AIOP&#39;s Interrupt Channel</span>
<span class="cm">          Register.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sDisInterrupts</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Word_t</span> <span class="n">Flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Byte_t</span> <span class="n">Mask</span><span class="p">;</span>		<span class="cm">/* Interrupt Mask Register */</span>

	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span>
	    <span class="o">~</span><span class="p">((</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXINT_EN</span> <span class="o">|</span> <span class="n">SRCINT_EN</span> <span class="o">|</span> <span class="n">MCINT_EN</span><span class="p">));</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">RxControl</span><span class="p">);</span>
	<span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">Byte_t</span><span class="p">)</span> <span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">TXINT_EN</span><span class="p">);</span>
	<span class="n">out32</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IndexAddr</span><span class="p">,</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">TxControl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">CHANINT_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Mask</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sBitMapClrTbl</span><span class="p">[</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span><span class="p">];</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">Mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sSetInterfaceMode</span><span class="p">(</span><span class="n">CHANNEL_T</span> <span class="o">*</span> <span class="n">ChP</span><span class="p">,</span> <span class="n">Byte_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">ChP</span><span class="o">-&gt;</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span> <span class="n">ChP</span><span class="o">-&gt;</span><span class="n">ChanNum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Not an official SSCI function, but how to reset RocketModems.</span>
<span class="cm"> *  ISA bus version</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sModemReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ByteIO_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">Byte_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg3IO</span><span class="p">);</span>
	<span class="cm">/* if AIOP[1] is not enabled, enable it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">sInB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2IO</span><span class="p">);</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MReg2IO</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">MBaseIO</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">sEnAiop</span><span class="p">(</span><span class="n">CtlP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* apply or remove reset */</span>
	<span class="n">sDisAiop</span><span class="p">(</span><span class="n">CtlP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Not an official SSCI function, but how to reset RocketModems.</span>
<span class="cm"> *  PCI bus version</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sPCIModemReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ByteIO_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* 2nd AIOP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sOutB</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">chan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* apply or remove reset */</span>
<span class="p">}</span>

<span class="cm">/*  Resets the speaker controller on RocketModem II and III devices */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rmSpeakerReset</span><span class="p">(</span><span class="n">CONTROLLER_T</span> <span class="o">*</span> <span class="n">CtlP</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">model</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ByteIO_t</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* RocketModem II speaker control is at the 8th port location of offset 0x40 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">model</span> <span class="o">==</span> <span class="n">MODEL_RP4M</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">MODEL_RP6M</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x4F</span><span class="p">;</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* RocketModem III speaker control is at the 1st port location of offset 0x80 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">model</span> <span class="o">==</span> <span class="n">MODEL_UPCI_RM3_8PORT</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">MODEL_UPCI_RM3_4PORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">CtlP</span><span class="o">-&gt;</span><span class="n">AiopIO</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x88</span><span class="p">;</span>
		<span class="n">sOutB</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*  Returns the line number given the controller (board), aiop and channel number */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">GetLineNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lineNumbers</span><span class="p">[(</span><span class="n">ctrl</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">ch</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Stores the line number associated with a given controller (board), aiop</span>
<span class="cm"> *  and channel number.  </span>
<span class="cm"> *  Returns:  The line number assigned </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">SetLineNumber</span><span class="p">(</span><span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aiop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lineNumbers</span><span class="p">[(</span><span class="n">ctrl</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aiop</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextLineNumber</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nextLineNumber</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
