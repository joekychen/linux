<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › vme › bridges › vme_tsi148.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vme_tsi148.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Support for the Tundra TSI148 VME-PCI Bridge Chip</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Martyn Welch &lt;martyn.welch@ge.com&gt;</span>
<span class="cm"> * Copyright 2008 GE Intelligent Platforms Embedded Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on work by Tom Armistead and Ajit Prem</span>
<span class="cm"> * Copyright 2004 Motorola Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/byteorder/generic.h&gt;</span>
<span class="cp">#include &lt;linux/vme.h&gt;</span>

<span class="cp">#include &quot;../vme_bridge.h&quot;</span>
<span class="cp">#include &quot;vme_tsi148.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">tsi148_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tsi148_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tsi148_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">tsi148_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>


<span class="cm">/* Module parameter */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">err_chk</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">geoid</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;vme_tsi148&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tsi148_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TUNDRA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TUNDRA_TSI148</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tsi148_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tsi148_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tsi148_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">tsi148_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reg_join</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">high</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">low</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">variable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">variable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">variable</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">low</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reg_split</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">variable</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">high</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">low</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">variable</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">variable</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wakes up DMA queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_DMA_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">channel_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">serviced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_DMA0S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTC_DMA0C</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_DMA1S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTC_DMA1C</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">serviced</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wake up location monitor queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_LM_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serviced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_LMS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* We only enable interrupts if the callback is set */</span>
			<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">lm_callback</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">i</span><span class="p">);</span>
			<span class="n">serviced</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTC_LMC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">serviced</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wake up mail box queue.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX This functionality is not exposed up though API.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_MB_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serviced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_MBS</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>	<span class="n">TSI148_GCSR_MBOX</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;VME Mailbox %d received&quot;</span>
				<span class="s">&quot;: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">serviced</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTC_MBC</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">serviced</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Display error &amp; status message when PERR (PCI) exception interrupt occurs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_PERR_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;PCI Exception at address: 0x%08x:%08x, &quot;</span>
		<span class="s">&quot;attributes: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPAU</span><span class="p">),</span>
		<span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPAL</span><span class="p">),</span>
		<span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPAT</span><span class="p">));</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;PCI-X attribute reg: %08x, PCI-X split &quot;</span>
		<span class="s">&quot;completion reg: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPXA</span><span class="p">),</span>
		<span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPXS</span><span class="p">));</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">TSI148_LCSR_EDPAT_EDPCL</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPAT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TSI148_LCSR_INTC_PERRC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Save address and status when VME error interrupt occurs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_VERR_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">error_addr_high</span><span class="p">,</span> <span class="n">error_addr_low</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">error_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_attrib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">error_addr_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VEAU</span><span class="p">);</span>
	<span class="n">error_addr_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VEAL</span><span class="p">);</span>
	<span class="n">error_attrib</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VEAT</span><span class="p">);</span>

	<span class="n">reg_join</span><span class="p">(</span><span class="n">error_addr_high</span><span class="p">,</span> <span class="n">error_addr_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_addr</span><span class="p">);</span>

	<span class="cm">/* Check for exception register overflow (we have lost error data) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_attrib</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VEAT_VEOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;VME Bus Exception Overflow &quot;</span>
			<span class="s">&quot;Occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bus_error</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">error_addr</span><span class="p">;</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">error_attrib</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">vme_errors</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Unable to alloc memory for &quot;</span>
			<span class="s">&quot;VMEbus Error reporting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;VME Bus Error at address: &quot;</span>
			<span class="s">&quot;0x%llx, attributes: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error_addr</span><span class="p">,</span> <span class="n">error_attrib</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear Status */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">TSI148_LCSR_VEAT_VESCL</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VEAT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TSI148_LCSR_INTC_VERRC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wake up IACK queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_IACK_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">iack_queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TSI148_LCSR_INTC_IACKC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calling VME bus interrupt callback if provided.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">tsi148_VIRQ_irqhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">serviced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note: Even though the registers are defined as</span>
<span class="cm">			 * 32-bits in the spec, we only want to issue 8-bit</span>
<span class="cm">			 * IACK cycles on the bus, read from offset 3.</span>
<span class="cm">			 */</span>
			<span class="n">vec</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VIACK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">vme_irq_handler</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>

			<span class="n">serviced</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">serviced</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Top level interrupt handler.  Clears appropriate interrupt status bits and</span>
<span class="cm"> * then calls appropriate sub handler(s).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tsi148_irqhandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">serviced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Determine which interrupts are unmasked and set */</span>
	<span class="n">enable</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTS</span><span class="p">);</span>

	<span class="cm">/* Only look at unmasked interrupts */</span>
	<span class="n">stat</span> <span class="o">&amp;=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* Call subhandlers as appropriate */</span>
	<span class="cm">/* DMA irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_INTS_DMA1S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_DMA0S</span><span class="p">))</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_DMA_irqhandler</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* Location monitor irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_INTS_LM3S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_LM2S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_LM1S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_LM0S</span><span class="p">))</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_LM_irqhandler</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* Mail box irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_INTS_MB3S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_MB2S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_MB1S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_MB0S</span><span class="p">))</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_MB_irqhandler</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* PCI bus error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_PERRS</span><span class="p">)</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_PERR_irqhandler</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>

	<span class="cm">/* VME bus error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_VERRS</span><span class="p">)</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_VERR_irqhandler</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>

	<span class="cm">/* IACK irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_INTS_IACKS</span><span class="p">)</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_IACK_irqhandler</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>

	<span class="cm">/* VME bus irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_INTS_IRQ7S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_IRQ6S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_IRQ5S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_IRQ4S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_IRQ3S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_IRQ2S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_IRQ1S</span><span class="p">))</span>
		<span class="n">serviced</span> <span class="o">|=</span> <span class="n">tsi148_VIRQ_irqhandler</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

	<span class="cm">/* Clear serviced interrupts */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">serviced</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_irq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Initialise list for VME bus errors */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">vme_errors</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">irq_mtx</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			     <span class="n">tsi148_irqhandler</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span><span class="p">,</span>
			     <span class="n">driver_name</span><span class="p">,</span> <span class="n">tsi148_bridge</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get assigned pci irq &quot;</span>
			<span class="s">&quot;vector %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable and unmask interrupts */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">TSI148_LCSR_INTEO_DMA1EO</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTEO_DMA0EO</span> <span class="o">|</span>
		<span class="n">TSI148_LCSR_INTEO_MB3EO</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTEO_MB2EO</span> <span class="o">|</span>
		<span class="n">TSI148_LCSR_INTEO_MB1EO</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTEO_MB0EO</span> <span class="o">|</span>
		<span class="n">TSI148_LCSR_INTEO_PERREO</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTEO_VERREO</span> <span class="o">|</span>
		<span class="n">TSI148_LCSR_INTEO_IACKEO</span><span class="p">;</span>

	<span class="cm">/* This leaves the following interrupts masked.</span>
<span class="cm">	 * TSI148_LCSR_INTEO_VIEEO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_SYSFLEO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_ACFLEO</span>
<span class="cm">	 */</span>

	<span class="cm">/* Don&#39;t enable Location Monitor interrupts here - they will be</span>
<span class="cm">	 * enabled when the location monitors are properly configured and</span>
<span class="cm">	 * a callback has been attached.</span>
<span class="cm">	 * TSI148_LCSR_INTEO_LM0EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_LM1EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_LM2EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_LM3EO</span>
<span class="cm">	 */</span>

	<span class="cm">/* Don&#39;t enable VME interrupts until we add a handler, else the board</span>
<span class="cm">	 * will respond to it and we don&#39;t want that unless it knows how to</span>
<span class="cm">	 * properly deal with it.</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ7EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ6EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ5EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ4EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ3EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ2EO</span>
<span class="cm">	 * TSI148_LCSR_INTEO_IRQ1EO</span>
<span class="cm">	 */</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_irq_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Turn off interrupts */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>

	<span class="cm">/* Clear all interrupts */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTC</span><span class="p">);</span>

	<span class="cm">/* Detach interrupt handler */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tsi148_bridge</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check to see if an IACk has been received, return true (1) or false (0).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_iack_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VICR_IRQS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure VME interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_irq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* We need to do the ordering differently for enabling and disabling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_INTEN_IRQEN</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_INTEO_IRQEO</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sync</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTEO_IRQEO</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTEN_IRQEN</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a VME bus interrupt at the requested level &amp; vector. Wait for</span>
<span class="cm"> * interrupt to be acked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_irq_generate</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">statid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">vme_int</span><span class="p">);</span>

	<span class="cm">/* Read VICR register */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">);</span>

	<span class="cm">/* Set Status/ID */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TSI148_LCSR_VICR_STID_M</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">statid</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VICR_STID_M</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">);</span>

	<span class="cm">/* Assert VMEbus IRQ */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">TSI148_LCSR_VICR_IRQL</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">);</span>

	<span class="cm">/* XXX Consider implementing a timeout? */</span>
	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">iack_queue</span><span class="p">,</span>
		<span class="n">tsi148_iack_received</span><span class="p">(</span><span class="n">bridge</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">vme_int</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the first error in this address range</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="nf">tsi148_find_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">err_pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="n">vme_err</span><span class="p">,</span> <span class="o">*</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bound</span><span class="p">;</span>

	<span class="n">bound</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX We are currently not looking at the address space when parsing</span>
<span class="cm">	 *     for errors. This is because parsing the Address Modifier Codes</span>
<span class="cm">	 *     is going to be quite resource intensive to do properly. We</span>
<span class="cm">	 *     should be OK just looking at the addresses and this is certainly</span>
<span class="cm">	 *     much better than what we had before.</span>
<span class="cm">	 */</span>
	<span class="n">err_pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Iterate through errors */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">err_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">vme_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vme_err</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">err_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_bus_error</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">address</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">valid</span> <span class="o">=</span> <span class="n">vme_err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear errors in the provided address range.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_clear_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">err_pos</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="n">vme_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bound</span><span class="p">;</span>

	<span class="n">bound</span> <span class="o">=</span> <span class="n">address</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX We are currently not looking at the address space when parsing</span>
<span class="cm">	 *     for errors. This is because parsing the Address Modifier Codes</span>
<span class="cm">	 *     is going to be quite resource intensive to do properly. We</span>
<span class="cm">	 *     should be OK just looking at the addresses and this is certainly</span>
<span class="cm">	 *     much better than what we had before.</span>
<span class="cm">	 */</span>
	<span class="n">err_pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Iterate through errors */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">err_pos</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">vme_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vme_err</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">err_pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_bus_error</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">address</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">list_del</span><span class="p">(</span><span class="n">err_pos</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vme_err</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a slave window with the requested attributes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_slave_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_slave_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="n">pci_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">granularity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_base_low</span><span class="p">,</span> <span class="n">vme_base_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_bound_low</span><span class="p">,</span> <span class="n">vme_bound_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_offset_low</span><span class="p">,</span> <span class="n">pci_offset_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_bound</span><span class="p">,</span> <span class="n">pci_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aspace</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_A16</span>:
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_AS_A16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A24</span>:
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_AS_A24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A32</span>:
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_AS_A32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A64</span>:
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_AS_A64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_CRCSR</span>:
	<span class="k">case</span> <span class="n">VME_USER1</span>:
	<span class="k">case</span> <span class="n">VME_USER2</span>:
	<span class="k">case</span> <span class="n">VME_USER3</span>:
	<span class="k">case</span> <span class="n">VME_USER4</span>:
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert 64-bit variables to 2x 32-bit variables */</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">vme_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_base_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_base_low</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bound address is a valid address for the window, adjust</span>
<span class="cm">	 * accordingly</span>
<span class="cm">	 */</span>
	<span class="n">vme_bound</span> <span class="o">=</span> <span class="n">vme_base</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">granularity</span><span class="p">;</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">vme_bound</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_bound_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_bound_low</span><span class="p">);</span>
	<span class="n">pci_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_base</span> <span class="o">-</span> <span class="n">vme_base</span><span class="p">;</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">pci_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_offset_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_offset_low</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vme_base_low</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid VME base alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vme_bound_low</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid VME bound alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_offset_low</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">granularity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid PCI Offset &quot;</span>
			<span class="s">&quot;alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Disable while we are mucking around */</span>
	<span class="n">temp_ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_ITAT_EN</span><span class="p">;</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>

	<span class="cm">/* Setup mapping */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_base_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITSAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_base_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITSAL</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_bound_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITEAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_bound_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITEAL</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_offset_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITOFU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_offset_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITOFL</span><span class="p">);</span>

	<span class="cm">/* Setup 2eSST speeds */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_ITAT_2eSSTM_M</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VME_2eSST160</span> <span class="o">|</span> <span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_2eSST160</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_160</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST267</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_267</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST320</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_320</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup cycle types */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1F</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_BLT</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_BLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_MBLT</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_MBLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eVME</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eVME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSST</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eSST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSSTB</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_2eSSTB</span><span class="p">;</span>

	<span class="cm">/* Setup address space */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_ITAT_AS_M</span><span class="p">;</span>
	<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SUPER</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_SUPR</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_USER</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_NPRIV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_PROG</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_PGM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_DATA</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_DATA</span><span class="p">;</span>

	<span class="cm">/* Write ctl reg without enable */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_ITAT_EN</span><span class="p">;</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get slave window configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_slave_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_slave_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">enabled</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">vme_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">pci_base</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">granularity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_base_low</span><span class="p">,</span> <span class="n">vme_base_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_bound_low</span><span class="p">,</span> <span class="n">vme_bound_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_offset_low</span><span class="p">,</span> <span class="n">pci_offset_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_bound</span><span class="p">,</span> <span class="n">pci_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Read registers */</span>
	<span class="n">ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>

	<span class="n">vme_base_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITSAU</span><span class="p">);</span>
	<span class="n">vme_base_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITSAL</span><span class="p">);</span>
	<span class="n">vme_bound_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITEAU</span><span class="p">);</span>
	<span class="n">vme_bound_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITEAL</span><span class="p">);</span>
	<span class="n">pci_offset_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITOFU</span><span class="p">);</span>
	<span class="n">pci_offset_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_ITOFL</span><span class="p">);</span>

	<span class="cm">/* Convert 64-bit variables to 2x 32-bit variables */</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">vme_base_high</span><span class="p">,</span> <span class="n">vme_base_low</span><span class="p">,</span> <span class="n">vme_base</span><span class="p">);</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">vme_bound_high</span><span class="p">,</span> <span class="n">vme_bound_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_bound</span><span class="p">);</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">pci_offset_high</span><span class="p">,</span> <span class="n">pci_offset_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_offset</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pci_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">vme_base</span> <span class="o">+</span> <span class="n">pci_offset</span><span class="p">;</span>

	<span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">aspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_EN</span><span class="p">)</span>
		<span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_AS_A16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_AS_A24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A24</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_AS_A32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_AS_A64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">granularity</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Need granularity before we set the size */</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)((</span><span class="n">vme_bound</span> <span class="o">-</span> <span class="o">*</span><span class="n">vme_base</span><span class="p">)</span> <span class="o">+</span> <span class="n">granularity</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_160</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST160</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_267</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST267</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_ITAT_2eSSTM_320</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST320</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_BLT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_BLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_MBLT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_MBLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eVME</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eVME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eSST</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_2eSSTB</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSSTB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_SUPR</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_SUPER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_NPRIV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_USER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_PGM</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_PROG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_ITAT_DATA</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_DATA</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate and map PCI Resource</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_alloc_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">existing_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">existing_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>

	<span class="cm">/* If the existing size is OK, return */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">existing_size</span> <span class="o">==</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">existing_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span><span class="p">);</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Exit here if size is zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">VMENAMSIZ</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Unable to allocate &quot;</span>
				<span class="s">&quot;memory for resource name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_name</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s.%d&quot;</span><span class="p">,</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">;</span>
	<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_bus_alloc_resource</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCIBIOS_MIN_MEM</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Failed to allocate mem &quot;</span>
			<span class="s">&quot;resource for window %d size 0x%lx start 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span>
		<span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Failed to remap resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_remap:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">);</span>
<span class="nl">err_resource:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
<span class="nl">err_name:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free and unmap PCI Resource</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_free_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span><span class="p">);</span>
	<span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the attributes of an outbound window.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_master_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_base_low</span><span class="p">,</span> <span class="n">pci_base_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_bound_low</span><span class="p">,</span> <span class="n">pci_bound_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_offset_low</span><span class="p">,</span> <span class="n">vme_offset_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pci_bound</span><span class="p">,</span> <span class="n">vme_offset</span><span class="p">,</span> <span class="n">pci_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Verify input data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vme_base</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid VME Window &quot;</span>
			<span class="s">&quot;alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_window</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Size must be non-zero for &quot;</span>
			<span class="s">&quot;enabled windows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_window</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Let&#39;s allocate the resource here rather than further up the stack as</span>
<span class="cm">	 * it avoids pushing loads of bus dependent stuff up the stack. If size</span>
<span class="cm">	 * is zero, any existing resource will be freed.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">tsi148_alloc_resource</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory for &quot;</span>
			<span class="s">&quot;resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci_bound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vme_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Bound address is a valid address for the window, adjust</span>
<span class="cm">		 * according to window granularity.</span>
<span class="cm">		 */</span>
		<span class="n">pci_bound</span> <span class="o">=</span> <span class="n">pci_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="n">vme_offset</span> <span class="o">=</span> <span class="n">vme_base</span> <span class="o">-</span> <span class="n">pci_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert 64-bit variables to 2x 32-bit variables */</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">pci_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_base_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_base_low</span><span class="p">);</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">pci_bound</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bound_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bound_low</span><span class="p">);</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">vme_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_offset_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_offset_low</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_base_low</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid PCI base alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_gran</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_bound_low</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid PCI bound alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_gran</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vme_offset_low</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid VME Offset &quot;</span>
			<span class="s">&quot;alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_gran</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Disable while we are mucking around */</span>
	<span class="n">temp_ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_EN</span><span class="p">;</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>

	<span class="cm">/* Setup 2eSST speeds */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_2eSSTM_M</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VME_2eSST160</span> <span class="o">|</span> <span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_2eSST160</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_160</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST267</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_267</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST320</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_320</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup cycle types */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_BLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">;</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_TM_BLT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_MBLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">;</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_TM_MBLT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eVME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">;</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_TM_2eVME</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">;</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_TM_2eSST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSSTB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Currently not setting &quot;</span>
			<span class="s">&quot;Broadcast Select Registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">;</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_TM_2eSSTB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup data width */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_DBW_M</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_D16</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_DBW_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_D32</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_DBW_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid data width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dwidth</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup address space */</span>
	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">aspace</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_A16</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A24</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A32</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A64</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_CRCSR</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_CRCSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER1</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER2</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER3</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER4</span>:
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_aspace</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SUPER</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_SUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_PROG</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_PGM</span><span class="p">;</span>

	<span class="cm">/* Setup mapping */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_base_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_base_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAL</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_bound_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTEAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_bound_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTEAL</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_offset_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTOFU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">vme_offset_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTOFL</span><span class="p">);</span>

	<span class="cm">/* Write ctl reg without enable */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">temp_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_OTAT_EN</span><span class="p">;</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">temp_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_aspace:</span>
<span class="nl">err_dwidth:</span>
<span class="nl">err_gran:</span>
	<span class="n">tsi148_free_resource</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<span class="nl">err_res:</span>
<span class="nl">err_window:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the attributes of an outbound window.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX Not parsing prefetch information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__tsi148_master_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">enabled</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">vme_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">aspace</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cycle</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_base_low</span><span class="p">,</span> <span class="n">pci_base_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_bound_low</span><span class="p">,</span> <span class="n">pci_bound_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vme_offset_low</span><span class="p">,</span> <span class="n">vme_offset_high</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pci_base</span><span class="p">,</span> <span class="n">pci_bound</span><span class="p">,</span> <span class="n">vme_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>

	<span class="n">pci_base_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAU</span><span class="p">);</span>
	<span class="n">pci_base_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAL</span><span class="p">);</span>
	<span class="n">pci_bound_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTEAU</span><span class="p">);</span>
	<span class="n">pci_bound_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTEAL</span><span class="p">);</span>
	<span class="n">vme_offset_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTOFU</span><span class="p">);</span>
	<span class="n">vme_offset_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTOFL</span><span class="p">);</span>

	<span class="cm">/* Convert 64-bit variables to 2x 32-bit variables */</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">pci_base_high</span><span class="p">,</span> <span class="n">pci_base_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_base</span><span class="p">);</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">pci_bound_high</span><span class="p">,</span> <span class="n">pci_bound_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bound</span><span class="p">);</span>
	<span class="n">reg_join</span><span class="p">(</span><span class="n">vme_offset_high</span><span class="p">,</span> <span class="n">vme_offset_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_offset</span><span class="p">);</span>

	<span class="o">*</span><span class="n">vme_base</span> <span class="o">=</span> <span class="n">pci_base</span> <span class="o">+</span> <span class="n">vme_offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pci_bound</span> <span class="o">-</span> <span class="n">pci_base</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">aspace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_EN</span><span class="p">)</span>
		<span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Setup address space */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A16</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A24</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A32</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_A64</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_CRCSR</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_CRCSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_USER1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_USER2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER3</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_USER3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_AMODE_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_AMODE_USER4</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_USER4</span><span class="p">;</span>

	<span class="cm">/* Setup 2eSST speeds */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_160</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST160</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_267</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST267</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_2eSSTM_320</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST320</span><span class="p">;</span>

	<span class="cm">/* Setup cycle types */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_SCT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_SCT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_BLT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_BLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_MBLT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_MBLT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_2eVME</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eVME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_2eSST</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_TM_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_TM_2eSSTB</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_2eSSTB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_SUP</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_SUPER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_USER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_PGM</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_PROG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_DATA</span><span class="p">;</span>

	<span class="cm">/* Setup data width */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_DBW_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_DBW_16</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dwidth</span> <span class="o">=</span> <span class="n">VME_D16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_OTAT_DBW_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_OTAT_DBW_32</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dwidth</span> <span class="o">=</span> <span class="n">VME_D32</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_master_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">enabled</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">vme_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">aspace</span><span class="p">,</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cycle</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__tsi148_master_get</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">vme_base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">aspace</span><span class="p">,</span>
		<span class="n">cycle</span><span class="p">,</span> <span class="n">dwidth</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tsi148_master_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_base</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">dwidth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="n">vme_err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_chk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_chk</span><span class="p">;</span>

	<span class="n">__tsi148_master_get</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aspace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dwidth</span><span class="p">);</span>

	<span class="n">vme_err</span> <span class="o">=</span> <span class="n">tsi148_find_error</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		<span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vme_err</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;First VME read error detected &quot;</span>
			<span class="s">&quot;an at address 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">-</span> <span class="p">(</span><span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="cm">/* Clear down save errors in this address range */</span>
		<span class="n">tsi148_clear_errors</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			<span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">skip_chk:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tsi148_master_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">vme_base</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">dwidth</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vme_bus_error</span> <span class="o">*</span><span class="n">vme_err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Writes are posted. We need to do a read on the VME bus to flush out</span>
<span class="cm">	 * all of the writes before we check for errors. We can&#39;t guarantee</span>
<span class="cm">	 * that reading the data we have just written is safe. It is believed</span>
<span class="cm">	 * that there isn&#39;t any read, write re-ordering, so we can read any</span>
<span class="cm">	 * location in VME space, so lets read the Device ID from the tsi148&#39;s</span>
<span class="cm">	 * own registers as mapped into CR/CSR space.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We check for saved errors in the written address range/space.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_chk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip_chk</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get window info first, to maximise the time that the buffers may</span>
<span class="cm">	 * fluch on their own</span>
<span class="cm">	 */</span>
	<span class="n">__tsi148_master_get</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vme_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aspace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dwidth</span><span class="p">);</span>

	<span class="n">ioread16</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">+</span> <span class="mh">0x7F000</span><span class="p">);</span>

	<span class="n">vme_err</span> <span class="o">=</span> <span class="n">tsi148_find_error</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		<span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vme_err</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;First VME write error detected&quot;</span>
			<span class="s">&quot; an at address 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">vme_err</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">-</span> <span class="p">(</span><span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="cm">/* Clear down save errors in this address range */</span>
		<span class="n">tsi148_clear_errors</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">vme_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			<span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">skip_chk:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform an RMW cycle on the VME bus.</span>
<span class="cm"> *</span>
<span class="cm"> * Requires a previously configured master window, returns final value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tsi148_master_rmw</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">compare</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">swap</span><span class="p">,</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pci_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_addr_high</span><span class="p">,</span> <span class="n">pci_addr_low</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Find the PCI address that maps to the desired VME address */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Locking as we can only do one of these at a time */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">vme_rmw</span><span class="p">);</span>

	<span class="cm">/* Lock image */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pci_addr_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAU</span><span class="p">);</span>
	<span class="n">pci_addr_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_OTSAL</span><span class="p">);</span>

	<span class="n">reg_join</span><span class="p">(</span><span class="n">pci_addr_high</span><span class="p">,</span> <span class="n">pci_addr_low</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">reg_split</span><span class="p">(</span><span class="n">pci_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr_low</span><span class="p">);</span>

	<span class="cm">/* Configure registers */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_RMWEN</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">compare</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_RMWC</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">swap</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_RMWS</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_addr_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_RMWAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">pci_addr_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_RMWAL</span><span class="p">);</span>

	<span class="cm">/* Enable RMW */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VMCTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_VMCTRL_RMWEN</span><span class="p">;</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VMCTRL</span><span class="p">);</span>

	<span class="cm">/* Kick process off with a read to the required address. */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">kern_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* Disable RMW */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VMCTRL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_VMCTRL_RMWEN</span><span class="p">;</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VMCTRL</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">vme_rmw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_set_vme_src_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">);</span>

	<span class="cm">/* Setup 2eSST speeds */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VME_2eSST160</span> <span class="o">|</span> <span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_2eSST160</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_2eSSTM_160</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST267</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_2eSSTM_267</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST320</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_2eSSTM_320</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup cycle types */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SCT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_SCT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_BLT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_BLT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_MBLT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_MBLT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eVME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_2eVME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_2eSST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSSTB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Currently not setting Broadcast Select &quot;</span>
			<span class="s">&quot;Registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_TM_2eSSTB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup data width */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_D16</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_DBW_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_D32</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_DBW_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid data width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup address space */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">aspace</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_A16</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_A16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A24</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_A24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A32</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_A32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A64</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_A64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_CRCSR</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_CRCSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER1</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_USER1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER2</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_USER2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER3</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_USER3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER4</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_AMODE_USER4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SUPER</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_SUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_PROG</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_PGM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_set_vme_dest_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dwidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">attr</span><span class="p">);</span>

	<span class="cm">/* Setup 2eSST speeds */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VME_2eSST160</span> <span class="o">|</span> <span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_2eSST160</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_2eSSTM_160</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST267</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_2eSSTM_267</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_2eSST320</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_2eSSTM_320</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup cycle types */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SCT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_SCT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_BLT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_BLT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_MBLT</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_MBLT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eVME</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_2eVME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSST</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_2eSST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_2eSSTB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Currently not setting Broadcast Select &quot;</span>
			<span class="s">&quot;Registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_TM_2eSSTB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup data width */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dwidth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_D16</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_DBW_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_D32</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_DBW_32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid data width</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup address space */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">aspace</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_A16</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_A16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A24</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_A24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A32</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_A32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A64</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_A64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_CRCSR</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_CRCSR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER1</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_USER1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER2</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_USER2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER3</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_USER3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_USER4</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_AMODE_USER4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SUPER</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_SUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_PROG</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DDAT_PGM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a link list descriptor to the list</span>
<span class="cm"> *</span>
<span class="cm"> * Note: DMA engine expects the DMA descriptor to be big endian.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_list_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_dma_list</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">vme_dma_attr</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_dma_attr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsi148_dma_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address_high</span><span class="p">,</span> <span class="n">address_low</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_dma_pattern</span> <span class="o">*</span><span class="n">pattern_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_dma_pci</span> <span class="o">*</span><span class="n">pci_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_dma_vme</span> <span class="o">*</span><span class="n">vme_attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* Descriptor must be aligned on 64-bit boundaries */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_dma_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;dma resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Test descriptor alignment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Descriptor not aligned to 8 &quot;</span>
			<span class="s">&quot;byte boundary as required: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_align</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Given we are going to fill out the structure, we probably don&#39;t</span>
<span class="cm">	 * need to zero it, but better safe than sorry for now.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_dma_descriptor</span><span class="p">));</span>

	<span class="cm">/* Fill out source part */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_DMA_PATTERN</span>:
		<span class="n">pattern_attr</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">pattern_attr</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">TSI148_LCSR_DSAT_TYP_PAT</span><span class="p">;</span>

		<span class="cm">/* Default behaviour is 32 bit pattern */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pattern_attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">VME_DMA_PATTERN_BYTE</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_PSZ</span><span class="p">;</span>

		<span class="cm">/* It seems that the default behaviour is to increment */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pattern_attr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">VME_DMA_PATTERN_INCREMENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_DSAT_NIN</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_DMA_PCI</span>:
		<span class="n">pci_attr</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">reg_split</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_high</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_high</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">TSI148_LCSR_DSAT_TYP_PCI</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_DMA_VME</span>:
		<span class="n">vme_attr</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">reg_split</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_high</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_high</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">TSI148_LCSR_DSAT_TYP_VME</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">tsi148_dma_set_vme_src_attributes</span><span class="p">(</span>
			<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dsat</span><span class="p">,</span>
			<span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">aspace</span><span class="p">,</span> <span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">,</span> <span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">dwidth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_source</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid source type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_source</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assume last link - this will be over-written by adding another */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dnlau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dnlal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">TSI148_LCSR_DNLAL_LLA</span><span class="p">);</span>

	<span class="cm">/* Fill out destination part */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_DMA_PCI</span>:
		<span class="n">pci_attr</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">reg_split</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_high</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_high</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">TSI148_LCSR_DDAT_TYP_PCI</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_DMA_VME</span>:
		<span class="n">vme_attr</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

		<span class="n">reg_split</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_high</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_high</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddat</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">TSI148_LCSR_DDAT_TYP_VME</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">tsi148_dma_set_vme_dest_attributes</span><span class="p">(</span>
			<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ddat</span><span class="p">,</span>
			<span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">aspace</span><span class="p">,</span> <span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">,</span> <span class="n">vme_attr</span><span class="o">-&gt;</span><span class="n">dwidth</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_dest</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid destination type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dest</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill out count */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dcnt</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/* Add to list */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>

	<span class="cm">/* Fill out previous descriptors &quot;Next Address&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi148_dma_entry</span><span class="p">,</span>
			<span class="n">list</span><span class="p">);</span>
		<span class="cm">/* We need the bus address for the pointer */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_dma_descriptor</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">reg_split</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_high</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">address_low</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dnlau</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_high</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">dnlal</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">address_low</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_dest:</span>
<span class="nl">err_source:</span>
<span class="nl">err_align:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="nl">err_mem:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check to see if the provided DMA channel is busy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_DSTA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_DSTA_BSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Execute a previously generated link list</span>
<span class="cm"> *</span>
<span class="cm"> * XXX Need to provide control register configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_list_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_dma_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vme_dma_resource</span> <span class="o">*</span><span class="n">ctrlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_dma_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_addr_high</span><span class="p">,</span> <span class="n">bus_addr_low</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">dctlreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">ctrlr</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX We have an active DMA transfer and currently haven&#39;t</span>
<span class="cm">		 *     sorted out the mechanism for &quot;pending&quot; DMA transfers.</span>
<span class="cm">		 *     Return busy.</span>
<span class="cm">		 */</span>
		<span class="cm">/* Need to add to pending here */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get first bus address and write into registers */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi148_dma_entry</span><span class="p">,</span>
		<span class="n">list</span><span class="p">);</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_dma_descriptor</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">reg_split</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_addr_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_addr_low</span><span class="p">);</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">bus_addr_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OFFSET_DNLAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">bus_addr_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OFFSET_DNLAL</span><span class="p">);</span>

	<span class="n">dctlreg</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_DCTL</span><span class="p">);</span>

	<span class="cm">/* Start the operation */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">dctlreg</span> <span class="o">|</span> <span class="n">TSI148_LCSR_DCTL_DGO</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OFFSET_DCTL</span><span class="p">);</span>

	<span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span>
		<span class="n">tsi148_dma_busy</span><span class="p">(</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">channel</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read status register, this register is valid until we kick off a</span>
<span class="cm">	 * new transfer.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_DMA</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">TSI148_LCSR_OFFSET_DSTA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_DSTA_VBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;DMA Error. DSTA=%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remove list from running list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clean up a previously generated link list</span>
<span class="cm"> *</span>
<span class="cm"> * We have a separate function, don&#39;t assume that the chain can&#39;t be reused.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_dma_list_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_dma_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_dma_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* detach and free each entry */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tsi148_dma_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_dma_descriptor</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * All 4 location monitors reside at the same base - this is therefore a</span>
<span class="cm"> * system wide configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * This does not enable the LM monitor - that should be done when the first</span>
<span class="cm"> * callback is attached and disabled when the last callback is removed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_lm_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_lm_resource</span> <span class="o">*</span><span class="n">lm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">lm_base</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lm_base_high</span><span class="p">,</span> <span class="n">lm_base_low</span><span class="p">,</span> <span class="n">lm_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">lm</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="cm">/* If we already have a callback attached, we can&#39;t move it! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lm</span><span class="o">-&gt;</span><span class="n">monitors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">lm_callback</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Location monitor &quot;</span>
				<span class="s">&quot;callback attached, can&#39;t reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aspace</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VME_A16</span>:
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_AS_A16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A24</span>:
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_AS_A24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A32</span>:
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_AS_A32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VME_A64</span>:
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_AS_A64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Invalid address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_SUPER</span><span class="p">)</span>
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_SUPR</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_USER</span><span class="p">)</span>
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_NPRIV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_PROG</span><span class="p">)</span>
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_PGM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">&amp;</span> <span class="n">VME_DATA</span><span class="p">)</span>
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_DATA</span><span class="p">;</span>

	<span class="n">reg_split</span><span class="p">(</span><span class="n">lm_base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm_base_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lm_base_low</span><span class="p">);</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">lm_base_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMBAU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">lm_base_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMBAL</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">lm_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get configuration of the callback monitor and return whether it is enabled</span>
<span class="cm"> * or disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_lm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_lm_resource</span> <span class="o">*</span><span class="n">lm</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lm_base</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">aspace</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lm_base_high</span><span class="p">,</span> <span class="n">lm_base_low</span><span class="p">,</span> <span class="n">lm_ctl</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">lm</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">lm_base_high</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMBAU</span><span class="p">);</span>
	<span class="n">lm_base_low</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMBAL</span><span class="p">);</span>
	<span class="n">lm_ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>

	<span class="n">reg_join</span><span class="p">(</span><span class="n">lm_base_high</span><span class="p">,</span> <span class="n">lm_base_low</span><span class="p">,</span> <span class="n">lm_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_EN</span><span class="p">)</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_LMAT_AS_A16</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_LMAT_AS_A24</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_LMAT_AS_A32</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_AS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">TSI148_LCSR_LMAT_AS_A64</span><span class="p">)</span>
		<span class="o">*</span><span class="n">aspace</span> <span class="o">|=</span> <span class="n">VME_A64</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_SUPR</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_SUPER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_NPRIV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_USER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_PGM</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_PROG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_DATA</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cycle</span> <span class="o">|=</span> <span class="n">VME_DATA</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attach a callback to a specific location monitor.</span>
<span class="cm"> *</span>
<span class="cm"> * Callback will be passed the monitor triggered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_lm_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_lm_resource</span> <span class="o">*</span><span class="n">lm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">monitor</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lm_ctl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">lm</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="cm">/* Ensure that the location monitor is configured - need PGM or DATA */</span>
	<span class="n">lm_ctl</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_LMAT_PGM</span> <span class="o">|</span> <span class="n">TSI148_LCSR_LMAT_DATA</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Location monitor not properly &quot;</span>
			<span class="s">&quot;configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that a callback isn&#39;t already attached */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">lm_callback</span><span class="p">[</span><span class="n">monitor</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Existing callback attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Attach callback */</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">lm_callback</span><span class="p">[</span><span class="n">monitor</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>

	<span class="cm">/* Enable Location Monitor interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTEN_LMEN</span><span class="p">[</span><span class="n">monitor</span><span class="p">];</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_INTEO_LMEO</span><span class="p">[</span><span class="n">monitor</span><span class="p">];</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>

	<span class="cm">/* Ensure that global Location Monitor Enable set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lm_ctl</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_LMAT_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lm_ctl</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_LMAT_EN</span><span class="p">;</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">lm_ctl</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Detach a callback function forn a specific location monitor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_lm_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_lm_resource</span> <span class="o">*</span><span class="n">lm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">monitor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lm_en</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">lm</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="cm">/* Disable Location Monitor and ensure previous interrupts are clear */</span>
	<span class="n">lm_en</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>
	<span class="n">lm_en</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_INTEN_LMEN</span><span class="p">[</span><span class="n">monitor</span><span class="p">];</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">lm_en</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEN</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_INTEO_LMEO</span><span class="p">[</span><span class="n">monitor</span><span class="p">];</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTEO</span><span class="p">);</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">TSI148_LCSR_INTC_LMC</span><span class="p">[</span><span class="n">monitor</span><span class="p">],</span>
		 <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTC</span><span class="p">);</span>

	<span class="cm">/* Detach callback */</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">lm_callback</span><span class="p">[</span><span class="n">monitor</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If all location monitors disabled, disable global Location Monitor */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lm_en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TSI148_LCSR_INTS_LM0S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_LM1S</span> <span class="o">|</span>
			<span class="n">TSI148_LCSR_INTS_LM2S</span> <span class="o">|</span> <span class="n">TSI148_LCSR_INTS_LM3S</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_LMAT_EN</span><span class="p">;</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Determine Geographical Addressing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_slot_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">geoid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VSTAT</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VSTAT_GA_M</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">geoid</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">tsi148_alloc_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Find pci_dev container of dev */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_free_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Find pci_dev container of dev */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tsi148_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure CR/CSR space</span>
<span class="cm"> *</span>
<span class="cm"> * Access to the CR/CSR can be configured at power-up. The location of the</span>
<span class="cm"> * CR/CSR registers in the CR/CSR address space is determined by the boards</span>
<span class="cm"> * Auto-ID or Geographic address. This function ensures that the window is</span>
<span class="cm"> * enabled at an offset consistent with the boards geopgraphic address.</span>
<span class="cm"> *</span>
<span class="cm"> * Each board has a 512kB window, with the highest 4kB being used for the</span>
<span class="cm"> * boards registers, this means there is a fix length 508kB window which must</span>
<span class="cm"> * be mapped onto PCI memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_crcsr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cbar</span><span class="p">,</span> <span class="n">crat</span><span class="p">,</span> <span class="n">vstat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crcsr_bus_high</span><span class="p">,</span> <span class="n">crcsr_bus_low</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Allocate mem for CR/CSR image */</span>
	<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_kernel</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VME_CRCSR_BUF_SIZE</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_kernel</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;CR/CSR image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VME_CRCSR_BUF_SIZE</span><span class="p">);</span>

	<span class="n">reg_split</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crcsr_bus_high</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crcsr_bus_low</span><span class="p">);</span>

	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">crcsr_bus_high</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CROU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">crcsr_bus_low</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CROL</span><span class="p">);</span>

	<span class="cm">/* Ensure that the CR/CSR is configured at the correct offset */</span>
	<span class="n">cbar</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_CBAR</span><span class="p">);</span>
	<span class="n">cbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">cbar</span> <span class="o">&amp;</span> <span class="n">TSI148_CRCSR_CBAR_M</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">;</span>

	<span class="n">vstat</span> <span class="o">=</span> <span class="n">tsi148_slot_get</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cbar</span> <span class="o">!=</span> <span class="n">vstat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cbar</span> <span class="o">=</span> <span class="n">vstat</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Setting CR/CSR offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">cbar</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_CBAR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;CR/CSR Offset: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="p">);</span>

	<span class="n">crat</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CRAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crat</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_CRAT_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Enabling CR/CSR space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="n">crat</span> <span class="o">|</span> <span class="n">TSI148_LCSR_CRAT_EN</span><span class="p">,</span>
			<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CRAT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;CR/CSR already enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If we want flushed, error-checked writes, set up a window</span>
<span class="cm">	 * over the CR/CSR registers. We read from here to safely flush</span>
<span class="cm">	 * through VME writes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_chk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tsi148_master_set</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">vstat</span> <span class="o">*</span> <span class="mh">0x80000</span><span class="p">),</span> <span class="mh">0x80000</span><span class="p">,</span> <span class="n">VME_CRCSR</span><span class="p">,</span> <span class="n">VME_SCT</span><span class="p">,</span>
			<span class="n">VME_D16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Configuring flush image&quot;</span>
				<span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_crcsr_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Turn off CR/CSR space */</span>
	<span class="n">crat</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CRAT</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">crat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TSI148_LCSR_CRAT_EN</span><span class="p">,</span>
		<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CRAT</span><span class="p">);</span>

	<span class="cm">/* Free image */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CROU</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CROL</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VME_CRCSR_BUF_SIZE</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_kernel</span><span class="p">,</span>
		<span class="n">bridge</span><span class="o">-&gt;</span><span class="n">crcsr_bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tsi148_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">master_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">tsi148_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">master_image</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_slave_resource</span> <span class="o">*</span><span class="n">slave_image</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_dma_resource</span> <span class="o">*</span><span class="n">dma_ctrlr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_lm_resource</span> <span class="o">*</span><span class="n">lm</span><span class="p">;</span>

	<span class="cm">/* If we want to support more than one of each bridge, we need to</span>
<span class="cm">	 * dynamically generate this so we get one per device</span>
<span class="cm">	 */</span>
	<span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_bridge</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsi148_bridge</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for device &quot;</span>
			<span class="s">&quot;structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_struct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsi148_device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tsi148_driver</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsi148_device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for device &quot;</span>
			<span class="s">&quot;structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">tsi148_device</span><span class="p">;</span>

	<span class="cm">/* Enable the device */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Map Registers */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to reserve resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* map registers in BAR 0 */</span>
	<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to remap CRG region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_remap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check to see if the mapping worked out */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_PCFS_ID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_TUNDRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CRG region check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_test</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize wait queues &amp; mutual exclusion flags */</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">dma_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">iack_queue</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">vme_int</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">vme_rmw</span><span class="p">);</span>

	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>

	<span class="cm">/* Setup IRQ */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">tsi148_irq_init</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip Initialization failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we are going to flush writes, we need to read from the VME bus.</span>
<span class="cm">	 * We need to do this safely, thus we read the devices own CR/CSR</span>
<span class="cm">	 * register. To do this we must set up a window in CR/CSR space and</span>
<span class="cm">	 * hence have one less master window resource available.</span>
<span class="cm">	 */</span>
	<span class="n">master_num</span> <span class="o">=</span> <span class="n">TSI148_MAX_MASTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_chk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_num</span><span class="o">--</span><span class="p">;</span>

		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;flush resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_master</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">master_num</span><span class="p">;</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">address_attr</span> <span class="o">=</span> <span class="n">VME_A16</span> <span class="o">|</span> <span class="n">VME_A24</span> <span class="o">|</span>
			<span class="n">VME_A32</span> <span class="o">|</span> <span class="n">VME_A64</span><span class="p">;</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">cycle_attr</span> <span class="o">=</span> <span class="n">VME_SCT</span> <span class="o">|</span> <span class="n">VME_BLT</span> <span class="o">|</span>
			<span class="n">VME_MBLT</span> <span class="o">|</span> <span class="n">VME_2eVME</span> <span class="o">|</span> <span class="n">VME_2eSST</span> <span class="o">|</span> <span class="n">VME_2eSSTB</span> <span class="o">|</span>
			<span class="n">VME_2eSST160</span> <span class="o">|</span> <span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span> <span class="o">|</span> <span class="n">VME_SUPER</span> <span class="o">|</span>
			<span class="n">VME_USER</span> <span class="o">|</span> <span class="n">VME_PROG</span> <span class="o">|</span> <span class="n">VME_DATA</span><span class="p">;</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">width_attr</span> <span class="o">=</span> <span class="n">VME_D16</span> <span class="o">|</span> <span class="n">VME_D32</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
		<span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">flush_image</span><span class="o">-&gt;</span><span class="n">kern_base</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add master windows to list */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_resources</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_image</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_master_resource</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master_image</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;master resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_master</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master_image</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">address_attr</span> <span class="o">=</span> <span class="n">VME_A16</span> <span class="o">|</span> <span class="n">VME_A24</span> <span class="o">|</span> <span class="n">VME_A32</span> <span class="o">|</span>
			<span class="n">VME_A64</span><span class="p">;</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">cycle_attr</span> <span class="o">=</span> <span class="n">VME_SCT</span> <span class="o">|</span> <span class="n">VME_BLT</span> <span class="o">|</span> <span class="n">VME_MBLT</span> <span class="o">|</span>
			<span class="n">VME_2eVME</span> <span class="o">|</span> <span class="n">VME_2eSST</span> <span class="o">|</span> <span class="n">VME_2eSSTB</span> <span class="o">|</span> <span class="n">VME_2eSST160</span> <span class="o">|</span>
			<span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span> <span class="o">|</span> <span class="n">VME_SUPER</span> <span class="o">|</span> <span class="n">VME_USER</span> <span class="o">|</span>
			<span class="n">VME_PROG</span> <span class="o">|</span> <span class="n">VME_DATA</span><span class="p">;</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">width_attr</span> <span class="o">=</span> <span class="n">VME_D16</span> <span class="o">|</span> <span class="n">VME_D32</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master_image</span><span class="o">-&gt;</span><span class="n">bus_resource</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">));</span>
		<span class="n">master_image</span><span class="o">-&gt;</span><span class="n">kern_base</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master_image</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_resources</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add slave windows to list */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_resources</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI148_MAX_SLAVE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slave_image</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_slave_resource</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave_image</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;slave resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_slave</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">address_attr</span> <span class="o">=</span> <span class="n">VME_A16</span> <span class="o">|</span> <span class="n">VME_A24</span> <span class="o">|</span> <span class="n">VME_A32</span> <span class="o">|</span>
			<span class="n">VME_A64</span> <span class="o">|</span> <span class="n">VME_CRCSR</span> <span class="o">|</span> <span class="n">VME_USER1</span> <span class="o">|</span> <span class="n">VME_USER2</span> <span class="o">|</span>
			<span class="n">VME_USER3</span> <span class="o">|</span> <span class="n">VME_USER4</span><span class="p">;</span>
		<span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">cycle_attr</span> <span class="o">=</span> <span class="n">VME_SCT</span> <span class="o">|</span> <span class="n">VME_BLT</span> <span class="o">|</span> <span class="n">VME_MBLT</span> <span class="o">|</span>
			<span class="n">VME_2eVME</span> <span class="o">|</span> <span class="n">VME_2eSST</span> <span class="o">|</span> <span class="n">VME_2eSSTB</span> <span class="o">|</span> <span class="n">VME_2eSST160</span> <span class="o">|</span>
			<span class="n">VME_2eSST267</span> <span class="o">|</span> <span class="n">VME_2eSST320</span> <span class="o">|</span> <span class="n">VME_SUPER</span> <span class="o">|</span> <span class="n">VME_USER</span> <span class="o">|</span>
			<span class="n">VME_PROG</span> <span class="o">|</span> <span class="n">VME_DATA</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slave_image</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_resources</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add dma engines to list */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_resources</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TSI148_MAX_DMA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_ctrlr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_dma_resource</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_ctrlr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
			<span class="s">&quot;dma resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_dma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">route_attr</span> <span class="o">=</span> <span class="n">VME_DMA_VME_TO_MEM</span> <span class="o">|</span>
			<span class="n">VME_DMA_MEM_TO_VME</span> <span class="o">|</span> <span class="n">VME_DMA_VME_TO_VME</span> <span class="o">|</span>
			<span class="n">VME_DMA_MEM_TO_MEM</span> <span class="o">|</span> <span class="n">VME_DMA_PATTERN_TO_VME</span> <span class="o">|</span>
			<span class="n">VME_DMA_PATTERN_TO_MEM</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_ctrlr</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_resources</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add location monitor to list */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_resources</span><span class="p">);</span>
	<span class="n">lm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vme_lm_resource</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for &quot;</span>
		<span class="s">&quot;location monitor resource structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_lm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lm</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">lm</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lm</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lm</span><span class="o">-&gt;</span><span class="n">monitors</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_resources</span><span class="p">);</span>

	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_get</span> <span class="o">=</span> <span class="n">tsi148_slave_get</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_set</span> <span class="o">=</span> <span class="n">tsi148_slave_set</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_get</span> <span class="o">=</span> <span class="n">tsi148_master_get</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_set</span> <span class="o">=</span> <span class="n">tsi148_master_set</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_read</span> <span class="o">=</span> <span class="n">tsi148_master_read</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_write</span> <span class="o">=</span> <span class="n">tsi148_master_write</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_rmw</span> <span class="o">=</span> <span class="n">tsi148_master_rmw</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_list_add</span> <span class="o">=</span> <span class="n">tsi148_dma_list_add</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_list_exec</span> <span class="o">=</span> <span class="n">tsi148_dma_list_exec</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_list_empty</span> <span class="o">=</span> <span class="n">tsi148_dma_list_empty</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">irq_set</span> <span class="o">=</span> <span class="n">tsi148_irq_set</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">irq_generate</span> <span class="o">=</span> <span class="n">tsi148_irq_generate</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_set</span> <span class="o">=</span> <span class="n">tsi148_lm_set</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_get</span> <span class="o">=</span> <span class="n">tsi148_lm_get</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_attach</span> <span class="o">=</span> <span class="n">tsi148_lm_attach</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_detach</span> <span class="o">=</span> <span class="n">tsi148_lm_detach</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slot_get</span> <span class="o">=</span> <span class="n">tsi148_slot_get</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">alloc_consistent</span> <span class="o">=</span> <span class="n">tsi148_alloc_consistent</span><span class="p">;</span>
	<span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">free_consistent</span> <span class="o">=</span> <span class="n">tsi148_free_consistent</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VSTAT</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Board is%s the VME system controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VSTAT_SCONS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; not&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">geoid</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VME geographical address is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span> <span class="o">&amp;</span> <span class="n">TSI148_LCSR_VSTAT_GA_M</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VME geographical address is set to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">geoid</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VME Write and flush and error check is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">err_chk</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tsi148_crcsr_init</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CR/CSR configuration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_crcsr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">vme_register_bridge</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip Registration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tsi148_bridge</span><span class="p">);</span>

	<span class="cm">/* Clear VME bus &quot;board fail&quot;, and &quot;power-up reset&quot; lines */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32be</span><span class="p">(</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VSTAT</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TSI148_LCSR_VSTAT_BRDFL</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">TSI148_LCSR_VSTAT_CPURST</span><span class="p">;</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VSTAT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_reg:</span>
	<span class="n">tsi148_crcsr_exit</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_crcsr:</span>
<span class="nl">err_lm:</span>
	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">lm_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_lm_resource</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_dma:</span>
	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_ctrlr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_dma_resource</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dma_ctrlr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_slave:</span>
	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slave_image</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_slave_resource</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">slave_image</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_master:</span>
	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_image</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_master_resource</span><span class="p">,</span>
			<span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">master_image</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tsi148_irq_exit</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_irq:</span>
<span class="nl">err_test:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">tsi148_device</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">err_remap:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_resource:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_enable:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tsi148_device</span><span class="p">);</span>
<span class="nl">err_driver:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>
<span class="nl">err_struct:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tsi148_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmplist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_master_resource</span> <span class="o">*</span><span class="n">master_image</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_slave_resource</span> <span class="o">*</span><span class="n">slave_image</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_dma_resource</span> <span class="o">*</span><span class="n">dma_ctrlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tsi148_driver</span> <span class="o">*</span><span class="n">bridge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vme_bridge</span> <span class="o">*</span><span class="n">tsi148_bridge</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">bridge</span> <span class="o">=</span> <span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>


	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Driver is being unloaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Shutdown all inbound and outbound windows.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_IT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">TSI148_LCSR_OFFSET_ITAT</span><span class="p">);</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_OT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">TSI148_LCSR_OFFSET_OTAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Shutdown Location monitor.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_LMAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Shutdown CRG map.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_CSRAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Clear error status.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_EDPAT</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VEAT</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x07000700</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_PSTAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Remove VIRQ interrupt (if any)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioread32be</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
		<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_VICR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Map all Interrupts to PCI INTA</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTM1</span><span class="p">);</span>
	<span class="n">iowrite32be</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSI148_LCSR_INTM2</span><span class="p">);</span>

	<span class="n">tsi148_irq_exit</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">vme_unregister_bridge</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>

	<span class="n">tsi148_crcsr_exit</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tmplist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">dma_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_ctrlr</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_dma_resource</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dma_ctrlr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tmplist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">slave_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slave_image</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_slave_resource</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">slave_image</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* resources are stored in link list */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tmplist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">master_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_image</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vme_master_resource</span><span class="p">,</span>
			<span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">master_image</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tsi148_bridge</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tsi148_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsi148_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">err_chk</span><span class="p">,</span> <span class="s">&quot;Check for VME errors on reads and writes&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">err_chk</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">geoid</span><span class="p">,</span> <span class="s">&quot;Override geographical addressing&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">geoid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VME driver for the Tundra Tempe VME bridge&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tsi148_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tsi148_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
