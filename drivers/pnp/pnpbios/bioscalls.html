<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pnp › pnpbios › bioscalls.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bioscalls.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * bioscalls.c - the lowlevel layer of the PnPBIOS driver</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/desc.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;pnpbios.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">segment</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pnp_bios_callpoint</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * These are some opcodes for a &quot;static asmlinkage&quot;</span>
<span class="cm"> * As this code is *not* executed inside the linux kernel segment, but in a</span>
<span class="cm"> * alias at offset 0, we need a far return that can not be compiled by</span>
<span class="cm"> * default (please, prove me wrong! this is *really* ugly!)</span>
<span class="cm"> * This is the only way to get the bios to return into the kernel code,</span>
<span class="cm"> * because the bios code runs in 16 bit protected mode and therefore can only</span>
<span class="cm"> * return to the caller if the call is within the first 64kB, and the linux</span>
<span class="cm"> * kernel begins at offset 3GB...</span>
<span class="cm"> */</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">pnp_bios_callfunc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;.text			</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">__ALIGN_STR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;pnp_bios_callfunc:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	pushl %edx	</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	pushl %ecx	</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	pushl %ebx	</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	pushl %eax	</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lcallw *pnp_bios_callpoint</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	addl $16, %esp	</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lret		</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.previous		</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#define Q2_SET_SEL(cpu, selname, address, size) \</span>
<span class="cp">do { \</span>
<span class="cp">	struct desc_struct *gdt = get_cpu_gdt_table((cpu)); \</span>
<span class="cp">	set_desc_base(&amp;gdt[(selname) &gt;&gt; 3], (u32)(address)); \</span>
<span class="cp">	set_desc_limit(&amp;gdt[(selname) &gt;&gt; 3], (size) - 1); \</span>
<span class="cp">} while(0)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">bad_bios_desc</span> <span class="o">=</span> <span class="n">GDT_ENTRY_INIT</span><span class="p">(</span><span class="mh">0x4092</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="mh">0x400UL</span><span class="p">),</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mh">0x400</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * At some point we want to use this stack frame pointer to unwind</span>
<span class="cm"> * after PnP BIOS oopses.</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="n">pnp_bios_fault_esp</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">pnp_bios_fault_eip</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">pnp_bios_is_utter_crap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">pnp_bios_lock</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Support Functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">call_pnp_bios</span><span class="p">(</span><span class="n">u16</span> <span class="n">func</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg3</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">arg4</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg5</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg6</span><span class="p">,</span> <span class="n">u16</span> <span class="n">arg7</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">ts1_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ts1_size</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">ts2_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ts2_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">desc_struct</span> <span class="n">save_desc_40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * PnP BIOSes are generally not terribly re-entrant.</span>
<span class="cm">	 * Also, don&#39;t rely on them to save everything correctly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_bios_is_utter_crap</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>
	<span class="n">save_desc_40</span> <span class="o">=</span> <span class="n">get_cpu_gdt_table</span><span class="p">(</span><span class="n">cpu</span><span class="p">)[</span><span class="mh">0x40</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>
	<span class="n">get_cpu_gdt_table</span><span class="p">(</span><span class="n">cpu</span><span class="p">)[</span><span class="mh">0x40</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">bad_bios_desc</span><span class="p">;</span>

	<span class="cm">/* On some boxes IRQ&#39;s during PnP BIOS calls are deadly.  */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_bios_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* The lock prevents us bouncing CPU here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts1_size</span><span class="p">)</span>
		<span class="n">Q2_SET_SEL</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="n">ts1_base</span><span class="p">,</span> <span class="n">ts1_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts2_size</span><span class="p">)</span>
		<span class="n">Q2_SET_SEL</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">PNP_TS2</span><span class="p">,</span> <span class="n">ts2_base</span><span class="p">,</span> <span class="n">ts2_size</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;pushl %%ebp</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%esi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%ds</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%es</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%fs</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushl %%gs</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;pushfl</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;movl %%esp, pnp_bios_fault_esp</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;movl $1f, pnp_bios_fault_eip</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;lcall %5,%6</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;1:popfl</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%gs</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%fs</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%es</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%ds</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%esi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			     <span class="s">&quot;popl %%ebp</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="o">:</span><span class="s">&quot;=a&quot;</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
			     <span class="o">:</span><span class="s">&quot;0&quot;</span><span class="p">((</span><span class="n">func</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">arg1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			     <span class="s">&quot;b&quot;</span><span class="p">((</span><span class="n">arg2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">arg3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			     <span class="s">&quot;c&quot;</span><span class="p">((</span><span class="n">arg4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">arg5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			     <span class="s">&quot;d&quot;</span><span class="p">((</span><span class="n">arg6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">arg7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			     <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">PNP_CS32</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			     <span class="o">:</span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_bios_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">get_cpu_gdt_table</span><span class="p">(</span><span class="n">cpu</span><span class="p">)[</span><span class="mh">0x40</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_desc_40</span><span class="p">;</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="cm">/* If we get here and this is set then the PnP BIOS faulted on us. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_bios_is_utter_crap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: Warning! Your PnP BIOS caused a fatal error. Attempting to continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: You may need to reboot with the </span><span class="se">\&quot;</span><span class="s">pnpbios=off</span><span class="se">\&quot;</span><span class="s"> option to operate stably</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: Check with your vendor for an updated BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pnpbios_print_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PNP_SUCCESS</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: function successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_NOT_SET_STATICALLY</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: unable to set static resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_UNKNOWN_FUNCTION</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: invalid function number passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: %s: function not supported on this system</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_INVALID_HANDLE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: invalid handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_BAD_PARAMETER</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: invalid parameters were passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_SET_FAILED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: unable to set resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_EVENTS_NOT_PENDING</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: no events are pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_SYSTEM_NOT_DOCKED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: the system is not docked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_NO_ISA_PNP_CARDS</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: %s: no isapnp cards are installed on this system</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_UNABLE_TO_DETERMINE_DOCK_CAPABILITIES</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: %s: cannot determine the capabilities of the docking station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_CONFIG_CHANGE_FAILED_NO_BATTERY</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: %s: unable to undock, the system does not have a battery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_CONFIG_CHANGE_FAILED_RESOURCE_CONFLICT</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;PnPBIOS: %s: could not dock due to resource conflicts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_BUFFER_TOO_SMALL</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: the buffer passed is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_USE_ESCD_SUPPORT</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: use ESCD instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_MESSAGE_NOT_SUPPORTED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: the message is unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PNP_HARDWARE_ERROR</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: a hardware failure has occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">module</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PnPBIOS: %s: unexpected status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PnP BIOS Low Level Calls</span>
<span class="cm"> */</span>

<span class="cp">#define PNP_GET_NUM_SYS_DEV_NODES		0x00</span>
<span class="cp">#define PNP_GET_SYS_DEV_NODE			0x01</span>
<span class="cp">#define PNP_SET_SYS_DEV_NODE			0x02</span>
<span class="cp">#define PNP_GET_EVENT				0x03</span>
<span class="cp">#define PNP_SEND_MESSAGE			0x04</span>
<span class="cp">#define PNP_GET_DOCKING_STATION_INFORMATION	0x05</span>
<span class="cp">#define PNP_SET_STATIC_ALLOCED_RES_INFO		0x09</span>
<span class="cp">#define PNP_GET_STATIC_ALLOCED_RES_INFO		0x0a</span>
<span class="cp">#define PNP_GET_APM_ID_TABLE			0x0b</span>
<span class="cp">#define PNP_GET_PNP_ISA_CONFIG_STRUC		0x40</span>
<span class="cp">#define PNP_GET_ESCD_INFO			0x41</span>
<span class="cp">#define PNP_READ_ESCD				0x42</span>
<span class="cp">#define PNP_WRITE_ESCD				0x43</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x00, &quot;get number of system device nodes&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_dev_node_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev_node_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_NUM_SYS_DEV_NODES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">PNP_TS1</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev_node_info</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">no_nodes</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_dev_node_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev_node_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_dev_node_info</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;dev_node_info&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note that some PnP BIOSes (e.g., on Sony Vaio laptops) die a horrible</span>
<span class="cm"> * death if they are asked to access the &quot;current&quot; configuration.</span>
<span class="cm"> * Therefore, if it&#39;s a matter of indifference, it&#39;s better to call</span>
<span class="cm"> * get_dev_node() and set_dev_node() with boot=1 rather than with boot=0.</span>
<span class="cm"> */</span>

<span class="cm">/* </span>
<span class="cm"> * Call PnP BIOS with function 0x01, &quot;get system device node&quot;</span>
<span class="cm"> * Input: *nodenum = desired node,</span>
<span class="cm"> *        boot = whether to get nonvolatile boot (!=0)</span>
<span class="cm"> *               or volatile current (0) config</span>
<span class="cm"> * Output: *nodenum=next node or 0xff if no more nodes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_get_dev_node</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">nodenum</span><span class="p">,</span> <span class="kt">char</span> <span class="n">boot</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pnp_bios_node</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_nodenum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span> <span class="o">&amp;&amp;</span> <span class="n">pnpbios_dont_use_current_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">tmp_nodenum</span> <span class="o">=</span> <span class="o">*</span><span class="n">nodenum</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_SYS_DEV_NODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS2</span><span class="p">,</span>
			       <span class="n">boot</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_nodenum</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_nodenum</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="o">*</span><span class="n">nodenum</span> <span class="o">=</span> <span class="n">tmp_nodenum</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_get_dev_node</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">nodenum</span><span class="p">,</span> <span class="kt">char</span> <span class="n">boot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnp_bios_node</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_get_dev_node</span><span class="p">(</span><span class="n">nodenum</span><span class="p">,</span> <span class="n">boot</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;get_dev_node&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x02, &quot;set system device node&quot;</span>
<span class="cm"> * Input: *nodenum = desired node, </span>
<span class="cm"> *        boot = whether to set nonvolatile boot (!=0)</span>
<span class="cm"> *               or volatile current (0) config</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_set_dev_node</span><span class="p">(</span><span class="n">u8</span> <span class="n">nodenum</span><span class="p">,</span> <span class="kt">char</span> <span class="n">boot</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">pnp_bios_node</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span> <span class="o">&amp;&amp;</span> <span class="n">pnpbios_dont_use_current_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_SET_SYS_DEV_NODE</span><span class="p">,</span> <span class="n">nodenum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span>
			       <span class="n">boot</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_set_dev_node</span><span class="p">(</span><span class="n">u8</span> <span class="n">nodenum</span><span class="p">,</span> <span class="kt">char</span> <span class="n">boot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnp_bios_node</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_set_dev_node</span><span class="p">(</span><span class="n">nodenum</span><span class="p">,</span> <span class="n">boot</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;set_dev_node&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Update devlist */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pnp_bios_get_dev_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nodenum</span><span class="p">,</span> <span class="n">boot</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x05, &quot;get docking station information&quot;</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pnp_bios_dock_station_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_docking_station_info</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_DOCKING_STATION_INFORMATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span>
			       <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_docking_station_info</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x0a, &quot;get statically allocated resource</span>
<span class="cm"> * information&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_get_stat_res</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_STATIC_ALLOCED_RES_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span>
			       <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_get_stat_res</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_get_stat_res</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;get_stat_res&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x40, &quot;get isa pnp configuration structure&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_isapnp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_isa_config_struc</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">PNP_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_PNP_ISA_CONFIG_STRUC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_isa_config_struc</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_isapnp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_isa_config_struc</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_isapnp_config</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;isapnp_config&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS with function 0x41, &quot;get ESCD info&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_escd_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">escd_info_struc</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">ESCD_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_GET_ESCD_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			       <span class="n">PNP_TS1</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">escd_info_struc</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_escd_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">escd_info_struc</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_escd_info</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;escd_info&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call PnP BIOS function 0x42, &quot;read ESCD&quot;</span>
<span class="cm"> * nvram_base is determined by calling escd_info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pnp_bios_read_escd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nvram_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_bios_present</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">ESCD_FUNCTION_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">call_pnp_bios</span><span class="p">(</span><span class="n">PNP_READ_ESCD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PNP_TS1</span><span class="p">,</span> <span class="n">PNP_TS2</span><span class="p">,</span> <span class="n">PNP_DS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">65536</span><span class="p">,</span> <span class="n">__va</span><span class="p">(</span><span class="n">nvram_base</span><span class="p">),</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pnp_bios_read_escd</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nvram_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__pnp_bios_read_escd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nvram_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pnpbios_print_status</span><span class="p">(</span><span class="s">&quot;read_escd&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pnpbios_calls_init</span><span class="p">(</span><span class="k">union</span> <span class="n">pnp_bios_install_struct</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_bios_lock</span><span class="p">);</span>
	<span class="n">pnp_bios_callpoint</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">pm16offset</span><span class="p">;</span>
	<span class="n">pnp_bios_callpoint</span><span class="p">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">PNP_CS16</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">desc_struct</span> <span class="o">*</span><span class="n">gdt</span> <span class="o">=</span> <span class="n">get_cpu_gdt_table</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">set_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdt</span><span class="p">[</span><span class="n">GDT_ENTRY_PNPBIOS_CS32</span><span class="p">],</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pnp_bios_callfunc</span><span class="p">);</span>
		<span class="n">set_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdt</span><span class="p">[</span><span class="n">GDT_ENTRY_PNPBIOS_CS16</span><span class="p">],</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">pm16cseg</span><span class="p">));</span>
		<span class="n">set_desc_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdt</span><span class="p">[</span><span class="n">GDT_ENTRY_PNPBIOS_DS</span><span class="p">],</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">.</span><span class="n">pm16dseg</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
