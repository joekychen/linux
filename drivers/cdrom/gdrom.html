<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cdrom › gdrom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>gdrom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* GD ROM driver for the SEGA Dreamcast</span>
<span class="cm"> * copyright Adrian McMenamin, 2007</span>
<span class="cm"> * With thanks to Marcus Comstedt and Nathan Keynes</span>
<span class="cm"> * for work in reversing PIO and DMA</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/bio.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;mach/dma.h&gt;</span>
<span class="cp">#include &lt;mach/sysasic.h&gt;</span>

<span class="cp">#define GDROM_DEV_NAME &quot;gdrom&quot;</span>
<span class="cp">#define GD_SESSION_OFFSET 150</span>

<span class="cm">/* GD Rom commands */</span>
<span class="cp">#define GDROM_COM_SOFTRESET 0x08</span>
<span class="cp">#define GDROM_COM_EXECDIAG 0x90</span>
<span class="cp">#define GDROM_COM_PACKET 0xA0</span>
<span class="cp">#define GDROM_COM_IDDEV 0xA1</span>

<span class="cm">/* GD Rom registers */</span>
<span class="cp">#define GDROM_BASE_REG			0xA05F7000</span>
<span class="cp">#define GDROM_ALTSTATUS_REG		(GDROM_BASE_REG + 0x18)</span>
<span class="cp">#define GDROM_DATA_REG			(GDROM_BASE_REG + 0x80)</span>
<span class="cp">#define GDROM_ERROR_REG		(GDROM_BASE_REG + 0x84)</span>
<span class="cp">#define GDROM_INTSEC_REG		(GDROM_BASE_REG + 0x88)</span>
<span class="cp">#define GDROM_SECNUM_REG		(GDROM_BASE_REG + 0x8C)</span>
<span class="cp">#define GDROM_BCL_REG			(GDROM_BASE_REG + 0x90)</span>
<span class="cp">#define GDROM_BCH_REG			(GDROM_BASE_REG + 0x94)</span>
<span class="cp">#define GDROM_DSEL_REG			(GDROM_BASE_REG + 0x98)</span>
<span class="cp">#define GDROM_STATUSCOMMAND_REG	(GDROM_BASE_REG + 0x9C)</span>
<span class="cp">#define GDROM_RESET_REG		(GDROM_BASE_REG + 0x4E4)</span>

<span class="cp">#define GDROM_DMA_STARTADDR_REG	(GDROM_BASE_REG + 0x404)</span>
<span class="cp">#define GDROM_DMA_LENGTH_REG		(GDROM_BASE_REG + 0x408)</span>
<span class="cp">#define GDROM_DMA_DIRECTION_REG	(GDROM_BASE_REG + 0x40C)</span>
<span class="cp">#define GDROM_DMA_ENABLE_REG		(GDROM_BASE_REG + 0x414)</span>
<span class="cp">#define GDROM_DMA_STATUS_REG		(GDROM_BASE_REG + 0x418)</span>
<span class="cp">#define GDROM_DMA_WAIT_REG		(GDROM_BASE_REG + 0x4A0)</span>
<span class="cp">#define GDROM_DMA_ACCESS_CTRL_REG	(GDROM_BASE_REG + 0x4B8)</span>

<span class="cp">#define GDROM_HARD_SECTOR	2048</span>
<span class="cp">#define BLOCK_LAYER_SECTOR	512</span>
<span class="cp">#define GD_TO_BLK		4</span>

<span class="cp">#define GDROM_DEFAULT_TIMEOUT	(HZ * 7)</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">gdrom_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">sense_key</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">text</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sense_texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">NO_SENSE</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RECOVERED_ERROR</span><span class="p">,</span> <span class="s">&quot;Recovered from error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">NOT_READY</span><span class="p">,</span> <span class="s">&quot;Device not ready&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MEDIUM_ERROR</span><span class="p">,</span> <span class="s">&quot;Disk not ready&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">HARDWARE_ERROR</span><span class="p">,</span> <span class="s">&quot;Hardware error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ILLEGAL_REQUEST</span><span class="p">,</span> <span class="s">&quot;Command has failed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">UNIT_ATTENTION</span><span class="p">,</span> <span class="s">&quot;Device needs attention - disk may have been changed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DATA_PROTECT</span><span class="p">,</span> <span class="s">&quot;Data protection error&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">ABORTED_COMMAND</span><span class="p">,</span> <span class="s">&quot;Command aborted&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdrom_major</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">command_queue</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">request_queue</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">gdrom_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gdrom_readdisk_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">gdrom_readdisk_dma</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">gdrom_deferred</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">gdromtoc</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">[</span><span class="mi">99</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leadout</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gdrom_unit</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">disk_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gdromtoc</span> <span class="o">*</span><span class="n">toc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">gdrom_rq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">gd</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">gdrom_id</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">mid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">modid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">verid</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">padA</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">mname</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">modname</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">firmver</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">padB</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gdrom_getsense</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">bufstring</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdrom_packetcommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">command</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gdrom_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gdrom_is_busy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ALTSTATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gdrom_data_request</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ALTSTATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x88</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gdrom_wait_clrbusy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ALTSTATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">gdrom_wait_busy_sleeps</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="cm">/* Wait to get busy first */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_is_busy</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="cm">/* Now wait for busy to clear */</span>
	<span class="k">return</span> <span class="n">gdrom_wait_clrbusy</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdrom_identifydevice</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="cm">/* If the device won&#39;t clear it has probably</span>
<span class="cm">	* been hit by a serious failure - but we&#39;ll</span>
<span class="cm">	* try to return a sense key even so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_clrbusy</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">GDROM_COM_IDDEV</span><span class="p">,</span> <span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_busy_sleeps</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* now read in the data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">GDROM_DATA_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdrom_spicommand</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">spi_string</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">spi_string</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* ensure IRQ_WAIT is set */</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">GDROM_ALTSTATUS_REG</span><span class="p">);</span>
	<span class="cm">/* specify how many bytes we expect back */</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">GDROM_BCL_REG</span><span class="p">);</span>
	<span class="n">__raw_writeb</span><span class="p">((</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">GDROM_BCH_REG</span><span class="p">);</span>
	<span class="cm">/* other parameters */</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_INTSEC_REG</span><span class="p">);</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_SECNUM_REG</span><span class="p">);</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_ERROR_REG</span><span class="p">);</span>
	<span class="cm">/* Wait until we can go */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_clrbusy</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">;</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">GDROM_COM_PACKET</span><span class="p">,</span> <span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_data_request</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outsw</span><span class="p">(</span><span class="n">GDROM_DATA_REG</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* gdrom_command_executediagnostic:</span>
<span class="cm"> * Used to probe for presence of working GDROM</span>
<span class="cm"> * Restarts GDROM device and then applies standard ATA 3</span>
<span class="cm"> * Execute Diagnostic Command: a return of &#39;1&#39; indicates device 0</span>
<span class="cm"> * present and device 1 absent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">gdrom_execute_diagnostic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdrom_hardreset</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_clrbusy</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">GDROM_COM_EXECDIAG</span><span class="p">,</span> <span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_busy_sleeps</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ERROR_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare disk command</span>
<span class="cm"> * byte 0 = 0x70</span>
<span class="cm"> * byte 1 = 0x1f</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_preparedisk_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">spin_command</span><span class="p">;</span>
	<span class="n">spin_command</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_command</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">spin_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">spin_command</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gdrom_packetcommand</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">spin_command</span><span class="p">);</span>
	<span class="cm">/* 60 second timeout */</span>
	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span> <span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">);</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">spin_command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* log an error */</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read TOC command</span>
<span class="cm"> * byte 0 = 0x14</span>
<span class="cm"> * byte 1 = session</span>
<span class="cm"> * byte 3 = sizeof TOC &gt;&gt; 8  ie upper byte</span>
<span class="cm"> * byte 4 = sizeof TOC &amp; 0xff ie lower byte</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_readtoc_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">gdromtoc</span> <span class="o">*</span><span class="n">toc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tocsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">toc_command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">toc_command</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toc_command</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">tocsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gdromtoc</span><span class="p">);</span>
	<span class="n">toc_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="n">toc_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">;</span>
	<span class="n">toc_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tocsize</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">toc_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">tocsize</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">toc_command</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">tocsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_readtoc_final</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gdrom_packetcommand</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">toc_command</span><span class="p">);</span>
	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span> <span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_readtoc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">insw</span><span class="p">(</span><span class="n">GDROM_DATA_REG</span><span class="p">,</span> <span class="n">toc</span><span class="p">,</span> <span class="n">tocsize</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">cleanup_readtoc:</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">cleanup_readtoc_final:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">toc_command</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TOC helpers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_entry_lba</span><span class="p">(</span><span class="kt">int</span> <span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">-</span> <span class="n">GD_SESSION_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_entry_q_ctrl</span><span class="p">(</span><span class="kt">int</span> <span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0x000000f0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_entry_track</span><span class="p">(</span><span class="kt">int</span> <span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_get_last_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cdrom_multisession</span> <span class="o">*</span><span class="n">ms_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fentry</span><span class="p">,</span> <span class="n">lentry</span><span class="p">,</span> <span class="n">track</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tocuse</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">tocuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Check if GD-ROM */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gdrom_readtoc_cmd</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Not a GD-ROM so check if standard CD-ROM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tocuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gdrom_readtoc_cmd</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Could not get CD table of contents</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fentry</span> <span class="o">=</span> <span class="n">get_entry_track</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">);</span>
	<span class="n">lentry</span> <span class="o">=</span> <span class="n">get_entry_track</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>
	<span class="cm">/* Find the first data track */</span>
	<span class="n">track</span> <span class="o">=</span> <span class="n">get_entry_track</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="n">track</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_entry_q_ctrl</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* ie a real data track */</span>
		<span class="n">track</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">track</span> <span class="o">&gt;=</span> <span class="n">fentry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">track</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">track</span> <span class="o">&lt;</span> <span class="n">get_entry_track</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;No data on the last session of the CD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gdrom_getsense</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ms_info</span><span class="o">-&gt;</span><span class="n">addr_format</span> <span class="o">=</span> <span class="n">CDROM_LBA</span><span class="p">;</span>
	<span class="n">ms_info</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">lba</span> <span class="o">=</span> <span class="n">get_entry_lba</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ms_info</span><span class="o">-&gt;</span><span class="n">xa_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">purpose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* spin up the disk */</span>
	<span class="k">return</span> <span class="n">gdrom_preparedisk_cmd</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* this function is required even if empty */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdrom_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_drivestatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* read the sense key */</span>
	<span class="kt">char</span> <span class="n">sense</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ERROR_REG</span><span class="p">);</span>
	<span class="n">sense</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_DISC_OK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_DRIVE_NOT_READY</span><span class="p">;</span>
	<span class="cm">/* default */</span>
	<span class="k">return</span> <span class="n">CDS_NO_INFO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gdrom_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check the sense key */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_ERROR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x60</span> <span class="o">?</span>
		<span class="n">DISK_EVENT_MEDIA_CHANGE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reset the G1 bus */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x1fffff</span><span class="p">,</span> <span class="n">GDROM_RESET_REG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mh">0xa0000000</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mh">0xa0200000</span><span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">__raw_readl</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* keep the function looking like the universal</span>
<span class="cm"> * CD Rom specification  - returning int */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_packetcommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cd_info</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gdrom_spicommand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">command</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get Sense SPI command</span>
<span class="cm"> * From Marcus Comstedt</span>
<span class="cm"> * cmd = 0x13</span>
<span class="cm"> * cmd + 4 = length of returned buffer</span>
<span class="cm"> * Returns 5 16 bit words</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_getsense</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="n">bufstring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">sense_command</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">sense</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sense_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">sense_command</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sense_command</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sense_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	<span class="n">sense_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">sense_command</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="cm">/* even if something is pending try to get</span>
<span class="cm">	* the sense key if possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">gdrom_wait_clrbusy</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup_sense_final</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gdrom_packetcommand</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">sense_command</span><span class="p">);</span>
	<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span> <span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">pending</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_sense</span><span class="p">;</span>
	<span class="n">insw</span><span class="p">(</span><span class="n">GDROM_DATA_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">,</span> <span class="n">sense_command</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Drive not ready - command aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup_sense</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sense_key</span> <span class="o">=</span> <span class="n">sense</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense_key</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sense_texts</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense_texts</span><span class="p">[</span><span class="n">sense_key</span><span class="p">].</span><span class="n">text</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown sense key: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sense_key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufstring</span><span class="p">)</span> <span class="cm">/* return addional sense data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bufstring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense_key</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_sense:</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">cleanup_sense_final:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sense_command</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_audio_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="n">gdrom_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">gdrom_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">gdrom_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drive_status</span>		<span class="o">=</span> <span class="n">gdrom_drivestatus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">gdrom_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_last_session</span>	<span class="o">=</span> <span class="n">gdrom_get_last_session</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>			<span class="o">=</span> <span class="n">gdrom_hardreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">audio_ioctl</span>		<span class="o">=</span> <span class="n">gdrom_audio_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capability</span>		<span class="o">=</span> <span class="n">CDC_MULTI_SESSION</span> <span class="o">|</span> <span class="n">CDC_MEDIA_CHANGED</span> <span class="o">|</span>
				  <span class="n">CDC_RESET</span> <span class="o">|</span> <span class="n">CDC_DRIVE_STATUS</span> <span class="o">|</span> <span class="n">CDC_CD_R</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_minors</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_bdops_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_open</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_bdops_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>
	<span class="n">cdrom_release</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gdrom_bdops_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cdrom_check_events</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">clearing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gdrom_bdops_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_ioctl</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">gdrom_bdops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">gdrom_bdops_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">gdrom_bdops_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_events</span>		<span class="o">=</span> <span class="n">gdrom_bdops_check_events</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">gdrom_bdops_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">gdrom_command_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">gdrom_dma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdrom_set_interrupt_handlers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_CMD</span><span class="p">,</span> <span class="n">gdrom_command_interrupt</span><span class="p">,</span>
		<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;gdrom_command&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_DMA</span><span class="p">,</span> <span class="n">gdrom_dma_interrupt</span><span class="p">,</span>
		<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;gdrom_dma&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Implement DMA read using SPI command</span>
<span class="cm"> * 0 -&gt; 0x30</span>
<span class="cm"> * 1 -&gt; mode</span>
<span class="cm"> * 2 -&gt; block &gt;&gt; 16</span>
<span class="cm"> * 3 -&gt; block &gt;&gt; 8</span>
<span class="cm"> * 4 -&gt; block</span>
<span class="cm"> * 8 -&gt; sectors &gt;&gt; 16</span>
<span class="cm"> * 9 -&gt; sectors &gt;&gt; 8</span>
<span class="cm"> * 10 -&gt; sectors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdrom_readdisk_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">block_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">read_command</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">elem</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_deferred</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">read_command</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_command</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* get more memory later? */</span>
	<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdrom_deferred</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span><span class="p">,</span> <span class="n">queuelist</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_lock</span><span class="p">);</span>
		<span class="n">block</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">/</span><span class="n">GD_TO_BLK</span> <span class="o">+</span> <span class="n">GD_SESSION_OFFSET</span><span class="p">;</span>
		<span class="n">block_cnt</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">/</span><span class="n">GD_TO_BLK</span><span class="p">;</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">),</span> <span class="n">GDROM_DMA_STARTADDR_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="n">block_cnt</span> <span class="o">*</span> <span class="n">GDROM_HARD_SECTOR</span><span class="p">,</span> <span class="n">GDROM_DMA_LENGTH_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GDROM_DMA_DIRECTION_REG</span><span class="p">);</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GDROM_DMA_ENABLE_REG</span><span class="p">);</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_cnt</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="cm">/* set for DMA */</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GDROM_ERROR_REG</span><span class="p">);</span>
		<span class="cm">/* other registers */</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_SECNUM_REG</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_BCL_REG</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_BCH_REG</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_DSEL_REG</span><span class="p">);</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_INTSEC_REG</span><span class="p">);</span>
		<span class="cm">/* Wait for registers to reset after any previous activity */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">gdrom_is_busy</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">GDROM_COM_PACKET</span><span class="p">,</span> <span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Wait for packet command to finish */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">gdrom_is_busy</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">outsw</span><span class="p">(</span><span class="n">GDROM_DATA_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_command</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Wait for any pending DMA to finish */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">__raw_readb</span><span class="p">(</span><span class="n">GDROM_DMA_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="cm">/* start transfer */</span>
		<span class="n">__raw_writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GDROM_DMA_STATUS_REG</span><span class="p">);</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">request_queue</span><span class="p">,</span>
			<span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_DEFAULT_TIMEOUT</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gd</span><span class="p">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gd</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* now seek to take the request spinlock</span>
<span class="cm">		* before handling ending the request */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_lock</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">);</span>
		<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">read_command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gdrom_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">rq</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">REQ_TYPE_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;gdrom: Non-fs request ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Read only device - write request ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Add to list of deferred work and then schedule</span>
<span class="cm">		 * workqueue.</span>
<span class="cm">		 */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">queuelist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdrom_deferred</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Print string identifying GD ROM device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdrom_outputversion</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gdrom_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">model_name</span><span class="p">,</span> <span class="o">*</span><span class="n">manuf_name</span><span class="p">,</span> <span class="o">*</span><span class="n">firmw_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* query device ID */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gdrom_id</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">gdrom_identifydevice</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">model_name</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">modname</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model_name</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_id</span><span class="p">;</span>
	<span class="n">manuf_name</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">mname</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">manuf_name</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_model_name</span><span class="p">;</span>
	<span class="n">firmw_ver</span> <span class="o">=</span> <span class="n">kstrndup</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">firmver</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmw_ver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_manuf_name</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s from %s with firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">model_name</span><span class="p">,</span> <span class="n">manuf_name</span><span class="p">,</span> <span class="n">firmw_ver</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">firmw_ver</span><span class="p">);</span>
<span class="nl">free_manuf_name:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">manuf_name</span><span class="p">);</span>
<span class="nl">free_model_name:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">model_name</span><span class="p">);</span>
<span class="nl">free_id:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set the default mode for DMA transfer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gdrom_init_dma_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x13</span><span class="p">,</span> <span class="n">GDROM_ERROR_REG</span><span class="p">);</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="n">GDROM_INTSEC_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_clrbusy</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0xEF</span><span class="p">,</span> <span class="n">GDROM_STATUSCOMMAND_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gdrom_wait_busy_sleeps</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="cm">/* Memory protection setting for GDROM DMA</span>
<span class="cm">	* Bits 31 - 16 security: 0x8843</span>
<span class="cm">	* Bits 15 and 7 reserved (0)</span>
<span class="cm">	* Bits 14 - 8 start of transfer range in 1 MB blocks OR&#39;ed with 0x80</span>
<span class="cm">	* Bits 6 - 0 end of transfer range in 1 MB blocks OR&#39;ed with 0x80</span>
<span class="cm">	* (0x40 | 0x80) = start range at 0x0C000000</span>
<span class="cm">	* (0x7F | 0x80) = end range at 0x0FFFFFFF */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x8843407F</span><span class="p">,</span> <span class="n">GDROM_DMA_ACCESS_CTRL_REG</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">GDROM_DMA_WAIT_REG</span><span class="p">);</span> <span class="cm">/* DMA word setting */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">probe_gdrom_setupcd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gdrom_ops</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">GDROM_DEV_NAME</span><span class="p">);</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">CDC_CLOSE_TRAY</span><span class="o">|</span><span class="n">CDC_OPEN_TRAY</span><span class="o">|</span><span class="n">CDC_LOCK</span><span class="o">|</span>
		<span class="n">CDC_SELECT_DISC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">probe_gdrom_setupdisk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">gdrom_major</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">minors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">GDROM_DEV_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">probe_gdrom_setupqueue</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">,</span> <span class="n">GDROM_HARD_SECTOR</span><span class="p">);</span>
	<span class="cm">/* using DMA so memory will need to be contiguous */</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* set a large max size to get most from DMA */</span>
	<span class="n">blk_queue_max_segment_size</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">,</span> <span class="mh">0x40000</span><span class="p">);</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">gdrom_init_dma_mode</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * register this as a block device and as compliant with the</span>
<span class="cm"> * universal CD Rom driver interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">probe_gdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* Start the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdrom_execute_diagnostic</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;ATA Probe for GDROM failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Print out firmware ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdrom_outputversion</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/* Register GDROM */</span>
	<span class="n">gdrom_major</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GDROM_DEV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdrom_major</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">gdrom_major</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Registered with major number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gdrom_major</span><span class="p">);</span>
	<span class="cm">/* Specify basic properties of drive */</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_fail_no_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">probe_gdrom_setupcd</span><span class="p">();</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_fail_no_disk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">probe_gdrom_setupdisk</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_cdrom</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_fail_cdrom_register</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gdrom_bdops</span><span class="p">;</span>
	<span class="cm">/* latch on to the interrupt */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gdrom_set_interrupt_handlers</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_fail_cmdirq_register</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">gdrom_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdrom_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_fail_requestq</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">probe_gdrom_setupqueue</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_fail_toc</span><span class="p">;</span>

	<span class="n">gd</span><span class="p">.</span><span class="n">toc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gdromtoc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_fail_toc</span><span class="p">;</span>
	<span class="n">add_disk</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">probe_fail_toc:</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">);</span>
<span class="nl">probe_fail_requestq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
<span class="nl">probe_fail_cmdirq_register:</span>
<span class="nl">probe_fail_cdrom_register:</span>
	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="p">);</span>
<span class="nl">probe_fail_no_disk:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">gdrom_major</span><span class="p">,</span> <span class="n">GDROM_DEV_NAME</span><span class="p">);</span>
	<span class="n">gdrom_major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">probe_fail_no_mem:</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Probe failed - error is 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">remove_gdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">gdrom_rq</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">HW_EVENT_GDROM_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gd</span><span class="p">);</span>
	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">disk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gdrom_major</span><span class="p">)</span>
		<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">gdrom_major</span><span class="p">,</span> <span class="n">GDROM_DEV_NAME</span><span class="p">);</span>
	<span class="n">unregister_cdrom</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">cd_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">gdrom_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">probe_gdrom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">remove_gdrom</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">GDROM_DEV_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_gdrom</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">gd</span><span class="p">.</span><span class="n">toc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="n">GDROM_DEV_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_driver</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_gdrom</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gdrom_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gd</span><span class="p">.</span><span class="n">toc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_gdrom</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_gdrom</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Adrian McMenamin &lt;adrian@mcmen.demon.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SEGA Dreamcast GD-ROM Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
