<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › cdrom › cdrom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cdrom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/cdrom/cdrom.c</span>
<span class="cm">   Copyright (c) 1996, 1997 David A. van Leeuwen.</span>
<span class="cm">   Copyright (c) 1997, 1998 Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm">   Copyright (c) 1998, 1999 Jens Axboe &lt;axboe@image.dk&gt;</span>

<span class="cm">   May be copied or modified under the terms of the GNU General Public</span>
<span class="cm">   License.  See linux/COPYING for more information.</span>

<span class="cm">   Uniform CD-ROM driver for Linux.</span>
<span class="cm">   See Documentation/cdrom/cdrom-standard.tex for usage information.</span>

<span class="cm">   The routines in the file provide a uniform interface between the</span>
<span class="cm">   software that uses CD-ROMs and the various low-level drivers that</span>
<span class="cm">   actually talk to the hardware. Suggestions are welcome.</span>
<span class="cm">   Patches that work are more welcome though.  ;-)</span>

<span class="cm"> To Do List:</span>
<span class="cm"> ----------------------------------</span>

<span class="cm"> -- Modify sysctl/proc interface. I plan on having one directory per</span>
<span class="cm"> drive, with entries for outputing general drive information, and sysctl</span>
<span class="cm"> based tunable parameters such as whether the tray should auto-close for</span>
<span class="cm"> that drive. Suggestions (or patches) for this welcome!</span>


<span class="cm"> Revision History</span>
<span class="cm"> ----------------------------------</span>
<span class="cm"> 1.00  Date Unknown -- David van Leeuwen &lt;david@tm.tno.nl&gt;</span>
<span class="cm"> -- Initial version by David A. van Leeuwen. I don&#39;t have a detailed</span>
<span class="cm">  changelog for the 1.x series, David?</span>

<span class="cm">2.00  Dec  2, 1997 -- Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm">  -- New maintainer! As David A. van Leeuwen has been too busy to actively</span>
<span class="cm">  maintain and improve this driver, I am now carrying on the torch. If</span>
<span class="cm">  you have a problem with this driver, please feel free to contact me.</span>

<span class="cm">  -- Added (rudimentary) sysctl interface. I realize this is really weak</span>
<span class="cm">  right now, and is _very_ badly implemented. It will be improved...</span>

<span class="cm">  -- Modified CDROM_DISC_STATUS so that it is now incorporated into</span>
<span class="cm">  the Uniform CD-ROM driver via the cdrom_count_tracks function.</span>
<span class="cm">  The cdrom_count_tracks function helps resolve some of the false</span>
<span class="cm">  assumptions of the CDROM_DISC_STATUS ioctl, and is also used to check</span>
<span class="cm">  for the correct media type when mounting or playing audio from a CD.</span>

<span class="cm">  -- Remove the calls to verify_area and only use the copy_from_user and</span>
<span class="cm">  copy_to_user stuff, since these calls now provide their own memory</span>
<span class="cm">  checking with the 2.1.x kernels.</span>

<span class="cm">  -- Major update to return codes so that errors from low-level drivers</span>
<span class="cm">  are passed on through (thanks to Gerd Knorr for pointing out this</span>
<span class="cm">  problem).</span>

<span class="cm">  -- Made it so if a function isn&#39;t implemented in a low-level driver,</span>
<span class="cm">  ENOSYS is now returned instead of EINVAL.</span>

<span class="cm">  -- Simplified some complex logic so that the source code is easier to read.</span>

<span class="cm">  -- Other stuff I probably forgot to mention (lots of changes).</span>

<span class="cm">2.01 to 2.11 Dec 1997-Jan 1998</span>
<span class="cm">  -- TO-DO!  Write changelogs for 2.01 to 2.12.</span>

<span class="cm">2.12  Jan  24, 1998 -- Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm">  -- Fixed a bug in the IOCTL_IN and IOCTL_OUT macros.  It turns out that</span>
<span class="cm">  copy_*_user does not return EFAULT on error, but instead returns the number </span>
<span class="cm">  of bytes not copied.  I was returning whatever non-zero stuff came back from </span>
<span class="cm">  the copy_*_user functions directly, which would result in strange errors.</span>

<span class="cm">2.13  July 17, 1998 -- Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm">  -- Fixed a bug in CDROM_SELECT_SPEED where you couldn&#39;t lower the speed</span>
<span class="cm">  of the drive.  Thanks to Tobias Ringstr|m &lt;tori@prosolvia.se&gt; for pointing</span>
<span class="cm">  this out and providing a simple fix.</span>
<span class="cm">  -- Fixed the procfs-unload-module bug with the fill_inode procfs callback.</span>
<span class="cm">  thanks to Andrea Arcangeli</span>
<span class="cm">  -- Fixed it so that the /proc entry now also shows up when cdrom is</span>
<span class="cm">  compiled into the kernel.  Before it only worked when loaded as a module.</span>

<span class="cm">  2.14 August 17, 1998 -- Erik Andersen &lt;andersee@debian.org&gt;</span>
<span class="cm">  -- Fixed a bug in cdrom_media_changed and handling of reporting that</span>
<span class="cm">  the media had changed for devices that _don&#39;t_ implement media_changed.  </span>
<span class="cm">  Thanks to Grant R. Guenther &lt;grant@torque.net&gt; for spotting this bug.</span>
<span class="cm">  -- Made a few things more pedanticly correct.</span>

<span class="cm">2.50 Oct 19, 1998 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- New maintainers! Erik was too busy to continue the work on the driver,</span>
<span class="cm">  so now Chris Zwilling &lt;chris@cloudnet.com&gt; and Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  will do their best to follow in his footsteps</span>
<span class="cm">  </span>
<span class="cm">  2.51 Dec 20, 1998 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Check if drive is capable of doing what we ask before blindly changing</span>
<span class="cm">  cdi-&gt;options in various ioctl.</span>
<span class="cm">  -- Added version to proc entry.</span>
<span class="cm">  </span>
<span class="cm">  2.52 Jan 16, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Fixed an error in open_for_data where we would sometimes not return</span>
<span class="cm">  the correct error value. Thanks Huba Gaspar &lt;huba@softcell.hu&gt;.</span>
<span class="cm">  -- Fixed module usage count - usage was based on /proc/sys/dev</span>
<span class="cm">  instead of /proc/sys/dev/cdrom. This could lead to an oops when other</span>
<span class="cm">  modules had entries in dev. Feb 02 - real bug was in sysctl.c where</span>
<span class="cm">  dev would be removed even though it was used. cdrom.c just illuminated</span>
<span class="cm">  that bug.</span>
<span class="cm">  </span>
<span class="cm">  2.53 Feb 22, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Fixup of several ioctl calls, in particular CDROM_SET_OPTIONS has</span>
<span class="cm">  been &quot;rewritten&quot; because capabilities and options aren&#39;t in sync. They</span>
<span class="cm">  should be...</span>
<span class="cm">  -- Added CDROM_LOCKDOOR ioctl. Locks the door and keeps it that way.</span>
<span class="cm">  -- Added CDROM_RESET ioctl.</span>
<span class="cm">  -- Added CDROM_DEBUG ioctl. Enable debug messages on-the-fly.</span>
<span class="cm">  -- Added CDROM_GET_CAPABILITY ioctl. This relieves userspace programs</span>
<span class="cm">  from parsing /proc/sys/dev/cdrom/info.</span>
<span class="cm">  </span>
<span class="cm">  2.54 Mar 15, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Check capability mask from low level driver when counting tracks as</span>
<span class="cm">  per suggestion from Corey J. Scotts &lt;cstotts@blue.weeg.uiowa.edu&gt;.</span>
<span class="cm">  </span>
<span class="cm">  2.55 Apr 25, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- autoclose was mistakenly checked against CDC_OPEN_TRAY instead of</span>
<span class="cm">  CDC_CLOSE_TRAY.</span>
<span class="cm">  -- proc info didn&#39;t mask against capabilities mask.</span>
<span class="cm">  </span>
<span class="cm">  3.00 Aug 5, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Unified audio ioctl handling across CD-ROM drivers. A lot of the</span>
<span class="cm">  code was duplicated before. Drives that support the generic packet</span>
<span class="cm">  interface are now being fed packets from here instead.</span>
<span class="cm">  -- First attempt at adding support for MMC2 commands - for DVD and</span>
<span class="cm">  CD-R(W) drives. Only the DVD parts are in now - the interface used is</span>
<span class="cm">  the same as for the audio ioctls.</span>
<span class="cm">  -- ioctl cleanups. if a drive couldn&#39;t play audio, it didn&#39;t get</span>
<span class="cm">  a change to perform device specific ioctls as well.</span>
<span class="cm">  -- Defined CDROM_CAN(CDC_XXX) for checking the capabilities.</span>
<span class="cm">  -- Put in sysctl files for autoclose, autoeject, check_media, debug,</span>
<span class="cm">  and lock.</span>
<span class="cm">  -- /proc/sys/dev/cdrom/info has been updated to also contain info about</span>
<span class="cm">  CD-Rx and DVD capabilities.</span>
<span class="cm">  -- Now default to checking media type.</span>
<span class="cm">  -- CDROM_SEND_PACKET ioctl added. The infrastructure was in place for</span>
<span class="cm">  doing this anyway, with the generic_packet addition.</span>
<span class="cm">  </span>
<span class="cm">  3.01 Aug 6, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Fix up the sysctl handling so that the option flags get set</span>
<span class="cm">  correctly.</span>
<span class="cm">  -- Fix up ioctl handling so the device specific ones actually get</span>
<span class="cm">  called :).</span>
<span class="cm">  </span>
<span class="cm">  3.02 Aug 8, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Fixed volume control on SCSI drives (or others with longer audio</span>
<span class="cm">  page).</span>
<span class="cm">  -- Fixed a couple of DVD minors. Thanks to Andrew T. Veliath</span>
<span class="cm">  &lt;andrewtv@usa.net&gt; for telling me and for having defined the various</span>
<span class="cm">  DVD structures and ioctls in the first place! He designed the original</span>
<span class="cm">  DVD patches for ide-cd and while I rearranged and unified them, the</span>
<span class="cm">  interface is still the same.</span>
<span class="cm">  </span>
<span class="cm">  3.03 Sep 1, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Moved the rest of the audio ioctls from the CD-ROM drivers here. Only</span>
<span class="cm">  CDROMREADTOCENTRY and CDROMREADTOCHDR are left.</span>
<span class="cm">  -- Moved the CDROMREADxxx ioctls in here.</span>
<span class="cm">  -- Defined the cdrom_get_last_written and cdrom_get_next_block as ioctls</span>
<span class="cm">  and exported functions.</span>
<span class="cm">  -- Erik Andersen &lt;andersen@xmission.com&gt; modified all SCMD_ commands</span>
<span class="cm">  to now read GPCMD_ for the new generic packet interface. All low level</span>
<span class="cm">  drivers are updated as well.</span>
<span class="cm">  -- Various other cleanups.</span>

<span class="cm">  3.04 Sep 12, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Fixed a couple of possible memory leaks (if an operation failed and</span>
<span class="cm">  we didn&#39;t free the buffer before returning the error).</span>
<span class="cm">  -- Integrated Uniform CD Changer handling from Richard Sharman</span>
<span class="cm">  &lt;rsharman@pobox.com&gt;.</span>
<span class="cm">  -- Defined CD_DVD and CD_CHANGER log levels.</span>
<span class="cm">  -- Fixed the CDROMREADxxx ioctls.</span>
<span class="cm">  -- CDROMPLAYTRKIND uses the GPCMD_PLAY_AUDIO_MSF command - too few</span>
<span class="cm">  drives supported it. We lose the index part, however.</span>
<span class="cm">  -- Small modifications to accommodate opens of /dev/hdc1, required</span>
<span class="cm">  for ide-cd to handle multisession discs.</span>
<span class="cm">  -- Export cdrom_mode_sense and cdrom_mode_select.</span>
<span class="cm">  -- init_cdrom_command() for setting up a cgc command.</span>
<span class="cm">  </span>
<span class="cm">  3.05 Oct 24, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Changed the interface for CDROM_SEND_PACKET. Before it was virtually</span>
<span class="cm">  impossible to send the drive data in a sensible way.</span>
<span class="cm">  -- Lowered stack usage in mmc_ioctl(), dvd_read_disckey(), and</span>
<span class="cm">  dvd_read_manufact.</span>
<span class="cm">  -- Added setup of write mode for packet writing.</span>
<span class="cm">  -- Fixed CDDA ripping with cdda2wav - accept much larger requests of</span>
<span class="cm">  number of frames and split the reads in blocks of 8.</span>

<span class="cm">  3.06 Dec 13, 1999 - Jens Axboe &lt;axboe@image.dk&gt;</span>
<span class="cm">  -- Added support for changing the region of DVD drives.</span>
<span class="cm">  -- Added sense data to generic command.</span>

<span class="cm">  3.07 Feb 2, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Do same &quot;read header length&quot; trick in cdrom_get_disc_info() as</span>
<span class="cm">  we do in cdrom_get_track_info() -- some drive don&#39;t obey specs and</span>
<span class="cm">  fail if they can&#39;t supply the full Mt Fuji size table.</span>
<span class="cm">  -- Deleted stuff related to setting up write modes. It has a different</span>
<span class="cm">  home now.</span>
<span class="cm">  -- Clear header length in mode_select unconditionally.</span>
<span class="cm">  -- Removed the register_disk() that was added, not needed here.</span>

<span class="cm">  3.08 May 1, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Fix direction flag in setup_send_key and setup_report_key. This</span>
<span class="cm">  gave some SCSI adapters problems.</span>
<span class="cm">  -- Always return -EROFS for write opens</span>
<span class="cm">  -- Convert to module_init/module_exit style init and remove some</span>
<span class="cm">  of the #ifdef MODULE stuff</span>
<span class="cm">  -- Fix several dvd errors - DVD_LU_SEND_ASF should pass agid,</span>
<span class="cm">  DVD_HOST_SEND_RPC_STATE did not set buffer size in cdb, and</span>
<span class="cm">  dvd_do_auth passed uninitialized data to drive because init_cdrom_command</span>
<span class="cm">  did not clear a 0 sized buffer.</span>
<span class="cm">  </span>
<span class="cm">  3.09 May 12, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Fix Video-CD on SCSI drives that don&#39;t support READ_CD command. In</span>
<span class="cm">  that case switch block size and issue plain READ_10 again, then switch</span>
<span class="cm">  back.</span>

<span class="cm">  3.10 Jun 10, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Fix volume control on CD&#39;s - old SCSI-II drives now use their own</span>
<span class="cm">  code, as doing MODE6 stuff in here is really not my intention.</span>
<span class="cm">  -- Use READ_DISC_INFO for more reliable end-of-disc.</span>

<span class="cm">  3.11 Jun 12, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Fix bug in getting rpc phase 2 region info.</span>
<span class="cm">  -- Reinstate &quot;correct&quot; CDROMPLAYTRKIND</span>

<span class="cm">   3.12 Oct 18, 2000 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Use quiet bit on packet commands not known to work</span>

<span class="cm">   3.20 Dec 17, 2003 - Jens Axboe &lt;axboe@suse.de&gt;</span>
<span class="cm">  -- Various fixes and lots of cleanups not listed :-)</span>
<span class="cm">  -- Locking fixes</span>
<span class="cm">  -- Mt Rainier support</span>
<span class="cm">  -- DVD-RAM write open fixes</span>

<span class="cm">  Nov 5 2001, Aug 8 2002. Modified by Andy Polyakov</span>
<span class="cm">  &lt;appro@fy.chalmers.se&gt; to support MMC-3 compliant DVD+RW units.</span>

<span class="cm">  Modified by Nigel Kukard &lt;nkukard@lbsd.net&gt; - support DVD+RW</span>
<span class="cm">  2.4.x patch by Andy Polyakov &lt;appro@fy.chalmers.se&gt;</span>

<span class="cm">-------------------------------------------------------------------------*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define REVISION &quot;Revision: 3.20&quot;</span>
<span class="cp">#define VERSION &quot;Id: cdrom.c 3.20 2003/12/17&quot;</span>

<span class="cm">/* I use an error-log mask to give fine grain control over the type of</span>
<span class="cm">   messages dumped to the system logs.  The available masks include: */</span>
<span class="cp">#define CD_NOTHING      0x0</span>
<span class="cp">#define CD_WARNING	0x1</span>
<span class="cp">#define CD_REG_UNREG	0x2</span>
<span class="cp">#define CD_DO_IOCTL	0x4</span>
<span class="cp">#define CD_OPEN		0x8</span>
<span class="cp">#define CD_CLOSE	0x10</span>
<span class="cp">#define CD_COUNT_TRACKS 0x20</span>
<span class="cp">#define CD_CHANGER	0x40</span>
<span class="cp">#define CD_DVD		0x80</span>

<span class="cm">/* Define this to remove _all_ the debugging messages */</span>
<span class="cm">/* #define ERRLOGMASK CD_NOTHING */</span>
<span class="cp">#define ERRLOGMASK CD_WARNING</span>
<span class="cm">/* #define ERRLOGMASK (CD_WARNING|CD_OPEN|CD_COUNT_TRACKS|CD_CLOSE) */</span>
<span class="cm">/* #define ERRLOGMASK (CD_WARNING|CD_REG_UNREG|CD_DO_IOCTL|CD_OPEN|CD_CLOSE|CD_COUNT_TRACKS) */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt; </span>
<span class="cp">#include &lt;linux/cdrom.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/blkpg.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/times.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* used to tell the module to turn on full debugging messages */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="cm">/* default compatibility mode */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">autoclose</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">autoeject</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">lockdoor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* will we ever get to use this... sigh. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">check_media_type</span><span class="p">;</span>
<span class="cm">/* automatically restart mrw format */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">mrw_format_restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">autoclose</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">autoeject</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lockdoor</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">check_media_type</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mrw_format_restart</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cdrom_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mrw_format_status</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;not mrw&quot;</span><span class="p">,</span>
	<span class="s">&quot;bgformat inactive&quot;</span><span class="p">,</span>
	<span class="s">&quot;bgformat active&quot;</span><span class="p">,</span>
	<span class="s">&quot;mrw complete&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mrw_address_space</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span> <span class="s">&quot;GAA&quot;</span> <span class="p">};</span>

<span class="cp">#if (ERRLOGMASK!=CD_NOTHING)</span>
<span class="cp">#define cdinfo(type, fmt, args...)			\</span>
<span class="cp">do {							\</span>
<span class="cp">	if ((ERRLOGMASK &amp; type) || debug == 1)		\</span>
<span class="cp">		pr_info(fmt, ##args);			\</span>
<span class="cp">} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define cdinfo(type, fmt, args...)			\</span>
<span class="cp">do {							\</span>
<span class="cp">	if (0 &amp;&amp; (ERRLOGMASK &amp; type) || debug == 1)	\</span>
<span class="cp">		pr_info(fmt, ##args);			\</span>
<span class="cp">} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* These are used to simplify getting data in from and back to user land */</span>
<span class="cp">#define IOCTL_IN(arg, type, in)					\</span>
<span class="cp">	if (copy_from_user(&amp;(in), (type __user *) (arg), sizeof (in)))	\</span>
<span class="cp">		return -EFAULT;</span>

<span class="cp">#define IOCTL_OUT(arg, type, out) \</span>
<span class="cp">	if (copy_to_user((type __user *) (arg), &amp;(out), sizeof (out)))	\</span>
<span class="cp">		return -EFAULT;</span>

<span class="cm">/* The (cdo-&gt;capability &amp; ~cdi-&gt;mask &amp; CDC_XXX) construct was used in</span>
<span class="cm">   a lot of places. This macro makes the code more clear. */</span>
<span class="cp">#define CDROM_CAN(type) (cdi-&gt;ops-&gt;capability &amp; ~cdi-&gt;mask &amp; (type))</span>

<span class="cm">/* used in the audio ioctls */</span>
<span class="cp">#define CHECKAUDIO if ((ret=check_for_audio_disc(cdi, cdo))) return ret</span>

<span class="cm">/*</span>
<span class="cm"> * Another popular OS uses 7 seconds as the hard timeout for default</span>
<span class="cm"> * commands, so it is a good choice for us as well.</span>
<span class="cm"> */</span>
<span class="cp">#define CDROM_DEF_TIMEOUT	(7 * HZ)</span>

<span class="cm">/* Not-exported routines. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">open_for_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span> <span class="n">cdi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">check_for_audio_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span> <span class="n">cdi</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span> <span class="n">cdo</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sanitize_format</span><span class="p">(</span><span class="k">union</span> <span class="n">cdrom_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> 
		<span class="n">u_char</span> <span class="o">*</span> <span class="n">curr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">requested</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mmc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">cdrom_get_last_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cdrom_get_next_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cdrom_count_tracks</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">tracktype</span><span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cdrom_mrw_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">disc_information</span> <span class="o">*</span><span class="n">di</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cdrom_sysctl_register</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cdrom_list</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_dummy_generic_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This macro makes sure we don&#39;t have to check on cdrom_device_ops</span>
<span class="cm"> * existence in the run-time routines below. Change_capability is a</span>
<span class="cm"> * hack to have the capability flags defined const, while we can still</span>
<span class="cm"> * change it here without gcc complaining at every line.</span>
<span class="cm"> */</span>
<span class="cp">#define ENSURE(call, bits) if (cdo-&gt;call == NULL) *change_capability &amp;= ~(bits)</span>

<span class="kt">int</span> <span class="nf">register_cdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">banner_printed</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
        <span class="kt">int</span> <span class="o">*</span><span class="n">change_capability</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">;</span> <span class="cm">/* hack */</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;entering register_cdrom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">banner_printed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Uniform CD-ROM driver &quot;</span> <span class="n">REVISION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">banner_printed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdrom_sysctl_register</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ENSURE</span><span class="p">(</span><span class="n">drive_status</span><span class="p">,</span> <span class="n">CDC_DRIVE_STATUS</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">check_events</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">media_changed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">change_capability</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">CDC_MEDIA_CHANGED</span> <span class="o">|</span> <span class="n">CDC_SELECT_DISC</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">tray_move</span><span class="p">,</span> <span class="n">CDC_CLOSE_TRAY</span> <span class="o">|</span> <span class="n">CDC_OPEN_TRAY</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">lock_door</span><span class="p">,</span> <span class="n">CDC_LOCK</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">select_speed</span><span class="p">,</span> <span class="n">CDC_SELECT_SPEED</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">get_last_session</span><span class="p">,</span> <span class="n">CDC_MULTI_SESSION</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">get_mcn</span><span class="p">,</span> <span class="n">CDC_MCN</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">CDC_RESET</span><span class="p">);</span>
	<span class="n">ENSURE</span><span class="p">(</span><span class="n">generic_packet</span><span class="p">,</span> <span class="n">CDC_GENERIC_PACKET</span><span class="p">);</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">n_minors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">CDO_USE_FFLAGS</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">autoclose</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CLOSE_TRAY</span><span class="p">))</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">CDO_AUTO_CLOSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoeject</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_OPEN_TRAY</span><span class="p">))</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">CDO_AUTO_EJECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lockdoor</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">CDO_LOCK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_media_type</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">CDO_CHECK_TYPE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MRW_W</span><span class="p">))</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">=</span> <span class="n">cdrom_mrw_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">=</span> <span class="n">CDDA_BPC_FULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">=</span> <span class="n">CDDA_OLD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">)</span>
		<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span> <span class="o">=</span> <span class="n">cdrom_dummy_generic_packet</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_REG_UNREG</span><span class="p">,</span> <span class="s">&quot;drive </span><span class="se">\&quot;</span><span class="s">/dev/%s</span><span class="se">\&quot;</span><span class="s"> registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdrom_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef ENSURE</span>

<span class="kt">void</span> <span class="nf">unregister_cdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;entering unregister_cdrom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">n_minors</span><span class="o">--</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_REG_UNREG</span><span class="p">,</span> <span class="s">&quot;drive </span><span class="se">\&quot;</span><span class="s">/dev/%s</span><span class="se">\&quot;</span><span class="s"> unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cdrom_get_media_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">media_event_desc</span> <span class="o">*</span><span class="n">med</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">event_header</span> <span class="o">*</span><span class="n">eh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">event_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_EVENT_STATUS_NOTIFICATION</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* IMMED */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* media event */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">med</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">nea</span> <span class="o">||</span> <span class="n">eh</span><span class="o">-&gt;</span><span class="n">notification_class</span> <span class="o">!=</span> <span class="mh">0x4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">med</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eh</span><span class="p">)],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">med</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * the first prototypes used 0x2c as the page code for the mrw mode page,</span>
<span class="cm"> * subsequently this was changed to 0x03. probe the one used by this drive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_probe_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">MRW_MODE_PC</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mrw_mode_page</span> <span class="o">=</span> <span class="n">MRW_MODE_PC</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">MRW_MODE_PC_PRE1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mrw_mode_page</span> <span class="o">=</span> <span class="n">MRW_MODE_PC_PRE1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_is_mrw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mrw_feature_desc</span> <span class="o">*</span><span class="n">mfd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">CDF_MRW</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mrw_feature_desc</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">feature_header</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">mfd</span><span class="o">-&gt;</span><span class="n">feature_code</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CDF_MRW</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">write</span> <span class="o">=</span> <span class="n">mfd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mrw_probe_pc</span><span class="p">(</span><span class="n">cdi</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_bgformat</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%sstarting format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cont</span> <span class="o">?</span> <span class="s">&quot;Re&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FmtData bit set (bit 4), format type is 1</span>
<span class="cm">	 */</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_WRITE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_FORMAT_UNIT</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 4 byte format list header, 8 byte format list descriptor</span>
<span class="cm">	 */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * nr_blocks field</span>
<span class="cm">	 */</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x24</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bgformat failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_bgformat_susp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">immed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_CLOSE_TRACK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Session = 1, Track = 0</span>
<span class="cm">	 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">immed</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_flush_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_FLUSH_CACHE</span><span class="p">;</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">di</span><span class="p">),</span><span class="n">disc_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">mrw_status</span> <span class="o">==</span> <span class="n">CDM_MRW_BGFORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;issuing MRW background format suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mrw_bgformat_susp</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">media_written</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_flush_cache</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_set_lba_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mode_page_header</span> <span class="o">*</span><span class="n">mph</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mrw_mode_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mode_page_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">mph</span><span class="o">-&gt;</span><span class="n">desc_length</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">mph</span><span class="o">-&gt;</span><span class="n">mode_data_length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">space</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_select</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: mrw address space %s selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mrw_address_space</span><span class="p">[</span><span class="n">space</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_get_random_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rwrt_feature_desc</span> <span class="o">*</span><span class="n">rfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">;</span>	<span class="cm">/* often 0x46 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">CDF_RWRT</span><span class="p">;</span>			<span class="cm">/* often 0x0020 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>		<span class="cm">/* often 0x18 */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">feature_header</span><span class="p">)],</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">rfd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_has_defect_mgt</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__be16</span> <span class="o">*</span><span class="n">feature_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">CDF_HWDM</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">feature_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">feature_header</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">feature_code</span><span class="p">)</span> <span class="o">==</span> <span class="n">CDF_HWDM</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_is_random_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rwrt_feature_desc</span> <span class="n">rfd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_random_writable</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CDF_RWRT</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="p">.</span><span class="n">feature_code</span><span class="p">))</span>
		<span class="o">*</span><span class="n">write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_media_erasable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">di</span><span class="p">),</span> <span class="n">n_first_track</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">di</span><span class="p">.</span><span class="n">erasable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: check RO bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_dvdram_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_media_erasable</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * allow writable open if media info read worked and media is</span>
<span class="cm">	 * erasable, _or_ if it fails since not all drives support it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_mrw_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * always reset to DMA lba space on open</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_mrw_set_lba_space</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">MRW_LBA_DMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed setting lba address space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">di</span><span class="p">),</span><span class="n">disc_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">.</span><span class="n">erasable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mrw_status</span>
<span class="cm">	 * 0	-	not MRW formatted</span>
<span class="cm">	 * 1	-	MRW bgformat started, but not running or complete</span>
<span class="cm">	 * 2	-	MRW bgformat in progress</span>
<span class="cm">	 * 3	-	MRW formatting complete</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;open: mrw_status &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mrw_format_status</span><span class="p">[</span><span class="n">di</span><span class="p">.</span><span class="n">mrw_status</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">.</span><span class="n">mrw_status</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">mrw_status</span> <span class="o">==</span> <span class="n">CDM_MRW_BGFORMAT_INACTIVE</span> <span class="o">&amp;&amp;</span>
			<span class="n">mrw_format_restart</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mrw_bgformat</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mo_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * obtain write protect information as per</span>
<span class="cm">	 * drivers/scsi/sd.c:sd_read_write_protect_flag</span>
<span class="cm">	 */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_ALL_PAGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_VENDOR_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_ALL_PAGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* drive gave us no info, let the user go ahead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ram_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rwrt_feature_desc</span> <span class="n">rfd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_has_defect_mgt</span><span class="p">(</span><span class="n">cdi</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_random_writable</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfd</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CDF_RWRT</span> <span class="o">==</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="p">.</span><span class="n">feature_code</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">!</span><span class="n">rfd</span><span class="p">.</span><span class="n">curr</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;can open for random write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_mmc3_profile</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">mmc3_profile</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_GET_CONFIGURATION</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Starting Feature Number */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>		<span class="cm">/* Allocation Length */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="n">mmc3_profile</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc3_profile</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span> <span class="o">=</span> <span class="n">mmc3_profile</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_is_dvd_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x12</span>:	<span class="cm">/* DVD-RAM	*/</span>
	<span class="k">case</span> <span class="mh">0x1A</span>:	<span class="cm">/* DVD+RW	*/</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * returns 0 for ok to open write, non-0 to disallow</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_open_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mrw</span><span class="p">,</span> <span class="n">mrw_write</span><span class="p">,</span> <span class="n">ram_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mrw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdrom_is_mrw</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrw_write</span><span class="p">))</span>
		<span class="n">mrw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MO_DRIVE</span><span class="p">))</span>
		<span class="n">ram_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cdrom_is_random_writable</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ram_write</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">mrw</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_MRW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">CDC_MRW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrw_write</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_MRW_W</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">CDC_MRW_W</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ram_write</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDC_RAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">CDC_RAM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MRW_W</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mrw_open_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_DVD_RAM</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_dvdram_open_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
 	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_RAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
 		 <span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CD_R</span><span class="o">|</span><span class="n">CDC_CD_RW</span><span class="o">|</span><span class="n">CDC_DVD</span><span class="o">|</span><span class="n">CDC_DVD_R</span><span class="o">|</span><span class="n">CDC_MRW</span><span class="o">|</span><span class="n">CDC_MO_DRIVE</span><span class="p">))</span>
 		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_ram_open_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MO_DRIVE</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mo_open_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdrom_is_dvd_rw</span><span class="p">(</span><span class="n">cdi</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_dvd_rw_close_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mmc3_profile</span> <span class="o">!=</span> <span class="mh">0x1a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CLOSE</span><span class="p">,</span> <span class="s">&quot;%s: No DVD+RW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">media_written</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CLOSE</span><span class="p">,</span> <span class="s">&quot;%s: DVD+RW media clean</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: dirty DVD+RW media, </span><span class="se">\&quot;</span><span class="s">finalizing</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_FLUSH_CACHE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_CLOSE_TRACK</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_CLOSE_TRACK</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	 <span class="cm">/* Close session */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">media_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_close_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	return cdrom_flush_cache(cdi);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* We use the open-option O_NONBLOCK to indicate that the</span>
<span class="cm"> * purpose of opening is only for subsequent ioctl() calls; no device</span>
<span class="cm"> * integrity checks are performed.</span>
<span class="cm"> *</span>
<span class="cm"> * We hope that all cd-player programs will adopt this convention. It</span>
<span class="cm"> * is in their own interest: device control becomes a lot easier</span>
<span class="cm"> * this way.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cdrom_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;entering cdrom_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 

	<span class="cm">/* open is event synchronization point, check events first */</span>
	<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="cm">/* if this was a O_NONBLOCK open and we should honor the flags,</span>
<span class="cm">	 * do a quick open without drive/disc integrity checks. */</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_NDELAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_USE_FFLAGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">open_for_data</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">cdrom_mmc3_profile</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_open_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_RAM</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">media_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;Use count for </span><span class="se">\&quot;</span><span class="s">/dev/%s</span><span class="se">\&quot;</span><span class="s"> now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_LOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;door unlocked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">open_for_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span> <span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">tracktype</span> <span class="n">tracks</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;entering open_for_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Check if the driver can report drive status.  If it can, we</span>
<span class="cm">	   can do clever things.  If it can&#39;t, well, we at least tried! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;drive_status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span> 
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">CDS_TRAY_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;the tray is open...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
			<span class="cm">/* can/may i close it? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CLOSE_TRAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_AUTO_CLOSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;trying to close the tray.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="n">ret</span><span class="o">=</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">tray_move</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. tried to close the tray but failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
					<span class="cm">/* Ignore the error from the low</span>
<span class="cm">					level driver.  We don&#39;t care why it</span>
<span class="cm">					couldn&#39;t close the tray.  We only care </span>
<span class="cm">					that there is no disc in the drive, </span>
<span class="cm">					since that is the _REAL_ problem here.*/</span>
					<span class="n">ret</span><span class="o">=-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. this drive can&#39;t close the tray.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="n">ret</span><span class="o">=-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Ok, the door should be closed now.. Check again */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">CDS_NO_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">CDS_TRAY_OPEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. the tray is still not closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;tray might not contain a medium.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span><span class="o">=-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;the tray is now closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="p">}</span>
		<span class="cm">/* the door should be closed now, check for the disc */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="o">!=</span><span class="n">CDS_DISC_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cdrom_count_tracks</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tracks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">error</span> <span class="o">==</span> <span class="n">CDS_NO_DISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. no disc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span><span class="o">=-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* CD-Players which don&#39;t use O_NONBLOCK, workman</span>
<span class="cm">	 * for example, need bit CDO_CHECK_TYPE cleared! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">data</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_CHECK_TYPE</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/* give people a warning shot, now that CDO_CHECK_TYPE</span>
<span class="cm">		       is the default case! */</span>
		    <span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. wrong media type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		    <span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;pid %d must open device O_NONBLOCK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
		    <span class="n">ret</span><span class="o">=-</span><span class="n">EMEDIUMTYPE</span><span class="p">;</span>
		    <span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
		    <span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;wrong media type, but CDO_CHECK_TYPE not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;all seems well, opening the device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 

	<span class="cm">/* all seems well, we can open the device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* open for data */</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;opening the device gave me %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span> 
	<span class="cm">/* After all this careful checking, we shouldn&#39;t have problems</span>
<span class="cm">	   opening the device, but we don&#39;t want the device locked if </span>
<span class="cm">	   this somehow fails... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;open device failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="k">goto</span> <span class="n">clean_up_and_return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_LOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;door locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;device opened successfully.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Something failed.  Try to unlock the drive, because some drivers</span>
<span class="cm">	(notably ide-cd) lock the drive after every command.  This produced</span>
<span class="cm">	a nasty bug where after mount failed, the drive would remain locked!  </span>
<span class="cm">	This ensures that the drive gets unlocked after a mount fails.  This </span>
<span class="cm">	is a goto to avoid bloating the driver with redundant code. */</span> 
<span class="nl">clean_up_and_return:</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;open failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;door unlocked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This code is similar to that in open_for_data. The routine is called</span>
<span class="cm">   whenever an audio play operation is requested.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_for_audio_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span> <span class="n">cdi</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span> <span class="n">cdo</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">tracktype</span> <span class="n">tracks</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;entering check_for_audio_disc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_CHECK_TYPE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;drive_status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span> 
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">CDS_TRAY_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;the tray is open...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
			<span class="cm">/* can/may i close it? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CLOSE_TRAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_AUTO_CLOSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;trying to close the tray.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="n">ret</span><span class="o">=</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">tray_move</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. tried to close tray but failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
					<span class="cm">/* Ignore the error from the low</span>
<span class="cm">					level driver.  We don&#39;t care why it</span>
<span class="cm">					couldn&#39;t close the tray.  We only care </span>
<span class="cm">					that there is no disc in the drive, </span>
<span class="cm">					since that is the _REAL_ problem here.*/</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. this driver can&#39;t close the tray.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Ok, the door should be closed now.. Check again */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">CDS_NO_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span><span class="o">==</span><span class="n">CDS_TRAY_OPEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. the tray is still not closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
			<span class="p">}</span>	
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="o">!=</span><span class="n">CDS_DISC_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;bummer. disc isn&#39;t ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>	
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_OPEN</span><span class="p">,</span> <span class="s">&quot;the tray is now closed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="p">}</span>	
	<span class="p">}</span>
	<span class="n">cdrom_count_tracks</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tracks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> 
		<span class="k">return</span><span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">audio</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMEDIUMTYPE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cdrom_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opened_for_data</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CLOSE</span><span class="p">,</span> <span class="s">&quot;entering cdrom_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CLOSE</span><span class="p">,</span> <span class="s">&quot;Use count for </span><span class="se">\&quot;</span><span class="s">/dev/%s</span><span class="se">\&quot;</span><span class="s"> now zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">cdrom_dvd_rw_close_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cdo</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CDC_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">keeplocked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CLOSE</span><span class="p">,</span> <span class="s">&quot;Unlocking door!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">opened_for_data</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_USE_FFLAGS</span><span class="p">)</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_NDELAY</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * flush cache on last write release</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_RAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&amp;&amp;</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">for_data</span><span class="p">)</span>
		<span class="n">cdrom_close_write</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>

	<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>      <span class="cm">/* last process that closes dev*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opened_for_data</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">CDO_AUTO_EJECT</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_OPEN_TRAY</span><span class="p">))</span>
			<span class="n">cdo</span><span class="o">-&gt;</span><span class="n">tray_move</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_mech_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">cdrom_changer_info</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanyo changer isn&#39;t spec compliant (doesn&#39;t use regular change</span>
<span class="cm">	 * LOAD_UNLOAD command, and it doesn&#39;t implement the mech status</span>
<span class="cm">	 * command below</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">nslots</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">curslot</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">length</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">length</span><span class="p">].</span><span class="n">disc_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">length</span><span class="p">].</span><span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_mechstat_header</span><span class="p">)</span> <span class="o">+</span>
		 <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_slot</span><span class="p">);</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_MECHANISM_STATUS</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_slot_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_changer_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CHANGER</span><span class="p">,</span> <span class="s">&quot;entering cdrom_slot_status()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_NO_INFO</span><span class="p">;</span>
	
	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_mech_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">info</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">disc_present</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">CDS_DISC_OK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">CDS_NO_DISC</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the number of slots for an ATAPI/SCSI cdrom, </span>
<span class="cm"> * return 1 if not a changer. </span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cdrom_number_of_slots</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nslots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_changer_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CHANGER</span><span class="p">,</span> <span class="s">&quot;entering cdrom_number_of_slots()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="cm">/* cdrom_read_mech_status requires a valid value for capacity: */</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdrom_read_mech_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nslots</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">nslots</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nslots</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* If SLOT &lt; 0, unload the current slot.  Otherwise, try to load SLOT. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_load_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CHANGER</span><span class="p">,</span> <span class="s">&quot;entering cdrom_load_unload()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_NONE</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_LOAD_UNLOAD</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* The Sanyo 3 CD changer uses byte 7 of the </span>
<span class="cm">	GPCMD_TEST_UNIT_READY to command to switch CDs instead of</span>
<span class="cm">	using the GPCMD_LOAD_UNLOAD opcode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">&amp;&amp;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_TEST_UNIT_READY</span><span class="p">;</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">sanyo_slot</span> <span class="o">=</span> <span class="n">slot</span> <span class="o">?</span> <span class="n">slot</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_select_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_changer_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curslot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CHANGER</span><span class="p">,</span> <span class="s">&quot;entering cdrom_select_disc()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_SELECT_DISC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDRIVE_CANT_DO_THIS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">media_changed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">CDSL_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set media changed bits, on both queues */</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">cdrom_load_unload</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_mech_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">curslot</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">curslot</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">keeplocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">CDSL_CURRENT</span><span class="p">)</span> <span class="p">{</span>
	    		<span class="k">return</span> <span class="n">curslot</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Specifying CDSL_CURRENT will attempt to load the currnet slot,</span>
<span class="cm">	which is useful if it had been previously unloaded.</span>
<span class="cm">	Whether it can or not, it returns the current slot. </span>
<span class="cm">	Similarly,  if slot happens to be the current one, we still</span>
<span class="cm">	try and load it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">CDSL_CURRENT</span><span class="p">)</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">curslot</span><span class="p">;</span>

	<span class="cm">/* set media changed bits on both queues */</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_load_unload</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">slot</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * As cdrom implements an extra ioctl consumer for media changed</span>
<span class="cm"> * event, it needs to buffer -&gt;check_events() output, such that event</span>
<span class="cm"> * is not lost for both the usual VFS and ioctl paths.</span>
<span class="cm"> * cdi-&gt;{vfs|ioctl}_events are used to buffer pending events for each</span>
<span class="cm"> * path.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX: Locking is non-existent.  cdi-&gt;ops-&gt;check_events() can be</span>
<span class="cm"> * called in parallel and buffering fields are accessed without any</span>
<span class="cm"> * exclusion.  The original media_changed code had the same problem.</span>
<span class="cm"> * It might be better to simply deprecate CDROM_MEDIA_CHANGED ioctl</span>
<span class="cm"> * and remove this cruft altogether.  It doesn&#39;t have much usefulness</span>
<span class="cm"> * at this point.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_update_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">clearing</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">vfs_events</span> <span class="o">|=</span> <span class="n">events</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ioctl_events</span> <span class="o">|=</span> <span class="n">events</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cdrom_check_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clearing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">cdrom_update_events</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">clearing</span><span class="p">);</span>
	<span class="n">events</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">vfs_events</span><span class="p">;</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">vfs_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">events</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_check_events</span><span class="p">);</span>

<span class="cm">/* We want to make media_changed accessible to the user through an</span>
<span class="cm"> * ioctl. The main problem now is that we must double-buffer the</span>
<span class="cm"> * low-level implementation, to assure that the VFS and the user both</span>
<span class="cm"> * see a medium change once.</span>
<span class="cm"> */</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">media_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">changed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MEDIA_CHANGED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* changed since last call? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">check_events</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">);</span>	<span class="cm">/* shouldn&#39;t be called from VFS path */</span>
		<span class="n">cdrom_update_events</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ioctl_events</span> <span class="o">&amp;</span> <span class="n">DISK_EVENT_MEDIA_CHANGE</span><span class="p">;</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ioctl_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">media_changed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>    <span class="cm">/* set bit on both queues */</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">media_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>         <span class="cm">/* clear bit */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cdrom_media_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This talks to the VFS, which doesn&#39;t like errors - just 1 or 0.  </span>
<span class="cm">	 * Returning &quot;0&quot; is always safe (media hasn&#39;t been changed). Do that </span>
<span class="cm">	 * if the low-level cdrom driver dosn&#39;t support media changed. */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">media_changed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MEDIA_CHANGED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">media_changed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* badly broken, I know. Is due for a fixup anytime. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_count_tracks</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">tracktype</span><span class="o">*</span> <span class="n">tracks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_tochdr</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_tocentry</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">audio</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">cdi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">xa</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_COUNT_TRACKS</span><span class="p">,</span> <span class="s">&quot;entering cdrom_count_tracks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="cm">/* Grab the TOC header so we can see how many tracks there are */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMREADTOCHDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">)</span>
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">CDS_NO_DISC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">CDS_NO_INFO</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>	
	<span class="cm">/* check what type of tracks are on this disc */</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">cdth_trk0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">header</span><span class="p">.</span><span class="n">cdth_trk1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="p">.</span><span class="n">cdte_track</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMREADTOCENTRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">=</span><span class="n">CDS_NO_INFO</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>	
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">cdte_ctrl</span> <span class="o">&amp;</span> <span class="n">CDROM_DATA_TRACK</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">cdi</span><span class="o">++</span><span class="p">;</span>
		    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> 
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">xa</span><span class="o">++</span><span class="p">;</span>
		    <span class="k">else</span>
			<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		    <span class="n">tracks</span><span class="o">-&gt;</span><span class="n">audio</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_COUNT_TRACKS</span><span class="p">,</span> <span class="s">&quot;track %d: format=%d, ctrl=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">cdte_ctrl</span><span class="p">);</span>
	<span class="p">}</span>	
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_COUNT_TRACKS</span><span class="p">,</span> <span class="s">&quot;disc has %d tracks: %d=audio %d=data %d=Cd-I %d=XA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">header</span><span class="p">.</span><span class="n">cdth_trk1</span><span class="p">,</span> <span class="n">tracks</span><span class="o">-&gt;</span><span class="n">audio</span><span class="p">,</span> <span class="n">tracks</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> 
		<span class="n">tracks</span><span class="o">-&gt;</span><span class="n">cdi</span><span class="p">,</span> <span class="n">tracks</span><span class="o">-&gt;</span><span class="n">xa</span><span class="p">);</span>
<span class="p">}</span>	

<span class="cm">/* Requests to the low-level drivers will /always/ be done in the</span>
<span class="cm">   following format convention:</span>

<span class="cm">   CDROM_LBA: all data-related requests.</span>
<span class="cm">   CDROM_MSF: all audio-related requests.</span>

<span class="cm">   However, a low-level implementation is allowed to refuse this</span>
<span class="cm">   request, and return information in its own favorite format.</span>

<span class="cm">   It doesn&#39;t make sense /at all/ to ask for a play_audio in LBA</span>
<span class="cm">   format, or ask for multi-session info in MSF format. However, for</span>
<span class="cm">   backward compatibility these format requests will be satisfied, but</span>
<span class="cm">   the requests to the low-level drivers will be sanitized in the more</span>
<span class="cm">   meaningful format indicated above.</span>
<span class="cm"> */</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">sanitize_format</span><span class="p">(</span><span class="k">union</span> <span class="n">cdrom_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		     <span class="n">u_char</span> <span class="o">*</span> <span class="n">curr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">requested</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">curr</span> <span class="o">==</span> <span class="n">requested</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>                 <span class="cm">/* nothing to be done! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested</span> <span class="o">==</span> <span class="n">CDROM_LBA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">lba</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span> <span class="o">+</span>
			<span class="mi">75</span> <span class="o">*</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                        <span class="cm">/* CDROM_MSF */</span>
		<span class="kt">int</span> <span class="n">lba</span> <span class="o">=</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">lba</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">%</span> <span class="mi">75</span><span class="p">;</span>
		<span class="n">lba</span> <span class="o">/=</span> <span class="mi">75</span><span class="p">;</span>
		<span class="n">lba</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">curr</span> <span class="o">=</span> <span class="n">requested</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_cdrom_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">CDROM_DEF_TIMEOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DVD handling */</span>

<span class="cp">#define copy_key(dest,src)	memcpy((dest), (src), sizeof(dvd_key))</span>
<span class="cp">#define copy_chal(dest,src)	memcpy((dest), (src), sizeof(dvd_challenge))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_report_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">agid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_REPORT_KEY</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span> <span class="o">|</span> <span class="p">(</span><span class="n">agid</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="k">case</span> <span class="mi">8</span>: <span class="k">case</span> <span class="mi">5</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="k">case</span> <span class="mi">4</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_READ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_send_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">agid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_SEND_KEY</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span> <span class="o">|</span> <span class="p">(</span><span class="n">agid</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="mi">6</span>: <span class="p">{</span>
			<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_WRITE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_do_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_authinfo</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">rpc_state_t</span> <span class="n">rpc_state</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* LU data send */</span>
	<span class="k">case</span> <span class="n">DVD_LU_SEND_AGID</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_AGID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsa</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsa</span><span class="p">.</span><span class="n">agid</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="cm">/* Returning data, let host change state */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVD_LU_SEND_KEY1</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_KEY1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsk</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">copy_key</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsk</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="cm">/* Returning data, let host change state */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVD_LU_SEND_CHALLENGE</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_CHALLENGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">copy_chal</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">chal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="cm">/* Returning data, let host change state */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Post-auth key */</span>
	<span class="k">case</span> <span class="n">DVD_LU_SEND_TITLE_KEY</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_TITLE_KEY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">lba</span><span class="p">;</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">cpm</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">cp_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">cgms</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">copy_key</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">lstk</span><span class="p">.</span><span class="n">title_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="cm">/* Returning data, let host change state */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVD_LU_SEND_ASF</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_ASF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsasf</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsasf</span><span class="p">.</span><span class="n">asf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* LU data receive (LU changes state) */</span>
	<span class="k">case</span> <span class="n">DVD_HOST_SEND_CHALLENGE</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_HOST_SEND_CHALLENGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_send_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">hsc</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">copy_chal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">hsc</span><span class="p">.</span><span class="n">chal</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DVD_LU_SEND_KEY1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DVD_HOST_SEND_KEY2</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_HOST_SEND_KEY2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_send_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">hsk</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa</span><span class="p">;</span>
		<span class="n">copy_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">hsk</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DVD_AUTH_FAILURE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DVD_AUTH_ESTABLISHED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Misc */</span>
	<span class="k">case</span> <span class="n">DVD_INVALIDATE_AGID</span>:
		<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_INVALIDATE_AGID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">lsa</span><span class="p">.</span><span class="n">agid</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Get region settings */</span>
	<span class="k">case</span> <span class="n">DVD_LU_SEND_RPC_STATE</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_LU_SEND_RPC_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">setup_report_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpc_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rpc_state_t</span><span class="p">));</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rpc_state</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lrpcs</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">rpc_state</span><span class="p">.</span><span class="n">type_code</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lrpcs</span><span class="p">.</span><span class="n">vra</span> <span class="o">=</span> <span class="n">rpc_state</span><span class="p">.</span><span class="n">vra</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lrpcs</span><span class="p">.</span><span class="n">ucca</span> <span class="o">=</span> <span class="n">rpc_state</span><span class="p">.</span><span class="n">ucca</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lrpcs</span><span class="p">.</span><span class="n">region_mask</span> <span class="o">=</span> <span class="n">rpc_state</span><span class="p">.</span><span class="n">region_mask</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">lrpcs</span><span class="p">.</span><span class="n">rpc_scheme</span> <span class="o">=</span> <span class="n">rpc_state</span><span class="p">.</span><span class="n">rpc_scheme</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Set region settings */</span>
	<span class="k">case</span> <span class="n">DVD_HOST_SEND_RPC_STATE</span>:
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DVD</span><span class="p">,</span> <span class="s">&quot;entering DVD_HOST_SEND_RPC_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">setup_send_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">hrpcs</span><span class="p">.</span><span class="n">pdrc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;Invalid DVD key ioctl (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_physical</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dvd_layer</span> <span class="o">*</span><span class="n">layer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">layer_num</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">physical</span><span class="p">.</span><span class="n">layer_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">layer_num</span> <span class="o">&gt;=</span> <span class="n">DVD_LAYERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_num</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * refrain from reporting errors on non-existing layers (mainly)</span>
<span class="cm">	 */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">layer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">physical</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">layer_num</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * place the data... really ugly, but at least we won&#39;t have to</span>
<span class="cm">	 * worry about endianess in userspace.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">layer</span><span class="p">));</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">book_version</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">book_type</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">min_rate</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">disc_size</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">layer_type</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">track_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">nlayers</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">track_density</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">linear_density</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">start_sector</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">end_sector</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">end_sector_l0</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">base</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">layer</span><span class="o">-&gt;</span><span class="n">bca</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_copyright</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">copyright</span><span class="p">.</span><span class="n">layer_num</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">copyright</span><span class="p">.</span><span class="n">cpst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">copyright</span><span class="p">.</span><span class="n">rmi</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_disckey</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">disckey</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">disckey</span><span class="p">.</span><span class="n">agid</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">disckey</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">disckey</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_bca</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">188</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">188</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;Received invalid BCA length (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bca</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_manufact</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DVD_STRUCTURE</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;Received invalid manufacture info length&quot;</span>
				   <span class="s">&quot; (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;Received invalid manufacture info &quot;</span>
					<span class="s">&quot;length (%d): truncating to 2048</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">manufact</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dvd_read_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DVD_STRUCT_PHYSICAL</span>:
		<span class="k">return</span> <span class="n">dvd_read_physical</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DVD_STRUCT_COPYRIGHT</span>:
		<span class="k">return</span> <span class="n">dvd_read_copyright</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DVD_STRUCT_DISCKEY</span>:
		<span class="k">return</span> <span class="n">dvd_read_disckey</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DVD_STRUCT_BCA</span>:
		<span class="k">return</span> <span class="n">dvd_read_bca</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">DVD_STRUCT_MANUFACT</span>:
		<span class="k">return</span> <span class="n">dvd_read_manufact</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
		
	<span class="nl">default:</span>
		<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span> <span class="s">&quot;: Invalid DVD structure read requested (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cdrom_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">page_code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_MODE_SENSE_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_code</span> <span class="o">|</span> <span class="p">(</span><span class="n">page_control</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_READ</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cdrom_mode_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_MODE_SELECT_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>		<span class="cm">/* PF */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_WRITE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cdrom_subchnl</span> <span class="o">*</span><span class="n">subchnl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mcn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_SUBCHANNEL</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>     <span class="cm">/* MSF addressing */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>  <span class="cm">/* request subQ data */</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcn</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_audiostatus</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_ctrl</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_trk</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_ind</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_reladdr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_reladdr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_reladdr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_absaddr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_absaddr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">subchnl</span><span class="o">-&gt;</span><span class="n">cdsc_absaddr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Specific READ_10 interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lba</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">blocksize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nblocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">nblocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="n">nblocks</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* very generic interface for reading the various types of blocks */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nblocks</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blksize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_CD</span><span class="p">;</span>
	<span class="cm">/* expected sector size - cdda,mode1,etc. */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">format</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* starting address */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* number of blocks */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nblocks</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">nblocks</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">blksize</span> <span class="o">*</span> <span class="n">nblocks</span><span class="p">;</span>
	
	<span class="cm">/* set the header info returned */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CD_FRAMESIZE_RAW0</span>	: <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CD_FRAMESIZE_RAW1</span>	: <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CD_FRAMESIZE_RAW</span>	: <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">default</span>			<span class="o">:</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_cdda_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nframes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * start with will ra.nframes size, back down if alloc fails</span>
<span class="cm">	 */</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CD_FRAMESIZE_RAW</span> <span class="o">*</span> <span class="n">nr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_READ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="n">nframes</span><span class="p">)</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="n">nframes</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_block</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CD_FRAMESIZE_RAW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">CD_FRAMESIZE_RAW</span> <span class="o">*</span> <span class="n">nr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ubuf</span> <span class="o">+=</span> <span class="n">CD_FRAMESIZE_RAW</span> <span class="o">*</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">nframes</span> <span class="o">-=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">lba</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_cdda_bpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nframes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bio</span> <span class="o">*</span><span class="n">bio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nframes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">nframes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">==</span> <span class="n">CDDA_BPC_SINGLE</span><span class="p">)</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE_RAW</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue_max_sectors</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">CD_FRAMESIZE_RAW</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">CD_FRAMESIZE_RAW</span><span class="p">;</span>

		<span class="n">rq</span> <span class="o">=</span> <span class="n">blk_get_request</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">READ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">blk_rq_map_user</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_CD</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lba</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xf8</span><span class="p">;</span>

		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">cmd_type</span> <span class="o">=</span> <span class="n">REQ_TYPE_BLOCK_PC</span><span class="p">;</span>
		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">bio</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_execute_rq</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">request_sense</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sense_key</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_unmap_user</span><span class="p">(</span><span class="n">bio</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">blk_put_request</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nframes</span> <span class="o">-=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">lba</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="n">ubuf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_read_cdda</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">lba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nframes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">==</span> <span class="n">CDDA_OLD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cdrom_read_cdda_old</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">nframes</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="cm">/*</span>
<span class="cm">	 * for anything else than success and io error, we need to retry</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_cdda_bpc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">nframes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I&#39;ve seen drives get sense 4/8/3 udma crc errors on multi</span>
<span class="cm">	 * frame dma, so drop to single frame dma if we need to</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">==</span> <span class="n">CDDA_BPC_FULL</span> <span class="o">&amp;&amp;</span> <span class="n">nframes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;dropping to single frame dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">=</span> <span class="n">CDDA_BPC_SINGLE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * so we have an io error of some sort with multi frame dma. if the</span>
<span class="cm">	 * condition wasn&#39;t a hardware error</span>
<span class="cm">	 * problems, not for any error</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span> <span class="o">!=</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span> <span class="o">!=</span> <span class="mh">0x0b</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;dropping to old style cdda (sense=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">last_sense</span><span class="p">);</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">cdda_method</span> <span class="o">=</span> <span class="n">CDDA_OLD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdrom_read_cdda_old</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">nframes</span><span class="p">);</span>	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_multisession</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_multisession</span> <span class="n">ms_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">requested_format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMMULTISESSION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CDC_MULTI_SESSION</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms_info</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">requested_format</span> <span class="o">=</span> <span class="n">ms_info</span><span class="p">.</span><span class="n">addr_format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested_format</span> <span class="o">!=</span> <span class="n">CDROM_MSF</span> <span class="o">&amp;&amp;</span> <span class="n">requested_format</span> <span class="o">!=</span> <span class="n">CDROM_LBA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ms_info</span><span class="p">.</span><span class="n">addr_format</span> <span class="o">=</span> <span class="n">CDROM_LBA</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_last_session</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms_info</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms_info</span><span class="p">.</span><span class="n">addr_format</span><span class="p">,</span> <span class="n">requested_format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ms_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;CDROMMULTISESSION successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_eject</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMEJECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_OPEN_TRAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">keeplocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tray_move</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_closetray</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMCLOSETRAY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CLOSE_TRAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tray_move</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_eject_sw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMEJECT_SW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_OPEN_TRAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">keeplocked</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CDO_AUTO_CLOSE</span> <span class="o">|</span> <span class="n">CDO_AUTO_EJECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
		<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">CDO_AUTO_CLOSE</span> <span class="o">|</span> <span class="n">CDO_AUTO_EJECT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_media_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_changer_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_MEDIA_CHANGED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_MEDIA_CHANGED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="cm">/* cannot select disc or select current disc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_SELECT_DISC</span><span class="p">)</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">==</span> <span class="n">CDSL_CURRENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">media_changed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_mech_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">arg</span><span class="p">].</span><span class="n">change</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_set_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_SET_OPTIONS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Options need to be in sync with capability.</span>
<span class="cm">	 * Too late for that, so we have to check each one separately.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDO_USE_FFLAGS</span>:
	<span class="k">case</span> <span class="n">CDO_CHECK_TYPE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CDO_LOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
	<span class="cm">/* default is basically CDO_[AUTO_CLOSE|AUTO_EJECT] */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_clear_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_CLEAR_OPTIONS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_select_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_SELECT_SPEED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_SELECT_SPEED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">select_speed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_select_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_SELECT_DISC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_SELECT_DISC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">CDSL_CURRENT</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span> <span class="o">!=</span> <span class="n">CDSL_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * -&gt;select_disc is a hook to allow a driver-specific way of</span>
<span class="cm">	 * seleting disc.  However, since there is no equivalent hook for</span>
<span class="cm">	 * cdrom_slot_status this may not actually be useful...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">select_disc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">select_disc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_CHANGER</span><span class="p">,</span> <span class="s">&quot;Using generic cdrom_select_disc()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdrom_select_disc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_RESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">invalidate_bdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_lock_door</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;%socking door.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span> <span class="o">?</span> <span class="s">&quot;L&quot;</span> <span class="o">:</span> <span class="s">&quot;Unl&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDRIVE_CANT_DO_THIS</span><span class="p">;</span>

	<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">keeplocked</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t unlock the door on multiple opens by default, but allow</span>
<span class="cm">	 * root to do so.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;%sabling debug.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span> <span class="o">?</span> <span class="s">&quot;En&quot;</span> <span class="o">:</span> <span class="s">&quot;Dis&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_get_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_GET_CAPABILITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following function is implemented, although very few audio</span>
<span class="cm"> * discs give Universal Product Code information, which should just be</span>
<span class="cm"> * the Medium Catalog Number on the box.  Note, that the way the code</span>
<span class="cm"> * is written on the CD is /not/ uniform across all discs!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_get_mcn</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_mcn</span> <span class="n">mcn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_GET_MCN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CDC_MCN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mcn</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mcn</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;CDROM_GET_MCN successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_drive_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_DRIVE_STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CDC_DRIVE_STATUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_SELECT_DISC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="n">CDSL_CURRENT</span> <span class="o">||</span> <span class="n">arg</span> <span class="o">==</span> <span class="n">CDSL_NONE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDSL_CURRENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">arg</span> <span class="o">&gt;=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdrom_slot_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ok, this is where problems start.  The current interface for the</span>
<span class="cm"> * CDROM_DISC_STATUS ioctl is flawed.  It makes the false assumption that</span>
<span class="cm"> * CDs are all CDS_DATA_1 or all CDS_AUDIO, etc.  Unfortunately, while this</span>
<span class="cm"> * is often the case, it is also very common for CDs to have some tracks</span>
<span class="cm"> * with data, and some tracks with audio.  Just because I feel like it,</span>
<span class="cm"> * I declare the following to be the best way to cope.  If the CD has ANY</span>
<span class="cm"> * data tracks on it, it will be returned as a data CD.  If it has any XA</span>
<span class="cm"> * tracks, I will return it as that.  Now I could simplify this interface</span>
<span class="cm"> * by combining these  returns with the above, but this more clearly</span>
<span class="cm"> * demonstrates the problem with the current interface.  Too bad this</span>
<span class="cm"> * wasn&#39;t designed to use bitmasks...         -Erik</span>
<span class="cm"> *</span>
<span class="cm"> * Well, now we have the option CDS_MIXED: a mixed-type CD.</span>
<span class="cm"> * User level programmers might feel the ioctl is not very useful.</span>
<span class="cm"> *					---david</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_disc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tracktype</span> <span class="n">tracks</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_DISC_STATUS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cdrom_count_tracks</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tracks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tracks</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Policy mode on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">audio</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tracks</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tracks</span><span class="p">.</span><span class="n">cdi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tracks</span><span class="p">.</span><span class="n">xa</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">CDS_AUDIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">CDS_MIXED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">cdi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_XA_2_2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">xa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_XA_2_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tracks</span><span class="p">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">CDS_DATA_1</span><span class="p">;</span>
	<span class="cm">/* Policy mode off */</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_WARNING</span><span class="p">,</span><span class="s">&quot;This disc doesn&#39;t have any tracks I recognize!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">CDS_NO_INFO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_changer_nslots</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_CHANGER_NSLOTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_get_subchnl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_subchnl</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">requested</span><span class="p">,</span> <span class="n">back</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* cdinfo(CD_DO_IOCTL,&quot;entering CDROMSUBCHNL\n&quot;);*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">requested</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested</span> <span class="o">!=</span> <span class="n">CDROM_MSF</span> <span class="o">&amp;&amp;</span> <span class="n">requested</span> <span class="o">!=</span> <span class="n">CDROM_LBA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMSUBCHNL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">back</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">;</span> <span class="cm">/* local copy */</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_absaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">back</span><span class="p">,</span> <span class="n">requested</span><span class="p">);</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_reladdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">,</span> <span class="n">requested</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;CDROMSUBCHNL successful\n&quot;); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_read_tochdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_tochdr</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;entering CDROMREADTOCHDR\n&quot;); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMREADTOCHDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;CDROMREADTOCHDR successful\n&quot;); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_read_tocentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_tocentry</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">requested_format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;entering CDROMREADTOCENTRY\n&quot;); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">requested_format</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">requested_format</span> <span class="o">!=</span> <span class="n">CDROM_MSF</span> <span class="o">&amp;&amp;</span> <span class="n">requested_format</span> <span class="o">!=</span> <span class="n">CDROM_LBA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* make interface to low-level uniform */</span>
	<span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMREADTOCENTRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="n">cdte_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">.</span><span class="n">cdte_format</span><span class="p">,</span> <span class="n">requested_format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;CDROMREADTOCENTRY successful\n&quot;); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_play_msf</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_msf</span> <span class="n">msf</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMPLAYMSF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msf</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msf</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMPLAYMSF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_play_trkind</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_ti</span> <span class="n">ti</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMPLAYTRKIND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ti</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_for_audio_disc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMPLAYTRKIND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_volctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_volctrl</span> <span class="n">volume</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMVOLCTRL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">volume</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMVOLCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_volread</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_volctrl</span> <span class="n">volume</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMVOLREAD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMVOLREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">volume</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_ioctl_audioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;doing audio ioctl (start/stop/pause/resume)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_PLAY_AUDIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_for_audio_disc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Just about every imaginable ioctl is supported in the Uniform layer</span>
<span class="cm"> * these days.</span>
<span class="cm"> * ATAPI / SCSI specific code now mainly resides in mmc_ioctl().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cdrom_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		<span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try the generic SCSI command ioctl&#39;s first.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_cmd_blk_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMMULTISESSION</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_multisession</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMEJECT</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_eject</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMCLOSETRAY</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_closetray</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMEJECT_SW</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_eject_sw</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_MEDIA_CHANGED</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_media_changed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_SET_OPTIONS</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_set_options</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_CLEAR_OPTIONS</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_clear_options</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_SELECT_SPEED</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_select_speed</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_SELECT_DISC</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_select_disc</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMRESET</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_reset</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_LOCKDOOR</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_lock_door</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_DEBUG</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_debug</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_GET_CAPABILITY</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_get_capability</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_GET_MCN</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_get_mcn</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_DRIVE_STATUS</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_drive_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_DISC_STATUS</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_disc_status</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_CHANGER_NSLOTS</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_changer_nslots</span><span class="p">(</span><span class="n">cdi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the ioctls that are implemented through the generic_packet()</span>
<span class="cm">	 * interface. this may look at bit funny, but if -ENOTTY is</span>
<span class="cm">	 * returned that particular ioctl is not implemented and we</span>
<span class="cm">	 * let it go through the device specific ones.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_GENERIC_PACKET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: most of the cdinfo() calls are commented out here,</span>
<span class="cm">	 * because they fill up the sys log when CD players poll</span>
<span class="cm">	 * the drive.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMSUBCHNL</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_get_subchnl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMREADTOCHDR</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_read_tochdr</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMREADTOCENTRY</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_read_tocentry</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMPLAYMSF</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_play_msf</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMPLAYTRKIND</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_play_trkind</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMVOLCTRL</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_volctrl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMVOLREAD</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_volread</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMSTART</span>:
	<span class="k">case</span> <span class="n">CDROMSTOP</span>:
	<span class="k">case</span> <span class="n">CDROMPAUSE</span>:
	<span class="k">case</span> <span class="n">CDROMRESUME</span>:
		<span class="k">return</span> <span class="n">cdrom_ioctl_audioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Required when we need to use READ_10 to issue other than 2048 block</span>
<span class="cm"> * reads</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_switch_blocksize</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">modesel_head</span> <span class="n">mh</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mh</span><span class="p">));</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_desc_length</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_length_med</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_length_lo</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">));</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mh</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_WRITE</span><span class="p">;</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_desc_length</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_length_med</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mh</span><span class="p">.</span><span class="n">block_length_lo</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request_sense</span> <span class="n">sense</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_msf</span> <span class="n">msf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMREADRAW</span>:
		<span class="n">blocksize</span> <span class="o">=</span> <span class="n">CD_FRAMESIZE_RAW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CDROMREADMODE1</span>:
		<span class="n">blocksize</span> <span class="o">=</span> <span class="n">CD_FRAMESIZE</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CDROMREADMODE2</span>:
		<span class="n">blocksize</span> <span class="o">=</span> <span class="n">CD_FRAMESIZE_RAW0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_msf</span><span class="p">,</span> <span class="n">msf</span><span class="p">);</span>
	<span class="n">lba</span> <span class="o">=</span> <span class="n">msf_to_lba</span><span class="p">(</span><span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_min0</span><span class="p">,</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_sec0</span><span class="p">,</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_frame0</span><span class="p">);</span>
	<span class="cm">/* FIXME: we need upper bound checking, too!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">blocksize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sense</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sense</span><span class="p">));</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_READ</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_block</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">sense</span><span class="p">.</span><span class="n">sense_key</span> <span class="o">==</span> <span class="mh">0x05</span> <span class="o">&amp;&amp;</span>
		   <span class="n">sense</span><span class="p">.</span><span class="n">asc</span> <span class="o">==</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span>
		   <span class="n">sense</span><span class="p">.</span><span class="n">ascq</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * SCSI-II devices are not required to support</span>
<span class="cm">		 * READ_CD, so let&#39;s try switching block size</span>
<span class="cm">		 */</span>
		<span class="cm">/* FIXME: switch back again... */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_switch_blocksize</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">sense</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_cd</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">cdrom_switch_blocksize</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_read_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_read_audio</span> <span class="n">ra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lba</span><span class="p">;</span>

	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_read_audio</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">addr_format</span> <span class="o">==</span> <span class="n">CDROM_MSF</span><span class="p">)</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="n">msf_to_lba</span><span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span>
				 <span class="n">ra</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">second</span><span class="p">,</span>
				 <span class="n">ra</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">msf</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ra</span><span class="p">.</span><span class="n">addr_format</span> <span class="o">==</span> <span class="n">CDROM_LBA</span><span class="p">)</span>
		<span class="n">lba</span> <span class="o">=</span> <span class="n">ra</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">lba</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* FIXME: we need upper bound checking, too!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lba</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ra</span><span class="p">.</span><span class="n">nframes</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ra</span><span class="p">.</span><span class="n">nframes</span> <span class="o">&gt;</span> <span class="n">CD_FRAMES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cdrom_read_cdda</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">ra</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">lba</span><span class="p">,</span> <span class="n">ra</span><span class="p">.</span><span class="n">nframes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_subchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_subchnl</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">requested</span><span class="p">,</span> <span class="n">back</span><span class="p">;</span>
	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_subchnl</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="n">requested</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">requested</span> <span class="o">==</span> <span class="n">CDROM_MSF</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">requested</span> <span class="o">==</span> <span class="n">CDROM_LBA</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_read_subchannel</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">back</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">;</span> <span class="cm">/* local copy */</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_absaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">back</span><span class="p">,</span> <span class="n">requested</span><span class="p">);</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_reladdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">.</span><span class="n">cdsc_format</span><span class="p">,</span> <span class="n">requested</span><span class="p">);</span>
	<span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_subchnl</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="cm">/* cdinfo(CD_DO_IOCTL, &quot;CDROMSUBCHNL successful\n&quot;); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_play_msf</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_msf</span> <span class="n">msf</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMPLAYMSF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_msf</span><span class="p">,</span> <span class="n">msf</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_PLAY_AUDIO_MSF</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_min0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_sec0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_frame0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_min1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_sec1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">msf</span><span class="p">.</span><span class="n">cdmsf_frame1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_play_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdrom_blk</span> <span class="n">blk</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMPLAYBLK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_blk</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_PLAY_AUDIO_10</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="n">from</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="n">from</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="n">from</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">blk</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">blk</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_volctrl</span> <span class="n">volctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">mask</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMVOLUME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_volctrl</span><span class="p">,</span> <span class="n">volctrl</span><span class="p">);</span>

	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_AUDIO_CTL_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		
	<span class="cm">/* originally the code depended on buffer[1] to determine</span>
<span class="cm">	   how much data is available for transfer. buffer[1] is</span>
<span class="cm">	   unfortunately ambigious and the only reliable way seem</span>
<span class="cm">	   to be to simply skip over the block descriptor... */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;</span> <span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">,</span>
					<span class="n">GPMODE_AUDIO_CTL_PAGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GPMODE_AUDIO_CTL_PAGE</span> <span class="o">||</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* now we have the current volume settings. if it was only</span>
<span class="cm">	   a CDROMVOLREAD, return these values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CDROMVOLREAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volctrl</span><span class="p">.</span><span class="n">channel0</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">volctrl</span><span class="p">.</span><span class="n">channel1</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">volctrl</span><span class="p">.</span><span class="n">channel2</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">volctrl</span><span class="p">.</span><span class="n">channel3</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">15</span><span class="p">];</span>
		<span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdrom_volctrl</span><span class="p">,</span> <span class="n">volctrl</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="cm">/* get the volume mask */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_mode_sense</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">,</span> <span class="n">GPMODE_AUDIO_CTL_PAGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="n">volctrl</span><span class="p">.</span><span class="n">channel0</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">9</span><span class="p">];</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">volctrl</span><span class="p">.</span><span class="n">channel1</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">11</span><span class="p">];</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">volctrl</span><span class="p">.</span><span class="n">channel2</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">13</span><span class="p">];</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">volctrl</span><span class="p">.</span><span class="n">channel3</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">15</span><span class="p">];</span>

	<span class="cm">/* set volume */</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cgc</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdrom_mode_select</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_start_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMSTART/CDROMSTOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_START_STOP_UNIT</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CDROMSTART</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_pause_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROMPAUSE/CDROMRESUME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_PAUSE_RESUME</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CDROMRESUME</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cgc</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">=</span> <span class="n">CGC_DATA_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_dvd_read_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
						<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">packet_command</span> <span class="o">*</span><span class="n">cgc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dvd_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dvd_struct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_DVD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering DVD_READ_STRUCT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvd_read_struct</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">cgc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_dvd_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dvd_authinfo</span> <span class="n">ai</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_DVD</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering DVD_AUTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dvd_authinfo</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dvd_do_auth</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dvd_authinfo</span><span class="p">,</span> <span class="n">ai</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_next_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
						<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_NEXT_WRITABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_next_writable</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="nf">mmc_ioctl_cdrom_last_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span>
						<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdinfo</span><span class="p">(</span><span class="n">CD_DO_IOCTL</span><span class="p">,</span> <span class="s">&quot;entering CDROM_LAST_WRITTEN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_last_written</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">last</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cgc</span><span class="p">));</span>

	<span class="cm">/* build a unified command and queue it through</span>
<span class="cm">	   cdo-&gt;generic_packet() */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CDROMREADRAW</span>:
	<span class="k">case</span> <span class="n">CDROMREADMODE1</span>:
	<span class="k">case</span> <span class="n">CDROMREADMODE2</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_read_data</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMREADAUDIO</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_read_audio</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMSUBCHNL</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_subchannel</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMPLAYMSF</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_play_msf</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMPLAYBLK</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_play_blk</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMVOLCTRL</span>:
	<span class="k">case</span> <span class="n">CDROMVOLREAD</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_volume</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMSTART</span>:
	<span class="k">case</span> <span class="n">CDROMSTOP</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_start_stop</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROMPAUSE</span>:
	<span class="k">case</span> <span class="n">CDROMRESUME</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_pause_resume</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DVD_READ_STRUCT</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_dvd_read_struct</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">DVD_AUTH</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_dvd_auth</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_NEXT_WRITABLE</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_next_writable</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CDROM_LAST_WRITTEN</span>:
		<span class="k">return</span> <span class="n">mmc_ioctl_cdrom_last_written</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">userptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_get_track_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">track</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">type</span><span class="p">,</span>
			 <span class="n">track_information</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_TRACK_RZONE_INFO</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="n">buflen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">track_information_length</span><span class="p">)</span> <span class="o">+</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">track_information_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">track_information</span><span class="p">))</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">track_information</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* return actual fill size */</span>
	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires CD R/RW */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_get_disc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="n">disc_information</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_ops</span> <span class="o">*</span><span class="n">cdo</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">packet_command</span> <span class="n">cgc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="cm">/* set up command and get the disc info */</span>
	<span class="n">init_cdrom_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cgc</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">),</span> <span class="n">CGC_DATA_READ</span><span class="p">);</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">GPCMD_READ_DISC_INFO</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cgc</span><span class="p">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* not all drives have the same disc_info length, so requeue</span>
<span class="cm">	 * packet with the length the drive tells us it can supply</span>
<span class="cm">	 */</span>
	<span class="n">buflen</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_information_length</span><span class="p">)</span> <span class="o">+</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">disc_information_length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disc_information</span><span class="p">))</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">disc_information</span><span class="p">);</span>

	<span class="n">cgc</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgc</span><span class="p">.</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdo</span><span class="o">-&gt;</span><span class="n">generic_packet</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cgc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* return actual fill size */</span>
	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the last written block on the CD-R media. this is for the udf</span>
<span class="cm">   file system. */</span>
<span class="kt">int</span> <span class="nf">cdrom_get_last_written</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_written</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_tocentry</span> <span class="n">toc</span><span class="p">;</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="n">track_information</span> <span class="n">ti</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">last_track</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ti_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_GENERIC_PACKET</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">use_toc</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">di</span><span class="p">),</span> <span class="n">last_track_lsb</span><span class="p">)</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">last_track_lsb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">use_toc</span><span class="p">;</span>

	<span class="cm">/* if unit didn&#39;t return msb, it&#39;s zeroed by cdrom_get_disc_info */</span>
	<span class="n">last_track</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">last_track_msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">di</span><span class="p">.</span><span class="n">last_track_lsb</span><span class="p">;</span>
	<span class="n">ti_size</span> <span class="o">=</span> <span class="n">cdrom_get_track_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">track_start</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">use_toc</span><span class="p">;</span>

	<span class="cm">/* if this track is blank, try the previous. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_track</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">use_toc</span><span class="p">;</span>
		<span class="n">last_track</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ti_size</span> <span class="o">=</span> <span class="n">cdrom_get_track_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ti_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">track_size</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_size</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">use_toc</span><span class="p">;</span>

	<span class="cm">/* if last recorded field is valid, return it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">lra_v</span> <span class="o">&amp;&amp;</span> <span class="n">ti_size</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">last_rec_address</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">last_rec_address</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">last_written</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">last_rec_address</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* make it up instead */</span>
		<span class="o">*</span><span class="n">last_written</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_start</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">track_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">free_blocks</span><span class="p">)</span>
			<span class="o">*</span><span class="n">last_written</span> <span class="o">-=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">free_blocks</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* this is where we end up if the drive either can&#39;t do a</span>
<span class="cm">	   GPCMD_READ_DISC_INFO or GPCMD_READ_TRACK_RZONE_INFO or if</span>
<span class="cm">	   it doesn&#39;t give enough information or fails. then we return</span>
<span class="cm">	   the toc contents. */</span>
<span class="nl">use_toc:</span>
	<span class="n">toc</span><span class="p">.</span><span class="n">cdte_format</span> <span class="o">=</span> <span class="n">CDROM_MSF</span><span class="p">;</span>
	<span class="n">toc</span><span class="p">.</span><span class="n">cdte_track</span> <span class="o">=</span> <span class="n">CDROM_LEADOUT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">audio_ioctl</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">CDROMREADTOCENTRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sanitize_format</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toc</span><span class="p">.</span><span class="n">cdte_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">toc</span><span class="p">.</span><span class="n">cdte_format</span><span class="p">,</span> <span class="n">CDROM_LBA</span><span class="p">);</span>
	<span class="o">*</span><span class="n">last_written</span> <span class="o">=</span> <span class="n">toc</span><span class="p">.</span><span class="n">cdte_addr</span><span class="p">.</span><span class="n">lba</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the next writable block. also for udf file system. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_get_next_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">next_writable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disc_information</span> <span class="n">di</span><span class="p">;</span>
	<span class="n">track_information</span> <span class="n">ti</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">last_track</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ti_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_GENERIC_PACKET</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">use_last_written</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_disc_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">di</span><span class="p">),</span> <span class="n">last_track_lsb</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">last_track_lsb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">use_last_written</span><span class="p">;</span>

	<span class="cm">/* if unit didn&#39;t return msb, it&#39;s zeroed by cdrom_get_disc_info */</span>
	<span class="n">last_track</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span><span class="p">.</span><span class="n">last_track_msb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">di</span><span class="p">.</span><span class="n">last_track_lsb</span><span class="p">;</span>
	<span class="n">ti_size</span> <span class="o">=</span> <span class="n">cdrom_get_track_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ti_size</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">track_start</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">use_last_written</span><span class="p">;</span>

        <span class="cm">/* if this track is blank, try the previous. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_track</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">use_last_written</span><span class="p">;</span>
		<span class="n">last_track</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ti_size</span> <span class="o">=</span> <span class="n">cdrom_get_track_info</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">last_track</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">use_last_written</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if next recordable address field is valid, use it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">nwa_v</span> <span class="o">&amp;&amp;</span> <span class="n">ti_size</span> <span class="o">&gt;=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">ti</span><span class="p">),</span> <span class="n">next_writable</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">next_writable</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">next_writable</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ti</span><span class="p">.</span><span class="n">next_writable</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">use_last_written:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cdrom_get_last_written</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="n">next_writable</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">next_writable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">next_writable</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_get_last_written</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">register_cdrom</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unregister_cdrom</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_open</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_release</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_ioctl</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_media_changed</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_number_of_slots</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_mode_select</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_mode_sense</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">init_cdrom_command</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdrom_get_media_event</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SYSCTL</span>

<span class="cp">#define CDROM_STR_SIZE 1000</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cdrom_sysctl_settings</span> <span class="p">{</span>
	<span class="kt">char</span>	<span class="n">info</span><span class="p">[</span><span class="n">CDROM_STR_SIZE</span><span class="p">];</span>	<span class="cm">/* general info */</span>
	<span class="kt">int</span>	<span class="n">autoclose</span><span class="p">;</span>		<span class="cm">/* close tray upon mount, etc */</span>
	<span class="kt">int</span>	<span class="n">autoeject</span><span class="p">;</span>		<span class="cm">/* eject on umount */</span>
	<span class="kt">int</span>	<span class="n">debug</span><span class="p">;</span>			<span class="cm">/* turn on debugging messages */</span>
	<span class="kt">int</span>	<span class="n">lock</span><span class="p">;</span>			<span class="cm">/* lock the door on device open */</span>
	<span class="kt">int</span>	<span class="n">check</span><span class="p">;</span>			<span class="cm">/* check media type */</span>
<span class="p">}</span> <span class="n">cdrom_sysctl_settings</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">cdrom_print_option</span> <span class="p">{</span>
	<span class="n">CTL_NAME</span><span class="p">,</span>
	<span class="n">CTL_SPEED</span><span class="p">,</span>
	<span class="n">CTL_SLOTS</span><span class="p">,</span>
	<span class="n">CTL_CAPABILITY</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_print_info</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cdrom_print_option</span> <span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdrom_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CTL_NAME</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CTL_SPEED</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CTL_SLOTS</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">cdi</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CTL_CAPABILITY</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span>
					<span class="s">&quot;</span><span class="se">\t</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;invalid option%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_sysctl_info</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
                           <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">max_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">lenp</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">ppos</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">write</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;CD-ROM information, &quot;</span> <span class="n">VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">drive name:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_NAME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">drive speed:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_SPEED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">drive # of slots:&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_SLOTS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can close tray:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_CLOSE_TRAY</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can open tray:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_OPEN_TRAY</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can lock tray:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_LOCK</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can change speed:&quot;</span><span class="p">,</span>
				<span class="n">CDC_SELECT_SPEED</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can select disk:&quot;</span><span class="p">,</span>
				<span class="n">CDC_SELECT_DISC</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can read multisession:&quot;</span><span class="p">,</span>
				<span class="n">CDC_MULTI_SESSION</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can read MCN:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_MCN</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Reports media changed:&quot;</span><span class="p">,</span>
				<span class="n">CDC_MEDIA_CHANGED</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can play audio:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_PLAY_AUDIO</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write CD-R:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_CD_R</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write CD-RW:&quot;</span><span class="p">,</span>
				<span class="n">CDC_CD_RW</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can read DVD:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_DVD</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write DVD-R:&quot;</span><span class="p">,</span>
				<span class="n">CDC_DVD_R</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write DVD-RAM:&quot;</span><span class="p">,</span>
				<span class="n">CDC_DVD_RAM</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can read MRW:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_MRW</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write MRW:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_MRW_W</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_print_info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Can write RAM:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CDC_RAM</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">CTL_CAPABILITY</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scnprintf</span><span class="p">(</span><span class="n">info</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">max_size</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="nl">doit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">proc_dostring</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;info buffer too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">doit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unfortunately, per device settings are not implemented through</span>
<span class="cm">   procfs/sysctl yet. When they are, this will naturally disappear. For now</span>
<span class="cm">   just update all drives. Later this will become the template on which</span>
<span class="cm">   new registered drives will be based. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_update_settings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdrom_device_info</span> <span class="o">*</span><span class="n">cdi</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cdi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cdrom_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoclose</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_CLOSE_TRAY</span><span class="p">))</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">CDO_AUTO_CLOSE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autoclose</span><span class="p">)</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDO_AUTO_CLOSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoeject</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_OPEN_TRAY</span><span class="p">))</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">CDO_AUTO_EJECT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autoeject</span><span class="p">)</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDO_AUTO_EJECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lockdoor</span> <span class="o">&amp;&amp;</span> <span class="n">CDROM_CAN</span><span class="p">(</span><span class="n">CDC_LOCK</span><span class="p">))</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">CDO_LOCK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lockdoor</span><span class="p">)</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDO_LOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_media_type</span><span class="p">)</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">CDO_CHECK_TYPE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cdi</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CDO_CHECK_TYPE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdrom_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdrom_sysctl_handler</span><span class="p">(</span><span class="n">ctl_table</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="n">ret</span> <span class="o">=</span> <span class="n">proc_dointvec</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">lenp</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
	
		<span class="cm">/* we only care for 1 or 0. */</span>
		<span class="n">autoclose</span>        <span class="o">=</span> <span class="o">!!</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoclose</span><span class="p">;</span>
		<span class="n">autoeject</span>        <span class="o">=</span> <span class="o">!!</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoeject</span><span class="p">;</span>
		<span class="n">debug</span>	         <span class="o">=</span> <span class="o">!!</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">debug</span><span class="p">;</span>
		<span class="n">lockdoor</span>         <span class="o">=</span> <span class="o">!!</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">lock</span><span class="p">;</span>
		<span class="n">check_media_type</span> <span class="o">=</span> <span class="o">!!</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">check</span><span class="p">;</span>

		<span class="cm">/* update the option flags according to the changes. we</span>
<span class="cm">		   don&#39;t have per device options through sysctl yet,</span>
<span class="cm">		   but we will have and then this will disappear. */</span>
		<span class="n">cdrom_update_settings</span><span class="p">();</span>
	<span class="p">}</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Place files in /proc/sys/dev/cdrom */</span>
<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">cdrom_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;info&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">info</span><span class="p">,</span> 
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="n">CDROM_STR_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0444</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;autoclose&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoclose</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_handler</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;autoeject&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoeject</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_handler</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;debug&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_handler</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;lock&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_handler</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;check_media&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">check</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0644</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proc_handler</span>	<span class="o">=</span> <span class="n">cdrom_sysctl_handler</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">cdrom_cdrom_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;cdrom&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">cdrom_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Make sure that /proc/sys/dev is there */</span>
<span class="k">static</span> <span class="n">ctl_table</span> <span class="n">cdrom_root_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">procname</span>	<span class="o">=</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxlen</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="mo">0555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">child</span>		<span class="o">=</span> <span class="n">cdrom_cdrom_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ctl_table_header</span> <span class="o">*</span><span class="n">cdrom_sysctl_header</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_sysctl_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cdrom_sysctl_header</span> <span class="o">=</span> <span class="n">register_sysctl_table</span><span class="p">(</span><span class="n">cdrom_root_table</span><span class="p">);</span>

	<span class="cm">/* set the defaults */</span>
	<span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoclose</span> <span class="o">=</span> <span class="n">autoclose</span><span class="p">;</span>
	<span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">autoeject</span> <span class="o">=</span> <span class="n">autoeject</span><span class="p">;</span>
	<span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lockdoor</span><span class="p">;</span>
	<span class="n">cdrom_sysctl_settings</span><span class="p">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check_media_type</span><span class="p">;</span>

	<span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_sysctl_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdrom_sysctl_header</span><span class="p">)</span>
		<span class="n">unregister_sysctl_table</span><span class="p">(</span><span class="n">cdrom_sysctl_header</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_SYSCTL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_sysctl_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdrom_sysctl_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SYSCTL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cdrom_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdrom_sysctl_register</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cdrom_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Uniform CD-ROM driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cdrom_sysctl_unregister</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cdrom_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cdrom_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
