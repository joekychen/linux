<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › sbus › char › jsflash.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>jsflash.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/sbus/char/jsflash.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992  Linus Torvalds	(drivers/char/mem.c)</span>
<span class="cm"> *  Copyright (C) 1997  Eddie C. Dost		(drivers/sbus/char/flash.c)</span>
<span class="cm"> *  Copyright (C) 1997-2000 Pavel Machek &lt;pavel@ucw.cz&gt;   (drivers/block/nbd.c)</span>
<span class="cm"> *  Copyright (C) 1999-2000 Pete Zaitcev</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is used to program OS into a Flash SIMM on</span>
<span class="cm"> * Krups and Espresso platforms.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: do not allow erase/programming if file systems are mounted.</span>
<span class="cm"> * TODO: Erase/program both banks of a 8MB SIMM.</span>
<span class="cm"> *</span>
<span class="cm"> * It is anticipated that programming an OS Flash will be a routine</span>
<span class="cm"> * procedure. In the same time it is exceedingly dangerous because</span>
<span class="cm"> * a user can program its OBP flash with OS image and effectively</span>
<span class="cm"> * kill the machine.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver uses an interface different from Eddie&#39;s flash.c</span>
<span class="cm"> * as a silly safeguard.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX The flash.c manipulates page caching characteristics in a certain</span>
<span class="cm"> * dubious way; also it assumes that remap_pfn_range() can remap</span>
<span class="cm"> * PCI bus locations, which may be false. ioremap() must be used</span>
<span class="cm"> * instead. We should discuss this.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/genhd.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pcic.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>

<span class="cp">#include &lt;asm/jsflash.h&gt;		</span><span class="cm">/* ioctl arguments. &lt;linux/&gt; ?? */</span><span class="cp"></span>
<span class="cp">#define JSFIDSZ		(sizeof(struct jsflash_ident_arg))</span>
<span class="cp">#define JSFPRGSZ	(sizeof(struct jsflash_program_arg))</span>

<span class="cm">/*</span>
<span class="cm"> * Our device numbers have no business in system headers.</span>
<span class="cm"> * The only thing a user knows is the device name /dev/jsflash.</span>
<span class="cm"> *</span>
<span class="cm"> * Block devices are laid out like this:</span>
<span class="cm"> *   minor+0	- Bootstrap, for 8MB SIMM 0x20400000[0x800000]</span>
<span class="cm"> *   minor+1	- Filesystem to mount, normally 0x20400400[0x7ffc00]</span>
<span class="cm"> *   minor+2	- Whole flash area for any case... 0x20000000[0x01000000]</span>
<span class="cm"> * Total 3 minors per flash device.</span>
<span class="cm"> *</span>
<span class="cm"> * It is easier to have static size vectors, so we define</span>
<span class="cm"> * a total minor range JSF_MAX, which must cover all minors.</span>
<span class="cm"> */</span>
<span class="cm">/* character device */</span>
<span class="cp">#define JSF_MINOR	178	</span><span class="cm">/* 178 is registered with hpa */</span><span class="cp"></span>
<span class="cm">/* block device */</span>
<span class="cp">#define JSF_MAX		 3	</span><span class="cm">/* 3 minors wasted total so far. */</span><span class="cp"></span>
<span class="cp">#define JSF_NPART	 3	</span><span class="cm">/* 3 minors per flash device */</span><span class="cp"></span>
<span class="cp">#define JSF_PART_BITS	 2	</span><span class="cm">/* 2 bits of minors to cover JSF_NPART */</span><span class="cp"></span>
<span class="cp">#define JSF_PART_MASK	 0x3	</span><span class="cm">/* 2 bits mask */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">jsf_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Access functions.</span>
<span class="cm"> * We could ioremap(), but it&#39;s easier this way.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">jsf_inl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;lda [%1] %2, %0</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="o">:</span>
				<span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="o">:</span>
				<span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_BYPASS</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsf_outl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;sta %0, [%1] %2</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="o">:</span> <span class="o">:</span>
				<span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">ASI_M_BYPASS</span><span class="p">)</span> <span class="o">:</span>
				<span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * soft carrier</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">jsfd_part</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dsize</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">jsflash</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">busy</span><span class="p">;</span>		<span class="cm">/* In use? */</span>
	<span class="k">struct</span> <span class="n">jsflash_ident_arg</span> <span class="n">id</span><span class="p">;</span>
	<span class="cm">/* int mbase; */</span>		<span class="cm">/* Minor base, typically zero */</span>
	<span class="k">struct</span> <span class="n">jsfd_part</span> <span class="n">dv</span><span class="p">[</span><span class="n">JSF_NPART</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * We do not map normal memory or obio as a safety precaution.</span>
<span class="cm"> * But offsets are real, for ease of userland programming.</span>
<span class="cm"> */</span>
<span class="cp">#define JSF_BASE_TOP	0x30000000</span>
<span class="cp">#define JSF_BASE_ALL	0x20000000</span>

<span class="cp">#define JSF_BASE_JK	0x20400000</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">jsfd_disk</span><span class="p">[</span><span class="n">JSF_MAX</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Let&#39;s pretend we may have several of these...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">jsflash</span> <span class="n">jsf0</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for AMD to finish its embedded algorithm.</span>
<span class="cm"> * We use the Toggle bit DQ6 (0x40) because it does not</span>
<span class="cm"> * depend on the data value as /DATA bit DQ7 does.</span>
<span class="cm"> *</span>
<span class="cm"> * XXX Do we need any timeout here? So far it never hanged, beware broken hw.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsf_wait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">x1</span> <span class="o">=</span> <span class="n">jsf_inl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">x2</span> <span class="o">=</span> <span class="n">jsf_inl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mh">0x40404040</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">x2</span> <span class="o">&amp;</span> <span class="mh">0x40404040</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Programming will only work if Flash is clean,</span>
<span class="cm"> * we leave it to the programmer application.</span>
<span class="cm"> *</span>
<span class="cm"> * AMD must be programmed one byte at a time;</span>
<span class="cm"> * thus, Simple Tech SIMM must be written 4 bytes at a time.</span>
<span class="cm"> *</span>
<span class="cm"> * Write waits for the chip to become ready after the write</span>
<span class="cm"> * was finished. This is done so that application would read</span>
<span class="cm"> * consistent data after the write is done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsf_write4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fa</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="mh">0xAAAAAAAA</span><span class="p">);</span>		<span class="cm">/* Unlock 1 Write 1 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>		<span class="cm">/* Unlock 1 Write 2 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="mh">0xA0A0A0A0</span><span class="p">);</span>		<span class="cm">/* Byte Program */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">jsf_wait</span><span class="p">(</span><span class="n">fa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsfd_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">togo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">byte4</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">togo</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">togo</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">b</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">jsf_inl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jsfd_do_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">jsfd_part</span> <span class="o">*</span><span class="n">jdp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">blk_rq_cur_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">jdp</span><span class="o">-&gt;</span><span class="n">dsize</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;jsfd: write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">jdp</span><span class="o">-&gt;</span><span class="n">dbase</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;jsfd: bad base %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">jdp</span><span class="o">-&gt;</span><span class="n">dbase</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">jsfd_read</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">jdp</span><span class="o">-&gt;</span><span class="n">dbase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">end:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__blk_end_request_cur</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">blk_fetch_request</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The memory devices use the full 32/64 bits of the offset, and so we cannot</span>
<span class="cm"> * check against negative addresses: they are ok. The return value is weird,</span>
<span class="cm"> * though, in that case (0).</span>
<span class="cm"> *</span>
<span class="cm"> * also note that seeking relative to the &quot;end of file&quot; isn&#39;t supported:</span>
<span class="cm"> * it has no meaning, so it returns -EINVAL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">jsf_lseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">orig</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OS SIMM Cannot be read in other size but a 32bits word.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">jsf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> 
    <span class="kt">size_t</span> <span class="n">togo</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">byte4</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">JSF_BASE_ALL</span> <span class="o">||</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="n">JSF_BASE_TOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">+</span> <span class="n">togo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span>	<span class="cm">/* wrap */</span>
	   <span class="o">||</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">togo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">JSF_BASE_TOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">togo</span> <span class="o">=</span> <span class="n">JSF_BASE_TOP</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">JSF_BASE_ALL</span> <span class="o">&amp;&amp;</span> <span class="n">togo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* __bzero XXX */</span>
<span class="c">		size_t x = JSF_BASE_ALL - p;</span>
<span class="c">		if (x &gt; togo) x = togo;</span>
<span class="c">		clear_user(tmp, x);</span>
<span class="c">		tmp += x;</span>
<span class="c">		p += x;</span>
<span class="c">		togo -= x;</span>
<span class="cp">#else</span>
		<span class="cm">/*</span>
<span class="cm">		 * Implementation of clear_user() calls __bzero</span>
<span class="cm">		 * without regard to modversions,</span>
<span class="cm">		 * so we cannot build a module.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">togo</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">togo</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">b</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">jsf_inl</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX Small togo may remain if 1 byte is ordered.</span>
<span class="cm">	 * It would be nice if we did a word size read and unpacked it.</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="o">-</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">jsf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span>
    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsf_ioctl_erase</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* p = jsf0.base;	hits wrong bank */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="mh">0x20400000</span><span class="p">;</span>

	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0xAAAAAAAA</span><span class="p">);</span>		<span class="cm">/* Unlock 1 Write 1 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>		<span class="cm">/* Unlock 1 Write 2 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x80808080</span><span class="p">);</span>		<span class="cm">/* Erase setup */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0xAAAAAAAA</span><span class="p">);</span>		<span class="cm">/* Unlock 2 Write 1 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>		<span class="cm">/* Unlock 2 Write 2 */</span>
	<span class="n">jsf_outl</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x10101010</span><span class="p">);</span>		<span class="cm">/* Chip erase */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * This code is ok, except that counter based timeout</span>
<span class="c">	 * has no place in this world. Let&#39;s just drop timeouts...</span>
<span class="c">	 */</span>
<span class="c">	{</span>
<span class="c">		int i;</span>
<span class="c">		__u32 x;</span>
<span class="c">		for (i = 0; i &lt; 1000000; i++) {</span>
<span class="c">			x = jsf_inl(p);</span>
<span class="c">			if ((x &amp; 0x80808080) == 0x80808080) break;</span>
<span class="c">		}</span>
<span class="c">		if ((x &amp; 0x80808080) != 0x80808080) {</span>
<span class="c">			printk(&quot;jsf0: erase timeout with 0x%08x\n&quot;, x);</span>
<span class="c">		} else {</span>
<span class="c">			printk(&quot;jsf0: erase done with 0x%08x\n&quot;, x);</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#else</span>
	<span class="n">jsf_wait</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Program a block of flash.</span>
<span class="cm"> * Very simple because we can do it byte by byte anyway.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsf_ioctl_program</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jsflash_program_arg</span> <span class="n">abuf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">togo</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abuf</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">JSFPRGSZ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span> 
	<span class="n">p</span> <span class="o">=</span> <span class="n">abuf</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
	<span class="n">togo</span> <span class="o">=</span> <span class="n">abuf</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">togo</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">uptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">abuf</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">togo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">togo</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">jsf_write4</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">n</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">uptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">jsf_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">JSFLASH_IDENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jsf0</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">JSFIDSZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">JSFLASH_ERASE</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">jsf_ioctl_erase</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">JSFLASH_PROGRAM</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">jsf_ioctl_program</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsf_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span> <span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsf_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jsf0</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">jsf0</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* XXX What security? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jsf0</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">jsf_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">jsf_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">jsf_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">jsf_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span>	<span class="n">jsf_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">jsf_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">jsf_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">jsf_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">jsf_dev</span> <span class="o">=</span> <span class="p">{</span> <span class="n">JSF_MINOR</span><span class="p">,</span> <span class="s">&quot;jsflash&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jsf_fops</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">jsfd_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsflash_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsflash</span> <span class="o">*</span><span class="n">jsf</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">banner</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">linux_prom_registers</span> <span class="n">reg0</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">prom_getchild</span><span class="p">(</span><span class="n">prom_root_node</span><span class="p">);</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">prom_searchsiblings</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;flash-memory&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span><span class="n">node</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getproperty</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reg0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jsflash: no </span><span class="se">\&quot;</span><span class="s">reg</span><span class="se">\&quot;</span><span class="s"> property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg0</span><span class="p">.</span><span class="n">which_io</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jsflash: bus number nonzero: 0x%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">reg0</span><span class="p">.</span><span class="n">which_io</span><span class="p">,</span> <span class="n">reg0</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Flash may be somewhere else, for instance on Ebus.</span>
<span class="cm">		 * So, don&#39;t do the following check for IIep flash space.</span>
<span class="cm">		 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if ((reg0.phys_addr &gt;&gt; 24) != 0x20) {</span>
<span class="c">			printk(&quot;jsflash: suspicious address: 0x%x:%x\n&quot;,</span>
<span class="c">			    reg0.which_io, reg0.phys_addr);</span>
<span class="c">			return -ENXIO;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">reg0</span><span class="p">.</span><span class="n">reg_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jsflash: bad size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">reg0</span><span class="p">.</span><span class="n">reg_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* XXX Remove this code once PROLL ID12 got widespread */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jsflash: no /flash-memory node, use PROLL &gt;= 12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_getproperty</span><span class="p">(</span><span class="n">prom_root_node</span><span class="p">,</span> <span class="s">&quot;banner-name&quot;</span><span class="p">,</span> <span class="n">banner</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">banner</span><span class="p">,</span> <span class="s">&quot;JavaStation-NC&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">strcmp</span> <span class="p">(</span><span class="n">banner</span><span class="p">,</span> <span class="s">&quot;JavaStation-E&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg0</span><span class="p">.</span><span class="n">which_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg0</span><span class="p">.</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="mh">0x20400000</span><span class="p">;</span>
		<span class="n">reg0</span><span class="p">.</span><span class="n">reg_size</span>  <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Let us be really paranoid for modifications to probing code. */</span>
	<span class="cm">/* extern enum sparc_cpu sparc_cpu_model; */</span> <span class="cm">/* in &lt;asm/system.h&gt; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sparc_cpu_model</span> <span class="o">!=</span> <span class="n">sun4m</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We must be on sun4m because we use MMU Bypass ASI. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jsf0</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jsf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jsf0</span><span class="p">;</span>

		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">reg0</span><span class="p">.</span><span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">reg0</span><span class="p">.</span><span class="n">reg_size</span><span class="p">;</span>

		<span class="cm">/* XXX Redo the userland interface. */</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">JSF_BASE_ALL</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">;</span>	<span class="cm">/* 16M - all segments */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">jsf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Krups_all&quot;</span><span class="p">);</span>

		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">jsf</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">jsf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">jsf</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dsize</span> <span class="o">=</span> <span class="n">jsf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dbase</span> <span class="o">=</span> <span class="n">JSF_BASE_ALL</span><span class="p">;</span>
		<span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dsize</span> <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Espresso Flash @0x%lx [%d MB]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jsf</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">jsf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_dev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;jsf: unable to get misc minor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">JSF_MINOR</span><span class="p">);</span>
		<span class="n">jsf0</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">jsf_queue</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jsfd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jsflash</span> <span class="o">*</span><span class="n">jsf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jsfd_part</span> <span class="o">*</span><span class="n">jdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jsf0</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">JSF_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disk</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">jsfd_disk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_blkdev</span><span class="p">(</span><span class="n">JSFD_MAJOR</span><span class="p">,</span> <span class="s">&quot;jsfd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jsf_queue</span> <span class="o">=</span> <span class="n">blk_init_queue</span><span class="p">(</span><span class="n">jsfd_do_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jsf_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">JSFD_MAJOR</span><span class="p">,</span> <span class="s">&quot;jsfd&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">JSF_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span> <span class="o">=</span> <span class="n">jsfd_disk</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">JSF_PART_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">JSF_NPART</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">jsf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jsf0</span><span class="p">;</span>	<span class="cm">/* actually, &amp;jsfv[i &gt;&gt; JSF_PART_BITS] */</span>
		<span class="n">jdp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jsf</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="o">&amp;</span><span class="n">JSF_PART_MASK</span><span class="p">];</span>

		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">JSFD_MAJOR</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;jsfd%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jsfd_fops</span><span class="p">;</span>
		<span class="n">set_capacity</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="n">jdp</span><span class="o">-&gt;</span><span class="n">dsize</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">jdp</span><span class="p">;</span>
		<span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">jsf_queue</span><span class="p">;</span>
		<span class="n">add_disk</span><span class="p">(</span><span class="n">disk</span><span class="p">);</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">disk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">jsfd_disk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">jsflash_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">jsflash_init</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jsfd_init</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">jsflash_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">JSF_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">JSF_PART_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">JSF_NPART</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">del_gendisk</span><span class="p">(</span><span class="n">jsfd_disk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">put_disk</span><span class="p">(</span><span class="n">jsfd_disk</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jsf0</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;jsf0: cleaning busy unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">jsf0</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jsf0</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jsf_dev</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">JSFD_MAJOR</span><span class="p">,</span> <span class="s">&quot;jsfd&quot;</span><span class="p">);</span>
	<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">jsf_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">jsflash_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">jsflash_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
