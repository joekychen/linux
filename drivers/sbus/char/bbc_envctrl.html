<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › sbus › char › bbc_envctrl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bbc_envctrl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bbc_envctrl.c: UltraSPARC-III environment control driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001, 2008 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>

<span class="cp">#include &quot;bbc_i2c.h&quot;</span>
<span class="cp">#include &quot;max1617.h&quot;</span>

<span class="cp">#undef ENVCTRL_TRACE</span>

<span class="cm">/* WARNING: Making changes to this driver is very dangerous.</span>
<span class="cm"> *          If you misprogram the sensor chips they can</span>
<span class="cm"> *          cut the power on you instantly.</span>
<span class="cm"> */</span>

<span class="cm">/* Two temperature sensors exist in the SunBLADE-1000 enclosure.</span>
<span class="cm"> * Both are implemented using max1617 i2c devices.  Each max1617</span>
<span class="cm"> * monitors 2 temperatures, one for one of the cpu dies and the other</span>
<span class="cm"> * for the ambient temperature.</span>
<span class="cm"> *</span>
<span class="cm"> * The max1617 is capable of being programmed with power-off</span>
<span class="cm"> * temperature values, one low limit and one high limit.  These</span>
<span class="cm"> * can be controlled independently for the cpu or ambient temperature.</span>
<span class="cm"> * If a limit is violated, the power is simply shut off.  The frequency</span>
<span class="cm"> * with which the max1617 does temperature sampling can be controlled</span>
<span class="cm"> * as well.</span>
<span class="cm"> *</span>
<span class="cm"> * Three fans exist inside the machine, all three are controlled with</span>
<span class="cm"> * an i2c digital to analog converter.  There is a fan directed at the</span>
<span class="cm"> * two processor slots, another for the rest of the enclosure, and the</span>
<span class="cm"> * third is for the power supply.  The first two fans may be speed</span>
<span class="cm"> * controlled by changing the voltage fed to them.  The third fan may</span>
<span class="cm"> * only be completely off or on.  The third fan is meant to only be</span>
<span class="cm"> * disabled/enabled when entering/exiting the lowest power-saving</span>
<span class="cm"> * mode of the machine.</span>
<span class="cm"> *</span>
<span class="cm"> * An environmental control kernel thread periodically monitors all</span>
<span class="cm"> * temperature sensors.  Based upon the samples it will adjust the</span>
<span class="cm"> * fan speeds to try and keep the system within a certain temperature</span>
<span class="cm"> * range (the goal being to make the fans as quiet as possible without</span>
<span class="cm"> * allowing the system to get too hot).</span>
<span class="cm"> *</span>
<span class="cm"> * If the temperature begins to rise/fall outside of the acceptable</span>
<span class="cm"> * operating range, a periodic warning will be sent to the kernel log.</span>
<span class="cm"> * The fans will be put on full blast to attempt to deal with this</span>
<span class="cm"> * situation.  After exceeding the acceptable operating range by a</span>
<span class="cm"> * certain threshold, the kernel thread will shut down the system.</span>
<span class="cm"> * Here, the thread is attempting to shut the machine down cleanly</span>
<span class="cm"> * before the hardware based power-off event is triggered.</span>
<span class="cm"> */</span>

<span class="cm">/* These settings are in Celsius.  We use these defaults only</span>
<span class="cm"> * if we cannot interrogate the cpu-fru SEEPROM.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">temp_limits</span> <span class="p">{</span>
	<span class="n">s8</span> <span class="n">high_pwroff</span><span class="p">,</span> <span class="n">high_shutdown</span><span class="p">,</span> <span class="n">high_warn</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">low_warn</span><span class="p">,</span> <span class="n">low_shutdown</span><span class="p">,</span> <span class="n">low_pwroff</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">temp_limits</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">temp_limits</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">all_temps</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">all_fans</span><span class="p">);</span>

<span class="cp">#define CPU_FAN_REG	0xf0</span>
<span class="cp">#define SYS_FAN_REG	0xf2</span>
<span class="cp">#define PSUPPLY_FAN_REG	0xf4</span>

<span class="cp">#define FAN_SPEED_MIN	0x0c</span>
<span class="cp">#define FAN_SPEED_MAX	0x3f</span>

<span class="cp">#define PSUPPLY_FAN_ON	0x1f</span>
<span class="cp">#define PSUPPLY_FAN_OFF	0x00</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_fan_speeds</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Put temperatures into range so we don&#39;t mis-program</span>
<span class="cm">	 * the hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">&lt;</span> <span class="n">FAN_SPEED_MIN</span><span class="p">)</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">&gt;</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">&lt;</span> <span class="n">FAN_SPEED_MIN</span><span class="p">)</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">&gt;</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
<span class="cp">#ifdef ENVCTRL_TRACE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fan%d: Changed fan speed to cpu(%02x) sys(%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
	       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span><span class="p">,</span> <span class="n">CPU_FAN_REG</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span><span class="p">,</span> <span class="n">SYS_FAN_REG</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">psupply_fan_on</span> <span class="o">?</span>
			<span class="n">PSUPPLY_FAN_ON</span> <span class="o">:</span> <span class="n">PSUPPLY_FAN_OFF</span><span class="p">),</span>
		       <span class="n">PSUPPLY_FAN_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_current_temps</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">prev_amb_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">;</span>
	<span class="n">bbc_i2c_readb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">,</span>
		      <span class="n">MAX1617_AMB_TEMP</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">prev_cpu_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">;</span>
	<span class="n">bbc_i2c_readb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">,</span>
		      <span class="n">MAX1617_CPU_TEMP</span><span class="p">);</span>
<span class="cp">#ifdef ENVCTRL_TRACE</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;temp%d: cpu(%d C) amb(%d C)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_envctrl_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">shutting_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shutting_down</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&gt;=</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_shutdown</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&lt;</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;ambient&quot;</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&gt;=</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_shutdown</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&lt;</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;CPU&quot;</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;temp%d: Outside of safe %s &quot;</span>
	       <span class="s">&quot;operating temperature, %d C.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;kenvctrld: Shutting down the system now.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">shutting_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orderly_poweroff</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;envctrl: shutdown execution failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define WARN_INTERVAL	(30 * HZ)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">analyze_ambient_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_warn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tick</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">last_warn</span> <span class="o">+</span> <span class="n">WARN_INTERVAL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&gt;=</span>
		    <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;temp%d: &quot;</span>
			       <span class="s">&quot;Above safe ambient operating temperature, %d C.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&lt;</span>
			   <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_warn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;temp%d: &quot;</span>
			       <span class="s">&quot;Below safe ambient operating temperature, %d C.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="o">*</span><span class="n">last_warn</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&gt;=</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&lt;</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_warn</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now check the shutdown limits. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&gt;=</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_shutdown</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span> <span class="o">&lt;</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_envctrl_shutdown</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_FULLBLAST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tick</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">amb_goal_hi</span> <span class="o">=</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">amb_goal_lo</span><span class="p">;</span>

		<span class="n">amb_goal_lo</span> <span class="o">=</span> <span class="n">amb_goal_hi</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* We do not try to avoid &#39;too cold&#39; events.  Basically we</span>
<span class="cm">		 * only try to deal with over-heating and fan noise reduction.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_amb_temp</span> <span class="o">&lt;</span> <span class="n">amb_goal_hi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_amb_temp</span> <span class="o">&gt;=</span> <span class="n">amb_goal_lo</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SLOWER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_FASTER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">analyze_cpu_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_warn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tick</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">last_warn</span> <span class="o">+</span> <span class="n">WARN_INTERVAL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&gt;=</span>
		    <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;temp%d: &quot;</span>
			       <span class="s">&quot;Above safe CPU operating temperature, %d C.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&lt;</span>
			   <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_warn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;temp%d: &quot;</span>
			       <span class="s">&quot;Below safe CPU operating temperature, %d C.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="o">*</span><span class="n">last_warn</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&gt;=</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&lt;</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_warn</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Now check the shutdown limits. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&gt;=</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_shutdown</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span> <span class="o">&lt;</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_shutdown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_envctrl_shutdown</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_FULLBLAST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tick</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">cpu_goal_hi</span> <span class="o">=</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_warn</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">s8</span> <span class="n">cpu_goal_lo</span><span class="p">;</span>

		<span class="n">cpu_goal_lo</span> <span class="o">=</span> <span class="n">cpu_goal_hi</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>

		<span class="cm">/* We do not try to avoid &#39;too cold&#39; events.  Basically we</span>
<span class="cm">		 * only try to deal with over-heating and fan noise reduction.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_cpu_temp</span> <span class="o">&lt;</span> <span class="n">cpu_goal_hi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_cpu_temp</span> <span class="o">&gt;=</span> <span class="n">cpu_goal_lo</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SLOWER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_FASTER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">analyze_temps</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">last_warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_amb_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)((</span><span class="kt">int</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_amb_temp</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_cpu_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)((</span><span class="kt">int</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_cpu_temp</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">analyze_ambient_temp</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">last_warn</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sample_tick</span><span class="p">);</span>
	<span class="n">analyze_cpu_temp</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">last_warn</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sample_tick</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">sample_tick</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">fan_action</span> <span class="nf">prioritize_fan_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">which_fan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fan_action</span> <span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_STATE_MAX</span><span class="p">;</span>

	<span class="cm">/* Basically, prioritize what the temperature sensors</span>
<span class="cm">	 * recommend we do, and perform that action on all the</span>
<span class="cm">	 * fans.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_temps</span><span class="p">,</span> <span class="n">glob_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">which_fan</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAN_FULLBLAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_FULLBLAST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">which_fan</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAN_SAME</span> <span class="o">&amp;&amp;</span>
		    <span class="n">decision</span> <span class="o">!=</span> <span class="n">FAN_FASTER</span><span class="p">)</span>
			<span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">which_fan</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAN_FASTER</span><span class="p">)</span>
			<span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_FASTER</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">!=</span> <span class="n">FAN_FASTER</span> <span class="o">&amp;&amp;</span>
			 <span class="n">decision</span> <span class="o">!=</span> <span class="n">FAN_SAME</span> <span class="o">&amp;&amp;</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">which_fan</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAN_SLOWER</span><span class="p">)</span>
			<span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_SLOWER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_STATE_MAX</span><span class="p">)</span>
		<span class="n">decision</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">decision</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">maybe_new_ambient_fan_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fan_action</span> <span class="n">decision</span> <span class="o">=</span> <span class="n">prioritize_fan_action</span><span class="p">(</span><span class="n">FAN_AMBIENT</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_SAME</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_FULLBLAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">&gt;=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_FASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">&gt;=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">orig_speed</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">orig_speed</span> <span class="o">&lt;=</span> <span class="n">FAN_SPEED_MIN</span> <span class="o">||</span>
			    <span class="n">orig_speed</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">maybe_new_cpu_fan_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">fan_action</span> <span class="n">decision</span> <span class="o">=</span> <span class="n">prioritize_fan_action</span><span class="p">(</span><span class="n">FAN_CPU</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_SAME</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_FULLBLAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">&gt;=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decision</span> <span class="o">==</span> <span class="n">FAN_FASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">&gt;=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">&lt;</span>
				    <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span>
						<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">&lt;=</span> <span class="n">FAN_SPEED_MIN</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">maybe_new_fan_speeds</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">new</span>  <span class="o">=</span> <span class="n">maybe_new_ambient_fan_speed</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">|=</span> <span class="n">maybe_new_cpu_fan_speed</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
		<span class="n">set_fan_speeds</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fans_full_blast</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="cm">/* Since we will not be monitoring things anymore, put</span>
<span class="cm">	 * the fans on full blast.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_fans</span><span class="p">,</span> <span class="n">glob_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span> <span class="n">FAN_SPEED_MAX</span><span class="p">;</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">psupply_fan_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_fan_speeds</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define POLL_INTERVAL	(5 * 1000)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_warning_jiffies</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">kenvctrld_task</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kenvctrld</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;bbc_envctrl: kenvctrld starting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">last_warning_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">WARN_INTERVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">POLL_INTERVAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_temps</span><span class="p">,</span> <span class="n">glob_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_current_temps</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">analyze_temps</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_warning_jiffies</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_fans</span><span class="p">,</span> <span class="n">glob_list</span><span class="p">)</span>
			<span class="n">maybe_new_fan_speeds</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;bbc_envctrl: kenvctrld exiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">fans_full_blast</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">attach_one_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">temp_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">bbc_i2c_attach</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_idx</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">glob_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_temps</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">temps</span><span class="p">);</span>

	<span class="cm">/* Tell it to convert once every 5 seconds, clear all cfg</span>
<span class="cm">	 * bits.</span>
<span class="cm">	 */</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">MAX1617_WR_CFG_BYTE</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">MAX1617_WR_CVRATE_BYTE</span><span class="p">);</span>

	<span class="cm">/* Program the hard temperature limits into the chip. */</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_pwroff</span><span class="p">,</span>
		       <span class="n">MAX1617_WR_AMB_HIGHLIM</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">amb_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_pwroff</span><span class="p">,</span>
		       <span class="n">MAX1617_WR_AMB_LOWLIM</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">high_pwroff</span><span class="p">,</span>
		       <span class="n">MAX1617_WR_CPU_HIGHLIM</span><span class="p">);</span>
	<span class="n">bbc_i2c_writeb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">cpu_temp_limits</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">low_pwroff</span><span class="p">,</span>
		       <span class="n">MAX1617_WR_CPU_LOWLIM</span><span class="p">);</span>

	<span class="n">get_current_temps</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">prev_cpu_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_cpu_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_cpu_temp</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">prev_amb_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">avg_amb_temp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">curr_amb_temp</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_AMBIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fan_todo</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAN_SAME</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">attach_one_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">fan_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">bbc_i2c_attach</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">fan_idx</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">glob_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">all_fans</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fans</span><span class="p">);</span>

	<span class="cm">/* The i2c device controlling the fans is write-only.</span>
<span class="cm">	 * So the only way to keep track of the current power</span>
<span class="cm">	 * level fed to the fans is via software.  Choose half</span>
<span class="cm">	 * power for cpu/system and &#39;on&#39; fo the powersupply fan</span>
<span class="cm">	 * and set it now.</span>
<span class="cm">	 */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">psupply_fan_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">FAN_SPEED_MAX</span> <span class="o">-</span> <span class="n">FAN_SPEED_MIN</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cpu_fan_speed</span> <span class="o">+=</span> <span class="n">FAN_SPEED_MIN</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">FAN_SPEED_MAX</span> <span class="o">-</span> <span class="n">FAN_SPEED_MIN</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">system_fan_speed</span> <span class="o">+=</span> <span class="n">FAN_SPEED_MIN</span><span class="p">;</span>

	<span class="n">set_fan_speeds</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_one_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bbc_i2c_detach</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_all_temps</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_cpu_temperature</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="o">*</span><span class="n">tpos</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">temps</span><span class="p">,</span> <span class="n">bp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bp_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">glob_list</span><span class="p">);</span>
		<span class="n">destroy_one_temp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_one_fan</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bbc_i2c_detach</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_all_fans</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bbc_fan_control</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="n">fpos</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fpos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fans</span><span class="p">,</span> <span class="n">bp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">glob_list</span><span class="p">);</span>
		<span class="n">destroy_one_fan</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bbc_envctrl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fan_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">op</span> <span class="o">=</span> <span class="n">bbc_i2c_getdev</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">devidx</span><span class="o">++</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;temperature&quot;</span><span class="p">))</span>
			<span class="n">attach_one_temp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">temp_index</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;fan-control&quot;</span><span class="p">))</span>
			<span class="n">attach_one_fan</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">fan_index</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp_index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fan_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kenvctrld_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">kenvctrld</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;kenvctrld&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">kenvctrld_task</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">kenvctrld_task</span><span class="p">);</span>

			<span class="n">kenvctrld_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">destroy_all_temps</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">destroy_all_fans</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bbc_envctrl_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bbc_i2c_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kenvctrld_task</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">kenvctrld_task</span><span class="p">);</span>

	<span class="n">destroy_all_temps</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">destroy_all_fans</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
