<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › core › sdio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sdio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mmc/sdio.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2006-2007 Pierre Ossman</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_ids.h&gt;</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;bus.h&quot;</span>
<span class="cp">#include &quot;sd.h&quot;</span>
<span class="cp">#include &quot;sdio_bus.h&quot;</span>
<span class="cp">#include &quot;mmc_ops.h&quot;</span>
<span class="cp">#include &quot;sd_ops.h&quot;</span>
<span class="cp">#include &quot;sdio_ops.h&quot;</span>
<span class="cp">#include &quot;sdio_cis.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_read_fbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_nonstd_func_interface</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">SDIO_CLASS_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">SDIO_FBR_BASE</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="n">SDIO_FBR_STD_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">SDIO_FBR_BASE</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="n">SDIO_FBR_STD_IF_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">func</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_init_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fn</span> <span class="o">&gt;</span> <span class="n">SDIO_MAX_FUNCS</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">sdio_alloc_func</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">func</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_NONSTD_SDIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_read_fbr</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_read_func_cis</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">max_blksize</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">blksize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">fn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is okay to remove the function here even though we hold</span>
<span class="cm">	 * the host lock as we haven&#39;t registered the device yet.</span>
<span class="cm">	 */</span>
	<span class="n">sdio_remove_func</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_read_cccr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ocr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cccr_vsn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uhs</span> <span class="o">=</span> <span class="n">ocr</span> <span class="o">&amp;</span> <span class="n">R4_18V_PRESENT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_cccr</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_CCCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cccr_vsn</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cccr_vsn</span> <span class="o">&gt;</span> <span class="n">SDIO_CCCR_REV_3_00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unrecognised CCCR structure version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">cccr_vsn</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">sdio_vsn</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_CAPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_CCCR_CAP_SMB</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">multi_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_CCCR_CAP_LSC</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">low_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_CCCR_CAP_4BLS</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">wide_bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cccr_vsn</span> <span class="o">&gt;=</span> <span class="n">SDIO_CCCR_REV_1_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_POWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_POWER_SMPC</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">high_power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cccr_vsn</span> <span class="o">&gt;=</span> <span class="n">SDIO_CCCR_REV_1_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_SPEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">.</span><span class="n">sda_spec3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cccr_vsn</span> <span class="o">&gt;=</span> <span class="n">SDIO_CCCR_REV_3_00</span> <span class="o">&amp;&amp;</span> <span class="n">uhs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">.</span><span class="n">sda_spec3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SDIO_CCCR_UHS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">MMC_CAP_UHS_SDR12</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span> <span class="o">|</span>
				 <span class="n">MMC_CAP_UHS_SDR50</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span>
				 <span class="n">MMC_CAP_UHS_DDR50</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_UHS_DDR50</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span>
						<span class="o">|=</span> <span class="n">SD_MODE_UHS_DDR50</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_UHS_SDR50</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span>
						<span class="o">|=</span> <span class="n">SD_MODE_UHS_SDR50</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_UHS_SDR104</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span>
						<span class="o">|=</span> <span class="n">SD_MODE_UHS_SDR104</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SDIO_CCCR_DRIVE_STRENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_DRIVE_SDTA</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_A</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_DRIVE_SDTC</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_C</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SDIO_DRIVE_SDTD</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_D</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if no uhs mode ensure we check for high speed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="n">SDIO_SPEED_SHS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">high_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">hs_max_dtr</span> <span class="o">=</span> <span class="mi">50000000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">high_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">hs_max_dtr</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_enable_wide</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">low_speed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">wide_bus</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDIO_BUS_WIDTH_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDIO_BUS_WIDTH_RESERVED</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: SDIO_CCCR_IF is invalid: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* set as 4-bit bus width */</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDIO_BUS_WIDTH_MASK</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDIO_BUS_WIDTH_4BIT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If desired, disconnect the pull-up resistor on CD/DAT[3] (pin 1)</span>
<span class="cm"> * of the card. This may be required on certain setups of boards,</span>
<span class="cm"> * controllers and embedded sdio device which do not need the card&#39;s</span>
<span class="cm"> * pull-up. As a result, card detection is disabled and power is saved.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_disable_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_disable_cd</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDIO_BUS_CD_DISABLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Devices that remain active during a system suspend are</span>
<span class="cm"> * put back into 1-bit mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_disable_wide</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">low_speed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">wide_bus</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDIO_BUS_WIDTH_4BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDIO_BUS_WIDTH_4BIT</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDIO_BUS_ASYNC_INT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_IF</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mmc_set_bus_width</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_enable_4bit_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MMC_TYPE_SDIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sdio_enable_wide</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">.</span><span class="n">bus_widths</span> <span class="o">&amp;</span> <span class="n">SD_SCR_BUS_WIDTH_4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_app_set_bus_width</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_enable_wide</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mmc_app_set_bus_width</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Test if the card supports high-speed mode and, if so, switch to it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_switch_hs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">high_speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_SPEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">|=</span> <span class="n">SDIO_SPEED_EHS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">speed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDIO_SPEED_EHS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_SPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable SDIO/combo card&#39;s high-speed mode. Return 0/1 if [not]supported.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_enable_hs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_sdio_switch_hs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MMC_TYPE_SDIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_sd_switch_hs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mmc_sdio_switch_hs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">mmc_sdio_get_max_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">max_dtr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_highspeed</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The SDIO specification doesn&#39;t mention how</span>
<span class="cm">		 * the CIS transfer speed register relates to</span>
<span class="cm">		 * high-speed, but it seems that 50 MHz is</span>
<span class="cm">		 * mandatory.</span>
<span class="cm">		 */</span>
		<span class="n">max_dtr</span> <span class="o">=</span> <span class="mi">50000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max_dtr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">max_dtr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MMC_TYPE_SD_COMBO</span><span class="p">)</span>
		<span class="n">max_dtr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_dtr</span><span class="p">,</span> <span class="n">mmc_sd_get_max_clock</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">max_dtr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">host_drive_to_sdio_drive</span><span class="p">(</span><span class="kt">int</span> <span class="n">host_strength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">host_strength</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_SET_DRIVER_TYPE_A</span>:
		<span class="k">return</span> <span class="n">SDIO_DTSx_SET_TYPE_A</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_SET_DRIVER_TYPE_B</span>:
		<span class="k">return</span> <span class="n">SDIO_DTSx_SET_TYPE_B</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_SET_DRIVER_TYPE_C</span>:
		<span class="k">return</span> <span class="n">SDIO_DTSx_SET_TYPE_C</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_SET_DRIVER_TYPE_D</span>:
		<span class="k">return</span> <span class="n">SDIO_DTSx_SET_TYPE_D</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">SDIO_DTSx_SET_TYPE_B</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_select_driver_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">host_drv_type</span> <span class="o">=</span> <span class="n">SD_DRIVER_TYPE_B</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">card_drv_type</span> <span class="o">=</span> <span class="n">SD_DRIVER_TYPE_B</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drive_strength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">card_strength</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the host doesn&#39;t support any of the Driver Types A,C or D,</span>
<span class="cm">	 * or there is no board specific handler then default Driver</span>
<span class="cm">	 * Type B is used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">MMC_CAP_DRIVER_TYPE_A</span> <span class="o">|</span>
		 <span class="n">MMC_CAP_DRIVER_TYPE_C</span> <span class="o">|</span>
		 <span class="n">MMC_CAP_DRIVER_TYPE_D</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">select_drive_strength</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_DRIVER_TYPE_A</span><span class="p">)</span>
		<span class="n">host_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_A</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_DRIVER_TYPE_C</span><span class="p">)</span>
		<span class="n">host_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_C</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_DRIVER_TYPE_D</span><span class="p">)</span>
		<span class="n">host_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_D</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">&amp;</span> <span class="n">SD_DRIVER_TYPE_A</span><span class="p">)</span>
		<span class="n">card_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_A</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">&amp;</span> <span class="n">SD_DRIVER_TYPE_C</span><span class="p">)</span>
		<span class="n">card_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_C</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_drv_type</span> <span class="o">&amp;</span> <span class="n">SD_DRIVER_TYPE_D</span><span class="p">)</span>
		<span class="n">card_drv_type</span> <span class="o">|=</span> <span class="n">SD_DRIVER_TYPE_D</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The drive strength that the hardware can support</span>
<span class="cm">	 * depends on the board design.  Pass the appropriate</span>
<span class="cm">	 * information and let the hardware specific code</span>
<span class="cm">	 * return what is possible given the options</span>
<span class="cm">	 */</span>
	<span class="n">drive_strength</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">select_drive_strength</span><span class="p">(</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span><span class="p">,</span>
		<span class="n">host_drv_type</span><span class="p">,</span> <span class="n">card_drv_type</span><span class="p">);</span>

	<span class="cm">/* if error just use default for drive strength B */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_DRIVE_STRENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">card_strength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card_strength</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SDIO_DRIVE_DTSx_MASK</span><span class="o">&lt;&lt;</span><span class="n">SDIO_DRIVE_DTSx_SHIFT</span><span class="p">);</span>
	<span class="n">card_strength</span> <span class="o">|=</span> <span class="n">host_drive_to_sdio_drive</span><span class="p">(</span><span class="n">drive_strength</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_DRIVE_STRENGTH</span><span class="p">,</span>
		<span class="n">card_strength</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* if error default to drive strength B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mmc_set_driver_type</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">drive_strength</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_set_bus_speed_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_speed</span><span class="p">,</span> <span class="n">timing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">speed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the host doesn&#39;t support any of the UHS-I modes, fallback on</span>
<span class="cm">	 * default speed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMC_CAP_UHS_SDR12</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span> <span class="o">|</span>
	    <span class="n">MMC_CAP_UHS_SDR50</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_DDR50</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_SDR12</span><span class="p">;</span>
	<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_SDR12</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_UHS_SDR104</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">&amp;</span> <span class="n">SD_MODE_UHS_SDR104</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_SDR104</span><span class="p">;</span>
			<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_SDR104</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span> <span class="o">=</span> <span class="n">UHS_SDR104_MAX_DTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_UHS_DDR50</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">&amp;</span> <span class="n">SD_MODE_UHS_DDR50</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_DDR50</span><span class="p">;</span>
			<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_DDR50</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span> <span class="o">=</span> <span class="n">UHS_DDR50_MAX_DTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span>
		    <span class="n">MMC_CAP_UHS_SDR50</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">&amp;</span>
		    <span class="n">SD_MODE_UHS_SDR50</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_SDR50</span><span class="p">;</span>
			<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_SDR50</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span> <span class="o">=</span> <span class="n">UHS_SDR50_MAX_DTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span>
		    <span class="n">MMC_CAP_UHS_SDR50</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">&amp;</span> <span class="n">SD_MODE_UHS_SDR25</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_SDR25</span><span class="p">;</span>
			<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_SDR25</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span> <span class="o">=</span> <span class="n">UHS_SDR25_MAX_DTR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span>
		    <span class="n">MMC_CAP_UHS_SDR50</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span> <span class="o">|</span>
		    <span class="n">MMC_CAP_UHS_SDR12</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span> <span class="o">&amp;</span>
		    <span class="n">SD_MODE_UHS_SDR12</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_speed</span> <span class="o">=</span> <span class="n">SDIO_SPEED_SDR12</span><span class="p">;</span>
			<span class="n">timing</span> <span class="o">=</span> <span class="n">MMC_TIMING_UHS_SDR12</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span> <span class="o">=</span> <span class="n">UHS_SDR12_MAX_DTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_SPEED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">speed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDIO_SPEED_BSS_MASK</span><span class="p">;</span>
	<span class="n">speed</span> <span class="o">|=</span> <span class="n">bus_speed</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_io_rw_direct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDIO_CCCR_SPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_set_timing</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">timing</span><span class="p">);</span>
		<span class="n">mmc_set_clock</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">uhs_max_dtr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * UHS-I specific initialization procedure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_init_uhs_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">.</span><span class="n">sda_spec3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch to wider bus (if supported).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_enable_4bit_bus</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_set_bus_width</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set the driver strength for the card */</span>
	<span class="n">sdio_select_driver_type</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Set bus speed mode of the card */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_set_bus_speed_mode</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Initialize and start re-tuning timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">execute_tuning</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">execute_tuning</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
						      <span class="n">MMC_SEND_TUNING_BLOCK</span><span class="p">);</span>

<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the detection and initialisation of a card.</span>
<span class="cm"> *</span>
<span class="cm"> * In the case of a resume, &quot;oldcard&quot; will contain the card</span>
<span class="cm"> * we&#39;re trying to reinitialise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ocr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">oldcard</span><span class="p">,</span> <span class="kt">int</span> <span class="n">powered_resume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">claimed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Inform the card of the voltage</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powered_resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The initialization should be done at 3.3 V I/O voltage. */</span>
		<span class="n">mmc_set_signal_voltage</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_SIGNAL_VOLTAGE_330</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_send_io_op_cond</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For SPI, enable CRC as appropriate.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_spi_set_crc</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">use_spi_crc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate card structure.</span>
<span class="cm">	 */</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">mmc_alloc_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="n">R4_MEMORY_PRESENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mmc_sd_get_cid</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="n">ocr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MMC_TYPE_SD_COMBO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oldcard</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MMC_TYPE_SD_COMBO</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cid</span><span class="p">,</span> <span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">raw_cid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mmc_remove_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MMC_TYPE_SDIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oldcard</span> <span class="o">&amp;&amp;</span> <span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MMC_TYPE_SDIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_remove_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call the optional HC&#39;s init_card function to handle quirks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_card</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the host and card support UHS-I mode request the card</span>
<span class="cm">	 * to switch to 1.8V signaling level.  No 1.8v signalling if</span>
<span class="cm">	 * UHS mode is not enabled to maintain compatibilty and some</span>
<span class="cm">	 * systems that claim 1.8v signalling in fact do not support</span>
<span class="cm">	 * it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="n">R4_18V_PRESENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">MMC_CAP_UHS_SDR12</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span> <span class="o">|</span>
			 <span class="n">MMC_CAP_UHS_SDR50</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span>
			 <span class="n">MMC_CAP_UHS_DDR50</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_set_signal_voltage</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_SIGNAL_VOLTAGE_180</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R4_18V_PRESENT</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R4_18V_PRESENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R4_18V_PRESENT</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R4_18V_PRESENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For native busses:  set card RCA and quit open drain mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powered_resume</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_send_relative_addr</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Update oldcard with the new RCA received from the SDIO</span>
<span class="cm">		 * device -- we&#39;re doing this so that it&#39;s updated in the</span>
<span class="cm">		 * &quot;card&quot; struct when oldcard overwrites that later.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldcard</span><span class="p">)</span>
			<span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">rca</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read CSD, before selecting the card</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldcard</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MMC_TYPE_SD_COMBO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sd_get_csd</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">mmc_decode_cid</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select card, as all following commands rely on that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powered_resume</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_select_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_NONSTD_SDIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is non-standard SDIO device, meaning it doesn&#39;t</span>
<span class="cm">		 * have any CIA (Common I/O area) registers present.</span>
<span class="cm">		 * It&#39;s host&#39;s responsibility to fill cccr and cis</span>
<span class="cm">		 * structures in init_card().</span>
<span class="cm">		 */</span>
		<span class="n">mmc_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">max_dtr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cccr</span><span class="p">.</span><span class="n">high_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_card_set_highspeed</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">mmc_set_timing</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_TIMING_SD_HS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the common registers.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_read_cccr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ocr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the common CIS tuples.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_read_common_cis</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldcard</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">same</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">oldcard</span><span class="o">-&gt;</span><span class="n">cis</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
		<span class="n">mmc_remove_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">same</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

		<span class="n">card</span> <span class="o">=</span> <span class="n">oldcard</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmc_fixup_device</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MMC_TYPE_SD_COMBO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sd_setup_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">oldcard</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* handle as SDIO-only card if memory init failed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_go_idle</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
				<span class="cm">/* should not fail, as it worked previously */</span>
				<span class="n">mmc_spi_set_crc</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">use_spi_crc</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MMC_TYPE_SDIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If needed, disconnect card detection pull-up resistor.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_disable_cd</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

	<span class="cm">/* Initialization sequence for UHS-I cards */</span>
	<span class="cm">/* Only if card supports 1.8v and UHS signaling */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="n">R4_18V_PRESENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sw_caps</span><span class="p">.</span><span class="n">sd3_bus_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sdio_init_uhs_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

		<span class="cm">/* Card is an ultra-high-speed card */</span>
		<span class="n">mmc_card_set_uhs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Switch to high-speed (if supported).</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_enable_hs</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mmc_sd_go_highspeed</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Change to the card&#39;s maximum speed.</span>
<span class="cm">		 */</span>
		<span class="n">mmc_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mmc_sdio_get_max_clock</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Switch to wider bus (if supported).</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_enable_4bit_bus</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mmc_set_bus_width</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">finish:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldcard</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">remove:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldcard</span><span class="p">)</span>
		<span class="n">mmc_remove_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Host is being removed. Free up the current card.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_sdio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_funcs</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">sdio_remove_func</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmc_remove_card</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Card detection - card is alive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_select_card</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Card detection callback from host.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_sdio_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Make sure card is powered before detecting it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_POWER_OFF_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Just check if our card has been removed.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">_mmc_detect_card_removed</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell PM core it&#39;s OK to power off the card now.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The _sync variant is used in order to ensure that the card</span>
<span class="cm">	 * is left powered off in case an error occurred, and the card</span>
<span class="cm">	 * is going to be removed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since there is no specific reason to believe a new user</span>
<span class="cm">	 * is about to show up at this point, the _sync variant is</span>
<span class="cm">	 * desirable anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_POWER_OFF_CARD</span><span class="p">)</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_sdio_remove</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">mmc_detach_bus</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">mmc_power_off</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SDIO suspend.  We need to suspend all functions separately.</span>
<span class="cm"> * Therefore all registered functions must have drivers with suspend</span>
<span class="cm"> * and resume methods.  Failing that we simply remove the whole card.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_funcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="n">sdio_func_present</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">pmops</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmops</span> <span class="o">||</span> <span class="o">!</span><span class="n">pmops</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">||</span> <span class="o">!</span><span class="n">pmops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* force removal of entire card in that case */</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">pmops</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="n">sdio_func_present</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">pmops</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">;</span>
			<span class="n">pmops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_card_wake_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">sdio_disable_wide</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Basic card reinitialization. */</span>
	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* No need to reinitialize powered-resumed nonremovable cards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_is_removable</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sdio_init_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					<span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_card_wake_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We may have switched to 1-bit mode during suspend */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_enable_4bit_bus</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_set_bus_width</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irqs</span><span class="p">)</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq_thread</span><span class="p">);</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the card looked to be the same as before suspending, then</span>
<span class="cm">	 * we proceed to resume all card functions.  If one of them returns</span>
<span class="cm">	 * an error then we simply return that error to the core and the</span>
<span class="cm">	 * card will be redetected as new.  It is the responsibility of</span>
<span class="cm">	 * the function driver to perform further tests with the extra</span>
<span class="cm">	 * knowledge it has of the card to confirm the card is indeed the</span>
<span class="cm">	 * same as before suspending (same MAC address for network cards,</span>
<span class="cm">	 * etc.) and return an error otherwise.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_funcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&amp;&amp;</span> <span class="n">sdio_func_present</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="o">*</span><span class="n">pmops</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pmops</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_sdio_power_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ocr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the card by performing the same steps that are taken by</span>
<span class="cm">	 * mmc_rescan_try_freq() and mmc_attach_sdio() during a &quot;normal&quot; probe.</span>
<span class="cm">	 *</span>
<span class="cm">	 * sdio_reset() is technically not needed. Having just powered up the</span>
<span class="cm">	 * hardware, it should already be in reset state. However, some</span>
<span class="cm">	 * platforms (such as SD8686 on OLPC) do not instantly cut power,</span>
<span class="cm">	 * meaning that a reset is required when restoring power soon after</span>
<span class="cm">	 * powering off. It is harmless in other cases.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The CMD5 reset (mmc_send_io_op_cond()), according to the SDIO spec,</span>
<span class="cm">	 * is not necessary for non-removable cards. However, it is required</span>
<span class="cm">	 * for OLPC SD8686 (which expects a [CMD5,5,3,7] init sequence), and</span>
<span class="cm">	 * harmless in other situations.</span>
<span class="cm">	 *</span>
<span class="cm">	 * With these steps taken, mmc_select_voltage() is also required to</span>
<span class="cm">	 * restore the correct voltage setting of the card.</span>
<span class="cm">	 */</span>

	<span class="cm">/* The initialization should be done at 3.3 V I/O voltage. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
		<span class="n">mmc_set_signal_voltage</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">MMC_SIGNAL_VOLTAGE_330</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sdio_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_go_idle</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_send_if_cond</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_send_io_op_cond</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">=</span> <span class="n">mmc_select_voltage</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ocr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_sdio_init_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">mmc_card_keep_power</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irqs</span><span class="p">)</span>
		<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_bus_ops</span> <span class="n">mmc_sdio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">mmc_sdio_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">mmc_sdio_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">mmc_sdio_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">mmc_sdio_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_restore</span> <span class="o">=</span> <span class="n">mmc_sdio_power_restore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alive</span> <span class="o">=</span> <span class="n">mmc_sdio_alive</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Starting point for SDIO card init.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mmc_attach_sdio</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">funcs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ocr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">claimed</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_send_io_op_cond</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ocr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mmc_attach_bus</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_sdio_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check the voltages that the card claims to</span>
<span class="cm">	 * support.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: card claims to support voltages &quot;</span>
		       <span class="s">&quot;below the defined range. These will be ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="p">));</span>
		<span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">=</span> <span class="n">mmc_select_voltage</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ocr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can we support the voltage(s) of the card(s)?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect and init the card.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sdio_init_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Retry initialization with S18R set to 0.</span>
<span class="cm">			 */</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R4_18V_PRESENT</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_sdio_init_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable runtime PM only if supported by host+card+board</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_POWER_OFF_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Let runtime PM core know our card is active</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enable runtime PM for this card</span>
<span class="cm">		 */</span>
		<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The number of functions on the card is encoded inside</span>
<span class="cm">	 * the ocr.</span>
<span class="cm">	 */</span>
	<span class="n">funcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">ocr</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_funcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize (but don&#39;t add) all present functions.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">funcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_funcs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_init_func</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enable Runtime PM for this func (if supported)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_POWER_OFF_CARD</span><span class="p">)</span>
			<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First add the card to the driver model...</span>
<span class="cm">	 */</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_add_card</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove_added</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ...then the SDIO functions.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">funcs</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sdio_add_func</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sdio_func</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">remove_added</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


<span class="nl">remove_added:</span>
	<span class="cm">/* Remove without lock if the device has been added. */</span>
	<span class="n">mmc_sdio_remove</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">remove:</span>
	<span class="cm">/* And with lock if it hasn&#39;t been added. */</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span>
		<span class="n">mmc_sdio_remove</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">mmc_detach_bus</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d whilst initialising SDIO card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
