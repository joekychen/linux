<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › omap_hsmmc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap_hsmmc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/mmc/host/omap_hsmmc.c</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for OMAP2430/3430 MMC controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Texas Instruments.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Syed Mohammed Khasim	&lt;x0khasim@ti.com&gt;</span>
<span class="cm"> *	Madhusudhan		&lt;madhu.cr@ti.com&gt;</span>
<span class="cm"> *	Mohit Jalori		&lt;mjalori@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/core.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;plat/board.h&gt;</span>
<span class="cp">#include &lt;plat/mmc.h&gt;</span>
<span class="cp">#include &lt;plat/cpu.h&gt;</span>

<span class="cm">/* OMAP HSMMC Host Controller Registers */</span>
<span class="cp">#define OMAP_HSMMC_SYSCONFIG	0x0010</span>
<span class="cp">#define OMAP_HSMMC_SYSSTATUS	0x0014</span>
<span class="cp">#define OMAP_HSMMC_CON		0x002C</span>
<span class="cp">#define OMAP_HSMMC_BLK		0x0104</span>
<span class="cp">#define OMAP_HSMMC_ARG		0x0108</span>
<span class="cp">#define OMAP_HSMMC_CMD		0x010C</span>
<span class="cp">#define OMAP_HSMMC_RSP10	0x0110</span>
<span class="cp">#define OMAP_HSMMC_RSP32	0x0114</span>
<span class="cp">#define OMAP_HSMMC_RSP54	0x0118</span>
<span class="cp">#define OMAP_HSMMC_RSP76	0x011C</span>
<span class="cp">#define OMAP_HSMMC_DATA		0x0120</span>
<span class="cp">#define OMAP_HSMMC_HCTL		0x0128</span>
<span class="cp">#define OMAP_HSMMC_SYSCTL	0x012C</span>
<span class="cp">#define OMAP_HSMMC_STAT		0x0130</span>
<span class="cp">#define OMAP_HSMMC_IE		0x0134</span>
<span class="cp">#define OMAP_HSMMC_ISE		0x0138</span>
<span class="cp">#define OMAP_HSMMC_CAPA		0x0140</span>

<span class="cp">#define VS18			(1 &lt;&lt; 26)</span>
<span class="cp">#define VS30			(1 &lt;&lt; 25)</span>
<span class="cp">#define SDVS18			(0x5 &lt;&lt; 9)</span>
<span class="cp">#define SDVS30			(0x6 &lt;&lt; 9)</span>
<span class="cp">#define SDVS33			(0x7 &lt;&lt; 9)</span>
<span class="cp">#define SDVS_MASK		0x00000E00</span>
<span class="cp">#define SDVSCLR			0xFFFFF1FF</span>
<span class="cp">#define SDVSDET			0x00000400</span>
<span class="cp">#define AUTOIDLE		0x1</span>
<span class="cp">#define SDBP			(1 &lt;&lt; 8)</span>
<span class="cp">#define DTO			0xe</span>
<span class="cp">#define ICE			0x1</span>
<span class="cp">#define ICS			0x2</span>
<span class="cp">#define CEN			(1 &lt;&lt; 2)</span>
<span class="cp">#define CLKD_MASK		0x0000FFC0</span>
<span class="cp">#define CLKD_SHIFT		6</span>
<span class="cp">#define DTO_MASK		0x000F0000</span>
<span class="cp">#define DTO_SHIFT		16</span>
<span class="cp">#define INT_EN_MASK		0x307F0033</span>
<span class="cp">#define BWR_ENABLE		(1 &lt;&lt; 4)</span>
<span class="cp">#define BRR_ENABLE		(1 &lt;&lt; 5)</span>
<span class="cp">#define DTO_ENABLE		(1 &lt;&lt; 20)</span>
<span class="cp">#define INIT_STREAM		(1 &lt;&lt; 1)</span>
<span class="cp">#define DP_SELECT		(1 &lt;&lt; 21)</span>
<span class="cp">#define DDIR			(1 &lt;&lt; 4)</span>
<span class="cp">#define DMA_EN			0x1</span>
<span class="cp">#define MSBS			(1 &lt;&lt; 5)</span>
<span class="cp">#define BCE			(1 &lt;&lt; 1)</span>
<span class="cp">#define FOUR_BIT		(1 &lt;&lt; 1)</span>
<span class="cp">#define DDR			(1 &lt;&lt; 19)</span>
<span class="cp">#define DW8			(1 &lt;&lt; 5)</span>
<span class="cp">#define CC			0x1</span>
<span class="cp">#define TC			0x02</span>
<span class="cp">#define OD			0x1</span>
<span class="cp">#define ERR			(1 &lt;&lt; 15)</span>
<span class="cp">#define CMD_TIMEOUT		(1 &lt;&lt; 16)</span>
<span class="cp">#define DATA_TIMEOUT		(1 &lt;&lt; 20)</span>
<span class="cp">#define CMD_CRC			(1 &lt;&lt; 17)</span>
<span class="cp">#define DATA_CRC		(1 &lt;&lt; 21)</span>
<span class="cp">#define CARD_ERR		(1 &lt;&lt; 28)</span>
<span class="cp">#define STAT_CLEAR		0xFFFFFFFF</span>
<span class="cp">#define INIT_STREAM_CMD		0x00000000</span>
<span class="cp">#define DUAL_VOLT_OCR_BIT	7</span>
<span class="cp">#define SRC			(1 &lt;&lt; 25)</span>
<span class="cp">#define SRD			(1 &lt;&lt; 26)</span>
<span class="cp">#define SOFTRESET		(1 &lt;&lt; 1)</span>
<span class="cp">#define RESETDONE		(1 &lt;&lt; 0)</span>

<span class="cp">#define MMC_AUTOSUSPEND_DELAY	100</span>
<span class="cp">#define MMC_TIMEOUT_MS		20</span>
<span class="cp">#define OMAP_MMC_MIN_CLOCK	400000</span>
<span class="cp">#define OMAP_MMC_MAX_CLOCK	52000000</span>
<span class="cp">#define DRIVER_NAME		&quot;omap_hsmmc&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * One controller can have multiple slots, like on some omap boards using</span>
<span class="cm"> * omap.c controller driver. Luckily this is not currently done on any known</span>
<span class="cm"> * omap_hsmmc.c device.</span>
<span class="cm"> */</span>
<span class="cp">#define mmc_slot(host)		(host-&gt;pdata-&gt;slots[host-&gt;slot_id])</span>

<span class="cm">/*</span>
<span class="cm"> * MMC Host controller read/write API&#39;s</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP_HSMMC_READ(base, reg)	\</span>
<span class="cp">	__raw_readl((base) + OMAP_HSMMC_##reg)</span>

<span class="cp">#define OMAP_HSMMC_WRITE(base, reg, val) \</span>
<span class="cp">	__raw_writel((val), (base) + OMAP_HSMMC_##reg)</span>

<span class="k">struct</span> <span class="n">omap_hsmmc_next</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">dma_len</span><span class="p">;</span>
	<span class="n">s32</span>		<span class="n">cookie</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">device</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">mmc_host</span>	<span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">mmc_command</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">mmc_data</span>	<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">clk</span>		<span class="o">*</span><span class="n">fclk</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">clk</span>		<span class="o">*</span><span class="n">dbclk</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * vcc == configured supply</span>
<span class="cm">	 * vcc_aux == optional</span>
<span class="cm">	 *   -	MMC1, supply for DAT4..DAT7</span>
<span class="cm">	 *   -	MMC2/MMC2, external level shifter voltage supply, for</span>
<span class="cm">	 *	chip (SDIO, eMMC, etc) or transceiver (MMC2 only)</span>
<span class="cm">	 */</span>
	<span class="k">struct</span>	<span class="n">regulator</span>	<span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">regulator</span>	<span class="o">*</span><span class="n">vcc_aux</span><span class="p">;</span>
	<span class="kt">void</span>	<span class="n">__iomem</span>		<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">resource_size_t</span>		<span class="n">mapbase</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">irq_lock</span><span class="p">;</span> <span class="cm">/* Prevent races with irq handler */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dma_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dma_sg_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">bus_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">power_mode</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">bytesleft</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">suspended</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">use_dma</span><span class="p">,</span> <span class="n">dma_ch</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dma_line_tx</span><span class="p">,</span> <span class="n">dma_line_rx</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">slot_id</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">response_busy</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">context_loss</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">vdd</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">protect_card</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">reqs_blocked</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">use_reg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">req_in_progress</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_next</span>	<span class="n">next_data</span><span class="p">;</span>

	<span class="k">struct</span>	<span class="n">omap_mmc_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_card_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* NOTE: assumes card detect signal is active-low */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_get_wp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* NOTE: assumes write protect signal is active-high */</span>
	<span class="k">return</span> <span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_get_cover_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* NOTE: assumes card detect signal is active-low */</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value_cansleep</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_suspend_cdirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_detect_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_resume_cdirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_detect_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define omap_hsmmc_suspend_cdirq	NULL</span>
<span class="cp">#define omap_hsmmc_resume_cdirq		NULL</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_REGULATOR</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power_on</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">vdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span>
		<span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t see a Vcc regulator, assume it&#39;s a fixed</span>
<span class="cm">	 * voltage always-on regulator.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * With DT, never turn OFF the regulator. This is because</span>
<span class="cm">	 * the pbias cell programming support is still missing when</span>
<span class="cm">	 * booting with Device tree</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vdd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">before_set_reg</span><span class="p">)</span>
		<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">before_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">power_on</span><span class="p">,</span> <span class="n">vdd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assume Vcc regulator is used only to power the card ... OMAP</span>
<span class="cm">	 * VDDS is used to power the pins, optionally with a transceiver to</span>
<span class="cm">	 * support cards using voltages other than VDDS (1.8V nominal).  When a</span>
<span class="cm">	 * transceiver is used, DAT3..7 are muxed as transceiver control pins.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In some cases this regulator won&#39;t support enable/disable;</span>
<span class="cm">	 * e.g. it&#39;s a fixed rail for a WLAN chip.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In other cases vcc_aux switches interface power.  Example, for</span>
<span class="cm">	 * eMMC cards it represents VccQ.  Sometimes transceivers or SDIO</span>
<span class="cm">	 * chips/cards need an interface voltage rail too.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_regulator_set_ocr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="n">vdd</span><span class="p">);</span>
		<span class="cm">/* Enable interface voltage rail, if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_regulator_set_ocr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span>
							<span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Shut down the rail */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Then proceed to shut down the local regulator */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_regulator_set_ocr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span>
						<span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">after_set_reg</span><span class="p">)</span>
		<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">after_set_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">power_on</span><span class="p">,</span> <span class="n">vdd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_reg_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ocr_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span> <span class="o">=</span> <span class="n">omap_hsmmc_set_power</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vmmc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vmmc regulator missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">ocr_value</span> <span class="o">=</span> <span class="n">mmc_regulator_get_ocrmask</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span> <span class="o">=</span> <span class="n">ocr_value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span> <span class="o">&amp;</span> <span class="n">ocr_value</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ocrmask %x is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span><span class="p">);</span>
				<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Allow an aux regulator */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vmmc_aux&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">reg</span><span class="p">;</span>

		<span class="cm">/* For eMMC do not power off when not in sleep state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">no_regulator_off_init</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		* UGLY HACK:  workaround regulator framework bugs.</span>
<span class="cm">		* When the bootloader leaves a supply active, it&#39;s</span>
<span class="cm">		* initialized with zero usecount ... and we can&#39;t</span>
<span class="cm">		* disable it without first enabling it.  Until the</span>
<span class="cm">		* framework is fixed, we need a workaround like this</span>
<span class="cm">		* (which is safe for MMC, but not in general).</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulator_is_enabled</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span> <span class="o">&amp;&amp;</span> <span class="n">regulator_is_enabled</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">vdd</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span>
						 <span class="mi">1</span><span class="p">,</span> <span class="n">vdd</span><span class="p">);</span>
			<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_reg_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vcc_aux</span><span class="p">);</span>
	<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_have_reg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_reg_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_reg_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_have_reg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_gpio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cover</span><span class="p">)</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get_cover_state</span> <span class="o">=</span>
					<span class="n">omap_hsmmc_get_cover_state</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_detect</span> <span class="o">=</span> <span class="n">omap_hsmmc_card_detect</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_detect_irq</span> <span class="o">=</span>
				<span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">,</span> <span class="s">&quot;mmc_cd&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_sp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get_ro</span> <span class="o">=</span> <span class="n">omap_hsmmc_get_wp</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">,</span> <span class="s">&quot;mmc_wp&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_cd</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_wp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_wp:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">);</span>
<span class="nl">err_free_cd:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">))</span>
<span class="nl">err_free_sp:</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_gpio_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start clock to the card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_start_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">CEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop clock to the card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_stop_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;MMC Clock is not stoped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">INT_EN_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BRR_ENABLE</span> <span class="o">|</span> <span class="n">BWR_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">INT_EN_MASK</span><span class="p">;</span>

	<span class="cm">/* Disable timeout for erases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">MMC_ERASE</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DTO_ENABLE</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">STAT_CLEAR</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">ISE</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">ISE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">STAT_CLEAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Calculate divisor for the given clock frequency */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">calc_divisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dsor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsor</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">),</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsor</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">)</span>
			<span class="n">dsor</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dsor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Set clock to %uHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="n">omap_hsmmc_stop_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CLKD_MASK</span> <span class="o">|</span> <span class="n">DTO_MASK</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">regval</span> <span class="o">|</span> <span class="p">(</span><span class="n">calc_divisor</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">DTO</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">ICE</span><span class="p">);</span>

	<span class="cm">/* Wait till the ICS bit is set */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ICS</span>
		<span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">omap_hsmmc_start_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_set_bus_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">con</span><span class="p">;</span>

	<span class="n">con</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_DDR50</span><span class="p">)</span>
		<span class="n">con</span> <span class="o">|=</span> <span class="n">DDR</span><span class="p">;</span>	<span class="cm">/* configure in DDR mode */</span>
	<span class="k">else</span>
		<span class="n">con</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DDR</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_8</span>:
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">con</span> <span class="o">|</span> <span class="n">DW8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_4</span>:
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">con</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DW8</span><span class="p">);</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">FOUR_BIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_1</span>:
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">con</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DW8</span><span class="p">);</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FOUR_BIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_set_bus_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">con</span><span class="p">;</span>

	<span class="n">con</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_OPENDRAIN</span><span class="p">)</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">con</span> <span class="o">|</span> <span class="n">OD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">con</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/*</span>
<span class="cm"> * Restore the MMC host context, if it was lost as result of a</span>
<span class="cm"> * power state change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_context_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">context_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hctl</span><span class="p">,</span> <span class="n">capa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context_loss</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context_loss</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;context was %slost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">context_loss</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">context_loss</span> <span class="o">?</span> <span class="s">&quot;not &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">context_loss</span> <span class="o">==</span> <span class="n">context_loss</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Wait for hardware reset */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RESETDONE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RESETDONE</span>
		<span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="cm">/* Do software reset */</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">,</span> <span class="n">SOFTRESET</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RESETDONE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RESETDONE</span>
		<span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">)</span> <span class="o">|</span> <span class="n">AUTOIDLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">controller_flags</span> <span class="o">&amp;</span> <span class="n">OMAP_HSMMC_SUPPORTS_DUAL_VOLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">MMC_POWER_OFF</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MMC_VDD_23_24</span><span class="p">)</span>
			<span class="n">hctl</span> <span class="o">=</span> <span class="n">SDVS18</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hctl</span> <span class="o">=</span> <span class="n">SDVS30</span><span class="p">;</span>
		<span class="n">capa</span> <span class="o">=</span> <span class="n">VS30</span> <span class="o">|</span> <span class="n">VS18</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hctl</span> <span class="o">=</span> <span class="n">SDVS18</span><span class="p">;</span>
		<span class="n">capa</span> <span class="o">=</span> <span class="n">VS18</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">hctl</span><span class="p">);</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CAPA</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CAPA</span><span class="p">)</span> <span class="o">|</span> <span class="n">capa</span><span class="p">);</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SDBP</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDBP</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SDBP</span>
		<span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="n">omap_hsmmc_disable_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Do not initialize card-specific things if the power is off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">omap_hsmmc_set_bus_width</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">omap_hsmmc_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">omap_hsmmc_set_bus_mode</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">context_loss</span> <span class="o">=</span> <span class="n">context_loss</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;context is restored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Save the MMC host context (store the number of power state changes so far).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_context_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">context_loss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context_loss</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context_loss</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">context_loss</span> <span class="o">=</span> <span class="n">context_loss</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_context_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_context_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Send init stream sequence to card</span>
<span class="cm"> * before sending IDLE command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_init_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="n">INT_EN_MASK</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">)</span> <span class="o">|</span> <span class="n">INIT_STREAM</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">INIT_STREAM_CMD</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">CC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CC</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INIT_STREAM</span><span class="p">);</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">STAT_CLEAR</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">omap_hsmmc_cover_is_closed</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_cover_state</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_cover_state</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">omap_hsmmc_show_cover_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_host</span><span class="p">,</span> <span class="n">class_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">omap_hsmmc_cover_is_closed</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;closed&quot;</span> <span class="o">:</span> <span class="s">&quot;open&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cover_switch</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">omap_hsmmc_show_cover_switch</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">omap_hsmmc_show_slot_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_host</span><span class="p">,</span> <span class="n">class_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">slot_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">omap_hsmmc_show_slot_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the response type and send the cmd.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">omap_hsmmc_start_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmdreg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resptype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmdtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;%s: CMD%d, argument 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">omap_hsmmc_enable_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span>
			<span class="n">resptype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resptype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">resptype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unlike OMAP1 controller, the cmdtype does not seem to be based on</span>
<span class="cm">	 * ac, bc, adtc, bcr. Only commands ending an open ended transfer need</span>
<span class="cm">	 * a val of 0x3, rest 0x0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">cmdtype</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">cmdreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">resptype</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmdtype</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdreg</span> <span class="o">|=</span> <span class="n">DP_SELECT</span> <span class="o">|</span> <span class="n">MSBS</span> <span class="o">|</span> <span class="n">BCE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">cmdreg</span> <span class="o">|=</span> <span class="n">DDIR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmdreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DDIR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="n">cmdreg</span> <span class="o">|=</span> <span class="n">DMA_EN</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">req_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">ARG</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmdreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">omap_hsmmc_get_dma_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_request_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">req_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_ch</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">omap_hsmmc_disable_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="cm">/* Do not complete the request if DMA is still in progress */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">dma_ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notify the transfer complete to MMC core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">omap_hsmmc_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>

		<span class="cm">/* TC before CC from CMD6 - don&#39;t know why, but it happens */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span>
		    <span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">omap_hsmmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_hsmmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">omap_hsmmc_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notify the core about command completion</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">omap_hsmmc_cmd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* response type 2 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">RSP10</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">RSP32</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">RSP54</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">RSP76</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* response types 1, 1b, 3, 4, 5, 6 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">RSP10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">omap_hsmmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMA clean up for command errors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_dma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dma_ch</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">dma_ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
			<span class="n">omap_hsmmc_get_dma_dir</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Readable error output</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_dbg_report_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* --- means reserved bit without definition at documentation */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">omap_hsmmc_status_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;CC&quot;</span>  <span class="p">,</span> <span class="s">&quot;TC&quot;</span>  <span class="p">,</span> <span class="s">&quot;BGE&quot;</span><span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;BWR&quot;</span> <span class="p">,</span> <span class="s">&quot;BRR&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span>
		<span class="s">&quot;CIRQ&quot;</span><span class="p">,</span>	<span class="s">&quot;OBI&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;ERRI&quot;</span><span class="p">,</span>
		<span class="s">&quot;CTO&quot;</span> <span class="p">,</span> <span class="s">&quot;CCRC&quot;</span><span class="p">,</span> <span class="s">&quot;CEB&quot;</span><span class="p">,</span> <span class="s">&quot;CIE&quot;</span><span class="p">,</span> <span class="s">&quot;DTO&quot;</span> <span class="p">,</span> <span class="s">&quot;DCRC&quot;</span><span class="p">,</span> <span class="s">&quot;DEB&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span>
		<span class="s">&quot;ACE&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">,</span> <span class="s">&quot;CERR&quot;</span><span class="p">,</span> <span class="s">&quot;BADA&quot;</span><span class="p">,</span> <span class="s">&quot;---&quot;</span> <span class="p">,</span> <span class="s">&quot;---&quot;</span>
	<span class="p">};</span>
	<span class="kt">char</span> <span class="n">res</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MMC IRQ 0x%x :&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">omap_hsmmc_status_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">omap_hsmmc_status_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_dbg_report_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_MMC_DEBUG */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * MMC controller internal state machines reset</span>
<span class="cm"> *</span>
<span class="cm"> * Used to reset command or data internal state machines, using respectively</span>
<span class="cm"> *  SRC or SRD bit of SYSCTL register</span>
<span class="cm"> * Can be called from interrupt context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">loops_per_jiffy</span> <span class="o">*</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MMC_TIMEOUT_MS</span><span class="p">));</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span>
			 <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">bit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * OMAP4 ES2 and greater has an updated reset logic.</span>
<span class="cm">	 * Monitor a 0-&gt;1 transition first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HSMMC_HAS_UPDATED_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;Timeout waiting on controller reset in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_do_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end_trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* Flush posted write */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">INT_EN_MASK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;IRQ Status is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_hsmmc_dbg_report_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CMD_TIMEOUT</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CMD_CRC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CMD_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
									<span class="n">SRC</span><span class="p">);</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">end_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
					<span class="n">omap_hsmmc_dma_cleanup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
								<span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SRD</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DATA_TIMEOUT</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DATA_CRC</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DATA_TIMEOUT</span><span class="p">)</span> <span class="o">?</span>
						<span class="o">-</span><span class="n">ETIMEDOUT</span> <span class="o">:</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
					<span class="n">omap_hsmmc_dma_cleanup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">response_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SRD</span><span class="p">);</span>
				<span class="n">end_trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CARD_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
				<span class="s">&quot;Ignoring card err CMD%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
				<span class="n">end_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
				<span class="n">end_trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_cmd</span> <span class="o">||</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span>
		<span class="n">omap_hsmmc_cmd_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">end_trans</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TC</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="n">omap_hsmmc_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MMC controller IRQ handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_hsmmc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">omap_hsmmc_do_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="cm">/* Flush posted write */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">INT_EN_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_sd_bus_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
			 <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SDBP</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops_per_jiffy</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDBP</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch MMC interface voltage ... only relevant for MMC1.</span>
<span class="cm"> *</span>
<span class="cm"> * MMC2 and MMC3 use fixed 1.8V levels, and maybe a transceiver.</span>
<span class="cm"> * The MMC2 transceiver controls are used instead of DAT4..DAT7.</span>
<span class="cm"> * Some chips, like eMMC ones, use internal transceivers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_switch_opcond</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Disable the clocks */</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>

	<span class="cm">/* Turn the power off */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Turn the power ON with given VDD 1.8 or 3.0v */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					       <span class="n">vdd</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
		<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDVSCLR</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a MMC dual voltage card is detected, the set_ios fn calls</span>
<span class="cm">	 * this fn with VDD bit set for 1.8V. Upon card removal from the</span>
<span class="cm">	 * slot, omap_hsmmc_set_ios sets the VDD back to 3V on MMC_POWER_OFF.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Cope with a bit of slop in the range ... per data sheets:</span>
<span class="cm">	 *  - &quot;1.8V&quot; for vdds_mmc1/vdds_mmc1a can be up to 2.45V max,</span>
<span class="cm">	 *    but recommended values are 1.71V to 1.89V</span>
<span class="cm">	 *  - &quot;3.0V&quot; for vdds_mmc1/vdds_mmc1a can be up to 3.5V max,</span>
<span class="cm">	 *    but recommended values are 2.7V to 3.3V</span>
<span class="cm">	 *</span>
<span class="cm">	 * Board setup code shouldn&#39;t permit anything very out-of-range.</span>
<span class="cm">	 * TWL4030-family VMMC1 and VSIM regulators are fine (avoiding the</span>
<span class="cm">	 * middle range) but VSIM can&#39;t power DAT4..DAT7 at more than 3V.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vdd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MMC_VDD_23_24</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">SDVS18</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">SDVS30</span><span class="p">;</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>
	<span class="n">set_sd_bus_power</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Unable to switch operating voltage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Protect the card while the cover is open */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_protect_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_cover_state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">reqs_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_cover_state</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cover is closed, &quot;</span>
					 <span class="s">&quot;card is now accessible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cover is open, &quot;</span>
					 <span class="s">&quot;card is now inaccessible</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * irq handler to notify the core about card insertion/removal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">omap_hsmmc_detect</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_mmc_slot_data</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">carddetect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cover_switch&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">card_detect</span><span class="p">)</span>
		<span class="n">carddetect</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">card_detect</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">omap_hsmmc_protect_card</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">carddetect</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carddetect</span><span class="p">)</span>
		<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_get_dma_sync_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sync_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_line_tx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_line_rx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sync_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_config_dma_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">nblk</span><span class="p">,</span> <span class="n">dma_ch</span><span class="p">;</span>

	<span class="n">dma_ch</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">OMAP_HSMMC_DATA</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
			<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">OMAP_HSMMC_DATA</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
			<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">blksz</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="n">nblk</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sgl</span><span class="p">)</span> <span class="o">/</span> <span class="n">blksz</span><span class="p">;</span>

	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S32</span><span class="p">,</span>
			<span class="n">blksz</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nblk</span><span class="p">,</span> <span class="n">OMAP_DMA_SYNC_FRAME</span><span class="p">,</span>
			<span class="n">omap_hsmmc_get_dma_sync_dev</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>
			<span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">));</span>

	<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMA call back function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_dma_cb</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">cb_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_ch</span><span class="p">,</span> <span class="n">req_in_progress</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch_status</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;unexpected dma status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_sg_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_sg_idx</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fire up the next transfer. */</span>
		<span class="n">omap_hsmmc_config_dma_params</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					   <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_sg_idx</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span><span class="p">)</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
			     <span class="n">omap_hsmmc_get_dma_dir</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>

	<span class="n">req_in_progress</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req_in_progress</span><span class="p">;</span>
	<span class="n">dma_ch</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">);</span>

	<span class="cm">/* If DMA has finished after TC, complete the request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_pre_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">omap_hsmmc_next</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">&amp;&amp;</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[%s] invalid cookie: data-&gt;host_cookie %d&quot;</span>
		       <span class="s">&quot; host-&gt;next_data.cookie %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">cookie</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if next job is already prepared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">cookie</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
				     <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				     <span class="n">omap_hsmmc_get_dma_dir</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_len</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">dma_len</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">dma_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">dma_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">dma_len</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="o">++</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">dma_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Routine to configure and start DMA for the MMC card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_start_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Sanity check: all the SG entries must be aligned by block size. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>

		<span class="n">sgl</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgl</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">%</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* REVISIT: The MMC buffer increments only when MSB is written.</span>
<span class="cm">		 * Return error for blksz which is non multiple of four.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">omap_hsmmc_get_dma_sync_dev</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>
			       <span class="s">&quot;MMC/SD&quot;</span><span class="p">,</span> <span class="n">omap_hsmmc_dma_cb</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;%s: omap_request_dma() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_hsmmc_pre_dma_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_sg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">omap_hsmmc_config_dma_params</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_data_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout_ns</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout_clks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">cycle_ns</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clkd</span><span class="p">,</span> <span class="n">dto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">);</span>
	<span class="n">clkd</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">CLKD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CLKD_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clkd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clkd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cycle_ns</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">)</span> <span class="o">/</span> <span class="n">clkd</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout_ns</span> <span class="o">/</span> <span class="n">cycle_ns</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">timeout_clks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">timeout</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dto</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dto</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">dto</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">dto</span><span class="p">)</span>
			<span class="n">dto</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dto</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">)</span>
			<span class="n">dto</span> <span class="o">-=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dto</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
			<span class="n">dto</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DTO_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">dto</span> <span class="o">&lt;&lt;</span> <span class="n">DTO_SHIFT</span><span class="p">;</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure block length for MMC/SD cards and initiate the transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">omap_hsmmc_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">BLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set an arbitrary 100ms data timeout for commands with</span>
<span class="cm">		 * busy signal.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">)</span>
			<span class="n">set_data_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">100000000U</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">BLK</span><span class="p">,</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">set_data_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_hsmmc_start_dma_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;MMC start dma failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_post_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span><span class="p">)</span>
			<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
				     <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				     <span class="n">omap_hsmmc_get_dma_dir</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_pre_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">is_first_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap_hsmmc_pre_dma_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">))</span>
			<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">host_cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Request function. for read/write operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req_in_progress</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">protect_card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">reqs_blocked</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Ensure the controller is left in a consistent</span>
<span class="cm">			 * state by resetting the command and data state</span>
<span class="cm">			 * machines.</span>
<span class="cm">			 */</span>
			<span class="n">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SRD</span><span class="p">);</span>
			<span class="n">omap_hsmmc_reset_controller_fsm</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SRC</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">reqs_blocked</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">reqs_blocked</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">reqs_blocked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">omap_hsmmc_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_hsmmc_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Routine to configure clock values. Exposed API to core */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">do_send_init_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MMC_POWER_OFF</span>:
			<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span>
						 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_POWER_UP</span>:
			<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">,</span>
						 <span class="mi">1</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_POWER_ON</span>:
			<span class="n">do_send_init_stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: set registers based only on changes to ios */</span>

	<span class="n">omap_hsmmc_set_bus_width</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">controller_flags</span> <span class="o">&amp;</span> <span class="n">OMAP_HSMMC_SUPPORTS_DUAL_VOLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only MMC1 can interface at 3V without some flavor</span>
<span class="cm">		 * of external transceiver; but they all handle 1.8V.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDVSDET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">==</span> <span class="n">DUAL_VOLT_OCR_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="cm">/*</span>
<span class="cm">			 * With pbias cell programming missing, this</span>
<span class="cm">			 * can&#39;t be allowed when booting with device</span>
<span class="cm">			 * tree.</span>
<span class="cm">			 */</span>
			<span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The mmc_select_voltage fn of the core does</span>
<span class="cm">				 * not seem to set the power_mode to</span>
<span class="cm">				 * MMC_POWER_UP upon recalculating the voltage.</span>
<span class="cm">				 * vdd 1.8v.</span>
<span class="cm">				 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">omap_hsmmc_switch_opcond</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
						<span class="s">&quot;Switch operation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">omap_hsmmc_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_send_init_stream</span><span class="p">)</span>
		<span class="n">send_init_stream</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">omap_hsmmc_set_bus_mode</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_get_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_ro</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_ro</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">init_card</span><span class="p">)</span>
		<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">init_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_conf_bus_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hctl</span><span class="p">,</span> <span class="n">capa</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Only MMC1 supports 3.0V */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">controller_flags</span> <span class="o">&amp;</span> <span class="n">OMAP_HSMMC_SUPPORTS_DUAL_VOLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hctl</span> <span class="o">=</span> <span class="n">SDVS30</span><span class="p">;</span>
		<span class="n">capa</span> <span class="o">=</span> <span class="n">VS30</span> <span class="o">|</span> <span class="n">VS18</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hctl</span> <span class="o">=</span> <span class="n">SDVS18</span><span class="p">;</span>
		<span class="n">capa</span> <span class="o">=</span> <span class="n">VS18</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDVS_MASK</span><span class="p">;</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="n">hctl</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CAPA</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CAPA</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="n">capa</span><span class="p">);</span>

	<span class="cm">/* Set the controller to AUTO IDLE mode */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">);</span>
	<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">,</span> <span class="n">value</span> <span class="o">|</span> <span class="n">AUTOIDLE</span><span class="p">);</span>

	<span class="cm">/* Set SD bus power bit */</span>
	<span class="n">set_sd_bus_power</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_enable_fclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_disable_fclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">omap_hsmmc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">omap_hsmmc_enable_fclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">omap_hsmmc_disable_fclk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_req</span> <span class="o">=</span> <span class="n">omap_hsmmc_post_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_req</span> <span class="o">=</span> <span class="n">omap_hsmmc_pre_req</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">omap_hsmmc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span> <span class="o">=</span> <span class="n">omap_hsmmc_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span> <span class="o">=</span> <span class="n">omap_hsmmc_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span> <span class="o">=</span> <span class="n">omap_hsmmc_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_card</span> <span class="o">=</span> <span class="n">omap_hsmmc_init_card</span><span class="p">,</span>
	<span class="cm">/* NYET -- enable_sdio_irq */</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_regs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">context_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">)</span>
		<span class="n">context_loss</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_context_loss_count</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;mmc%d:</span><span class="se">\n</span><span class="s"> ctx_loss:</span><span class="se">\t</span><span class="s">%d:%d</span><span class="se">\n\n</span><span class="s">regs:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">context_loss</span><span class="p">,</span> <span class="n">context_loss</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;host suspended, can&#39;t read registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;SYSCONFIG:</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CON:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CON</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;HCTL:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;SYSCTL:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">SYSCTL</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;IE:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">IE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ISE:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">ISE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CAPA:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CAPA</span><span class="p">));</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_regs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">omap_hsmmc_regs_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mmc_regs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>           <span class="o">=</span> <span class="n">omap_hsmmc_regs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>           <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>         <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>        <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">)</span>
		<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;regs&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span>
			<span class="n">mmc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_regs_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">omap_hsmmc_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">omap4_reg_offset</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">omap_mmc_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap2-hsmmc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap3-hsmmc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;ti,omap4-hsmmc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap4_reg_offset</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">omap_mmc_of_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="nf">of_get_hsmmc_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* out of memory */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ti,dual-volt&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">controller_flags</span> <span class="o">|=</span> <span class="n">OMAP_HSMMC_SUPPORTS_DUAL_VOLT</span><span class="p">;</span>

	<span class="cm">/* This driver only supports 1 slot */</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_slots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">switch_pin</span> <span class="o">=</span> <span class="n">of_get_named_gpio</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cd-gpios&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gpio_wp</span> <span class="o">=</span> <span class="n">of_get_named_gpio</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;wp-gpios&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ti,non-removable&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nonremovable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">no_regulator_off_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;bus-width&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_8_BIT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_find_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ti,needs-special-reset&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">features</span> <span class="o">|=</span> <span class="n">HSMMC_HAS_UPDATED_RESET</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">omap_mmc_platform_data</span>
			<span class="o">*</span><span class="nf">of_get_hsmmc_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">omap_hsmmc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">of_match_ptr</span><span class="p">(</span><span class="n">omap_mmc_of_match</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">of_get_hsmmc_pdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="o">*</span><span class="n">offsetp</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="o">*</span><span class="n">offsetp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Platform Data is missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_slots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No Slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_hsmmc_gpio_init</span><span class="p">(</span><span class="n">pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">omap_hsmmc_host</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span>		<span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span>	<span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span>	<span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span>	<span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span>	<span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">SZ_4K</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">MMC_POWER_OFF</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">next_data</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_hsmmc_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If regulator_disable can only put vcc_aux to sleep then there is</span>
<span class="cm">	 * no off state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">vcc_aux_disable_is_sleep</span><span class="p">)</span>
		<span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">no_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">OMAP_MMC_MIN_CLOCK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">OMAP_MMC_MAX_CLOCK</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">controller_flags</span> <span class="o">&amp;</span> <span class="n">OMAP_HSMMC_BROKEN_MULTIBLOCK_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;multiblock reads disabled due to 35xx erratum 2.1.1.128; MMC read performance may suffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps2</span> <span class="o">|=</span> <span class="n">MMC_CAP2_NO_MULTI_READ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MMC_AUTOSUSPEND_DELAY</span><span class="p">);</span>
	<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">omap_hsmmc_context_save</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mmchsdb_fck&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * MMC can still work without debounce clock.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Failed to get debounce clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Failed to enable debounce clk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Since we do only SG emulation, we can have as many segs</span>
<span class="cm">	 * as we want. */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>       <span class="cm">/* Block Length at max can be 1024 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>    <span class="cm">/* No. of Blocks is 16 bits */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_MMC_HIGHSPEED</span> <span class="o">|</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span> <span class="o">|</span>
		     <span class="n">MMC_CAP_WAIT_WHILE_BUSY</span> <span class="o">|</span> <span class="n">MMC_CAP_ERASE</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">caps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_8_BIT_DATA</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">nonremovable</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_NONREMOVABLE</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_caps</span> <span class="o">=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">pm_caps</span><span class="p">;</span>

	<span class="n">omap_hsmmc_conf_bus_power</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="s">&quot;tx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;cannot get DMA TX channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_line_tx</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="s">&quot;rx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;cannot get DMA RX channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_line_rx</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Request IRQ for MMC operations */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">omap_hsmmc_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Unable to grab HSMMC IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
				<span class="s">&quot;Unable to configure MMC IRQs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_irq_cd_init</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap_hsmmc_have_reg</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">set_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">omap_hsmmc_reg_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_reg</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">ocr_mask</span><span class="p">;</span>

	<span class="cm">/* Request IRQ for card detect */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">,</span>
					   <span class="n">omap_hsmmc_detect</span><span class="p">,</span>
					   <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span><span class="p">,</span>
					   <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
				<span class="s">&quot;Unable to grab MMC CD IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_irq_cd</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">omap_hsmmc_suspend_cdirq</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span> <span class="o">=</span> <span class="n">omap_hsmmc_resume_cdirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_hsmmc_disable_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">omap_hsmmc_protect_card</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_slot_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_slot_name</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">get_cover_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev_attr_cover_switch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_slot_name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">omap_hsmmc_debugfs</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_slot_name:</span>
	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_irq_cd:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_reg</span><span class="p">)</span>
		<span class="n">omap_hsmmc_reg_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_reg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_irq_cd_init:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err1:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
<span class="nl">err_alloc:</span>
	<span class="n">omap_hsmmc_gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">omap_hsmmc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_reg</span><span class="p">)</span>
		<span class="n">omap_hsmmc_reg_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mmc_slot</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="n">card_detect_irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">omap_hsmmc_gpio_free</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to handle MMC board&quot;</span>
					<span class="s">&quot; level suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unmask interrupt failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_KEEP_POWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">omap_hsmmc_disable_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">OMAP_HSMMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">,</span>
				<span class="n">OMAP_HSMMC_READ</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">HCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDBP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Routine to resume the MMC device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">)</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dbclk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_KEEP_POWER</span><span class="p">))</span>
		<span class="n">omap_hsmmc_conf_bus_power</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unmask interrupt failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">omap_hsmmc_protect_card</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Notify the core to resume the host */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define omap_hsmmc_suspend	NULL</span>
<span class="cp">#define omap_hsmmc_resume		NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">omap_hsmmc_context_save</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">omap_hsmmc_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_hsmmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">omap_hsmmc_context_restore</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">omap_hsmmc_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">omap_hsmmc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">omap_hsmmc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">omap_hsmmc_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">omap_hsmmc_runtime_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap_hsmmc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">omap_hsmmc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">omap_hsmmc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">omap_hsmmc_dev_pm_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">omap_mmc_of_match</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">omap_hsmmc_driver</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP High Speed Multimedia Card driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments Inc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
