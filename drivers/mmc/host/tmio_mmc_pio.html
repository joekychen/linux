<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › tmio_mmc_pio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tmio_mmc_pio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/mmc/host/tmio_mmc_pio.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Guennadi Liakhovetski</span>
<span class="cm"> * Copyright (C) 2007 Ian Molton</span>
<span class="cm"> * Copyright (C) 2004 Ian Molton</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver for the MMC / SD / SDIO IP found in:</span>
<span class="cm"> *</span>
<span class="cm"> * TC6393XB, TC6391XB, TC6387XB, T7L66XB, ASIC3, SH-Mobile SoCs</span>
<span class="cm"> *</span>
<span class="cm"> * This driver draws mainly on scattered spec sheets, Reverse engineering</span>
<span class="cm"> * of the toshiba e800  SD driver and some parts of the 2.4 ASIC3 driver (4 bit</span>
<span class="cm"> * support). (Further 4 bit support from a later datasheet).</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *   Investigate using a workqueue for PIO transfers</span>
<span class="cm"> *   Eliminate FIXMEs</span>
<span class="cm"> *   SDIO support</span>
<span class="cm"> *   Better Power management</span>
<span class="cm"> *   Handle MMC errors better</span>
<span class="cm"> *   double buffer support</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/tmio.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/cd-gpio.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/tmio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_qos.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;tmio_mmc.h&quot;</span>

<span class="kt">void</span> <span class="nf">tmio_mmc_enable_mmc_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">TMIO_MASK_IRQ</span><span class="p">);</span>
	<span class="n">sd_ctrl_write32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_IRQ_MASK</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">TMIO_MASK_IRQ</span><span class="p">);</span>
	<span class="n">sd_ctrl_write32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_IRQ_MASK</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_ack_mmc_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sd_ctrl_write32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STATUS</span><span class="p">,</span> <span class="o">~</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_init_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_orig</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmio_mmc_next_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">--</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>

<span class="cp">#define STATUS_TO_TEXT(a, status, i) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (status &amp; TMIO_STAT_##a) { \</span>
<span class="cp">			if (i++) \</span>
<span class="cp">				printk(&quot; | &quot;); \</span>
<span class="cp">			printk(#a); \</span>
<span class="cp">		} \</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pr_debug_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;status: %08x = &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CARD_REMOVE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CARD_INSERT</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">SIGSTATE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">WRPROTECT</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CARD_REMOVE_A</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CARD_INSERT_A</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">SIGSTATE_A</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CMD_IDX_ERR</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">STOPBIT_ERR</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">ILL_FUNC</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CMDRESPEND</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">DATAEND</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CRCFAIL</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">DATATIMEOUT</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">CMDTIMEOUT</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">RXOVERFLOW</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">TXUNDERRUN</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">RXRDY</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">TXRQ</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">STATUS_TO_TEXT</span><span class="p">(</span><span class="n">ILL_ACCESS</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define pr_debug_status(s)  do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_enable_sdio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq_mask</span> <span class="o">=</span> <span class="n">TMIO_SDIO_MASK_ALL</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">TMIO_SDIO_STAT_IOIRQ</span><span class="p">;</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_TRANSACTION_CTL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SDIO_IRQ_MASK</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq_mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq_mask</span> <span class="o">=</span> <span class="n">TMIO_SDIO_MASK_ALL</span><span class="p">;</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SDIO_IRQ_MASK</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq_mask</span><span class="p">);</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_TRANSACTION_CTL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span><span class="p">,</span> <span class="n">clk</span> <span class="o">=</span> <span class="mh">0x80000080</span><span class="p">;</span>
			<span class="n">new_clock</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">clock</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span> <span class="n">clk</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">clock</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">set_clk_div</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">set_clk_div</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">clk</span><span class="o">&gt;&gt;</span><span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CARD_CLK_CTL</span><span class="p">,</span> <span class="n">clk</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_clk_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* implicit BUG_ON(!res) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_CLK_AND_WAIT_CTL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CARD_CLK_CTL</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0100</span> <span class="o">&amp;</span>
		<span class="n">sd_ctrl_read16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CARD_CLK_CTL</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_clk_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CARD_CLK_CTL</span><span class="p">,</span> <span class="mh">0x0100</span> <span class="o">|</span>
		<span class="n">sd_ctrl_read16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CARD_CLK_CTL</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* implicit BUG_ON(!res) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_CLK_AND_WAIT_CTL</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* FIXME - should we set stop clock reg here */</span>
	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_RESET_SD</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="cm">/* implicit BUG_ON(!res) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_RESET_SDIO</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_RESET_SD</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_RESET_SDIO</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tmio_mmc_host</span><span class="p">,</span>
						  <span class="n">delayed_reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * is request already finished? Since we use a non-blocking</span>
<span class="cm">	 * cancel_delayed_work(), it can happen, that a .set_ios() call preempts</span>
<span class="cm">	 * us, so, have to check for IS_ERR(host-&gt;mrq)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">mrq</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">last_req_ts</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;timeout waiting for hardware interrupt (CMD%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tmio_mmc_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Ready for new calls */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tmio_mmc_abort_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called with host-&gt;lock held, interrupts disabled */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_finish_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">mrq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">delayed_reset_work</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">||</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">))</span>
		<span class="n">tmio_mmc_abort_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_done_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tmio_mmc_host</span><span class="p">,</span>
						  <span class="n">done</span><span class="p">);</span>
	<span class="n">tmio_mmc_finish_request</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* These are the bitmasks the tmio chip requires to implement the MMC response</span>
<span class="cm"> * types. Note that R1 and R6 are the same in this scheme. */</span>
<span class="cp">#define APP_CMD        0x0040</span>
<span class="cp">#define RESP_NONE      0x0300</span>
<span class="cp">#define RESP_R1        0x0400</span>
<span class="cp">#define RESP_R1B       0x0500</span>
<span class="cp">#define RESP_R2        0x0600</span>
<span class="cp">#define RESP_R3        0x0700</span>
<span class="cp">#define DATA_PRESENT   0x0800</span>
<span class="cp">#define TRANSFER_READ  0x1000</span>
<span class="cp">#define TRANSFER_MULTI 0x2000</span>
<span class="cp">#define SECURITY_CMD   0x4000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmio_mmc_start_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_mask</span> <span class="o">=</span> <span class="n">TMIO_MASK_CMD</span><span class="p">;</span>

	<span class="cm">/* Command 12 is handled by hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STOP_INTERNAL_ACTION</span><span class="p">,</span> <span class="mh">0x001</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_RSP_NONE</span>: <span class="n">c</span> <span class="o">|=</span> <span class="n">RESP_NONE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1</span>:   <span class="n">c</span> <span class="o">|=</span> <span class="n">RESP_R1</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1B</span>:  <span class="n">c</span> <span class="o">|=</span> <span class="n">RESP_R1B</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R2</span>:   <span class="n">c</span> <span class="o">|=</span> <span class="n">RESP_R2</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R3</span>:   <span class="n">c</span> <span class="o">|=</span> <span class="n">RESP_R3</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Unknown response type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

<span class="cm">/* FIXME - this seems to be ok commented out but the spec suggest this bit</span>
<span class="cm"> *         should be set when issuing app commands.</span>
<span class="cm"> *	if(cmd-&gt;flags &amp; MMC_FLAG_ACMD)</span>
<span class="cm"> *		c |= APP_CMD;</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">|=</span> <span class="n">DATA_PRESENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STOP_INTERNAL_ACTION</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
			<span class="n">c</span> <span class="o">|=</span> <span class="n">TRANSFER_MULTI</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">|=</span> <span class="n">TRANSFER_READ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">native_hotplug</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TMIO_STAT_CARD_REMOVE</span> <span class="o">|</span> <span class="n">TMIO_STAT_CARD_INSERT</span><span class="p">);</span>
	<span class="n">tmio_mmc_enable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>

	<span class="cm">/* Fire off the command */</span>
	<span class="n">sd_ctrl_write32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_ARG_REG</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_CMD</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This chip always returns (at least?) as much data as you ask for.</span>
<span class="cm"> * I&#39;m unsure what happens if you ask for less than a block. This should be</span>
<span class="cm"> * looked into to ensure that a funny length read doesn&#39;t hose the controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_pio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sg_virt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PIO IRQ in DMA mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Spurious PIO IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_virt</span> <span class="o">=</span> <span class="n">tmio_mmc_kmap_atomic</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">sg_virt</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;count: %08x offset: %08x flags %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">count</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Transfer the data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">sd_ctrl_read16_rep</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_DATA_PORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sd_ctrl_write16_rep</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_DATA_PORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">tmio_mmc_kunmap_atomic</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">sg_virt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_off</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">tmio_mmc_next_sg</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_check_bounce_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_ptr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">sg_vaddr</span> <span class="o">=</span> <span class="n">tmio_mmc_kmap_atomic</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_orig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sg_vaddr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_sg</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">tmio_mmc_kunmap_atomic</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_orig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">sg_vaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* needs to be called with host-&gt;lock held */</span>
<span class="kt">void</span> <span class="nf">tmio_mmc_do_data_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">stop</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Spurious data end IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">stop</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>

	<span class="cm">/* FIXME - return correct transfer count on errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Completed data request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: other drivers allow an optional stop command of any given type</span>
<span class="cm">	 *        which we dont do, as the chip can auto generate them.</span>
<span class="cm">	 *        Perhaps we can be smarter about when to use auto CMD12 and</span>
<span class="cm">	 *        only issue the auto request when we know this is the desired</span>
<span class="cm">	 *        stop command, allowing fallback to the stop command the</span>
<span class="cm">	 *        upper layers expect. For now, we do what works.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span><span class="p">)</span>
			<span class="n">tmio_mmc_check_bounce_buffer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Complete Rx request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Complete Tx request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span>
			<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STOP_INTERNAL_ACTION</span><span class="p">,</span> <span class="mh">0x000</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_data_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_tx</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Has all data been written out yet? Testing on SuperH showed,</span>
<span class="cm">		 * that in most cases the first interrupt comes already with the</span>
<span class="cm">		 * BUSY status bit clear, but on some operations, like mount or</span>
<span class="cm">		 * in the beginning of a write / sync / umount, there is one</span>
<span class="cm">		 * DATAEND interrupt with the BUSY bit set, in this cases</span>
<span class="cm">		 * waiting for one more interrupt fixes the problem.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sd_ctrl_read32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_CMD_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_STAT_DATAEND</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_complete</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_rx</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_STAT_DATAEND</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_complete</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmio_mmc_do_data_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_MASK_READOP</span> <span class="o">|</span> <span class="n">TMIO_MASK_WRITEOP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_cmd_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Spurious CMD irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* This controller is sicker than the PXA one. Not only do we need to</span>
<span class="cm">	 * drop the top 8 bits of the first response word, we also need to</span>
<span class="cm">	 * modify the order of the response for short response command types.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">CTL_RESPONSE</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd_ctrl_read32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>  <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_R3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_CMDTIMEOUT</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_CRCFAIL</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_CRC</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="cm">/* If there is data to handle we enable data IRQs here, and</span>
<span class="cm">	 * we will ultimatley finish the request in the data_end handler.</span>
<span class="cm">	 * If theres no data or we encountered an error, finish now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span>
				<span class="n">tmio_mmc_enable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_MASK_READOP</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_issue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span>
				<span class="n">tmio_mmc_enable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_MASK_WRITEOP</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_issue</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_card_irq_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="o">*</span><span class="n">ireg</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">sd_ctrl_read32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STATUS</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ireg</span> <span class="o">=</span> <span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TMIO_MASK_IRQ</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span><span class="p">;</span>

	<span class="n">pr_debug_status</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">);</span>
	<span class="n">pr_debug_status</span><span class="p">(</span><span class="o">*</span><span class="n">ireg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__tmio_mmc_card_detect_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>

	<span class="cm">/* Card insert / remove attempts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMIO_STAT_CARD_INSERT</span> <span class="o">|</span> <span class="n">TMIO_STAT_CARD_REMOVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmio_mmc_ack_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_STAT_CARD_INSERT</span> <span class="o">|</span>
			<span class="n">TMIO_STAT_CARD_REMOVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_CARD_REMOVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">((</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_CARD_INSERT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">.</span><span class="n">work</span><span class="p">))</span>
			<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">tmio_mmc_card_detect_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>

	<span class="n">tmio_mmc_card_irq_status</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">__tmio_mmc_card_detect_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_card_detect_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">__tmio_mmc_sdcard_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Command completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMIO_STAT_CMDRESPEND</span> <span class="o">|</span> <span class="n">TMIO_STAT_CMDTIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmio_mmc_ack_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
			     <span class="n">TMIO_STAT_CMDRESPEND</span> <span class="o">|</span>
			     <span class="n">TMIO_STAT_CMDTIMEOUT</span><span class="p">);</span>
		<span class="n">tmio_mmc_cmd_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMIO_STAT_RXRDY</span> <span class="o">|</span> <span class="n">TMIO_STAT_TXRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmio_mmc_ack_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_STAT_RXRDY</span> <span class="o">|</span> <span class="n">TMIO_STAT_TXRQ</span><span class="p">);</span>
		<span class="n">tmio_mmc_pio_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data transfer completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_DATAEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmio_mmc_ack_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_STAT_DATAEND</span><span class="p">);</span>
		<span class="n">tmio_mmc_data_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">tmio_mmc_sdcard_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>

	<span class="n">tmio_mmc_card_irq_status</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">__tmio_mmc_sdcard_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_sdcard_irq</span><span class="p">);</span>

<span class="n">irqreturn_t</span> <span class="nf">tmio_mmc_sdio_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_SDIO_IRQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sd_ctrl_read16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SDIO_STATUS</span><span class="p">);</span>
	<span class="n">ireg</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">TMIO_SDIO_MASK_ALL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span><span class="p">;</span>

	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SDIO_STATUS</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TMIO_SDIO_MASK_ALL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_SDIO_IRQ</span> <span class="o">&amp;&amp;</span> <span class="n">ireg</span> <span class="o">&amp;</span> <span class="n">TMIO_SDIO_STAT_IOIRQ</span><span class="p">)</span>
		<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_sdio_irq</span><span class="p">);</span>

<span class="n">irqreturn_t</span> <span class="nf">tmio_mmc_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MMC IRQ begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tmio_mmc_card_irq_status</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__tmio_mmc_card_detect_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__tmio_mmc_sdcard_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ireg</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">tmio_mmc_sdio_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">devid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_irq</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmio_mmc_start_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;setup data transfer: blocksize %08x  nr_blocks %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>

	<span class="cm">/* Some hardware cannot perform 2 byte requests in 4 bit mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">.</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">blksz_2bytes</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_BLKSZ_2BYTES</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">blksz_2bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %d byte block unsupported in 4 bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tmio_mmc_init_sg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Set transfer length / blocksize */</span>
	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_XFER_LEN</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>
	<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_XFER_BLK_COUNT</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">);</span>

	<span class="n">tmio_mmc_start_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process requests from the MMC layer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;request not null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">last_req_ts</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tmio_mmc_start_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tmio_mmc_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">delayed_reset_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">fail:</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">force_pio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set MMC clock / power.</span>
<span class="cm"> * Note: This controller uses a simple divider scheme therefore it cannot</span>
<span class="cm"> * run a MMC card at full speed (20MHz). The max clock is 24MHz on SD, but as</span>
<span class="cm"> * MMC wont run that fast, it has to be clocked at 12MHz which is the next</span>
<span class="cm"> * slowest setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tmio_mmc_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ios_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s.%d: concurrent .set_ios(), clk %u, mode %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				<span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s.%d: CMD%u active since %lu, now %lu!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">last_req_ts</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ios_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * host-&gt;power toggles between false and true in both cases - either</span>
<span class="cm">	 * or not the controller can be runtime-suspended during inactivity.</span>
<span class="cm">	 * But if the controller has to be kept on, the runtime-pm usage_count</span>
<span class="cm">	 * is kept positive, so no suspending actually takes place.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_ON</span> <span class="o">&amp;&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmio_mmc_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="cm">/* power up SD bus */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">set_pwr</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">set_pwr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* start bus clock */</span>
		<span class="n">tmio_mmc_clk_start</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">MMC_POWER_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">set_pwr</span> <span class="o">&amp;&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">set_pwr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmio_mmc_clk_stop</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_1</span>:
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_MEM_CARD_OPT</span><span class="p">,</span> <span class="mh">0x80e0</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_4</span>:
		<span class="n">sd_ctrl_write16</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_SD_MEM_CARD_OPT</span><span class="p">,</span> <span class="mh">0x00e0</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Let things settle. delay taken from winCE driver */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">140</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s.%d: IOS interrupted: clk %u, mode %u&quot;</span><span class="p">,</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			<span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ios_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmio_mmc_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_WRPROTECT_DISABLE</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">sd_ctrl_read32</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTL_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TMIO_STAT_WRPROTECT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tmio_mmc_get_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cd</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">tmio_mmc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">tmio_mmc_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">tmio_mmc_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>         <span class="o">=</span> <span class="n">tmio_mmc_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">tmio_mmc_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_sdio_irq</span> <span class="o">=</span> <span class="n">tmio_mmc_enable_sdio_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tmio_mmc_host_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">**</span><span class="n">host</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_mask</span> <span class="o">=</span> <span class="n">TMIO_MASK_CMD</span><span class="p">;</span>

	<span class="n">res_ctl</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_ctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">_host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>
	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mmc</span><span class="p">);</span>

	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">set_pwr</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_pwr</span><span class="p">;</span>
	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">set_clk_div</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_clk_div</span><span class="p">;</span>

	<span class="cm">/* SD control register space size is 0x200, 0x400 for bus_shift=1 */</span>
	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">bus_shift</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res_ctl</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res_ctl</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res_ctl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">host_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmio_mmc_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hclk</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">PAGE_CACHE_SIZE</span> <span class="o">/</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ocr_mask</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ocr_mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>

	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">native_hotplug</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_USE_GPIO_CD</span> <span class="o">||</span>
				  <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_NEEDS_POLL</span> <span class="o">||</span>
				  <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_NONREMOVABLE</span><span class="p">);</span>

	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pm_disable</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are 4 different scenarios for the card detection:</span>
<span class="cm">	 *  1) an external gpio irq handles the cd (best for power savings)</span>
<span class="cm">	 *  2) internal sdhi irq handles the cd</span>
<span class="cm">	 *  3) a worker thread polls the sdhi - indicated by MMC_CAP_NEEDS_POLL</span>
<span class="cm">	 *  4) the medium is non-removable - indicated by MMC_CAP_NONREMOVABLE</span>
<span class="cm">	 *</span>
<span class="cm">	 *  While we increment the runtime PM counter for all scenarios when</span>
<span class="cm">	 *  the mmc core activates us by calling an appropriate set_ios(), we</span>
<span class="cm">	 *  must additionally ensure that in case 2) the tmio mmc hardware stays</span>
<span class="cm">	 *  additionally ensure that in case 2) the tmio mmc hardware stays</span>
<span class="cm">	 *  powered on during runtime for the card detection to work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">native_hotplug</span><span class="p">)</span>
		<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tmio_mmc_clk_stop</span><span class="p">(</span><span class="n">_host</span><span class="p">);</span>
	<span class="n">tmio_mmc_reset</span><span class="p">(</span><span class="n">_host</span><span class="p">);</span>

	<span class="n">_host</span><span class="o">-&gt;</span><span class="n">sdcard_irq_mask</span> <span class="o">=</span> <span class="n">sd_ctrl_read32</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="n">CTL_IRQ_MASK</span><span class="p">);</span>
	<span class="n">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="n">TMIO_MASK_ALL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_SDIO_IRQ</span><span class="p">)</span>
		<span class="n">tmio_mmc_enable_sdio_irq</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">ios_lock</span><span class="p">);</span>

	<span class="cm">/* Init delayed work for request timeouts */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">delayed_reset_work</span><span class="p">,</span> <span class="n">tmio_mmc_reset_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span> <span class="n">tmio_mmc_done_work</span><span class="p">);</span>

	<span class="cm">/* See if we also get DMA */</span>
	<span class="n">tmio_mmc_request_dma</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>

	<span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">dev_pm_qos_expose_latency_limit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Unmask the IRQs we want to know about */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">chan_rx</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">TMIO_MASK_READOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">chan_tx</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">TMIO_MASK_WRITEOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">native_hotplug</span><span class="p">)</span>
		<span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TMIO_STAT_CARD_REMOVE</span> <span class="o">|</span> <span class="n">TMIO_STAT_CARD_INSERT</span><span class="p">);</span>

	<span class="n">tmio_mmc_enable_mmc_irqs</span><span class="p">(</span><span class="n">_host</span><span class="p">,</span> <span class="n">irq_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_USE_GPIO_CD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_cd_gpio_request</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cd_gpio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmio_mmc_host_remove</span><span class="p">(</span><span class="n">_host</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">_host</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">pm_disable:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">_host</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
<span class="nl">host_free:</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_probe</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">tmio_mmc_host_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TMIO_MMC_USE_GPIO_CD</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * This means we can miss a card-eject, but this is anyway</span>
<span class="cm">		 * possible, because of delayed processing of hotplug events.</span>
<span class="cm">		 */</span>
		<span class="n">mmc_cd_gpio_free</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">native_hotplug</span><span class="p">)</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_pm_qos_hide_latency_limit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">delayed_reset_work</span><span class="p">);</span>
	<span class="n">tmio_mmc_release_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_remove</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">tmio_mmc_host_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">tmio_mmc_disable_mmc_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TMIO_MASK_ALL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tmio_mmc_host_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">tmio_mmc_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tmio_mmc_enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* The MMC core will perform the complete set up */</span>
	<span class="k">return</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_resume</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">tmio_mmc_host_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_runtime_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tmio_mmc_host_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tmio_mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">tmio_mmc_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tmio_mmc_enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tmio_mmc_host_runtime_resume</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
