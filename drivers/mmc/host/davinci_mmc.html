<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › davinci_mmc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>davinci_mmc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * davinci_mmc.c - TI DaVinci MMC/SD/SDIO driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Texas Instruments.</span>
<span class="cm"> *       Original author: Purushotam Kumar</span>
<span class="cm"> * Copyright (C) 2009 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>

<span class="cp">#include &lt;mach/mmc.h&gt;</span>
<span class="cp">#include &lt;mach/edma.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Register Definitions</span>
<span class="cm"> */</span>
<span class="cp">#define DAVINCI_MMCCTL       0x00 </span><span class="cm">/* Control Register                  */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCCLK       0x04 </span><span class="cm">/* Memory Clock Control Register     */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCST0       0x08 </span><span class="cm">/* Status Register 0                 */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCST1       0x0C </span><span class="cm">/* Status Register 1                 */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCIM        0x10 </span><span class="cm">/* Interrupt Mask Register           */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCTOR       0x14 </span><span class="cm">/* Response Time-Out Register        */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCTOD       0x18 </span><span class="cm">/* Data Read Time-Out Register       */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCBLEN      0x1C </span><span class="cm">/* Block Length Register             */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCNBLK      0x20 </span><span class="cm">/* Number of Blocks Register         */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCNBLC      0x24 </span><span class="cm">/* Number of Blocks Counter Register */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCDRR       0x28 </span><span class="cm">/* Data Receive Register             */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCDXR       0x2C </span><span class="cm">/* Data Transmit Register            */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCCMD       0x30 </span><span class="cm">/* Command Register                  */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCARGHL     0x34 </span><span class="cm">/* Argument Register                 */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCRSP01     0x38 </span><span class="cm">/* Response Register 0 and 1         */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCRSP23     0x3C </span><span class="cm">/* Response Register 0 and 1         */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCRSP45     0x40 </span><span class="cm">/* Response Register 0 and 1         */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCRSP67     0x44 </span><span class="cm">/* Response Register 0 and 1         */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCDRSP      0x48 </span><span class="cm">/* Data Response Register            */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCETOK      0x4C</span>
<span class="cp">#define DAVINCI_MMCCIDX      0x50 </span><span class="cm">/* Command Index Register            */</span><span class="cp"></span>
<span class="cp">#define DAVINCI_MMCCKC       0x54</span>
<span class="cp">#define DAVINCI_MMCTORC      0x58</span>
<span class="cp">#define DAVINCI_MMCTODC      0x5C</span>
<span class="cp">#define DAVINCI_MMCBLNC      0x60</span>
<span class="cp">#define DAVINCI_SDIOCTL      0x64</span>
<span class="cp">#define DAVINCI_SDIOST0      0x68</span>
<span class="cp">#define DAVINCI_SDIOIEN      0x6C</span>
<span class="cp">#define DAVINCI_SDIOIST      0x70</span>
<span class="cp">#define DAVINCI_MMCFIFOCTL   0x74 </span><span class="cm">/* FIFO Control Register             */</span><span class="cp"></span>

<span class="cm">/* DAVINCI_MMCCTL definitions */</span>
<span class="cp">#define MMCCTL_DATRST         (1 &lt;&lt; 0)</span>
<span class="cp">#define MMCCTL_CMDRST         (1 &lt;&lt; 1)</span>
<span class="cp">#define MMCCTL_WIDTH_8_BIT    (1 &lt;&lt; 8)</span>
<span class="cp">#define MMCCTL_WIDTH_4_BIT    (1 &lt;&lt; 2)</span>
<span class="cp">#define MMCCTL_DATEG_DISABLED (0 &lt;&lt; 6)</span>
<span class="cp">#define MMCCTL_DATEG_RISING   (1 &lt;&lt; 6)</span>
<span class="cp">#define MMCCTL_DATEG_FALLING  (2 &lt;&lt; 6)</span>
<span class="cp">#define MMCCTL_DATEG_BOTH     (3 &lt;&lt; 6)</span>
<span class="cp">#define MMCCTL_PERMDR_LE      (0 &lt;&lt; 9)</span>
<span class="cp">#define MMCCTL_PERMDR_BE      (1 &lt;&lt; 9)</span>
<span class="cp">#define MMCCTL_PERMDX_LE      (0 &lt;&lt; 10)</span>
<span class="cp">#define MMCCTL_PERMDX_BE      (1 &lt;&lt; 10)</span>

<span class="cm">/* DAVINCI_MMCCLK definitions */</span>
<span class="cp">#define MMCCLK_CLKEN          (1 &lt;&lt; 8)</span>
<span class="cp">#define MMCCLK_CLKRT_MASK     (0xFF &lt;&lt; 0)</span>

<span class="cm">/* IRQ bit definitions, for DAVINCI_MMCST0 and DAVINCI_MMCIM */</span>
<span class="cp">#define MMCST0_DATDNE         BIT(0)	</span><span class="cm">/* data done */</span><span class="cp"></span>
<span class="cp">#define MMCST0_BSYDNE         BIT(1)	</span><span class="cm">/* busy done */</span><span class="cp"></span>
<span class="cp">#define MMCST0_RSPDNE         BIT(2)	</span><span class="cm">/* command done */</span><span class="cp"></span>
<span class="cp">#define MMCST0_TOUTRD         BIT(3)	</span><span class="cm">/* data read timeout */</span><span class="cp"></span>
<span class="cp">#define MMCST0_TOUTRS         BIT(4)	</span><span class="cm">/* command response timeout */</span><span class="cp"></span>
<span class="cp">#define MMCST0_CRCWR          BIT(5)	</span><span class="cm">/* data write CRC error */</span><span class="cp"></span>
<span class="cp">#define MMCST0_CRCRD          BIT(6)	</span><span class="cm">/* data read CRC error */</span><span class="cp"></span>
<span class="cp">#define MMCST0_CRCRS          BIT(7)	</span><span class="cm">/* command response CRC error */</span><span class="cp"></span>
<span class="cp">#define MMCST0_DXRDY          BIT(9)	</span><span class="cm">/* data transmit ready (fifo empty) */</span><span class="cp"></span>
<span class="cp">#define MMCST0_DRRDY          BIT(10)	</span><span class="cm">/* data receive ready (data in fifo)*/</span><span class="cp"></span>
<span class="cp">#define MMCST0_DATED          BIT(11)	</span><span class="cm">/* DAT3 edge detect */</span><span class="cp"></span>
<span class="cp">#define MMCST0_TRNDNE         BIT(12)	</span><span class="cm">/* transfer done */</span><span class="cp"></span>

<span class="cm">/* DAVINCI_MMCST1 definitions */</span>
<span class="cp">#define MMCST1_BUSY           (1 &lt;&lt; 0)</span>

<span class="cm">/* DAVINCI_MMCCMD definitions */</span>
<span class="cp">#define MMCCMD_CMD_MASK       (0x3F &lt;&lt; 0)</span>
<span class="cp">#define MMCCMD_PPLEN          (1 &lt;&lt; 7)</span>
<span class="cp">#define MMCCMD_BSYEXP         (1 &lt;&lt; 8)</span>
<span class="cp">#define MMCCMD_RSPFMT_MASK    (3 &lt;&lt; 9)</span>
<span class="cp">#define MMCCMD_RSPFMT_NONE    (0 &lt;&lt; 9)</span>
<span class="cp">#define MMCCMD_RSPFMT_R1456   (1 &lt;&lt; 9)</span>
<span class="cp">#define MMCCMD_RSPFMT_R2      (2 &lt;&lt; 9)</span>
<span class="cp">#define MMCCMD_RSPFMT_R3      (3 &lt;&lt; 9)</span>
<span class="cp">#define MMCCMD_DTRW           (1 &lt;&lt; 11)</span>
<span class="cp">#define MMCCMD_STRMTP         (1 &lt;&lt; 12)</span>
<span class="cp">#define MMCCMD_WDATX          (1 &lt;&lt; 13)</span>
<span class="cp">#define MMCCMD_INITCK         (1 &lt;&lt; 14)</span>
<span class="cp">#define MMCCMD_DCLR           (1 &lt;&lt; 15)</span>
<span class="cp">#define MMCCMD_DMATRIG        (1 &lt;&lt; 16)</span>

<span class="cm">/* DAVINCI_MMCFIFOCTL definitions */</span>
<span class="cp">#define MMCFIFOCTL_FIFORST    (1 &lt;&lt; 0)</span>
<span class="cp">#define MMCFIFOCTL_FIFODIR_WR (1 &lt;&lt; 1)</span>
<span class="cp">#define MMCFIFOCTL_FIFODIR_RD (0 &lt;&lt; 1)</span>
<span class="cp">#define MMCFIFOCTL_FIFOLEV    (1 &lt;&lt; 2) </span><span class="cm">/* 0 = 128 bits, 1 = 256 bits */</span><span class="cp"></span>
<span class="cp">#define MMCFIFOCTL_ACCWD_4    (0 &lt;&lt; 3) </span><span class="cm">/* access width of 4 bytes    */</span><span class="cp"></span>
<span class="cp">#define MMCFIFOCTL_ACCWD_3    (1 &lt;&lt; 3) </span><span class="cm">/* access width of 3 bytes    */</span><span class="cp"></span>
<span class="cp">#define MMCFIFOCTL_ACCWD_2    (2 &lt;&lt; 3) </span><span class="cm">/* access width of 2 bytes    */</span><span class="cp"></span>
<span class="cp">#define MMCFIFOCTL_ACCWD_1    (3 &lt;&lt; 3) </span><span class="cm">/* access width of 1 byte     */</span><span class="cp"></span>

<span class="cm">/* DAVINCI_SDIOST0 definitions */</span>
<span class="cp">#define SDIOST0_DAT1_HI       BIT(0)</span>

<span class="cm">/* DAVINCI_SDIOIEN definitions */</span>
<span class="cp">#define SDIOIEN_IOINTEN       BIT(0)</span>

<span class="cm">/* DAVINCI_SDIOIST definitions */</span>
<span class="cp">#define SDIOIST_IOINT         BIT(0)</span>

<span class="cm">/* MMCSD Init clock in Hz in opendrain mode */</span>
<span class="cp">#define MMCSD_INIT_CLOCK		200000</span>

<span class="cm">/*</span>
<span class="cm"> * One scatterlist dma &quot;segment&quot; is at most MAX_CCNT rw_threshold units,</span>
<span class="cm"> * and we handle up to MAX_NR_SG segments.  MMC_BLOCK_BOUNCE kicks in only</span>
<span class="cm"> * for drivers with max_segs == 1, making the segments bigger (64KB)</span>
<span class="cm"> * than the page or two that&#39;s otherwise typical. nr_sg (passed from</span>
<span class="cm"> * platform data) == 16 gives at least the same throughput boost, using</span>
<span class="cm"> * EDMA transfer linkage instead of spending CPU time copying pages.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_CCNT	((1 &lt;&lt; 16) - 1)</span>

<span class="cp">#define MAX_NR_SG	16</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">rw_threshold</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rw_threshold</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rw_threshold</span><span class="p">,</span>
		<span class="s">&quot;Read/Write threshold. Default = 32&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">poll_threshold</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll_threshold</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">poll_threshold</span><span class="p">,</span>
		 <span class="s">&quot;Polling transaction size threshold. Default = 128&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">poll_loopcount</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll_loopcount</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">poll_loopcount</span><span class="p">,</span>
		 <span class="s">&quot;Maximum polling loop count. Default = 32&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">__initdata</span> <span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma</span><span class="p">,</span> <span class="s">&quot;Whether to use DMA or not. Default = 1&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmc_input_clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmc_irq</span><span class="p">,</span> <span class="n">sdio_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus_mode</span><span class="p">;</span>

<span class="cp">#define DAVINCI_MMC_DATADIR_NONE	0</span>
<span class="cp">#define DAVINCI_MMC_DATADIR_READ	1</span>
<span class="cp">#define DAVINCI_MMC_DATADIR_WRITE	2</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_dir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">suspended</span><span class="p">;</span>

	<span class="cm">/* buffer is used during PIO of one scatterlist segment, and</span>
<span class="cm">	 * is updated along with buffer_bytes_left.  bytes_left applies</span>
<span class="cm">	 * to all N blocks of the PIO transfer.</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer_bytes_left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bytes_left</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">rxdma</span><span class="p">,</span> <span class="n">txdma</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">use_dma</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_dma</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sdio_int</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">active_request</span><span class="p">;</span>

	<span class="cm">/* Scatterlist DMA uses one or more parameter RAM entries:</span>
<span class="cm">	 * the main one (associated with rxdma or txdma) plus zero or</span>
<span class="cm">	 * more links.  The entries for a given transfer differ only</span>
<span class="cm">	 * by memory buffer (address, length) and link field.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">edmacc_param</span>	<span class="n">tx_template</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edmacc_param</span>	<span class="n">rx_template</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">n_link</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">links</span><span class="p">[</span><span class="n">MAX_NR_SG</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* For PIO we walk scatterlists one segment at a time. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sg_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="cm">/* Version of the MMC/SD controller */</span>
	<span class="n">u8</span> <span class="n">version</span><span class="p">;</span>
	<span class="cm">/* for ns in one cycle calculation */</span>
	<span class="kt">unsigned</span> <span class="n">ns_in_one_cycle</span><span class="p">;</span>
	<span class="cm">/* Number of sg segments */</span>
	<span class="n">u8</span> <span class="n">nr_sg</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">freq_transition</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">mmc_davinci_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="cm">/* PIO only */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_sg_to_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">davinci_fifo_data_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">mmc_davinci_sg_to_buf</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/* NOTE:  we never transfer more than rw_threshold bytes</span>
<span class="cm">	 * to/from the fifo here; there&#39;s no I/O overlap.</span>
<span class="cm">	 * This also assumes that access width( i.e. ACCWD) is 4 bytes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDXR</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite8_rep</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDXR</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDRR</span><span class="p">);</span>
			<span class="n">p</span>  <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioread8_rep</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDRR</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_start_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">im_val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;CMD%d, arg 0x%08x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span>
		<span class="p">({</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MMC_RSP_R1</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;, R1/R5/R6/R7 response&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_RSP_R1B</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;, R1b response&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_RSP_R2</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;, R2 response&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_RSP_R3</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;, R3/R4 response&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;, (R? response)&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span> <span class="n">s</span><span class="p">;</span> <span class="p">}));</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1B</span>:
		<span class="cm">/* There&#39;s some spec confusion about when R1B is</span>
<span class="cm">		 * allowed, but if the card doesn&#39;t issue a BUSY</span>
<span class="cm">		 * then it&#39;s harmless for us to allow it.</span>
<span class="cm">		 */</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_BSYEXP</span><span class="p">;</span>
		<span class="cm">/* FALLTHROUGH */</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1</span>:		<span class="cm">/* 48 bits, CRC */</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_RSPFMT_R1456</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R2</span>:		<span class="cm">/* 136 bits, CRC */</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_RSPFMT_R2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R3</span>:		<span class="cm">/* 48 bits, no CRC */</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_RSPFMT_R3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_RSPFMT_NONE</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;unknown resp_type %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set command index */</span>
	<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>

	<span class="cm">/* Enable EDMA transfer triggers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_DMATRIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">MMC_CTLR_VERSION_2</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_READ</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_DMATRIG</span><span class="p">;</span>

	<span class="cm">/* Setting whether command involves data transfer or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_WDATX</span><span class="p">;</span>

	<span class="cm">/* Setting whether stream or block transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_STREAM</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_STRMTP</span><span class="p">;</span>

	<span class="cm">/* Setting whether data read or write */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_DTRW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_PUSHPULL</span><span class="p">)</span>
		<span class="n">cmd_reg</span> <span class="o">|=</span> <span class="n">MMCCMD_PPLEN</span><span class="p">;</span>

	<span class="cm">/* set Command timeout */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1FFF</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCTOR</span><span class="p">);</span>

	<span class="cm">/* Enable interrupt (calculate here, defer until FIFO is stuffed). */</span>
	<span class="n">im_val</span> <span class="o">=</span>  <span class="n">MMCST0_RSPDNE</span> <span class="o">|</span> <span class="n">MMCST0_CRCRS</span> <span class="o">|</span> <span class="n">MMCST0_TOUTRS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">im_val</span> <span class="o">|=</span> <span class="n">MMCST0_DATDNE</span> <span class="o">|</span> <span class="n">MMCST0_CRCWR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span><span class="p">)</span>
			<span class="n">im_val</span> <span class="o">|=</span> <span class="n">MMCST0_DXRDY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">im_val</span> <span class="o">|=</span> <span class="n">MMCST0_DATDNE</span> <span class="o">|</span> <span class="n">MMCST0_CRCRD</span> <span class="o">|</span> <span class="n">MMCST0_TOUTRD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span><span class="p">)</span>
			<span class="n">im_val</span> <span class="o">|=</span> <span class="n">MMCST0_DRRDY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Before non-DMA WRITE commands the controller needs priming:</span>
<span class="cm">	 * FIFO should be populated with 32 bytes i.e. whatever is the FIFO size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">))</span>
		<span class="n">davinci_fifo_data_trans</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rw_threshold</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCARGHL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd_reg</span><span class="p">,</span>  <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCMD</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">active_request</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">&lt;=</span> <span class="n">poll_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="n">poll_loopcount</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_request</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_davinci_irq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">active_request</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">im_val</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* DMA infrastructure */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">davinci_abort_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sync_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_READ</span><span class="p">)</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">;</span>

	<span class="n">edma_stop</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">);</span>
	<span class="n">edma_clean_channel</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">mmc_davinci_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_dma_cb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DMA_COMPLETE</span> <span class="o">!=</span> <span class="n">ch_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="cm">/* Currently means:  DMA Event Missed, or &quot;null&quot; transfer</span>
<span class="cm">		 * request was seen.  In the future, TC errors (like bad</span>
<span class="cm">		 * addresses) might be presented too.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;DMA %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				<span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">mmc_davinci_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set up tx or rx template, to be modified and updated later */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mmc_davinci_dma_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">edmacc_param</span> <span class="o">*</span><span class="n">template</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">sync_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span>	<span class="n">acnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span>	<span class="n">bcnt</span> <span class="o">=</span> <span class="n">rw_threshold</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span>	<span class="n">ccnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">src_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dst_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s16</span>		<span class="n">src_bidx</span><span class="p">,</span> <span class="n">dst_bidx</span><span class="p">;</span>
	<span class="n">s16</span>		<span class="n">src_cidx</span><span class="p">,</span> <span class="n">dst_cidx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A-B Sync transfer:  each DMA request is for one &quot;frame&quot; of</span>
<span class="cm">	 * rw_threshold bytes, broken into &quot;acnt&quot;-size chunks repeated</span>
<span class="cm">	 * &quot;bcnt&quot; times.  Each segment needs &quot;ccnt&quot; such frames; since</span>
<span class="cm">	 * we tell the block layer our mmc-&gt;max_seg_size limit, we can</span>
<span class="cm">	 * trust (later) that it&#39;s within bounds.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The FIFOs are read/written in 4-byte chunks (acnt == 4) and</span>
<span class="cm">	 * EDMA will optimize memory operations to use larger bursts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">;</span>

		<span class="cm">/* src_prt, ccnt, and link to be set up later */</span>
		<span class="n">src_bidx</span> <span class="o">=</span> <span class="n">acnt</span><span class="p">;</span>
		<span class="n">src_cidx</span> <span class="o">=</span> <span class="n">acnt</span> <span class="o">*</span> <span class="n">bcnt</span><span class="p">;</span>

		<span class="n">dst_port</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDXR</span><span class="p">;</span>
		<span class="n">dst_bidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dst_cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">;</span>

		<span class="n">src_port</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDRR</span><span class="p">;</span>
		<span class="n">src_bidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">src_cidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* dst_prt, ccnt, and link to be set up later */</span>
		<span class="n">dst_bidx</span> <span class="o">=</span> <span class="n">acnt</span><span class="p">;</span>
		<span class="n">dst_cidx</span> <span class="o">=</span> <span class="n">acnt</span> <span class="o">*</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t use FIFO mode for the FIFOs because MMC FIFO addresses</span>
<span class="cm">	 * are not 256-bit (32-byte) aligned.  So we use INCR, and the W8BIT</span>
<span class="cm">	 * parameter is ignored.</span>
<span class="cm">	 */</span>
	<span class="n">edma_set_src</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span> <span class="n">INCR</span><span class="p">,</span> <span class="n">W8BIT</span><span class="p">);</span>
	<span class="n">edma_set_dest</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span> <span class="n">INCR</span><span class="p">,</span> <span class="n">W8BIT</span><span class="p">);</span>

	<span class="n">edma_set_src_index</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">src_bidx</span><span class="p">,</span> <span class="n">src_cidx</span><span class="p">);</span>
	<span class="n">edma_set_dest_index</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">dst_bidx</span><span class="p">,</span> <span class="n">dst_cidx</span><span class="p">);</span>

	<span class="n">edma_set_transfer_params</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">acnt</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">,</span> <span class="n">ccnt</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ABSYNC</span><span class="p">);</span>

	<span class="n">edma_read_slot</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">template</span><span class="p">);</span>

	<span class="cm">/* don&#39;t bother with irqs or chaining */</span>
	<span class="n">template</span><span class="o">-&gt;</span><span class="n">opt</span> <span class="o">|=</span> <span class="n">EDMA_CHAN_SLOT</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_send_dma_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edmacc_param</span>	<span class="o">*</span><span class="n">template</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">channel</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">sg_len</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span>		<span class="n">shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">rw_threshold</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">template</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tx_template</span><span class="p">;</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">template</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">rx_template</span><span class="p">;</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We know sg_len and ccnt will never be out of range because</span>
<span class="cm">	 * we told the mmc layer which in turn tells the block layer</span>
<span class="cm">	 * to ensure that it only hands us one scatterlist segment</span>
<span class="cm">	 * per EDMA PARAM entry.  Update the PARAM</span>
<span class="cm">	 * entries needed for each segment of this scatterlist.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="n">channel</span><span class="p">,</span> <span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
			<span class="n">sg_len</span><span class="o">--</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">link</span><span class="o">++</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">buf</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="kt">unsigned</span>	<span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="n">template</span><span class="o">-&gt;</span><span class="n">link_bcntrld</span> <span class="o">=</span> <span class="n">sg_len</span>
				<span class="o">?</span> <span class="p">(</span><span class="n">EDMA_CHAN_SLOT</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">link</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="o">:</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">bytes_left</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">bytes_left</span><span class="p">;</span>
		<span class="n">bytes_left</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">)</span>
			<span class="n">template</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">template</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">template</span><span class="o">-&gt;</span><span class="n">ccnt</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

		<span class="n">edma_write_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">template</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">)</span>
		<span class="n">edma_clear_event</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">edma_start</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_davinci_start_dma_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">rw_threshold</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				<span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
				<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>

	<span class="cm">/* no individual DMA segment should need a partial FIFO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
					<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
					<span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mmc_davinci_send_dma_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init_or_module</span>
<span class="nf">davinci_release_dma_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_link</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">edma_free_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">edma_free_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">);</span>
	<span class="n">edma_free_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">davinci_acquire_dma_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">link_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Acquire master DMA write channel */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">edma_alloc_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">,</span> <span class="n">mmc_davinci_dma_cb</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
			<span class="n">EVENTQ_DEFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;alloc %s channel err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="s">&quot;tx&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmc_davinci_dma_setup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tx_template</span><span class="p">);</span>

	<span class="cm">/* Acquire master DMA read channel */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">edma_alloc_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span><span class="p">,</span> <span class="n">mmc_davinci_dma_cb</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
			<span class="n">EVENTQ_DEFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;alloc %s channel err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="s">&quot;rx&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_master_write</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmc_davinci_dma_setup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">rx_template</span><span class="p">);</span>

	<span class="cm">/* Allocate parameter RAM slots, which will later be bound to a</span>
<span class="cm">	 * channel as needed to handle a scatterlist.</span>
<span class="cm">	 */</span>
	<span class="n">link_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_sg</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">link_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">edma_alloc_slot</span><span class="p">(</span><span class="n">EDMA_CTLR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">),</span> <span class="n">EDMA_SLOT_ANY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;dma PaRAM alloc --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">r</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">n_link</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_master_write:</span>
	<span class="n">edma_free_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_davinci_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifo_lev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rw_threshold</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="n">MMCFIFOCTL_FIFOLEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">)</span>
		<span class="n">fifo_lev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rw_threshold</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="n">MMCFIFOCTL_FIFOLEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">DAVINCI_MMC_DATADIR_NONE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCBLEN</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCNBLK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;%s %s, %d blocks of %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_STREAM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;stream&quot;</span> <span class="o">:</span> <span class="s">&quot;block&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;  DTO %d cycles + %d ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ns_in_one_cycle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCTOD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCNBLK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCBLEN</span><span class="p">);</span>

	<span class="cm">/* Configure the FIFO */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_DATA_WRITE</span>:
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">DAVINCI_MMC_DATADIR_WRITE</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fifo_lev</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFODIR_WR</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFORST</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCFIFOCTL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fifo_lev</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFODIR_WR</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCFIFOCTL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">DAVINCI_MMC_DATADIR_READ</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fifo_lev</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFODIR_RD</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFORST</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCFIFOCTL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fifo_lev</span> <span class="o">|</span> <span class="n">MMCFIFOCTL_FIFODIR_RD</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCFIFOCTL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>

	<span class="cm">/* For now we try to use DMA whenever we won&#39;t need partial FIFO</span>
<span class="cm">	 * reads or writes, either for the whole transfer (as tested here)</span>
<span class="cm">	 * or for any individual scatterlist segment (tested when we call</span>
<span class="cm">	 * start_dma_transfer).</span>
<span class="cm">	 *</span>
<span class="cm">	 * While we *could* change that, unusual block sizes are rarely</span>
<span class="cm">	 * used.  The occasional fallback to PIO should&#39;t hurt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rw_threshold</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">&amp;&amp;</span> <span class="n">mmc_davinci_start_dma_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* zero this to ensure we take no PIO paths */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Revert to CPU Copy */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
		<span class="n">mmc_davinci_sg_to_buf</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">900</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mmcst1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Card may still be sending BUSY after a previous operation,</span>
<span class="cm">	 * typically some kind of write.  If so, we can&#39;t proceed yet.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mmcst1</span>  <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCST1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmcst1</span> <span class="o">&amp;</span> <span class="n">MMCST1_BUSY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmcst1</span> <span class="o">&amp;</span> <span class="n">MMCST1_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;still BUSY? bad ... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mmc_davinci_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">mmc_davinci_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calculate_freq_for_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmc_req_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmc_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mmc_pclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mmc_push_pull_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmc_pclk</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_input_clk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_req_freq</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_pclk</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mmc_req_freq</span><span class="p">))</span>
		<span class="n">mmc_push_pull_divisor</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mmc_pclk</span>
				<span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mmc_req_freq</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc_push_pull_divisor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmc_freq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mmc_pclk</span>
		<span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mmc_push_pull_divisor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_freq</span> <span class="o">&gt;</span> <span class="n">mmc_req_freq</span><span class="p">)</span>
		<span class="n">mmc_push_pull_divisor</span> <span class="o">=</span> <span class="n">mmc_push_pull_divisor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Convert ns to clock cycles */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_req_freq</span> <span class="o">&lt;=</span> <span class="mi">400000</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ns_in_one_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(((</span><span class="n">mmc_pclk</span>
				<span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mmc_push_pull_divisor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="mi">1000</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ns_in_one_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(((</span><span class="n">mmc_pclk</span>
				<span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mmc_push_pull_divisor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="mi">1000000</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mmc_push_pull_divisor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">calculate_clk_divider</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">open_drain_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mmc_pclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmc_push_pull_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_OPENDRAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

		<span class="cm">/* Ignoring the init clock value passed for fixing the inter</span>
<span class="cm">		 * operability with different cards.</span>
<span class="cm">		 */</span>
		<span class="n">open_drain_freq</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mmc_pclk</span>
				<span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">MMCSD_INIT_CLOCK</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">open_drain_freq</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="n">open_drain_freq</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MMCCLK_CLKRT_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">open_drain_freq</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>

		<span class="cm">/* Convert ns to clock cycles */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ns_in_one_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">MMCSD_INIT_CLOCK</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">mmc_push_pull_freq</span> <span class="o">=</span> <span class="n">calculate_freq_for_card</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_push_pull_freq</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="n">mmc_push_pull_freq</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MMCCLK_CLKEN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MMCCLK_CLKRT_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">mmc_push_pull_freq</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">MMCCLK_CLKEN</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
		<span class="s">&quot;clock %dHz busmode %d powermode %d Vdd %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">,</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_POWER_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">)</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_POWER_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">)</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_8</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Enabling 8 bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">MMCCTL_WIDTH_4_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MMCCTL_WIDTH_8_BIT</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_4</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Enabling 4 bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="n">MMCCTL_WIDTH_8_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MMCCTL_WIDTH_4_BIT</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">MMCCTL_WIDTH_4_BIT</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_1</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Enabling 1 bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="n">MMC_CTLR_VERSION_2</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">MMCCTL_WIDTH_8_BIT</span> <span class="o">|</span> <span class="n">MMCCTL_WIDTH_4_BIT</span><span class="p">),</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="n">MMCCTL_WIDTH_4_BIT</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">calculate_clk_divider</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">ios</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">lose</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* Send clock cycles, poll completion */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCARGHL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MMCCMD_INITCK</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCMD</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCST0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">MMCST0_RSPDNE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lose</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lose</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;powerup timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME on power OFF, reset things ... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_davinci_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * SDIO Interrupt Detection work-around as suggested by</span>
<span class="cm">		 * Davinci Errata (TMS320DM355 Silicon Revision 1.1 Errata</span>
<span class="cm">		 * 2.1.6): Signal SDIO interrupt only if it is enabled by core</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_int</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOST0</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">SDIOST0_DAT1_HI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">SDIOIST_IOINT</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIST</span><span class="p">);</span>
			<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">davinci_abort_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
			     <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span>
			     <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">DAVINCI_MMC_DATADIR_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">||</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">active_request</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mmc_davinci_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_cmd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* response type 2 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCRSP01</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCRSP23</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCRSP45</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCRSP67</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* response types 1, 1b, 3, 4, 5, 6 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCRSP67</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">active_request</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>	<span class="cm">/* reset */</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">MMCCTL_CMDRST</span> <span class="o">|</span> <span class="n">MMCCTL_DATRST</span><span class="p">;</span>
	<span class="k">else</span>		<span class="cm">/* enable */</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MMCCTL_CMDRST</span> <span class="o">|</span> <span class="n">MMCCTL_DATRST</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">davinci_abort_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mmc_davinci_sdio_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SDIOIST_IOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;SDIO interrupt status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">status</span> <span class="o">|</span> <span class="n">SDIOIST_IOINT</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIST</span><span class="p">);</span>
		<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mmc_davinci_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">qstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCST0</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;Spurious interrupt 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="cm">/* Disable the interrupt from mmcsd */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCST0</span><span class="p">);</span>
	<span class="n">qstatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* handle FIFO first when using PIO for data.</span>
<span class="cm">	 * bytes_left will decrease to zero as I/O progress and status will</span>
<span class="cm">	 * read zero over iteration because this controller status</span>
<span class="cm">	 * register(MMCST0) reports any status only once and it is cleared</span>
<span class="cm">	 * by read. So, it is not unbouned loop even in the case of</span>
<span class="cm">	 * non-dma.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMCST0_DXRDY</span> <span class="o">|</span> <span class="n">MMCST0_DRRDY</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">im_val</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If interrupts fire during the following loop, they will be</span>
<span class="cm">		 * handled by the handler, but the PIC will still buffer these.</span>
<span class="cm">		 * As a result, the handler will be called again to serve these</span>
<span class="cm">		 * needlessly. In order to avoid these spurious interrupts,</span>
<span class="cm">		 * keep interrupts masked during the loop.</span>
<span class="cm">		 */</span>
		<span class="n">im_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">davinci_fifo_data_trans</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rw_threshold</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCST0</span><span class="p">);</span>
			<span class="n">qstatus</span> <span class="o">|=</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMCST0_DXRDY</span> <span class="o">|</span> <span class="n">MMCST0_DRRDY</span><span class="p">)));</span>

		<span class="cm">/*</span>
<span class="cm">		 * If an interrupt is pending, it is assumed it will fire when</span>
<span class="cm">		 * it is unmasked. This assumption is also taken when the MMCIM</span>
<span class="cm">		 * is first set. Otherwise, writing to MMCIM after reading the</span>
<span class="cm">		 * status is race-prone.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">im_val</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_DATDNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All blocks sent/received, and CRC checks passed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">do_dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* if datasize &lt; rw_threshold</span>
<span class="cm">				 * no RX ints are generated</span>
<span class="cm">				 */</span>
				<span class="n">davinci_fifo_data_trans</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bytes_left</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					<span class="s">&quot;DATDNE with no host-&gt;data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_TOUTRD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read data timeout */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;read data timeout, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">qstatus</span><span class="p">);</span>

		<span class="n">davinci_abort_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMCST0_CRCWR</span> <span class="o">|</span> <span class="n">MMCST0_CRCRD</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Data CRC error */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* NOTE:  this controller uses CRCWR to report both CRC</span>
<span class="cm">		 * errors and timeouts (on writes).  MMCDRSP values are</span>
<span class="cm">		 * only weakly documented, but 0x9f was clearly a timeout</span>
<span class="cm">		 * case and the two three-bit patterns in various SD specs</span>
<span class="cm">		 * (101, 010) aren&#39;t part of it ...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_CRCWR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCDRSP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0x9f</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;data %s %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_CRCWR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;timeout&quot;</span> <span class="o">:</span> <span class="s">&quot;CRC&quot;</span><span class="p">);</span>

		<span class="n">davinci_abort_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_TOUTRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Command timeout */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
				<span class="s">&quot;CMD%d timeout, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">qstatus</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">davinci_abort_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_CRCRS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Command CRC error */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Command CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qstatus</span> <span class="o">&amp;</span> <span class="n">MMCST0_RSPDNE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* End of command phase */</span>
		<span class="n">end_command</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_command</span><span class="p">)</span>
		<span class="n">mmc_davinci_cmd_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end_transfer</span><span class="p">)</span>
		<span class="n">mmc_davinci_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_davinci_get_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span> <span class="o">||</span> <span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">get_cd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">get_cd</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_davinci_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span> <span class="o">||</span> <span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">get_ro</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">get_ro</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_davinci_enable_sdio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOST0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDIOST0_DAT1_HI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">SDIOIST_IOINT</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIST</span><span class="p">);</span>
			<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_int</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIEN</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">SDIOIEN_IOINTEN</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_int</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIEN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDIOIEN_IOINTEN</span><span class="p">,</span>
		       <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_SDIOIEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">mmc_davinci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">mmc_davinci_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">mmc_davinci_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">mmc_davinci_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">mmc_davinci_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_sdio_irq</span> <span class="o">=</span> <span class="n">mmc_davinci_enable_sdio_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_davinci_cpufreq_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mmc_pclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_davinci_host</span><span class="p">,</span> <span class="n">freq_transition</span><span class="p">);</span>
	<span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
	<span class="n">mmc_pclk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPUFREQ_POSTCHANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_input_clk</span> <span class="o">=</span> <span class="n">mmc_pclk</span><span class="p">;</span>
		<span class="n">calculate_clk_divider</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mmc_davinci_cpufreq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">mmc_davinci_cpufreq_transition</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
					 <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_davinci_cpufreq_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">freq_transition</span><span class="p">,</span>
				    <span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mmc_davinci_cpufreq_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_davinci_cpufreq_deregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_mmcsd_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MMCCLK_CLKEN</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCCLK</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1FFF</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCTOR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCTOD</span><span class="p">);</span>

	<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">davinci_mmcsd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">davinci_mmc_config</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">mem_size</span><span class="p">;</span>

	<span class="cm">/* REVISIT:  when we&#39;re fully converted, fail if pdata is NULL */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">mem_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_davinci_host</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>	<span class="cm">/* Important */</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">rxdma</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">txdma</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MMCSDCLK&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_input_clk</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">init_mmcsd_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_sg</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_sg</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_sg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_sg</span> <span class="o">&gt;</span> <span class="n">MAX_NR_SG</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_sg</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_sg</span> <span class="o">=</span> <span class="n">MAX_NR_SG</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="n">use_dma</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">davinci_acquire_dma_channels</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* REVISIT:  someday, support IRQ-driven card detection.  */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_NEEDS_POLL</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_WAIT_WHILE_BUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">wires</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">wires</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">wires</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MMC_CAP_4_BIT_DATA</span> <span class="o">|</span> <span class="n">MMC_CAP_8_BIT_DATA</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_davinci_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="mi">312500</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>

	<span class="cm">/* With no iommu coalescing pages, each phys_seg is a hw_seg.</span>
<span class="cm">	 * Each hw_seg uses one EDMA parameter RAM slot, always one</span>
<span class="cm">	 * channel and then usually some linked slots.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_link</span><span class="p">;</span>

	<span class="cm">/* EDMA limit per hw segment (one or two MBytes) */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span>	<span class="o">=</span> <span class="n">MAX_CCNT</span> <span class="o">*</span> <span class="n">rw_threshold</span><span class="p">;</span>

	<span class="cm">/* MMC/SD controller limits for multiblock requests */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span>	<span class="o">=</span> <span class="mi">4095</span><span class="p">;</span>  <span class="cm">/* BLEN is 12 bits */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span>	<span class="o">=</span> <span class="mi">65535</span><span class="p">;</span> <span class="cm">/* NBLK is 16 bits */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span>	<span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;max_segs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;max_blk_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;max_req_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;max_seg_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_davinci_cpufreq_register</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register cpufreq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cpu_freq_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">mmc_davinci_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq</span><span class="p">,</span> <span class="n">mmc_davinci_sdio_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rename_region</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Using %s, %d-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mmc_davinci_cpufreq_deregister</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">cpu_freq_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">davinci_release_dma_channels</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
			<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="p">)</span>
		<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">davinci_mmcsd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_davinci_cpufreq_deregister</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sdio_irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

		<span class="n">davinci_release_dma_channels</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

		<span class="n">release_resource</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="p">);</span>

		<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">davinci_mmcsd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">DAVINCI_MMCIM</span><span class="p">);</span>
		<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">davinci_mmcsd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_davinci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">mmc_davinci_reset_ctrl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">davinci_mmcsd_pm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>        <span class="o">=</span> <span class="n">davinci_mmcsd_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">davinci_mmcsd_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define davinci_mmcsd_pm_ops (&amp;davinci_mmcsd_pm)</span>
<span class="cp">#else</span>
<span class="cp">#define davinci_mmcsd_pm_ops NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">davinci_mmcsd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;davinci_mmc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">davinci_mmcsd_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">davinci_mmcsd_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">davinci_mmcsd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">davinci_mmcsd_driver</span><span class="p">,</span>
				     <span class="n">davinci_mmcsd_probe</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">davinci_mmcsd_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">davinci_mmcsd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">davinci_mmcsd_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">davinci_mmcsd_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments India&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MMC/SD driver for Davinci MMC controller&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:davinci_mmc&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
