<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › tifm_sd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tifm_sd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  tifm_sd.c - TI FlashMedia driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Alex Dubov &lt;oakad@yahoo.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to Brad Campbell for extensive testing of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/tifm.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#define DRIVER_NAME &quot;tifm_sd&quot;</span>
<span class="cp">#define DRIVER_VERSION &quot;0.8&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">no_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">fixed_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_dma</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fixed_timeout</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cm">/* Constants here are mostly from OMAP5912 datasheet */</span>
<span class="cp">#define TIFM_MMCSD_RESET      0x0002</span>
<span class="cp">#define TIFM_MMCSD_CLKMASK    0x03ff</span>
<span class="cp">#define TIFM_MMCSD_POWER      0x0800</span>
<span class="cp">#define TIFM_MMCSD_4BBUS      0x8000</span>
<span class="cp">#define TIFM_MMCSD_RXDE       0x8000   </span><span class="cm">/* rx dma enable */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_TXDE       0x0080   </span><span class="cm">/* tx dma enable */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_BUFINT     0x0c00   </span><span class="cm">/* set bits: AE, AF */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_DPE        0x0020   </span><span class="cm">/* data timeout counted in kilocycles */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_INAB       0x0080   </span><span class="cm">/* abort / initialize command */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_READ       0x8000</span>

<span class="cp">#define TIFM_MMCSD_ERRMASK    0x01e0   </span><span class="cm">/* set bits: CCRC, CTO, DCRC, DTO */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_EOC        0x0001   </span><span class="cm">/* end of command phase  */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CD         0x0002   </span><span class="cm">/* card detect           */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CB         0x0004   </span><span class="cm">/* card enter busy state */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_BRS        0x0008   </span><span class="cm">/* block received/sent   */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_EOFB       0x0010   </span><span class="cm">/* card exit busy state  */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_DTO        0x0020   </span><span class="cm">/* data time-out         */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_DCRC       0x0040   </span><span class="cm">/* data crc error        */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CTO        0x0080   </span><span class="cm">/* command time-out      */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CCRC       0x0100   </span><span class="cm">/* command crc error     */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_AF         0x0400   </span><span class="cm">/* fifo almost full      */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_AE         0x0800   </span><span class="cm">/* fifo almost empty     */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_OCRB       0x1000   </span><span class="cm">/* OCR busy              */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CIRQ       0x2000   </span><span class="cm">/* card irq (cmd40/sdio) */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CERR       0x4000   </span><span class="cm">/* card status error     */</span><span class="cp"></span>

<span class="cp">#define TIFM_MMCSD_ODTO       0x0040   </span><span class="cm">/* open drain / extended timeout */</span><span class="cp"></span>
<span class="cp">#define TIFM_MMCSD_CARD_RO    0x0200   </span><span class="cm">/* card is read-only     */</span><span class="cp"></span>

<span class="cp">#define TIFM_MMCSD_FIFO_SIZE  0x0020</span>

<span class="cp">#define TIFM_MMCSD_RSP_R0     0x0000</span>
<span class="cp">#define TIFM_MMCSD_RSP_R1     0x0100</span>
<span class="cp">#define TIFM_MMCSD_RSP_R2     0x0200</span>
<span class="cp">#define TIFM_MMCSD_RSP_R3     0x0300</span>
<span class="cp">#define TIFM_MMCSD_RSP_R4     0x0400</span>
<span class="cp">#define TIFM_MMCSD_RSP_R5     0x0500</span>
<span class="cp">#define TIFM_MMCSD_RSP_R6     0x0600</span>

<span class="cp">#define TIFM_MMCSD_RSP_BUSY   0x0800</span>

<span class="cp">#define TIFM_MMCSD_CMD_BC     0x0000</span>
<span class="cp">#define TIFM_MMCSD_CMD_BCR    0x1000</span>
<span class="cp">#define TIFM_MMCSD_CMD_AC     0x2000</span>
<span class="cp">#define TIFM_MMCSD_CMD_ADTC   0x3000</span>

<span class="cp">#define TIFM_MMCSD_MAX_BLOCK_SIZE  0x0800UL</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CMD_READY</span>    <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
	<span class="n">FIFO_READY</span>   <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
	<span class="n">BRS_READY</span>    <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">SCMD_ACTIVE</span>  <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
	<span class="n">SCMD_READY</span>   <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
	<span class="n">CARD_BUSY</span>    <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">DATA_CARRY</span>   <span class="o">=</span> <span class="mh">0x0040</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span>       <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>        <span class="n">eject</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
			      <span class="nl">open_drain:</span><span class="mi">1</span><span class="p">,</span>
			      <span class="nl">no_dma:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>        <span class="n">cmd_flags</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>          <span class="n">clk_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>          <span class="n">clk_div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">timeout_jiffies</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">finish_tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>     <span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span>    <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="kt">int</span>                   <span class="n">sg_len</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">sg_pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>          <span class="n">block_pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>    <span class="n">bounce_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>         <span class="n">bounce_buf_data</span><span class="p">[</span><span class="n">TIFM_MMCSD_MAX_BLOCK_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* for some reason, host won&#39;t respond correctly to readw/writew */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_read_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">DATA_CARRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DATA_CARRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">DATA_CARRY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buf</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_write_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">DATA_CARRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DATA_CARRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">DATA_CARRY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buf</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_transfer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">t_size</span> <span class="o">=</span> <span class="n">TIFM_MMCSD_FIFO_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">DATA_CARRY</span><span class="p">))</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					       <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr</span>
					       <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA</span><span class="p">);</span>

				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>

		<span class="n">pg</span> <span class="o">=</span> <span class="n">nth_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">]),</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">p_off</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">p_off</span><span class="p">;</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">p_cnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">p_cnt</span><span class="p">,</span> <span class="n">t_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">tifm_sd_read_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
			<span class="n">tifm_sd_write_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">);</span>

		<span class="n">t_size</span> <span class="o">-=</span> <span class="n">p_cnt</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">+=</span> <span class="n">p_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_copy_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_off</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_off</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src_buf</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">+</span> <span class="n">src_off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst_buf</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="o">+</span> <span class="n">dst_off</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst_buf</span><span class="p">,</span> <span class="n">src_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">dst_buf</span> <span class="o">-</span> <span class="n">dst_off</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">src_buf</span> <span class="o">-</span> <span class="n">src_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_bounce_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_size</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">pg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bouncing block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">length</span> <span class="o">-</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>

		<span class="n">pg</span> <span class="o">=</span> <span class="n">nth_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">]),</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">p_off</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">p_off</span><span class="p">;</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">p_cnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">p_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">p_cnt</span><span class="p">,</span> <span class="n">t_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
			<span class="n">tifm_sd_copy_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">),</span>
					  <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">-</span> <span class="n">t_size</span><span class="p">,</span>
					  <span class="n">pg</span><span class="p">,</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">tifm_sd_copy_page</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">p_off</span><span class="p">,</span> <span class="n">sg_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">),</span>
					  <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">-</span> <span class="n">t_size</span><span class="p">,</span> <span class="n">p_cnt</span><span class="p">);</span>

		<span class="n">t_size</span> <span class="o">-=</span> <span class="n">p_cnt</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">+=</span> <span class="n">p_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_set_dma_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_size</span> <span class="o">=</span> <span class="n">TIFM_DMA_TSIZE</span> <span class="o">*</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">dma_blk_cnt</span><span class="p">,</span> <span class="n">dma_off</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">DATA_CARRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DATA_CARRY</span><span class="p">;</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">tifm_sd_bounce_block</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">r_data</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">])</span> <span class="o">-</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dma_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_len</span> <span class="o">&lt;</span> <span class="n">t_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_blk_cnt</span> <span class="o">=</span> <span class="n">dma_len</span> <span class="o">/</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
		<span class="n">dma_off</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">+=</span> <span class="n">dma_blk_cnt</span> <span class="o">*</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_blk_cnt</span> <span class="o">=</span> <span class="n">TIFM_DMA_TSIZE</span><span class="p">;</span>
		<span class="n">dma_off</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">+=</span> <span class="n">t_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_blk_cnt</span><span class="p">)</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">tifm_sd_bounce_block</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">r_data</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">DATA_CARRY</span><span class="p">;</span>

		<span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">;</span>
		<span class="n">dma_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_blk_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting dma for %d blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_blk_cnt</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">+</span> <span class="n">dma_off</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_ADDRESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">dma_blk_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">TIFM_DMA_TX</span> <span class="o">|</span> <span class="n">TIFM_DMA_EN</span><span class="p">,</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_CONTROL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">dma_blk_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">TIFM_DMA_EN</span><span class="p">,</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_CONTROL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tifm_sd_op_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_RSP_NONE</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_RSP_R0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1B</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_RSP_BUSY</span><span class="p">;</span> <span class="c1">// deliberate fall-through</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_RSP_R1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R2</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_RSP_R2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R3</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_RSP_R3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_cmd_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_CMD_BC</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_CMD_BC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_CMD_BCR</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_CMD_BCR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_CMD_AC</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_CMD_AC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_CMD_ADTC</span>:
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_CMD_ADTC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_mask</span> <span class="o">=</span> <span class="n">tifm_sd_op_flags</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">open_drain</span><span class="p">)</span>
		<span class="n">cmd_mask</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_ODTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">))</span>
		<span class="n">cmd_mask</span> <span class="o">|=</span> <span class="n">TIFM_MMCSD_READ</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;executing opcode 0x%x, arg: 0x%x, mask: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">cmd_mask</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_ARG_HIGH</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_ARG_LOW</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">|</span> <span class="n">cmd_mask</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_COMMAND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_fetch_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_RESPONSE</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">finish_request</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">CMD_READY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_ACTIVE</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_READY</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">finish_request</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">BRS_READY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">||</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">FIFO_READY</span><span class="p">)))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">SCMD_ACTIVE</span><span class="p">;</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_EOFB</span>
					       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span>
						       <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
					       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span>
					       <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
					<span class="n">tifm_sd_exec</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_READY</span><span class="p">)</span>
					    <span class="o">||</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">CARD_BUSY</span><span class="p">))</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_EOFB</span><span class="p">)</span>
					       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span>
						       <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
					       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span>
					       <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">CARD_BUSY</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_EOFB</span><span class="p">)</span>
				       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span>
					       <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
				       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">SCMD_ACTIVE</span><span class="p">;</span>
					<span class="n">tifm_sd_exec</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_READY</span><span class="p">))</span>
						<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">finish_request:</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called from interrupt handler */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_data_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fifo_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">mmc_host</span><span class="o">*</span><span class="p">)</span><span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">));</span>
	<span class="n">fifo_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_STATUS</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data event: fifo_status %x, flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fifo_status</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fifo_status</span> <span class="o">&amp;</span> <span class="n">TIFM_FIFO_READY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tifm_sd_set_dma_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">r_data</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">FIFO_READY</span><span class="p">;</span>
				<span class="n">tifm_sd_check_status</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">fifo_status</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_STATUS</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called from interrupt handler */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_card_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">mmc_host</span><span class="o">*</span><span class="p">)</span><span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">));</span>
	<span class="n">host_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;host event: host_status %x, flags %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">host_status</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_ERRMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_ERRMASK</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_CTO</span><span class="p">)</span>
				<span class="n">cmd_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_CCRC</span><span class="p">)</span>
				<span class="n">cmd_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_DTO</span><span class="p">)</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_DCRC</span><span class="p">)</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_FIFO_INT_SETALL</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_INT_ENABLE_CLEAR</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_DMA_RESET</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_CONTROL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">cmd_error</span><span class="p">;</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">SCMD_READY</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">cmd_error</span><span class="p">;</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">SCMD_ACTIVE</span><span class="p">;</span>
					<span class="n">tifm_sd_exec</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">cmd_error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIFM_MMCSD_EOC</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_CERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">CMD_READY</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">CMD_READY</span><span class="p">;</span>
					<span class="n">tifm_sd_fetch_resp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">SCMD_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">SCMD_READY</span><span class="p">;</span>
					<span class="n">tifm_sd_fetch_resp</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span>
							   <span class="n">sock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_BRS</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">BRS_READY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_AE</span><span class="p">)</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_AE</span><span class="p">,</span>
				       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIFM_MMCSD_AE</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_AF</span>
					   <span class="o">|</span> <span class="n">TIFM_MMCSD_BRS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">tifm_sd_transfer_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">host_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIFM_MMCSD_AE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_EOFB</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CARD_BUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_CB</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">CARD_BUSY</span><span class="p">;</span>

		<span class="n">tifm_sd_check_status</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host_status</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_set_data_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fixed_timeout</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data_timeout</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">/</span>
			<span class="p">((</span><span class="mi">1000000000UL</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_freq</span><span class="p">)</span> <span class="o">*</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_timeout</span> <span class="o">&lt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data_timeout</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA_TO</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_DPE</span><span class="p">)</span>
		       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SDIO_MODE_CONFIG</span><span class="p">),</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SDIO_MODE_CONFIG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_timeout</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">data_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* set to unlimited */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data_timeout</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_DATA_TO</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_DPE</span>
		       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SDIO_MODE_CONFIG</span><span class="p">),</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SDIO_MODE_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eject</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : unfinished request detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span> <span class="o">=</span> <span class="n">no_dma</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tifm_sd_set_data_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">r_data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
			 <span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_EOFB</span>
				<span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
				<span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_BUFINT</span>
			       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(((</span><span class="n">TIFM_MMCSD_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			       <span class="o">|</span> <span class="p">(</span><span class="n">TIFM_MMCSD_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BUFFER_CONFIG</span><span class="p">);</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf_data</span><span class="p">,</span>
				    <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">tifm_map_sg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span>
					    <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span>
					    <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : scatterlist map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">tifm_map_sg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
						   <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
						   <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span>
						   <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span>
						   <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span>
						   <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : scatterlist map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
				<span class="n">tifm_unmap_sg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span>
					      <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span>
					      <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_FIFO_INT_SETALL</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_INT_ENABLE_CLEAR</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_FIFO_PAGE_SIZE</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_FIFO_ENABLE</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_FIFO_CONTROL</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_FIFO_INTMASK</span><span class="p">,</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_INT_ENABLE_SET</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_TXDE</span><span class="p">,</span>
				       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BUFFER_CONFIG</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_RXDE</span><span class="p">,</span>
				       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BUFFER_CONFIG</span><span class="p">);</span>

			<span class="n">tifm_sd_set_dma_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">r_data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_NUM_BLOCKS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BLOCK_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_jiffies</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_CTRL_LED</span> <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">),</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">);</span>
	<span class="n">tifm_sd_exec</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_end_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">r_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; %s : no request to complete?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r_data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">no_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_BUFINT</span><span class="p">)</span>
			       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">),</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tifm_unmap_sg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bounce_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				      <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span> <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">tifm_unmap_sg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">r_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				      <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span> <span class="o">:</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">r_data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blocks</span>
			<span class="o">-</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_NUM_BLOCKS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">r_data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">*=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
		<span class="n">r_data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">r_data</span><span class="o">-&gt;</span><span class="n">blksz</span>
			<span class="o">-</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BLOCK_LEN</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_CTRL_LED</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">),</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_abort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : card failed to respond for a long period of time &quot;</span>
	       <span class="s">&quot;(%x, %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_flags</span><span class="p">);</span>

	<span class="n">tifm_eject</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clk_div1</span><span class="p">,</span> <span class="n">clk_div2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ios: clock = %u, vdd = %x, bus_mode = %x, &quot;</span>
		<span class="s">&quot;chip_select = %x, power_mode = %x, bus_width = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">,</span>
		<span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_4BBUS</span> <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">),</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_4BBUS</span><span class="p">)</span>
		       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">),</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_div1</span> <span class="o">=</span> <span class="mi">20000000</span> <span class="o">/</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk_div1</span><span class="p">)</span>
			<span class="n">clk_div1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">clk_div2</span> <span class="o">=</span> <span class="mi">24000000</span> <span class="o">/</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clk_div2</span><span class="p">)</span>
			<span class="n">clk_div2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="mi">20000000</span> <span class="o">/</span> <span class="n">clk_div1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
			<span class="n">clk_div1</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">24000000</span> <span class="o">/</span> <span class="n">clk_div2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
			<span class="n">clk_div2</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">20000000</span> <span class="o">/</span> <span class="n">clk_div1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">24000000</span> <span class="o">/</span> <span class="n">clk_div2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="n">clk_div1</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">((</span><span class="o">~</span><span class="n">TIFM_CTRL_FAST_CLK</span><span class="p">)</span>
			       <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">),</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="mi">24000000</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="n">clk_div2</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_CTRL_FAST_CLK</span>
			       <span class="o">|</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">),</span>
			       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_CONTROL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">&amp;=</span> <span class="n">TIFM_MMCSD_CLKMASK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span>
	       <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">TIFM_MMCSD_CLKMASK</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">)),</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">open_drain</span> <span class="o">=</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_OPENDRAIN</span><span class="p">);</span>

	<span class="cm">/* chip_select : maybe later */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>vdd
power is set before probe / after remove</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TIFM_MMCSD_CARD_RO</span> <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_PRESENT_STATE</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">tifm_sd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">tifm_sd_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span> <span class="o">=</span> <span class="n">tifm_sd_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>  <span class="o">=</span> <span class="n">tifm_sd_ro</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_initialize_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">host_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">=</span> <span class="mi">61</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_freq</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_RESET</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_POWER</span><span class="p">,</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">);</span>

	<span class="cm">/* wait up to 0.51 sec for reset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">rc</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_SYSTEM_STATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : controller failed to reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_NUM_BLOCKS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_div</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_POWER</span><span class="p">,</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_CONFIG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_RXDE</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_BUFFER_CONFIG</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>command timeout fixed to 64 clocks for now</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_COMMAND_TO</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_INAB</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_COMMAND</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">;</span> <span class="n">rc</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">host_status</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_ERRMASK</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host_status</span> <span class="o">&amp;</span> <span class="n">TIFM_MMCSD_EOC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s : card not ready - probe failed on initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_MMCSD_CERR</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_BRS</span> <span class="o">|</span> <span class="n">TIFM_MMCSD_EOC</span>
	       <span class="o">|</span> <span class="n">TIFM_MMCSD_ERRMASK</span><span class="p">,</span>
	       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">TIFM_SOCK_STATE_OCCUPIED</span>
	      <span class="o">&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_PRESENT_STATE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s : card gone, unexpectedly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_sd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">tifm_set_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_jiffies</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">,</span> <span class="n">tifm_sd_end_cmd</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">tifm_sd_abort</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tifm_sd_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="mi">20000000</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="mi">24000000</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">TIFM_MMCSD_MAX_BLOCK_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">card_event</span> <span class="o">=</span> <span class="n">tifm_sd_card_event</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">data_event</span> <span class="o">=</span> <span class="n">tifm_sd_data_event</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tifm_sd_initialize_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tifm_sd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">eject</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_MMCSD_INT_ENABLE</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TIFM_FIFO_INT_SETALL</span><span class="p">,</span>
		       <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_INT_ENABLE_CLEAR</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">SOCK_DMA_FIFO_INT_ENABLE_SET</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;after remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tifm_sd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">tifm_dev</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">tifm_get_drvdata</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tifm_sd</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tifm_sd_initialize_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resume initialize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">eject</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define tifm_sd_suspend NULL</span>
<span class="cp">#define tifm_sd_resume NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tifm_device_id</span> <span class="n">tifm_sd_id_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">TIFM_TYPE_SD</span> <span class="p">},</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tifm_driver</span> <span class="n">tifm_sd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tifm_sd_id_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">tifm_sd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">tifm_sd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">tifm_sd_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">tifm_sd_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tifm_sd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tifm_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tifm_sd_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tifm_sd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tifm_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tifm_sd_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alex Dubov&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI FlashMedia SD driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">tifm</span><span class="p">,</span> <span class="n">tifm_sd_id_tbl</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tifm_sd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tifm_sd_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
