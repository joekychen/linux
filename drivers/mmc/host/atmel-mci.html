<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › atmel-mci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atmel-mci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Atmel MultiMedia Card Interface driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2008 Atmel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio.h&gt;</span>

<span class="cp">#include &lt;mach/atmel-mci.h&gt;</span>
<span class="cp">#include &lt;linux/atmel-mci.h&gt;</span>
<span class="cp">#include &lt;linux/atmel_pdc.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;mach/cpu.h&gt;</span>
<span class="cp">#include &lt;mach/board.h&gt;</span>

<span class="cp">#include &quot;atmel-mci-regs.h&quot;</span>

<span class="cp">#define ATMCI_DATA_ERROR_FLAGS	(ATMCI_DCRCE | ATMCI_DTOE | ATMCI_OVRE | ATMCI_UNRE)</span>
<span class="cp">#define ATMCI_DMA_THRESHOLD	16</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">EVENT_CMD_RDY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">EVENT_XFER_COMPLETE</span><span class="p">,</span>
	<span class="n">EVENT_NOTBUSY</span><span class="p">,</span>
	<span class="n">EVENT_DATA_ERROR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atmel_mci_state</span> <span class="p">{</span>
	<span class="n">STATE_IDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">STATE_SENDING_CMD</span><span class="p">,</span>
	<span class="n">STATE_DATA_XFER</span><span class="p">,</span>
	<span class="n">STATE_WAITING_NOTBUSY</span><span class="p">,</span>
	<span class="n">STATE_SENDING_STOP</span><span class="p">,</span>
	<span class="n">STATE_END_REQUEST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atmci_xfer_dir</span> <span class="p">{</span>
	<span class="n">XFER_RECEIVE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">XFER_TRANSMIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">atmci_pdc_buf</span> <span class="p">{</span>
	<span class="n">PDC_FIRST_BUF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PDC_SECOND_BUF</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atmel_mci_caps</span> <span class="p">{</span>
	<span class="n">bool</span>    <span class="n">has_dma</span><span class="p">;</span>
	<span class="n">bool</span>    <span class="n">has_pdc</span><span class="p">;</span>
	<span class="n">bool</span>    <span class="n">has_cfg_reg</span><span class="p">;</span>
	<span class="n">bool</span>    <span class="n">has_cstor_reg</span><span class="p">;</span>
	<span class="n">bool</span>    <span class="n">has_highspeed</span><span class="p">;</span>
	<span class="n">bool</span>    <span class="n">has_rwproof</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">has_odd_clk_div</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">has_bad_data_ordering</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">need_reset_after_xfer</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">need_blksz_mul_4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atmel_mci_dma</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">data_desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct atmel_mci - MMC controller state shared between all slots</span>
<span class="cm"> * @lock: Spinlock protecting the queue and associated data.</span>
<span class="cm"> * @regs: Pointer to MMIO registers.</span>
<span class="cm"> * @sg: Scatterlist entry currently being processed by PIO or PDC code.</span>
<span class="cm"> * @pio_offset: Offset into the current scatterlist entry.</span>
<span class="cm"> * @buffer: Buffer used if we don&#39;t have the r/w proof capability. We</span>
<span class="cm"> *      don&#39;t have the time to switch pdc buffers so we have to use only</span>
<span class="cm"> *      one buffer for the full transaction.</span>
<span class="cm"> * @buf_size: size of the buffer.</span>
<span class="cm"> * @phys_buf_addr: buffer address needed for pdc.</span>
<span class="cm"> * @cur_slot: The slot which is currently using the controller.</span>
<span class="cm"> * @mrq: The request currently being processed on @cur_slot,</span>
<span class="cm"> *	or NULL if the controller is idle.</span>
<span class="cm"> * @cmd: The command currently being sent to the card, or NULL.</span>
<span class="cm"> * @data: The data currently being transferred, or NULL if no data</span>
<span class="cm"> *	transfer is in progress.</span>
<span class="cm"> * @data_size: just data-&gt;blocks * data-&gt;blksz.</span>
<span class="cm"> * @dma: DMA client state.</span>
<span class="cm"> * @data_chan: DMA channel being used for the current data transfer.</span>
<span class="cm"> * @cmd_status: Snapshot of SR taken upon completion of the current</span>
<span class="cm"> *	command. Only valid when EVENT_CMD_COMPLETE is pending.</span>
<span class="cm"> * @data_status: Snapshot of SR taken upon completion of the current</span>
<span class="cm"> *	data transfer. Only valid when EVENT_DATA_COMPLETE or</span>
<span class="cm"> *	EVENT_DATA_ERROR is pending.</span>
<span class="cm"> * @stop_cmdr: Value to be loaded into CMDR when the stop command is</span>
<span class="cm"> *	to be sent.</span>
<span class="cm"> * @tasklet: Tasklet running the request state machine.</span>
<span class="cm"> * @pending_events: Bitmask of events flagged by the interrupt handler</span>
<span class="cm"> *	to be processed by the tasklet.</span>
<span class="cm"> * @completed_events: Bitmask of events which the state machine has</span>
<span class="cm"> *	processed.</span>
<span class="cm"> * @state: Tasklet state.</span>
<span class="cm"> * @queue: List of slots waiting for access to the controller.</span>
<span class="cm"> * @need_clock_update: Update the clock rate before the next request.</span>
<span class="cm"> * @need_reset: Reset controller before next request.</span>
<span class="cm"> * @timer: Timer to balance the data timeout error flag which cannot rise.</span>
<span class="cm"> * @mode_reg: Value of the MR register.</span>
<span class="cm"> * @cfg_reg: Value of the CFG register.</span>
<span class="cm"> * @bus_hz: The rate of @mck in Hz. This forms the basis for MMC bus</span>
<span class="cm"> *	rate and timeout calculations.</span>
<span class="cm"> * @mapbase: Physical address of the MMIO registers.</span>
<span class="cm"> * @mck: The peripheral bus clock hooked up to the MMC controller.</span>
<span class="cm"> * @pdev: Platform device associated with the MMC controller.</span>
<span class="cm"> * @slot: Slots sharing this MMC controller.</span>
<span class="cm"> * @caps: MCI capabilities depending on MCI version.</span>
<span class="cm"> * @prepare_data: function to setup MCI before data transfer which</span>
<span class="cm"> * depends on MCI capabilities.</span>
<span class="cm"> * @submit_data: function to start data transfer which depends on MCI</span>
<span class="cm"> * capabilities.</span>
<span class="cm"> * @stop_transfer: function to stop data transfer which depends on MCI</span>
<span class="cm"> * capabilities.</span>
<span class="cm"> *</span>
<span class="cm"> * Locking</span>
<span class="cm"> * =======</span>
<span class="cm"> *</span>
<span class="cm"> * @lock is a softirq-safe spinlock protecting @queue as well as</span>
<span class="cm"> * @cur_slot, @mrq and @state. These must always be updated</span>
<span class="cm"> * at the same time while holding @lock.</span>
<span class="cm"> *</span>
<span class="cm"> * @lock also protects mode_reg and need_clock_update since these are</span>
<span class="cm"> * used to synchronize mode register updates with the queue</span>
<span class="cm"> * processing.</span>
<span class="cm"> *</span>
<span class="cm"> * The @mrq field of struct atmel_mci_slot is also protected by @lock,</span>
<span class="cm"> * and must always be written at the same time as the slot is added to</span>
<span class="cm"> * @queue.</span>
<span class="cm"> *</span>
<span class="cm"> * @pending_events and @completed_events are accessed using atomic bit</span>
<span class="cm"> * operations, so they don&#39;t need any locking.</span>
<span class="cm"> *</span>
<span class="cm"> * None of the fields touched by the interrupt handler need any</span>
<span class="cm"> * locking. However, ordering is important: Before EVENT_DATA_ERROR or</span>
<span class="cm"> * EVENT_DATA_COMPLETE is set in @pending_events, all data-related</span>
<span class="cm"> * interrupts must be disabled and @data_status updated with a</span>
<span class="cm"> * snapshot of SR. Similarly, before EVENT_CMD_COMPLETE is set, the</span>
<span class="cm"> * CMDRDY interrupt must be disabled and @cmd_status updated with a</span>
<span class="cm"> * snapshot of SR, and before EVENT_XFER_COMPLETE can be set, the</span>
<span class="cm"> * bytes_xfered field of @data must be written. This is ensured by</span>
<span class="cm"> * using barriers.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atmel_mci</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pio_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">buf_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">buf_phys_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">cur_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">data_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">atmel_mci_dma</span>	<span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>		<span class="o">*</span><span class="n">data_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_slave_config</span>	<span class="n">dma_conf</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">cmd_status</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">data_status</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">stop_cmdr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">tasklet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">pending_events</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">completed_events</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">atmel_mci_state</span>	<span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">queue</span><span class="p">;</span>

	<span class="n">bool</span>			<span class="n">need_clock_update</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">need_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">mode_reg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cfg_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">bus_hz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">mapbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">mck</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span><span class="p">[</span><span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">atmel_mci_caps</span>   <span class="n">caps</span><span class="p">;</span>

	<span class="n">u32</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare_data</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">submit_data</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">stop_transfer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct atmel_mci_slot - MMC slot state</span>
<span class="cm"> * @mmc: The mmc_host representing this slot.</span>
<span class="cm"> * @host: The MMC controller this slot is using.</span>
<span class="cm"> * @sdc_reg: Value of SDCR to be written before using this slot.</span>
<span class="cm"> * @sdio_irq: SDIO irq mask for this slot.</span>
<span class="cm"> * @mrq: mmc_request currently being processed or waiting to be</span>
<span class="cm"> *	processed, or NULL when the slot is idle.</span>
<span class="cm"> * @queue_node: List node for placing this node in the @queue list of</span>
<span class="cm"> *	&amp;struct atmel_mci.</span>
<span class="cm"> * @clock: Clock rate configured by set_ios(). Protected by host-&gt;lock.</span>
<span class="cm"> * @flags: Random state bits associated with the slot.</span>
<span class="cm"> * @detect_pin: GPIO pin used for card detection, or negative if not</span>
<span class="cm"> *	available.</span>
<span class="cm"> * @wp_pin: GPIO pin used for card write protect sending, or negative</span>
<span class="cm"> *	if not available.</span>
<span class="cm"> * @detect_is_active_high: The state of the detect pin when it is active.</span>
<span class="cm"> * @detect_timer: Timer used for debouncing @detect_pin interrupts.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span>		<span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">sdc_reg</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">sdio_irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">queue_node</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define ATMCI_CARD_PRESENT	0</span>
<span class="cp">#define ATMCI_CARD_NEED_INIT	1</span>
<span class="cp">#define ATMCI_SHUTDOWN		2</span>
<span class="cp">#define ATMCI_SUSPENDED		3</span>

	<span class="kt">int</span>			<span class="n">detect_pin</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">wp_pin</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">detect_is_active_high</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">detect_timer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define atmci_test_and_clear_pending(host, event)		\</span>
<span class="cp">	test_and_clear_bit(event, &amp;host-&gt;pending_events)</span>
<span class="cp">#define atmci_set_completed(host, event)			\</span>
<span class="cp">	set_bit(event, &amp;host-&gt;completed_events)</span>
<span class="cp">#define atmci_set_pending(host, event)				\</span>
<span class="cp">	set_bit(event, &amp;host-&gt;pending_events)</span>

<span class="cm">/*</span>
<span class="cm"> * The debugfs stuff below is mostly optimized away when</span>
<span class="cm"> * CONFIG_DEBUG_FS is not set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_req_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span>	<span class="o">*</span><span class="n">stop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Make sure we get a consistent snapshot */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mrq</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">stop</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
				<span class="s">&quot;CMD%u(0x%x) flg %x rsp %x %x %x %x err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;DATA %u / %u * %u flg %x err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
				<span class="s">&quot;CMD%u(0x%x) flg %x rsp %x %x %x %x err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stop</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">stop</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">stop</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
				<span class="n">stop</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stop</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stop</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">stop</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_req_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">atmci_req_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">atmci_req_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">atmci_req_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_show_status_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regname</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">sr_bit</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;CMDRDY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RXRDY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TXRDY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;BLKE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;DTIP&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;NOTBUSY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">6</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ENDRX&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">7</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ENDTX&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">8</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SDIOIRQA&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">9</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SDIOIRQB&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">12</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SDIOWAIT&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">14</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RXBUFF&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">15</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TXBUFE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">16</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RINDE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">17</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RDIRE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">18</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RCRCE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">19</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RENDE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">20</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RTOE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">21</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;DCRCE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">22</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;DTOE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">23</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;CSTOE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">24</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;BLKOVRE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">25</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;DMADONE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">26</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FIFOEMPTY&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">27</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;XFRDONE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">30</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;OVRE&quot;</span><span class="p">,</span>
		<span class="p">[</span><span class="mi">31</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNRE&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s:</span><span class="se">\t</span><span class="s">0x%08x&quot;</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sr_bit</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sr_bit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">sr_bit</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">seq_puts</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot; UNKNOWN&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_regs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ATMCI_REGS_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab a more or less consistent snapshot. Note that we&#39;re</span>
<span class="cm">	 * not disabling interrupts, so IMR and SR may not be</span>
<span class="cm">	 * consistent.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ATMCI_REGS_SIZE</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;MR:</span><span class="se">\t</span><span class="s">0x%08x%s%s CLKDIV=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_MR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_MR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ATMCI_MR_RDPROOF</span> <span class="o">?</span> <span class="s">&quot; RDPROOF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_MR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ATMCI_MR_WRPROOF</span> <span class="o">?</span> <span class="s">&quot; WRPROOF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_MR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;DTOR:</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_DTOR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;SDCR:</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_SDCR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ARGR:</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_ARGR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;BLKR:</span><span class="se">\t</span><span class="s">0x%08x BCNT=%u BLKLEN=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_BLKR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_BLKR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_BLKR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cstor_reg</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CSTOR:</span><span class="se">\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_CSTOR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* Don&#39;t read RSPR and RDR; it will consume the data there */</span>

	<span class="n">atmci_show_status_reg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;SR&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_SR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="n">atmci_show_status_reg</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;IMR&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_IMR</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_DMA</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;DMA:</span><span class="se">\t</span><span class="s">0x%08x OFFSET=%u CHKSIZE=%u%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">val</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span>
				<span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span>
					<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATMCI_DMAEN</span> <span class="o">?</span> <span class="s">&quot; DMAEN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">ATMCI_CFG</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;CFG:</span><span class="se">\t</span><span class="s">0x%08x%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">val</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATMCI_CFG_FIFOMODE_1DATA</span> <span class="o">?</span> <span class="s">&quot; FIFOMODE_ONE_DATA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATMCI_CFG_FERRCTRL_COR</span> <span class="o">?</span> <span class="s">&quot; FERRCTRL_CLEAR_ON_READ&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATMCI_CFG_HSMODE</span> <span class="o">?</span> <span class="s">&quot; HSMODE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATMCI_CFG_LSYNC</span> <span class="o">?</span> <span class="s">&quot; LSYNC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_regs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">atmci_regs_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">atmci_regs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">atmci_regs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_init_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span>		<span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;regs&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">atmci_regs_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;req&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmci_req_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">debugfs_create_x32</span><span class="p">(</span><span class="s">&quot;pending_events&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pending_events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">debugfs_create_x32</span><span class="p">(</span><span class="s">&quot;completed_events&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">completed_events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize debugfs for slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atmci_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_VERSION</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_timeout_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;software timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atmci_ns_to_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is easier here to use us instead of ns for the timeout,</span>
<span class="cm">	 * it prevents from overflows during calculation.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">us</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Maximum clock frequency is host-&gt;bus_hz/2 */</span>
	<span class="k">return</span> <span class="n">us</span> <span class="o">*</span> <span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span>	<span class="n">dtomul_to_shift</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span>	<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">dtocyc</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">dtomul</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">atmci_ns_to_clocks</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dtomul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dtomul</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">dtomul</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">dtomul_to_shift</span><span class="p">[</span><span class="n">dtomul</span><span class="p">];</span>
		<span class="n">dtocyc</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtocyc</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtomul</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtomul</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">dtocyc</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;setting timeout to %u cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtocyc</span> <span class="o">&lt;&lt;</span> <span class="n">dtomul_to_shift</span><span class="p">[</span><span class="n">dtomul</span><span class="p">]);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_DTOR</span><span class="p">,</span> <span class="p">(</span><span class="n">ATMCI_DTOMUL</span><span class="p">(</span><span class="n">dtomul</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATMCI_DTOCYC</span><span class="p">(</span><span class="n">dtocyc</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return mask with command flags to be enabled for this command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">atmci_prepare_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>	<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">cmdr</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">cmdr</span> <span class="o">=</span> <span class="n">ATMCI_CMDR_CMDNB</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span>
			<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_RSPTYP_136BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_RSPTYP_48BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This should really be MAXLAT_5 for CMD2 and ACMD41, but</span>
<span class="cm">	 * it&#39;s too difficult to determine whether this is an ACMD or</span>
<span class="cm">	 * not. Better make it 64.</span>
<span class="cm">	 */</span>
	<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_MAXLAT_64CYC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">.</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_OPENDRAIN</span><span class="p">)</span>
		<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_OPDCMD</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_START_XFER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">SD_IO_RW_EXTENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_SDIO_BLOCK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_STREAM</span><span class="p">)</span>
				<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_STREAM</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_MULTI_BLOCK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_BLOCK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_TRDIR_READ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cmdr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;start command: ARGR=0x%08x CMDR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_ARGR</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CMDR</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_send_stop_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;send stop command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">atmci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_CMDRDY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure given PDC buffer taking care of alignement issues.</span>
<span class="cm"> * Update host-&gt;data_size and host-&gt;sg.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_pdc_set_single_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">atmci_xfer_dir</span> <span class="n">dir</span><span class="p">,</span> <span class="k">enum</span> <span class="n">atmci_pdc_buf</span> <span class="n">buf_nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pointer_reg</span><span class="p">,</span> <span class="n">counter_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">XFER_RECEIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pointer_reg</span> <span class="o">=</span> <span class="n">ATMEL_PDC_RPR</span><span class="p">;</span>
		<span class="n">counter_reg</span> <span class="o">=</span> <span class="n">ATMEL_PDC_RCR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pointer_reg</span> <span class="o">=</span> <span class="n">ATMEL_PDC_TPR</span><span class="p">;</span>
		<span class="n">counter_reg</span> <span class="o">=</span> <span class="n">ATMEL_PDC_TCR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_nb</span> <span class="o">==</span> <span class="n">PDC_SECOND_BUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pointer_reg</span> <span class="o">+=</span> <span class="n">ATMEL_PDC_SCND_BUF_OFF</span><span class="p">;</span>
		<span class="n">counter_reg</span> <span class="o">+=</span> <span class="n">ATMEL_PDC_SCND_BUF_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pointer_reg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_phys_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf_size</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pointer_reg</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">&lt;=</span> <span class="n">buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If size is different from modulo 4, transfer bytes */</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">counter_reg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">|</span> <span class="n">ATMCI_MR_PDCFBYTE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Else transfer 32-bits words */</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">counter_reg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We assume the size of a page is 32-bits aligned */</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">counter_reg</span><span class="p">,</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure PDC buffer according to the data size ie configuring one or two</span>
<span class="cm"> * buffers. Don&#39;t use this function if you want to configure only the second</span>
<span class="cm"> * buffer. In this case, use atmci_pdc_set_single_buf.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_pdc_set_both_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmci_pdc_set_single_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">PDC_FIRST_BUF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span>
		<span class="n">atmci_pdc_set_single_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">PDC_SECOND_BUF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap sg lists, called when transfer is finished.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_pdc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>         <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				<span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				 <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable PDC transfers. Update pending flags to EVENT_XFER_COMPLETE after</span>
<span class="cm"> * having received ATMCI_TXBUFE or ATMCI_RXBUFF interrupt. Enable ATMCI_NOTBUSY</span>
<span class="cm"> * interrupt needed for both transfer directions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_pdc_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">transfer_size</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMEL_PDC_PTCR</span><span class="p">,</span> <span class="n">ATMEL_PDC_RXTDIS</span> <span class="o">|</span> <span class="n">ATMEL_PDC_TXTDIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_bad_data_ordering</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">transfer_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
		                    <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">transfer_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atmci_pdc_cleanup</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the card was removed, data will be NULL. No point trying</span>
<span class="cm">	 * to send the stop command or waiting for NBUSY in this case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;(%s) set pending xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_dma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>                 <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				<span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				 <span class="o">?</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">:</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called by the DMA driver from tasklet context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_dma_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_dma</span><span class="p">)</span>
		<span class="cm">/* Disable DMA hardware handshaking on MCI */</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_DMA</span><span class="p">,</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_DMA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATMCI_DMAEN</span><span class="p">);</span>

	<span class="n">atmci_dma_cleanup</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the card was removed, data will be NULL. No point trying</span>
<span class="cm">	 * to send the stop command or waiting for NBUSY in this case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;(%s) set pending xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Regardless of what the documentation says, we have</span>
<span class="cm">		 * to wait for NOTBUSY even after block read</span>
<span class="cm">		 * operations.</span>
<span class="cm">		 *</span>
<span class="cm">		 * When the DMA transfer is complete, the controller</span>
<span class="cm">		 * may still be reading the CRC from the card, i.e.</span>
<span class="cm">		 * the data transfer is still in progress and we</span>
<span class="cm">		 * haven&#39;t seen all the potential error bits yet.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The interrupt handler will schedule a different</span>
<span class="cm">		 * tasklet to finish things up when the data transfer</span>
<span class="cm">		 * is completely done.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We may not complete the mmc request here anyway</span>
<span class="cm">		 * because the mmc layer may call back and cause us to</span>
<span class="cm">		 * violate the &quot;don&#39;t submit new operations from the</span>
<span class="cm">		 * completion callback&quot; rule of the dma engine</span>
<span class="cm">		 * framework.</span>
<span class="cm">		 */</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns a mask of interrupt flags to be enabled after the whole</span>
<span class="cm"> * request has been prepared.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">atmci_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_chan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">iflags</span> <span class="o">=</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Errata: MMC data write operation with less than 12</span>
<span class="cm">	 * bytes is impossible.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Errata: MCI Transmit Data Register (TDR) FIFO</span>
<span class="cm">	 * corruption when length is not multiple of 4.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&lt;</span> <span class="mi">12</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pio_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">iflags</span> <span class="o">|=</span> <span class="n">ATMCI_RXRDY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iflags</span> <span class="o">|=</span> <span class="n">ATMCI_TXRDY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set interrupt flags and set block length into the MCI mode register even</span>
<span class="cm"> * if this value is also accessible in the MCI block register. It seems to be</span>
<span class="cm"> * necessary before the High Speed MCI version. It also map sg and configure</span>
<span class="cm"> * PDC registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">atmci_prepare_data_pdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">iflags</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">iflags</span> <span class="o">=</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">;</span>

	<span class="cm">/* Enable pdc mode */</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">|</span> <span class="n">ATMCI_MR_PDCMODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
		<span class="n">iflags</span> <span class="o">|=</span> <span class="n">ATMCI_ENDRX</span> <span class="o">|</span> <span class="n">ATMCI_RXBUFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="n">iflags</span> <span class="o">|=</span> <span class="n">ATMCI_ENDTX</span> <span class="o">|</span> <span class="n">ATMCI_TXBUFE</span> <span class="o">|</span> <span class="n">ATMCI_BLKE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set BLKLEN */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ATMCI_BLKLEN</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Configure PDC */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="n">sg_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
		                  <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_bad_data_ordering</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span>
		<span class="n">atmci_pdc_set_both_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
			<span class="p">((</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">?</span> <span class="n">XFER_RECEIVE</span> <span class="o">:</span> <span class="n">XFER_TRANSMIT</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">iflags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">atmci_prepare_data_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>		<span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span>		<span class="n">direction</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_transfer_direction</span>	<span class="n">slave_dirn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">sglen</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">maxburst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iflags</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">iflags</span> <span class="o">=</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t do DMA on &quot;complex&quot; transfers, i.e. with</span>
<span class="cm">	 * non-word-aligned buffers or lengths. Also, we don&#39;t bother</span>
<span class="cm">	 * with all the DMA setup overhead for short transfers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&lt;</span> <span class="n">ATMCI_DMA_THRESHOLD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">atmci_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">atmci_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">atmci_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we don&#39;t have a channel, we can&#39;t do DMA */</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">slave_dirn</span> <span class="o">=</span> <span class="n">DMA_DEV_TO_MEM</span><span class="p">;</span>
		<span class="n">maxburst</span> <span class="o">=</span> <span class="n">atmci_convert_chksize</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">src_maxburst</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">slave_dirn</span> <span class="o">=</span> <span class="n">DMA_MEM_TO_DEV</span><span class="p">;</span>
		<span class="n">maxburst</span> <span class="o">=</span> <span class="n">atmci_convert_chksize</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">dst_maxburst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_DMA</span><span class="p">,</span> <span class="n">ATMCI_DMA_CHKSIZE</span><span class="p">(</span><span class="n">maxburst</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATMCI_DMAEN</span><span class="p">);</span>

	<span class="n">sglen</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">dmaengine_slave_config</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dmaengine_prep_slave_sg</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sglen</span><span class="p">,</span> <span class="n">slave_dirn</span><span class="p">,</span>
			<span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_CTRL_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_exit</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">data_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atmci_dma_complete</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iflags</span><span class="p">;</span>
<span class="nl">unmap_exit:</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atmci_submit_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start PDC according to transfer direction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atmci_submit_data_pdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMEL_PDC_PTCR</span><span class="p">,</span> <span class="n">ATMEL_PDC_RXTEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMEL_PDC_PTCR</span><span class="p">,</span> <span class="n">ATMEL_PDC_TXTEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atmci_submit_data_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span>			<span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span>	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">data_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmaengine_submit</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">dma_async_issue_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_stop_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	        <span class="s">&quot;(%s) set pending xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop data transfer because error(s) occured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_stop_transfer_pdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMEL_PDC_PTCR</span><span class="p">,</span> <span class="n">ATMEL_PDC_RXTDIS</span> <span class="o">|</span> <span class="n">ATMEL_PDC_TXTDIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_stop_transfer_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmaengine_terminate_all</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">atmci_dma_cleanup</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Data transfer was stopped by the interrupt handler */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;(%s) set pending xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start a request: prepare data if needed, prepare the command and activate</span>
<span class="cm"> * interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">iflags</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cmdflags</span><span class="p">;</span>

	<span class="n">mrq</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pending_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">completed_events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;start request: cmd %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_reset_after_xfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iflags</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IMR</span><span class="p">);</span>
		<span class="n">iflags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ATMCI_SDIOIRQA</span> <span class="o">|</span> <span class="n">ATMCI_SDIOIRQB</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_SWRST</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_MCIEN</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CFG</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span><span class="p">);</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SDCR</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdc_reg</span><span class="p">);</span>

	<span class="n">iflags</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IMR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iflags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ATMCI_SDIOIRQA</span> <span class="o">|</span> <span class="n">ATMCI_SDIOIRQB</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;WARNING: IMR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">iflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_NEED_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Send init sequence (74 clock cycles) */</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CMDR</span><span class="p">,</span> <span class="n">ATMCI_CMDR_SPCMD_INIT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATMCI_CMDRDY</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">iflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmci_set_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="cm">/* Must set block count/size before sending command */</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_BLKR</span><span class="p">,</span> <span class="n">ATMCI_BCNT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">ATMCI_BLKLEN</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">));</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;BLKR=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ATMCI_BCNT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">)</span> <span class="o">|</span> <span class="n">ATMCI_BLKLEN</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">));</span>

		<span class="n">iflags</span> <span class="o">|=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iflags</span> <span class="o">|=</span> <span class="n">ATMCI_CMDRDY</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmdflags</span> <span class="o">=</span> <span class="n">atmci_prepare_command</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">atmci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmdflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">submit_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span> <span class="o">=</span> <span class="n">atmci_prepare_command</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_STOP_XFER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">))</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_TRDIR_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_STREAM</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_STREAM</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_cmdr</span> <span class="o">|=</span> <span class="n">ATMCI_CMDR_MULTI_BLOCK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could have enabled interrupts earlier, but I suspect</span>
<span class="cm">	 * that would open up a nice can of interesting race</span>
<span class="cm">	 * conditions (e.g. command and data complete, but stop not</span>
<span class="cm">	 * prepared yet.)</span>
<span class="cm">	 */</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">iflags</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_queue_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;queue request: state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SENDING_CMD</span><span class="p">;</span>
		<span class="n">atmci_start_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;queue request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">queue_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MRQ: cmd %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We may &quot;know&quot; the card is gone even though there&#39;s still an</span>
<span class="cm">	 * electrical connection. If so, we really need to communicate</span>
<span class="cm">	 * this to the MMC core since there won&#39;t be any more</span>
<span class="cm">	 * interrupts as the card is completely removed. Otherwise,</span>
<span class="cm">	 * the MMC core might believe the card is still there even</span>
<span class="cm">	 * though the card was just removed very slowly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t support multiple blocks of weird lengths. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atmci_queue_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdc_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATMCI_SDCBUS_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_1</span>:
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdc_reg</span> <span class="o">|=</span> <span class="n">ATMCI_SDCBUS_1BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_4</span>:
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdc_reg</span> <span class="o">|=</span> <span class="n">ATMCI_SDCBUS_4BIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock_min</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">clkdiv</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_SWRST</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_MCIEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CFG</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use mirror of ios-&gt;clock to prevent race with mmc</span>
<span class="cm">		 * core ios update when finding the minimum.</span>
<span class="cm">		 */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clock</span>
					<span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="n">clock_min</span><span class="p">)</span>
				<span class="n">clock_min</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Calculate clock divider */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_odd_clk_div</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clkdiv</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span><span class="p">,</span> <span class="n">clock_min</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clkdiv</span> <span class="o">&gt;</span> <span class="mi">511</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
				         <span class="s">&quot;clock %u too slow; using %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				         <span class="n">clock_min</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span> <span class="o">/</span> <span class="p">(</span><span class="mi">511</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
				<span class="n">clkdiv</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">=</span> <span class="n">ATMCI_MR_CLKDIV</span><span class="p">(</span><span class="n">clkdiv</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
			                 <span class="o">|</span> <span class="n">ATMCI_MR_CLKODD</span><span class="p">(</span><span class="n">clkdiv</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clkdiv</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">clock_min</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clkdiv</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
				         <span class="s">&quot;clock %u too slow; using %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				         <span class="n">clock_min</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">256</span><span class="p">));</span>
				<span class="n">clkdiv</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">=</span> <span class="n">ATMCI_MR_CLKDIV</span><span class="p">(</span><span class="n">clkdiv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * WRPROOF and RDPROOF prevent overruns/underruns by</span>
<span class="cm">		 * stopping the clock when the FIFO is full/empty.</span>
<span class="cm">		 * This state is not expected to last for long.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ATMCI_MR_WRPROOF</span> <span class="o">|</span> <span class="n">ATMCI_MR_RDPROOF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* setup High Speed mode in relation with card capacity */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_SD_HS</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span> <span class="o">|=</span> <span class="n">ATMCI_CFG_HSMODE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATMCI_CFG_HSMODE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CFG</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">need_clock_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">any_slot_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">any_slot_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">any_slot_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_MCIDIS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">);</span>
				<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_POWER_UP</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_NEED_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: None of the currently available AVR32-based</span>
<span class="cm">		 * boards allow MMC power to be turned off. Implement</span>
<span class="cm">		 * power control when this can be tested properly.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We also need to hook this into the clock management</span>
<span class="cm">		 * somehow so that newly inserted cards aren&#39;t</span>
<span class="cm">		 * subjected to a fast clock before we have a chance</span>
<span class="cm">		 * to figure out what the maximum rate is. Currently,</span>
<span class="cm">		 * there&#39;s no way to avoid this, and there never will</span>
<span class="cm">		 * be for boards that don&#39;t support power control.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">read_only</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_only</span> <span class="o">=</span> <span class="n">gpio_get_value</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;card is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">read_only</span> <span class="o">?</span> <span class="s">&quot;read-only&quot;</span> <span class="o">:</span> <span class="s">&quot;read-write&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">read_only</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_get_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">present</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">present</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">)</span> <span class="o">^</span>
			    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_is_active_high</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;card is %spresent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">present</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">present</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_enable_sdio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdio_irq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdio_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">atmci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">atmci_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">atmci_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">atmci_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cd</span>		<span class="o">=</span> <span class="n">atmci_get_cd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_sdio_irq</span> <span class="o">=</span> <span class="n">atmci_enable_sdio_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Called with host-&gt;lock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_request_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span>		<span class="o">*</span><span class="n">prev_mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the MMC clock rate if necessary. This may be</span>
<span class="cm">	 * necessary if set_ios() is called when a different slot is</span>
<span class="cm">	 * busy transferring data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">need_clock_update</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CFG</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_slot</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">atmel_mci_slot</span><span class="p">,</span> <span class="n">queue_node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">queue_node</span><span class="p">);</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;list not empty: %s is next</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SENDING_CMD</span><span class="p">;</span>
		<span class="n">atmci_start_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;list empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_IDLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">prev_mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_command_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>		<span class="n">status</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">;</span>

	<span class="cm">/* Read the response from the card (up to 16 bytes) */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_RSPR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_RSPR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_RSPR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_RSPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_RTOE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_CRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_RCRCE</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATMCI_RINDE</span> <span class="o">|</span> <span class="n">ATMCI_RDIRE</span> <span class="o">|</span> <span class="n">ATMCI_RENDE</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_blksz_mul_4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_detect_change</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">present</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">present_old</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * atmci_cleanup_slot() sets the ATMCI_SHUTDOWN flag before</span>
<span class="cm">	 * freeing the interrupt. We must not re-enable the interrupt</span>
<span class="cm">	 * if it has been freed, and if we&#39;re shutting down, it</span>
<span class="cm">	 * doesn&#39;t really matter whether the card is present or not.</span>
<span class="cm">	 */</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATMCI_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">));</span>
	<span class="n">present</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">)</span> <span class="o">^</span>
		    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_is_active_high</span><span class="p">);</span>
	<span class="n">present_old</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;detect change: %d (was %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">present</span><span class="p">,</span> <span class="n">present_old</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">present</span> <span class="o">!=</span> <span class="n">present_old</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;card %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">present</span> <span class="o">?</span> <span class="s">&quot;inserted&quot;</span> <span class="o">:</span> <span class="s">&quot;removed&quot;</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Clean up queue if present */</span>
		<span class="n">mrq</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Reset controller to terminate any ongoing</span>
<span class="cm">				 * commands or data transfers.</span>
<span class="cm">				 */</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_SWRST</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_MCIEN</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_MR</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span><span class="p">)</span>
					<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CFG</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cfg_reg</span><span class="p">);</span>

				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">STATE_IDLE</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_SENDING_CMD</span>:
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
						<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_DATA_XFER</span>:
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_WAITING_NOTBUSY</span>:
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_SENDING_STOP</span>:
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">STATE_END_REQUEST</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">atmci_request_end</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">queue_node</span><span class="p">);</span>
				<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
					<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>

				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_tasklet_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span>	<span class="o">*</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">atmel_mci_state</span>	<span class="n">state</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">atmel_mci_state</span>	<span class="n">prev_state</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;tasklet: state %u pending/completed/mask %lx/%lx/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">state</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pending_events</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">completed_events</span><span class="p">,</span>
		<span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IMR</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prev_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_IDLE</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_SENDING_CMD</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Command has been sent, we are waiting for command</span>
<span class="cm">			 * ready. Then we have three next states possible:</span>
<span class="cm">			 * END_REQUEST by default, WAITING_NOTBUSY if it&#39;s a</span>
<span class="cm">			 * command needing it or DATA_XFER if there is data.</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: cmd ready?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmci_test_and_clear_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">EVENT_CMD_RDY</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set completed cmd ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">atmci_set_completed</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_CMD_RDY</span><span class="p">);</span>
			<span class="n">atmci_command_complete</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				        <span class="s">&quot;command with data transfer&quot;</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * If there is a command error don&#39;t start</span>
<span class="cm">				 * data transfer.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span>
					             <span class="n">ATMCI_TXRDY</span> <span class="o">|</span> <span class="n">ATMCI_RXRDY</span>
					             <span class="o">|</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">);</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_DATA_XFER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				        <span class="s">&quot;command response need waiting notbusy&quot;</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_WAITING_NOTBUSY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DATA_XFER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">atmci_test_and_clear_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">EVENT_DATA_ERROR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set completed data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">atmci_set_completed</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_DATA_ERROR</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * A data transfer is in progress. The event expected</span>
<span class="cm">			 * to move to the next state depends of data transfer</span>
<span class="cm">			 * type (PDC or DMA). Once transfer done we can move</span>
<span class="cm">			 * to the next step which is WAITING_NOTBUSY in write</span>
<span class="cm">			 * case and directly SENDING_STOP in read case.</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: xfer complete?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmci_test_and_clear_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">EVENT_XFER_COMPLETE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			        <span class="s">&quot;(%s) set completed xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">atmci_set_completed</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_WAITING_NOTBUSY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_CMDRDY</span><span class="p">);</span>
				<span class="n">atmci_send_stop_cmd</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SENDING_STOP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_WAITING_NOTBUSY</span>:
			<span class="cm">/*</span>
<span class="cm">			 * We can be in the state for two reasons: a command</span>
<span class="cm">			 * requiring waiting not busy signal (stop command</span>
<span class="cm">			 * included) or a write operation. In the latest case,</span>
<span class="cm">			 * we need to send a stop command.</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: not busy?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmci_test_and_clear_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">EVENT_NOTBUSY</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set completed not busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_set_completed</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_NOTBUSY</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * For some commands such as CMD53, even if</span>
<span class="cm">				 * there is data transfer, there is no stop</span>
<span class="cm">				 * command to send.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span>
					             <span class="n">ATMCI_CMDRDY</span><span class="p">);</span>
					<span class="n">atmci_send_stop_cmd</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SENDING_STOP</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span>
					                     <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_SENDING_STOP</span>:
			<span class="cm">/*</span>
<span class="cm">			 * In this state, it is important to set host-&gt;data to</span>
<span class="cm">			 * NULL (which is tested in the waiting notbusy state)</span>
<span class="cm">			 * in order to go to the end request state instead of</span>
<span class="cm">			 * sending stop again.</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: cmd ready?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmci_test_and_clear_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">EVENT_CMD_RDY</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FSM: cmd ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">atmci_command_complete</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span>
				             <span class="n">ATMCI_TXRDY</span> <span class="o">|</span> <span class="n">ATMCI_RXRDY</span>
				             <span class="o">|</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_END_REQUEST</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
				<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_WAITING_NOTBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_END_REQUEST</span>:
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_TXRDY</span> <span class="o">|</span> <span class="n">ATMCI_RXRDY</span>
			                   <span class="o">|</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_DTOE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_DCRCE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">atmci_request_end</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">STATE_IDLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">prev_state</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_read_data_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">offset</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pio_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_RDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">put_unaligned</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>

			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="n">remaining</span><span class="p">;</span>

			<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span> <span class="o">+</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="p">(</span><span class="n">ATMCI_NOTBUSY</span> <span class="o">|</span> <span class="n">ATMCI_RXRDY</span>
						<span class="o">|</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_RXRDY</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pio_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_RXRDY</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_write_data_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span>	<span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">offset</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pio_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_TDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">remaining</span><span class="p">);</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="n">remaining</span><span class="p">;</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_TDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">remaining</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span> <span class="o">+</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_TDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">nbytes</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="p">(</span><span class="n">ATMCI_NOTBUSY</span> <span class="o">|</span> <span class="n">ATMCI_TXRDY</span>
						<span class="o">|</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATMCI_TXRDY</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pio_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_TXRDY</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_XFER_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmci_sdio_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdio_irq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atmci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">status</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pass_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SR</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IMR</span><span class="p">);</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_DATA_ERROR_FLAGS</span>
					<span class="o">|</span> <span class="n">ATMCI_RXRDY</span> <span class="o">|</span> <span class="n">ATMCI_TXRDY</span>
					<span class="o">|</span> <span class="n">ATMCI_ENDRX</span> <span class="o">|</span> <span class="n">ATMCI_ENDTX</span>
					<span class="o">|</span> <span class="n">ATMCI_RXBUFF</span> <span class="o">|</span> <span class="n">ATMCI_TXBUFE</span><span class="p">);</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set pending data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_DATA_ERROR</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_TXBUFE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: tx buffer empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_TXBUFE</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_ENDTX</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We can receive this interruption before having configured</span>
<span class="cm">			 * the second pdc buffer, so we need to reconfigure first and</span>
<span class="cm">			 * second buffers again</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_pdc_set_both_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">XFER_TRANSMIT</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_ENDTX</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_TXBUFE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atmci_pdc_complete</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_ENDTX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: end of tx buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_ENDTX</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_pdc_set_single_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">XFER_TRANSMIT</span><span class="p">,</span> <span class="n">PDC_SECOND_BUF</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_ENDTX</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_RXBUFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: rx buffer full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_RXBUFF</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_ENDRX</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We can receive this interruption before having configured</span>
<span class="cm">			 * the second pdc buffer, so we need to reconfigure first and</span>
<span class="cm">			 * second buffers again</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_pdc_set_both_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">XFER_RECEIVE</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_ENDRX</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_RXBUFF</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atmci_pdc_complete</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_ENDRX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: end of rx buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_ENDRX</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmci_pdc_set_single_buf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">XFER_RECEIVE</span><span class="p">,</span> <span class="n">PDC_SECOND_BUF</span><span class="p">);</span>
				<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IER</span><span class="p">,</span> <span class="n">ATMCI_ENDRX</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * First mci IPs, so mainly the ones having pdc, have some</span>
<span class="cm">		 * issues with the notbusy signal. You can&#39;t get it after</span>
<span class="cm">		 * data transmission if you have not sent a stop command.</span>
<span class="cm">		 * The appropriate workaround is to use the BLKE signal.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_BLKE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: blke</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_BLKE</span><span class="p">);</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set pending notbusy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_NOTBUSY</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: not_busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_NOTBUSY</span><span class="p">);</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set pending notbusy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_NOTBUSY</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_RXRDY</span><span class="p">)</span>
			<span class="n">atmci_read_data_pio</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_TXRDY</span><span class="p">)</span>
			<span class="n">atmci_write_data_pio</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="n">ATMCI_CMDRDY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ: cmd ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="n">ATMCI_CMDRDY</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set pending cmd rdy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atmci_set_pending</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">EVENT_CMD_RDY</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATMCI_SDIOIRQA</span> <span class="o">|</span> <span class="n">ATMCI_SDIOIRQB</span><span class="p">))</span>
			<span class="n">atmci_sdio_interrupt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pass_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pass_count</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atmci_detect_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>	<span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable interrupts until the pin has stabilized and check</span>
<span class="cm">	 * the state then. Use mod_timer() since we may be in the</span>
<span class="cm">	 * middle of the timer routine when this interrupt triggers.</span>
<span class="cm">	 */</span>
	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atmci_init_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mci_slot_pdata</span> <span class="o">*</span><span class="n">slot_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">sdc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sdio_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span>			<span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci_slot</span>		<span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci_slot</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span> <span class="o">=</span> <span class="n">slot_data</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span> <span class="o">=</span> <span class="n">slot_data</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_is_active_high</span> <span class="o">=</span> <span class="n">slot_data</span><span class="o">-&gt;</span><span class="n">detect_is_active_high</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdc_reg</span> <span class="o">=</span> <span class="n">sdc_reg</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">sdio_irq</span> <span class="o">=</span> <span class="n">sdio_irq</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span>	<span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdio_irq</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SDIO_IRQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_highspeed</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Without the read/write proof capability, it is strongly suggested to</span>
<span class="cm">	 * use only one bit for data to prevent fifo underruns and overruns</span>
<span class="cm">	 * which will corrupt data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slot_data</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atmci_get_version</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">4095</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="mi">32768</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assume card is present initially */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">,</span> <span class="s">&quot;mmc_detect&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;no detect pin available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">)</span> <span class="o">^</span>
				<span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_is_active_high</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATMCI_CARD_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_NEEDS_POLL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">,</span> <span class="s">&quot;mmc_wp&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="s">&quot;no WP pin available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_timer</span><span class="p">,</span> <span class="n">atmci_detect_change</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">),</span>
				<span class="n">atmci_detect_interrupt</span><span class="p">,</span>
				<span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span>
				<span class="s">&quot;mmc-detect&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
				<span class="s">&quot;could not request IRQ %d for detect pin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">));</span>
			<span class="n">gpio_free</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">);</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">atmci_init_debugfs</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atmci_cleanup_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Debugfs stuff is cleaned up by mmc core */</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATMCI_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">;</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">pin</span><span class="p">),</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">detect_timer</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">wp_pin</span><span class="p">);</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">atmci_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mci_dma_data</span>	<span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span> <span class="o">&amp;&amp;</span> <span class="n">find_slave_dev</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slave_data_ptr</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">atmci_configure_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mci_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">find_slave_dev</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>

		<span class="cm">/* Try to grab a DMA channel */</span>
		<span class="n">dma_cap_zero</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_SLAVE</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span> <span class="o">=</span>
			<span class="n">dma_request_channel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">atmci_filter</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_slave</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no DMA channel available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;using %s for DMA transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dma_chan_name</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">));</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">ATMCI_RDR</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">src_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">src_maxburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">+</span> <span class="n">ATMCI_TDR</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">dst_addr_width</span> <span class="o">=</span> <span class="n">DMA_SLAVE_BUSWIDTH_4_BYTES</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">dst_maxburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_conf</span><span class="p">.</span><span class="n">device_fc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HSMCI (High Speed MCI) module is not fully compatible with MCI module.</span>
<span class="cm"> * HSMCI provides DMA support and a new config register but no more supports</span>
<span class="cm"> * PDC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">atmci_get_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">atmci_get_version</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;version: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_pdc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cstor_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_highspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_odd_clk_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_bad_data_ordering</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_reset_after_xfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_blksz_mul_4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* keep only major version number */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x500</span>:
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_odd_clk_div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x400</span>:
	<span class="k">case</span> <span class="mh">0x300</span>:
<span class="cp">#ifdef CONFIG_AT_HDMAC</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;has dma capability but dma engine is not selected, then use pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_pdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cfg_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_cstor_reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_highspeed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x200</span>:
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_blksz_mul_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x100</span>:
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_bad_data_ordering</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">need_reset_after_xfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_pdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unmanaged mci version, set minimum capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atmci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mci_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>		<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">nr_slots</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_mci</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mci_clk&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_clk_get</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_SWRST</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_hz</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">atmci_tasklet_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">atmci_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_request_irq</span><span class="p">;</span>

	<span class="cm">/* Get MCI capabilities and set operations according to it */</span>
	<span class="n">atmci_get_cap</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_dma</span> <span class="o">&amp;&amp;</span> <span class="n">atmci_configure_dma</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">prepare_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_prepare_data_dma</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">submit_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_submit_data_dma</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_stop_transfer_dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_pdc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using PDC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">prepare_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_prepare_data_pdc</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">submit_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_submit_data_pdc</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_stop_transfer_pdc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using PIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">prepare_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_prepare_data</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">submit_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_submit_data</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_transfer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmci_stop_transfer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">atmci_timeout_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* We need at least one slot to succeed */</span>
	<span class="n">nr_slots</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">atmci_init_slot</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">ATMCI_SDCSEL_SLOT_A</span><span class="p">,</span> <span class="n">ATMCI_SDIOIRQA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nr_slots</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">atmci_init_slot</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="mi">1</span><span class="p">,</span> <span class="n">ATMCI_SDCSEL_SLOT_B</span><span class="p">,</span> <span class="n">ATMCI_SDIOIRQB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nr_slots</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_slots</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;init failed: no slot defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_init_slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">has_rwproof</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span>
		                                  <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_phys_addr</span><span class="p">,</span>
						  <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;buffer allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_init_slot</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Atmel MCI controller at 0x%08lx irq %d, %u slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">nr_slots</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init_slot:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_request_irq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
<span class="nl">err_clk_get:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">atmci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">,</span>
		                  <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_phys_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">atmci_cleanup_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_IDR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">);</span>
	<span class="n">atmci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_CR</span><span class="p">,</span> <span class="n">ATMCI_CR_MCIDIS</span><span class="p">);</span>
	<span class="n">atmci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ATMCI_SR</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MMC_ATMELMCI_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">chan</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mck</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	 <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">slot</span>
				<span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">ATMCI_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATMCI_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">ATMCI_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_mci</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATMCI_MAX_NR_SLOTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atmel_mci_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATMCI_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATMCI_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">atmci_pm</span><span class="p">,</span> <span class="n">atmci_suspend</span><span class="p">,</span> <span class="n">atmci_resume</span><span class="p">);</span>
<span class="cp">#define ATMCI_PM_OPS	(&amp;atmci_pm)</span>
<span class="cp">#else</span>
<span class="cp">#define ATMCI_PM_OPS	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">atmci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">atmci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_mci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>		<span class="o">=</span> <span class="n">ATMCI_PM_OPS</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atmci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmci_driver</span><span class="p">,</span> <span class="n">atmci_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atmci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">late_initcall</span><span class="p">(</span><span class="n">atmci_init</span><span class="p">);</span> <span class="cm">/* try to load after dma driver when built-in */</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atmci_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Atmel Multimedia Card Interface driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Haavard Skinnemoen (Atmel)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
