<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › wbsd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wbsd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mmc/host/wbsd.c - Winbond W83L51xD SD/MMC driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004-2007 Pierre Ossman, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Warning!</span>
<span class="cm"> *</span>
<span class="cm"> * Changes to the FIFO system should be done with extreme care since</span>
<span class="cm"> * the hardware is full of bugs related to the FIFO. Known issues are:</span>
<span class="cm"> *</span>
<span class="cm"> * - FIFO size field in FSR is always zero.</span>
<span class="cm"> *</span>
<span class="cm"> * - FIFO interrupts tend not to work as they should. Interrupts are</span>
<span class="cm"> *   triggered only for full/empty events, not for threshold values.</span>
<span class="cm"> *</span>
<span class="cm"> * - On APIC systems the FIFO empty interrupt is sometimes lost.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;wbsd.h&quot;</span>

<span class="cp">#define DRIVER_NAME &quot;wbsd&quot;</span>

<span class="cp">#define DBG(x...) \</span>
<span class="cp">	pr_debug(DRIVER_NAME &quot;: &quot; x)</span>
<span class="cp">#define DBGF(f, x...) \</span>
<span class="cp">	pr_debug(DRIVER_NAME &quot; [%s()]: &quot; f, __func__ , ##x)</span>

<span class="cm">/*</span>
<span class="cm"> * Device resources</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">pnp_dev_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;WEC0517&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;WEC0518&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">pnp_dev_table</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">config_ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x4E</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">unlock_codes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x87</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">valid_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x7112</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">param_nopnp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">param_nopnp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">param_io</span> <span class="o">=</span> <span class="mh">0x248</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">param_irq</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">param_dma</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Basic functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_unlock_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unlock_code</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">unlock_code</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_lock_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">LOCK_CODE</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">wbsd_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_write_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_IDXR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_DATAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">wbsd_read_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_IDXR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_DATAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">setup</span><span class="p">,</span> <span class="n">ier</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset chip (SD/MMC part) and fifo.</span>
<span class="cm">	 */</span>
	<span class="n">setup</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">);</span>
	<span class="n">setup</span> <span class="o">|=</span> <span class="n">WBSD_FIFO_RESET</span> <span class="o">|</span> <span class="n">WBSD_SOFT_RESET</span><span class="p">;</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set DAT3 to input</span>
<span class="cm">	 */</span>
	<span class="n">setup</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_DAT3_H</span><span class="p">;</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_FIGNORE_DETECT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read back default clock.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_CLK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power down port.</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">WBSD_POWER_N</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set maximum timeout.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_TAAC</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test for card presence</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WBSD_CARDPRESENT</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WBSD_FCARD_PRESENT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_FCARD_PRESENT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable interesting interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">WBSD_EINT_CARD</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">WBSD_EINT_FIFO_THRE</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">WBSD_EINT_CRC</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">WBSD_EINT_TIMEOUT</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">WBSD_EINT_TC</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_EIR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_ISR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">setup</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Resetting chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Soft reset of chip (SD/MMC part).</span>
<span class="cm">	 */</span>
	<span class="n">setup</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">);</span>
	<span class="n">setup</span> <span class="o">|=</span> <span class="n">WBSD_SOFT_RESET</span><span class="p">;</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_request_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmaflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Release ISA DMA controller.</span>
<span class="cm">		 */</span>
		<span class="n">dmaflags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disable DMA on host.</span>
<span class="cm">		 */</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MMC layer might call back into the driver so first unlock.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scatter/gather functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_init_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Get info. about SG list from data structure.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wbsd_next_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Skip to next SG entry.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="o">++</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Any entries left?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">wbsd_sg_to_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cur_sg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_sg_to_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sgbuf</span><span class="p">;</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgbuf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">,</span> <span class="n">sgbuf</span><span class="p">,</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">dmabuf</span> <span class="o">+=</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_dma_to_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dmabuf</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sgbuf</span><span class="p">;</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgbuf</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sgbuf</span><span class="p">,</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">dmabuf</span> <span class="o">+=</span> <span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Command handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_get_short_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Correct response type?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RSPLEN</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WBSD_RSP_SHORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP13</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP14</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wbsd_get_long_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Correct response type?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RSPLEN</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WBSD_RSP_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
			<span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
			<span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP3</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
			<span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_RESP4</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">isr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear accumulated ISR. The interrupt routine</span>
<span class="cm">	 * will fill this one with events that occur during</span>
<span class="cm">	 * transfer.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send the command (CRC calculated by host).</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CMDR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CMDR</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the request to complete.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">WBSD_CARDTRAFFIC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do we expect a reply?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read back status.</span>
<span class="cm">		 */</span>
		<span class="n">isr</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">;</span>

		<span class="cm">/* Card removed? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_CARD</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="cm">/* Timeout? */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_TIMEOUT</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="cm">/* CRC? */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_CRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_CRC</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="cm">/* All ok */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span>
				<span class="n">wbsd_get_long_reply</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">wbsd_get_short_reply</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_empty_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fsr</span><span class="p">,</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle excessive data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">wbsd_sg_to_buffer</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Drain the fifo. This has a tendency to loop longer</span>
<span class="cm">	 * than the FIFO length (usually one block).</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">fsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_FSR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The size field in the FSR is broken so we have to</span>
<span class="cm">		 * do some guessing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_FULL</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_FUTHRE</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fifo</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_DFR</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span><span class="o">--</span><span class="p">;</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * End of scatter list entry?</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get next entry. Check if last.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wbsd_next_sg</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="n">buffer</span> <span class="o">=</span> <span class="n">wbsd_sg_to_buffer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a very dirty hack to solve a</span>
<span class="cm">	 * hardware problem. The chip doesn&#39;t trigger</span>
<span class="cm">	 * FIFO threshold interrupts properly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">-</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_fill_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fsr</span><span class="p">,</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that we aren&#39;t being called after the</span>
<span class="cm">	 * entire buffer has been transferred.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">wbsd_sg_to_buffer</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill the fifo. This has a tendency to loop longer</span>
<span class="cm">	 * than the FIFO length (usually one block).</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">fsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_FSR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_FULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The size field in the FSR is broken so we have to</span>
<span class="cm">		 * do some guessing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_EMPTY</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fsr</span> <span class="o">&amp;</span> <span class="n">WBSD_FIFO_EMTHRE</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">fifo</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_DFR</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">offset</span><span class="o">++</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span><span class="o">--</span><span class="p">;</span>

			<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * End of scatter list entry?</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">remain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Get next entry. Check if last.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wbsd_next_sg</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="n">buffer</span> <span class="o">=</span> <span class="n">wbsd_sg_to_buffer</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The controller stops sending interrupts for</span>
<span class="cm">	 * &#39;FIFO empty&#39; under certain conditions. So we</span>
<span class="cm">	 * need to be a bit more pro-active.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">blksize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">setup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmaflags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate size.</span>
<span class="cm">	 */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check timeout values for overflow.</span>
<span class="cm">	 * (Yes, some cards cause this value to overflow).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">&gt;</span> <span class="mi">127000000</span><span class="p">)</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_TAAC</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_TAAC</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_NSAC</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_NSAC</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Inform the chip of how large blocks will be</span>
<span class="cm">	 * sent. It needs this to determine when to</span>
<span class="cm">	 * calculate CRC.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Space for CRC must be included in the size.</span>
<span class="cm">	 * Two bytes are needed for each data line.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blksize</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_PBSMSB</span><span class="p">,</span> <span class="p">(</span><span class="n">blksize</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_PBSLSB</span><span class="p">,</span> <span class="n">blksize</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blksize</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_PBSMSB</span><span class="p">,</span>
			<span class="p">((</span><span class="n">blksize</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">|</span> <span class="n">WBSD_DATA_WIDTH</span><span class="p">);</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_PBSLSB</span><span class="p">,</span> <span class="n">blksize</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO. This is needed even for DMA</span>
<span class="cm">	 * transfers since the chip still uses the FIFO</span>
<span class="cm">	 * internally.</span>
<span class="cm">	 */</span>
	<span class="n">setup</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">);</span>
	<span class="n">setup</span> <span class="o">|=</span> <span class="n">WBSD_FIFO_RESET</span><span class="p">;</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMA transfer?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The buffer for DMA is only 64 kB.</span>
<span class="cm">		 */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Transfer data from the SG list to</span>
<span class="cm">		 * the DMA buffer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
			<span class="n">wbsd_sg_to_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Initialise the ISA DMA controller.</span>
<span class="cm">		 */</span>
		<span class="n">dmaflags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_WRITE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">enable_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enable DMA on the host.</span>
<span class="cm">		 */</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_DMA</span><span class="p">,</span> <span class="n">WBSD_DMA_ENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This flag is used to keep printk</span>
<span class="cm">		 * output to a minimum.</span>
<span class="cm">		 */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">firsterr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Initialise the SG list.</span>
<span class="cm">		 */</span>
		<span class="n">wbsd_init_sg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Turn off DMA.</span>
<span class="cm">		 */</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set up FIFO threshold levels (and fill</span>
<span class="cm">		 * buffer if doing a write).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_FIFOEN</span><span class="p">,</span>
				<span class="n">WBSD_FIFOEN_FULL</span> <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_FIFOEN</span><span class="p">,</span>
				<span class="n">WBSD_FIFOEN_EMPTY</span> <span class="o">|</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">wbsd_fill_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_finish_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmaflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send a stop command if needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">wbsd_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the controller to leave data</span>
<span class="cm">	 * transfer state.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WBSD_BLOCK_READ</span> <span class="o">|</span> <span class="n">WBSD_BLOCK_WRITE</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMA transfer?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable DMA on the host.</span>
<span class="cm">		 */</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Turn of ISA DMA controller.</span>
<span class="cm">		 */</span>
		<span class="n">dmaflags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflags</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">-=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">%</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Any leftover data?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Incomplete DMA transfer. &quot;</span>
				<span class="s">&quot;%d bytes left.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Transfer data from DMA buffer to</span>
<span class="cm">			 * SG list.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
				<span class="n">wbsd_dma_to_sg</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="p">)</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">-=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wbsd_request_end</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * MMC layer callbacks                                                       *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable tasklets to avoid a deadlock.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that there is actually a card in the slot.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WBSD_FCARD_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The hardware is so delightfully stupid that it has a list</span>
<span class="cm">		 * of &quot;data&quot; commands. If a command isn&#39;t on this list, it&#39;ll</span>
<span class="cm">		 * just go back to the idle state and won&#39;t send any data</span>
<span class="cm">		 * interrupts.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">11</span>:
		<span class="k">case</span> <span class="mi">17</span>:
		<span class="k">case</span> <span class="mi">18</span>:
		<span class="k">case</span> <span class="mi">20</span>:
		<span class="k">case</span> <span class="mi">24</span>:
		<span class="k">case</span> <span class="mi">25</span>:
		<span class="k">case</span> <span class="mi">26</span>:
		<span class="k">case</span> <span class="mi">27</span>:
		<span class="k">case</span> <span class="mi">30</span>:
		<span class="k">case</span> <span class="mi">42</span>:
		<span class="k">case</span> <span class="mi">56</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* ACMDs. We don&#39;t keep track of state, so we just treat them</span>
<span class="cm">		 * like any other command. */</span>
		<span class="k">case</span> <span class="mi">51</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Data command %d is not &quot;</span>
				<span class="s">&quot;supported by this controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Does the request include data?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbsd_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wbsd_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is a data transfer the request</span>
<span class="cm">	 * will be finished after the data has</span>
<span class="cm">	 * transferred.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Dirty fix for hardware bug.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">);</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">wbsd_request_end</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">clk</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">pwr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip on each power off.</span>
<span class="cm">	 * Should clear out any weird states.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span>
		<span class="n">wbsd_init_device</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">24000000</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">WBSD_CLK_24M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">16000000</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">WBSD_CLK_16M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">12000000</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">WBSD_CLK_12M</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">WBSD_CLK_375K</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only write to the clock register when</span>
<span class="cm">	 * there is an actual change.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_CLK</span><span class="p">,</span> <span class="n">clk</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power up card.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>
		<span class="n">pwr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_POWER_N</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">pwr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MMC cards need to have pin 1 high during init.</span>
<span class="cm">	 * It wreaks havoc with the card detection though so</span>
<span class="cm">	 * that needs to be disabled.</span>
<span class="cm">	 */</span>
	<span class="n">setup</span> <span class="o">=</span> <span class="n">wbsd_read_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">chip_select</span> <span class="o">==</span> <span class="n">MMC_CS_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">!=</span> <span class="n">MMC_BUS_WIDTH_1</span><span class="p">);</span>
		<span class="n">setup</span> <span class="o">|=</span> <span class="n">WBSD_DAT3_H</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WBSD_FIGNORE_DETECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup</span> <span class="o">&amp;</span> <span class="n">WBSD_DAT3_H</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">setup</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_DAT3_H</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We cannot resume card detection immediately</span>
<span class="cm">			 * because of capacitance and delays in the chip.</span>
<span class="cm">			 */</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ignore_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_SETUP</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store bus width for later. Will be used when</span>
<span class="cm">	 * setting up the data transfer.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">csr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">WBSD_MSLED</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_MSLED</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">WBSD_WRPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">wbsd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">wbsd_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">wbsd_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">wbsd_get_ro</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Interrupt handling                                                        *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Helper function to reset detection ignore</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_reset_ignore</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Resetting card detection ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_FIGNORE_DETECT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Card status might have changed during the</span>
<span class="cm">	 * blackout.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tasklets</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="nf">wbsd_get_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_tasklet_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">csr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WBSD_FIGNORE_DETECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_CSR</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">csr</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">WBSD_CARDPRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WBSD_FCARD_PRESENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Card inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WBSD_FCARD_PRESENT</span><span class="p">;</span>

			<span class="n">delay</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WBSD_FCARD_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Card removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBSD_FCARD_PRESENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Card removed during transfer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">wbsd_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unlock first since we might get a call back.</span>
<span class="cm">	 */</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_tasklet_fifo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">wbsd_get_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
		<span class="n">wbsd_fill_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wbsd_empty_fifo</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Done?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">num_sg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbsd_write_index</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_IDX_FIFOEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_tasklet_crc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">wbsd_get_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_tasklet_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">wbsd_get_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_tasklet_finish</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">wbsd_get_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="n">wbsd_finish_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

<span class="nl">end:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wbsd_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">WBSD_ISR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Was it actually our hardware that caused the interrupt?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">isr</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">|=</span> <span class="n">isr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Schedule tasklets as needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_CARD</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_FIFO_THRE</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_CRC</span><span class="p">)</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">crc_tasklet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_TIMEOUT</span><span class="p">)</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_tasklet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">WBSD_INT_TC</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Device initialisation and shutdown                                        *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate/free MMC structure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_alloc_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate MMC structure.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set host parameters.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wbsd_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="mi">375000</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="mi">24000000</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up timers</span>
<span class="cm">	 */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ignore_timer</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ignore_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ignore_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">wbsd_reset_ignore</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum number of segments. Worst case is one sector per segment</span>
<span class="cm">	 * so this will be 64kB/512.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum request size. Also limited by 64KiB buffer.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum segment size. Could be one segment with the maximum number</span>
<span class="cm">	 * of bytes.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum block size. We have 12 bits (= 4095) but have to subtract</span>
<span class="cm">	 * space for CRC. So the maximum is 4095 - 4*2 = 4087.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">4087</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum block count. There is no real limit so the maximum</span>
<span class="cm">	 * request size will be the only restriction.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_free_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ignore_timer</span><span class="p">);</span>

	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scan for known chip id:s</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Iterate through all ports, all codes to</span>
<span class="cm">	 * find hardware that is in our known list.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">config_ports</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unlock_codes</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">unlock_code</span> <span class="o">=</span> <span class="n">unlock_codes</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="n">wbsd_unlock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

			<span class="n">outb</span><span class="p">(</span><span class="n">WBSD_CONF_ID_HI</span><span class="p">,</span> <span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">outb</span><span class="p">(</span><span class="n">WBSD_CONF_ID_LO</span><span class="p">,</span> <span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">wbsd_lock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_ids</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">valid_ids</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Unknown hardware (id %x) found at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">id</span><span class="p">,</span> <span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">release_region</span><span class="p">(</span><span class="n">config_ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">unlock_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate/free io port ranges</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_request_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_release_regions</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate/free DMA port and buffer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">wbsd_request_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to allocate a special buffer in</span>
<span class="cm">	 * order for ISA to be able to DMA to it.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">WBSD_DMA_SIZE</span><span class="p">,</span>
		<span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_REPEAT</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Translate the address to a physical address.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">,</span>
		<span class="n">WBSD_DMA_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ISA DMA must be aligned on a 64k basis.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">kfree</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * ISA cannot access memory above 16 MB.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">&gt;=</span> <span class="mh">0x1000000</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">kfree</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">kfree:</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;ve gotten here then there is some kind of alignment bug</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
		<span class="n">WBSD_DMA_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">free:</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Unable to allocate DMA %d. &quot;</span>
		<span class="s">&quot;Falling back on FIFO.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_release_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="n">WBSD_DMA_SIZE</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate/free IRQ.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up tasklets. Must be done before requesting interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">,</span> <span class="n">wbsd_tasklet_card</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">,</span> <span class="n">wbsd_tasklet_fifo</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">crc_tasklet</span><span class="p">,</span> <span class="n">wbsd_tasklet_crc</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_tasklet</span><span class="p">,</span> <span class="n">wbsd_tasklet_timeout</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">,</span> <span class="n">wbsd_tasklet_finish</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">wbsd_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">wbsd_release_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fifo_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">crc_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate all resources for the host.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_request_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate I/O ports.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_request_region</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_request_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate DMA.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_request_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release all resources for the host.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbsd_release_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">wbsd_release_irq</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">wbsd_release_regions</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the resources the chip should use.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_chip_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbsd_unlock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_SWRST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_SWRST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select SD/MMC function.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_DEVICE</span><span class="p">,</span> <span class="n">DEVICE_SD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up card detection.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PINS</span><span class="p">,</span> <span class="n">WBSD_PINS_DETECT_GP11</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure chip</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PORT_HI</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PORT_LO</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_IRQ</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_DRQ</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable and power up chip.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_POWER</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">wbsd_lock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check that configured resources are correct.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_chip_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">wbsd_unlock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select SD/MMC function.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_DEVICE</span><span class="p">,</span> <span class="n">DEVICE_SD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read configuration.</span>
<span class="cm">	 */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">wbsd_read_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PORT_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">|=</span> <span class="n">wbsd_read_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PORT_LO</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">wbsd_read_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_IRQ</span><span class="p">);</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">wbsd_read_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_DRQ</span><span class="p">);</span>

	<span class="n">wbsd_lock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate against given configuration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Powers down the SD function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wbsd_chip_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbsd_unlock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_DEVICE</span><span class="p">,</span> <span class="n">DEVICE_SD</span><span class="p">);</span>
	<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wbsd_lock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Devices setup and shutdown                                                *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">pnp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_alloc_mmc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan for hardware.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_scan</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="n">DRIVER_NAME</span>
				<span class="s">&quot;: Unable to confirm device presence. You may &quot;</span>
				<span class="s">&quot;experience lock-ups.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wbsd_free_mmc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Request resources.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_request_resources</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbsd_release_resources</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">wbsd_free_mmc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if chip needs to be configured.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wbsd_chip_validate</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="n">DRIVER_NAME</span>
				<span class="s">&quot;: PnP active but chip not configured! &quot;</span>
				<span class="s">&quot;You probably have a buggy BIOS. &quot;</span>
				<span class="s">&quot;Configuring chip manually.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wbsd_chip_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wbsd_chip_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power Management stuff. No idea how this works.</span>
<span class="cm">	 * Not tested.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wbsd_unlock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">wbsd_write_config</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">WBSD_CONF_PME</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">);</span>
		<span class="n">wbsd_lock_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allow device to initialise itself properly.</span>
<span class="cm">	 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip into a known state.</span>
<span class="cm">	 */</span>
	<span class="n">wbsd_init_device</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: W83L51xD&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; id %x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; at 0x%x irq %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dma %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; FIFO&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; PnP&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">wbsd_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pnp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Power down the SD/MMC function.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp</span><span class="p">)</span>
		<span class="n">wbsd_chip_poweroff</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">wbsd_release_resources</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">wbsd_free_mmc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Non-PnP</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wbsd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Use the module parameters for resources */</span>
	<span class="k">return</span> <span class="n">wbsd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">param_io</span><span class="p">,</span> <span class="n">param_irq</span><span class="p">,</span> <span class="n">param_dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">wbsd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbsd_shutdown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PnP</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">wbsd_pnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnpdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get resources from PnP layer.</span>
<span class="cm">	 */</span>
	<span class="n">io</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pnpdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pnpdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_dma_valid</span><span class="p">(</span><span class="n">pnpdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">pnpdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;PnP resources: port %3x irq %d dma %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wbsd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnpdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">wbsd_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wbsd_shutdown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Power management</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">wbsd_init_device</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_platform_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;Suspending...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wbsd_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wbsd_chip_poweroff</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_platform_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;Resuming...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">wbsd_chip_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow device to initialise itself properly.</span>
<span class="cm">	 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wbsd_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_pnp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;Suspending...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wbsd_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wbsd_pnp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pnp_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pnp_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wbsd_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGF</span><span class="p">(</span><span class="s">&quot;Resuming...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if chip needs to be configured.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wbsd_chip_validate</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="n">DRIVER_NAME</span>
				<span class="s">&quot;: PnP active but chip not configured! &quot;</span>
				<span class="s">&quot;You probably have a buggy BIOS. &quot;</span>
				<span class="s">&quot;Configuring chip manually.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">wbsd_chip_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow device to initialise itself properly.</span>
<span class="cm">	 */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wbsd_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define wbsd_platform_suspend NULL</span>
<span class="cp">#define wbsd_platform_resume NULL</span>

<span class="cp">#define wbsd_pnp_suspend NULL</span>
<span class="cp">#define wbsd_pnp_resume NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">wbsd_device</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">wbsd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wbsd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">wbsd_remove</span><span class="p">),</span>

	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">wbsd_platform_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">wbsd_platform_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">wbsd_pnp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pnp_dev_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wbsd_pnp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">wbsd_pnp_remove</span><span class="p">),</span>

	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">wbsd_pnp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">wbsd_pnp_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Module loading/unloading</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wbsd_drv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span>
		<span class="s">&quot;: Winbond W83L51xD SD/MMC card interface driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Copyright(c) Pierre Ossman</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PNP</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param_nopnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_pnp_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_nopnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

		<span class="n">wbsd_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wbsd_device</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_driver</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">wbsd_device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">platform_device_put</span><span class="p">(</span><span class="n">wbsd_device</span><span class="p">);</span>
			<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_driver</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wbsd_drv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PNP</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param_nopnp</span><span class="p">)</span>
		<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_pnp_driver</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_nopnp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">wbsd_device</span><span class="p">);</span>

		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wbsd_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">wbsd_drv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wbsd_drv_exit</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nopnp</span><span class="p">,</span> <span class="n">param_nopnp</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">param_io</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">param_irq</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">param_dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pierre Ossman &lt;pierre@ossman.eu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Winbond W83L51xD SD/MMC card interface driver&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nopnp</span><span class="p">,</span> <span class="s">&quot;Scan for device instead of relying on PNP. (default 0)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;I/O base to allocate. Must be 8 byte aligned. (default 0x248)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ to allocate. (default 6)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;DMA channel to allocate. -1 for no DMA. (default 2)&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
