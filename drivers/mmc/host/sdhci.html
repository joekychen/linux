<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › sdhci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sdhci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mmc/host/sdhci.c - Secure Digital Host Controller Interface driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005-2008 Pierre Ossman, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to the following companies for their support:</span>
<span class="cm"> *</span>
<span class="cm"> *     - JMicron (hardware and technical support)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;linux/leds.h&gt;</span>

<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>

<span class="cp">#include &quot;sdhci.h&quot;</span>

<span class="cp">#define DRIVER_NAME &quot;sdhci&quot;</span>

<span class="cp">#define DBG(f, x...) \</span>
<span class="cp">	pr_debug(DRIVER_NAME &quot; [%s()]: &quot; f, __func__,## x)</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || (defined(CONFIG_LEDS_CLASS_MODULE) &amp;&amp; \</span>
<span class="cp">	defined(CONFIG_MMC_SDHCI_MODULE))</span>
<span class="cp">#define SDHCI_USE_LEDS_CLASS</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_TUNING_LOOP 40</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug_quirks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug_quirks2</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sdhci_finish_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sdhci_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sdhci_finish_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdhci_execute_tuning</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">opcode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sdhci_tuning_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sdhci_runtime_pm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sdhci_runtime_pm_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_dumpregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: =========== REGISTER DUMP (%s)===========</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Sys addr: 0x%08x | Version:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_DMA_ADDRESS</span><span class="p">),</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_VERSION</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Blk size: 0x%08x | Blk cnt:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_BLOCK_SIZE</span><span class="p">),</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_BLOCK_COUNT</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Argument: 0x%08x | Trn mode: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_ARGUMENT</span><span class="p">),</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_TRANSFER_MODE</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Present:  0x%08x | Host ctl: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">),</span>
		<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Power:    0x%08x | Blk gap:  0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">),</span>
		<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_BLOCK_GAP_CONTROL</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Wake-up:  0x%08x | Clock:    0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_WAKE_UP_CONTROL</span><span class="p">),</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Timeout:  0x%08x | Int stat: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_TIMEOUT_CONTROL</span><span class="p">),</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Int enab: 0x%08x | Sig enab: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ENABLE</span><span class="p">),</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_SIGNAL_ENABLE</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: AC12 err: 0x%08x | Slot int: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_ACMD12_ERR</span><span class="p">),</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_SLOT_INT_STATUS</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Caps:     0x%08x | Caps_1:   0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CAPABILITIES</span><span class="p">),</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CAPABILITIES_1</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Cmd:      0x%08x | Max curr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_COMMAND</span><span class="p">),</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAX_CURRENT</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Host ctl2: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: ADMA Err: 0x%08x | ADMA Ptr: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SDHCI_ADMA_ERROR</span><span class="p">),</span>
		       <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SDHCI_ADMA_ADDRESS</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: ===========================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Low level functions                                                       *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_clear_set_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clear</span><span class="p">,</span> <span class="n">u32</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ier</span><span class="p">;</span>

	<span class="n">ier</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ENABLE</span><span class="p">);</span>
	<span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clear</span><span class="p">;</span>
	<span class="n">ier</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ier</span><span class="p">,</span> <span class="n">SDHCI_INT_ENABLE</span><span class="p">);</span>
	<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ier</span><span class="p">,</span> <span class="n">SDHCI_SIGNAL_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_unmask_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irqs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_mask_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_card_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">present</span><span class="p">,</span> <span class="n">irqs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_CARD_DETECTION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_NONREMOVABLE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">present</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">SDHCI_CARD_PRESENT</span><span class="p">;</span>
	<span class="n">irqs</span> <span class="o">=</span> <span class="n">present</span> <span class="o">?</span> <span class="n">SDHCI_INT_CARD_REMOVE</span> <span class="o">:</span> <span class="n">SDHCI_INT_CARD_INSERT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">sdhci_unmask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irqs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdhci_mask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irqs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_enable_card_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdhci_set_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_disable_card_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdhci_set_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">ier</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_CARD_NO_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">SDHCI_CARD_PRESENT</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_RESTORE_IRQS_AFTER_RESET</span><span class="p">)</span>
		<span class="n">ier</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_reset_enter</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_reset_enter</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">SDHCI_SOFTWARE_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Wait max 100 ms */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* hw clears the bit when it&#39;s done */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_SOFTWARE_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Reset 0x%x never completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_reset_exit</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_reset_exit</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_RESTORE_IRQS_AFTER_RESET</span><span class="p">)</span>
		<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ALL_MASK</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">))</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sdhci_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">soft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">soft</span><span class="p">)</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_CMD</span><span class="o">|</span><span class="n">SDHCI_RESET_DATA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">);</span>

	<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ALL_MASK</span><span class="p">,</span>
		<span class="n">SDHCI_INT_BUS_POWER</span> <span class="o">|</span> <span class="n">SDHCI_INT_DATA_END_BIT</span> <span class="o">|</span>
		<span class="n">SDHCI_INT_DATA_CRC</span> <span class="o">|</span> <span class="n">SDHCI_INT_DATA_TIMEOUT</span> <span class="o">|</span> <span class="n">SDHCI_INT_INDEX</span> <span class="o">|</span>
		<span class="n">SDHCI_INT_END_BIT</span> <span class="o">|</span> <span class="n">SDHCI_INT_CRC</span> <span class="o">|</span> <span class="n">SDHCI_INT_TIMEOUT</span> <span class="o">|</span>
		<span class="n">SDHCI_INT_DATA_END</span> <span class="o">|</span> <span class="n">SDHCI_INT_RESPONSE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soft</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* force clock reconfiguration */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdhci_set_ios</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdhci_init</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sdhci_enable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_activate_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_LED</span><span class="p">;</span>
	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_deactivate_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_LED</span><span class="p">;</span>
	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef SDHCI_USE_LEDS_CLASS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_led_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdhci_host</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">runtime_suspended</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">==</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="n">sdhci_deactivate_led</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdhci_activate_led</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Core functions                                                            *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_read_block_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PIO reading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">blksize</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_miter_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>

		<span class="n">blksize</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">consumed</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scratch</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_BUFFER</span><span class="p">);</span>
				<span class="n">chunk</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">scratch</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">scratch</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">chunk</span><span class="o">--</span><span class="p">;</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sg_miter_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_write_block_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">chunk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scratch</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PIO writing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">blksize</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="n">chunk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">blksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_miter_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">))</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">blksize</span><span class="p">);</span>

		<span class="n">blksize</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">consumed</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scratch</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">chunk</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">chunk</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">blksize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">scratch</span><span class="p">,</span> <span class="n">SDHCI_BUFFER</span><span class="p">);</span>
				<span class="n">chunk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">scratch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sg_miter_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_transfer_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">SDHCI_DATA_AVAILABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">SDHCI_SPACE_AVAILABLE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some controllers (JMicron JMB38x) mess up the buffer bits</span>
<span class="cm">	 * for transfers &lt; 4 bytes. As long as it is just one block,</span>
<span class="cm">	 * we can ignore the bits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_SMALL_PIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_PIO_NEEDS_DELAY</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">sdhci_read_block_pio</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sdhci_write_block_pio</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;PIO transfer complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sdhci_kmap_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_kunmap_atomic</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="o">*</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_adma_desc</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">dataddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)(</span><span class="n">desc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">cmdlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* SDHCI specification says ADMA descriptors should be 4 byte</span>
<span class="cm">	 * aligned, so using 16 or 32bit operations should be safe. */</span>

	<span class="n">cmdlen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">cmdlen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">dataddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_adma_table_pre</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>

	<span class="n">u8</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">align</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">align_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The spec does not specify endianness of descriptor table.</span>
<span class="cm">	 * We currently guess that it is LE.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ADMA descriptor table is mapped further down as we</span>
<span class="cm">	 * need to fill it with data first.</span>
<span class="cm">	 */</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">,</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap_align</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">;</span>
	<span class="n">align</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">;</span>

	<span class="n">align_addr</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The SDHCI specification states that ADMA</span>
<span class="cm">		 * addresses must be 32-bit aligned. If they</span>
<span class="cm">		 * aren&#39;t, then we use a bounce buffer for</span>
<span class="cm">		 * the (up to three) bytes that screw up the</span>
<span class="cm">		 * alignment.</span>
<span class="cm">		 */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span> <span class="o">=</span> <span class="n">sdhci_kmap_atomic</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">WARN_ON</span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buffer</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">3</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">align</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">sdhci_kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* tran, valid */</span>
			<span class="n">sdhci_set_adma_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">align_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>

			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">);</span>

			<span class="n">align</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">align_addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">desc</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">);</span>

		<span class="cm">/* tran, valid */</span>
		<span class="n">sdhci_set_adma_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
		<span class="n">desc</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this triggers then we have a calculation bug</span>
<span class="cm">		 * somewhere. :/</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">((</span><span class="n">desc</span> <span class="o">-</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* Mark the last descriptor as the terminating descriptor</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">!=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* end */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* Add a terminating entry.</span>
<span class="cm">		*/</span>

		<span class="cm">/* nop, end, valid */</span>
		<span class="n">sdhci_set_adma_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Resync align buffer as we might have changed it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">,</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unmap_entries</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_addr</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unmap_entries:</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="nl">unmap_align:</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">,</span>
		<span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_adma_table_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">align</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_addr</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">,</span>
		<span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

		<span class="n">align</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">;</span>

		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

				<span class="n">buffer</span> <span class="o">=</span> <span class="n">sdhci_kmap_atomic</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">WARN_ON</span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buffer</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">3</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">sdhci_kunmap_atomic</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

				<span class="n">align</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sdhci_calc_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">target_timeout</span><span class="p">,</span> <span class="n">current_timeout</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the host controller provides us with an incorrect timeout</span>
<span class="cm">	 * value, just skip the check and use 0xE.  The hardware may take</span>
<span class="cm">	 * longer to time out, but that&#39;s much better than having a too-short</span>
<span class="cm">	 * timeout value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_TIMEOUT_VAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xE</span><span class="p">;</span>

	<span class="cm">/* Unspecified timeout, assume max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_timeout_ms</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xE</span><span class="p">;</span>

	<span class="cm">/* timeout in us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="n">target_timeout</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_timeout_ms</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">target_timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
			<span class="n">target_timeout</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out needed cycles.</span>
<span class="cm">	 * We do this in steps in order to fit inside a 32 bit int.</span>
<span class="cm">	 * The first step is the minimum timeout, which will have a</span>
<span class="cm">	 * minimum resolution of 6 bits:</span>
<span class="cm">	 * (1) 2^13*1000 &gt; 2^22,</span>
<span class="cm">	 * (2) host-&gt;timeout_clk &lt; 2^16</span>
<span class="cm">	 *     =&gt;</span>
<span class="cm">	 *     (1) / (2) &gt; 2^6</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">current_timeout</span> <span class="o">&lt;</span> <span class="n">target_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">current_timeout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mh">0xF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Too large timeout 0x%x requested for CMD%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">count</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_transfer_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pio_irqs</span> <span class="o">=</span> <span class="n">SDHCI_INT_DATA_AVAIL</span> <span class="o">|</span> <span class="n">SDHCI_INT_SPACE_AVAIL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_irqs</span> <span class="o">=</span> <span class="n">SDHCI_INT_DMA_END</span> <span class="o">|</span> <span class="n">SDHCI_INT_ADMA_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span>
		<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pio_irqs</span><span class="p">,</span> <span class="n">dma_irqs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dma_irqs</span><span class="p">,</span> <span class="n">pio_irqs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sdhci_calc_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">SDHCI_TIMEOUT_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">524288</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_early</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: This doesn&#39;t account for merging when mapping the</span>
<span class="cm">	 * scatterlist.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">broken</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="n">broken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_32BIT_ADMA_SIZE</span><span class="p">)</span>
				<span class="n">broken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_32BIT_DMA_SIZE</span><span class="p">)</span>
				<span class="n">broken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">broken</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Reverting to PIO because of &quot;</span>
						<span class="s">&quot;transfer size (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_REQ_USE_DMA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The assumption here being that alignment is the same after</span>
<span class="cm">	 * translation to device address space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">broken</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="n">broken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * As we use 3 byte chunks to work around</span>
<span class="cm">			 * alignment problems, we need to check this</span>
<span class="cm">			 * quirk.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_32BIT_ADMA_SIZE</span><span class="p">)</span>
				<span class="n">broken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_32BIT_DMA_ADDR</span><span class="p">)</span>
				<span class="n">broken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">broken</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">for_each_sg</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Reverting to PIO because of &quot;</span>
						<span class="s">&quot;bad alignment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_REQ_USE_DMA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_adma_table_pre</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This only happens when someone fed</span>
<span class="cm">				 * us an invalid request.</span>
<span class="cm">				 */</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_REQ_USE_DMA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_addr</span><span class="p">,</span>
					<span class="n">SDHCI_ADMA_ADDRESS</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">sg_cnt</span><span class="p">;</span>

			<span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
					<span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">DMA_FROM_DEVICE</span> <span class="o">:</span>
						<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This only happens when someone fed</span>
<span class="cm">				 * us an invalid request.</span>
<span class="cm">				 */</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_REQ_USE_DMA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sg_cnt</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">),</span>
					<span class="n">SDHCI_DMA_ADDRESS</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always adjust the DMA selection as some controllers</span>
<span class="cm">	 * (e.g. JMicron) can&#39;t do PIO properly when the selection</span>
<span class="cm">	 * is ADMA.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_DMA_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_ADMA32</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_SDMA</span><span class="p">;</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">SG_MITER_ATOMIC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SG_MITER_TO_SG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SG_MITER_FROM_SG</span><span class="p">;</span>
		<span class="n">sg_miter_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_miter</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdhci_set_transfer_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Set the DMA boundary value and block size */</span>
	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAKE_BLKSZ</span><span class="p">(</span><span class="n">SDHCI_DEFAULT_BOUNDARY_ARG</span><span class="p">,</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">),</span> <span class="n">SDHCI_BLOCK_SIZE</span><span class="p">);</span>
	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="n">SDHCI_BLOCK_COUNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_transfer_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">SDHCI_TRNS_BLK_CNT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_op_multi</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">SDHCI_TRNS_MULTI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we are sending CMD23, CMD12 never gets sent</span>
<span class="cm">		 * on successful completion (so no Auto-CMD12).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_AUTO_CMD12</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">SDHCI_TRNS_AUTO_CMD12</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_AUTO_CMD23</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">SDHCI_TRNS_AUTO_CMD23</span><span class="p">;</span>
			<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">SDHCI_ARGUMENT2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">SDHCI_TRNS_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">SDHCI_TRNS_DMA</span><span class="p">;</span>

	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">SDHCI_TRANSFER_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_finish_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_REQ_USE_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span>
			<span class="n">sdhci_adma_table_post</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_READ</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">DMA_FROM_DEVICE</span> <span class="o">:</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The specification states that the block count register must</span>
<span class="cm">	 * be updated, but it does not specify at what point in the</span>
<span class="cm">	 * data flow. That makes the register entirely useless to read</span>
<span class="cm">	 * back so we have to assume that nothing made it to the card</span>
<span class="cm">	 * in the event of an error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to send CMD12 if -</span>
<span class="cm">	 * a) open-ended multiblock transfer (no CMD23)</span>
<span class="cm">	 * b) error in multiblock transfer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">||</span>
	     <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * The controller needs a reset of internal state machines</span>
<span class="cm">		 * upon error conditions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_CMD</span><span class="p">);</span>
			<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_DATA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sdhci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Wait max 10 ms */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">SDHCI_CMD_INHIBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDHCI_DATA_INHIBIT</span><span class="p">;</span>

	<span class="cm">/* We shouldn&#39;t wait for data inihibit for stop commands, even</span>
<span class="cm">	   though they might use busy signaling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_DATA_INHIBIT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Controller never released &quot;</span>
				<span class="s">&quot;inhibit bit(s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">sdhci_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">SDHCI_ARGUMENT</span><span class="p">);</span>

	<span class="n">sdhci_set_transfer_mode</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unsupported response type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">SDHCI_CMD_RESP_NONE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">SDHCI_CMD_RESP_LONG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">SDHCI_CMD_RESP_SHORT_BUSY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">SDHCI_CMD_RESP_SHORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_CRC</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_CMD_CRC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_OPCODE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_CMD_INDEX</span><span class="p">;</span>

	<span class="cm">/* CMD19 is special in that the Data Present Select should be set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">MMC_SEND_TUNING_BLOCK</span> <span class="o">||</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">MMC_SEND_TUNING_BLOCK_HS200</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_CMD_DATA</span><span class="p">;</span>

	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAKE_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span> <span class="n">SDHCI_COMMAND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_finish_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CRC is stripped so we need to do some shifting. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
					<span class="n">SDHCI_RESPONSE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span>
						<span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
						<span class="n">SDHCI_RESPONSE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESPONSE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Finished CMD23, now send actual command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sdhci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Processed actual command. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data_early</span><span class="p">)</span>
			<span class="n">sdhci_finish_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Initialized for compiler warning */</span>
	<span class="kt">int</span> <span class="n">real_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">,</span> <span class="n">clk_mul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&amp;&amp;</span> <span class="n">clock</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">actual_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NONSTANDARD_CLOCK</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if the Host Controller supports Programmable Clock</span>
<span class="cm">		 * Mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * We need to figure out whether the Host Driver needs</span>
<span class="cm">			 * to select Programmable Clock Mode, or the value can</span>
<span class="cm">			 * be set automatically by the Host Controller based on</span>
<span class="cm">			 * the Preset Value registers.</span>
<span class="cm">			 */</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;=</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">div</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">*</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">)</span> <span class="o">/</span>
					      <span class="n">div</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * Set Programmable Clock Mode in the Clock</span>
<span class="cm">				 * Control register.</span>
<span class="cm">				 */</span>
				<span class="n">clk</span> <span class="o">=</span> <span class="n">SDHCI_PROG_CLOCK_MODE</span><span class="p">;</span>
				<span class="n">real_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
				<span class="n">clk_mul</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">;</span>
				<span class="n">div</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Version 3.00 divisors must be a multiple of 2. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span>
				<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;</span> <span class="n">SDHCI_MAX_DIV_SPEC_300</span><span class="p">;</span>
				     <span class="n">div</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">real_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Version 2.00 divisors must be a power of 2. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;</span> <span class="n">SDHCI_MAX_DIV_SPEC_200</span><span class="p">;</span> <span class="n">div</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">/</span> <span class="n">div</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">real_div</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">div</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">real_div</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">actual_clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">*</span> <span class="n">clk_mul</span><span class="p">)</span> <span class="o">/</span> <span class="n">real_div</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">|=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&amp;</span> <span class="n">SDHCI_DIV_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDHCI_DIVIDER_SHIFT</span><span class="p">;</span>
	<span class="n">clk</span> <span class="o">|=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="n">SDHCI_DIV_HI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SDHCI_DIV_MASK_LEN</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="n">SDHCI_DIVIDER_HI_SHIFT</span><span class="p">;</span>
	<span class="n">clk</span> <span class="o">|=</span> <span class="n">SDHCI_CLOCK_INT_EN</span><span class="p">;</span>
	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Wait max 20 ms */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">clk</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">))</span>
		<span class="o">&amp;</span> <span class="n">SDHCI_CLOCK_INT_STABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Internal clock never &quot;</span>
				<span class="s">&quot;stabilised.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clk</span> <span class="o">|=</span> <span class="n">SDHCI_CLOCK_CARD_EN</span><span class="p">;</span>
	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">power</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MMC_VDD_165_195</span>:
			<span class="n">pwr</span> <span class="o">=</span> <span class="n">SDHCI_POWER_180</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_VDD_29_30</span>:
		<span class="k">case</span> <span class="n">MMC_VDD_30_31</span>:
			<span class="n">pwr</span> <span class="o">=</span> <span class="n">SDHCI_POWER_300</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_VDD_32_33</span>:
		<span class="k">case</span> <span class="n">MMC_VDD_33_34</span>:
			<span class="n">pwr</span> <span class="o">=</span> <span class="n">SDHCI_POWER_330</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pwr</span> <span class="o">==</span> <span class="n">pwr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pwr</span> <span class="o">=</span> <span class="n">pwr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Spec says that we should clear the power reg before setting</span>
<span class="cm">	 * a new value. Some controllers don&#39;t seem to like this though.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_SINGLE_POWER_WRITE</span><span class="p">))</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At least the Marvell CaFe chip gets confused if we set the voltage</span>
<span class="cm">	 * and set turn on power at the same time, so set the voltage first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_SIMULT_VDD_AND_POWER</span><span class="p">)</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>

	<span class="n">pwr</span> <span class="o">|=</span> <span class="n">SDHCI_POWER_ON</span><span class="p">;</span>

	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some controllers need an extra 10ms delay of 10ms before they</span>
<span class="cm">	 * can apply clock after applying power</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_DELAY_AFTER_POWER</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">power</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * MMC callbacks                                                             *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">present</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifndef SDHCI_USE_LEDS_CLASS</span>
	<span class="n">sdhci_activate_led</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure we don&#39;t send the STOP for non-SET_BLOCK_COUNTED</span>
<span class="cm">	 * requests if Auto-CMD12 is enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_AUTO_CMD12</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>

	<span class="cm">/* If polling, assume that the card is always present. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_CARD_DETECTION</span><span class="p">)</span>
		<span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">present</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">SDHCI_CARD_PRESENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">present</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">present_state</span><span class="p">;</span>

		<span class="n">present_state</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if the re-tuning timer has already expired and there</span>
<span class="cm">		 * is no on-going data transfer. If so, we need to execute</span>
<span class="cm">		 * tuning procedure before sending command.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">present_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_DOING_WRITE</span> <span class="o">|</span> <span class="n">SDHCI_DOING_READ</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sdhci_execute_tuning</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* Restore original mmc_request structure */</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">mrq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_AUTO_CMD23</span><span class="p">))</span>
			<span class="n">sdhci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sdhci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_do_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vdd_bit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span> <span class="o">&amp;&amp;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span>
			<span class="n">mmc_regulator_set_ocr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the chip on each power off.</span>
<span class="cm">	 * Should clear out any weird states.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SDHCI_SIGNAL_ENABLE</span><span class="p">);</span>
		<span class="n">sdhci_reinit</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sdhci_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_OFF</span><span class="p">)</span>
		<span class="n">vdd_bit</span> <span class="o">=</span> <span class="n">sdhci_set_power</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vdd_bit</span> <span class="o">=</span> <span class="n">sdhci_set_power</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span> <span class="o">&amp;&amp;</span> <span class="n">vdd_bit</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mmc_regulator_set_ocr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">,</span> <span class="n">vdd_bit</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_send_init_74_clocks</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_send_init_74_clocks</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If your platform has 8-bit width support but is not a v3 controller,</span>
<span class="cm">	 * or if it requires special setup code, you should implement that in</span>
<span class="cm">	 * platform_8bit_width().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_8bit_width</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_8bit_width</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
				<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_8BITBUS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
				<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_8BITBUS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span>
				<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_SD_HS</span> <span class="o">||</span>
	     <span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_MMC_HS</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_HISPD_BIT</span><span class="p">))</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_HISPD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_HISPD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">clk</span><span class="p">,</span> <span class="n">ctrl_2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>

		<span class="cm">/* In case of UHS-I modes, set High Speed Enable */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_MMC_HS200</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR50</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR104</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_DDR50</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR25</span><span class="p">))</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_HISPD</span><span class="p">;</span>

		<span class="n">ctrl_2</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl_2</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We only need to set Driver Strength if the</span>
<span class="cm">			 * preset value enable is not set.</span>
<span class="cm">			 */</span>
			<span class="n">ctrl_2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_DRV_TYPE_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">drv_type</span> <span class="o">==</span> <span class="n">MMC_SET_DRIVER_TYPE_A</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_DRV_TYPE_A</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">drv_type</span> <span class="o">==</span> <span class="n">MMC_SET_DRIVER_TYPE_C</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_DRV_TYPE_C</span><span class="p">;</span>

			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl_2</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * According to SDHC Spec v3.00, if the Preset Value</span>
<span class="cm">			 * Enable in the Host Control 2 register is set, we</span>
<span class="cm">			 * need to reset SD Clock Enable before changing High</span>
<span class="cm">			 * Speed Enable to avoid generating clock gliches.</span>
<span class="cm">			 */</span>

			<span class="cm">/* Reset SD Clock Enable */</span>
			<span class="n">clk</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>
			<span class="n">clk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CLOCK_CARD_EN</span><span class="p">;</span>
			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

			<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>

			<span class="cm">/* Re-enable SD Clock */</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sdhci_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="cm">/* Reset SD Clock Enable */</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>
		<span class="n">clk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CLOCK_CARD_EN</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_uhs_signaling</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_uhs_signaling</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ctrl_2</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
			<span class="cm">/* Select Bus Speed Mode for host */</span>
			<span class="n">ctrl_2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_UHS_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_MMC_HS200</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_HS_SDR200</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR12</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_UHS_SDR12</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR25</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_UHS_SDR25</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR50</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_UHS_SDR50</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_SDR104</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_UHS_SDR104</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">timing</span> <span class="o">==</span> <span class="n">MMC_TIMING_UHS_DDR50</span><span class="p">)</span>
				<span class="n">ctrl_2</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_UHS_DDR50</span><span class="p">;</span>
			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl_2</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Re-enable SD Clock */</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdhci_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some (ENE) controllers go apeshit on some ios operation,</span>
<span class="cm">	 * signalling timeout and CRC errors even on CMD0. Resetting</span>
<span class="cm">	 * it on each ios seems to solve the problem.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_RESET_CMD_DATA_ON_IOS</span><span class="p">)</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_CMD</span> <span class="o">|</span> <span class="n">SDHCI_RESET_DATA</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">sdhci_do_set_ios</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_check_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_readonly</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">)</span>
		<span class="n">is_readonly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_ro</span><span class="p">)</span>
		<span class="n">is_readonly</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_ro</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">is_readonly</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">SDHCI_WRITE_PROTECT</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* This quirk needs to be replaced by a callback-function later */</span>
	<span class="k">return</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_INVERTED_WRITE_PROTECT</span> <span class="o">?</span>
		<span class="o">!</span><span class="n">is_readonly</span> <span class="o">:</span> <span class="n">is_readonly</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SAMPLE_COUNT	5</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_do_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ro_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_UNSTABLE_RO_DETECT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sdhci_check_ro</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ro_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SAMPLE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdhci_check_ro</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ro_count</span> <span class="o">&gt;</span> <span class="n">SAMPLE_COUNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_reset</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_get_ro</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_do_get_ro</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_enable_sdio_irq_nolock</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_SDIO_IRQ_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_SDIO_IRQ_ENABLED</span><span class="p">;</span>

	<span class="cm">/* SDIO IRQ will be enabled as appropriate in runtime resume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">runtime_suspended</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">sdhci_unmask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_CARD_INT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdhci_mask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_CARD_INT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_enable_sdio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sdhci_enable_sdio_irq_nolock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_do_start_signal_voltage_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pwr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clk</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">present_state</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Signal Voltage Switching is only applicable for Host Controllers</span>
<span class="cm">	 * v3.00 and above.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We first check whether the request is to set signalling voltage</span>
<span class="cm">	 * to 3.3V. If so, we change the voltage to 3.3V and return quickly.</span>
<span class="cm">	 */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">signal_voltage</span> <span class="o">==</span> <span class="n">MMC_SIGNAL_VOLTAGE_330</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set 1.8V Signal Enable in the Host Control2 register to 0 */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_VDD_180</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

		<span class="cm">/* Wait for 5ms */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">);</span>

		<span class="cm">/* 3.3V regulator output should be stable within 5 ms */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_VDD_180</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Switching to 3.3V &quot;</span>
				<span class="s">&quot;signalling voltage failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_VDD_180</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">signal_voltage</span> <span class="o">==</span> <span class="n">MMC_SIGNAL_VOLTAGE_180</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stop SDCLK */</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>
		<span class="n">clk</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CLOCK_CARD_EN</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>

		<span class="cm">/* Check whether DAT[3:0] is 0000 */</span>
		<span class="n">present_state</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">present_state</span> <span class="o">&amp;</span> <span class="n">SDHCI_DATA_LVL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		       <span class="n">SDHCI_DATA_LVL_SHIFT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable 1.8V Signal Enable in the Host Control2</span>
<span class="cm">			 * register</span>
<span class="cm">			 */</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_VDD_180</span><span class="p">;</span>
			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

			<span class="cm">/* Wait for 5ms */</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">);</span>

			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_VDD_180</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Provide SDCLK again and wait for 1ms*/</span>
				<span class="n">clk</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>
				<span class="n">clk</span> <span class="o">|=</span> <span class="n">SDHCI_CLOCK_CARD_EN</span><span class="p">;</span>
				<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span> <span class="n">SDHCI_CLOCK_CONTROL</span><span class="p">);</span>
				<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * If DAT[3:0] level is 1111b, then the card</span>
<span class="cm">				 * was successfully switched to 1.8V signaling.</span>
<span class="cm">				 */</span>
				<span class="n">present_state</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span>
							<span class="n">SDHCI_PRESENT_STATE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">present_state</span> <span class="o">&amp;</span> <span class="n">SDHCI_DATA_LVL_MASK</span><span class="p">)</span> <span class="o">==</span>
				     <span class="n">SDHCI_DATA_LVL_MASK</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we are here, that means the switch to 1.8V signaling</span>
<span class="cm">		 * failed. We power cycle the card, and retry initialization</span>
<span class="cm">		 * sequence by setting S18R to 0.</span>
<span class="cm">		 */</span>
		<span class="n">pwr</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>
		<span class="n">pwr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_POWER_ON</span><span class="p">;</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>

		<span class="cm">/* Wait for 1ms as per the spec */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span>
		<span class="n">pwr</span> <span class="o">|=</span> <span class="n">SDHCI_POWER_ON</span><span class="p">;</span>
		<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">SDHCI_POWER_CONTROL</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Switching to 1.8V signalling &quot;</span>
			<span class="s">&quot;voltage failed, retrying with S18R set to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* No signal voltage switch required */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_start_signal_voltage_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sdhci_do_start_signal_voltage_switch</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ios</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_execute_tuning</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ier</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tuning_loop_counter</span> <span class="o">=</span> <span class="n">MAX_TUNING_LOOP</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">requires_tuning_nonuhs</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Host Controller needs tuning only in case of SDR104 mode</span>
<span class="cm">	 * and for SDR50 mode when Use Tuning for SDR50 is set in the</span>
<span class="cm">	 * Capabilities register.</span>
<span class="cm">	 * If the Host Controller supports the HS200 mode then the</span>
<span class="cm">	 * tuning function has to be executed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_UHS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDHCI_CTRL_UHS_SDR50</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_SDR50_NEEDS_TUNING</span> <span class="o">||</span>
	     <span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_HS200_NEEDS_TUNING</span><span class="p">))</span>
		<span class="n">requires_tuning_nonuhs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_UHS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDHCI_CTRL_UHS_SDR104</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">requires_tuning_nonuhs</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_EXEC_TUNING</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As per the Host Controller spec v3.00, tuning command</span>
<span class="cm">	 * generates Buffer Read Ready interrupt, so enable that.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: The spec clearly says that when tuning sequence</span>
<span class="cm">	 * is being performed, the controller does not generate</span>
<span class="cm">	 * interrupts other than Buffer Read Ready interrupt. But</span>
<span class="cm">	 * to make sure we don&#39;t hit a controller bug, we _only_</span>
<span class="cm">	 * enable Buffer Read Ready interrupt here.</span>
<span class="cm">	 */</span>
	<span class="n">ier</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ENABLE</span><span class="p">);</span>
	<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ier</span><span class="p">,</span> <span class="n">SDHCI_INT_DATA_AVAIL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Issue CMD19 repeatedly till Execute Tuning is set to 0 or the number</span>
<span class="cm">	 * of loops reaches 40 times or a timeout of 150ms occurs.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tuning_loop_counter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * In response to CMD19, the card sends 64 bytes of tuning</span>
<span class="cm">		 * block to the Host Controller. So we set the block size</span>
<span class="cm">		 * to 64 here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">MMC_SEND_TUNING_BLOCK_HS200</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">.</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_8</span><span class="p">)</span>
				<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAKE_BLKSZ</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
					     <span class="n">SDHCI_BLOCK_SIZE</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">.</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span>
				<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAKE_BLKSZ</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
					     <span class="n">SDHCI_BLOCK_SIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAKE_BLKSZ</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
				     <span class="n">SDHCI_BLOCK_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The tuning block is sent by the card to the host controller.</span>
<span class="cm">		 * So we set the TRNS_READ bit in the Transfer Mode register.</span>
<span class="cm">		 * This also takes care of setting DMA Enable and Multi Block</span>
<span class="cm">		 * Select in the same register to 0.</span>
<span class="cm">		 */</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_TRNS_READ</span><span class="p">,</span> <span class="n">SDHCI_TRANSFER_MODE</span><span class="p">);</span>

		<span class="n">sdhci_send_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="cm">/* Wait for Buffer Read Ready interrupt */</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_ready_int</span><span class="p">,</span>
					<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Timeout waiting for &quot;</span>
				<span class="s">&quot;Buffer Read Ready interrupt during tuning &quot;</span>
				<span class="s">&quot;procedure, falling back to fixed sampling &quot;</span>
				<span class="s">&quot;clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_TUNED_CLK</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_EXEC_TUNING</span><span class="p">;</span>
			<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="n">tuning_loop_counter</span><span class="o">--</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_EXEC_TUNING</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Host Driver has exhausted the maximum number of loops allowed,</span>
<span class="cm">	 * so use fixed sampling frequency.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tuning_loop_counter</span> <span class="o">||</span> <span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_TUNED_CLK</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_TUNED_CLK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Tuning procedure&quot;</span>
				<span class="s">&quot; failed, falling back to fixed sampling&quot;</span>
				<span class="s">&quot; clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this is the very first time we are here, we start the retuning</span>
<span class="cm">	 * timer. Since only during the first time, SDHCI_NEEDS_RETUNING</span>
<span class="cm">	 * flag won&#39;t be set, we check this condition before actually starting</span>
<span class="cm">	 * the timer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="cm">/* Tuning mode 1 limits the maximum data length to 4MB */</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>
		<span class="cm">/* Reload the new initial value for timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">)</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case tuning fails, host controllers which support re-tuning can</span>
<span class="cm">	 * try tuning again at a later time, when the re-tuning timer expires.</span>
<span class="cm">	 * So for these controllers, we return 0. Since there might be other</span>
<span class="cm">	 * controllers who do not have this capability, we return error for</span>
<span class="cm">	 * them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">&amp;&amp;</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdhci_clear_set_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_DATA_AVAIL</span><span class="p">,</span> <span class="n">ier</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_do_enable_preset_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Host Controller v3.00 defines preset value registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only enable or disable Preset Value if they are not already</span>
<span class="cm">	 * enabled or disabled respectively. Otherwise, we bail out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_PV_ENABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_PRESET_VAL_ENABLE</span><span class="p">;</span>
		<span class="n">sdhci_writew</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL2</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_PV_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_enable_preset_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">sdhci_runtime_pm_get</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">sdhci_do_enable_preset_value</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">sdhci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">sdhci_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">sdhci_set_ios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ro</span>		<span class="o">=</span> <span class="n">sdhci_get_ro</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="n">sdhci_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_sdio_irq</span> <span class="o">=</span> <span class="n">sdhci_enable_sdio_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_signal_voltage_switch</span>	<span class="o">=</span> <span class="n">sdhci_start_signal_voltage_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">execute_tuning</span>			<span class="o">=</span> <span class="n">sdhci_execute_tuning</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_preset_value</span>		<span class="o">=</span> <span class="n">sdhci_enable_preset_value</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Tasklets                                                                  *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_tasklet_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span><span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check host-&gt;mrq first in case we are runtime suspended */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDHCI_CARD_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Card removed during transfer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Resetting controller.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>

		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_CMD</span><span class="p">);</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_DATA</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_tasklet_finish</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span><span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * If this tasklet gets rescheduled while running, it will</span>
<span class="cm">         * be run again afterwards but without any active request.</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">mrq</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The controller needs a reset of internal state machines</span>
<span class="cm">	 * upon error conditions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_RESET_AFTER_REQUEST</span><span class="p">)))</span> <span class="p">{</span>

		<span class="cm">/* Some controllers need this kick or reset won&#39;t work here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_CLOCK_BEFORE_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>

			<span class="cm">/* This is to force an update */</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sdhci_set_clock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Spec says we should do both at the same time, but Ricoh</span>
<span class="cm">		   controllers do not like that. */</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_CMD</span><span class="p">);</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifndef SDHCI_USE_LEDS_CLASS</span>
	<span class="n">sdhci_deactivate_led</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">mrq</span><span class="p">);</span>
	<span class="n">sdhci_runtime_pm_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_timeout_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Timeout waiting for hardware &quot;</span>
			<span class="s">&quot;interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">sdhci_finish_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_tuning_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Interrupt handling                                                        *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_cmd_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">intmask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Got command interrupt 0x%08x even &quot;</span>
			<span class="s">&quot;though no command operation was in progress.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">intmask</span><span class="p">);</span>
		<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_TIMEOUT</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_INT_CRC</span> <span class="o">|</span> <span class="n">SDHCI_INT_END_BIT</span> <span class="o">|</span>
			<span class="n">SDHCI_INT_INDEX</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The host can send and interrupt when the busy state has</span>
<span class="cm">	 * ended, allowing us to wait without wasting CPU cycles.</span>
<span class="cm">	 * Unfortunately this is overloaded on the &quot;data complete&quot;</span>
<span class="cm">	 * interrupt, so we need to take some care when handling</span>
<span class="cm">	 * it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: The 1.0 specification is a bit ambiguous about this</span>
<span class="cm">	 *       feature so there might be some problems with older</span>
<span class="cm">	 *       controllers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Cannot wait for busy signal when also &quot;</span>
				<span class="s">&quot;doing a data transfer&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_BUSY_IRQ</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* The controller does not support the end-of-busy IRQ,</span>
<span class="cm">		 * fall through and take the SDHCI_INT_RESPONSE */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_RESPONSE</span><span class="p">)</span>
		<span class="n">sdhci_finish_command</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_show_adma_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">attr</span><span class="p">;</span>

	<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">desc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">desc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">attr</span> <span class="o">=</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: %p: DMA 0x%08x, LEN 0x%04x, Attr=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dma</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">),</span> <span class="n">attr</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_show_adma_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_data_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">intmask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CMD19 generates _only_ Buffer Read Ready interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_AVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">SDHCI_GET_CMD</span><span class="p">(</span><span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_COMMAND</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">MMC_SEND_TUNING_BLOCK</span> <span class="o">||</span>
		    <span class="n">command</span> <span class="o">==</span> <span class="n">MMC_SEND_TUNING_BLOCK_HS200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_ready_int</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The &quot;data complete&quot; interrupt is also used to</span>
<span class="cm">		 * indicate that a busy state has ended. See comment</span>
<span class="cm">		 * above in sdhci_cmd_irq().</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_END</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sdhci_finish_command</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Got data interrupt 0x%08x even &quot;</span>
			<span class="s">&quot;though no data operation was in progress.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">intmask</span><span class="p">);</span>
		<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_TIMEOUT</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_END_BIT</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_CRC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">SDHCI_GET_CMD</span><span class="p">(</span><span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_COMMAND</span><span class="p">))</span>
			<span class="o">!=</span> <span class="n">MMC_BUS_TEST_R</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_ADMA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ADMA error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">sdhci_show_adma_error</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">sdhci_finish_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_INT_DATA_AVAIL</span> <span class="o">|</span> <span class="n">SDHCI_INT_SPACE_AVAIL</span><span class="p">))</span>
			<span class="n">sdhci_transfer_pio</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We currently don&#39;t do anything fancy with DMA</span>
<span class="cm">		 * boundaries, but as we can&#39;t disable the feature</span>
<span class="cm">		 * we need to at least restart the transfer.</span>
<span class="cm">		 *</span>
<span class="cm">		 * According to the spec sdhci_readl(host, SDHCI_DMA_ADDRESS)</span>
<span class="cm">		 * should return a valid address to continue from, but as</span>
<span class="cm">		 * some controllers are faulty, don&#39;t trust them.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DMA_END</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">dmastart</span><span class="p">,</span> <span class="n">dmanow</span><span class="p">;</span>
			<span class="n">dmastart</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">dmanow</span> <span class="o">=</span> <span class="n">dmastart</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Force update to the next DMA block boundary.</span>
<span class="cm">			 */</span>
			<span class="n">dmanow</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmanow</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">SDHCI_DEFAULT_BOUNDARY_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
				<span class="n">SDHCI_DEFAULT_BOUNDARY_SIZE</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">=</span> <span class="n">dmanow</span> <span class="o">-</span> <span class="n">dmastart</span><span class="p">;</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: DMA base 0x%08x, transferred 0x%06x bytes,&quot;</span>
				<span class="s">&quot; next 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">dmastart</span><span class="p">,</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span><span class="p">,</span> <span class="n">dmanow</span><span class="p">);</span>
			<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">dmanow</span><span class="p">,</span> <span class="n">SDHCI_DMA_ADDRESS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_END</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Data managed to finish before the</span>
<span class="cm">				 * command completed. Make sure we do</span>
<span class="cm">				 * things in the proper order.</span>
<span class="cm">				 */</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data_early</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sdhci_finish_data</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdhci_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intmask</span><span class="p">,</span> <span class="n">unexpected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cardint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_loops</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">runtime_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: got irq while runtime suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intmask</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intmask</span> <span class="o">||</span> <span class="n">intmask</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">again:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;*** %s got interrupt: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">intmask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_INT_CARD_INSERT</span> <span class="o">|</span> <span class="n">SDHCI_INT_CARD_REMOVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">present</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_PRESENT_STATE</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">SDHCI_CARD_PRESENT</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * There is a observation on i.mx esdhc.  INSERT bit will be</span>
<span class="cm">		 * immediately set again when it gets cleared, if a card is</span>
<span class="cm">		 * inserted.  We have to mask the irq to prevent interrupt</span>
<span class="cm">		 * storm which will freeze the system.  And the REMOVE gets</span>
<span class="cm">		 * the same situation.</span>
<span class="cm">		 *</span>
<span class="cm">		 * More testing are needed here to ensure it works for other</span>
<span class="cm">		 * platforms though.</span>
<span class="cm">		 */</span>
		<span class="n">sdhci_mask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">present</span> <span class="o">?</span> <span class="n">SDHCI_INT_CARD_INSERT</span> <span class="o">:</span>
						<span class="n">SDHCI_INT_CARD_REMOVE</span><span class="p">);</span>
		<span class="n">sdhci_unmask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">present</span> <span class="o">?</span> <span class="n">SDHCI_INT_CARD_REMOVE</span> <span class="o">:</span>
						  <span class="n">SDHCI_INT_CARD_INSERT</span><span class="p">);</span>

		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_INT_CARD_INSERT</span> <span class="o">|</span>
			     <span class="n">SDHCI_INT_CARD_REMOVE</span><span class="p">),</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
		<span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SDHCI_INT_CARD_INSERT</span> <span class="o">|</span> <span class="n">SDHCI_INT_CARD_REMOVE</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_CMD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_CMD_MASK</span><span class="p">,</span>
			<span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
		<span class="n">sdhci_cmd_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_CMD_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_MASK</span><span class="p">,</span>
			<span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
		<span class="n">sdhci_data_irq</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SDHCI_INT_CMD_MASK</span> <span class="o">|</span> <span class="n">SDHCI_INT_DATA_MASK</span><span class="p">);</span>

	<span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_INT_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_BUS_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Card is consuming too much power!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_BUS_POWER</span><span class="p">,</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_INT_BUS_POWER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">SDHCI_INT_CARD_INT</span><span class="p">)</span>
		<span class="n">cardint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_INT_CARD_INT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unexpected</span> <span class="o">|=</span> <span class="n">intmask</span><span class="p">;</span>
		<span class="n">sdhci_writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">intmask</span><span class="p">,</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">intmask</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intmask</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">max_loops</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unexpected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unexpected interrupt 0x%08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">unexpected</span><span class="p">);</span>
		<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have to delay this as it calls back into the driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cardint</span><span class="p">)</span>
		<span class="n">mmc_signal_sdio_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Suspend/resume                                                            *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="kt">int</span> <span class="nf">sdhci_suspend_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_tuning_timer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_suspend</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">sdhci_disable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Disable tuning since we are suspending */</span>
	<span class="n">has_tuning_timer</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span> <span class="o">&amp;&amp;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_tuning_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_tuning_timer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sdhci_enable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_suspend_host</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sdhci_resume_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdhci_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_KEEP_POWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks2</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK2_HOST_OFF_CARD_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Card keeps power but host controller does not */</span>
		<span class="n">sdhci_init</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdhci_do_set_ios</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdhci_init</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_KEEP_POWER</span><span class="p">));</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">sdhci_enable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_resume</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">platform_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Set the re-tuning expiration flag */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_resume_host</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sdhci_enable_irq_wakeups</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_WAKE_UP_CONTROL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">SDHCI_WAKE_ON_INT</span><span class="p">;</span>
	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">SDHCI_WAKE_UP_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_enable_irq_wakeups</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_runtime_pm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_runtime_pm_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_mark_last_busy</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pm_runtime_put_autosuspend</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sdhci_runtime_suspend_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable tuning since we are suspending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span> <span class="o">&amp;&amp;</span>
	    <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sdhci_mask_irqs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_INT_ALL_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">runtime_suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_runtime_suspend_host</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sdhci_runtime_resume_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">host_flags</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sdhci_init</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Force clock and power re-program */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdhci_do_set_ios</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>

	<span class="n">sdhci_do_start_signal_voltage_switch</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ios</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_PV_ENABLED</span><span class="p">)</span>
		<span class="n">sdhci_do_enable_preset_value</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Set the re-tuning expiration flag */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">==</span> <span class="n">SDHCI_TUNING_MODE_1</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_NEEDS_RETUNING</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">runtime_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Enable SDIO IRQ */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_SDIO_IRQ_ENABLED</span><span class="p">))</span>
		<span class="n">sdhci_enable_sdio_irq_nolock</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Enable Card Detection */</span>
	<span class="n">sdhci_enable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_runtime_resume_host</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Device allocation/registration                                            *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="nf">sdhci_alloc_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">priv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span><span class="p">)</span> <span class="o">+</span> <span class="n">priv_size</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">host</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_alloc_host</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sdhci_add_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">caps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">max_current_caps</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ocr_avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_quirks</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">debug_quirks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_quirks2</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks2</span> <span class="o">=</span> <span class="n">debug_quirks2</span><span class="p">;</span>

	<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">sdhci_readw</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_VERSION</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="n">SDHCI_SPEC_VER_MASK</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">SDHCI_SPEC_VER_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unknown controller version (%d). &quot;</span>
			<span class="s">&quot;You may experience problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_MISSING_CAPS</span><span class="p">)</span> <span class="o">?</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">:</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CAPABILITIES</span><span class="p">);</span>

	<span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_CAPABILITIES_1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_FORCE_DMA</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_DO_SDMA</span><span class="p">))</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Controller doesn&#39;t have SDMA capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_DMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Disabling DMA as it is marked broken</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_USE_SDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_200</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_DO_ADMA2</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;Disabling ADMA as it is marked broken</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_USE_ADMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_dma</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: No suitable DMA &quot;</span>
					<span class="s">&quot;available. Falling back to PIO.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need to allocate descriptors for all sg entries</span>
<span class="cm">		 * (128) and potentially one alignment transfer for</span>
<span class="cm">		 * each of those entries.</span>
<span class="cm">		 */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">);</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Unable to allocate ADMA &quot;</span>
				<span class="s">&quot;buffers. Falling back to standard DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_USE_ADMA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we use DMA, then it&#39;s up to the caller to set the DMA</span>
<span class="cm">	 * mask, but PIO does not need the hw shim so we set a new</span>
<span class="cm">	 * mask here in that case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_USE_SDMA</span> <span class="o">|</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CLOCK_V3_BASE_MASK</span><span class="p">)</span>
			<span class="o">&gt;&gt;</span> <span class="n">SDHCI_CLOCK_BASE_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CLOCK_BASE_MASK</span><span class="p">)</span>
			<span class="o">&gt;&gt;</span> <span class="n">SDHCI_CLOCK_BASE_SHIFT</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span>
			<span class="n">SDHCI_QUIRK_CAP_CLOCK_BASE_BROKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_max_clock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Hardware doesn&#39;t specify base clock &quot;</span>
			       <span class="s">&quot;frequency.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_max_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of Host Controller v3.00, find out whether clock</span>
<span class="cm">	 * multiplier is supported.</span>
<span class="cm">	 */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CLOCK_MUL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">SDHCI_CLOCK_MUL_SHIFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case the value in Clock Multiplier is 0, then programmable</span>
<span class="cm">	 * clock mode is not supported, otherwise the actual clock</span>
<span class="cm">	 * multiplier is one more than the value of Clock Multiplier</span>
<span class="cm">	 * in the Capabilities Register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set host parameters.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdhci_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_min_clock</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_min_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">*</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">*</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_mul</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">/</span> <span class="n">SDHCI_MAX_DIV_SPEC_300</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">max_clk</span> <span class="o">/</span> <span class="n">SDHCI_MAX_DIV_SPEC_200</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_TIMEOUT_CLK_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SDHCI_TIMEOUT_CLK_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_timeout_clock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_timeout_clock</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span>
				<span class="n">SDHCI_QUIRK_DATA_TIMEOUT_USES_SDCLK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Hardware doesn&#39;t specify timeout clock &quot;</span>
			       <span class="s">&quot;frequency.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_TIMEOUT_CLK_UNIT</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_DATA_TIMEOUT_USES_SDCLK</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_discard_to</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">timeout_clk</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SDIO_IRQ</span> <span class="o">|</span> <span class="n">MMC_CAP_ERASE</span> <span class="o">|</span> <span class="n">MMC_CAP_CMD23</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_MULTIBLOCK_READ_ACMD12</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_AUTO_CMD12</span><span class="p">;</span>

	<span class="cm">/* Auto-CMD23 stuff only works in ADMA or PIO. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_AUTO_CMD23</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Auto-CMD23 available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Auto-CMD23 unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * A controller may support 8-bit width, but the board itself</span>
<span class="cm">	 * might not have the pins brought out.  Boards that support</span>
<span class="cm">	 * 8-bit width must set &quot;mmc-&gt;caps |= MMC_CAP_8_BIT_DATA;&quot; in</span>
<span class="cm">	 * their platform code before calling sdhci_add_host(), and we</span>
<span class="cm">	 * won&#39;t assume 8-bit width for hosts without that CAP.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_FORCE_1_BIT_DATA</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_DO_HISPD</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SD_HIGHSPEED</span> <span class="o">|</span> <span class="n">MMC_CAP_MMC_HIGHSPEED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_CARD_DETECTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mmc_card_is_removable</span><span class="p">(</span><span class="n">mmc</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_NEEDS_POLL</span><span class="p">;</span>

	<span class="cm">/* Any UHS-I mode in caps implies SDR12 and SDR25 support. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDHCI_SUPPORT_SDR104</span> <span class="o">|</span> <span class="n">SDHCI_SUPPORT_SDR50</span> <span class="o">|</span>
		       <span class="n">SDHCI_SUPPORT_DDR50</span><span class="p">))</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_UHS_SDR12</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR25</span><span class="p">;</span>

	<span class="cm">/* SDR104 supports also implies SDR50 support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_SUPPORT_SDR104</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_UHS_SDR104</span> <span class="o">|</span> <span class="n">MMC_CAP_UHS_SDR50</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_SUPPORT_SDR50</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_UHS_SDR50</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_SUPPORT_DDR50</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_UHS_DDR50</span><span class="p">;</span>

	<span class="cm">/* Does the host need tuning for SDR50? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDR50_TUNING</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_SDR50_NEEDS_TUNING</span><span class="p">;</span>

	<span class="cm">/* Does the host need tuning for HS200? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps2</span> <span class="o">&amp;</span> <span class="n">MMC_CAP2_HS200</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_HS200_NEEDS_TUNING</span><span class="p">;</span>

	<span class="cm">/* Driver Type(s) (A, C, D) supported by the host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_DRIVER_TYPE_A</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_DRIVER_TYPE_A</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_DRIVER_TYPE_C</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_DRIVER_TYPE_C</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_DRIVER_TYPE_D</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_DRIVER_TYPE_D</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If Power Off Notify capability is enabled by the host,</span>
<span class="cm">	 * set notify to short power off notify timeout value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps2</span> <span class="o">&amp;</span> <span class="n">MMC_CAP2_POWEROFF_NOTIFY</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">power_notify_type</span> <span class="o">=</span> <span class="n">MMC_HOST_PW_NOTIFY_SHORT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">power_notify_type</span> <span class="o">=</span> <span class="n">MMC_HOST_PW_NOTIFY_NONE</span><span class="p">;</span>

	<span class="cm">/* Initial value for re-tuning timer count */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_RETUNING_TIMER_COUNT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			      <span class="n">SDHCI_RETUNING_TIMER_COUNT_SHIFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case Re-tuning Timer is not disabled, the actual value of</span>
<span class="cm">	 * re-tuning timer will be 2 ^ (n - 1).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Re-tuning mode supported by the Host Controller */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_RETUNING_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			     <span class="n">SDHCI_RETUNING_MODE_SHIFT</span><span class="p">;</span>

	<span class="n">ocr_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to SD Host Controller spec v3.00, if the Host System</span>
<span class="cm">	 * can afford more than 150mA, Host Driver should set XPC to 1. Also</span>
<span class="cm">	 * the value is meaningful only if Voltage Support in the Capabilities</span>
<span class="cm">	 * register is set. The actual current value is 4 times the register</span>
<span class="cm">	 * value.</span>
<span class="cm">	 */</span>
	<span class="n">max_current_caps</span> <span class="o">=</span> <span class="n">sdhci_readl</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_MAX_CURRENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_VDD_330</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_current_330</span><span class="p">;</span>

		<span class="n">ocr_avail</span> <span class="o">|=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span><span class="p">;</span>

		<span class="n">max_current_330</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_current_caps</span> <span class="o">&amp;</span>
				   <span class="n">SDHCI_MAX_CURRENT_330_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">SDHCI_MAX_CURRENT_330_SHIFT</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">SDHCI_MAX_CURRENT_MULTIPLIER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_current_330</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SET_XPC_330</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_VDD_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_current_300</span><span class="p">;</span>

		<span class="n">ocr_avail</span> <span class="o">|=</span> <span class="n">MMC_VDD_29_30</span> <span class="o">|</span> <span class="n">MMC_VDD_30_31</span><span class="p">;</span>

		<span class="n">max_current_300</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_current_caps</span> <span class="o">&amp;</span>
				   <span class="n">SDHCI_MAX_CURRENT_300_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">SDHCI_MAX_CURRENT_300_SHIFT</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">SDHCI_MAX_CURRENT_MULTIPLIER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_current_300</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SET_XPC_300</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_CAN_VDD_180</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_current_180</span><span class="p">;</span>

		<span class="n">ocr_avail</span> <span class="o">|=</span> <span class="n">MMC_VDD_165_195</span><span class="p">;</span>

		<span class="n">max_current_180</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_current_caps</span> <span class="o">&amp;</span>
				   <span class="n">SDHCI_MAX_CURRENT_180_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">SDHCI_MAX_CURRENT_180_SHIFT</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">SDHCI_MAX_CURRENT_MULTIPLIER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_current_180</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_SET_XPC_180</span><span class="p">;</span>

		<span class="cm">/* Maximum current capabilities of the host at 1.8V */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_current_180</span> <span class="o">&gt;=</span> <span class="mi">800</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_MAX_CURRENT_800</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_current_180</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_MAX_CURRENT_600</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_current_180</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_MAX_CURRENT_400</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_MAX_CURRENT_200</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">ocr_avail</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span> <span class="o">=</span> <span class="n">ocr_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span> <span class="o">&amp;=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sdio</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span> <span class="o">=</span> <span class="n">ocr_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span> <span class="o">&amp;=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* normal SD controllers don&#39;t support 1.8V */</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MMC_VDD_165_195</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_mmc</span> <span class="o">=</span> <span class="n">ocr_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_mmc</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail_mmc</span> <span class="o">&amp;=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_mmc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Hardware doesn&#39;t report any &quot;</span>
			<span class="s">&quot;support voltages.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum number of segments. Depends on if the hardware</span>
<span class="cm">	 * can do scatter/gather or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* PIO */</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum number of sectors in one transfer. Limited by DMA boundary</span>
<span class="cm">	 * size (512KiB).</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="mi">524288</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum segment size. Could be one segment with the maximum number</span>
<span class="cm">	 * of bytes. When doing hardware scatter/gather, each entry cannot</span>
<span class="cm">	 * be larger than 64 KiB though.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA_ZEROLEN_DESC</span><span class="p">)</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum block size. This varies from controller to controller and</span>
<span class="cm">	 * is specified in the capabilities register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_FORCE_BLK_SZ_2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">caps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDHCI_MAX_BLOCK_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">SDHCI_MAX_BLOCK_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Invalid maximum block size, &quot;</span>
				<span class="s">&quot;assuming 512 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
			<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">&lt;&lt;</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum block count.</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">SDHCI_QUIRK_NO_MULTIBLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init tasklets.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">,</span>
		<span class="n">sdhci_tasklet_card</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">,</span>
		<span class="n">sdhci_tasklet_finish</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">sdhci_timeout_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buf_ready_int</span><span class="p">);</span>

		<span class="cm">/* Initialize re-tuning timer */</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">sdhci_tuning_timer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdhci_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">untasklet</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;vmmc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no vmmc regulator found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdhci_init</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>
	<span class="n">sdhci_dumpregs</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SDHCI_USE_LEDS_CLASS</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">led_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">led_name</span><span class="p">),</span>
		<span class="s">&quot;%s::&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">));</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">led_name</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">sdhci_led_control</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: SDHCI controller on %s [%s] using %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">mmc</span><span class="p">)),</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_ADMA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ADMA&quot;</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">);</span>

	<span class="n">sdhci_enable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SDHCI_USE_LEDS_CLASS</span>
<span class="nl">reset:</span>
	<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">untasklet:</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_add_host</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sdhci_remove_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dead</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDHCI_DEVICE_DEAD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Controller removed during &quot;</span>
				<span class="s">&quot; transfer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEDIUM</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sdhci_disable_card_detection</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>

<span class="cp">#ifdef SDHCI_USE_LEDS_CLASS</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dead</span><span class="p">)</span>
		<span class="n">sdhci_reset</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_RESET_ALL</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="n">SDHCI_SPEC_300</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">tuning_timer</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">finish_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">adma_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">align_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_remove_host</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sdhci_free_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sdhci_free_host</span><span class="p">);</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Driver init/exit                                                          *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdhci_drv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span>
		<span class="s">&quot;: Secure Digital Host Controller Interface driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_NAME</span> <span class="s">&quot;: Copyright(c) Pierre Ossman</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sdhci_drv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sdhci_drv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sdhci_drv_exit</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug_quirks</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_quirks2</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pierre Ossman &lt;pierre@ossman.eu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Secure Digital Host Controller Interface core driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_quirks</span><span class="p">,</span> <span class="s">&quot;Force certain quirks.&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_quirks2</span><span class="p">,</span> <span class="s">&quot;Force certain other quirks.&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
