<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › omap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>omap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mmc/host/omap.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004 Nokia Corporation</span>
<span class="cm"> *  Written by Tuukka Tikkanen and Juha Yrjölä&lt;juha.yrjola@nokia.com&gt;</span>
<span class="cm"> *  Misc hacks here and there by Tony Lindgren &lt;tony@atomide.com&gt;</span>
<span class="cm"> *  Other hacks (DMA, SD, etc) by David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/tps65010.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;plat/board.h&gt;</span>
<span class="cp">#include &lt;plat/mmc.h&gt;</span>
<span class="cp">#include &lt;asm/gpio.h&gt;</span>
<span class="cp">#include &lt;plat/dma.h&gt;</span>
<span class="cp">#include &lt;plat/mux.h&gt;</span>
<span class="cp">#include &lt;plat/fpga.h&gt;</span>

<span class="cp">#define	OMAP_MMC_REG_CMD	0x00</span>
<span class="cp">#define	OMAP_MMC_REG_ARGL	0x01</span>
<span class="cp">#define	OMAP_MMC_REG_ARGH	0x02</span>
<span class="cp">#define	OMAP_MMC_REG_CON	0x03</span>
<span class="cp">#define	OMAP_MMC_REG_STAT	0x04</span>
<span class="cp">#define	OMAP_MMC_REG_IE		0x05</span>
<span class="cp">#define	OMAP_MMC_REG_CTO	0x06</span>
<span class="cp">#define	OMAP_MMC_REG_DTO	0x07</span>
<span class="cp">#define	OMAP_MMC_REG_DATA	0x08</span>
<span class="cp">#define	OMAP_MMC_REG_BLEN	0x09</span>
<span class="cp">#define	OMAP_MMC_REG_NBLK	0x0a</span>
<span class="cp">#define	OMAP_MMC_REG_BUF	0x0b</span>
<span class="cp">#define	OMAP_MMC_REG_SDIO	0x0d</span>
<span class="cp">#define	OMAP_MMC_REG_REV	0x0f</span>
<span class="cp">#define	OMAP_MMC_REG_RSP0	0x10</span>
<span class="cp">#define	OMAP_MMC_REG_RSP1	0x11</span>
<span class="cp">#define	OMAP_MMC_REG_RSP2	0x12</span>
<span class="cp">#define	OMAP_MMC_REG_RSP3	0x13</span>
<span class="cp">#define	OMAP_MMC_REG_RSP4	0x14</span>
<span class="cp">#define	OMAP_MMC_REG_RSP5	0x15</span>
<span class="cp">#define	OMAP_MMC_REG_RSP6	0x16</span>
<span class="cp">#define	OMAP_MMC_REG_RSP7	0x17</span>
<span class="cp">#define	OMAP_MMC_REG_IOSR	0x18</span>
<span class="cp">#define	OMAP_MMC_REG_SYSC	0x19</span>
<span class="cp">#define	OMAP_MMC_REG_SYSS	0x1a</span>

<span class="cp">#define	OMAP_MMC_STAT_CARD_ERR		(1 &lt;&lt; 14)</span>
<span class="cp">#define	OMAP_MMC_STAT_CARD_IRQ		(1 &lt;&lt; 13)</span>
<span class="cp">#define	OMAP_MMC_STAT_OCR_BUSY		(1 &lt;&lt; 12)</span>
<span class="cp">#define	OMAP_MMC_STAT_A_EMPTY		(1 &lt;&lt; 11)</span>
<span class="cp">#define	OMAP_MMC_STAT_A_FULL		(1 &lt;&lt; 10)</span>
<span class="cp">#define	OMAP_MMC_STAT_CMD_CRC		(1 &lt;&lt;  8)</span>
<span class="cp">#define	OMAP_MMC_STAT_CMD_TOUT		(1 &lt;&lt;  7)</span>
<span class="cp">#define	OMAP_MMC_STAT_DATA_CRC		(1 &lt;&lt;  6)</span>
<span class="cp">#define	OMAP_MMC_STAT_DATA_TOUT		(1 &lt;&lt;  5)</span>
<span class="cp">#define	OMAP_MMC_STAT_END_BUSY		(1 &lt;&lt;  4)</span>
<span class="cp">#define	OMAP_MMC_STAT_END_OF_DATA	(1 &lt;&lt;  3)</span>
<span class="cp">#define	OMAP_MMC_STAT_CARD_BUSY		(1 &lt;&lt;  2)</span>
<span class="cp">#define	OMAP_MMC_STAT_END_OF_CMD	(1 &lt;&lt;  0)</span>

<span class="cp">#define OMAP_MMC_REG(host, reg)		(OMAP_MMC_REG_##reg &lt;&lt; (host)-&gt;reg_shift)</span>
<span class="cp">#define OMAP_MMC_READ(host, reg)	__raw_readw((host)-&gt;virt_base + OMAP_MMC_REG(host, reg))</span>
<span class="cp">#define OMAP_MMC_WRITE(host, reg, val)	__raw_writew((val), (host)-&gt;virt_base + OMAP_MMC_REG(host, reg))</span>

<span class="cm">/*</span>
<span class="cm"> * Command types</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP_MMC_CMDTYPE_BC	0</span>
<span class="cp">#define OMAP_MMC_CMDTYPE_BCR	1</span>
<span class="cp">#define OMAP_MMC_CMDTYPE_AC	2</span>
<span class="cp">#define OMAP_MMC_CMDTYPE_ADTC	3</span>


<span class="cp">#define DRIVER_NAME &quot;mmci-omap&quot;</span>

<span class="cm">/* Specifies how often in millisecs to poll for card status changes</span>
<span class="cm"> * when the cover switch is open */</span>
<span class="cp">#define OMAP_MMC_COVER_POLL_DELAY	500</span>

<span class="k">struct</span> <span class="n">mmc_omap_host</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">vdd</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">saved_con</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">bus_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">fclk_freq</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">powered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tasklet_struct</span>	<span class="n">cover_tasklet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>       <span class="n">cover_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">cover_open</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_request</span>      <span class="o">*</span><span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span>    <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span>		<span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_mmc_slot_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">initialized</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">suspended</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span>	<span class="n">mrq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span>	<span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span>	<span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span>	<span class="n">mmc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span>		<span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">id</span><span class="p">;</span> <span class="cm">/* 16xx chips have 2 MMC blocks */</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span>		<span class="n">iclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span>		<span class="n">fclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">mem_res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">virt_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">phys_base</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">bus_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">hw_bus_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">reg_shift</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">cmd_abort_work</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">abort</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">cmd_abort_timer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span>      <span class="n">slot_release_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span>    <span class="o">*</span><span class="n">next_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>      <span class="n">send_stop_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span>		<span class="o">*</span><span class="n">stop_data</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sg_len</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">sg_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span>			<span class="n">buffer</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">buffer_bytes_left</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">total_bytes_left</span><span class="p">;</span>

	<span class="kt">unsigned</span>		<span class="n">use_dma</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">brs_received</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">dma_done</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">dma_is_read</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">dma_in_use</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">dma_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">dma_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">dma_len</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_omap_slot</span>    <span class="o">*</span><span class="n">slots</span><span class="p">[</span><span class="n">OMAP_MMC_MAX_SLOTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span>    <span class="o">*</span><span class="n">current_slot</span><span class="p">;</span>
	<span class="n">spinlock_t</span>              <span class="n">slot_lock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>       <span class="n">slot_wq</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">nr_slots</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>       <span class="n">clk_timer</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">clk_lock</span><span class="p">;</span>     <span class="cm">/* for changing enabled state */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">fclk_enabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">mmc_omap_wq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_fclk_offdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_ns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tick_ns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">+</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span><span class="p">;</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">tick_ns</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_fclk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk_enabled</span> <span class="o">!=</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_select_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">claimed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">claimed</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_claim</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_wq</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">no_claim:</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span> <span class="o">!=</span> <span class="n">slot</span> <span class="o">||</span> <span class="o">!</span><span class="n">claimed</span><span class="p">)</span>
		<span class="n">mmc_omap_fclk_offdelay</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span> <span class="o">!=</span> <span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">saved_con</span> <span class="o">&amp;</span> <span class="mh">0xFC00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">switch_slot</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">switch_slot</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">claimed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Doing the dummy read here seems to work around some bug</span>
<span class="cm">		 * at least in OMAP24xx silicon where the command would not</span>
<span class="cm">		 * start after writing the CMD register. Sigh. */</span>
		<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">);</span>

		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">saved_con</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mmc_omap_start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_slot_release_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_omap_host</span><span class="p">,</span>
						  <span class="n">slot_release_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">next_slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">next_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">rq</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">next_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mmc_omap_select_slot</span><span class="p">(</span><span class="n">next_slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rq</span> <span class="o">=</span> <span class="n">next_slot</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
	<span class="n">next_slot</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mmc_omap_start_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_release_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clk_enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk_enabled</span><span class="p">)</span>
		<span class="cm">/* Keeps clock running for at least 8 cycles on valid freq */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_timer</span><span class="p">,</span> <span class="n">jiffies</span>  <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_timer</span><span class="p">);</span>
		<span class="n">mmc_omap_fclk_offdelay</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Check for any pending requests */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">new_slot</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">next_slot</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">new_slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* The current slot should not have a request in queue */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">new_slot</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">next_slot</span> <span class="o">=</span> <span class="n">new_slot</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">new_slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_release_work</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_wq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">mmc_omap_cover_is_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cover_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cover_state</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
						    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mmc_omap_show_cover_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_host</span><span class="p">,</span> <span class="n">class_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_omap_cover_is_open</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;open&quot;</span> <span class="o">:</span>
		       <span class="s">&quot;closed&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cover_switch</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mmc_omap_show_cover_switch</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mmc_omap_show_slot_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_host</span><span class="p">,</span> <span class="n">class_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">slot_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mmc_omap_show_slot_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_start_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmdreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resptype</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmdtype</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">resptype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmdtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Our hardware needs to know exact type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_RSP_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R1</span>:
	<span class="k">case</span> <span class="n">MMC_RSP_R1B</span>:
		<span class="cm">/* resp 1, 1b, 6, 7 */</span>
		<span class="n">resptype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R2</span>:
		<span class="n">resptype</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_RSP_R3</span>:
		<span class="n">resptype</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Invalid response type: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmc_resp_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_cmd_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMC_CMD_ADTC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdtype</span> <span class="o">=</span> <span class="n">OMAP_MMC_CMDTYPE_ADTC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc_cmd_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMC_CMD_BC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdtype</span> <span class="o">=</span> <span class="n">OMAP_MMC_CMDTYPE_BC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc_cmd_type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMC_CMD_BCR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdtype</span> <span class="o">=</span> <span class="n">OMAP_MMC_CMDTYPE_BCR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmdtype</span> <span class="o">=</span> <span class="n">OMAP_MMC_CMDTYPE_AC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdreg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">|</span> <span class="p">(</span><span class="n">resptype</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmdtype</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">==</span> <span class="n">MMC_BUSMODE_OPENDRAIN</span><span class="p">)</span>
		<span class="n">cmdreg</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_BUSY</span><span class="p">)</span>
		<span class="n">cmdreg</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">))</span>
		<span class="n">cmdreg</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTO</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ARGL</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ARGH</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span>
		       <span class="n">OMAP_MMC_STAT_A_EMPTY</span>    <span class="o">|</span> <span class="n">OMAP_MMC_STAT_A_FULL</span>    <span class="o">|</span>
		       <span class="n">OMAP_MMC_STAT_CMD_CRC</span>    <span class="o">|</span> <span class="n">OMAP_MMC_STAT_CMD_TOUT</span>  <span class="o">|</span>
		       <span class="n">OMAP_MMC_STAT_DATA_CRC</span>   <span class="o">|</span> <span class="n">OMAP_MMC_STAT_DATA_TOUT</span> <span class="o">|</span>
		       <span class="n">OMAP_MMC_STAT_END_OF_CMD</span> <span class="o">|</span> <span class="n">OMAP_MMC_STAT_CARD_ERR</span>  <span class="o">|</span>
		       <span class="n">OMAP_MMC_STAT_END_OF_DATA</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="n">cmdreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_release_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">abort</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dma_data_dir</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">omap_stop_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">);</span>
	<span class="cm">/* Release DMA channel lazily */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
		<span class="n">dma_data_dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dma_data_dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
	<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
		     <span class="n">dma_data_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_send_stop_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_omap_host</span><span class="p">,</span>
						  <span class="n">send_stop_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tick_ns</span><span class="p">;</span>

	<span class="n">tick_ns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000000</span> <span class="o">+</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span><span class="p">;</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">tick_ns</span><span class="p">);</span>

	<span class="n">mmc_omap_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span><span class="p">)</span>
		<span class="n">mmc_omap_release_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NOTE:  MMC layer will sometimes poll-wait CMD13 next, issuing</span>
<span class="cm">	 * dozens of requests until the card finishes writing data.</span>
<span class="cm">	 * It&#39;d be cheaper to just wait till an EOFB interrupt arrives...</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
		<span class="n">mmc_omap_release_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">stop_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">send_stop_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_send_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxloops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">restarts</span><span class="p">,</span> <span class="n">passes</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Sending abort takes 80 clocks. Have some extra and round up */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">120</span><span class="o">*</span><span class="mi">1000000</span> <span class="o">+</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span><span class="p">;</span>
	<span class="n">restarts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">restarts</span> <span class="o">&lt;</span> <span class="n">maxloops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>

		<span class="n">passes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">passes</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_END_OF_CMD</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">passes</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">restarts</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_abort_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span><span class="p">)</span>
		<span class="n">mmc_omap_release_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmc_omap_send_abort</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_end_of_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_omap_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_done</span><span class="p">)</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">brs_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
		<span class="n">mmc_omap_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_dma_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_dma_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">brs_received</span><span class="p">)</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
		<span class="n">mmc_omap_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_cmd_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_136</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* response type 2 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP2</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP4</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP6</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* response types 1, 1b, 3, 4, 5, 6 */</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP6</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">RSP7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mmc_omap_abort_xfer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
		<span class="n">mmc_omap_release_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Abort stuck command. Can occur when card is removed while it is being</span>
<span class="cm"> * read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_abort_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_omap_host</span><span class="p">,</span>
						  <span class="n">cmd_abort_work</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;Aborting stuck command CMD%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mmc_host</span>    <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc_omap_send_abort</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mmc</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>
		<span class="n">mmc_omap_release_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mmc_request_done</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mmc_omap_cmd_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_cmd_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PIO only */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_sg_to_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">sg</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">+</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">sg_virt</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_clk_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PIO only */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_xfer_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">);</span>
		<span class="n">mmc_omap_sg_to_buf</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer_bytes_left</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writesw</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">OMAP_MMC_REG</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DATA</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__raw_readsw</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">OMAP_MMC_REG</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DATA</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_omap_report_irq</span><span class="p">(</span><span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mmc_omap_status_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;EOC&quot;</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">,</span> <span class="s">&quot;CB&quot;</span><span class="p">,</span> <span class="s">&quot;BRS&quot;</span><span class="p">,</span> <span class="s">&quot;EOFB&quot;</span><span class="p">,</span> <span class="s">&quot;DTO&quot;</span><span class="p">,</span> <span class="s">&quot;DCRC&quot;</span><span class="p">,</span> <span class="s">&quot;CTO&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCRC&quot;</span><span class="p">,</span> <span class="s">&quot;CRW&quot;</span><span class="p">,</span> <span class="s">&quot;AF&quot;</span><span class="p">,</span> <span class="s">&quot;AE&quot;</span><span class="p">,</span> <span class="s">&quot;OCRB&quot;</span><span class="p">,</span> <span class="s">&quot;CIRQ&quot;</span><span class="p">,</span> <span class="s">&quot;CERR&quot;</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_omap_status_bits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">mmc_omap_status_bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mmc_omap_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span> <span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_transfer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">transfer_error</span><span class="p">,</span> <span class="n">cmd_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			 <span class="s">&quot;Spurious IRQ 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">end_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">transfer_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MMC_DEBUG</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;MMC IRQ %04x (CMD %d): &quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">mmc_omap_report_irq</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_A_FULL</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_END_OF_DATA</span><span class="p">))</span>
				<span class="n">mmc_omap_xfer_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_A_EMPTY</span><span class="p">)</span>
				<span class="n">mmc_omap_xfer_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_END_OF_DATA</span><span class="p">)</span>
			<span class="n">end_transfer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_DATA_TOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;data timeout (CMD%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="n">transfer_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_DATA_CRC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					 <span class="s">&quot;data CRC error, bytes left %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span><span class="p">);</span>
				<span class="n">transfer_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;data CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_CMD_TOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Timeouts are routine with some commands */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span>
					<span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
				    <span class="o">!</span><span class="n">mmc_omap_cover_is_open</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
						<span class="s">&quot;command timeout (CMD%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">cmd</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cmd_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_CMD_CRC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					<span class="s">&quot;command CRC error (CMD%d, arg 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cmd</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
				<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
				<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cmd_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
					<span class="s">&quot;command CRC error without cmd?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_CARD_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
				<span class="s">&quot;ignoring card status error (CMD%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">);</span>
			<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * NOTE: On 1610 the END_OF_CMD may come too early when</span>
<span class="cm">		 * starting a write</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_END_OF_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OMAP_MMC_STAT_A_EMPTY</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">end_command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_error</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_timer</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_work</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end_command</span> <span class="o">&amp;&amp;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">mmc_omap_cmd_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">transfer_error</span><span class="p">)</span>
			<span class="n">mmc_omap_xfer_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">end_transfer</span><span class="p">)</span>
			<span class="n">mmc_omap_end_of_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap_mmc_notify_cover_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_closed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cover_open</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">);</span>

	<span class="cm">/* Other subsystems can call in here before we&#39;re initialised. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">num</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cover_open</span> <span class="o">=</span> <span class="n">mmc_omap_cover_is_open</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cover_open</span> <span class="o">!=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_open</span> <span class="o">=</span> <span class="n">cover_open</span><span class="p">;</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cover_switch&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_cover_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_cover_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cover_open</span> <span class="o">=</span> <span class="n">mmc_omap_cover_is_open</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>

	<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cover_open</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no card is inserted, we postpone polling until</span>
<span class="cm">	 * the cover has been closed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">mmc_card_present</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">OMAP_MMC_COVER_POLL_DELAY</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Prepare to transfer the next segment of a scatterlist */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_prepare_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dma_ch</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buf</span><span class="p">,</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">src_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dst_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data_addr</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">+</span> <span class="n">OMAP_MMC_REG</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DATA</span><span class="p">);</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* FIFO is 16x2 bytes on 15xx, and 32x2 bytes on 16xx and 24xx.</span>
<span class="cm">	 * Use 16 or 32 word frames when the blocksize is at least that large.</span>
<span class="cm">	 * Blocksize is usually 512 bytes; but not for some SD reads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap15xx</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">frame</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">/=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">frame</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x800f</span> <span class="o">|</span> <span class="p">((</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">src_port</span> <span class="o">=</span> <span class="n">OMAP_DMA_PORT_TIPB</span><span class="p">;</span>
			<span class="n">dst_port</span> <span class="o">=</span> <span class="n">OMAP_DMA_PORT_EMIFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA_MMC1_RX</span><span class="p">;</span>

		<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span>
					<span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
					<span class="n">data_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span>
					 <span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
					 <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_dest_data_pack</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">omap_set_dma_dest_burst_mode</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_BURST_4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="mh">0x0f80</span> <span class="o">|</span> <span class="p">((</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap1</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">src_port</span> <span class="o">=</span> <span class="n">OMAP_DMA_PORT_EMIFF</span><span class="p">;</span>
			<span class="n">dst_port</span> <span class="o">=</span> <span class="n">OMAP_DMA_PORT_TIPB</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP24XX_DMA_MMC1_TX</span><span class="p">;</span>

		<span class="n">omap_set_dma_dest_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">dst_port</span><span class="p">,</span>
					 <span class="n">OMAP_DMA_AMODE_CONSTANT</span><span class="p">,</span>
					 <span class="n">data_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_src_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">src_port</span><span class="p">,</span>
					<span class="n">OMAP_DMA_AMODE_POST_INC</span><span class="p">,</span>
					<span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap_set_dma_src_data_pack</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">omap_set_dma_src_burst_mode</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_BURST_4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Max limit for DMA frame count is 0xffff */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">omap_set_dma_transfer_params</span><span class="p">(</span><span class="n">dma_ch</span><span class="p">,</span> <span class="n">OMAP_DMA_DATA_TYPE_S16</span><span class="p">,</span>
				     <span class="n">frame</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">OMAP_DMA_SYNC_FRAME</span><span class="p">,</span>
				     <span class="n">sync_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* A scatterlist segment completed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_dma_cb</span><span class="p">(</span><span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ch_status</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">mmcdat</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span>
			<span class="s">&quot;DMA callback while DMA not enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME: We really should do something to _handle_ the errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_status</span> <span class="o">&amp;</span> <span class="n">OMAP1_DMA_TOUT_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span><span class="s">&quot;DMA timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_status</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_DROP_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;DMA sync error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch_status</span> <span class="o">&amp;</span> <span class="n">OMAP_DMA_BLOCK_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mmcdat</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_len</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_omap_prepare_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mmc_omap_dma_done</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_omap_get_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dma_dev_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync_dev</span><span class="p">,</span> <span class="n">dma_ch</span><span class="p">,</span> <span class="n">is_read</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">is_read</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_read</span> <span class="o">==</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_is_read</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">omap_free_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP_DMA_MMC_RX</span><span class="p">;</span>
			<span class="n">dma_dev_name</span> <span class="o">=</span> <span class="s">&quot;MMC1 read&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP_DMA_MMC2_RX</span><span class="p">;</span>
			<span class="n">dma_dev_name</span> <span class="o">=</span> <span class="s">&quot;MMC2 read&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP_DMA_MMC_TX</span><span class="p">;</span>
			<span class="n">dma_dev_name</span> <span class="o">=</span> <span class="s">&quot;MMC1 write&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sync_dev</span> <span class="o">=</span> <span class="n">OMAP_DMA_MMC2_TX</span><span class="p">;</span>
			<span class="n">dma_dev_name</span> <span class="o">=</span> <span class="s">&quot;MMC2 write&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">omap_request_dma</span><span class="p">(</span><span class="n">sync_dev</span><span class="p">,</span> <span class="n">dma_dev_name</span><span class="p">,</span> <span class="n">mmc_omap_dma_cb</span><span class="p">,</span>
			     <span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="s">&quot;omap_request_dma() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="n">dma_ch</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_is_read</span> <span class="o">=</span> <span class="n">is_read</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_cmd_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDIO</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDIO</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* Set maximum timeout */</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CTO</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_data_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">cycle_ns</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">cycle_ns</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">current_slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_ns</span> <span class="o">/</span> <span class="n">cycle_ns</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">+=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">timeout_clks</span><span class="p">;</span>

	<span class="cm">/* Check if we need to use timeout multiplier register */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">/=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDIO</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">DTO</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmc_omap_prepare_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">use_dma</span><span class="p">,</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sg_len</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">BLEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">NBLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_cmd_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">;</span>

	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">NBLK</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">BLEN</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_data_timeout</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/* cope with calling layer confusion; it issues &quot;single</span>
<span class="cm">	 * block&quot; writes using multi-block scatterlists.</span>
<span class="cm">	 */</span>
	<span class="n">sg_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">;</span>

	<span class="cm">/* Only do DMA for entire blocks */</span>
	<span class="n">use_dma</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sg_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">%</span> <span class="n">block_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_omap_get_dma_channel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dma_data_dir</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_DATA_WRITE</span><span class="p">)</span>
				<span class="n">dma_data_dir</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dma_data_dir</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

			<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
						<span class="n">sg_len</span><span class="p">,</span> <span class="n">dma_data_dir</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mmc_omap_prepare_dma</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">brs_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">use_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Revert to PIO? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">BUF</span><span class="p">,</span> <span class="mh">0x1f1f</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">total_bytes_left</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
		<span class="n">mmc_omap_sg_to_buf</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_start_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="cm">/* only touch fifo AFTER the controller readies it */</span>
	<span class="n">mmc_omap_prepare_data</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="n">mmc_omap_start_command</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_in_use</span><span class="p">)</span>
		<span class="n">omap_start_dma</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mmc_omap_select_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mmc_omap_start_request</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power_on</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">vdd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_power</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">),</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">power_on</span><span class="p">,</span>
					<span class="n">vdd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap24xx</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">power_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">);</span>
			<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">w</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">w</span> <span class="o">=</span> <span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">);</span>
			<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_omap_calc_divisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">func_clk_rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dsor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsor</span> <span class="o">=</span> <span class="n">func_clk_rate</span> <span class="o">/</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsor</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dsor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_clk_rate</span> <span class="o">/</span> <span class="n">dsor</span> <span class="o">&gt;</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="n">dsor</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsor</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">)</span>
		<span class="n">dsor</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">fclk_freq</span> <span class="o">=</span> <span class="n">func_clk_rate</span> <span class="o">/</span> <span class="n">dsor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_width</span> <span class="o">==</span> <span class="n">MMC_BUS_WIDTH_4</span><span class="p">)</span>
		<span class="n">dsor</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dsor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_set_ios</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_ios</span> <span class="o">*</span><span class="n">ios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dsor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk_enabled</span><span class="p">;</span>

	<span class="n">mmc_omap_select_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dsor</span> <span class="o">=</span> <span class="n">mmc_omap_calc_divisor</span><span class="p">(</span><span class="n">mmc</span><span class="p">,</span> <span class="n">ios</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">!=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">vdd</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">;</span>

	<span class="n">clk_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_POWER_OFF</span>:
		<span class="n">mmc_omap_set_power</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_POWER_UP</span>:
		<span class="cm">/* Cannot touch dsor yet, just power up MMC */</span>
		<span class="n">mmc_omap_set_power</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">vdd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_POWER_ON</span>:
		<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">clk_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dsor</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">!=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_bus_mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_bus_mode</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">mmc</span><span class="p">),</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
						  <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">);</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">bus_mode</span> <span class="o">=</span> <span class="n">ios</span><span class="o">-&gt;</span><span class="n">bus_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On insanely high arm_per frequencies something sometimes</span>
<span class="cm">	 * goes somehow out of sync, and the POW bit is not being set,</span>
<span class="cm">	 * which results in the while loop below getting stuck.</span>
<span class="cm">	 * Writing to the CON register twice seems to do the trick. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">dsor</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">saved_con</span> <span class="o">=</span> <span class="n">dsor</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">MMC_POWER_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* worst case at 400kHz, 80 cycles makes 200 microsecs */</span>
		<span class="kt">int</span> <span class="n">usecs</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

		<span class="cm">/* Send clock cycles, poll completion */</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">CMD</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">usecs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">OMAP_MMC_READ</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">usecs</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">OMAP_MMC_WRITE</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">STAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">mmc_omap_release_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">clk_enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_host_ops</span> <span class="n">mmc_omap_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">request</span>	<span class="o">=</span> <span class="n">mmc_omap_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ios</span>	<span class="o">=</span> <span class="n">mmc_omap_set_ios</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mmc_omap_new_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc_alloc_host</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span><span class="p">),</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">mmc_priv</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">mmc</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">wires</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_4_BIT_DATA</span><span class="p">;</span>

	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_omap_ops</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_min</span> <span class="o">=</span> <span class="mi">400000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_class_is_omap2</span><span class="p">())</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="mi">48000000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="mi">24000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">)</span>
		<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">max_freq</span><span class="p">,</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">f_max</span><span class="p">);</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">ocr_avail</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ocr_mask</span><span class="p">;</span>

	<span class="cm">/* Use scatterlist DMA to reduce per-transfer costs.</span>
<span class="cm">	 * NOTE max_seg_size assumption that small blocks aren&#39;t</span>
<span class="cm">	 * normally used (except e.g. for reading SD registers).</span>
<span class="cm">	 */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>	<span class="cm">/* BLEN is 11 bits (+1) */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>	<span class="cm">/* NBLK is 11 bits (+1) */</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_size</span> <span class="o">*</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>
	<span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_seg_size</span> <span class="o">=</span> <span class="n">mmc</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mmc_add_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_remove_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev_attr_slot_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cover_state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">dev_attr_cover_switch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_remove_slot_name</span><span class="p">;</span>

		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_timer</span><span class="p">,</span> <span class="n">mmc_omap_cover_timer</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_tasklet</span><span class="p">,</span> <span class="n">mmc_omap_cover_handler</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_remove_slot_name:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_slot_name</span><span class="p">);</span>
<span class="nl">err_remove_host:</span>
	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_omap_remove_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">mmc</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_slot_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_cover_state</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">class_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_cover_switch</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_tasklet</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cover_timer</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">);</span>

	<span class="n">mmc_remove_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
	<span class="n">mmc_free_host</span><span class="p">(</span><span class="n">mmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mmc_omap_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">omap_mmc_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_slots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_omap_host</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_release_work</span><span class="p">,</span> <span class="n">mmc_omap_slot_release_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">send_stop_work</span><span class="p">,</span> <span class="n">mmc_omap_send_stop_work</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_work</span><span class="p">,</span> <span class="n">mmc_omap_abort_command</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_abort_timer</span><span class="p">,</span> <span class="n">mmc_omap_cmd_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_lock</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">clk_timer</span><span class="p">,</span> <span class="n">mmc_omap_clk_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_lock</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">,</span> <span class="n">mmc_omap_dma_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slot_wq</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">dma_ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ick&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_mmc_host</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fck&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_iclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mmc_omap_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_fclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">reg_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpu_is_omap7xx</span><span class="p">()</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;mmc_omap&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_plat_cleanup</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_omap_new_slot</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mmc_omap_remove_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">goto</span> <span class="n">err_destroy_wq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_destroy_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">);</span>
<span class="nl">err_plat_cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
<span class="nl">err_free_fclk:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
<span class="nl">err_free_iclk:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
<span class="nl">err_free_mmc_host:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">err_free_mem_region:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">mmc_omap_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mmc_omap_remove_slot</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mmc_omap_fclk_enable</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">fclk</span><span class="p">);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iclk</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc_omap_wq</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_omap_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

		<span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_suspend_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_omap_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_omap_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">nr_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_omap_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_resume_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">host</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define mmc_omap_suspend	NULL</span>
<span class="cp">#define mmc_omap_resume		NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mmc_omap_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mmc_omap_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mmc_omap_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mmc_omap_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mmc_omap_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mmc_omap_driver</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OMAP Multimedia Card driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Juha Yrjölä&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
