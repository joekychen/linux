<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › host › sdhci-pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sdhci-pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*  linux/drivers/mmc/host/sdhci-pci.c - SDHCI on PCI bus interface</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005-2008 Pierre Ossman, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to the following companies for their support:</span>
<span class="cm"> *</span>
<span class="cm"> *     - JMicron (hardware and technical support)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdhci-pci-data.h&gt;</span>

<span class="cp">#include &quot;sdhci.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * PCI device IDs</span>
<span class="cm"> */</span>
<span class="cp">#define PCI_DEVICE_ID_INTEL_PCH_SDIO0	0x8809</span>
<span class="cp">#define PCI_DEVICE_ID_INTEL_PCH_SDIO1	0x880a</span>

<span class="cm">/*</span>
<span class="cm"> * PCI registers</span>
<span class="cm"> */</span>

<span class="cp">#define PCI_SDHCI_IFPIO			0x00</span>
<span class="cp">#define PCI_SDHCI_IFDMA			0x01</span>
<span class="cp">#define PCI_SDHCI_IFVENDOR		0x02</span>

<span class="cp">#define PCI_SLOT_INFO			0x40	</span><span class="cm">/* 8 bits */</span><span class="cp"></span>
<span class="cp">#define  PCI_SLOT_INFO_SLOTS(x)		((x &gt;&gt; 4) &amp; 7)</span>
<span class="cp">#define  PCI_SLOT_INFO_FIRST_BAR_MASK	0x07</span>

<span class="cp">#define MAX_SLOTS			8</span>

<span class="k">struct</span> <span class="n">sdhci_pci_chip</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sdhci_pci_slot</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">quirks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">quirks2</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">allow_runtime_pm</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="p">);</span>

	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">probe_slot</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">remove_slot</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span>	<span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_data</span>	<span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">pci_bar</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rst_n_gpio</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cd_gpio</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cd_irq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">quirks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">quirks2</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">allow_runtime_pm</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="o">*</span><span class="n">fixes</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">num_slots</span><span class="p">;</span>	<span class="cm">/* Slots on controller */</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span>	<span class="o">*</span><span class="n">slots</span><span class="p">[</span><span class="n">MAX_SLOTS</span><span class="p">];</span> <span class="cm">/* Pointers to host slots */</span>
<span class="p">};</span>


<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Hardware specific quirk handling                                          *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ricoh_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SAMSUNG</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SONY</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_NO_CARD_NO_RESET</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ricoh_mmc_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span>
		<span class="p">((</span><span class="mh">0x21</span> <span class="o">&lt;&lt;</span> <span class="n">SDHCI_TIMEOUT_CLK_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">SDHCI_TIMEOUT_CLK_MASK</span><span class="p">)</span> <span class="o">|</span>

		<span class="p">((</span><span class="mh">0x21</span> <span class="o">&lt;&lt;</span> <span class="n">SDHCI_CLOCK_BASE_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">SDHCI_CLOCK_BASE_MASK</span><span class="p">)</span> <span class="o">|</span>

		<span class="n">SDHCI_TIMEOUT_CLK_UNIT</span> <span class="o">|</span>
		<span class="n">SDHCI_CAN_VDD_330</span> <span class="o">|</span>
		<span class="n">SDHCI_CAN_DO_SDMA</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ricoh_mmc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Apply a delay to allow controller to settle */</span>
	<span class="cm">/* Otherwise it becomes confused if card state changed</span>
<span class="cm">		during suspend */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_ricoh</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ricoh_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_32BIT_DMA_ADDR</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_FORCE_DMA</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_CLOCK_BEFORE_RESET</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_ricoh_mmc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">ricoh_mmc_probe_slot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ricoh_mmc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_32BIT_DMA_ADDR</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_CLOCK_BEFORE_RESET</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_NO_CARD_NO_RESET</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_MISSING_CAPS</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_ene_712</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_SINGLE_POWER_WRITE</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_BROKEN_DMA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_ene_714</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_SINGLE_POWER_WRITE</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_RESET_CMD_DATA_ON_IOS</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_BROKEN_DMA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_cafe</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_NO_SIMULT_VDD_AND_POWER</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_NO_BUSY_IRQ</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_BROKEN_TIMEOUT_VAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrst_hc_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_8_BIT_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ADMA operation is disabled for Moorestown platform due to</span>
<span class="cm"> * hardware bugs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mrst_hc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * slots number is fixed here for MRST as SDIO3/5 are never used and</span>
<span class="cm">	 * have hardware bugs.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_hc_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_8_BIT_DATA</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdhci_pci_sd_cd</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>

	<span class="n">mmc_detect_change</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_pci_add_own_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">gpio</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="s">&quot;sd_cd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gpio_direction_input</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">gpio_to_irq</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdhci_pci_sd_cd</span><span class="p">,</span> <span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span>
			  <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span> <span class="s">&quot;sd_cd&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup card detect wake up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_pci_remove_own_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_irq</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sdhci_pci_add_own_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sdhci_pci_remove_own_cd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mfd_emmc_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_8_BIT_DATA</span> <span class="o">|</span> <span class="n">MMC_CAP_NONREMOVABLE</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps2</span> <span class="o">|=</span> <span class="n">MMC_CAP2_BOOTPART_NOACC</span> <span class="o">|</span>
				  <span class="n">MMC_CAP2_HC_ERASE_SZ</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mfd_sdio_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_POWER_OFF_CARD</span> <span class="o">|</span> <span class="n">MMC_CAP_NONREMOVABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_mrst_hc0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA</span> <span class="o">|</span> <span class="n">SDHCI_QUIRK_NO_HISPD_BIT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">mrst_hc_probe_slot</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_mrst_hc1_hc2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA</span> <span class="o">|</span> <span class="n">SDHCI_QUIRK_NO_HISPD_BIT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mrst_hc_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_mfd_sd</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">allow_runtime_pm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_mfd_sdio</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quirks2</span>	<span class="o">=</span> <span class="n">SDHCI_QUIRK2_HOST_OFF_CARD_ON</span><span class="p">,</span>
	<span class="p">.</span><span class="n">allow_runtime_pm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">mfd_sdio_probe_slot</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_mfd_emmc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">allow_runtime_pm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">mfd_emmc_probe_slot</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_intel_pch_sdio</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">pch_hc_probe_slot</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* O2Micro extra registers */</span>
<span class="cp">#define O2_SD_LOCK_WP		0xD3</span>
<span class="cp">#define O2_SD_MULTI_VCC3V	0xEE</span>
<span class="cp">#define O2_SD_CLKREQ		0xEC</span>
<span class="cp">#define O2_SD_CAPS		0xE0</span>
<span class="cp">#define O2_SD_ADMA1		0xE2</span>
<span class="cp">#define O2_SD_ADMA2		0xE7</span>
<span class="cp">#define O2_SD_INF_MOD		0xF1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">o2_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_O2_8220</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_O2_8221</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_O2_8320</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_O2_8321</span>:
		<span class="cm">/* This extra setup is required due to broken ADMA. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_LOCK_WP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_LOCK_WP</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>

		<span class="cm">/* Set Multi 3 to VCC3V# */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_MULTI_VCC3V</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="cm">/* Disable CLK_REQ# support after media DET */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_CLKREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_CLKREQ</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>

		<span class="cm">/* Choose capabilities, enable SDMA.  We have to write 0x01</span>
<span class="cm">		 * to the capabilities register first to unlock it.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_CAPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_CAPS</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_CAPS</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">);</span>

		<span class="cm">/* Disable ADMA1/2 */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_ADMA1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_ADMA2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

		<span class="cm">/* Disable the infinite transfer mode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_INF_MOD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_INF_MOD</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>

		<span class="cm">/* Lock WP */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_LOCK_WP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">O2_SD_LOCK_WP</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jmicron_pmos</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">scratch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn PMOS on [bit 0], set over current detection to 2.4 V</span>
<span class="cm">	 * [bit 1:2] and enable over current debouncing [bit 6].</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x47</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x47</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jmicron_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mmcdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_32BIT_DMA_ADDR</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_32BIT_DMA_SIZE</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_32BIT_ADMA_SIZE</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_RESET_AFTER_REQUEST</span> <span class="o">|</span>
			  <span class="n">SDHCI_QUIRK_BROKEN_SMALL_PIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * JMicron chips can have two interfaces to the same hardware</span>
<span class="cm">	 * in order to work around limitations in Microsoft&#39;s driver.</span>
<span class="cm">	 * We need to make sure we only bind to one of them.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This code assumes two things:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. The PCI code adds subfunctions in order.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 2. The MMC interface has a lower subfunction number</span>
<span class="cm">	 *    than the SD interface.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_SD</span><span class="p">)</span>
		<span class="n">mmcdev</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_SD</span><span class="p">)</span>
		<span class="n">mmcdev</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmcdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">sd_dev</span><span class="p">;</span>

		<span class="n">sd_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">sd_dev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span>
						<span class="n">mmcdev</span><span class="p">,</span> <span class="n">sd_dev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">sd_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">sd_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sd_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">sd_dev</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Refusing to bind to &quot;</span>
				<span class="s">&quot;secondary interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * JMicron chips need a bit of a nudge to enable the power</span>
<span class="cm">	 * output pins.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">jmicron_pmos</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failure enabling card power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* quirk for unsable RO-detection on JM388 chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_SD</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_UNSTABLE_RO_DETECT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jmicron_enable_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="n">scratch</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">scratch</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scratch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">scratch</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jmicron_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>

		<span class="n">version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SDHCI_HOST_VERSION</span><span class="p">);</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="n">SDHCI_VENDOR_VER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">SDHCI_VENDOR_VER_SHIFT</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Older versions of the chip have lots of nasty glitches</span>
<span class="cm">		 * in the ADMA engine. It&#39;s best just to avoid it</span>
<span class="cm">		 * completely.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mh">0xAC</span><span class="p">)</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_BROKEN_ADMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* JM388 MMC doesn&#39;t support 1.8V while SD supports it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_sd</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span> <span class="o">|</span>
			<span class="n">MMC_VDD_29_30</span> <span class="o">|</span> <span class="n">MMC_VDD_30_31</span> <span class="o">|</span>
			<span class="n">MMC_VDD_165_195</span><span class="p">;</span> <span class="cm">/* allow 1.8V */</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ocr_avail_mmc</span> <span class="o">=</span> <span class="n">MMC_VDD_32_33</span> <span class="o">|</span> <span class="n">MMC_VDD_33_34</span> <span class="o">|</span>
			<span class="n">MMC_VDD_29_30</span> <span class="o">|</span> <span class="n">MMC_VDD_30_31</span><span class="p">;</span> <span class="cm">/* no 1.8V for MMC */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The secondary interface requires a bit set to get the</span>
<span class="cm">	 * interrupts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span> <span class="o">||</span>
	    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span>
		<span class="n">jmicron_enable_mmc</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_BUS_WIDTH_TEST</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jmicron_remove_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dead</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span> <span class="o">||</span>
	    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span>
		<span class="n">jmicron_enable_mmc</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jmicron_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">jmicron_enable_mmc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">jmicron_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">jmicron_enable_mmc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">jmicron_pmos</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failure enabling card power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_o2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">o2_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_jmicron</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">jmicron_probe</span><span class="p">,</span>

	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">jmicron_probe_slot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_slot</span>	<span class="o">=</span> <span class="n">jmicron_remove_slot</span><span class="p">,</span>

	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">jmicron_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">jmicron_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* SysKonnect CardBus2SDIO extra registers */</span>
<span class="cp">#define SYSKT_CTRL		0x200</span>
<span class="cp">#define SYSKT_RDFIFO_STAT	0x204</span>
<span class="cp">#define SYSKT_WRFIFO_STAT	0x208</span>
<span class="cp">#define SYSKT_POWER_DATA	0x20c</span>
<span class="cp">#define   SYSKT_POWER_330	0xef</span>
<span class="cp">#define   SYSKT_POWER_300	0xf8</span>
<span class="cp">#define   SYSKT_POWER_184	0xcc</span>
<span class="cp">#define SYSKT_POWER_CMD		0x20d</span>
<span class="cp">#define   SYSKT_POWER_START	(1 &lt;&lt; 7)</span>
<span class="cp">#define SYSKT_POWER_STATUS	0x20e</span>
<span class="cp">#define   SYSKT_POWER_STATUS_OK	(1 &lt;&lt; 0)</span>
<span class="cp">#define SYSKT_BOARD_REV		0x210</span>
<span class="cp">#define SYSKT_CHIP_REV		0x211</span>
<span class="cp">#define SYSKT_CONF_DATA		0x212</span>
<span class="cp">#define   SYSKT_CONF_DATA_1V8	(1 &lt;&lt; 2)</span>
<span class="cp">#define   SYSKT_CONF_DATA_2V5	(1 &lt;&lt; 1)</span>
<span class="cp">#define   SYSKT_CONF_DATA_3V3	(1 &lt;&lt; 0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">syskt_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_SDHCI_IFVENDOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000FF</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">|=</span> <span class="n">PCI_SDHCI_IFDMA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">syskt_probe_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tm</span><span class="p">,</span> <span class="n">ps</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">board_rev</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_BOARD_REV</span><span class="p">);</span>
	<span class="n">u8</span>  <span class="n">chip_rev</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_CHIP_REV</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SysKonnect CardBus2SDIO, &quot;</span>
					 <span class="s">&quot;board rev %d.%d, chip rev %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">board_rev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">board_rev</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span>
					 <span class="n">chip_rev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>  <span class="n">chip_rev</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_rev</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_FORCE_DMA</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">SYSKT_POWER_330</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_POWER_DATA</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">SYSKT_POWER_START</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_POWER_CMD</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">tm</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  <span class="cm">/* Wait max 1 ms */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_POWER_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&amp;</span> <span class="n">SYSKT_POWER_STATUS_OK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;power regulator never stabilized&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SYSKT_POWER_CMD</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_syskt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quirks</span>		<span class="o">=</span> <span class="n">SDHCI_QUIRK_NO_SIMULT_VDD_AND_POWER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">syskt_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe_slot</span>	<span class="o">=</span> <span class="n">syskt_probe_slot</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">SDHCI_QUIRK_DELAY_AFTER_POWER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="n">sdhci_via</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">via_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pci_ids</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_RICOH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_RICOH_R5C822</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ricoh</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>         <span class="o">=</span> <span class="n">PCI_VENDOR_ID_RICOH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="mh">0x843</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ricoh_mmc</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>         <span class="o">=</span> <span class="n">PCI_VENDOR_ID_RICOH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="mh">0xe822</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ricoh_mmc</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>         <span class="o">=</span> <span class="n">PCI_VENDOR_ID_RICOH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="mh">0xe823</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ricoh_mmc</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENE_CB712_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ene_712</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENE_CB712_SD_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ene_712</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENE_CB714_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ene_714</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_ENE_CB714_SD_2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_ene_714</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>         <span class="o">=</span> <span class="n">PCI_VENDOR_ID_MARVELL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="n">PCI_DEVICE_ID_MARVELL_88ALP01_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>    <span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_cafe</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_jmicron</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB38X_MMC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_jmicron</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_jmicron</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMB388_ESD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_jmicron</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_syskt</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="mh">0x95d0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_via</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MRST_SD0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mrst_hc0</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MRST_SD1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mrst_hc1_hc2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MRST_SD2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mrst_hc1_hc2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MFD_SD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mfd_sd</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MFD_SDIO1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mfd_sdio</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MFD_SDIO2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mfd_sdio</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MFD_EMMC0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mfd_emmc</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_MFD_EMMC1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_mfd_emmc</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_PCH_SDIO0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_pch_sdio</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_INTEL_PCH_SDIO1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_intel_pch_sdio</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_O2_8120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_o2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_O2_8220</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_o2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_O2_8221</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_o2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_O2_8320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_o2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_O2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_O2_8321</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="p">(</span><span class="n">kernel_ulong_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sdhci_o2</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>	<span class="cm">/* Generic SD host controller */</span>
		<span class="n">PCI_DEVICE_CLASS</span><span class="p">((</span><span class="n">PCI_CLASS_SYSTEM_SDHCI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mh">0xFFFF00</span><span class="p">)</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="cm">/* end: all zeroes */</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_ids</span><span class="p">);</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * SDHCI core callbacks                                                      *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_enable_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">sdhci_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0xFFFF00</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">PCI_CLASS_SYSTEM_SDHCI</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_SDHCI_IFDMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDHCI_USE_SDMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Will use DMA mode even though HW &quot;</span>
			<span class="s">&quot;doesn&#39;t fully claim to support it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_8bit_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">sdhci_readb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_8</span>:
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_8BITBUS</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MMC_BUS_WIDTH_4</span>:
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDHCI_CTRL_8BITBUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SDHCI_CTRL_8BITBUS</span> <span class="o">|</span> <span class="n">SDHCI_CTRL_4BITBUS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdhci_writeb</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">SDHCI_HOST_CONTROL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_pci_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">sdhci_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rst_n_gpio</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">rst_n_gpio</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">rst_n_gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* For eMMC, minimum is 1us but give it 10us for good measure */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">rst_n_gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* For eMMC, minimum is 200us but give it 300us for good measure */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdhci_ops</span> <span class="n">sdhci_pci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enable_dma</span>	<span class="o">=</span> <span class="n">sdhci_pci_enable_dma</span><span class="p">,</span>
	<span class="p">.</span><span class="n">platform_8bit_width</span>	<span class="o">=</span> <span class="n">sdhci_pci_8bit_width</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>		<span class="o">=</span> <span class="n">sdhci_pci_hw_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Suspend/resume                                                            *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="n">mmc_pm_flag_t</span> <span class="n">slot_pm_flags</span><span class="p">;</span>
	<span class="n">mmc_pm_flag_t</span> <span class="n">pm_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_suspend_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_suspend</span><span class="p">;</span>

		<span class="n">slot_pm_flags</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot_pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_WAKE_SDIO_IRQ</span><span class="p">)</span>
			<span class="n">sdhci_enable_irq_wakeups</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

		<span class="n">pm_flags</span> <span class="o">|=</span> <span class="n">slot_pm_flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_suspend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_KEEP_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm_flags</span> <span class="o">&amp;</span> <span class="n">MMC_PM_WAKE_SDIO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_pme_active</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pci_suspend:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdhci_resume_host</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_resume_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define sdhci_pci_suspend NULL</span>
<span class="cp">#define sdhci_pci_resume NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_runtime_suspend_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_runtime_suspend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_runtime_suspend</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pci_runtime_suspend:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdhci_runtime_resume_host</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_runtime_resume_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdhci_pci_runtime_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define sdhci_pci_runtime_suspend	NULL</span>
<span class="cp">#define sdhci_pci_runtime_resume	NULL</span>
<span class="cp">#define sdhci_pci_runtime_idle		NULL</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">sdhci_pci_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sdhci_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">sdhci_pci_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span> <span class="o">=</span> <span class="n">sdhci_pci_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span> <span class="o">=</span> <span class="n">sdhci_pci_runtime_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_idle</span> <span class="o">=</span> <span class="n">sdhci_pci_runtime_idle</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Device probing/removal                                                    *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">sdhci_pci_probe_slot</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_bar</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">slotno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">first_bar</span> <span class="o">+</span> <span class="n">slotno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BAR %d is not iomem. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid iomem size. You may &quot;</span>
			<span class="s">&quot;experience problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_SDHCI_IFVENDOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Vendor specific interface. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PCI_SDHCI_IFVENDOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown interface. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">sdhci_alloc_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_CAST</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">sdhci_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">pci_bar</span> <span class="o">=</span> <span class="n">bar</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Retrieve platform data if there is any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sdhci_pci_get_data</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">sdhci_pci_get_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">slotno</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">;</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">cd_gpio</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cd_gpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">hw_name</span> <span class="o">=</span> <span class="s">&quot;PCI&quot;</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdhci_pci_ops</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">quirks2</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks2</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot request region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to remap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">probe_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">probe_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_request</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">,</span> <span class="s">&quot;eMMC_reset&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">MMC_CAP_HW_RESET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request rst_n_gpio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">mmc</span><span class="o">-&gt;</span><span class="n">pm_caps</span> <span class="o">=</span> <span class="n">MMC_PM_KEEP_POWER</span> <span class="o">|</span> <span class="n">MMC_PM_WAKE_SDIO_IRQ</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdhci_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>

	<span class="n">sdhci_pci_add_own_cd</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>

<span class="nl">remove:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">remove_slot</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">remove_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

<span class="nl">release:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

<span class="nl">free:</span>
	<span class="n">sdhci_free_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdhci_pci_remove_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dead</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scratch</span><span class="p">;</span>

	<span class="n">sdhci_pci_remove_own_cd</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>

	<span class="n">dead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scratch</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">SDHCI_INT_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scratch</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sdhci_remove_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">dead</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">))</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">rst_n_gpio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">remove_slot</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">remove_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">dead</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">pci_bar</span><span class="p">);</span>

	<span class="n">sdhci_free_host</span><span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">sdhci_pci_runtime_pm_allow</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_allow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
	<span class="n">pm_runtime_use_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_suspend_ignore_children</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sdhci_pci_runtime_pm_forbid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sdhci_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">slots</span><span class="p">,</span> <span class="n">first_bar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDHCI controller found [%04x:%04x] (rev %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_SLOT_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">slots</span> <span class="o">=</span> <span class="n">PCI_SLOT_INFO_SLOTS</span><span class="p">(</span><span class="n">slots</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found %d slot(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">slots</span> <span class="o">&gt;</span> <span class="n">MAX_SLOTS</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_SLOT_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_bar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">first_bar</span> <span class="o">&amp;=</span> <span class="n">PCI_SLOT_INFO_FIRST_BAR_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_bar</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid first BAR. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdhci_pci_chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sdhci_pci_fixes</span> <span class="o">*</span><span class="p">)</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">quirks2</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">quirks2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">allow_runtime_pm</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">allow_runtime_pm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span> <span class="o">=</span> <span class="n">slots</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fixes</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slots</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span>	<span class="cm">/* Quirk may have changed this */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">sdhci_pci_probe_slot</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">first_bar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">slot</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">sdhci_pci_remove_slot</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allow_runtime_pm</span><span class="p">)</span>
		<span class="n">sdhci_pci_runtime_pm_allow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sdhci_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdhci_pci_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">allow_runtime_pm</span><span class="p">)</span>
			<span class="n">sdhci_pci_runtime_pm_forbid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_slots</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sdhci_pci_remove_slot</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sdhci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;sdhci-pci&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">pci_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">sdhci_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">sdhci_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span>	<span class="p">{</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span>   <span class="o">&amp;</span><span class="n">sdhci_pci_pm_ops</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*****************************************************************************\</span>
<span class="cm"> *                                                                           *</span>
<span class="cm"> * Driver init/exit                                                          *</span>
<span class="cm"> *                                                                           *</span>
<span class="cm">\*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdhci_drv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdhci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sdhci_drv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdhci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sdhci_drv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sdhci_drv_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pierre Ossman &lt;pierre@ossman.eu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Secure Digital Host Controller Interface PCI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
