<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › card › sdio_uart.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sdio_uart.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/mmc/card/sdio_uart.c - SDIO UART/GPS driver</span>
<span class="cm"> *</span>
<span class="cm"> * Based on drivers/serial/8250.c and drivers/serial/serial_core.c</span>
<span class="cm"> * by Russell King.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Nicolas Pitre</span>
<span class="cm"> * Created:	June 15, 2007</span>
<span class="cm"> * Copyright:	MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Note: Although this driver assumes a 16550A-like UART implementation,</span>
<span class="cm"> * it is not possible to leverage the common 8250/16550 driver, nor the</span>
<span class="cm"> * core UART infrastructure, as they assumes direct access to the hardware</span>
<span class="cm"> * registers, often under a spinlock.  This is not possible in the SDIO</span>
<span class="cm"> * context as SDIO access functions must be able to sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Because we need to lock the SDIO host to ensure an exclusive access to</span>
<span class="cm"> * the card, we simply rely on that lock to also prevent and serialize</span>
<span class="cm"> * concurrent access to the same port.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/tty_flip.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/mmc/core.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_ids.h&gt;</span>


<span class="cp">#define UART_NR		8	</span><span class="cm">/* Number of UARTs this driver can handle */</span><span class="cp"></span>


<span class="cp">#define FIFO_SIZE	PAGE_SIZE</span>
<span class="cp">#define WAKEUP_CHARS	256</span>

<span class="k">struct</span> <span class="n">uart_icount</span> <span class="p">{</span>
	<span class="n">__u32</span>	<span class="n">cts</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">dsr</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">rng</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">dcd</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">rx</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">tx</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">frame</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">overrun</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">parity</span><span class="p">;</span>
	<span class="n">__u32</span>	<span class="n">brk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span>		<span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdio_func</span>	<span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">func_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">in_sdio_uart_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">regs_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kfifo</span>		<span class="n">xmit_fifo</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">write_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_icount</span>	<span class="n">icount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">uartclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rx_mctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">read_status_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">ignore_status_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">x_char</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>           <span class="n">ier</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>           <span class="n">lcr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">UART_NR</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_add_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="nf">sdio_uart_port_get</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">UART_NR</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_port_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_port_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">sdio_uart_port_destroy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_port_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">!=</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>
	<span class="n">sdio_uart_table</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_table_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re killing a port that potentially still is in use by</span>
<span class="cm">	 * the tty layer. Be careful to prevent any further access</span>
<span class="cm">	 * to the SDIO function and arrange for the tty layer to</span>
<span class="cm">	 * give up on that port ASAP.</span>
<span class="cm">	 * Beware: the lock ordering is critical.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* tty_hangup is async so is this safe as is ?? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sdio_release_irq</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_disable_func</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">sdio_uart_port_put</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_claim_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">in_sdio_uart_irq</span> <span class="o">!=</span> <span class="n">current</span><span class="p">))</span>
		<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sdio_uart_release_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">in_sdio_uart_irq</span> <span class="o">!=</span> <span class="n">current</span><span class="p">))</span>
		<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sdio_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">sdio_readb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">regs_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sdio_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdio_writeb</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">regs_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sdio_uart_get_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* FIXME: What stops this losing the delta bits and breaking</span>
<span class="cm">	   sdio_uart_check_modem_status ? */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CAR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_RNG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_DSR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">TIOCM_CTS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_write_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT1</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_OUT2</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_OUT2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mctrl</span> <span class="o">&amp;</span> <span class="n">TIOCM_LOOP</span><span class="p">)</span>
		<span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_LOOP</span><span class="p">;</span>

	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_MCR</span><span class="p">,</span> <span class="n">mcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sdio_uart_update_mctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clear</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">)</span>
		<span class="n">sdio_uart_write_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define sdio_uart_set_mctrl(port, x)	sdio_uart_update_mctrl(port, x, 0)</span>
<span class="cp">#define sdio_uart_clear_mctrl(port, x)	sdio_uart_update_mctrl(port, 0, x)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">termios</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cval</span><span class="p">,</span> <span class="n">fcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">quot</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">cval</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_STOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">tty_termios_baud_rate</span><span class="p">(</span><span class="n">termios</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>  <span class="cm">/* Special case: B0 rate. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Oops, the quotient was zero.  Try again with the old</span>
<span class="cm">		 * baud rate if possible, otherwise default to 9600.</span>
<span class="cm">		 */</span>
		<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">;</span>
			<span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="n">B9600</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">quot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">+</span> <span class="n">baud</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">baud</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&lt;</span> <span class="mi">2400</span><span class="p">)</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span> <span class="n">UART_FCR_TRIGGER_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span> <span class="n">UART_FCR_R_TRIG_10</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">=</span> <span class="n">UART_LSR_OE</span> <span class="o">|</span> <span class="n">UART_LSR_THRE</span> <span class="o">|</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">INPCK</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">PARMRK</span><span class="p">))</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Characters to ignore</span>
<span class="cm">	 */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span> <span class="n">UART_LSR_FE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNBRK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_BI</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re ignoring parity and break indicators,</span>
<span class="cm">		 * ignore overruns too (for real raw support).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_iflag</span> <span class="o">&amp;</span> <span class="n">IGNPAR</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_OE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore all characters if CREAD is not set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CREAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">|=</span> <span class="n">UART_LSR_DR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CTS flow control flag and modem status interrupts</span>
<span class="cm">	 */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_MSI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">))</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="n">UART_IER_MSI</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">=</span> <span class="n">cval</span><span class="p">;</span>

	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span> <span class="o">|</span> <span class="n">UART_LCR_DLAB</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_DLL</span><span class="p">,</span> <span class="n">quot</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_DLM</span><span class="p">,</span> <span class="n">quot</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>

	<span class="n">sdio_uart_write_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">|=</span> <span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_THRI</span><span class="p">;</span>
		<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_stop_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_IER_RLSI</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_DR</span><span class="p">;</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_receive_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_NORMAL</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UART_LSR_BI</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span> <span class="o">|</span>
					<span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_OE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For statistics only</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_LSR_FE</span> <span class="o">|</span> <span class="n">UART_LSR_PE</span><span class="p">);</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Mask off conditions which should be ignored.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">read_status_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_BI</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_BREAK</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_PE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_PARITY</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_FE</span><span class="p">)</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">TTY_FRAME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UART_LSR_OE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Overrun is special.  Since it&#39;s reported immediately,</span>
<span class="cm">		 * it doesn&#39;t affect the current character.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ignore_status_mask</span> <span class="o">&amp;</span> <span class="n">UART_LSR_OE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TTY_OVERRUN</span><span class="p">);</span>

		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max_count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_transmit_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kfifo</span> <span class="o">*</span><span class="n">xmit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iobuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">kfifo_len</span><span class="p">(</span><span class="n">xmit</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">tty</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">||</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdio_uart_stop_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">kfifo_out_locked</span><span class="p">(</span><span class="n">xmit</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_TX</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="n">xmit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">WAKEUP_CHARS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sdio_uart_stop_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_check_modem_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_ANY_DELTA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_TERI</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDSR</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DDCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* DCD raise - wake for open */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DCD drop - hang up if tty attached */</span>
			<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tty_hangup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">tty_port_tty_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cts</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cts</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cts</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">sdio_uart_stop_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tty_kref_put</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This handles the interrupt from one port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">sdio_get_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iir</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In a few places sdio_uart_irq() is called directly instead of</span>
<span class="cm">	 * waiting for the actual interrupt to be raised and the SDIO IRQ</span>
<span class="cm">	 * thread scheduled in order to reduce latency.  However, some</span>
<span class="cm">	 * interaction with the tty core may end up calling us back</span>
<span class="cm">	 * (serial echo, flow control, etc.) through those same places</span>
<span class="cm">	 * causing undesirable effects.  Let&#39;s stop the recursion here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">in_sdio_uart_irq</span> <span class="o">==</span> <span class="n">current</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iir</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">UART_IIR_NO_INT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">in_sdio_uart_irq</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">lsr</span> <span class="o">=</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">)</span>
		<span class="n">sdio_uart_receive_chars</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsr</span><span class="p">);</span>
	<span class="n">sdio_uart_check_modem_status</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">)</span>
		<span class="n">sdio_uart_transmit_chars</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">in_sdio_uart_irq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uart_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>	<span class="cm">/* Missing hardware shouldn&#39;t block for carrier */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_get_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">TIOCM_CAR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	uart_dtr_rts		-	 port helper to set uart signals</span>
<span class="cm"> *	@tport: tty port to be updated</span>
<span class="cm"> *	@onoff: set to turn on DTR/RTS</span>
<span class="cm"> *</span>
<span class="cm"> *	Called by the tty port helpers when the modem signals need to be</span>
<span class="cm"> *	adjusted during an open, close and hangup.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uart_dtr_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sdio_uart_clear_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdio_uart_set_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_DTR</span> <span class="o">|</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>
	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sdio_uart_activate	-	start up hardware</span>
<span class="cm"> *	@tport: tty port to activate</span>
<span class="cm"> *	@tty: tty bound to this port</span>
<span class="cm"> *</span>
<span class="cm"> *	Activate a tty port. The port locking guarantees us this will be</span>
<span class="cm"> *	run exactly once per set of opens, and if successful will see the</span>
<span class="cm"> *	shutdown method run exactly once to match. Start up and shutdown are</span>
<span class="cm"> *	protected from each other by the internal locking and will not run</span>
<span class="cm"> *	at the same time even during a hangup event.</span>
<span class="cm"> *</span>
<span class="cm"> *	If we successfully start up the port we take an extra kref as we</span>
<span class="cm"> *	will keep it around until shutdown when the kref is dropped.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the TTY IO error marker - we will only clear this</span>
<span class="cm">	 * once we have successfully opened the port.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">kfifo_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_enable_func</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_claim_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">sdio_uart_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the FIFO buffers and disable them.</span>
<span class="cm">	 * (they will be reenabled in sdio_change_speed())</span>
<span class="cm">	 */</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span>
		       <span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span> <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LSR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_RX</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IIR</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">sdio_in</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_MSR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">UART_LCR_WLEN8</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">UART_IER_RLSI</span><span class="o">|</span><span class="n">UART_IER_RDI</span><span class="o">|</span><span class="n">UART_IER_RTOIE</span><span class="o">|</span><span class="n">UART_IER_UUE</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">=</span> <span class="n">TIOCM_OUT2</span><span class="p">;</span>

	<span class="n">sdio_uart_change_speed</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span>
		<span class="n">sdio_uart_set_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdio_uart_get_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Kick the IRQ handler once while we&#39;re still holding the host lock */</span>
	<span class="n">sdio_uart_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>

	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">sdio_disable_func</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sdio_uart_shutdown	-	stop hardware</span>
<span class="cm"> *	@tport: tty port to shut down</span>
<span class="cm"> *</span>
<span class="cm"> *	Deactivate a tty port. The port locking guarantees us this will be</span>
<span class="cm"> *	run only if a successful matching activate already ran. The two are</span>
<span class="cm"> *	protected from each other by the internal locking and will not run</span>
<span class="cm"> *	at the same time even during a hangup event.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">tport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">tport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdio_uart_stop_rx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts from this port */</span>
	<span class="n">sdio_release_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_IER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sdio_uart_clear_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_OUT2</span><span class="p">);</span>

	<span class="cm">/* Disable break condition and FIFOs. */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="n">UART_FCR_ENABLE_FIFO</span> <span class="o">|</span>
				 <span class="n">UART_FCR_CLEAR_RCVR</span> <span class="o">|</span>
				 <span class="n">UART_FCR_CLEAR_XMIT</span><span class="p">);</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_FCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sdio_disable_func</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>

	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sdio_uart_install	-	install method</span>
<span class="cm"> *	@driver: the driver in use (sdio_uart in our case)</span>
<span class="cm"> *	@tty: the tty being bound</span>
<span class="cm"> *</span>
<span class="cm"> *	Look up and bind the tty and the driver together. Initialize</span>
<span class="cm"> *	any needed private data (in our case the termios)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">sdio_uart_port_get</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">tty_standard_install</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* This is the ref sdio_uart_port get provided */</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sdio_uart_port_put</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sdio_uart_cleanup	-	called on the last tty kref drop</span>
<span class="cm"> *	@tty: the tty being destroyed</span>
<span class="cm"> *</span>
<span class="cm"> *	Called asynchronously when the last reference to the tty is dropped.</span>
<span class="cm"> *	We cannot destroy the tty-&gt;driver_data port kref until this point</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* Bug trap */</span>
	<span class="n">sdio_uart_port_put</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Open/close/hangup is now entirely boilerplate</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tty_port_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">tty_port_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">tty_port_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">write_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">sdio_uart_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
			<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">FIFO_SIZE</span> <span class="o">-</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">xmit_fifo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_send_xchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">&amp;</span> <span class="n">UART_IER_THRI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">sdio_uart_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
		<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">sdio_uart_clear_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>

	<span class="n">sdio_uart_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span>
		<span class="n">sdio_uart_set_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_RTS</span><span class="p">);</span>

	<span class="n">sdio_uart_irq</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cflag</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sdio_uart_change_speed</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">,</span> <span class="n">old_termios</span><span class="p">);</span>

	<span class="cm">/* Handle transition to B0 status */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span>
		<span class="n">sdio_uart_clear_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TIOCM_RTS</span> <span class="o">|</span> <span class="n">TIOCM_DTR</span><span class="p">);</span>

	<span class="cm">/* Handle transition away from B0 status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">TIOCM_DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TTY_THROTTLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">TIOCM_RTS</span><span class="p">;</span>
		<span class="n">sdio_uart_set_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning off CRTSCTS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sdio_uart_start_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Handle turning on CRTSCTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sdio_uart_get_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TIOCM_CTS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sdio_uart_stop_tx</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_break_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">break_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">break_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">|=</span> <span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LCR_SBC</span><span class="p">;</span>
	<span class="n">sdio_out</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">UART_LCR</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">lcr</span><span class="p">);</span>

	<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mctrl</span> <span class="o">|</span> <span class="n">sdio_uart_get_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sdio_uart_claim_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdio_uart_update_mctrl</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
		<span class="n">sdio_uart_release_func</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;serinfo:1.0 driver%s%s revision:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UART_NR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">sdio_uart_port_get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d: uart:SDIO&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; tx:%d rx:%d&quot;</span><span class="p">,</span>
					      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; fe:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">frame</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; pe:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">parity</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; brk:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">brk</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; oe:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">overrun</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; cts:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">cts</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dsr:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dsr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; rng:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">rng</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; dcd:%d&quot;</span><span class="p">,</span>
						      <span class="n">port</span><span class="o">-&gt;</span><span class="n">icount</span><span class="p">.</span><span class="n">dcd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sdio_uart_port_put</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sdio_uart_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sdio_uart_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sdio_uart_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">sdio_uart_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dtr_rts</span> <span class="o">=</span> <span class="n">uart_dtr_rts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">uart_carrier_raised</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">sdio_uart_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">sdio_uart_activate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">sdio_uart_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">sdio_uart_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">sdio_uart_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">sdio_uart_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span>		<span class="o">=</span> <span class="n">sdio_uart_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span>	<span class="o">=</span> <span class="n">sdio_uart_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_xchar</span>		<span class="o">=</span> <span class="n">sdio_uart_send_xchar</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span>		<span class="o">=</span> <span class="n">sdio_uart_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span>		<span class="o">=</span> <span class="n">sdio_uart_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>		<span class="o">=</span> <span class="n">sdio_uart_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span>			<span class="o">=</span> <span class="n">sdio_uart_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">break_ctl</span>		<span class="o">=</span> <span class="n">sdio_uart_break_ctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span>		<span class="o">=</span> <span class="n">sdio_uart_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span>		<span class="o">=</span> <span class="n">sdio_uart_tiocmset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">install</span>		<span class="o">=</span> <span class="n">sdio_uart_install</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>		<span class="o">=</span> <span class="n">sdio_uart_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdio_uart_proc_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">sdio_uart_tty_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdio_uart_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_uart_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">SDIO_CLASS_UART</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: need info on UART class basic setup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">SDIO_CLASS_GPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We need tuple 0x91.  It contains SUBTPL_SIOREG</span>
<span class="cm">		 * and SUBTPL_RCVCAPS.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">sdio_func_tuple</span> <span class="o">*</span><span class="n">tpl</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tpl</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">tuples</span><span class="p">;</span> <span class="n">tpl</span><span class="p">;</span> <span class="n">tpl</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="mh">0x91</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* SUBTPL_SIOREG */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span>
       <span class="s">&quot;%s: can&#39;t find tuple 0x91 subtuple 0 (SUBTPL_SIOREG) for GPS class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Register ID = 0x%02x, Exp ID = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">regs_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: regs offset = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">regs_offset</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="mi">115200</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: clk %d baudcode %u 4800-div %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">uartclk</span><span class="p">,</span>
		       <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">tpl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">sdio_set_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdio_uart_port_ops</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_uart_add_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">tty_register_device</span><span class="p">(</span><span class="n">sdio_uart_tty_driver</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sdio_uart_port_remove</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdio_uart_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdio_uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">sdio_get_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">tty_unregister_device</span><span class="p">(</span><span class="n">sdio_uart_tty_driver</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">sdio_uart_port_remove</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="n">sdio_uart_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SDIO_DEVICE_CLASS</span><span class="p">(</span><span class="n">SDIO_CLASS_UART</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="n">SDIO_DEVICE_CLASS</span><span class="p">(</span><span class="n">SDIO_CLASS_GPS</span><span class="p">)</span>		<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end: all zeroes */</span>				<span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">sdio</span><span class="p">,</span> <span class="n">sdio_uart_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdio_driver</span> <span class="n">sdio_uart_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sdio_uart_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sdio_uart_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sdio_uart&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sdio_uart_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sdio_uart_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_driver</span> <span class="o">*</span><span class="n">tty_drv</span><span class="p">;</span>

	<span class="n">sdio_uart_tty_driver</span> <span class="o">=</span> <span class="n">tty_drv</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">UART_NR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty_drv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;sdio_uart&quot;</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span>   <span class="s">&quot;ttySDIO&quot;</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* dynamically allocated */</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B4800</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ispeed</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
	<span class="n">tty_drv</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_ospeed</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">tty_drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdio_uart_ops</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">tty_drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">tty_drv</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">tty_drv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sdio_uart_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdio_uart_driver</span><span class="p">);</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">sdio_uart_tty_driver</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">sdio_uart_tty_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sdio_uart_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sdio_uart_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nicolas Pitre&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
