<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › card › block.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>block.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Block driver for media (i.e., flash cards)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2002 Hewlett-Packard Company</span>
<span class="cm"> * Copyright 2005-2008 Pierre Ossman</span>
<span class="cm"> *</span>
<span class="cm"> * Use consistent with the GNU GPL is permitted,</span>
<span class="cm"> * provided that this copyright notice is</span>
<span class="cm"> * preserved in its entirety in all copies and derived works.</span>
<span class="cm"> *</span>
<span class="cm"> * HEWLETT-PACKARD COMPANY MAKES NO WARRANTIES, EXPRESSED OR IMPLIED,</span>
<span class="cm"> * AS TO THE USEFULNESS OR CORRECTNESS OF THIS CODE OR ITS</span>
<span class="cm"> * FITNESS FOR ANY PARTICULAR PURPOSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Many thanks to Alessandro Rubini and Jonathan Corbet!</span>
<span class="cm"> *</span>
<span class="cm"> * Author:  Andrew Christian</span>
<span class="cm"> *          28 May 2002</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/hdreg.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/string_helpers.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;linux/mmc/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sd.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;queue.h&quot;</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;mmc:block&quot;</span><span class="p">);</span>
<span class="cp">#ifdef MODULE_PARAM_PREFIX</span>
<span class="cp">#undef MODULE_PARAM_PREFIX</span>
<span class="cp">#endif</span>
<span class="cp">#define MODULE_PARAM_PREFIX &quot;mmcblk.&quot;</span>

<span class="cp">#define INAND_CMD38_ARG_EXT_CSD  113</span>
<span class="cp">#define INAND_CMD38_ARG_ERASE    0x00</span>
<span class="cp">#define INAND_CMD38_ARG_TRIM     0x01</span>
<span class="cp">#define INAND_CMD38_ARG_SECERASE 0x80</span>
<span class="cp">#define INAND_CMD38_ARG_SECTRIM1 0x81</span>
<span class="cp">#define INAND_CMD38_ARG_SECTRIM2 0x88</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">block_mutex</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The defaults come from config options but can be overriden by module</span>
<span class="cm"> * or bootarg options.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">perdev_minors</span> <span class="o">=</span> <span class="n">CONFIG_MMC_BLOCK_MINORS</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;ve only got one major, so number of mmcblk devices is</span>
<span class="cm"> * limited to 256 / number of minors per device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_devices</span><span class="p">;</span>

<span class="cm">/* 256 minors, so at most 256 separate devices */</span>
<span class="k">static</span> <span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">dev_use</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">name_use</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * There is one mmc_blk_data per slot.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gendisk</span>	<span class="o">*</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_queue</span> <span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">part</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define MMC_BLK_CMD23	(1 &lt;&lt; 0)	</span><span class="cm">/* Can do SET_BLOCK_COUNT for multiblock */</span><span class="cp"></span>
<span class="cp">#define MMC_BLK_REL_WR	(1 &lt;&lt; 1)	</span><span class="cm">/* MMC Reliable write support */</span><span class="cp"></span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">usage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">read_only</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">part_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">name_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">reset_done</span><span class="p">;</span>
<span class="cp">#define MMC_BLK_READ		BIT(0)</span>
<span class="cp">#define MMC_BLK_WRITE		BIT(1)</span>
<span class="cp">#define MMC_BLK_DISCARD		BIT(2)</span>
<span class="cp">#define MMC_BLK_SECDISCARD	BIT(3)</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only set in main mmc_blk_data associated</span>
<span class="cm">	 * with mmc_card with mmc_set_drvdata, and keeps</span>
<span class="cm">	 * track of the current selected device partition.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">part_curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">force_ro</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">power_ro_lock</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">area_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">open_lock</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">mmc_blk_status</span> <span class="p">{</span>
	<span class="n">MMC_BLK_SUCCESS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MMC_BLK_PARTIAL</span><span class="p">,</span>
	<span class="n">MMC_BLK_CMD_ERR</span><span class="p">,</span>
	<span class="n">MMC_BLK_RETRY</span><span class="p">,</span>
	<span class="n">MMC_BLK_ABORT</span><span class="p">,</span>
	<span class="n">MMC_BLK_DATA_ERR</span><span class="p">,</span>
	<span class="n">MMC_BLK_ECC_ERR</span><span class="p">,</span>
	<span class="n">MMC_BLK_NOMEDIUM</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">perdev_minors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">perdev_minors</span><span class="p">,</span> <span class="s">&quot;Minors numbers to allocate per device&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="nf">mmc_blk_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">md</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span> <span class="o">&amp;&amp;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">md</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">md</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mmc_get_devidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">devmaj</span> <span class="o">=</span> <span class="n">MAJOR</span><span class="p">(</span><span class="n">disk_devt</span><span class="p">(</span><span class="n">disk</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">devidx</span> <span class="o">=</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">disk_devt</span><span class="p">(</span><span class="n">disk</span><span class="p">))</span> <span class="o">/</span> <span class="n">perdev_minors</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devmaj</span><span class="p">)</span>
		<span class="n">devidx</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">/</span> <span class="n">perdev_minors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">devidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_blk_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">devidx</span> <span class="o">=</span> <span class="n">mmc_get_devidx</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
		<span class="n">blk_cleanup_queue</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">devidx</span><span class="p">,</span> <span class="n">dev_use</span><span class="p">);</span>

		<span class="n">put_disk</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">open_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">power_ro_lock_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lock</span> <span class="o">&amp;</span> <span class="n">EXT_CSD_BOOT_WP_B_PERM_WP_EN</span><span class="p">)</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lock</span> <span class="o">&amp;</span> <span class="n">EXT_CSD_BOOT_WP_B_PWR_WP_EN</span><span class="p">)</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">locked</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">power_ro_lock_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span> <span class="n">EXT_CSD_BOOT_WP</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lock</span> <span class="o">|</span>
				<span class="n">EXT_CSD_BOOT_WP_B_PWR_WP_EN</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">part_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Locking boot partition ro until next power on failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lock</span> <span class="o">|=</span> <span class="n">EXT_CSD_BOOT_WP_B_PWR_WP_EN</span><span class="p">;</span>

	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Locking boot partition ro until next power on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
		<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">part_md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">area_type</span> <span class="o">==</span> <span class="n">MMC_BLK_DATA_AREA_BOOT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Locking boot partition ro until next power on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">part_md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
				<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">force_ro_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
		       <span class="n">get_disk_ro</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">^</span>
		       <span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">);</span>
	<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">force_ro_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">dev_to_disk</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">set</span> <span class="o">||</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">check_disk_change</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EROFS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">gendisk</span> <span class="o">*</span><span class="n">disk</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mutex</span><span class="p">);</span>
	<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mmc_blk_getgeo</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hd_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">cylinders</span> <span class="o">=</span> <span class="n">get_capacity</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">heads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mmc_blk_ioc_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">ic</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">buf_bytes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_blk_ioc_data</span> <span class="o">*</span><span class="nf">mmc_blk_ioctl_copy_from_user</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_ioc_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">idata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idata_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">blksz</span> <span class="o">*</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span> <span class="o">&gt;</span> <span class="n">MMC_IOC_MAX_BYTES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idata_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">idata</span><span class="p">;</span>

	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">idata_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
					<span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">data_ptr</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">copy_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">idata</span><span class="p">;</span>

<span class="nl">copy_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="nl">idata_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_ioctl_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ic_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_ioc_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The caller must have CAP_SYS_RAWIO, and must be calling this on the</span>
<span class="cm">	 * whole block device, not on a partition.  This prevents overspray</span>
<span class="cm">	 * between sibling partitions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">bdev</span> <span class="o">!=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_contains</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">idata</span> <span class="o">=</span> <span class="n">mmc_blk_ioctl_copy_from_user</span><span class="p">(</span><span class="n">ic_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">idata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_get</span><span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bd_disk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cmd_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cmd_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">blksz</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>

		<span class="n">sg_init_one</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">write_flag</span><span class="p">)</span>
			<span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_DATA_WRITE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_DATA_READ</span><span class="p">;</span>

		<span class="cm">/* data.flags must already be set before doing this. */</span>
		<span class="n">mmc_set_data_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

		<span class="cm">/* Allow overriding the timeout_ns for empirical tuning. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">data_timeout_ns</span><span class="p">)</span>
			<span class="n">data</span><span class="p">.</span><span class="n">timeout_ns</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">data_timeout_ns</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_RSP_R1B</span><span class="p">)</span> <span class="o">==</span> <span class="n">MMC_RSP_R1B</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Pretend this is a data transfer and rely on the</span>
<span class="cm">			 * host driver to compute timeout.  When all host</span>
<span class="cm">			 * drivers support cmd.cmd_timeout for R1B, this</span>
<span class="cm">			 * can be changed to:</span>
<span class="cm">			 *</span>
<span class="cm">			 *     mrq.data = NULL;</span>
<span class="cm">			 *     cmd.cmd_timeout = idata-&gt;ic.cmd_timeout_ms;</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="p">.</span><span class="n">timeout_ns</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">cmd_timeout_ms</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">is_acmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_app_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cmd_rel_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc_wait_for_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="s">&quot;%s: cmd error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cmd_rel_host</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">mmc_dev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="s">&quot;%s: data error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cmd_rel_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to the SD specs, some commands require a delay after</span>
<span class="cm">	 * issuing the command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">postsleep_min_us</span><span class="p">)</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">postsleep_min_us</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">postsleep_max_us</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ic_ptr</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">),</span> <span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cmd_rel_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">write_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">ic</span><span class="p">.</span><span class="n">data_ptr</span><span class="p">,</span>
						<span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf_bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cmd_rel_host</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">cmd_rel_host:</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

<span class="nl">cmd_done:</span>
	<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
<span class="nl">cmd_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MMC_IOC_CMD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_ioctl_cmd</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_ioc_cmd</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_blk_ioctl</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">block_device_operations</span> <span class="n">mmc_bdops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">mmc_blk_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">mmc_blk_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getgeo</span>			<span class="o">=</span> <span class="n">mmc_blk_getgeo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">mmc_blk_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>		<span class="o">=</span> <span class="n">mmc_blk_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mmc_blk_part_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">main_md</span> <span class="o">=</span> <span class="n">mmc_get_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">main_md</span><span class="o">-&gt;</span><span class="n">part_curr</span> <span class="o">==</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">part_config</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">part_config</span><span class="p">;</span>

		<span class="n">part_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EXT_CSD_PART_CONFIG_ACC_MASK</span><span class="p">;</span>
		<span class="n">part_config</span> <span class="o">|=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span>
				 <span class="n">EXT_CSD_PART_CONFIG</span><span class="p">,</span> <span class="n">part_config</span><span class="p">,</span>
				 <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">part_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">part_config</span> <span class="o">=</span> <span class="n">part_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">main_md</span><span class="o">-&gt;</span><span class="n">part_curr</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mmc_sd_num_wr_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">blocks</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_APP_CMD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R1</span> <span class="o">|</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">R1_APP_CMD</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">SD_APP_SEND_NUM_WR_BLKS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R1</span> <span class="o">|</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>

	<span class="n">data</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_DATA_READ</span><span class="p">;</span>
	<span class="n">data</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mmc_set_data_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">blocks</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocks</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">mmc_wait_for_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">blocks</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blocks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_STOP_TRANSMISSION</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R1B</span> <span class="o">|</span> <span class="n">MMC_RSP_R1B</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_card_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SEND_STATUS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R2</span> <span class="o">|</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">retries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ERR_NOMEDIUM	3</span>
<span class="cp">#define ERR_RETRY	2</span>
<span class="cp">#define ERR_ABORT	1</span>
<span class="cp">#define ERR_CONTINUE	0</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_cmd_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">status_valid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
		<span class="cm">/* response crc error, retry the r/w cmd */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s sending %s command, card status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;response CRC error&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_RETRY</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ETIMEDOUT</span>:
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s sending %s command, card status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="s">&quot;timed out&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* If the status cmd initially failed, retry the r/w cmd */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_valid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_RETRY</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it was a r/w cmd crc error, or illegal command</span>
<span class="cm">		 * (eg, issued in wrong state) then retry - we should</span>
<span class="cm">		 * have corrected the state problem above.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">R1_COM_CRC_ERROR</span> <span class="o">|</span> <span class="n">R1_ILLEGAL_COMMAND</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_RETRY</span><span class="p">;</span>

		<span class="cm">/* Otherwise abort the command */</span>
		<span class="k">return</span> <span class="n">ERR_ABORT</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* We don&#39;t understand the error code the driver gave us */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unknown error %d sending read/write command, card status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_ABORT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initial r/w and stop cmd error recovery.</span>
<span class="cm"> * We don&#39;t know whether the card received the r/w cmd or not, so try to</span>
<span class="cm"> * restore things back to a sane state.  Essentially, we do this as follows:</span>
<span class="cm"> * - Obtain card status.  If the first attempt to obtain card status fails,</span>
<span class="cm"> *   the status word will reflect the failed status cmd, not the failed</span>
<span class="cm"> *   r/w cmd.  If we fail to obtain card status, it suggests we can no</span>
<span class="cm"> *   longer communicate with the card.</span>
<span class="cm"> * - Check the card state.  If the card received the cmd but there was a</span>
<span class="cm"> *   transient problem with the response, it might still be in a data transfer</span>
<span class="cm"> *   mode.  Try to send it a stop command.  If this fails, we can&#39;t recover.</span>
<span class="cm"> * - If the r/w cmd failed due to a response CRC error, it was probably</span>
<span class="cm"> *   transient, so retry the cmd.</span>
<span class="cm"> * - If the r/w cmd timed out, but we didn&#39;t get the r/w cmd status, retry.</span>
<span class="cm"> * - If the r/w cmd timed out, and the r/w cmd failed due to CRC error or</span>
<span class="cm"> *   illegal cmd, retry.</span>
<span class="cm"> * Otherwise we don&#39;t understand what happened, so abort.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_cmd_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ecc_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">prev_cmd_status_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">stop_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_removed</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_NOMEDIUM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to get card status which indicates both the card state</span>
<span class="cm">	 * and why there was no response.  If the first attempt fails,</span>
<span class="cm">	 * we can&#39;t be sure the returned status is for the r/w command.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_card_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">prev_cmd_status_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d sending status command, %sing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">retry</span> <span class="o">?</span> <span class="s">&quot;retry&quot;</span> <span class="o">:</span> <span class="s">&quot;abort&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We couldn&#39;t get a response from the card.  Give up. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if the card is removed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_detect_card_removed</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERR_NOMEDIUM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_ABORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Flag ECC errors */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">R1_CARD_ECC_FAILED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">R1_CARD_ECC_FAILED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">R1_CARD_ECC_FAILED</span><span class="p">))</span>
		<span class="o">*</span><span class="n">ecc_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the current card state.  If it is in some data transfer</span>
<span class="cm">	 * mode, tell it to stop (and hopefully transition back to TRAN.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">R1_CURRENT_STATE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">R1_STATE_DATA</span> <span class="o">||</span>
	    <span class="n">R1_CURRENT_STATE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">R1_STATE_RCV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">send_stop</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d sending stop command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the stop cmd also timed out, the card is probably</span>
<span class="cm">		 * not present, so abort.  Other errors are bad news too.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERR_ABORT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stop_status</span> <span class="o">&amp;</span> <span class="n">R1_CARD_ECC_FAILED</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ecc_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for set block count errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mmc_blk_cmd_error</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s">&quot;SET_BLOCK_COUNT&quot;</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
				<span class="n">prev_cmd_status_valid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Check for r/w command errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mmc_blk_cmd_error</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s">&quot;r/w cmd&quot;</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
				<span class="n">prev_cmd_status_valid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Data errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_CONTINUE</span><span class="p">;</span>

	<span class="cm">/* Now for stop errors.  These aren&#39;t fatal to the transfer. */</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d sending stop command, original cmd response %#x, card status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
	       <span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Subsitute in our own stop status as this will give the error</span>
<span class="cm">	 * state which happened during the execution of the r/w command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_status</span><span class="p">;</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERR_CONTINUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">reset_done</span> <span class="o">&amp;</span> <span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">reset_done</span> <span class="o">|=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_hw_reset</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="cm">/* Ensure we switch back to the correct partition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">main_md</span> <span class="o">=</span> <span class="n">mmc_get_drvdata</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">part_err</span><span class="p">;</span>

		<span class="n">main_md</span><span class="o">-&gt;</span><span class="n">part_curr</span> <span class="o">=</span> <span class="n">main_md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">;</span>
		<span class="n">part_err</span> <span class="o">=</span> <span class="n">mmc_blk_part_switch</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We have failed to get back into the correct</span>
<span class="cm">			 * partition, so we need to abort the whole request.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_blk_reset_success</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">reset_done</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_issue_discard_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">MMC_BLK_DISCARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_erase</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">from</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_discard</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">MMC_DISCARD_ARG</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_trim</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">MMC_TRIM_ARG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">MMC_ERASE_ARG</span><span class="p">;</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span>
				 <span class="n">INAND_CMD38_ARG_EXT_CSD</span><span class="p">,</span>
				 <span class="n">arg</span> <span class="o">==</span> <span class="n">MMC_TRIM_ARG</span> <span class="o">?</span>
				 <span class="n">INAND_CMD38_ARG_TRIM</span> <span class="o">:</span>
				 <span class="n">INAND_CMD38_ARG_ERASE</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_blk_reset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mmc_blk_reset_success</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_issue_secdiscard_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">trim_arg</span><span class="p">,</span> <span class="n">erase_arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">MMC_BLK_SECDISCARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmc_can_secure_erase_trim</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">||</span> <span class="n">mmc_can_sanitize</span><span class="p">(</span><span class="n">card</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">from</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="cm">/* The sanitize operation is supported at v4.5 only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_sanitize</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">erase_arg</span> <span class="o">=</span> <span class="n">MMC_ERASE_ARG</span><span class="p">;</span>
		<span class="n">trim_arg</span> <span class="o">=</span> <span class="n">MMC_TRIM_ARG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">erase_arg</span> <span class="o">=</span> <span class="n">MMC_SECURE_ERASE_ARG</span><span class="p">;</span>
		<span class="n">trim_arg</span> <span class="o">=</span> <span class="n">MMC_SECURE_TRIM1_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_erase_group_aligned</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">erase_arg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_trim</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">trim_arg</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span>
				 <span class="n">INAND_CMD38_ARG_EXT_CSD</span><span class="p">,</span>
				 <span class="n">arg</span> <span class="o">==</span> <span class="n">MMC_SECURE_TRIM1_ARG</span> <span class="o">?</span>
				 <span class="n">INAND_CMD38_ARG_SECTRIM1</span> <span class="o">:</span>
				 <span class="n">INAND_CMD38_ARG_SECERASE</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_retry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="n">MMC_SECURE_TRIM1_ARG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span>
					 <span class="n">INAND_CMD38_ARG_EXT_CSD</span><span class="p">,</span>
					 <span class="n">INAND_CMD38_ARG_SECTRIM2</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">MMC_SECURE_TRIM2_ARG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_retry</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_sanitize</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">EXT_CSD_CMD_SET_NORMAL</span><span class="p">,</span>
				 <span class="n">EXT_CSD_SANITIZE_START</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out_retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_blk_reset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mmc_blk_reset_success</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_issue_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_flush_cache</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reformat current write as a reliable write, supporting</span>
<span class="cm"> * both legacy and the enhanced reliable write MMC cards.</span>
<span class="cm"> * In each transfer we&#39;ll handle only as much as a single</span>
<span class="cm"> * reliable write can handle, thus finish the request in</span>
<span class="cm"> * partial completions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mmc_apply_rel_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_param</span> <span class="o">&amp;</span> <span class="n">EXT_CSD_WR_REL_PARAM_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Legacy mode imposes restrictions on transfers. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_sectors</span><span class="p">))</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_sectors</span><span class="p">)</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_sectors</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_sectors</span><span class="p">)</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define CMD_ERRORS							\</span>
<span class="cp">	(R1_OUT_OF_RANGE |	</span><span class="cm">/* Command argument out of range */</span><span class="cp">	\</span>
<span class="cp">	 R1_ADDRESS_ERROR |	</span><span class="cm">/* Misaligned address */</span><span class="cp">		\</span>
<span class="cp">	 R1_BLOCK_LEN_ERROR |	</span><span class="cm">/* Transferred block length incorrect */</span><span class="cp">\</span>
<span class="cp">	 R1_WP_VIOLATION |	</span><span class="cm">/* Tried to write to protected block */</span><span class="cp">	\</span>
<span class="cp">	 R1_CC_ERROR |		</span><span class="cm">/* Card controller error */</span><span class="cp">		\</span>
<span class="cp">	 R1_ERROR)		</span><span class="cm">/* General/unknown error */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_err_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_queue_req</span> <span class="o">*</span><span class="n">mq_mrq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_queue_req</span><span class="p">,</span>
						    <span class="n">mmc_active</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mq_mrq</span><span class="o">-&gt;</span><span class="n">brq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">mq_mrq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ecc_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * sbc.error indicates a problem with the set block count</span>
<span class="cm">	 * command.  No data will have been transferred.</span>
<span class="cm">	 *</span>
<span class="cm">	 * cmd.error indicates a problem with the r/w command.  No</span>
<span class="cm">	 * data will have been transferred.</span>
<span class="cm">	 *</span>
<span class="cm">	 * stop.error indicates a problem with the stop command.  Data</span>
<span class="cm">	 * may have been transferred, or may still be transferring.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">error</span> <span class="o">||</span>
	    <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mmc_blk_cmd_recovery</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">brq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ecc_err</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ERR_RETRY</span>:
			<span class="k">return</span> <span class="n">MMC_BLK_RETRY</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ERR_ABORT</span>:
			<span class="k">return</span> <span class="n">MMC_BLK_ABORT</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ERR_NOMEDIUM</span>:
			<span class="k">return</span> <span class="n">MMC_BLK_NOMEDIUM</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ERR_CONTINUE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for errors relating to the execution of the</span>
<span class="cm">	 * initial command - such as address errors.  No data</span>
<span class="cm">	 * has been transferred.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CMD_ERRORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: r/w command failed, status = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">MMC_BLK_ABORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Everything else is either success, or a data error of some</span>
<span class="cm">	 * kind.  If it was a write, we may have transitioned to</span>
<span class="cm">	 * program mode, which we have to wait for it to complete.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">get_card_status</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d requesting status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">MMC_BLK_CMD_ERR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Some cards mishandle the status bits,</span>
<span class="cm">			 * so make sure to check both the busy</span>
<span class="cm">			 * indication and the card state.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">R1_READY_FOR_DATA</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">R1_CURRENT_STATE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">R1_STATE_PRG</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error %d transferring data, sector %u, nr %u, cmd response %#x, card status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		       <span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ecc_err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">MMC_BLK_ECC_ERR</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">MMC_BLK_DATA_ERR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">MMC_BLK_CMD_ERR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bytes_xfered</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MMC_BLK_RETRY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">!=</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bytes_xfered</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MMC_BLK_PARTIAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">MMC_BLK_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_blk_rw_rq_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue_req</span> <span class="o">*</span><span class="n">mqrq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">disable_multi</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">readcmd</span><span class="p">,</span> <span class="n">writecmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mqrq</span><span class="o">-&gt;</span><span class="n">brq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">mqrq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_data_tag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reliable writes are used to implement Forced Unit Access and</span>
<span class="cm">	 * REQ_META accesses, and are supported only on MMCs.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX: this really needs a good explanation of why REQ_META</span>
<span class="cm">	 * is treated special.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">do_rel_wr</span> <span class="o">=</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_FUA</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_META</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_BLK_REL_WR</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">brq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_request</span><span class="p">));</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">blk_rq_pos</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_blockaddr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R1</span> <span class="o">|</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blksz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_STOP_TRANSMISSION</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_SPI_R1B</span> <span class="o">|</span> <span class="n">MMC_RSP_R1B</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The block layer doesn&#39;t support all sector count</span>
<span class="cm">	 * restrictions, so we need to be prepared for too big</span>
<span class="cm">	 * requests.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">)</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * After a read error, we redo the request one sector</span>
<span class="cm">		 * at a time in order to accurately determine which</span>
<span class="cm">		 * sectors can be read successfully.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disable_multi</span><span class="p">)</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Some controllers can&#39;t do multiblock reads due to hw bugs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps2</span> <span class="o">&amp;</span> <span class="n">MMC_CAP2_NO_MULTI_READ</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">do_rel_wr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SPI multiblock writes terminate using a special</span>
<span class="cm">		 * token, not a STOP_TRANSMISSION request.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_host_is_spi</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
			<span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
		<span class="n">readcmd</span> <span class="o">=</span> <span class="n">MMC_READ_MULTIPLE_BLOCK</span><span class="p">;</span>
		<span class="n">writecmd</span> <span class="o">=</span> <span class="n">MMC_WRITE_MULTIPLE_BLOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">readcmd</span> <span class="o">=</span> <span class="n">MMC_READ_SINGLE_BLOCK</span><span class="p">;</span>
		<span class="n">writecmd</span> <span class="o">=</span> <span class="n">MMC_WRITE_BLOCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">readcmd</span><span class="p">;</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MMC_DATA_READ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">writecmd</span><span class="p">;</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MMC_DATA_WRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_rel_wr</span><span class="p">)</span>
		<span class="n">mmc_apply_rel_rw</span><span class="p">(</span><span class="n">brq</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Data tag is used only during writing meta data to speed</span>
<span class="cm">	 * up write and any subsequent read of this meta data</span>
<span class="cm">	 */</span>
	<span class="n">do_data_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">data_tag_unit_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_META</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blksz</span><span class="p">)</span> <span class="o">&gt;=</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">data_tag_unit_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pre-defined multi-block transfers are preferable to</span>
<span class="cm">	 * open ended-ones (and necessary for reliable writes).</span>
<span class="cm">	 * However, it is not sufficient to just send CMD23,</span>
<span class="cm">	 * and avoid the final CMD12, as on an error condition</span>
<span class="cm">	 * CMD12 (stop) needs to be sent anyway. This, coupled</span>
<span class="cm">	 * with Auto-CMD23 enhancements provided by some</span>
<span class="cm">	 * hosts, means that the complexity of dealing</span>
<span class="cm">	 * with this is best left to the host. If CMD23 is</span>
<span class="cm">	 * supported by card and host, we&#39;ll fill sbc in and let</span>
<span class="cm">	 * the host deal with handling it correctly. This means</span>
<span class="cm">	 * that for hosts that don&#39;t expose MMC_CAP_CMD23, no</span>
<span class="cm">	 * change of behavior will be observed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * N.B: Some MMC cards experience perf degradation.</span>
<span class="cm">	 * We&#39;ll avoid using CMD23-bounded multiblock writes for</span>
<span class="cm">	 * these, while retaining features like reliable writes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_BLK_CMD23</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_op_multi</span><span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">do_rel_wr</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">MMC_QUIRK_BLK_NO_CMD23</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">do_data_tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SET_BLOCK_COUNT</span><span class="p">;</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">do_rel_wr</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">do_data_tag</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">.</span><span class="n">sbc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">sbc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmc_set_data_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sg</span> <span class="o">=</span> <span class="n">mqrq</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">mmc_queue_map_sg</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">mqrq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust the sg list so it is the same size as the</span>
<span class="cm">	 * request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">!=</span> <span class="n">blk_rq_sectors</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_size</span> <span class="o">=</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

		<span class="n">for_each_sg</span><span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_size</span> <span class="o">-=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">data_size</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mqrq</span><span class="o">-&gt;</span><span class="n">mmc_active</span><span class="p">.</span><span class="n">mrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">;</span>
	<span class="n">mqrq</span><span class="o">-&gt;</span><span class="n">mmc_active</span><span class="p">.</span><span class="n">err_check</span> <span class="o">=</span> <span class="n">mmc_blk_err_check</span><span class="p">;</span>

	<span class="n">mmc_queue_bounce_pre</span><span class="p">(</span><span class="n">mqrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_cmd_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If this is an SD card and we&#39;re writing, we can first</span>
<span class="cm">	 * mark the known good sectors as ok.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the card is not SD, we can still ok written sectors</span>
<span class="cm">	 * as reported by the controller (which might be less than</span>
<span class="cm">	 * the real number of written sectors, but never more).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_sd</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">blocks</span><span class="p">;</span>

		<span class="n">blocks</span> <span class="o">=</span> <span class="n">mmc_sd_num_wr_blocks</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bytes_xfered</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_issue_rw_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rqc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_request</span> <span class="o">*</span><span class="n">brq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_cur</span><span class="o">-&gt;</span><span class="n">brq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">disable_multi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mmc_blk_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_queue_req</span> <span class="o">*</span><span class="n">mq_rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">rqc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">areq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rqc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_prev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * When 4KB native sector is enabled, only 8 blocks</span>
<span class="cm">			 * multiple read or write is allowed</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">data_sector_size</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Transfer size is not 4KB sector size aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mmc_blk_rw_rq_prep</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_cur</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mq</span><span class="p">);</span>
			<span class="n">areq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_cur</span><span class="o">-&gt;</span><span class="n">mmc_active</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">areq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">areq</span> <span class="o">=</span> <span class="n">mmc_start_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">areq</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">areq</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mq_rq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_queue_req</span><span class="p">,</span> <span class="n">mmc_active</span><span class="p">);</span>
		<span class="n">brq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mq_rq</span><span class="o">-&gt;</span><span class="n">brq</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">mq_rq</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">rq_data_dir</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ</span> <span class="o">?</span> <span class="n">MMC_BLK_READ</span> <span class="o">:</span> <span class="n">MMC_BLK_WRITE</span><span class="p">;</span>
		<span class="n">mmc_queue_bounce_post</span><span class="p">(</span><span class="n">mq_rq</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MMC_BLK_SUCCESS</span>:
		<span class="k">case</span> <span class="n">MMC_BLK_PARTIAL</span>:
			<span class="cm">/*</span>
<span class="cm">			 * A block was successfully transferred.</span>
<span class="cm">			 */</span>
			<span class="n">mmc_blk_reset_success</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bytes_xfered</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the blk_end_request function returns non-zero even</span>
<span class="cm">			 * though all data has been transferred and no errors</span>
<span class="cm">			 * were returned by the host controller, it&#39;s a bug.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MMC_BLK_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s BUG rq_tot %d d_xfer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
				       <span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">bytes_xfered</span><span class="p">);</span>
				<span class="n">rqc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_BLK_CMD_ERR</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_cmd_err</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">brq</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_blk_reset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_BLK_RETRY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="n">MMC_BLK_ABORT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_blk_reset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_BLK_DATA_ERR</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_blk_reset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
			<span class="cm">/* Fall through */</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">MMC_BLK_ECC_ERR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Redo read one sector at a time */</span>
				<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: retrying using single block read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">req</span><span class="o">-&gt;</span><span class="n">rq_disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">);</span>
				<span class="n">disable_multi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * After an error, we redo I/O one sector at a</span>
<span class="cm">			 * time, so we only reach here after trying to</span>
<span class="cm">			 * read a single sector.</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span>
						<span class="n">brq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">blksz</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">start_new_req</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MMC_BLK_NOMEDIUM</span>:
			<span class="k">goto</span> <span class="n">cmd_abort</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * In case of a incomplete request</span>
<span class="cm">			 * prepare it again and resend.</span>
<span class="cm">			 */</span>
			<span class="n">mmc_blk_rw_rq_prep</span><span class="p">(</span><span class="n">mq_rq</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">disable_multi</span><span class="p">,</span> <span class="n">mq</span><span class="p">);</span>
			<span class="n">mmc_start_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mq_rq</span><span class="o">-&gt;</span><span class="n">mmc_active</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">cmd_abort:</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_removed</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">REQ_QUIET</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__blk_end_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="n">blk_rq_cur_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

 <span class="nl">start_new_req:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rqc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_blk_rw_rq_prep</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_cur</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mq</span><span class="p">);</span>
		<span class="n">mmc_start_req</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_cur</span><span class="o">-&gt;</span><span class="n">mmc_active</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_issue_rq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_queue</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mqrq_prev</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">)</span>
		<span class="cm">/* claim host only for the first request */</span>
		<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_part_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">__blk_end_request_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_DISCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* complete ongoing async transfer before issuing discard */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">)</span>
			<span class="n">mmc_blk_issue_rw_rq</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_SECURE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_issue_secdiscard_rq</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_issue_discard_rq</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd_flags</span> <span class="o">&amp;</span> <span class="n">REQ_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* complete ongoing async transfer before issuing flush */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">areq</span><span class="p">)</span>
			<span class="n">mmc_blk_issue_rw_rq</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_issue_flush</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_issue_rw_rq</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="cm">/* release host only when there are no more requests */</span>
		<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mmc_blk_readonly</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_card_readonly</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">cmdclass</span> <span class="o">&amp;</span> <span class="n">CCC_BLOCK_WRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="nf">mmc_blk_alloc_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span>
					      <span class="n">sector_t</span> <span class="n">size</span><span class="p">,</span>
					      <span class="n">bool</span> <span class="n">default_ro</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subname</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">area_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devidx</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">devidx</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">dev_use</span><span class="p">,</span> <span class="n">max_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devidx</span> <span class="o">&gt;=</span> <span class="n">max_devices</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">devidx</span><span class="p">,</span> <span class="n">dev_use</span><span class="p">);</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * !subname implies we are creating main mmc_blk_data that will be</span>
<span class="cm">	 * associated with mmc_card with mmc_set_drvdata. Due to device</span>
<span class="cm">	 * partitions, devidx will not coincide with a per-physical card</span>
<span class="cm">	 * index anymore so we keep track of a name index.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">subname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">name_idx</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">name_use</span><span class="p">,</span> <span class="n">max_devices</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">name_idx</span><span class="p">,</span> <span class="n">name_use</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">name_idx</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">dev_to_disk</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name_idx</span><span class="p">;</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">area_type</span> <span class="o">=</span> <span class="n">area_type</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the read-only status based on the supported commands</span>
<span class="cm">	 * and the write protect switch.</span>
<span class="cm">	 */</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">mmc_blk_readonly</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">alloc_disk</span><span class="p">(</span><span class="n">perdev_minors</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_init_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">subname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_putdisk</span><span class="p">;</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">issue_fn</span> <span class="o">=</span> <span class="n">mmc_blk_issue_rq</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>

	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">major</span>	<span class="o">=</span> <span class="n">MMC_BLOCK_MAJOR</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">first_minor</span> <span class="o">=</span> <span class="n">devidx</span> <span class="o">*</span> <span class="n">perdev_minors</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mmc_bdops</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">md</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">driverfs_dev</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
	<span class="n">set_disk_ro</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span> <span class="o">||</span> <span class="n">default_ro</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As discussed on lkml, GENHD_FL_REMOVABLE should:</span>
<span class="cm">	 *</span>
<span class="cm">	 * - be set for removable media with permanent block devices</span>
<span class="cm">	 * - be unset for removable block devices with permanent media</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since MMC block devices clearly fall under the second</span>
<span class="cm">	 * case, we do not set GENHD_FL_REMOVABLE.  Userspace</span>
<span class="cm">	 * should use the block device creation/destruction hotplug</span>
<span class="cm">	 * messages to tell when the card is present.</span>
<span class="cm">	 */</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">),</span>
		 <span class="s">&quot;mmcblk%d%s&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">name_idx</span><span class="p">,</span> <span class="n">subname</span> <span class="o">?</span> <span class="n">subname</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">data_sector_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">blk_queue_logical_block_size</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">set_capacity</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_host_cmd23</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">mmc_card_sd</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">.</span><span class="n">cmds</span> <span class="o">&amp;</span> <span class="n">SD_SCR_CMD23_SUPPORT</span><span class="p">))</span>
			<span class="n">md</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MMC_BLK_CMD23</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">md</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MMC_BLK_CMD23</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_param</span> <span class="o">&amp;</span> <span class="n">EXT_CSD_WR_REL_PARAM_EN</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">rel_sectors</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MMC_BLK_REL_WR</span><span class="p">;</span>
		<span class="n">blk_queue_flush</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">REQ_FLUSH</span> <span class="o">|</span> <span class="n">REQ_FUA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">md</span><span class="p">;</span>

 <span class="nl">err_putdisk:</span>
	<span class="n">put_disk</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
 <span class="nl">err_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="nf">mmc_blk_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sector_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_sd</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_card_blockaddr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The EXT_CSD sector count is in number or 512 byte</span>
<span class="cm">		 * sectors.</span>
<span class="cm">		 */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">sectors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The CSD capacity field is in units of read_blkbits.</span>
<span class="cm">		 * set_capacity takes units of 512 bytes.</span>
<span class="cm">		 */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">capacity</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">read_blkbits</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_alloc_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">MMC_BLK_DATA_AREA_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">md</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_alloc_part</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">part_type</span><span class="p">,</span>
			      <span class="n">sector_t</span> <span class="n">size</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">default_ro</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subname</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">area_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cap_str</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>

	<span class="n">part_md</span> <span class="o">=</span> <span class="n">mmc_blk_alloc_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">default_ro</span><span class="p">,</span>
				    <span class="n">subname</span><span class="p">,</span> <span class="n">area_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">part_md</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">part_md</span><span class="p">);</span>
	<span class="n">part_md</span><span class="o">-&gt;</span><span class="n">part_type</span> <span class="o">=</span> <span class="n">part_type</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">);</span>

	<span class="n">string_get_size</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">get_capacity</span><span class="p">(</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">STRING_UNITS_2</span><span class="p">,</span>
			<span class="n">cap_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap_str</span><span class="p">));</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s %s partition %u %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">part_md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">mmc_card_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
	       <span class="n">mmc_card_name</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">part_md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">,</span> <span class="n">cap_str</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MMC Physical partitions consist of two boot partitions and</span>
<span class="cm"> * up to four general purpose partitions.</span>
<span class="cm"> * For each partition enabled in EXT_CSD a block device will be allocatedi</span>
<span class="cm"> * to provide access to the partition.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_alloc_parts</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nr_parts</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_blk_alloc_part</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">part_cfg</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">force_ro</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">area_type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_blk_remove_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GENHD_FL_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">area_type</span> <span class="o">&amp;</span> <span class="n">MMC_BLK_DATA_AREA_BOOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lockable</span><span class="p">)</span>
				<span class="n">device_remove_file</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">);</span>

			<span class="cm">/* Stop new requests from getting into the queue */</span>
			<span class="n">del_gendisk</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Then flush out any already in there */</span>
		<span class="n">mmc_cleanup_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">mmc_blk_put</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_blk_remove_parts</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">name_idx</span><span class="p">,</span> <span class="n">name_use</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part_md</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_blk_data</span><span class="p">,</span> <span class="n">part</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">mmc_blk_remove_req</span><span class="p">(</span><span class="n">part_md</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_add_disk</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>

	<span class="n">add_disk</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">force_ro_show</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">force_ro_store</span><span class="p">;</span>
	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;force_ro&quot;</span><span class="p">;</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">force_ro_fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">area_type</span> <span class="o">&amp;</span> <span class="n">MMC_BLK_DATA_AREA_BOOT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lockable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">umode_t</span> <span class="n">mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">boot_ro_lock</span> <span class="o">&amp;</span> <span class="n">EXT_CSD_BOOT_WP_B_PWR_WP_DIS</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">;</span>

		<span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">power_ro_lock_show</span><span class="p">;</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">power_ro_lock_store</span><span class="p">;</span>
		<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span>
					<span class="s">&quot;ro_lock_until_next_power_on&quot;</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">power_ro_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">power_ro_lock_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">power_ro_lock_fail:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">disk_to_dev</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">force_ro</span><span class="p">);</span>
<span class="nl">force_ro_fail:</span>
	<span class="n">del_gendisk</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CID_MANFID_SANDISK	0x2</span>
<span class="cp">#define CID_MANFID_TOSHIBA	0x11</span>
<span class="cp">#define CID_MANFID_MICRON	0x13</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_fixup</span> <span class="n">blk_fixups</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;SEM02G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_SANDISK</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">add_quirk</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;SEM04G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_SANDISK</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">add_quirk</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;SEM08G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_SANDISK</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">add_quirk</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;SEM16G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_SANDISK</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">add_quirk</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;SEM32G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_SANDISK</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">add_quirk</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_INAND_CMD38</span><span class="p">),</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some MMC cards experience performance degradation with CMD23</span>
<span class="cm">	 * instead of CMD12-bounded multiblock transfers. For now we&#39;ll</span>
<span class="cm">	 * black list what&#39;s bad...</span>
<span class="cm">	 * - Certain Toshiba cards.</span>
<span class="cm">	 *</span>
<span class="cm">	 * N.B. This doesn&#39;t affect SD cards.</span>
<span class="cm">	 */</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;MMC08G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_TOSHIBA</span><span class="p">,</span> <span class="n">CID_OEMID_ANY</span><span class="p">,</span> <span class="n">add_quirk_mmc</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_BLK_NO_CMD23</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;MMC16G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_TOSHIBA</span><span class="p">,</span> <span class="n">CID_OEMID_ANY</span><span class="p">,</span> <span class="n">add_quirk_mmc</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_BLK_NO_CMD23</span><span class="p">),</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="s">&quot;MMC32G&quot;</span><span class="p">,</span> <span class="n">CID_MANFID_TOSHIBA</span><span class="p">,</span> <span class="n">CID_OEMID_ANY</span><span class="p">,</span> <span class="n">add_quirk_mmc</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_BLK_NO_CMD23</span><span class="p">),</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some Micron MMC cards needs longer data read timeout than</span>
<span class="cm">	 * indicated in CSD.</span>
<span class="cm">	 */</span>
	<span class="n">MMC_FIXUP</span><span class="p">(</span><span class="n">CID_NAME_ANY</span><span class="p">,</span> <span class="n">CID_MANFID_MICRON</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">add_quirk_mmc</span><span class="p">,</span>
		  <span class="n">MMC_QUIRK_LONG_READ_TIME</span><span class="p">),</span>

	<span class="n">END_FIXUP</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span><span class="p">,</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cap_str</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that the card supports the command class(es) we need.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">cmdclass</span> <span class="o">&amp;</span> <span class="n">CCC_BLOCK_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">mmc_blk_alloc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>

	<span class="n">string_get_size</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">get_capacity</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">STRING_UNITS_2</span><span class="p">,</span>
			<span class="n">cap_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap_str</span><span class="p">));</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">disk</span><span class="o">-&gt;</span><span class="n">disk_name</span><span class="p">,</span> <span class="n">mmc_card_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">mmc_card_name</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
		<span class="n">cap_str</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">read_only</span> <span class="o">?</span> <span class="s">&quot;(ro)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_blk_alloc_parts</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mmc_set_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="n">mmc_fixup_device</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">blk_fixups</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_add_disk</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">part_md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_add_disk</span><span class="p">(</span><span class="n">part_md</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mmc_blk_remove_parts</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="n">mmc_blk_remove_req</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_blk_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_get_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">mmc_blk_remove_parts</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_blk_part_switch</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">md</span><span class="p">);</span>
	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">mmc_blk_remove_req</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
	<span class="n">mmc_set_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_get_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_queue_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">part_md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_queue_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_blk_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">part_md</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_blk_data</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">mmc_get_drvdata</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Resume involves the card going into idle state,</span>
<span class="cm">		 * so current partition is always the main one.</span>
<span class="cm">		 */</span>
		<span class="n">md</span><span class="o">-&gt;</span><span class="n">part_curr</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">part_type</span><span class="p">;</span>
		<span class="n">mmc_queue_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">part_md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mmc_queue_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_md</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define	mmc_blk_suspend	NULL</span>
<span class="cp">#define mmc_blk_resume	NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_driver</span> <span class="n">mmc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;mmcblk&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mmc_blk_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mmc_blk_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mmc_blk_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mmc_blk_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mmc_blk_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perdev_minors</span> <span class="o">!=</span> <span class="n">CONFIG_MMC_BLOCK_MINORS</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;mmcblk: using %d minors per device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">perdev_minors</span><span class="p">);</span>

	<span class="n">max_devices</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="n">perdev_minors</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">register_blkdev</span><span class="p">(</span><span class="n">MMC_BLOCK_MAJOR</span><span class="p">,</span> <span class="s">&quot;mmc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mmc_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out2:</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">MMC_BLOCK_MAJOR</span><span class="p">,</span> <span class="s">&quot;mmc&quot;</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mmc_blk_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mmc_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_driver</span><span class="p">);</span>
	<span class="n">unregister_blkdev</span><span class="p">(</span><span class="n">MMC_BLOCK_MAJOR</span><span class="p">,</span> <span class="s">&quot;mmc&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mmc_blk_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mmc_blk_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Multimedia Card (MMC) block device driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
