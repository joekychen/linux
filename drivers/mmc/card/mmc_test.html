<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mmc › card › mmc_test.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mmc_test.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/mmc/card/mmc_test.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2007-2008 Pierre Ossman</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> * your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/mmc/core.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/card.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/host.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/mmc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;		</span><span class="cm">/* For nr_free_buffer_pages() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define RESULT_OK		0</span>
<span class="cp">#define RESULT_FAIL		1</span>
<span class="cp">#define RESULT_UNSUP_HOST	2</span>
<span class="cp">#define RESULT_UNSUP_CARD	3</span>

<span class="cp">#define BUFFER_ORDER		2</span>
<span class="cp">#define BUFFER_SIZE		(PAGE_SIZE &lt;&lt; BUFFER_ORDER)</span>

<span class="cm">/*</span>
<span class="cm"> * Limit the test area size to the maximum MMC HC erase group size.  Note that</span>
<span class="cm"> * the maximum SD allocation unit size is just 4MiB.</span>
<span class="cm"> */</span>
<span class="cp">#define TEST_AREA_MAX_SIZE (128 * 1024 * 1024)</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_pages - pages allocated by &#39;alloc_pages()&#39;.</span>
<span class="cm"> * @page: first page in the allocation</span>
<span class="cm"> * @order: order of the number of pages allocated</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_pages</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_mem - allocated memory.</span>
<span class="cm"> * @arr: array of allocations</span>
<span class="cm"> * @cnt: number of allocations</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_pages</span> <span class="o">*</span><span class="n">arr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_area - information for performance tests.</span>
<span class="cm"> * @max_sz: test area size (in bytes)</span>
<span class="cm"> * @dev_addr: address on card at which to do performance tests</span>
<span class="cm"> * @max_tfr: maximum transfer size allowed by driver (in bytes)</span>
<span class="cm"> * @max_segs: maximum segments allowed by driver in scatterlist @sg</span>
<span class="cm"> * @max_seg_sz: maximum segment size allowed by driver</span>
<span class="cm"> * @blocks: number of (512 byte) blocks currently mapped by @sg</span>
<span class="cm"> * @sg_len: length of currently mapped scatterlist @sg</span>
<span class="cm"> * @mem: allocated memory</span>
<span class="cm"> * @sg: scatterlist</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_tfr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_segs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_seg_sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_transfer_result - transfer results for performance tests.</span>
<span class="cm"> * @link: double-linked list</span>
<span class="cm"> * @count: amount of group of sectors to check</span>
<span class="cm"> * @sectors: amount of sectors to check in one group</span>
<span class="cm"> * @ts: time values of transfer</span>
<span class="cm"> * @rate: calculated transfer rate</span>
<span class="cm"> * @iops: I/O operations per second (times 100)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_transfer_result</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iops</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_general_result - results for tests.</span>
<span class="cm"> * @link: double-linked list</span>
<span class="cm"> * @card: card under test</span>
<span class="cm"> * @testcase: number of test case</span>
<span class="cm"> * @result: result of test run</span>
<span class="cm"> * @tr_lst: transfer measurements if any as mmc_test_transfer_result</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_general_result</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">testcase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">tr_lst</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_dbgfs_file - debugfs related file.</span>
<span class="cm"> * @link: double-linked list</span>
<span class="cm"> * @card: card under test</span>
<span class="cm"> * @file: file created under debugfs</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_dbgfs_file</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct mmc_test_card - test information.</span>
<span class="cm"> * @card: card under test</span>
<span class="cm"> * @scratch: transfer buffer</span>
<span class="cm"> * @buffer: transfer buffer</span>
<span class="cm"> * @highmem: buffer for highmem tests</span>
<span class="cm"> * @area: information for performance tests</span>
<span class="cm"> * @gr: pointer to results of current testcase</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_card</span>	<span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">u8</span>		<span class="n">scratch</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HIGHMEM</span>
	<span class="k">struct</span> <span class="n">page</span>	<span class="o">*</span><span class="n">highmem</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span>		<span class="n">area</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_general_result</span>	<span class="o">*</span><span class="n">gr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">mmc_test_prep_media</span> <span class="p">{</span>
	<span class="n">MMC_TEST_PREP_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MMC_TEST_PREP_WRITE_FULL</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MMC_TEST_PREP_ERASE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sg_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_write</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_nonblock_req</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">mmc_test_prep_media</span> <span class="n">prepare</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mmc_test_async_req</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="n">areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/*  General helper functions                                       */</span>
<span class="cm">/*******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Configure correct block size in card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_set_blksize</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_set_blocklen</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill in the mmc_request structure given a set of transfer parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_prepare_mrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sg_len</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mrq</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span>
			<span class="n">MMC_WRITE_MULTIPLE_BLOCK</span> <span class="o">:</span> <span class="n">MMC_READ_MULTIPLE_BLOCK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span>
			<span class="n">MMC_WRITE_BLOCK</span> <span class="o">:</span> <span class="n">MMC_READ_SINGLE_BLOCK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_blockaddr</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_ADTC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_STOP_TRANSMISSION</span><span class="p">;</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1B</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span> <span class="o">=</span> <span class="n">blksz</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span> <span class="n">MMC_DATA_WRITE</span> <span class="o">:</span> <span class="n">MMC_DATA_READ</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sg</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>

	<span class="n">mmc_set_data_timeout</span><span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">R1_READY_FOR_DATA</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">R1_CURRENT_STATE</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">R1_STATE_PRG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the card to finish the busy state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_wait_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">busy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SEND_STATUS</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MMC_RSP_R1</span> <span class="o">|</span> <span class="n">MMC_CMD_AC</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_wait_for_cmd</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busy</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_test_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MMC_CAP_WAIT_WHILE_BUSY</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Warning: Host did not &quot;</span>
					<span class="s">&quot;wait for busy state to end.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mmc_test_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transfer a single sector of kernel addressable data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_buffer_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">blksz</span><span class="p">);</span>

	<span class="n">mmc_test_prepare_mrq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>

	<span class="n">mmc_wait_for_req</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_wait_busy</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_free_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">].</span><span class="n">page</span><span class="p">,</span>
			     <span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">].</span><span class="n">order</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a lot of memory, preferably max_sz but at least min_sz.  In case</span>
<span class="cm"> * there isn&#39;t much memory do not exceed 1/16th total lowmem pages.  Also do</span>
<span class="cm"> * not exceed a maximum number of segments and try not to make segments much</span>
<span class="cm"> * bigger than maximum segment size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="nf">mmc_test_alloc_mem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_sz</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_sz</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_segs</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_seg_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_page_cnt</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">max_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_page_cnt</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">min_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_seg_page_cnt</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">max_seg_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">nr_free_buffer_pages</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_page_cnt</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
		<span class="n">max_page_cnt</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_page_cnt</span> <span class="o">&gt;</span> <span class="n">max_page_cnt</span><span class="p">)</span>
		<span class="n">min_page_cnt</span> <span class="o">=</span> <span class="n">max_page_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_seg_page_cnt</span> <span class="o">&gt;</span> <span class="n">max_page_cnt</span><span class="p">)</span>
		<span class="n">max_seg_page_cnt</span> <span class="o">=</span> <span class="n">max_page_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_segs</span> <span class="o">&gt;</span> <span class="n">max_page_cnt</span><span class="p">)</span>
		<span class="n">max_segs</span> <span class="o">=</span> <span class="n">max_page_cnt</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_mem</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_pages</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_segs</span><span class="p">,</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max_page_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">gfp_t</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span>
				<span class="n">__GFP_NORETRY</span><span class="p">;</span>

		<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">max_seg_page_cnt</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">||</span> <span class="o">!</span><span class="n">order</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">order</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_cnt</span> <span class="o">&lt;</span> <span class="n">min_page_cnt</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">].</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_page_cnt</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">max_page_cnt</span> <span class="o">-=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">page_cnt</span> <span class="o">+=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">max_segs</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">page_cnt</span> <span class="o">&lt;</span> <span class="n">min_page_cnt</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">mmc_test_free_mem</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map memory into a scatterlist.  Optionally allow the same memory to be</span>
<span class="cm"> * mapped more than once.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_map_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repeat</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_segs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_seg_sz</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sg_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_sg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">max_segs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_sg_len</span> <span class="o">&gt;</span> <span class="n">max_segs</span><span class="p">)</span>
		<span class="n">min_sg_len</span> <span class="o">=</span> <span class="n">max_segs</span><span class="p">;</span>

	<span class="o">*</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">min_sg_len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">min_sg_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">min_sg_len</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_seg_sz</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">max_seg_sz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span>
				<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sz</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sg_len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&amp;&amp;</span> <span class="n">repeat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span>
		<span class="n">sg_mark_end</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map memory into a scatterlist so that no pages are contiguous.  Allow the</span>
<span class="cm"> * same memory to be mapped more than once.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_map_sg_max_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_segs</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_seg_sz</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">last_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="n">sglist</span><span class="p">,</span> <span class="n">max_segs</span><span class="p">);</span>

	<span class="o">*</span><span class="n">sg_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="o">--</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="o">--</span><span class="n">cnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_addr</span> <span class="o">&amp;&amp;</span> <span class="n">last_addr</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">last_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_seg_sz</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">max_seg_sz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span>
				<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">sg_set_page</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sz</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="o">*</span><span class="n">sg_len</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span>
		<span class="n">sg_mark_end</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate transfer rate in bytes per second.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mmc_test_rate</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">ns</span><span class="p">;</span>

	<span class="n">ns</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">*=</span> <span class="mi">1000000000</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">+=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">*=</span> <span class="mi">1000000000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="n">UINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ns</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">ns</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Save transfer results for future usage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_save_transfer_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_transfer_result</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_transfer_result</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">sectors</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">iops</span> <span class="o">=</span> <span class="n">iops</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">tr_lst</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print the transfer rate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_print_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">bytes</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">iops</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">ts</span> <span class="o">=</span> <span class="n">timespec_sub</span><span class="p">(</span><span class="o">*</span><span class="n">ts2</span><span class="p">,</span> <span class="o">*</span><span class="n">ts1</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">mmc_test_rate</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">iops</span> <span class="o">=</span> <span class="n">mmc_test_rate</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span> <span class="cm">/* I/O ops per sec x 100 */</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Transfer of %u sectors (%u%s KiB) took %lu.%09lu &quot;</span>
			 <span class="s">&quot;seconds (%u kB/s, %u KiB/s, %u.%02u IOPS)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">sectors</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;.5&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
			 <span class="n">iops</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">iops</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">mmc_test_save_transfer_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">iops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print the average transfer rate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_print_avg_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">bytes</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts1</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">timespec</span> <span class="o">*</span><span class="n">ts2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">iops</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">tot</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">ts</span> <span class="o">=</span> <span class="n">timespec_sub</span><span class="p">(</span><span class="o">*</span><span class="n">ts2</span><span class="p">,</span> <span class="o">*</span><span class="n">ts1</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">mmc_test_rate</span><span class="p">(</span><span class="n">tot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">iops</span> <span class="o">=</span> <span class="n">mmc_test_rate</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span> <span class="cm">/* I/O ops per sec x 100 */</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Transfer of %u x %u sectors (%u x %u%s KiB) took &quot;</span>
			 <span class="s">&quot;%lu.%09lu seconds (%u kB/s, %u KiB/s, &quot;</span>
			 <span class="s">&quot;%u.%02u IOPS, sg_len %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">count</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			 <span class="n">sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">sectors</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;.5&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">,</span>
			 <span class="n">rate</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">iops</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">iops</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span>
			 <span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">sg_len</span><span class="p">);</span>

	<span class="n">mmc_test_save_transfer_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">iops</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the card size in sectors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mmc_test_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_sd</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mmc_card_blockaddr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ext_csd</span><span class="p">.</span><span class="n">sectors</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">capacity</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">read_blkbits</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/*  Test preparation and cleanup                                   */</span>
<span class="cm">/*******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Fill the first couple of sectors of the card with known data</span>
<span class="cm"> * so that bad reads/writes can be detected</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__mmc_test_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_buffer_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_prepare_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__mmc_test_prepare</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_prepare_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__mmc_test_prepare</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">BUFFER_SIZE</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_buffer_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/*  Test execution helpers                                         */</span>
<span class="cm">/*******************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Modifies the mmc_request to perform the &quot;short transfer&quot; tests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_prepare_broken_mrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mrq</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span>
			<span class="n">MMC_WRITE_BLOCK</span> <span class="o">:</span> <span class="n">MMC_READ_SINGLE_BLOCK</span><span class="p">;</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">MMC_SEND_STATUS</span><span class="p">;</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rca</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks that a normal transfer didn&#39;t have any errors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_check_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mrq</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">!=</span>
		<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_check_result_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">areq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_async_req</span> <span class="o">*</span><span class="n">test_async</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">areq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mmc_test_async_req</span><span class="p">,</span> <span class="n">areq</span><span class="p">);</span>

	<span class="n">mmc_test_wait_busy</span><span class="p">(</span><span class="n">test_async</span><span class="o">-&gt;</span><span class="n">test</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmc_test_check_result</span><span class="p">(</span><span class="n">test_async</span><span class="o">-&gt;</span><span class="n">test</span><span class="p">,</span> <span class="n">areq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks that a &quot;short transfer&quot; behaved as expected</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_check_broken_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mrq</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">&gt;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">blksz</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tests nonblock transfer with certain parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_nonblock_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_request</span> <span class="o">*</span><span class="n">mrq</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mmc_command</span> <span class="o">*</span><span class="n">stop</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mmc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mrq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_request</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_data</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_command</span><span class="p">));</span>

	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">mrq</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_nonblock_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sg_len</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">stop1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">stop2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data2</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mmc_test_async_req</span> <span class="n">test_areq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">done_areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">cur_areq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test_areq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">areq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_async_req</span> <span class="o">*</span><span class="n">other_areq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test_areq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">areq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">test_areq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">;</span>
	<span class="n">test_areq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">;</span>

	<span class="n">mmc_test_nonblock_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data1</span><span class="p">);</span>
	<span class="n">mmc_test_nonblock_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data2</span><span class="p">);</span>

	<span class="n">cur_areq</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mrq1</span><span class="p">;</span>
	<span class="n">cur_areq</span><span class="o">-&gt;</span><span class="n">err_check</span> <span class="o">=</span> <span class="n">mmc_test_check_result_async</span><span class="p">;</span>
	<span class="n">other_areq</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mrq2</span><span class="p">;</span>
	<span class="n">other_areq</span><span class="o">-&gt;</span><span class="n">err_check</span> <span class="o">=</span> <span class="n">mmc_test_check_result_async</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mmc_test_prepare_mrq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">cur_areq</span><span class="o">-&gt;</span><span class="n">mrq</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
				     <span class="n">blocks</span><span class="p">,</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
		<span class="n">done_areq</span> <span class="o">=</span> <span class="n">mmc_start_req</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">cur_areq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">done_areq</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">done_areq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">done_areq</span><span class="o">-&gt;</span><span class="n">mrq</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">mrq2</span><span class="p">)</span>
				<span class="n">mmc_test_nonblock_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd2</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">stop2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mmc_test_nonblock_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mrq1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd1</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">stop1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">done_areq</span> <span class="o">=</span> <span class="n">cur_areq</span><span class="p">;</span>
		<span class="n">cur_areq</span> <span class="o">=</span> <span class="n">other_areq</span><span class="p">;</span>
		<span class="n">other_areq</span> <span class="o">=</span> <span class="n">done_areq</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">+=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">done_areq</span> <span class="o">=</span> <span class="n">mmc_start_req</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tests a basic transfer with certain parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_simple_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sg_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">dev_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">;</span>

	<span class="n">mmc_test_prepare_mrq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
		<span class="n">blocks</span><span class="p">,</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>

	<span class="n">mmc_wait_for_req</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>

	<span class="n">mmc_test_wait_busy</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmc_test_check_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tests a transfer where the card will fail completely or partly</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_broken_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_request</span> <span class="n">mrq</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_command</span> <span class="n">stop</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_data</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">mrq</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">mrq</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stop</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span><span class="p">);</span>

	<span class="n">mmc_test_prepare_mrq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
	<span class="n">mmc_test_prepare_broken_mrq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>

	<span class="n">mmc_wait_for_req</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>

	<span class="n">mmc_test_wait_busy</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmc_test_check_broken_result</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Does a complete transfer test where data is also validated</span>
<span class="cm"> *</span>
<span class="cm"> * Note: mmc_test_prepare() must have been done before this call</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sg_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">dev_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blksz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">sg_copy_from_buffer</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">blksz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_simple_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
		<span class="n">blocks</span><span class="p">,</span> <span class="n">blksz</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sectors</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">/</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sectors</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span><span class="p">))</span>
			<span class="n">sectors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sectors</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectors</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_buffer_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span>
				<span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span>
				<span class="n">dev_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sectors</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xDF</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sg_copy_to_buffer</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">blksz</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************************************************/</span>
<span class="cm">/*  Tests                                                          */</span>
<span class="cm">/*******************************************************************/</span>

<span class="k">struct</span> <span class="n">mmc_test_case</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">run</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cleanup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_basic_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_simple_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_basic_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_simple_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_verify_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_verify_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_pow2_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">write_partial</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_pow2_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">read_partial</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_weird_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">write_partial</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_weird_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">csd</span><span class="p">.</span><span class="n">read_partial</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">;</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_align_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_align_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_align_multi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_align_multi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_xfersize_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_broken_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_xfersize_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_broken_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_xfersize_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_broken_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_xfersize_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_broken_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_write_high</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_read_high</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_write_high</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_multi_read_high</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="n">sg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="n">sg_init_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sg_set_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">/</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_no_highmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Highmem not configured - test skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HIGHMEM */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Map sz bytes so that it can be transferred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">max_scatter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_sg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_scatter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_test_map_sg_max_scatter</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span>
						  <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_test_map_sg</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">,</span>
				      <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">min_sg_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Failed to map sg list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transfer bytes mapped by mmc_test_area_map().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_transfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mmc_test_simple_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map and transfer bytes for multiple transfers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_io_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">max_scatter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">nonblock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">min_sg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the case of a maximally scattered transfer, the maximum transfer</span>
<span class="cm">	 * size is further limited by using PAGE_SIZE segments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_scatter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_tfr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">*</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">max_tfr</span><span class="p">)</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">max_tfr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_map</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">max_scatter</span><span class="p">,</span> <span class="n">min_sg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timed</span><span class="p">)</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_nonblock_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">,</span>
				 <span class="n">dev_addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_transfer</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
			<span class="n">dev_addr</span> <span class="o">+=</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timed</span><span class="p">)</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timed</span><span class="p">)</span>
		<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_scatter</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">timed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_area_io_seq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">max_scatter</span><span class="p">,</span>
				    <span class="n">timed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write the test area entirely.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase the test area entirely.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span>
			 <span class="n">MMC_ERASE_ARG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup struct mmc_test_area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">mmc_test_free_mem</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize an area for testing large transfers.  The test area is set to the</span>
<span class="cm"> * middle of the card because cards may have different charateristics at the</span>
<span class="cm"> * front (for FAT file system optimization).  Optionally, the area is erased</span>
<span class="cm"> * (if the card supports it) which may improve write performance.  Optionally,</span>
<span class="cm"> * the area is filled with data for subsequent read tests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">erase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fill</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_sz</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_set_blksize</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Make the test area size about 4MiB */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pref_erase</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">&gt;</span> <span class="n">TEST_AREA_MAX_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_seg_size</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">-=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">%</span> <span class="mi">512</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_blk_count</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">max_req_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">/</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">*</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to allocate enough memory for a max. sized transfer.  Less is OK</span>
<span class="cm">	 * because the same memory can be mapped into the scatterlist more than</span>
<span class="cm">	 * once.  Also, take into account the limits imposed on scatterlist</span>
<span class="cm">	 * segments by the host driver.</span>
<span class="cm">	 */</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mmc_test_alloc_mem</span><span class="p">(</span><span class="n">min_sz</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">,</span>
				    <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scatterlist</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">-=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_erase</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_fill</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">mmc_test_area_cleanup</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare for large transfers.  Do not erase the test area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_area_init</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare for large transfers.  Do erase the test area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_prepare_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_area_init</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare for large transfers.  Erase and fill the test area.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_area_prepare_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_area_init</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test best-case performance.  Best-case performance is expected from</span>
<span class="cm"> * a single large transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * An additional option (max_scatter) allows the measurement of the same</span>
<span class="cm"> * transfer but with no contiguous pages in the scatter list.  This tests</span>
<span class="cm"> * the efficiency of DMA to handle scattered pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_best_performance</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">max_scatter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
				<span class="n">max_scatter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Best-case read performance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_best_read_performance</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_best_performance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Best-case write performance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_best_write_performance</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_best_performance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Best-case read performance into scattered pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_best_read_perf_max_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_best_performance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Best-case write performance from scattered pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_best_write_perf_max_scatter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_best_performance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Single read performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_read_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Single write performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_write_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_erase</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_erase</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Single trim performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_trim_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_trim</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">MMC_TRIM_ARG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
		<span class="n">mmc_test_print_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span> <span class="n">MMC_TRIM_ARG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="n">mmc_test_print_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_seq_read_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">/</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Consecutive read performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_seq_read_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_seq_read_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_test_seq_read_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_seq_write_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_erase</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">/</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Consecutive write performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_seq_write_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_seq_write_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mmc_test_seq_write_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Consecutive trim performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_seq_trim_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_trim</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_erase</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_fill</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_sz</span> <span class="o">/</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">,</span>
					<span class="n">MMC_TRIM_ARG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">dev_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
		<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rnd_next</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mmc_test_rnd_num</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rnd_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rnd_next</span> <span class="o">=</span> <span class="n">rnd_next</span> <span class="o">*</span> <span class="mi">1103515245</span> <span class="o">+</span> <span class="mi">12345</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">rnd_next</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">rnd_cnt</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_rnd_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rnd_addr</span><span class="p">,</span> <span class="n">range1</span><span class="p">,</span> <span class="n">range2</span><span class="p">,</span> <span class="n">last_ea</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ea</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ssz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">ts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ssz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">rnd_addr</span> <span class="o">=</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">range1</span> <span class="o">=</span> <span class="n">rnd_addr</span> <span class="o">/</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pref_erase</span><span class="p">;</span>
	<span class="n">range2</span> <span class="o">=</span> <span class="n">range1</span> <span class="o">/</span> <span class="n">ssz</span><span class="p">;</span>

	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">UINT_MAX</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
		<span class="n">ts</span> <span class="o">=</span> <span class="n">timespec_sub</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">ts1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ea</span> <span class="o">=</span> <span class="n">mmc_test_rnd_num</span><span class="p">(</span><span class="n">range1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ea</span> <span class="o">==</span> <span class="n">last_ea</span><span class="p">)</span>
			<span class="n">ea</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">last_ea</span> <span class="o">=</span> <span class="n">ea</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">rnd_addr</span> <span class="o">+</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pref_erase</span> <span class="o">*</span> <span class="n">ea</span> <span class="o">+</span>
			   <span class="n">ssz</span> <span class="o">*</span> <span class="n">mmc_test_rnd_num</span><span class="p">(</span><span class="n">range2</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
		<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_random_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span> <span class="n">sz</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When writing, try to get more consistent results by running</span>
<span class="cm">		 * the test twice with exactly the same I/O but outputting the</span>
<span class="cm">		 * results only for the 2nd run.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">rnd_next</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_rnd_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">rnd_next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_rnd_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">rnd_next</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_rnd_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">rnd_next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mmc_test_rnd_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Random read performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_random_read_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_random_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Random write performance by transfer size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_random_write_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_random_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_seq_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tot_sz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_scatter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">ssz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ts2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the case of a maximally scattered transfer, the maximum transfer</span>
<span class="cm">	 * size is further limited by using PAGE_SIZE segments.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_scatter</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_tfr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_tfr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_segs</span> <span class="o">*</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_seg_sz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">max_tfr</span><span class="p">)</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">max_tfr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_sz</span> <span class="o">&gt;</span> <span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">tot_sz</span> <span class="o">=</span> <span class="n">dev_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">tot_sz</span> <span class="o">/</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span> <span class="cm">/* Round to 64MiB boundary */</span>

	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span>
				       <span class="n">max_scatter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">dev_addr</span> <span class="o">+=</span> <span class="n">ssz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>

	<span class="n">mmc_test_print_avg_rate</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_large_seq_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_seq_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_seq_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_seq_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Large sequential read performance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_large_seq_read_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_large_seq_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Large sequential write performance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_large_seq_write_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_test_large_seq_perf</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_rw_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="o">*</span><span class="n">tdata</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reqsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">min_sg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_area</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up test area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqsize</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">)</span>
		<span class="n">reqsize</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">max_tfr</span><span class="p">;</span>
	<span class="n">dev_addr</span> <span class="o">=</span> <span class="n">mmc_test_capacity</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_addr</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">))</span>
		<span class="n">dev_addr</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span> <span class="cm">/* Round to 64MiB boundary */</span>
	<span class="k">else</span>
		<span class="n">dev_addr</span> <span class="o">&amp;=</span> <span class="mh">0xfffff800</span><span class="p">;</span> <span class="cm">/* Round to 1MiB boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqsize</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* prepare test area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmc_can_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">prepare</span> <span class="o">&amp;</span> <span class="n">MMC_TEST_PREP_ERASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
				<span class="n">size</span> <span class="o">/</span> <span class="mi">512</span><span class="p">,</span> <span class="n">MMC_SECURE_ERASE_ARG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_erase</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
					<span class="n">size</span> <span class="o">/</span> <span class="mi">512</span><span class="p">,</span> <span class="n">MMC_ERASE_ARG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Run test */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_area_io_seq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">reqsize</span><span class="p">,</span> <span class="n">dev_addr</span><span class="p">,</span>
				   <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">do_write</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">/</span> <span class="n">reqsize</span><span class="p">,</span>
				   <span class="n">tdata</span><span class="o">-&gt;</span><span class="n">do_nonblock_req</span><span class="p">,</span> <span class="n">min_sg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="nl">err:</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;[%s] error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_rw_multiple_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="o">*</span><span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pre_req</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pre_req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">post_req</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">post_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span><span class="o">-&gt;</span><span class="n">do_nonblock_req</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">pre_req</span> <span class="o">&amp;&amp;</span> <span class="n">post_req</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pre_req</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">post_req</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;error: only one of pre/post is defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_rw_multiple</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">bs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_rw_multiple_sg_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="o">*</span><span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_rw_multiple</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">rw</span><span class="p">,</span> <span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">rw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					   <span class="n">rw</span><span class="o">-&gt;</span><span class="n">sg_len</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple blocking write 4k to 4 MB chunks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_mult_write_blocking_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
			     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_ERASE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_size</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple non-blocking write 4k to 4 MB chunks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_mult_write_nonblock_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
			     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_ERASE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_size</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple blocking read 4k to 4 MB chunks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_mult_read_blocking_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
			     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_NONE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_size</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple non-blocking read 4k to 4 MB chunks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_mult_read_nonblock_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span>
			     <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_NONE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_size</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple blocking write 1 to 512 sg elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_sglen_wr_blocking_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sg_len</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_ERASE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_sg_len</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple non-blocking write 1 to 512 sg elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_sglen_wr_nonblock_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sg_len</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_ERASE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_sg_len</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple blocking read 1 to 512 sg elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_sglen_r_blocking_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sg_len</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_NONE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_sg_len</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multiple non-blocking read 1 to 512 sg elements</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_profile_sglen_r_nonblock_perf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_len</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">,</span>
				 <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">mmc_test_multiple_rw</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">TEST_AREA_MAX_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sg_len</span><span class="p">),</span>
		<span class="p">.</span><span class="n">do_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">do_nonblock_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">MMC_TEST_PREP_NONE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">mmc_test_rw_multiple_sg_len</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * eMMC hardware reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mmc_hw_reset_check</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESULT_FAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_can_reset</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RESULT_UNSUP_CARD</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RESULT_UNSUP_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mmc_test_case</span> <span class="n">mmc_test_cases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Basic write (no data verification)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_basic_write</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Basic read (no data verification)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_basic_read</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Basic write (with data verification)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_verify_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Basic read (with data verification)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_verify_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Power of two block writes&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_pow2_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Power of two block reads&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_pow2_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Weird sized block writes&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_weird_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Weird sized block reads&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_weird_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Badly aligned write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_align_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Badly aligned read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_align_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Badly aligned multi-block write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_align_multi_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Badly aligned multi-block read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_align_multi_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Correct xfer_size at write (start failure)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_xfersize_write</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Correct xfer_size at read (start failure)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_xfersize_read</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Correct xfer_size at write (midway failure)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_xfersize_write</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Correct xfer_size at read (midway failure)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_xfersize_read</span><span class="p">,</span>
	<span class="p">},</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Highmem write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_write_high</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Highmem read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_read_high</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block highmem write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_write_high</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block highmem read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_prepare_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_multi_read_high</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

<span class="cp">#else</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Highmem write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_no_highmem</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Highmem read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_no_highmem</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block highmem write&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_no_highmem</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi-block highmem read&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_no_highmem</span><span class="p">,</span>
	<span class="p">},</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HIGHMEM */</span><span class="cp"></span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Best-case read performance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_fill</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_best_read_performance</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Best-case write performance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_erase</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_best_write_performance</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Best-case read performance into scattered pages&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_fill</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_best_read_perf_max_scatter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Best-case write performance from scattered pages&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_erase</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_best_write_perf_max_scatter</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Single read performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_fill</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_read_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Single write performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_write_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Single trim performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_fill</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_trim_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Consecutive read performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare_fill</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_seq_read_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Consecutive write performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_seq_write_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Consecutive trim performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_seq_trim_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Random read performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_random_read_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Random write performance by transfer size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_random_write_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Large sequential read into scattered pages&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_large_seq_read_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Large sequential write from scattered pages&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_large_seq_write_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Write performance with blocking req 4k to 4MB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_mult_write_blocking_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Write performance with non-blocking req 4k to 4MB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_mult_write_nonblock_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Read performance with blocking req 4k to 4MB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_mult_read_blocking_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Read performance with non-blocking req 4k to 4MB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_mult_read_nonblock_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Write performance blocking req 1 to 512 sg elems&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_sglen_wr_blocking_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Write performance non-blocking req 1 to 512 sg elems&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_sglen_wr_nonblock_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Read performance blocking req 1 to 512 sg elems&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_sglen_r_blocking_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Read performance non-blocking req 1 to 512 sg elems&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mmc_test_area_prepare</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_profile_sglen_r_nonblock_perf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">mmc_test_area_cleanup</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;eMMC hardware reset&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">mmc_test_hw_reset</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mmc_test_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mmc_test_result</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="kt">int</span> <span class="n">testcase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Starting tests of card %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">mmc_card_id</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>

	<span class="n">mmc_claim_host</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_test_cases</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_test_general_result</span> <span class="o">*</span><span class="n">gr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">testcase</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">testcase</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Test case %d. %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prepare</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prepare</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: Prepare &quot;</span>
					<span class="s">&quot;stage failed! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
					<span class="n">ret</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">gr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_general_result</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">tr_lst</span><span class="p">);</span>

			<span class="cm">/* Assign data what we know already */</span>
			<span class="n">gr</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
			<span class="n">gr</span><span class="o">-&gt;</span><span class="n">testcase</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Append container to global one */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_test_result</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Save the pointer to created container in our private</span>
<span class="cm">			 * structure.</span>
<span class="cm">			 */</span>
			<span class="n">test</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">=</span> <span class="n">gr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">run</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RESULT_OK</span>:
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESULT_FAIL</span>:
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESULT_UNSUP_HOST</span>:
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: UNSUPPORTED &quot;</span>
				<span class="s">&quot;(by host)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RESULT_UNSUP_CARD</span>:
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: UNSUPPORTED &quot;</span>
				<span class="s">&quot;(by card)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Result: ERROR (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Save the result */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gr</span><span class="p">)</span>
			<span class="n">gr</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cleanup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cleanup</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Warning: Cleanup &quot;</span>
					<span class="s">&quot;stage failed! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">),</span>
					<span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mmc_release_host</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Tests completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmc_hostname</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mmc_test_free_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_general_result</span> <span class="o">*</span><span class="n">gr</span><span class="p">,</span> <span class="o">*</span><span class="n">grs</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">gr</span><span class="p">,</span> <span class="n">grs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_test_result</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_test_transfer_result</span> <span class="o">*</span><span class="n">tr</span><span class="p">,</span> <span class="o">*</span><span class="n">trs</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">gr</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">trs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">tr_lst</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mmc_test_file_test</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtf_test_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="p">)</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_general_result</span> <span class="o">*</span><span class="n">gr</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_test_result</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mmc_test_transfer_result</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="s">&quot;Test %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gr</span><span class="o">-&gt;</span><span class="n">testcase</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gr</span><span class="o">-&gt;</span><span class="n">tr_lst</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="s">&quot;%u %d %lu.%09lu %u %u.%02u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">sectors</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">,</span>
				<span class="n">tr</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">iops</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">iops</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtf_test_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mtf_test_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mtf_test_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">sf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">)</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="p">)</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_card</span> <span class="o">*</span><span class="n">test</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">lbuf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">testcase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">lbuf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtol</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">testcase</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">test</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_card</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove all test cases associated with given card. Thus we have only</span>
<span class="cm">	 * actual data of the last run.</span>
<span class="cm">	 */</span>
	<span class="n">mmc_test_free_result</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">test</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HIGHMEM</span>
	<span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_HIGHMEM</span><span class="p">,</span> <span class="n">BUFFER_ORDER</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>
		<span class="n">mmc_test_run</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">testcase</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HIGHMEM</span>
	<span class="n">__free_pages</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">highmem</span><span class="p">,</span> <span class="n">BUFFER_ORDER</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mmc_test_fops_test</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mtf_test_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">mtf_test_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mtf_testlist_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mmc_test_cases</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="s">&quot;%d:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mmc_test_cases</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mtf_testlist_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mtf_testlist_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mmc_test_fops_testlist</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mtf_testlist_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mmc_test_free_dbgfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mmc_test_dbgfs_file</span> <span class="o">*</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">dfs</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_test_file_test</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">df</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">df</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__mmc_test_register_dbgfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mmc_test_dbgfs_file</span> <span class="o">*</span><span class="n">df</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">)</span>
		<span class="n">file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span>
			<span class="n">card</span><span class="p">,</span> <span class="n">fops</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can&#39;t create %s. Perhaps debugfs is disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">df</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_test_dbgfs_file</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">df</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can&#39;t allocate memory for internal usage.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">df</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">df</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">df</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mmc_test_file_test</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mmc_test_register_dbgfs_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__mmc_test_register_dbgfs_file</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mmc_test_fops_test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__mmc_test_register_dbgfs_file</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;testlist&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mmc_test_fops_testlist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_test_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mmc_test_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmc_card_mmc</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mmc_card_sd</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mmc_test_register_dbgfs_file</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Card claimed for testing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mmc_test_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">mmc_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mmc_test_free_result</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">mmc_test_free_dbgfs_file</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mmc_driver</span> <span class="n">mmc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drv</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;mmc_test&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mmc_test_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mmc_test_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">mmc_test_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mmc_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">mmc_test_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Clear stalled data if card is still plugged */</span>
	<span class="n">mmc_test_free_result</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mmc_test_free_dbgfs_file</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mmc_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mmc_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mmc_test_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mmc_test_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Multimedia Card (MMC) host test driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pierre Ossman&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
