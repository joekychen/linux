<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › 3w-9xxx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>3w-9xxx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   3w-9xxx.c -- 3ware 9000 Storage Controller device driver for Linux.</span>

<span class="cm">   Written By: Adam Radford &lt;linuxraid@lsi.com&gt;</span>
<span class="cm">   Modifications By: Tom Couch &lt;linuxraid@lsi.com&gt;</span>

<span class="cm">   Copyright (C) 2004-2009 Applied Micro Circuits Corporation.</span>
<span class="cm">   Copyright (C) 2010 LSI Corporation.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; version 2 of the License.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   NO WARRANTY</span>
<span class="cm">   THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">   CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">   LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">   solely responsible for determining the appropriateness of using and</span>
<span class="cm">   distributing the Program and assumes all risks associated with its</span>
<span class="cm">   exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">   the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">   programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">   DISCLAIMER OF LIABILITY</span>
<span class="cm">   NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">   DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">   TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">   USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">   HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">   Bugs/Comments/Suggestions should be mailed to:</span>
<span class="cm">   linuxraid@lsi.com</span>

<span class="cm">   For more information, goto:</span>
<span class="cm">   http://www.lsi.com</span>

<span class="cm">   Note: This version of the driver does not contain a bundled firmware</span>
<span class="cm">         image.</span>

<span class="cm">   History</span>
<span class="cm">   -------</span>
<span class="cm">   2.26.02.000 - Driver cleanup for kernel submission.</span>
<span class="cm">   2.26.02.001 - Replace schedule_timeout() calls with msleep().</span>
<span class="cm">   2.26.02.002 - Add support for PAE mode.</span>
<span class="cm">                 Add lun support.</span>
<span class="cm">                 Fix twa_remove() to free irq handler/unregister_chrdev()</span>
<span class="cm">                 before shutting down card.</span>
<span class="cm">                 Change to new &#39;change_queue_depth&#39; api.</span>
<span class="cm">                 Fix &#39;handled=1&#39; ISR usage, remove bogus IRQ check.</span>
<span class="cm">                 Remove un-needed eh_abort handler.</span>
<span class="cm">                 Add support for embedded firmware error strings.</span>
<span class="cm">   2.26.02.003 - Correctly handle single sgl&#39;s with use_sg=1.</span>
<span class="cm">   2.26.02.004 - Add support for 9550SX controllers.</span>
<span class="cm">   2.26.02.005 - Fix use_sg == 0 mapping on systems with 4GB or higher.</span>
<span class="cm">   2.26.02.006 - Fix 9550SX pchip reset timeout.</span>
<span class="cm">                 Add big endian support.</span>
<span class="cm">   2.26.02.007 - Disable local interrupts during kmap/unmap_atomic().</span>
<span class="cm">   2.26.02.008 - Free irq handler in __twa_shutdown().</span>
<span class="cm">                 Serialize reset code.</span>
<span class="cm">                 Add support for 9650SE controllers.</span>
<span class="cm">   2.26.02.009 - Fix dma mask setting to fallback to 32-bit if 64-bit fails.</span>
<span class="cm">   2.26.02.010 - Add support for 9690SA controllers.</span>
<span class="cm">   2.26.02.011 - Increase max AENs drained to 256.</span>
<span class="cm">                 Add MSI support and &quot;use_msi&quot; module parameter.</span>
<span class="cm">                 Fix bug in twa_get_param() on 4GB+.</span>
<span class="cm">                 Use pci_resource_len() for ioremap().</span>
<span class="cm">   2.26.02.012 - Add power management support.</span>
<span class="cm">   2.26.02.013 - Fix bug in twa_load_sgl().</span>
<span class="cm">   2.26.02.014 - Force 60 second timeout default.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &quot;3w-9xxx.h&quot;</span>

<span class="cm">/* Globals */</span>
<span class="cp">#define TW_DRIVER_VERSION &quot;2.26.02.014&quot;</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">twa_chrdev_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">twa_device_extension_list</span><span class="p">[</span><span class="n">TW_MAX_SLOT</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">twa_device_extension_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="n">sys_tz</span><span class="p">;</span>

<span class="cm">/* Module parameters */</span>
<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;LSI&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;3ware 9000 Storage Controller Linux Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">TW_DRIVER_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_msi</span><span class="p">,</span> <span class="s">&quot;Use Message Signaled Interrupts.  Default: 0&quot;</span><span class="p">);</span>

<span class="cm">/* Function prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_aen_queue_event</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="n">header</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_aen_read_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twa_aen_severity_lookup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">severity_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_aen_sync_time</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">twa_chrdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_chrdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_fill_sense</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copy_sense</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_host</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">request_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_get_request_id</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">request_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_initconnection</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">message_credits</span><span class="p">,</span>
 			      <span class="n">u32</span> <span class="n">set_features</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_srl</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_arch_id</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_branch</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_build</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_srl</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_arch_id</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_branch</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_build</span><span class="p">,</span> 
			      <span class="n">u32</span> <span class="o">*</span><span class="n">init_connect_result</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_load_sgl</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_poll_response</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_poll_status_gone</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">internal</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_reset_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_reset_sequence</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">soft_reset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_scsiop_execute_scsi</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_sg</span><span class="p">,</span> <span class="n">TW_SG_Entry</span> <span class="o">*</span><span class="n">sglistarg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_scsiop_execute_scsi_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">twa_string_lookup</span><span class="p">(</span><span class="n">twa_message_type</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aen_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">);</span>

<span class="cm">/* Functions */</span>

<span class="cm">/* Show some statistics about the card */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">twa_show_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;3w-9xxx Driver version: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Current commands posted:   %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max commands posted:       %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Current pending commands:  %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max pending commands:      %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Last sgl length:           %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max sgl length:            %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Last sector count:         %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;Max sector count:          %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;SCSI Host Resets:          %4d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;AEN&#39;s:                     %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">TW_DRIVER_VERSION</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="p">,</span>
		       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_show_stats() */</span>

<span class="cm">/* This function will set a devices queue depth */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue_depth</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MSG_ORDERED_TAG</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_change_queue_depth() */</span>

<span class="cm">/* Create sysfs &#39;stats&#39; entry */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">twa_host_stats_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> 	<span class="s">&quot;stats&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span>		<span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">twa_show_stats</span>
<span class="p">};</span>

<span class="cm">/* Host attributes initializer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">twa_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">twa_host_stats_attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* File operations struct for character device */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">twa_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">twa_chrdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">twa_chrdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This function will complete an aen request from the isr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_aen_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">aen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">;</span>

	<span class="cm">/* First check for internal completion of set param for time sync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TW_OP_OUT</span><span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span><span class="p">)</span> <span class="o">==</span> <span class="n">TW_OP_SET_PARAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Keep reading the queue in case there are more aen&#39;s */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_aen_read_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	        <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TW_AEN_QUEUE_EMPTY</span>:
		<span class="cm">/* Quit reading the queue if this is the last one */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_AEN_SYNC_TIME_WITH_HOST</span>:
		<span class="n">twa_aen_sync_time</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">twa_aen_queue_event</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>

		<span class="cm">/* If there are more aen&#39;s, keep reading the queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_aen_read_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
	<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TW_IN_ATTENTION_LOOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_complete() */</span>

<span class="cm">/* This function will drain aen queue */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_aen_drain_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_check_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cdb</span><span class="p">[</span><span class="n">TW_MAX_CDB_LEN</span><span class="p">];</span>
	<span class="n">TW_SG_Entry</span> <span class="n">sglist</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_check_reset</span><span class="p">)</span>
		<span class="n">first_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">first_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>

	<span class="cm">/* Initialize cdb */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">);</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span> <span class="cm">/* opcode */</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_ALLOCATION_LENGTH</span><span class="p">;</span> <span class="cm">/* allocation length */</span>

	<span class="cm">/* Initialize sglist */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sglist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_SG_Entry</span><span class="p">));</span>
	<span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">&amp;</span> <span class="n">TW_ALIGNMENT_9000_SGL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="s">&quot;Found unaligned address during AEN drain&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mark internal command */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Send command to the board */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_scsiop_execute_scsi</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sglist</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="s">&quot;Error posting request sense&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now poll for completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_poll_response</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="s">&quot;No valid response while draining AEN queue&quot;</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
		<span class="n">aen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">aen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TW_AEN_QUEUE_EMPTY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">first_reset</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TW_AEN_SOFT_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">first_reset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">first_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TW_AEN_SYNC_TIME_WITH_HOST</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now queue an event info */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="p">)</span>
			<span class="n">twa_aen_queue_event</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">finished</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">TW_MAX_AEN_DRAIN</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">TW_MAX_AEN_DRAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_drain_queue() */</span>

<span class="cm">/* This function will queue an event */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_aen_queue_event</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_Command_Apache_Header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">local_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">time</span><span class="p">;</span>
	<span class="n">TW_Event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">host</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">error_str</span><span class="p">;</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Fill out event info */</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">];</span>

	<span class="cm">/* Check for clobber */</span>
	<span class="n">host</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="s">&quot; scsi%d:&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">==</span> <span class="n">TW_AEN_NOT_RETRIEVED</span><span class="p">)</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">));</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">severity</span> <span class="o">=</span> <span class="n">TW_SEV_OUT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">.</span><span class="n">severity__reserved</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time</span><span class="p">);</span>
	<span class="n">local_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">sys_tz</span><span class="p">.</span><span class="n">tz_minuteswest</span> <span class="o">*</span> <span class="mi">60</span><span class="p">));</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">time_stamp_sec</span> <span class="o">=</span> <span class="n">local_time</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">aen_code</span> <span class="o">=</span> <span class="n">aen</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">TW_AEN_NOT_RETRIEVED</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">sequence_id</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_sequence_id</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_sequence_id</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Check for embedded error string */</span>
	<span class="n">error_str</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter_data</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter_len</span> <span class="o">+</span> <span class="p">(</span><span class="n">error_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">error_str</span><span class="p">))));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">severity</span> <span class="o">!=</span> <span class="n">TW_AEN_SEVERITY_DEBUG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx:%s AEN: %s (0x%02X:0x%04X): %s:%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">host</span><span class="p">,</span>
		       <span class="n">twa_aen_severity_lookup</span><span class="p">(</span><span class="n">TW_SEV_OUT</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">status_block</span><span class="p">.</span><span class="n">severity__reserved</span><span class="p">)),</span>
		       <span class="n">TW_MESSAGE_SOURCE_CONTROLLER_EVENT</span><span class="p">,</span> <span class="n">aen</span><span class="p">,</span>
		       <span class="n">error_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">?</span> <span class="n">twa_string_lookup</span><span class="p">(</span><span class="n">twa_aen_table</span><span class="p">,</span> <span class="n">aen</span><span class="p">)</span> <span class="o">:</span> <span class="n">error_str</span><span class="p">,</span>
		       <span class="n">header</span><span class="o">-&gt;</span><span class="n">err_specific_desc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">TW_Q_LENGTH</span><span class="p">)</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue_wrapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_queue_event() */</span>

<span class="cm">/* This function will read the aen queue from the isr */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_aen_read_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cdb</span><span class="p">[</span><span class="n">TW_MAX_CDB_LEN</span><span class="p">];</span>
	<span class="n">TW_SG_Entry</span> <span class="n">sglist</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>

	<span class="cm">/* Initialize cdb */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">);</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REQUEST_SENSE</span><span class="p">;</span> <span class="cm">/* opcode */</span>
	<span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_ALLOCATION_LENGTH</span><span class="p">;</span> <span class="cm">/* allocation length */</span>

	<span class="cm">/* Initialize sglist */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sglist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_SG_Entry</span><span class="p">));</span>
	<span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">;</span>
	<span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="cm">/* Mark internal command */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Now post the command packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_scsiop_execute_scsi</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sglist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="s">&quot;Post failed while reading AEN queue&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_read_queue() */</span>

<span class="cm">/* This function will look up an AEN severity string */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">twa_aen_severity_lookup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">severity_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">retval</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">severity_code</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">TW_AEN_SEVERITY_ERROR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">severity_code</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">TW_AEN_SEVERITY_DEBUG</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">twa_aen_severity_table</span><span class="p">[</span><span class="n">severity_code</span><span class="p">];</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_severity_lookup() */</span>

<span class="cm">/* This function will sync firmware time with the host time */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_aen_sync_time</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">schedulertime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">utc</span><span class="p">;</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Param_Apache</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_time</span><span class="p">;</span>

	<span class="cm">/* Fill out the command packet */</span>
	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_SET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8_offset</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8_offset</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">TW_COMMAND_SIZE</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6_offset</span><span class="p">.</span><span class="n">parameter_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup the param */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param_Apache</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_TIMEKEEP_TABLE</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span> <span class="cm">/* Controller time keep table */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3</span><span class="p">);</span> <span class="cm">/* SchedulerTime */</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Convert system time in UTC to local time seconds since last </span>
<span class="cm">           Sunday 12:00AM */</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">utc</span><span class="p">);</span>
	<span class="n">local_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">utc</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="p">(</span><span class="n">sys_tz</span><span class="p">.</span><span class="n">tz_minuteswest</span> <span class="o">*</span> <span class="mi">60</span><span class="p">));</span>
	<span class="n">schedulertime</span> <span class="o">=</span> <span class="n">local_time</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">);</span>
	<span class="n">schedulertime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">schedulertime</span> <span class="o">%</span> <span class="mi">604800</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">schedulertime</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/* Mark internal command */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Now post the command */</span>
	<span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_aen_sync_time() */</span>

<span class="cm">/* This function will allocate memory and check if it is correctly aligned */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_allocate_memory</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="s">&quot;Memory allocation failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">%</span> <span class="p">(</span><span class="n">TW_ALIGNMENT_9000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="s">&quot;Failed to allocate correctly aligned memory&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Command_Full</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_allocate_memory() */</span>

<span class="cm">/* This function will check the status register for unexpected bits */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_check_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_EXPECTED_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TW_STATUS_EXPECTED_BITS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_UNEXPECTED_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_check_bits() */</span>

<span class="cm">/* This function will check the srl and decide if we are compatible  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_check_srl</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flashed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fw_on_ctlr_srl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw_on_ctlr_arch_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fw_on_ctlr_branch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw_on_ctlr_build</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init_connect_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_INIT_MESSAGE_CREDITS</span><span class="p">,</span>
			       <span class="n">TW_EXTENDED_INIT_CONNECT</span><span class="p">,</span> <span class="n">TW_CURRENT_DRIVER_SRL</span><span class="p">,</span>
			       <span class="n">TW_9000_ARCH_ID</span><span class="p">,</span> <span class="n">TW_CURRENT_DRIVER_BRANCH</span><span class="p">,</span>
			       <span class="n">TW_CURRENT_DRIVER_BUILD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_on_ctlr_srl</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fw_on_ctlr_arch_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_on_ctlr_branch</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fw_on_ctlr_build</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_connect_result</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="s">&quot;Initconnection failed while checking SRL&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_srl</span> <span class="o">=</span> <span class="n">fw_on_ctlr_srl</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_branch</span> <span class="o">=</span> <span class="n">fw_on_ctlr_branch</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_build</span> <span class="o">=</span> <span class="n">fw_on_ctlr_build</span><span class="p">;</span>

	<span class="cm">/* Try base mode compatibility */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">init_connect_result</span> <span class="o">&amp;</span> <span class="n">TW_CTLR_FW_COMPATIBLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_INIT_MESSAGE_CREDITS</span><span class="p">,</span>
				       <span class="n">TW_EXTENDED_INIT_CONNECT</span><span class="p">,</span>
				       <span class="n">TW_BASE_FW_SRL</span><span class="p">,</span> <span class="n">TW_9000_ARCH_ID</span><span class="p">,</span>
				       <span class="n">TW_BASE_FW_BRANCH</span><span class="p">,</span> <span class="n">TW_BASE_FW_BUILD</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">fw_on_ctlr_srl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_on_ctlr_arch_id</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">fw_on_ctlr_branch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_on_ctlr_build</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">init_connect_result</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="s">&quot;Initconnection (base mode) failed while checking SRL&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">init_connect_result</span> <span class="o">&amp;</span> <span class="n">TW_CTLR_FW_COMPATIBLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TW_CURRENT_DRIVER_SRL</span> <span class="o">&gt;</span> <span class="n">fw_on_ctlr_srl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="s">&quot;Firmware and driver incompatibility: please upgrade firmware&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="s">&quot;Firmware and driver incompatibility: please upgrade driver&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_srl</span> <span class="o">=</span> <span class="n">TW_BASE_FW_SRL</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_branch</span> <span class="o">=</span> <span class="n">TW_BASE_FW_BRANCH</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_build</span> <span class="o">=</span> <span class="n">TW_BASE_FW_BUILD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load rest of compatibility struct */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_version</span><span class="p">,</span> <span class="n">TW_DRIVER_VERSION</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">TW_DRIVER_VERSION</span><span class="p">));</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_srl_high</span> <span class="o">=</span> <span class="n">TW_CURRENT_DRIVER_SRL</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_branch_high</span> <span class="o">=</span> <span class="n">TW_CURRENT_DRIVER_BRANCH</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_build_high</span> <span class="o">=</span> <span class="n">TW_CURRENT_DRIVER_BUILD</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_srl_low</span> <span class="o">=</span> <span class="n">TW_BASE_FW_SRL</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_branch_low</span> <span class="o">=</span> <span class="n">TW_BASE_FW_BRANCH</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">driver_build_low</span> <span class="o">=</span> <span class="n">TW_BASE_FW_BUILD</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">fw_on_ctlr_srl</span> <span class="o">=</span> <span class="n">fw_on_ctlr_srl</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">fw_on_ctlr_branch</span> <span class="o">=</span> <span class="n">fw_on_ctlr_branch</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">fw_on_ctlr_build</span> <span class="o">=</span> <span class="n">fw_on_ctlr_build</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_check_srl() */</span>

<span class="cm">/* This function handles ioctl for the character device */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">twa_chrdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sequence_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">event_index</span><span class="p">,</span> <span class="n">start_index</span><span class="p">;</span>
	<span class="n">TW_Ioctl_Driver_Command</span> <span class="n">driver_command</span><span class="p">;</span>
	<span class="n">TW_Ioctl_Buf_Apache</span> <span class="o">*</span><span class="n">tw_ioctl</span><span class="p">;</span>
	<span class="n">TW_Lock</span> <span class="o">*</span><span class="n">tw_lock</span><span class="p">;</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Compatibility_Info</span> <span class="o">*</span><span class="n">tw_compat_info</span><span class="p">;</span>
	<span class="n">TW_Event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">current_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_time_ms</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="n">twa_device_extension_list</span><span class="p">[</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_EFAULT</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twa_chrdev_mutex</span><span class="p">);</span>

	<span class="cm">/* Only let one of these through at a time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* First copy down the driver command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_command</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Driver_Command</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="cm">/* Check data buffer size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver_command</span><span class="p">.</span><span class="n">buffer_length</span> <span class="o">&gt;</span> <span class="n">TW_MAX_SECTORS</span> <span class="o">*</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware can only do multiple of 512 byte transfers */</span>
	<span class="n">data_buffer_length_adjusted</span> <span class="o">=</span> <span class="p">(</span><span class="n">driver_command</span><span class="p">.</span><span class="n">buffer_length</span> <span class="o">+</span> <span class="mi">511</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">511</span><span class="p">;</span>

	<span class="cm">/* Now allocate ioctl buf memory */</span>
	<span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_ioctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span> <span class="o">*</span><span class="p">)</span><span class="n">cpu_addr</span><span class="p">;</span>

	<span class="cm">/* Now copy down the entire ioctl */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="n">driver_command</span><span class="p">.</span><span class="n">buffer_length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="cm">/* See which ioctl we are doing */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_FIRMWARE_PASS_THROUGH</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">twa_get_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>

		<span class="cm">/* Flag internal command */</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Flag chrdev ioctl */</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>

		<span class="n">full_command_packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">;</span>

		<span class="cm">/* Load request id and sglist for both command types */</span>
		<span class="n">twa_load_sgl</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">full_command_packet</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>

		<span class="cm">/* Now post the command packet to the controller */</span>
		<span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_TIMEOUT</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

		<span class="cm">/* Now wait for command to complete */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">==</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

		<span class="cm">/* We timed out, and didn&#39;t get an interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">!=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Now we need to reset the board */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: scsi%d: WARNING: (0x%02X:0x%04X): Character ioctl (0x%x) timed out, resetting card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_EIO</span><span class="p">;</span>
			<span class="n">twa_reset_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now copy in the command packet response */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">firmware_command</span><span class="p">),</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>
		
		<span class="cm">/* Now complete the io */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_COMPATIBILITY_INFO</span>:
		<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Copy compatibility struct into ioctl data buffer */</span>
		<span class="n">tw_compat_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Compatibility_Info</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_compat_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Compatibility_Info</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_LAST_EVENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue_wrapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">TW_Q_LENGTH</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">TW_AEN_RETRIEVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_FIRST_EVENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue_wrapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> 
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">event_index</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">event_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">TW_AEN_RETRIEVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_NEXT_EVENT</span>:
		<span class="n">event</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Event</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">;</span>
		<span class="n">sequence_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">sequence_id</span><span class="p">;</span>
		<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue_wrapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">start_index</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="n">sequence_id</span> <span class="o">-</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">start_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sequence_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sequence_id</span> <span class="o">&gt;</span> <span class="n">sequence_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">)</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">TW_AEN_RETRIEVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_PREVIOUS_EVENT</span>:
		<span class="n">event</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Event</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">;</span>
		<span class="n">sequence_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">sequence_id</span><span class="p">;</span>
		<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue_wrapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">start_index</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">event_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_index</span> <span class="o">+</span> <span class="n">sequence_id</span> <span class="o">-</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">start_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sequence_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sequence_id</span> <span class="o">&lt;</span> <span class="n">sequence_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TW_IOCTL_ERROR_STATUS_AEN_CLOBBER</span><span class="p">)</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">aen_clobber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">event_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">TW_AEN_RETRIEVED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_GET_LOCK</span>:
		<span class="n">tw_lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Lock</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">data_buffer</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_time</span><span class="p">);</span>
		<span class="n">current_time_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">current_time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tw_lock</span><span class="o">-&gt;</span><span class="n">force_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_sem_lock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">current_time_ms</span> <span class="o">&gt;=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_msec</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_sem_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_msec</span> <span class="o">=</span> <span class="n">current_time_ms</span> <span class="o">+</span> <span class="n">tw_lock</span><span class="o">-&gt;</span><span class="n">timeout_msec</span><span class="p">;</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tw_lock</span><span class="o">-&gt;</span><span class="n">time_remaining_msec</span> <span class="o">=</span> <span class="n">tw_lock</span><span class="o">-&gt;</span><span class="n">timeout_msec</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_LOCKED</span><span class="p">;</span>
			<span class="n">tw_lock</span><span class="o">-&gt;</span><span class="n">time_remaining_msec</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_msec</span> <span class="o">-</span> <span class="n">current_time_ms</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TW_IOCTL_RELEASE_LOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_sem_lock</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_sem_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw_ioctl</span><span class="o">-&gt;</span><span class="n">driver_command</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_STATUS_NOT_LOCKED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_ENOTTY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now copy the entire response to userspace */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">tw_ioctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">+</span> <span class="n">driver_command</span><span class="p">.</span><span class="n">buffer_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out3:</span>
	<span class="cm">/* Now free ioctl buf memory */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data_buffer_length_adjusted</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twa_chrdev_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_chrdev_ioctl() */</span>

<span class="cm">/* This function handles open for the character device */</span>
<span class="cm">/* NOTE that this function will race with remove. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_chrdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">TW_IOCTL_ERROR_OS_ENODEV</span><span class="p">;</span>

	<span class="n">minor_number</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor_number</span> <span class="o">&gt;=</span> <span class="n">twa_device_extension_count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_chrdev_open() */</span>

<span class="cm">/* This function will print readable messages from status register errors */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_decode_bits</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check for various error conditions and handle them appropriately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_PCI_PARITY_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="s">&quot;PCI Parity Error: clearing&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_PARITY_ERROR</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_PCI_ABORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="s">&quot;PCI Abort: clearing&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_PCI_ABORT</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">TW_PCI_CLEAR_PCI_ABORT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_QUEUE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_3WARE_9650SE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">,</span> <span class="s">&quot;Controller Queue Error: clearing&quot;</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TW_CONTROL_CLEAR_QUEUE_ERROR</span><span class="p">,</span> <span class="n">TW_CONTROL_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_MICROCONTROLLER_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;Microcontroller Error: clearing&quot;</span><span class="p">);</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_decode_bits() */</span>

<span class="cm">/* This function will empty the response queue */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_empty_response_queue</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">,</span> <span class="n">response_que_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">TW_MAX_RESPONSE_DRAIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">response_que_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">TW_MAX_RESPONSE_DRAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_empty_response_queue() */</span>

<span class="cm">/* This function will clear the pchip/response queue on 9550SX */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_empty_response_queue_large</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">response_que_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_3WARE_9000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">before</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">response_que_value</span> <span class="o">&amp;</span> <span class="n">TW_9550SX_DRAIN_COMPLETED</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TW_9550SX_DRAIN_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">response_que_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR_LARGE</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">30</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* P-chip settle time */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_empty_response_queue_large() */</span>

<span class="cm">/* This function passes sense keys from firmware to scsi layer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_fill_sense</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">copy_sense</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">error_str</span><span class="p">;</span>

	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="cm">/* Check for embedded error string */</span>
	<span class="n">error_str</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">err_specific_desc</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">err_specific_desc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Don&#39;t print error for Logical unit not supported during rollcall */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">!=</span> <span class="n">TW_ERROR_LOGICAL_UNIT_NOT_SUPPORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">TW_ERROR_UNIT_OFFLINE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_host</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: scsi%d: ERROR: (0x%02X:0x%04X): %s:%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			       <span class="n">TW_MESSAGE_SOURCE_CONTROLLER_ERROR</span><span class="p">,</span>
			       <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
			       <span class="n">error_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">?</span>
			       <span class="n">twa_string_lookup</span><span class="p">(</span><span class="n">twa_error_table</span><span class="p">,</span>
						 <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="o">:</span> <span class="n">error_str</span><span class="p">,</span>
			       <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">err_specific_desc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: ERROR: (0x%02X:0x%04X): %s:%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">TW_MESSAGE_SOURCE_CONTROLLER_ERROR</span><span class="p">,</span>
			       <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
			       <span class="n">error_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">?</span>
			       <span class="n">twa_string_lookup</span><span class="p">(</span><span class="n">twa_error_table</span><span class="p">,</span>
						 <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="o">:</span> <span class="n">error_str</span><span class="p">,</span>
			       <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">err_specific_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">sense_data</span><span class="p">,</span> <span class="n">TW_SENSE_DATA_LENGTH</span><span class="p">);</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">TW_ISR_DONT_RESULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_fill_sense() */</span>

<span class="cm">/* This function will free up device extension resources */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_free_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">)</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span>
				    <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="p">,</span>
				    <span class="n">TW_SECTOR_SIZE</span><span class="o">*</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span>
				    <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				    <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> <span class="cm">/* End twa_free_device_extension() */</span>

<span class="cm">/* This function will free a request id */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_free_request_id</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_FINISHED</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_free_request_id() */</span>

<span class="cm">/* This function will get parameter table entries from the firmware */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">twa_get_param</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">table_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parameter_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parameter_size_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">TW_Param_Apache</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">retval</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Setup the command packet */</span>
	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>
	<span class="n">command_packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">;</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span> <span class="o">=</span> <span class="n">TW_OPSGL_IN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TW_OP_GET_PARAM</span><span class="p">);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">size</span>              <span class="o">=</span> <span class="n">TW_COMMAND_SIZE</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id</span>        <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte6_offset</span><span class="p">.</span><span class="n">block_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Now setup the param */</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Param_Apache</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">table_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">table_id</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">parameter_id</span><span class="p">);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">parameter_size_bytes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">parameter_size_bytes</span><span class="p">);</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8_offset</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">byte8_offset</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">sgl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>

	<span class="cm">/* Post the command packet to the board */</span>
	<span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Poll for completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_poll_response</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="s">&quot;No valid response during get param&quot;</span><span class="p">)</span>
	<span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_get_param() */</span>

<span class="cm">/* This function will assign an available request id */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_get_request_id</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span><span class="p">];</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="o">*</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_STARTED</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_get_request_id() */</span>

<span class="cm">/* This function will send an initconnection command to controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_initconnection</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">message_credits</span><span class="p">,</span>
 			      <span class="n">u32</span> <span class="n">set_features</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_srl</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_arch_id</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_branch</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_fw_build</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_srl</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_arch_id</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_branch</span><span class="p">,</span> 
			      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fw_on_ctlr_build</span><span class="p">,</span> 
			      <span class="n">u32</span> <span class="o">*</span><span class="n">init_connect_result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Initconnect</span> <span class="o">*</span><span class="n">tw_initconnect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Initialize InitConnection command packet */</span>
	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">));</span>
	<span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">header_desc</span><span class="p">.</span><span class="n">size_header</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	
	<span class="n">tw_initconnect</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Initconnect</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">;</span>
	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">opcode__reserved</span> <span class="o">=</span> <span class="n">TW_OPRES_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TW_OP_INIT_CONNECTION</span><span class="p">);</span>
	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">message_credits</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">message_credits</span><span class="p">);</span>
	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">set_features</span><span class="p">;</span>

	<span class="cm">/* Turn on 64-bit sgl support if we need to */</span>
	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_features</span> <span class="o">&amp;</span> <span class="n">TW_EXTENDED_INIT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">TW_INIT_COMMAND_PACKET_SIZE_EXTENDED</span><span class="p">;</span>
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_srl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">current_fw_srl</span><span class="p">);</span>
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_arch_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">current_fw_arch_id</span><span class="p">);</span>
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_branch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">current_fw_branch</span><span class="p">);</span>
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_build</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">current_fw_build</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> 
		<span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">TW_INIT_COMMAND_PACKET_SIZE</span><span class="p">;</span>

	<span class="cm">/* Send command packet to the board */</span>
	<span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Poll for completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_poll_response</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="s">&quot;No valid response during init connection&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_features</span> <span class="o">&amp;</span> <span class="n">TW_EXTENDED_INIT_CONNECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">fw_on_ctlr_srl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_srl</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fw_on_ctlr_arch_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_arch_id</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fw_on_ctlr_branch</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_branch</span><span class="p">);</span>
			<span class="o">*</span><span class="n">fw_on_ctlr_build</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">fw_build</span><span class="p">);</span>
			<span class="o">*</span><span class="n">init_connect_result</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tw_initconnect</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_initconnection() */</span>

<span class="cm">/* This function will initialize the fields of a device extension */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_initialize_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Initialize command packet buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_allocate_memory</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Command_Full</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="s">&quot;Command packet memory allocation failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize generic buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_allocate_memory</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="s">&quot;Generic memory allocation failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate event info space */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">TW_Q_LENGTH</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s">&quot;Event info memory allocation failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Event</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Event</span><span class="p">)));</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">error_sequence_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_initialize_device_extension() */</span>

<span class="cm">/* This function is the interrupt service routine */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">twa_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_que</span><span class="p">;</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the per adapter lock */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>

	<span class="cm">/* Read the registers */</span>
	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="cm">/* Check if this is our interrupt, otherwise bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_VALID_INTERRUPT</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>

	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If we are resetting, bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>

	<span class="cm">/* Check controller for errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle host interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_HOST_INTERRUPT</span><span class="p">)</span>
		<span class="n">TW_CLEAR_HOST_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Handle attention interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_ATTENTION_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_CLEAR_ATTENTION_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">TW_IN_ATTENTION_LOOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">twa_get_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">twa_aen_read_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
				<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">TW_IN_ATTENTION_LOOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle command interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_COMMAND_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_MASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="cm">/* Drain as many pending commands as we can */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_PENDING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="s">&quot;Found request id that wasn&#39;t pending&quot;</span><span class="p">);</span>
				<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If we get here, we will continue re-posting on the next command interrupt */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle response interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Drain the response queue from the board */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Complete the response */</span>
			<span class="n">response_que</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="n">request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_que</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>
			<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Check for command packet errors */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">error</span> <span class="o">=</span> <span class="n">twa_fill_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Skip ioctl error prints */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">error</span> <span class="o">=</span> <span class="n">twa_fill_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Check for correct state */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_POSTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="s">&quot;Received a request id that wasn&#39;t posted&quot;</span><span class="p">);</span>
					<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Check for internal command completion */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">twa_aen_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
						<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="s">&quot;Error completing AEN during attention interrupt&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_wqueue</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

				<span class="n">cmd</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

				<span class="n">twa_scsiop_execute_scsi_complete</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
				<span class="cm">/* If no error command was a success */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* If error, command failed */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Ask for a host reset */</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">CHECK_CONDITION</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* Report residual bytes for single sgl */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]))</span>
						<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* Now complete the io */</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
				<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
				<span class="n">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Check for valid status after each drain */</span>
			<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">twa_interrupt_bail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">twa_interrupt_bail:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_interrupt() */</span>

<span class="cm">/* This function will load the request id and various sgls for ioctls */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_load_sgl</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command</span> <span class="o">*</span><span class="n">oldcommand</span><span class="p">;</span>
	<span class="n">TW_Command_Apache</span> <span class="o">*</span><span class="n">newcommand</span><span class="p">;</span>
	<span class="n">TW_SG_Entry</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pae</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">pae</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TW_OP_OUT</span><span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">opcode__reserved</span><span class="p">)</span> <span class="o">==</span> <span class="n">TW_OP_EXECUTE_SCSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newcommand</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">;</span>
		<span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">request_id__lunl</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">(</span><span class="n">TW_LUN_OUT</span><span class="p">(</span><span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">request_id__lunl</span><span class="p">),</span> <span class="n">request_id</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">dma_handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">sgl_entries__lunh</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">(</span><span class="n">TW_LUN_OUT</span><span class="p">(</span><span class="n">newcommand</span><span class="o">-&gt;</span><span class="n">sgl_entries__lunh</span><span class="p">),</span> <span class="n">length</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">oldcommand</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">;</span>
		<span class="n">oldcommand</span><span class="o">-&gt;</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TW_SGL_OUT</span><span class="p">(</span><span class="n">oldcommand</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Load the sg list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">)</span>
				<span class="n">sgl</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_SG_Entry</span> <span class="o">*</span><span class="p">)((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">oldcommand</span><span class="o">+</span><span class="n">oldcommand</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">TW_SG_Entry</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">pae</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sgl</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_SG_Entry</span> <span class="o">*</span><span class="p">)((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">oldcommand</span><span class="o">+</span><span class="n">TW_SGL_OUT</span><span class="p">(</span><span class="n">oldcommand</span><span class="o">-&gt;</span><span class="n">opcode__sgloffset</span><span class="p">));</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">dma_handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Ioctl_Buf_Apache</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>

			<span class="n">oldcommand</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">pae</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* End twa_load_sgl() */</span>

<span class="cm">/* This function will perform a pci-dma mapping for a scatter gather list */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_map_scsi_sg_data</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">use_sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="n">use_sg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_sg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_sg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="s">&quot;Failed to map scatter gather list&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">TW_PHASE_SGLIST</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">have_data_in</span> <span class="o">=</span> <span class="n">use_sg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">use_sg</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_map_scsi_sg_data() */</span>

<span class="cm">/* This function will poll for a response interrupt of a request */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_poll_response</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">response_request_id</span><span class="p">;</span>
	<span class="n">TW_Response_Queue</span> <span class="n">response_queue</span><span class="p">;</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_poll_status_gone</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_RESPONSE_QUEUE_EMPTY</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">response_queue</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_RESPONSE_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="n">response_request_id</span> <span class="o">=</span> <span class="n">TW_RESID_OUT</span><span class="p">(</span><span class="n">response_queue</span><span class="p">.</span><span class="n">response_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_id</span> <span class="o">!=</span> <span class="n">response_request_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="s">&quot;Found unexpected request id while polling for response&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TW_OP_OUT</span><span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">opcode__reserved</span><span class="p">)</span> <span class="o">==</span> <span class="n">TW_OP_EXECUTE_SCSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* bad response */</span>
				<span class="n">twa_fill_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">oldcommand</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* bad response */</span>
				<span class="n">twa_fill_sense</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_poll_response() */</span>

<span class="cm">/* This function will poll the status register for a flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_poll_status</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span> 
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="n">before</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
		<span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
			<span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">seconds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_poll_status() */</span>

<span class="cm">/* This function will poll the status register for disappearance of a flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_poll_status_gone</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="n">before</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
		<span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
			<span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">before</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">seconds</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_poll_status_gone() */</span>

<span class="cm">/* This function will attempt to post a command packet to the board */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_post_command_packet</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">char</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status_reg_value</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">command_que_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">command_que_value</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="cm">/* For 9650SE write low 4 bytes first */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9650SE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">command_que_value</span> <span class="o">+=</span> <span class="n">TW_COMMAND_OFFSET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR_LARGE</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">status_reg_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">TW_STATUS_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_bits</span><span class="p">(</span><span class="n">status_reg_value</span><span class="p">))</span>
		<span class="n">twa_decode_bits</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">status_reg_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_PENDING</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">status_reg_value</span> <span class="o">&amp;</span> <span class="n">TW_STATUS_COMMAND_QUEUE_FULL</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Only pend internal driver commands */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Couldn&#39;t post the command packet, so we do it later */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_PENDING</span><span class="p">;</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_pending_request_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_queue</span><span class="p">[</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">;</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">TW_UNMASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9650SE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Now write upper 4 bytes */</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">command_que_value</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR_LARGE</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">command_que_value</span> <span class="o">+=</span> <span class="n">TW_COMMAND_OFFSET</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
				<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">command_que_value</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">TW_COMMAND_OFFSET</span> <span class="o">+</span> <span class="n">command_que_value</span><span class="p">,</span> <span class="n">TW_COMMAND_QUEUE_REG_ADDR</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_POSTED</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_posted_request_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_post_command_packet() */</span>

<span class="cm">/* This function will reset a device extension */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_reset_device_extension</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">TW_MASK_COMMAND_INTERRUPT</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Abort all requests that are in progress */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_FINISHED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_INITIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TW_S_COMPLETED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset queues and counts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TW_Q_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_INITIAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">free_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">posted_request_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_request_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_head</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">pending_tail</span> <span class="o">=</span> <span class="n">TW_Q_START</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">reset_print</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_reset_sequence</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">chrdev_request_id</span> <span class="o">=</span> <span class="n">TW_IOCTL_CHRDEV_FREE</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_reset_device_extension() */</span>

<span class="cm">/* This function will reset a controller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_reset_sequence</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">soft_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">do_soft_reset</span> <span class="o">=</span> <span class="n">soft_reset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">TW_MAX_RESET_TRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_soft_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TW_SOFT_RESET</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
			<span class="cm">/* Clear pchip/response queue on 9550SX */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">twa_empty_response_queue_large</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="s">&quot;Response queue (large) empty failed during reset sequence&quot;</span><span class="p">);</span>
				<span class="n">do_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure controller is in a good state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_poll_status</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">TW_STATUS_MICROCONTROLLER_READY</span> <span class="o">|</span> <span class="p">(</span><span class="n">do_soft_reset</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">TW_STATUS_ATTENTION_INTERRUPT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">60</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="s">&quot;Microcontroller not ready during reset sequence&quot;</span><span class="p">);</span>
			<span class="n">do_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Empty response queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_empty_response_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="s">&quot;Response queue empty failed during reset sequence&quot;</span><span class="p">);</span>
			<span class="n">do_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check for compatibility/flash */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_check_srl</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flashed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="s">&quot;Compatibility check failed during reset sequence&quot;</span><span class="p">);</span>
			<span class="n">do_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flashed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Drain the AEN queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twa_aen_drain_queue</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">soft_reset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="s">&quot;AEN drain failed during reset sequence&quot;</span><span class="p">);</span>
			<span class="n">do_soft_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If we got here, controller is in a good state */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_reset_sequence() */</span>

<span class="cm">/* This funciton returns unit geometry in cylinders/heads/sectors */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_scsi_biosparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">heads</span><span class="p">,</span> <span class="n">sectors</span><span class="p">,</span> <span class="n">cylinders</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">;</span>

	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">sector_div</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_scsi_biosparam() */</span>

<span class="cm">/* This is the new scsi eh reset function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_scsi_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">num_resets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="s">&quot;WARNING: (0x%02X:0x%04X): Command (0x%x) timed out, resetting card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Make sure we are not issuing an ioctl or resetting from ioctl */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>

	<span class="cm">/* Now reset the card and some of the device extension data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_reset_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="s">&quot;Controller reset failed during scsi host reset&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_scsi_eh_reset() */</span>

<span class="cm">/* This is the main scsi queue function to handle scsi opcodes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_scsi_queue_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* If we are resetting due to timed out ioctl, report as busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_IN_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if this FW supports luns */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_srl</span> <span class="o">&lt;</span> <span class="n">TW_FW_SRL_LUNS_SUPPORTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save done function into scsi_cmnd struct */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
		
	<span class="cm">/* Get a free request id */</span>
	<span class="n">twa_get_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request_id</span><span class="p">);</span>

	<span class="cm">/* Save the scsi command for use by the ISR */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="p">;</span>

	<span class="cm">/* Initialize phase to zero */</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">TW_PHASE_INITIAL</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">twa_scsiop_execute_scsi</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span>:
		<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">TW_S_COMPLETED</span><span class="p">;</span>
		<span class="n">twa_free_request_id</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_scsi_queue() */</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">twa_scsi_queue</span><span class="p">)</span>

<span class="cm">/* This function hands scsi cdb&#39;s to the firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">twa_scsiop_execute_scsi</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_sg</span><span class="p">,</span> <span class="n">TW_SG_Entry</span> <span class="o">*</span><span class="n">sglistarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">TW_Command_Full</span> <span class="o">*</span><span class="n">full_command_packet</span><span class="p">;</span>
	<span class="n">TW_Command_Apache</span> <span class="o">*</span><span class="n">command_packet</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_sectors</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sg_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">))</span>
			<span class="n">sglist</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize command packet */</span>
	<span class="n">full_command_packet</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">command_packet_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>
	<span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">header_desc</span><span class="p">.</span><span class="n">size_header</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">status_block</span><span class="p">.</span><span class="n">severity__reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">command_packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">full_command_packet</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">.</span><span class="n">newcommand</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">opcode__reserved</span> <span class="o">=</span> <span class="n">TW_OPRES_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TW_OP_EXECUTE_SCSI</span><span class="p">);</span>

	<span class="cm">/* We forced 16 byte cdb use earlier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id__lunl</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">request_id</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">request_id__lunl</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">request_id</span><span class="p">));</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sgl_offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sglistarg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Map sglist from scsi layer to cmd packet */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TW_MIN_SGL_LENGTH</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span> <span class="o">||</span>
				    <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">)</span>
					<span class="n">scsi_sg_copy_to_buffer</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span>
							       <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span>
							       <span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>
				<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_phys</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
				<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TW_MIN_SGL_LENGTH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sg_count</span> <span class="o">=</span> <span class="n">twa_map_scsi_sg_data</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sg_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
					<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">&amp;</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">TW_ALIGNMENT_9000_SGL</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="s">&quot;Found unaligned sgl address during execute scsi&quot;</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sgl_entries__lunh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">])));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Internal cdb post */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">use_sg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">sglistarg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">);</span>
			<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sglistarg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sg_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">&amp;</span> <span class="n">TW_CPU_TO_SGL</span><span class="p">(</span><span class="n">TW_ALIGNMENT_9000_SGL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="s">&quot;Found unaligned sgl address during internal post&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">command_packet</span><span class="o">-&gt;</span><span class="n">sgl_entries__lunh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TW_REQ_LUN_IN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">use_sg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span> <span class="o">||</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">)</span>
			<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span> <span class="o">||</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">)</span>
			<span class="n">num_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update sector statistic */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">num_sectors</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span><span class="p">)</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sector_count</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sector_count</span><span class="p">;</span>

	<span class="cm">/* Update SG statistics */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span> <span class="o">=</span> <span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span> <span class="o">&gt;</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span><span class="p">)</span>
			<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">max_sgl_entries</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">sgl_entries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now post the command to the board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">twa_post_command_packet</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_scsiop_execute_scsi() */</span>

<span class="cm">/* This function completes an execute scsi operation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_scsiop_execute_scsi_complete</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TW_MIN_SGL_LENGTH</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span> <span class="o">||</span>
	     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">generic_buffer_virt</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

			<span class="n">scsi_sg_copy_from_buffer</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">TW_SECTOR_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* End twa_scsiop_execute_scsi_complete() */</span>

<span class="cm">/* This function tells the controller to shut down */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__twa_shutdown</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable interrupts */</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Free up the IRQ */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Shutting down host %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="cm">/* Tell the card we are shutting down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="s">&quot;Connection shutdown failed&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Shutdown complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear all interrupts just before exit */</span>
	<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End __twa_shutdown() */</span>

<span class="cm">/* Wrapper for __twa_shutdown */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">__twa_shutdown</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_shutdown() */</span>

<span class="cm">/* This function will look up a string */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">twa_string_lookup</span><span class="p">(</span><span class="n">twa_message_type</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">code</span> <span class="o">!=</span> <span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">text</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">));</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">text</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_string_lookup() */</span>

<span class="cm">/* This function will perform a pci-dma unmap */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_unmap_scsi_data</span><span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">[</span><span class="n">request_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">SCp</span><span class="p">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">TW_PHASE_SGLIST</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_unmap_scsi_data() */</span>

<span class="cm">/* This function gets called when a disk is coming on-line */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Force 60 second timeout */</span>
	<span class="n">blk_queue_rq_timeout</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_slave_configure() */</span>

<span class="cm">/* scsi_host_template initializer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;3ware 9000 Storage Controller&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">twa_scsi_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">twa_scsi_eh_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>		<span class="o">=</span> <span class="n">twa_scsi_biosparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">twa_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">TW_Q_LENGTH</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">twa_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">TW_APACHE_MAX_SGL_LENGTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="n">TW_MAX_SECTORS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="n">TW_MAX_CMDS_PER_LUN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">twa_host_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">emulated</span>		<span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/* This function will probe and initialize a card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">twa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="s">&quot;Failed to enable pci device&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
	    <span class="o">||</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
		    <span class="o">||</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="s">&quot;Failed to set dma mask&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TW_Device_Extension</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="s">&quot;Failed to allocate memory for device extension&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* Save values to device extension */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_initialize_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="s">&quot;Failed to initialize device extension&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_device_extension</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request IO regions */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;3w-9xxx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="s">&quot;Failed to get mem region&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_device_extension</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mem_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Save base address */</span>
	<span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_addr</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="s">&quot;Failed to ioremap&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_mem_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts on the card */</span>
	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Initialize the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_reset_sequence</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>

	<span class="cm">/* Set host specific parameters */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9650SE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">))</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">TW_MAX_UNITS_9650SE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">TW_MAX_UNITS</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">TW_MAX_CDB_LEN</span><span class="p">;</span>

	<span class="cm">/* Channels aren&#39;t supported by adapter */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">TW_MAX_LUNS</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_compat_info</span><span class="p">.</span><span class="n">working_srl</span><span class="p">);</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Register the card with the kernel SCSI layer */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="s">&quot;scsi add host failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: scsi%d: Found a 3ware 9000 Storage Controller at 0x%lx, IRQ: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mem_addr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: scsi%d: Firmware %s, BIOS %s, Ports: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">twa_get_param</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TW_VERSION_TABLE</span><span class="p">,</span>
				     <span class="n">TW_PARAM_FWVER</span><span class="p">,</span> <span class="n">TW_PARAM_FWVER_LENGTH</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">twa_get_param</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TW_VERSION_TABLE</span><span class="p">,</span>
				     <span class="n">TW_PARAM_BIOSVER</span><span class="p">,</span> <span class="n">TW_PARAM_BIOSVER_LENGTH</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">twa_get_param</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TW_INFORMATION_TABLE</span><span class="p">,</span>
				     <span class="n">TW_PARAM_PORTCOUNT</span><span class="p">,</span> <span class="n">TW_PARAM_PORTCOUNT_LENGTH</span><span class="p">)));</span>

	<span class="cm">/* Try to enable MSI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_msi</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_3WARE_9000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TW_USING_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Now setup the interrupt handler */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">twa_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;3w-9xxx&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="s">&quot;Error requesting IRQ&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_remove_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">twa_device_extension_list</span><span class="p">[</span><span class="n">twa_device_extension_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_dev</span><span class="p">;</span>
	<span class="n">twa_device_extension_count</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Re-enable interrupts on the card */</span>
	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Finally, scan the host */</span>
	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twa_major</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">twa_major</span> <span class="o">=</span> <span class="n">register_chrdev</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;twa&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">twa_fops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="s">&quot;Failed to register character device&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_remove_host:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_USING_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="nl">out_release_mem_region:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_free_device_extension:</span>
	<span class="n">twa_free_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="nl">out_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_probe() */</span>

<span class="cm">/* This function is called to remove a device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">twa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* Unregister character device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_major</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">twa_major</span><span class="p">,</span> <span class="s">&quot;twa&quot;</span><span class="p">);</span>
		<span class="n">twa_major</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shutdown the card */</span>
	<span class="n">__twa_shutdown</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="cm">/* Disable MSI if enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_USING_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Free IO remapping */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>

	<span class="cm">/* Free up the mem region */</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Free up device extension resources */</span>
	<span class="n">twa_free_device_extension</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">twa_device_extension_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_remove() */</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/* This function is called on PCI suspend */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Suspending host %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>

	<span class="n">TW_DISABLE_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">tw_pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_USING_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Tell the card we are shutting down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_initconnection</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="s">&quot;Connection shutdown failed during suspend&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Suspend complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">TW_CLEAR_ALL_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_suspend() */</span>

<span class="cm">/* This function is called on PCI resume */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twa_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="n">tw_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">TW_Device_Extension</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Resuming host %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="s">&quot;Enable device failed during resume&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_try_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
	    <span class="o">||</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
		    <span class="o">||</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="s">&quot;Failed to set dma mask during resume&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* Initialize the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twa_reset_sequence</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now setup the interrupt handler */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">twa_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;3w-9xxx&quot;</span><span class="p">,</span> <span class="n">tw_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TW_PRINTK</span><span class="p">(</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">TW_DRIVER</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="s">&quot;Error requesting IRQ during resume&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now enable MSI if enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TW_USING_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tw_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Re-enable interrupts on the card */</span>
	<span class="n">TW_ENABLE_AND_CLEAR_INTERRUPTS</span><span class="p">(</span><span class="n">tw_dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3w-9xxx: Resume complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_disable_device:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End twa_resume() */</span>
<span class="cp">#endif</span>

<span class="cm">/* PCI Devices supported by this driver */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">twa_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_9000</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_9550SX</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_9650SE</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_3WARE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_3WARE_9690SA</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">twa_pci_tbl</span><span class="p">);</span>

<span class="cm">/* pci_driver initializer */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">twa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;3w-9xxx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">twa_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">twa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">twa_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">twa_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">twa_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">twa_shutdown</span>
<span class="p">};</span>

<span class="cm">/* This function is called on driver initialization */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">twa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;3ware 9000 Storage Controller device driver for Linux v%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TW_DRIVER_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twa_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_init() */</span>

<span class="cm">/* This function is called on driver exit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">twa_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twa_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* End twa_exit() */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">twa_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">twa_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
