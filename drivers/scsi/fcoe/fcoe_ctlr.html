<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › fcoe › fcoe_ctlr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fcoe_ctlr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2009 Cisco Systems, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2009 Intel Corporation.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained at www.Open-FCoE.org</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/rtnetlink.h&gt;</span>

<span class="cp">#include &lt;scsi/fc/fc_els.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fs.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fip.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_encaps.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fcoe.h&gt;</span>
<span class="cp">#include &lt;scsi/fc/fc_fcp.h&gt;</span>

<span class="cp">#include &lt;scsi/libfc.h&gt;</span>
<span class="cp">#include &lt;scsi/libfcoe.h&gt;</span>

<span class="cp">#include &quot;libfcoe.h&quot;</span>

<span class="cp">#define	FCOE_CTLR_MIN_FKA	500		</span><span class="cm">/* min keep alive (mS) */</span><span class="cp"></span>
<span class="cp">#define	FCOE_CTLR_DEF_FKA	FIP_DEF_FKA	</span><span class="cm">/* default keep alive (mS) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fcoe_ctlr_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fcoe_ctlr_timer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fcoe_ctlr_recv_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fcoe_ctlr_flogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fcoe_ctlr_vn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fcoe_ctlr_vn_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fcoe_ctlr_vn_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fcoe_ctlr_vn_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">fcoe_all_fcfs</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIP_ALL_FCF_MACS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fcoe_all_enode</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIP_ALL_ENODE_MACS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fcoe_all_vn2vn</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIP_ALL_VN2VN_MACS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fcoe_all_p2p</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIP_ALL_P2P_MACS</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">fcoe_ctlr_states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FIP_ST_DISABLED</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;DISABLED&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_LINK_WAIT</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;LINK_WAIT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_AUTO</span><span class="p">]</span> <span class="o">=</span>		<span class="s">&quot;AUTO&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_NON_FIP</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;NON_FIP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_ENABLED</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;ENABLED&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_VNMP_START</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;VNMP_START&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_VNMP_PROBE1</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;VNMP_PROBE1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_VNMP_PROBE2</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;VNMP_PROBE2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_VNMP_CLAIM</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;VNMP_CLAIM&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">FIP_ST_VNMP_UP</span><span class="p">]</span> <span class="o">=</span>	<span class="s">&quot;VNMP_UP&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fcoe_ctlr_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">fip_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fcoe_ctlr_states</span><span class="p">))</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">fcoe_ctlr_states</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cp</span><span class="p">)</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_set_state() - Set and do debug printing for the new FIP state.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @state: The new state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fip_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">)</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;state %s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fcoe_ctlr_state</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span> <span class="n">fcoe_ctlr_state</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_mtu_valid() - Check if a FCF&#39;s MTU is valid</span>
<span class="cm"> * @fcf: The FCF to check</span>
<span class="cm"> *</span>
<span class="cm"> * Return non-zero if FCF fcoe_size has been validated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_mtu_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_SOL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_fcf_usable() - Check if a FCF is usable</span>
<span class="cm"> * @fcf: The FCF to check</span>
<span class="cm"> *</span>
<span class="cm"> * Return non-zero if the FCF is usable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_fcf_usable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">FIP_FL_SOL</span> <span class="o">|</span> <span class="n">FIP_FL_AVAIL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_map_dest() - Set flag and OUI for mapping destination addresses</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">FIP_VN_FC_MAP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">FIP_DEF_FC_MAP</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">map_dest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_init() - Initialize the FCoE Controller instance</span>
<span class="cm"> * @fip: The FCoE controller to initialize</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fcoe_ctlr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fip_state</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_LINK_WAIT</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">fcoe_ctlr_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer_work</span><span class="p">,</span> <span class="n">fcoe_ctlr_timer_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">recv_work</span><span class="p">,</span> <span class="n">fcoe_ctlr_recv_work</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fip_recv_list</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_sysfs_fcf_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span> <span class="o">=</span> <span class="n">fcoe_ctlr_to_ctlr_dev</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf_device</span> <span class="n">temp</span><span class="p">,</span> <span class="o">*</span><span class="n">fcf_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;New FCF fab %16.16llx mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">temp</span><span class="p">.</span><span class="n">fabric_name</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">switch_name</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">switch_name</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">fc_map</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fc_map</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">vfid</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">vfid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">fka_period</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fka_period</span><span class="p">;</span>
	<span class="n">temp</span><span class="p">.</span><span class="n">selected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* default to unselected */</span>

	<span class="n">fcf_dev</span> <span class="o">=</span> <span class="n">fcoe_fcf_device_add</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fcf_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The fcoe_sysfs layer can return a CONNECTED fcf that</span>
<span class="cm">	 * has a priv (fcf was never deleted) or a CONNECTED fcf</span>
<span class="cm">	 * that doesn&#39;t have a priv (fcf was deleted). However,</span>
<span class="cm">	 * libfcoe will always delete FCFs before trying to add</span>
<span class="cm">	 * them. This is ensured because both recv_adv and</span>
<span class="cm">	 * age_fcfs are protected by the the fcoe_ctlr&#39;s mutex.</span>
<span class="cm">	 * This means that we should never get a FCF with a</span>
<span class="cm">	 * non-NULL priv pointer.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fcf_dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">fcf_dev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">fcf_dev</span> <span class="o">=</span> <span class="n">fcf_dev</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcf_count</span><span class="o">++</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_sysfs_fcf_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span> <span class="o">=</span> <span class="n">fcoe_ctlr_to_ctlr_dev</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf_device</span> <span class="o">*</span><span class="n">fcf_dev</span><span class="p">;</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcf_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">fcf_dev</span> <span class="o">=</span> <span class="n">fcoe_fcf_to_fcf_dev</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">fcf_dev</span><span class="p">);</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">fcf_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fcoe_fcf_device_delete</span><span class="p">(</span><span class="n">fcf_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_reset_fcfs() - Reset and free all FCFs for a controller</span>
<span class="cm"> * @fip: The FCoE controller whose FCFs are to be reset</span>
<span class="cm"> *</span>
<span class="cm"> * Called with &amp;fcoe_ctlr lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_reset_fcfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_sysfs_fcf_del</span><span class="p">(</span><span class="n">fcf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcf_count</span><span class="p">);</span>

	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_destroy() - Disable and tear down a FCoE controller</span>
<span class="cm"> * @fip: The FCoE controller to tear down</span>
<span class="cm"> *</span>
<span class="cm"> * This is called by FCoE drivers before freeing the &amp;fcoe_ctlr.</span>
<span class="cm"> *</span>
<span class="cm"> * The receive handler will have been deleted before this to guarantee</span>
<span class="cm"> * that no more recv_work will be scheduled.</span>
<span class="cm"> *</span>
<span class="cm"> * The timer routine will simply return once we set FIP_ST_DISABLED.</span>
<span class="cm"> * This guarantees that no further timeouts or work will be scheduled.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fcoe_ctlr_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">recv_work</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fip_recv_list</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_DISABLED</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_reset_fcfs</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_announce() - announce new FCF selection</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Also sets the destination MAC for FCoE and control packets</span>
<span class="cm"> *</span>
<span class="cm"> * Called with neither ctlr_mutex nor ctlr_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_announce</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">sel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
	<span class="n">sel</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;libfcoe: host%d: &quot;</span>
		       <span class="s">&quot;FIP Fibre-Channel Forwarder MAC %pM deselected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;libfcoe: host%d: FIP selected &quot;</span>
		       <span class="s">&quot;Fibre-Channel Forwarder MAC %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">fcoe_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">map_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_fcoe_size() - Return the maximum FCoE size required for VN_Port</span>
<span class="cm"> * @fip: The FCoE controller to get the maximum FCoE size from</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the maximum packet size including the FCoE header and trailer,</span>
<span class="cm"> * but not including any Ethernet or VLAN headers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">fcoe_ctlr_fcoe_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine the max FCoE frame size allowed, including</span>
<span class="cm">	 * FCoE header and trailer.</span>
<span class="cm">	 * Note:  lp-&gt;mfs is currently the payload size, not the frame size.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mfs</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_crc_eof</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_solicit() - Send a FIP solicitation</span>
<span class="cm"> * @fip: The FCoE controller to send the solicitation on</span>
<span class="cm"> * @fcf: The destination FCF (if NULL, a multicast solicitation is sent)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_solicit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_sol</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_header</span> <span class="n">fip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="n">mac</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="n">wwnn</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">fip_size_desc</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span> <span class="n">desc</span><span class="p">;</span>
	<span class="p">}</span>  <span class="n">__packed</span> <span class="o">*</span> <span class="n">sol</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcoe_size</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sol</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sol</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_sol</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sol</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcf</span> <span class="o">?</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span> <span class="o">:</span> <span class="n">fcoe_all_fcfs</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>

	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_ver</span> <span class="o">=</span> <span class="n">FIP_VER_ENCAPS</span><span class="p">(</span><span class="n">FIP_VER</span><span class="p">);</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_op</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_OP_DISC</span><span class="p">);</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_subcode</span> <span class="o">=</span> <span class="n">FIP_SC_SOL</span><span class="p">;</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_dl_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">);</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_flags</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_FL_FPMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">spma</span><span class="p">)</span>
		<span class="n">sol</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_flags</span> <span class="o">|=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_FL_SPMA</span><span class="p">);</span>

	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_MAC</span><span class="p">;</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">mac</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_NAME</span><span class="p">;</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wwnn</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_wwn</span><span class="p">);</span>

	<span class="n">fcoe_size</span> <span class="o">=</span> <span class="n">fcoe_ctlr_fcoe_size</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_FCOE_SIZE</span><span class="p">;</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">sol</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">fd_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fcoe_size</span><span class="p">);</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sol</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span><span class="p">)</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_link_up() - Start FCoE controller</span>
<span class="cm"> * @fip: The FCoE controller to start</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the LLD when the network link is ready.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fcoe_ctlr_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_NON_FIP</span> <span class="o">||</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="n">fc_linkup</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_LINK_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;invalid mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="cm">/* fall-through */</span>
		<span class="k">case</span> <span class="n">FIP_MODE_AUTO</span>:
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;setting AUTO mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* fall-through */</span>
		<span class="k">case</span> <span class="n">FIP_MODE_FABRIC</span>:
		<span class="k">case</span> <span class="n">FIP_MODE_NON_FIP</span>:
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
			<span class="n">fc_linkup</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
			<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_MODE_VN2VN</span>:
			<span class="n">fcoe_ctlr_vn_start</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
			<span class="n">fc_linkup</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_link_up</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_reset() - Reset a FCoE controller</span>
<span class="cm"> * @fip:       The FCoE controller to reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcoe_ctlr_reset_fcfs</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">;</span>
	<span class="n">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_link_down() - Stop a FCoE controller</span>
<span class="cm"> * @fip: The FCoE controller to be stopped</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if the link was up and now isn&#39;t.</span>
<span class="cm"> *</span>
<span class="cm"> * Called from the LLD when the network link is not ready.</span>
<span class="cm"> * There may be multiple calls while the link is down.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fcoe_ctlr_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">link_dropped</span><span class="p">;</span>

	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;link down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_reset</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">link_dropped</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_LINK_WAIT</span><span class="p">;</span>
	<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_LINK_WAIT</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_dropped</span><span class="p">)</span>
		<span class="n">fc_linkdown</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">link_dropped</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_link_down</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_send_keep_alive() - Send a keep-alive to the selected FCF</span>
<span class="cm"> * @fip:   The FCoE controller to send the FKA on</span>
<span class="cm"> * @lport: libfc fc_lport to send from</span>
<span class="cm"> * @ports: 0 for controller keep-alive, 1 for port keep-alive</span>
<span class="cm"> * @sa:	   The source MAC address</span>
<span class="cm"> *</span>
<span class="cm"> * A controller keep-alive is sent every fka_period (typically 8 seconds).</span>
<span class="cm"> * The source MAC is the native MAC address.</span>
<span class="cm"> *</span>
<span class="cm"> * A port keep-alive is sent every 90 seconds while logged in.</span>
<span class="cm"> * The source MAC is the assigned mapped source address.</span>
<span class="cm"> * The destination is the FCF&#39;s F-port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_send_keep_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">ports</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_kal</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_header</span> <span class="n">fip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="n">mac</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="o">*</span> <span class="n">kal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="n">vn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>

	<span class="n">fcf</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span> <span class="o">||</span> <span class="p">(</span><span class="n">ports</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kal</span><span class="p">)</span> <span class="o">+</span> <span class="n">ports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vn</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kal</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_kal</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kal</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kal</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>

	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_ver</span> <span class="o">=</span> <span class="n">FIP_VER_ENCAPS</span><span class="p">(</span><span class="n">FIP_VER</span><span class="p">);</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_op</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_OP_CTRL</span><span class="p">);</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_subcode</span> <span class="o">=</span> <span class="n">FIP_SC_KEEP_ALIVE</span><span class="p">;</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_dl_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">kal</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">ports</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vn</span><span class="p">))</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">);</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_flags</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_FL_FPMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">spma</span><span class="p">)</span>
		<span class="n">kal</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_flags</span> <span class="o">|=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_FL_SPMA</span><span class="p">);</span>

	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_MAC</span><span class="p">;</span>
	<span class="n">kal</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kal</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">kal</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">kal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_VN_ID</span><span class="p">;</span>
		<span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vn</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">get_src_addr</span><span class="p">(</span><span class="n">lport</span><span class="p">),</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_fc_id</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_wwpn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_encaps() - Encapsulate an ELS frame for FIP, without sending it</span>
<span class="cm"> * @fip:   The FCoE controller for the ELS frame</span>
<span class="cm"> * @dtype: The FIP descriptor type for the frame</span>
<span class="cm"> * @skb:   The FCoE ELS frame including FC header but no FCoE headers</span>
<span class="cm"> * @d_id:  The destination port ID.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error code on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller must check that the length is a multiple of 4.</span>
<span class="cm"> *</span>
<span class="cm"> * The @skb must have enough headroom (28 bytes) and tailroom (8 bytes).</span>
<span class="cm"> * Headroom includes the FIP encapsulation description, FIP header, and</span>
<span class="cm"> * Ethernet header.  The tailroom is for the FIP MAC descriptor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_encaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">dtype</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">d_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_encaps_head</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_header</span> <span class="n">fip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_encaps</span> <span class="n">encaps</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="o">*</span> <span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fip_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">op</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_encaps</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>	<span class="cm">/* len before push */</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_encaps_head</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cap</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_vn_lookup</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">d_id</span><span class="p">,</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_dest</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">fip_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fcf</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">fip_flags</span> <span class="o">=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">fip_flags</span> <span class="o">&amp;=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">spma</span> <span class="o">?</span> <span class="n">FIP_FL_SPMA</span> <span class="o">|</span> <span class="n">FIP_FL_FPMA</span> <span class="o">:</span>
					 <span class="n">FIP_FL_FPMA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fip_flags</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_ver</span> <span class="o">=</span> <span class="n">FIP_VER_ENCAPS</span><span class="p">(</span><span class="n">FIP_VER</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_op</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_OP_LS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span> <span class="o">||</span> <span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_RJT</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_subcode</span> <span class="o">=</span> <span class="n">FIP_SC_REP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_subcode</span> <span class="o">=</span> <span class="n">FIP_SC_REQ</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_flags</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fip_flags</span><span class="p">);</span>

	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">encaps</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">encaps</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="n">dlen</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">!=</span> <span class="n">ELS_LS_RJT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">);</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">));</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_MAC</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">FIP_DT_FLOGI</span> <span class="o">&amp;&amp;</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">FIP_DT_FDISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">get_src_addr</span><span class="p">(</span><span class="n">lport</span><span class="p">),</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hton24</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">FIP_VN_FC_MAP</span><span class="p">);</span>
			<span class="n">hton24</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_mac</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fip_flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_SPMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FLOGI/FDISC sent with SPMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FLOGI/FDISC sent with FPMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* FPMA only FLOGI.  Must leave the MAC desc zeroed. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_dl_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">dlen</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_els_send() - Send an ELS frame encapsulated by FIP if appropriate.</span>
<span class="cm"> * @fip:	FCoE controller.</span>
<span class="cm"> * @lport:	libfc fc_lport to send from</span>
<span class="cm"> * @skb:	FCoE ELS frame including FC header but no FCoE headers.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns a non-zero error code if the frame should not be sent.</span>
<span class="cm"> * Returns zero if the caller should send the frame with FCoE encapsulation.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller must check that the length is a multiple of 4.</span>
<span class="cm"> * The SKB must have enough headroom (28 bytes) and tailroom (8 bytes).</span>
<span class="cm"> * The the skb must also be an fc_frame.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called from the lower-level driver with spinlocks held,</span>
<span class="cm"> * so we must not take a mutex here.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fcoe_ctlr_els_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old_xid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">op</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_FLOGI</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_xid</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span><span class="p">;</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_xid</span> <span class="o">==</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">)</span>
				<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="n">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">)</span>
			<span class="n">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELS_FLOGI</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="n">FIP_DT_FLOGI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req_send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer_work</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_FDISC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_s_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">FIP_DT_FDISC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_LOGO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_VNMP_UP</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_FID_FLOGI</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_ENABLED</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FC_FID_FLOGI</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">FIP_DT_LOGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELS_LS_ACC</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If non-FIP, we may have gotten an SID by accepting an FLOGI</span>
<span class="cm">		 * from a point-to-point connection.  Switch to using</span>
<span class="cm">		 * the source mac based on the SID.  The destination</span>
<span class="cm">		 * MAC in this case would have been set by receiving the</span>
<span class="cm">		 * FLOGI.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">==</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">;</span>
			<span class="n">fc_fcoe_set_mac</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">update_mac</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ELS_LS_RJT</span>:
		<span class="n">op</span> <span class="o">=</span> <span class="n">fr_encaps</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_ENABLED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_VNMP_UP</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;els_send op %u d_id %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">op</span><span class="p">,</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_encaps</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_els_send</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_age_fcfs() - Reset and free all old FCFs for a controller</span>
<span class="cm"> * @fip: The FCoE controller to free FCFs on</span>
<span class="cm"> *</span>
<span class="cm"> * Called with lock held and preemption disabled.</span>
<span class="cm"> *</span>
<span class="cm"> * An FCF is considered old if we have missed two advertisements.</span>
<span class="cm"> * That is, there have been no valid advertisement from it for 2.5</span>
<span class="cm"> * times its keep-alive period.</span>
<span class="cm"> *</span>
<span class="cm"> * In addition, determine the time when an FCF selection can occur.</span>
<span class="cm"> *</span>
<span class="cm"> * Also, increment the MissDiscAdvCount when no advertisement is received</span>
<span class="cm"> * for the corresponding FCF for 1.5 * FKA_ADV_PERIOD (FC-BB-5 LESB).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the time in jiffies for the next call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">fcoe_ctlr_age_fcfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_timer</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_KA_PERIOD</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sel_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">del_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_dev_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span> <span class="n">get_cpu</span><span class="p">());</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deadline</span> <span class="o">=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">+</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span> <span class="o">+</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">==</span> <span class="n">fcf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">MissDiscAdvCount</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;libfcoe: host%d: &quot;</span>
				       <span class="s">&quot;Missing Discovery Advertisement &quot;</span>
				       <span class="s">&quot;for fab %16.16llx count %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">,</span>
				       <span class="n">stats</span><span class="o">-&gt;</span><span class="n">MissDiscAdvCount</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">next_timer</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span>
				<span class="n">next_timer</span> <span class="o">=</span> <span class="n">deadline</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">deadline</span> <span class="o">+=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">==</span> <span class="n">fcf</span><span class="p">)</span>
				<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Move to delete list so we can call</span>
<span class="cm">			 * fcoe_sysfs_fcf_del (which can sleep)</span>
<span class="cm">			 * after the put_cpu().</span>
<span class="cm">			 */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">VLinkFailureCount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">next_timer</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span>
				<span class="n">next_timer</span> <span class="o">=</span> <span class="n">deadline</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_mtu_valid</span><span class="p">(</span><span class="n">fcf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">sel_time</span> <span class="o">||</span> <span class="n">time_before</span><span class="p">(</span><span class="n">sel_time</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)))</span>
				<span class="n">sel_time</span> <span class="o">=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Removes fcf from current list */</span>
		<span class="n">fcoe_sysfs_fcf_del</span><span class="p">(</span><span class="n">fcf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel_time</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sel_time</span> <span class="o">+=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FCOE_CTLR_START_DELAY</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span> <span class="o">=</span> <span class="n">sel_time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">next_timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_parse_adv() - Decode a FIP advertisement into a new FCF entry</span>
<span class="cm"> * @fip: The FCoE controller receiving the advertisement</span>
<span class="cm"> * @skb: The received FIP advertisement frame</span>
<span class="cm"> * @fcf: The resulting FCF entry</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero on a valid parsed advertisement,</span>
<span class="cm"> * otherwise returns non zero value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_parse_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fiph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="n">wwn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_fab_desc</span> <span class="o">*</span><span class="n">fab</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_fka_desc</span> <span class="o">*</span><span class="n">fka</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_mask</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcf</span><span class="p">));</span>
	<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FCOE_CTLR_DEF_FKA</span><span class="p">);</span>

	<span class="n">fiph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * mask of required descriptors. validating each one clears its bit.</span>
<span class="cm">	 */</span>
	<span class="n">desc_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_PRI</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FAB</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FKA</span><span class="p">);</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_dl_len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fiph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">fiph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dlen</span> <span class="o">*</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">)</span> <span class="o">||</span> <span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">rlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Drop Adv if there are duplicate critical descriptors */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">desc_mask</span> <span class="o">&amp;</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Duplicate Critical &quot;</span>
					<span class="s">&quot;Descriptors in FIP adv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIP_DT_PRI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_pri_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">fip_pri_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd_pri</span><span class="p">;</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_PRI</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_MAC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span>
			       <span class="p">((</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span>
			       <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcoe_mac</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
					<span class="s">&quot;Invalid MAC addr %pM in FIP adv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_NAME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_wwn_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">wwn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">switch_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">fd_wwn</span><span class="p">);</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_FAB</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_fab_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">fab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_fab_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fab</span><span class="o">-&gt;</span><span class="n">fd_wwn</span><span class="p">);</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">vfid</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fab</span><span class="o">-&gt;</span><span class="n">fd_vfid</span><span class="p">);</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">fab</span><span class="o">-&gt;</span><span class="n">fd_map</span><span class="p">);</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FAB</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_FKA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_fka_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">fka</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_fka_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fka</span><span class="o">-&gt;</span><span class="n">fd_flags</span> <span class="o">&amp;</span> <span class="n">FIP_FKA_ADV_D</span><span class="p">)</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fd_flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">fka</span><span class="o">-&gt;</span><span class="n">fd_fka_period</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">FCOE_CTLR_MIN_FKA</span><span class="p">)</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FKA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_MAP_OUI</span>:
		<span class="k">case</span> <span class="n">FIP_DT_FCOE_SIZE</span>:
		<span class="k">case</span> <span class="n">FIP_DT_FLOGI</span>:
		<span class="k">case</span> <span class="n">FIP_DT_FDISC</span>:
		<span class="k">case</span> <span class="n">FIP_DT_LOGO</span>:
		<span class="k">case</span> <span class="n">FIP_DT_ELP</span>:
		<span class="nl">default:</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;unexpected descriptor type %x &quot;</span>
					<span class="s">&quot;in FIP adv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">);</span>
			<span class="cm">/* standard says ignore unknown descriptors &gt;= 128 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="n">FIP_DT_VENDOR_BASE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="n">rlen</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span> <span class="o">||</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">switch_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;adv missing descriptors mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">desc_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">len_err:</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP length error in descriptor type %x len %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_adv() - Handle an incoming advertisement</span>
<span class="cm"> * @fip: The FCoE controller receiving the advertisement</span>
<span class="cm"> * @skb: The received FIP packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_recv_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sol_tov</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FCOE_CTRL_SOL_TOV</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtu_valid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcoe_ctlr_parse_adv</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">switch_name</span> <span class="o">==</span> <span class="n">new</span><span class="p">.</span><span class="n">switch_name</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span> <span class="o">==</span> <span class="n">new</span><span class="p">.</span><span class="n">fabric_name</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span> <span class="o">==</span> <span class="n">new</span><span class="p">.</span><span class="n">fc_map</span> <span class="o">&amp;&amp;</span>
		    <span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">fcf_mac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcf_count</span> <span class="o">&gt;=</span> <span class="n">FCOE_CTLR_FCF_LIMIT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">fcf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fcf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>
		<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fip</span> <span class="o">=</span> <span class="n">fip</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fcoe_sysfs_fcf_add</span><span class="p">(</span><span class="n">fcf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to allocate sysfs instance &quot;</span>
			       <span class="s">&quot;for FCF, fab %16.16llx mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">new</span><span class="p">.</span><span class="n">fabric_name</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">fcf_mac</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fcf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Update the FCF&#39;s keep-alive descriptor flags.</span>
<span class="cm">		 * Other flag changes from new advertisements are</span>
<span class="cm">		 * ignored after a solicited advertisement is</span>
<span class="cm">		 * received and the FCF is selectable (usable).</span>
<span class="cm">		 */</span>
		<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fd_flags</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">fd_flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcoe_ctlr_fcf_usable</span><span class="p">(</span><span class="n">fcf</span><span class="p">))</span>
			<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fd_flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span> <span class="o">-=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span><span class="p">;</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span> <span class="o">+=</span> <span class="n">new</span><span class="p">.</span><span class="n">fka_period</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span><span class="p">))</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fka_period</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">fka_period</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">new</span><span class="p">.</span><span class="n">fcf_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mtu_valid</span> <span class="o">=</span> <span class="n">fcoe_ctlr_mtu_valid</span><span class="p">(</span><span class="n">fcf</span><span class="p">);</span>
	<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;New FCF fab %16.16llx mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this advertisement is not solicited and our max receive size</span>
<span class="cm">	 * hasn&#39;t been verified, send a solicited advertisement.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mtu_valid</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">fcf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If its been a while since we did a solicit, and this is</span>
<span class="cm">	 * the first advertisement we&#39;ve received, do a multicast</span>
<span class="cm">	 * solicitation to gather as many advertisements as we can</span>
<span class="cm">	 * before selection occurs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">+</span> <span class="n">sol_tov</span><span class="p">))</span>
		<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put this FCF at the head of the list for priority among equals.</span>
<span class="cm">	 * This helps in the case of an NPV switch which insists we use</span>
<span class="cm">	 * the FCF that answers multicast solicitations, not the others that</span>
<span class="cm">	 * are sending periodic multicast advertisements.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu_valid</span><span class="p">)</span>
		<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is the first validated FCF, note the time and</span>
<span class="cm">	 * set a timer to trigger selection.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mtu_valid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">&amp;&amp;</span> <span class="n">fcoe_ctlr_fcf_usable</span><span class="p">(</span><span class="n">fcf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FCOE_CTLR_START_DELAY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">time_before</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_els() - Handle an incoming FIP encapsulated ELS frame</span>
<span class="cm"> * @fip: The FCoE controller which received the packet</span>
<span class="cm"> * @skb: The received FIP packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_recv_els</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fiph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_encaps</span> <span class="o">*</span><span class="n">els</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_dev_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">sel</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fip_desc_type</span> <span class="n">els_dtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">els_op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sub</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">granted_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">size_t</span> <span class="n">els_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fiph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_subcode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span> <span class="o">!=</span> <span class="n">FIP_SC_REQ</span> <span class="o">&amp;&amp;</span> <span class="n">sub</span> <span class="o">!=</span> <span class="n">FIP_SC_REP</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_dl_len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fiph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">fiph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dlen</span> <span class="o">*</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">)</span> <span class="o">||</span> <span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">rlen</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="cm">/* Drop ELS if there are duplicate critical descriptors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">!=</span> <span class="n">FIP_DT_MAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">desc_mask</span> <span class="o">&amp;</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Duplicate Critical &quot;</span>
						<span class="s">&quot;Descriptors in FIP ELS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desc_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIP_DT_MAC</span>:
			<span class="n">sel</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP descriptors &quot;</span>
						<span class="s">&quot;received out of order</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Some switch implementations send two MAC descriptors,</span>
<span class="cm">			 * with first MAC(granted_mac) being the FPMA, and the</span>
<span class="cm">			 * second one(fcoe_mac) is used as destination address</span>
<span class="cm">			 * for sending/receiving FCoE packets. FIP traffic is</span>
<span class="cm">			 * sent using fip_mac. For regular switches, both</span>
<span class="cm">			 * fip_mac and fcoe_mac would be the same.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">granted_mac</span><span class="p">,</span>
				       <span class="p">((</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span>
				       <span class="n">ETH_ALEN</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sel</span><span class="p">))</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">fcoe_mac</span><span class="p">,</span>
				       <span class="p">((</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span>
				       <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_FLOGI</span>:
		<span class="k">case</span> <span class="n">FIP_DT_FDISC</span>:
		<span class="k">case</span> <span class="n">FIP_DT_LOGO</span>:
		<span class="k">case</span> <span class="n">FIP_DT_ELP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP descriptors &quot;</span>
						<span class="s">&quot;received out of order</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">els</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">els_len</span> <span class="o">=</span> <span class="n">dlen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">els</span><span class="p">);</span>
			<span class="n">els</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_encaps</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">els</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">els_dtype</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;unexpected descriptor type %x &quot;</span>
					<span class="s">&quot;in FIP adv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">);</span>
			<span class="cm">/* standard says ignore unknown descriptors &gt;= 128 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="n">FIP_DT_VENDOR_BASE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP descriptors &quot;</span>
						<span class="s">&quot;received out of order</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="n">rlen</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">els_op</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">els_dtype</span> <span class="o">==</span> <span class="n">FIP_DT_FLOGI</span> <span class="o">||</span> <span class="n">els_dtype</span> <span class="o">==</span> <span class="n">FIP_DT_FDISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_REP</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">els_op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">granted_mac</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
					<span class="s">&quot;Invalid MAC address %pM in FIP ELS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">granted_mac</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fr_cb</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">granted_mac</span><span class="p">,</span> <span class="n">granted_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">==</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">els_dtype</span> <span class="o">==</span> <span class="n">FIP_DT_FLOGI</span><span class="p">)</span>
					<span class="n">fcoe_ctlr_announce</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">els_dtype</span> <span class="o">==</span> <span class="n">FIP_DT_FLOGI</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">fcoe_ctlr_flogi_retry</span><span class="p">(</span><span class="n">fip</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>	<span class="cm">/* retrying FLOGI so drop reject */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">els_op</span> <span class="o">!=</span> <span class="n">ELS_LS_RJT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">FIP_DT_MAC</span> <span class="o">&amp;</span> <span class="n">desc_mask</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Missing critical descriptors &quot;</span>
				<span class="s">&quot;in FIP ELS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert skb into an fc_frame containing only the ELS.</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fh</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">els_len</span><span class="p">);</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">fc_frame_init</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fr_sof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_SOF_I3</span><span class="p">;</span>
	<span class="n">fr_eof</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_EOF_T</span><span class="p">;</span>
	<span class="n">fr_dev</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">lport</span><span class="p">;</span>
	<span class="n">fr_encaps</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">els_dtype</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span> <span class="n">get_cpu</span><span class="p">());</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxFrames</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">RxWords</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="n">fc_exch_recv</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">len_err:</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP length error in descriptor type %x len %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_els() - Handle an incoming link reset frame</span>
<span class="cm"> * @fip: The FCoE controller that received the frame</span>
<span class="cm"> * @fh:	 The received FIP header</span>
<span class="cm"> *</span>
<span class="cm"> * There may be multiple VN_Port descriptors.</span>
<span class="cm"> * The overall length has already been checked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_recv_clr_vlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="n">wp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vn_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_vlink_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_phys_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">**</span><span class="n">vlink_desc_arr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Clear Virtual Link received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span> <span class="o">||</span> <span class="o">!</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mask of required descriptors.  Validating each one clears its bit.</span>
<span class="cm">	 */</span>
	<span class="n">desc_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">);</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fip_dl_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">fh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Actually need to subtract &#39;sizeof(*mp) - sizeof(*wp)&#39; from &#39;rlen&#39;</span>
<span class="cm">	 * before determining max Vx_Port descriptor but a buggy FCF could have</span>
<span class="cm">	 * omited either or both MAC Address and Name Identifier descriptors</span>
<span class="cm">	 */</span>
	<span class="n">num_vlink_desc</span> <span class="o">=</span> <span class="n">rlen</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_vlink_desc</span><span class="p">)</span>
		<span class="n">vlink_desc_arr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_vlink_desc</span><span class="p">,</span>
					 <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vlink_desc_arr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">num_vlink_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dlen</span> <span class="o">*</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">rlen</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="cm">/* Drop CVL if there are duplicate critical descriptors */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">!=</span> <span class="n">FIP_DT_VN_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">desc_mask</span> <span class="o">&amp;</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Duplicate Critical &quot;</span>
					<span class="s">&quot;Descriptors in FIP CVL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIP_DT_MAC</span>:
			<span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mp</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_NAME</span>:
			<span class="n">wp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wp</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">fd_wwn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">switch_name</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_VN_ID</span>:
			<span class="n">vp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vp</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">vlink_desc_arr</span><span class="p">[</span><span class="n">num_vlink_desc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp</span><span class="p">;</span>
			<span class="n">vn_port</span> <span class="o">=</span> <span class="n">fc_vport_id_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span>
						      <span class="n">ntoh24</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">fd_fc_id</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vn_port</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vn_port</span> <span class="o">==</span> <span class="n">lport</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
				<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span>
					    <span class="n">get_cpu</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">VLinkFailureCount</span><span class="o">++</span><span class="p">;</span>
				<span class="n">put_cpu</span><span class="p">();</span>
				<span class="n">fcoe_ctlr_reset</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* standard says ignore unknown descriptors &gt;= 128 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span> <span class="o">&lt;</span> <span class="n">FIP_DT_VENDOR_BASE</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="n">rlen</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset only if all required descriptors were present and valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_mask</span><span class="p">)</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;missing descriptors mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">desc_mask</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_vlink_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;CVL: no Vx_Port descriptor found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * No Vx_Port description. Clear all NPIV ports,</span>
<span class="cm">		 * followed by physical port</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="n">per_cpu_ptr</span><span class="p">(</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">dev_stats</span><span class="p">,</span>
			    <span class="n">get_cpu</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">VLinkFailureCount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_cpu</span><span class="p">();</span>
		<span class="n">fcoe_ctlr_reset</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vn_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>

		<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;performing Clear Virtual Link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_vlink_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vp</span> <span class="o">=</span> <span class="n">vlink_desc_arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vn_port</span> <span class="o">=</span> <span class="n">fc_vport_id_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span>
						     <span class="n">ntoh24</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">fd_fc_id</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vn_port</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * &#39;port_id&#39; is already validated, check MAC address and</span>
<span class="cm">			 * wwpn</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">get_src_addr</span><span class="p">(</span><span class="n">vn_port</span><span class="p">),</span>
						<span class="n">vp</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
				<span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">fd_wwpn</span><span class="p">)</span> <span class="o">!=</span>
							<span class="n">vn_port</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vn_port</span> <span class="o">==</span> <span class="n">lport</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * Physical port, defer processing till all</span>
<span class="cm">				 * listed NPIV ports are cleared</span>
<span class="cm">				 */</span>
				<span class="n">reset_phys_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>    <span class="cm">/* NPIV port */</span>
				<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">vn_port</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reset_phys_port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
			<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vlink_desc_arr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv() - Receive a FIP packet</span>
<span class="cm"> * @fip: The FCoE controller that received the packet</span>
<span class="cm"> * @skb: The received FIP packet</span>
<span class="cm"> *</span>
<span class="cm"> * This may be called from either NET_RX_SOFTIRQ or IRQ.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fcoe_ctlr_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fip_recv_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">recv_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_recv</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_handler() - Receive a FIP frame</span>
<span class="cm"> * @fip: The FCoE controller that received the frame</span>
<span class="cm"> * @skb: The received FIP frame</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if the frame is dropped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_recv_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fiph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fip_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sub</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fiph</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">eh</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcoe_all_p2p</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">fcoe_all_enode</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="n">fiph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">op</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_op</span><span class="p">);</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_subcode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FIP_VER_DECAPS</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_ver</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FIP_VER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_dl_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">FIP_BPW</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fiph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">map_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_ENABLED</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">FIP_ST_ENABLED</span><span class="p">;</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Using FIP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span> <span class="o">&amp;&amp;</span> <span class="n">op</span> <span class="o">==</span> <span class="n">FIP_OP_VN2VN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fcoe_ctlr_vn_recv</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_ENABLED</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_VNMP_UP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_VNMP_CLAIM</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">FIP_OP_LS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_recv_els</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>	<span class="cm">/* consumes skb */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_ENABLED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">FIP_OP_DISC</span> <span class="o">&amp;&amp;</span> <span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_ADV</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_recv_adv</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">FIP_OP_CTRL</span> <span class="o">&amp;&amp;</span> <span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_CLR_VLINK</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_recv_clr_vlink</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">fiph</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_select() - Select the best FCF (if possible)</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the selected FCF, or NULL if none are usable.</span>
<span class="cm"> *</span>
<span class="cm"> * If there are conflicting advertisements, no FCF can be chosen.</span>
<span class="cm"> *</span>
<span class="cm"> * If there is already a selected FCF, this will choose a better one or</span>
<span class="cm"> * an equivalent one that hasn&#39;t already been sent a FLOGI.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="nf">fcoe_ctlr_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_fcf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;consider FCF fab %16.16llx &quot;</span>
				<span class="s">&quot;VFID %d mac %pM map %x val %d &quot;</span>
				<span class="s">&quot;sent %u pri %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">vfid</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">,</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span><span class="p">,</span> <span class="n">fcoe_ctlr_mtu_valid</span><span class="p">(</span><span class="n">fcf</span><span class="p">),</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span> <span class="o">!=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">fabric_name</span> <span class="o">||</span>
		    <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">vfid</span> <span class="o">!=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">vfid</span> <span class="o">||</span>
		    <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span> <span class="o">!=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">fc_map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;Conflicting fabric, VFID, &quot;</span>
					<span class="s">&quot;or FC-MAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcoe_ctlr_fcf_usable</span><span class="p">(</span><span class="n">fcf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FCF for fab %16.16llx &quot;</span>
					<span class="s">&quot;map %x %svalid %savailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fabric_name</span><span class="p">,</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">fc_map</span><span class="p">,</span>
					<span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_SOL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_AVAIL</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">best</span> <span class="o">||</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">&lt;</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">||</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">)</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">fcf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;using FCF mac %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">fcf_mac</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_KA_PERIOD</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">best</span><span class="o">-&gt;</span><span class="n">fka_period</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">best</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_flogi_send_locked() - send FIP-encapsulated FLOGI to current FCF</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error if it could not be sent.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex and ctlr_lock held.</span>
<span class="cm"> * Caller must verify that fip-&gt;sel_fcf is not NULL.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_flogi_send_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_orig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">skb_orig</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_orig</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clone and send the FLOGI request.  If clone fails, use original.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb_orig</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_orig</span><span class="p">;</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">fcoe_ctlr_encaps</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="n">FIP_DT_FLOGI</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				 <span class="n">ntoh24</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_flogi_retry() - resend FLOGI request to a new FCF if possible</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error code if there&#39;s no FLOGI request to retry or</span>
<span class="cm"> * no alternate FCF available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_flogi_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;re-sending FLOGI - reselect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">fcf</span> <span class="o">=</span> <span class="n">fcoe_ctlr_select</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span> <span class="o">||</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">fcoe_ctlr_flogi_send_locked</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_flogi_send() - Handle sending of FIP FLOGI.</span>
<span class="cm"> * @fip: The FCoE controller that timed out</span>
<span class="cm"> *</span>
<span class="cm"> * Done here because fcoe_ctlr_els_send() can&#39;t get mutex.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.  The caller must not hold ctlr_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_flogi_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
	<span class="n">fcf</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span> <span class="o">||</span> <span class="o">!</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req_send</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;sending FLOGI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this FLOGI is being sent due to a timeout retry</span>
<span class="cm">	 * to the same FCF as before, select a different FCF if possible.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;sending FLOGI - reselect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fcf</span> <span class="o">=</span> <span class="n">fcoe_ctlr_select</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcf</span> <span class="o">||</span> <span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;sending FLOGI - clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fcf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
				<span class="n">fcf</span><span class="o">-&gt;</span><span class="n">flogi_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fcf</span> <span class="o">=</span> <span class="n">fcoe_ctlr_select</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_flogi_send_locked</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req_send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* XXX */</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;No FCF selected - defer send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_timeout() - FIP timeout handler</span>
<span class="cm"> * @arg: The FCoE controller that timed out</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_timer_work() - Worker thread function for timer work</span>
<span class="cm"> * @work: Handle to a FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Ages FCFs.  Triggers FCF selection if possible.</span>
<span class="cm"> * Sends keep-alives and resets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_timer_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">vport</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_ctlr_ka</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_port_ka</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">sel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_timer</span><span class="p">;</span>

	<span class="n">fip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_ctlr</span><span class="p">,</span> <span class="n">timer_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fcoe_ctlr_vn_timeout</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcf</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="n">next_timer</span> <span class="o">=</span> <span class="n">fcoe_ctlr_age_fcfs</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>

	<span class="n">sel</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sel</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="n">fcoe_ctlr_select</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">next_timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">))</span>
			<span class="n">next_timer</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_req_send</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_flogi_send</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sel</span> <span class="o">&amp;&amp;</span> <span class="n">fcf</span><span class="p">)</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">fd_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">fka_period</span><span class="p">;</span>
			<span class="n">send_ctlr_ka</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">next_timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">))</span>
			<span class="n">next_timer</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_ka_time</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_KA_PERIOD</span><span class="p">);</span>
			<span class="n">send_port_ka</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">next_timer</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">))</span>
			<span class="n">next_timer</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fcfs</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">next_timer</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fc_lport_reset</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
		<span class="cm">/* restart things with a solicitation */</span>
		<span class="n">fcoe_ctlr_solicit</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_ctlr_ka</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_send_keep_alive</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_port_ka</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">get_src_addr</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_send_keep_alive</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">vports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">get_src_addr</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
			<span class="n">fcoe_ctlr_send_keep_alive</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">vport</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lp_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_work() - Worker thread function for receiving FIP frames</span>
<span class="cm"> * @recv_work: Handle to a FCoE controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_recv_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">recv_work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">fip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">recv_work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_ctlr</span><span class="p">,</span> <span class="n">recv_work</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">fip_recv_list</span><span class="p">)))</span>
		<span class="n">fcoe_ctlr_recv_handler</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_recv_flogi() - Snoop pre-FIP receipt of FLOGI response</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @fp:	 The FC frame to snoop</span>
<span class="cm"> *</span>
<span class="cm"> * Snoop potential response to FLOGI or even incoming FLOGI.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller has checked that we are waiting for login as indicated</span>
<span class="cm"> * by fip-&gt;flogi_oxid != FC_XID_UNKNOWN.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is responsible for freeing the frame.</span>
<span class="cm"> * Fill in the granted_mac address.</span>
<span class="cm"> *</span>
<span class="cm"> * Return non-zero if the frame should not be delivered to libfc.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fcoe_ctlr_recv_flogi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_frame_header</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>

	<span class="n">sa</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">;</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">fc_frame_header_get</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_type</span> <span class="o">!=</span> <span class="n">FC_TYPE_ELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">op</span> <span class="o">=</span> <span class="n">fc_frame_payload_op</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_LS_ACC</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">==</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_ox_id</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_AUTO</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">);</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
				<span class="s">&quot;received FLOGI LS_ACC using non-FIP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FLOGI accepted.</span>
<span class="cm">		 * If the src mac addr is FC_OUI-based, then we mark the</span>
<span class="cm">		 * address_mode flag to use FC_OUI-based Ethernet DA.</span>
<span class="cm">		 * Otherwise we use the FCoE gateway addr</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="n">FC_FCOE_FLOGI_MAC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">map_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">flogi_oxid</span> <span class="o">=</span> <span class="n">FC_XID_UNKNOWN</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="n">fc_fcoe_set_mac</span><span class="p">(</span><span class="n">fr_cb</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">granted_mac</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_d_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="n">ELS_FLOGI</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fh_r_ctl</span> <span class="o">==</span> <span class="n">FC_RCTL_ELS_REQ</span> <span class="o">&amp;&amp;</span> <span class="n">sa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Save source MAC for point-to-point responses.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_AUTO</span> <span class="o">||</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">dest_addr</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">map_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_AUTO</span><span class="p">)</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;received non-FIP FLOGI. &quot;</span>
						<span class="s">&quot;Setting non-FIP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_NON_FIP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_recv_flogi</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_wwn_from_mac() - Converts a 48-bit IEEE MAC address to a 64-bit FC WWN</span>
<span class="cm"> * @mac:    The MAC address to convert</span>
<span class="cm"> * @scheme: The scheme to use when converting</span>
<span class="cm"> * @port:   The port indicator for converting</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: u64 fc world wide name</span>
<span class="cm"> */</span>
<span class="n">u64</span> <span class="nf">fcoe_wwn_from_mac</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mac</span><span class="p">[</span><span class="n">MAX_ADDR_LEN</span><span class="p">],</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">wwn</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">host_mac</span><span class="p">;</span>

	<span class="cm">/* The MAC is in NO, so flip only the low 48 bits */</span>
	<span class="n">host_mac</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host_mac</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">));</span>
	<span class="n">wwn</span> <span class="o">=</span> <span class="n">host_mac</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">scheme</span> <span class="o">&lt;&lt;</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">scheme</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="n">wwn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">wwn</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fcoe_wwn_from_mac</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_rport() - return the fcoe_rport for a given fc_rport_priv</span>
<span class="cm"> * @rdata: libfc remote port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="nf">fcoe_ctlr_rport</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="p">)(</span><span class="n">rdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_send() - Send a FIP VN2VN Probe Request or Reply.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @sub: sub-opcode for probe request, reply, or advertisement.</span>
<span class="cm"> * @dest: The destination Ethernet MAC address</span>
<span class="cm"> * @min_len: minimum size of the Ethernet payload to be sent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">fip_vn2vn_subcode</span> <span class="n">sub</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">min_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_frame</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">eth</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_header</span> <span class="n">fip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="n">mac</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="n">wwnn</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="n">vn</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span> <span class="o">*</span> <span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_fc4_feat</span> <span class="o">*</span><span class="n">ff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_size_desc</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcp_feat</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">);</span>
	<span class="n">dlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_VN_CLAIM_NOTIFY</span> <span class="o">||</span> <span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_VN_CLAIM_REP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_fc4_feat</span><span class="p">)</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_size_desc</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">min_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span><span class="p">));</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_VN_BEACON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">FIP_VN_FC_MAP</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_source</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">eth</span><span class="p">.</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_ver</span> <span class="o">=</span> <span class="n">FIP_VER_ENCAPS</span><span class="p">(</span><span class="n">FIP_VER</span><span class="p">);</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_op</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">FIP_OP_VN2VN</span><span class="p">);</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_subcode</span> <span class="o">=</span> <span class="n">sub</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">fip</span><span class="p">.</span><span class="n">fip_dl_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">dlen</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_MAC</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctl_src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_NAME</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">wwnn</span><span class="p">.</span><span class="n">fd_wwn</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_VN_ID</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">FIP_VN_FC_MAP</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_mac</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">hton24</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_fc_id</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">);</span>
	<span class="n">put_unaligned_be64</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">vn</span><span class="p">.</span><span class="n">fd_wwpn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For claims, add FC-4 features.</span>
<span class="cm">	 * TBD: Add interface to get fc-4 types and features from libfc.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_VN_CLAIM_NOTIFY</span> <span class="o">||</span> <span class="n">sub</span> <span class="o">==</span> <span class="n">FIP_SC_VN_CLAIM_REP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_fc4_feat</span> <span class="o">*</span><span class="p">)(</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ff</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_FC4F</span><span class="p">;</span>
		<span class="n">ff</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ff</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="n">ff</span><span class="o">-&gt;</span><span class="n">fd_fts</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fcts</span><span class="p">;</span>

		<span class="n">fcp_feat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_INIT_FCN</span><span class="p">)</span>
			<span class="n">fcp_feat</span> <span class="o">|=</span> <span class="n">FCP_FEAT_INIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">service_params</span> <span class="o">&amp;</span> <span class="n">FCP_SPPF_TARG_FCN</span><span class="p">)</span>
			<span class="n">fcp_feat</span> <span class="o">|=</span> <span class="n">FCP_FEAT_TARG</span><span class="p">;</span>
		<span class="n">fcp_feat</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">FC_TYPE_FCP</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">ff</span><span class="o">-&gt;</span><span class="n">fd_ff</span><span class="p">.</span><span class="n">fd_feat</span><span class="p">[</span><span class="n">FC_TYPE_FCP</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">fcp_feat</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_size_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">ff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">size</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dtype</span> <span class="o">=</span> <span class="n">FIP_DT_FCOE_SIZE</span><span class="p">;</span>
		<span class="n">size</span><span class="o">-&gt;</span><span class="n">fd_desc</span><span class="p">.</span><span class="n">fip_dlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="n">size</span><span class="o">-&gt;</span><span class="n">fd_size</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">fcoe_ctlr_fcoe_size</span><span class="p">(</span><span class="n">fip</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_FIP</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_rport_callback - Event handler for rport events.</span>
<span class="cm"> * @lport: The lport which is receiving the event</span>
<span class="cm"> * @rdata: remote port private data</span>
<span class="cm"> * @event: The event that occurred</span>
<span class="cm"> *</span>
<span class="cm"> * Locking Note:  The rport lock must not be held when calling this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_rport_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">fc_rport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;vn_rport_callback %x event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPORT_EV_READY</span>:
		<span class="n">frport</span><span class="o">-&gt;</span><span class="n">login_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPORT_EV_LOGO</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_FAILED</span>:
	<span class="k">case</span> <span class="n">RPORT_EV_STOP</span>:
		<span class="n">frport</span><span class="o">-&gt;</span><span class="n">login_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">login_count</span> <span class="o">&gt;</span> <span class="n">FCOE_CTLR_VN2VN_LOGIN_LIMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
					<span class="s">&quot;rport FLOGI limited port_id %6.6x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_rport_operations</span> <span class="n">fcoe_ctlr_vn_rport_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">event_callback</span> <span class="o">=</span> <span class="n">fcoe_ctlr_vn_rport_callback</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_disc_stop_locked() - stop discovery in VN2VN mode</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_disc_stop_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_disc_stop() - stop discovery in VN2VN mode</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called through the local port template for discovery.</span>
<span class="cm"> * Called without the ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_disc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_disc_stop_locked</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_disc_stop_final() - stop discovery for shutdown in VN2VN mode</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called through the local port template for discovery.</span>
<span class="cm"> * Called without the ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_disc_stop_final</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcoe_ctlr_disc_stop</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_flush_queue</span><span class="p">();</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_restart() - VN2VN probe restart with new port_id</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called with fcoe_ctlr lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="n">fcoe_ctlr_disc_stop_locked</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get proposed port ID.</span>
<span class="cm">	 * If this is the first try after link up, use any previous port_id.</span>
<span class="cm">	 * If there was none, use the low bits of the port_name.</span>
<span class="cm">	 * On subsequent tries, get the next random one.</span>
<span class="cm">	 * Don&#39;t use reserved IDs, use another non-zero value, just as random.</span>
<span class="cm">	 */</span>
	<span class="n">port_id</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">probe_tries</span><span class="p">)</span>
		<span class="n">port_id</span> <span class="o">=</span> <span class="n">prandom32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">rnd_state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_id</span><span class="p">)</span>
		<span class="n">port_id</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwpn</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_id</span> <span class="o">||</span> <span class="n">port_id</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">probe_tries</span> <span class="o">&lt;</span> <span class="n">FIP_VN_RLIM_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">probe_tries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="n">FIP_VN_PROBE_WAIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="n">FIP_VN_RLIM_INT</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">wait</span><span class="p">));</span>
	<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_VNMP_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_start() - Start in VN2VN mode</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called with fcoe_ctlr lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">probe_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prandom32_seed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">rnd_state</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">);</span>
	<span class="n">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_parse - parse probe request or response</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @skb: incoming packet</span>
<span class="cm"> * @rdata: buffer for resulting parsed VN entry plus fcoe_rport</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error number on error.</span>
<span class="cm"> * Does not consume the packet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_vn_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fiph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="n">macd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="n">wwn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="n">vn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fip_size_desc</span> <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dtype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sub</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdata</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frport</span><span class="p">));</span>
	<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="n">fiph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">frport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_flags</span><span class="p">);</span>

	<span class="n">sub</span> <span class="o">=</span> <span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_subcode</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_PROBE_REQ</span>:
	<span class="k">case</span> <span class="n">FIP_SC_VN_PROBE_REP</span>:
	<span class="k">case</span> <span class="n">FIP_SC_VN_BEACON</span>:
		<span class="n">desc_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_VN_ID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_CLAIM_NOTIFY</span>:
	<span class="k">case</span> <span class="n">FIP_SC_VN_CLAIM_REP</span>:
		<span class="n">desc_mask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_MAC</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_NAME</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_VN_ID</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FC4F</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">BIT</span><span class="p">(</span><span class="n">FIP_DT_FCOE_SIZE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;vn_parse unknown subcode %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_dl_len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fiph</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">fiph</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dlen</span> <span class="o">*</span> <span class="n">FIP_BPW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="p">)</span> <span class="o">||</span> <span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">rlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">dtype</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fip_dtype</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc_mask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">dtype</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
						<span class="s">&quot;unexpected or duplicated desc &quot;</span>
						<span class="s">&quot;desc type %u in &quot;</span>
						<span class="s">&quot;FIP VN2VN subtype %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dtype</span><span class="p">,</span> <span class="n">sub</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">desc_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">dtype</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIP_DT_MAC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">macd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_mac_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">macd</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
					<span class="s">&quot;Invalid MAC addr %pM in FIP VN2VN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">macd</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="n">macd</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_NAME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_wwn_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">wwn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_wwn_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wwn</span><span class="o">-&gt;</span><span class="n">fd_wwn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_VN_ID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_vn_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">vn</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_vn_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">vn_mac</span><span class="p">,</span> <span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">ntoh24</span><span class="p">(</span><span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_fc_id</span><span class="p">);</span>
			<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">get_unaligned_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vn</span><span class="o">-&gt;</span><span class="n">fd_wwpn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_FC4F</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_fc4_feat</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIP_DT_FCOE_SIZE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fip_size_desc</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">len_err</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_size_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span><span class="p">;</span>
			<span class="n">frport</span><span class="o">-&gt;</span><span class="n">fcoe_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">size</span><span class="o">-&gt;</span><span class="n">fd_size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;unexpected descriptor type %x &quot;</span>
					<span class="s">&quot;in FIP probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">);</span>
			<span class="cm">/* standard says ignore unknown descriptors &gt;= 128 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">&lt;</span> <span class="n">FIP_DT_VENDOR_BASE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_desc</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">desc</span> <span class="o">+</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="n">rlen</span> <span class="o">-=</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">len_err:</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;FIP length error in descriptor type %x len %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dtype</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_send_claim() - send multicast FIP VN2VN Claim Notification.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_send_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_CLAIM_NOTIFY</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_probe_req() - handle incoming VN2VN probe request.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @rdata: parsed remote port with frport from the probe request</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">!=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_CLAIM</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_UP</span>:
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REP</span><span class="p">,</span>
				  <span class="n">frport</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE1</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Decide whether to reply to the Probe.</span>
<span class="cm">		 * Our selected address is never a &quot;recorded&quot; one, so</span>
<span class="cm">		 * only reply if our WWPN is greater and the</span>
<span class="cm">		 * Probe&#39;s REC bit is not set.</span>
<span class="cm">		 * If we don&#39;t reply, we will change our address.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwpn</span> <span class="o">&gt;</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_REC_OR_P2P</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REP</span><span class="p">,</span>
					  <span class="n">frport</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_START</span>:
		<span class="n">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_probe_reply() - handle incoming VN2VN probe reply.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @rdata: parsed remote port with frport from the probe request</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_probe_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">!=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_START</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE1</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE2</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_CLAIM</span>:
		<span class="n">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_UP</span>:
		<span class="n">fcoe_ctlr_vn_send_claim</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_add() - Add a VN2VN entry to the list, based on a claim reply.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @new: newly-parsed remote port with frport as a template for new rdata</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_identifiers</span> <span class="o">*</span><span class="n">ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port_id</span><span class="p">;</span>

	<span class="n">port_id</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_create</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fcoe_ctlr_vn_rport_ops</span><span class="p">;</span>
	<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">disc_id</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_id</span><span class="p">;</span>

	<span class="n">ids</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">node_name</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">node_name</span> <span class="o">!=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span><span class="p">))</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span><span class="p">;</span>
	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>

	<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;vn_add rport %6.6x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">port_id</span><span class="p">,</span> <span class="n">frport</span><span class="o">-&gt;</span><span class="n">fcoe_len</span> <span class="o">?</span> <span class="s">&quot;old&quot;</span> <span class="o">:</span> <span class="s">&quot;new&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">frport</span> <span class="o">=</span> <span class="o">*</span><span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_lookup() - Find VN remote port&#39;s MAC address</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @port_id:  The port_id of the remote VN_node</span>
<span class="cm"> * @mac: buffer which will hold the VN_NODE destination MAC address, if found.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero error if no remote port found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_vn_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_id</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">frport</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_claim_notify() - handle received FIP VN2VN Claim Notification</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> * @new: newly-parsed remote port with frport as a template for new rdata</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_claim_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_REC_OR_P2P</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REQ</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_START</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE1</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span>
			<span class="n">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_CLAIM</span>:
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_UP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">&gt;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wwpn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcoe_ctlr_vn_restart</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fcoe_ctlr_vn_send_claim</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_CLAIM_REP</span><span class="p">,</span> <span class="n">frport</span><span class="o">-&gt;</span><span class="n">enode_mac</span><span class="p">,</span>
				  <span class="n">min</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">fcoe_len</span><span class="p">,</span>
				      <span class="n">fcoe_ctlr_fcoe_size</span><span class="p">(</span><span class="n">fip</span><span class="p">)));</span>
		<span class="n">fcoe_ctlr_vn_add</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_claim_resp() - handle received Claim Response</span>
<span class="cm"> * @fip: The FCoE controller that received the frame</span>
<span class="cm"> * @new: newly-parsed remote port with frport from the Claim Response</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_claim_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;claim resp from from rport %x - state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">,</span> <span class="n">fcoe_ctlr_state</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_VNMP_UP</span> <span class="o">||</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_VNMP_CLAIM</span><span class="p">)</span>
		<span class="n">fcoe_ctlr_vn_add</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_beacon() - handle received beacon.</span>
<span class="cm"> * @fip: The FCoE controller that received the frame</span>
<span class="cm"> * @new: newly-parsed remote port with frport from the Beacon</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>

	<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIP_FL_REC_OR_P2P</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REQ</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_lookup</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="p">)</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">node_name</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span> <span class="o">==</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">&amp;&amp;</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FIP_ST_VNMP_UP</span><span class="p">)</span>
				<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
			<span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_destroy</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FIP_ST_VNMP_UP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Beacon from a new neighbor.</span>
<span class="cm">	 * Send a claim notify if one hasn&#39;t been sent recently.</span>
<span class="cm">	 * Don&#39;t add the neighbor yet.</span>
<span class="cm">	 */</span>
	<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;beacon from new rport %x. sending claim notify</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
		       <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_ANN_WAIT</span><span class="p">)))</span>
		<span class="n">fcoe_ctlr_vn_send_claim</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_age() - Check for VN_ports without recent beacons</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ctlr_mutex held.</span>
<span class="cm"> * Called only in state FIP_ST_VNMP_UP.</span>
<span class="cm"> * Returns the soonest time for next age-out or a time far in the future.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">fcoe_ctlr_vn_age</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">;</span>

	<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_BEACON_INT</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">rports</span><span class="p">,</span> <span class="n">peers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">deadline</span> <span class="o">=</span> <span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">+</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_BEACON_INT</span> <span class="o">*</span> <span class="mi">25</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span>
				<span class="s">&quot;port %16.16llx fc_id %6.6x beacon expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">rdata</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">.</span><span class="n">port_id</span><span class="p">);</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_logoff</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">next_time</span><span class="p">))</span>
			<span class="n">next_time</span> <span class="o">=</span> <span class="n">deadline</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_recv() - Receive a FIP frame</span>
<span class="cm"> * @fip: The FCoE controller that received the frame</span>
<span class="cm"> * @skb: The received FIP frame</span>
<span class="cm"> *</span>
<span class="cm"> * Returns non-zero if the frame is dropped.</span>
<span class="cm"> * Always consumes the frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fcoe_ctlr_vn_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="n">fiph</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">fip_vn2vn_subcode</span> <span class="n">sub</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="n">rdata</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="n">frport</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fiph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fip_header</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sub</span> <span class="o">=</span> <span class="n">fiph</span><span class="o">-&gt;</span><span class="n">fip_subcode</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">fcoe_ctlr_vn_parse</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;vn_recv vn_parse error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_PROBE_REQ</span>:
		<span class="n">fcoe_ctlr_vn_probe_req</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_PROBE_REP</span>:
		<span class="n">fcoe_ctlr_vn_probe_reply</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_CLAIM_NOTIFY</span>:
		<span class="n">fcoe_ctlr_vn_claim_notify</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_CLAIM_REP</span>:
		<span class="n">fcoe_ctlr_vn_claim_resp</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_SC_VN_BEACON</span>:
		<span class="n">fcoe_ctlr_vn_beacon</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">.</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LIBFCOE_FIP_DBG</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="s">&quot;vn_recv unknown subcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_disc_recv - discovery receive handler for VN2VN mode.</span>
<span class="cm"> * @lport: The local port</span>
<span class="cm"> * @fp: The received frame</span>
<span class="cm"> *</span>
<span class="cm"> * This should never be called since we don&#39;t see RSCNs or other</span>
<span class="cm"> * fabric-generated ELSes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_disc_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_seq_els_data</span> <span class="n">rjt_data</span><span class="p">;</span>

	<span class="n">rjt_data</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ELS_RJT_UNSUP</span><span class="p">;</span>
	<span class="n">rjt_data</span><span class="p">.</span><span class="n">explan</span> <span class="o">=</span> <span class="n">ELS_EXPL_NONE</span><span class="p">;</span>
	<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">seq_els_rsp_send</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ELS_LS_RJT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rjt_data</span><span class="p">);</span>
	<span class="n">fc_frame_free</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_disc_recv - start discovery for VN2VN mode.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * This sets a flag indicating that remote ports should be created</span>
<span class="cm"> * and started for the peers we discover.  We use the disc_callback</span>
<span class="cm"> * pointer as that flag.  Peers already discovered are created here.</span>
<span class="cm"> *</span>
<span class="cm"> * The lport lock is held during this call. The callback must be done</span>
<span class="cm"> * later, without holding either the lport or discovery locks.</span>
<span class="cm"> * The fcoe_ctlr lock may also be held during this call.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_disc_start</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span>
						  <span class="k">enum</span> <span class="n">fc_disc_event</span><span class="p">),</span>
				 <span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_disc</span> <span class="o">*</span><span class="n">disc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">disc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_id</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">disc</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer_work</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_disc() - report FIP VN_port discovery results after claim state.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> *</span>
<span class="cm"> * Starts the FLOGI and PLOGI login process to each discovered rport for which</span>
<span class="cm"> * we&#39;ve received at least one beacon.</span>
<span class="cm"> * Performs the discovery complete callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_disc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_disc</span> <span class="o">*</span><span class="n">disc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport_priv</span> <span class="o">*</span><span class="n">rdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_rport</span> <span class="o">*</span><span class="n">frport</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">fc_disc_event</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="n">callback</span> <span class="o">=</span> <span class="n">disc</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">?</span> <span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_callback</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">disc</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">rports</span><span class="p">,</span> <span class="n">peers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frport</span> <span class="o">=</span> <span class="n">fcoe_ctlr_rport</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frport</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)</span>
			<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">rport_login</span><span class="p">(</span><span class="n">rdata</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc</span><span class="o">-&gt;</span><span class="n">disc_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">lport</span><span class="p">,</span> <span class="n">DISC_EV_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_ctlr_vn_timeout - timer work function for VN2VN mode.</span>
<span class="cm"> * @fip: The FCoE controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fcoe_ctlr_vn_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_time</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">new_port_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_START</span>:
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_VNMP_PROBE1</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REQ</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_PROBE_WAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE1</span>:
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_VNMP_PROBE2</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_PROBE_REQ</span><span class="p">,</span> <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_ANN_WAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_PROBE2</span>:
		<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_VNMP_CLAIM</span><span class="p">);</span>
		<span class="n">new_port_id</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">FIP_VN_FC_MAP</span><span class="p">);</span>
		<span class="n">hton24</span><span class="p">(</span><span class="n">mac</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">new_port_id</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_map_dest</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="n">fip</span><span class="o">-&gt;</span><span class="n">update_mac</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="n">fcoe_ctlr_vn_send_claim</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_ANN_WAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_CLAIM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This may be invoked either by starting discovery so don&#39;t</span>
<span class="cm">		 * go to the next state unless it&#39;s been long enough.</span>
<span class="cm">		 */</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sol_time</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_ANN_WAIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">next_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcoe_ctlr_set_state</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_ST_VNMP_UP</span><span class="p">);</span>
			<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_BEACON</span><span class="p">,</span>
					  <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_ANN_WAIT</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span> <span class="o">=</span> <span class="n">next_time</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcoe_ctlr_vn_disc</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_VNMP_UP</span>:
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">fcoe_ctlr_vn_age</span><span class="p">(</span><span class="n">fip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcoe_ctlr_vn_send</span><span class="p">(</span><span class="n">fip</span><span class="p">,</span> <span class="n">FIP_SC_VN_BEACON</span><span class="p">,</span>
					  <span class="n">fcoe_all_vn2vn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">FIP_VN_BEACON_INT</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="n">FIP_VN_BEACON_FUZZ</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">,</span> <span class="n">next_time</span><span class="p">))</span>
			<span class="n">next_time</span> <span class="o">=</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">port_ka_time</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_ST_LINK_WAIT</span>:
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unexpected state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">next_time</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>

	<span class="cm">/* If port ID is new, notify local port after dropping ctlr_mutex */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_port_id</span><span class="p">)</span>
		<span class="n">fc_lport_set_local_id</span><span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">,</span> <span class="n">new_port_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fcoe_libfc_config() - Sets up libfc related properties for local port</span>
<span class="cm"> * @lport:    The local port to configure libfc for</span>
<span class="cm"> * @fip:      The FCoE controller in use by the local port</span>
<span class="cm"> * @tt:       The libfc function template</span>
<span class="cm"> * @init_fcp: If non-zero, the FCP portion of libfc should be initialized</span>
<span class="cm"> *</span>
<span class="cm"> * Returns : 0 for success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fcoe_libfc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_lport</span> <span class="o">*</span><span class="n">lport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">libfc_function_template</span> <span class="o">*</span><span class="n">tt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">init_fcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set the function pointers set by the LLDD */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_fcp</span> <span class="o">&amp;&amp;</span> <span class="n">fc_fcp_init</span><span class="p">(</span><span class="n">lport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fc_exch_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_elsct_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="n">fc_lport_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">rport_priv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_rport</span><span class="p">);</span>
	<span class="n">fc_rport_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FIP_MODE_VN2VN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">point_to_multipoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_recv_req</span> <span class="o">=</span> <span class="n">fcoe_ctlr_disc_recv</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_start</span> <span class="o">=</span> <span class="n">fcoe_ctlr_disc_start</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_stop</span> <span class="o">=</span> <span class="n">fcoe_ctlr_disc_stop</span><span class="p">;</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">tt</span><span class="p">.</span><span class="n">disc_stop_final</span> <span class="o">=</span> <span class="n">fcoe_ctlr_disc_stop_final</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">disc_mutex</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">rports</span><span class="p">);</span>
		<span class="n">lport</span><span class="o">-&gt;</span><span class="n">disc</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">fip</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fc_disc_init</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fcoe_libfc_config</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">fcoe_fcf_get_selected</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_fcf_device</span> <span class="o">*</span><span class="n">fcf_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span> <span class="o">=</span> <span class="n">fcoe_fcf_dev_to_ctlr_dev</span><span class="p">(</span><span class="n">fcf_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">fip</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_priv</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fcoe_fcf</span> <span class="o">*</span><span class="n">fcf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">fcf</span> <span class="o">=</span> <span class="n">fcoe_fcf_device_priv</span><span class="p">(</span><span class="n">fcf_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcf</span><span class="p">)</span>
		<span class="n">fcf_dev</span><span class="o">-&gt;</span><span class="n">selected</span> <span class="o">=</span> <span class="p">(</span><span class="n">fcf</span> <span class="o">==</span> <span class="n">fip</span><span class="o">-&gt;</span><span class="n">sel_fcf</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fcf_dev</span><span class="o">-&gt;</span><span class="n">selected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fip</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_fcf_get_selected</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">fcoe_ctlr_get_fip_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_ctlr_device</span> <span class="o">*</span><span class="n">ctlr_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fcoe_ctlr</span> <span class="o">*</span><span class="n">ctlr</span> <span class="o">=</span> <span class="n">fcoe_ctlr_device_priv</span><span class="p">(</span><span class="n">ctlr_dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIP_MODE_FABRIC</span>:
		<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FIP_CONN_TYPE_FABRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIP_MODE_VN2VN</span>:
		<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FIP_CONN_TYPE_VN2VN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ctlr_dev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FIP_CONN_TYPE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlr</span><span class="o">-&gt;</span><span class="n">ctlr_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fcoe_ctlr_get_fip_mode</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
