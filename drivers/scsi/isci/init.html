<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › isci › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is provided under a dual BSD/GPLv2 license.  When using or</span>
<span class="cm"> * redistributing this file, you may do so under either license.</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * BSD LICENSE</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *   * Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *   * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *     the documentation and/or other materials provided with the</span>
<span class="cm"> *     distribution.</span>
<span class="cm"> *   * Neither the name of Intel Corporation nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &quot;host.h&quot;</span>
<span class="cp">#include &quot;isci.h&quot;</span>
<span class="cp">#include &quot;task.h&quot;</span>
<span class="cp">#include &quot;probe_roms.h&quot;</span>

<span class="cp">#define MAJ 1</span>
<span class="cp">#define MIN 1</span>
<span class="cp">#define BUILD 0</span>
<span class="cp">#define DRV_VERSION __stringify(MAJ) &quot;.&quot; __stringify(MIN) &quot;.&quot; \</span>
<span class="cp">	__stringify(BUILD)</span>

<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">isci_transport_template</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">isci_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D61</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D63</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D65</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D67</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D69</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D6B</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D60</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D62</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D64</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D66</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D68</span><span class="p">),},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1D6A</span><span class="p">),},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">isci_id_table</span><span class="p">);</span>

<span class="cm">/* linux isci specific settings */</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">no_outbound_task_to</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_outbound_task_to</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_outbound_task_to</span><span class="p">,</span> <span class="s">&quot;No Outbound Task Timeout (1us incr)&quot;</span><span class="p">);</span>

<span class="n">u16</span> <span class="n">ssp_max_occ_to</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ssp_max_occ_to</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ssp_max_occ_to</span><span class="p">,</span> <span class="s">&quot;SSP Max occupancy timeout (100us incr)&quot;</span><span class="p">);</span>

<span class="n">u16</span> <span class="n">stp_max_occ_to</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">stp_max_occ_to</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">stp_max_occ_to</span><span class="p">,</span> <span class="s">&quot;STP Max occupancy timeout (100us incr)&quot;</span><span class="p">);</span>

<span class="n">u16</span> <span class="n">ssp_inactive_to</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ssp_inactive_to</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ssp_inactive_to</span><span class="p">,</span> <span class="s">&quot;SSP inactivity timeout (100us incr)&quot;</span><span class="p">);</span>

<span class="n">u16</span> <span class="n">stp_inactive_to</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">stp_inactive_to</span><span class="p">,</span> <span class="n">ushort</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">stp_inactive_to</span><span class="p">,</span> <span class="s">&quot;STP inactivity timeout (100us incr)&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phy_gen</span> <span class="o">=</span> <span class="n">SCIC_SDS_PARM_GEN2_SPEED</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">phy_gen</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">phy_gen</span><span class="p">,</span> <span class="s">&quot;PHY generation (1: 1.5Gbps 2: 3.0Gbps 3: 6.0Gbps)&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_concurr_spinup</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_concurr_spinup</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_concurr_spinup</span><span class="p">,</span> <span class="s">&quot;Max concurrent device spinup&quot;</span><span class="p">);</span>

<span class="n">uint</span> <span class="n">cable_selection_override</span> <span class="o">=</span> <span class="n">CABLE_OVERRIDE_DISABLED</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cable_selection_override</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cable_selection_override</span><span class="p">,</span>
		 <span class="s">&quot;This field indicates length of the SAS/SATA cable between &quot;</span>
		 <span class="s">&quot;host and device. If any bits &gt; 15 are set (default) &quot;</span>
		 <span class="s">&quot;indicates </span><span class="se">\&quot;</span><span class="s">use platform defaults</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">isci_show_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">shost</span><span class="p">),</span> <span class="n">shost_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span> <span class="o">=</span> <span class="n">SHOST_TO_SAS_HA</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sas_ha</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ihost</span><span class="p">),</span> <span class="n">sas_ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">isci_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">isci_show_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">isci_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_isci_id</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">isci_sht</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">sas_queuecommand</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>			<span class="o">=</span> <span class="n">sas_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">sas_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_finished</span>			<span class="o">=</span> <span class="n">isci_host_scan_finished</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan_start</span>			<span class="o">=</span> <span class="n">isci_host_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>		<span class="o">=</span> <span class="n">sas_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_type</span>		<span class="o">=</span> <span class="n">sas_change_queue_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">sas_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">ISCI_CAN_QUEUE_VAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="n">SCSI_DEFAULT_MAX_SECTORS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>			<span class="o">=</span> <span class="n">sas_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>				<span class="o">=</span> <span class="n">sas_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">isci_host_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sas_domain_function_template</span> <span class="n">isci_transport_ops</span>  <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* The class calls these to notify the LLDD of an event. */</span>
	<span class="p">.</span><span class="n">lldd_port_formed</span>	<span class="o">=</span> <span class="n">isci_port_formed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_port_deformed</span>	<span class="o">=</span> <span class="n">isci_port_deformed</span><span class="p">,</span>

	<span class="cm">/* The class calls these when a device is found or gone. */</span>
	<span class="p">.</span><span class="n">lldd_dev_found</span>		<span class="o">=</span> <span class="n">isci_remote_device_found</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_dev_gone</span>		<span class="o">=</span> <span class="n">isci_remote_device_gone</span><span class="p">,</span>

	<span class="p">.</span><span class="n">lldd_execute_task</span>	<span class="o">=</span> <span class="n">isci_task_execute_task</span><span class="p">,</span>
	<span class="cm">/* Task Management Functions. Must be called from process context. */</span>
	<span class="p">.</span><span class="n">lldd_abort_task</span>	<span class="o">=</span> <span class="n">isci_task_abort_task</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_abort_task_set</span>	<span class="o">=</span> <span class="n">isci_task_abort_task_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_clear_aca</span>		<span class="o">=</span> <span class="n">isci_task_clear_aca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_clear_task_set</span>	<span class="o">=</span> <span class="n">isci_task_clear_task_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_I_T_nexus_reset</span>	<span class="o">=</span> <span class="n">isci_task_I_T_nexus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_lu_reset</span>		<span class="o">=</span> <span class="n">isci_task_lu_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_query_task</span>	<span class="o">=</span> <span class="n">isci_task_query_task</span><span class="p">,</span>

	<span class="cm">/* ata recovery called from ata-eh */</span>
	<span class="p">.</span><span class="n">lldd_ata_check_ready</span>	<span class="o">=</span> <span class="n">isci_ata_check_ready</span><span class="p">,</span>

	<span class="cm">/* Port and Adapter management */</span>
	<span class="p">.</span><span class="n">lldd_clear_nexus_port</span>	<span class="o">=</span> <span class="n">isci_task_clear_nexus_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lldd_clear_nexus_ha</span>	<span class="o">=</span> <span class="n">isci_task_clear_nexus_ha</span><span class="p">,</span>

	<span class="cm">/* Phy management */</span>
	<span class="p">.</span><span class="n">lldd_control_phy</span>	<span class="o">=</span> <span class="n">isci_phy_control</span><span class="p">,</span>

	<span class="cm">/* GPIO support */</span>
	<span class="p">.</span><span class="n">lldd_write_gpio</span>	<span class="o">=</span> <span class="n">isci_gpio_write</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/******************************************************************************</span>
<span class="cm">* P R O T E C T E D  M E T H O D S</span>
<span class="cm">******************************************************************************/</span>



<span class="cm">/**</span>
<span class="cm"> * isci_register_sas_ha() - This method initializes various lldd</span>
<span class="cm"> *    specific members of the sas_ha struct and calls the libsas</span>
<span class="cm"> *    sas_register_ha() function.</span>
<span class="cm"> * @isci_host: This parameter specifies the lldd specific wrapper for the</span>
<span class="cm"> *    libsas sas_ha struct.</span>
<span class="cm"> *</span>
<span class="cm"> * This method returns an error code indicating sucess or failure. The user</span>
<span class="cm"> * should check for possible memory allocation error return otherwise, a zero</span>
<span class="cm"> * indicates success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isci_register_sas_ha</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">isci_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_ha_struct</span> <span class="o">*</span><span class="n">sas_ha</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asd_sas_phy</span> <span class="o">**</span><span class="n">sas_phys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asd_sas_port</span> <span class="o">**</span><span class="n">sas_ports</span><span class="p">;</span>

	<span class="n">sas_phys</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">SCI_MAX_PHYS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_phys</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sas_ports</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">SCI_MAX_PORTS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_ports</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">sas_ha_name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">lldd_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">sas_addr</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sas_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sas_phy</span><span class="p">;</span>
		<span class="n">sas_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">sas_ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">sas_phy</span>  <span class="o">=</span> <span class="n">sas_phys</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">sas_port</span> <span class="o">=</span> <span class="n">sas_ports</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span>

	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">lldd_queue_size</span> <span class="o">=</span> <span class="n">ISCI_CAN_QUEUE_VAL</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">lldd_max_execute_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sas_ha</span><span class="o">-&gt;</span><span class="n">strict_wide_ports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sas_register_ha</span><span class="p">(</span><span class="n">sas_ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">isci_host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isci_host</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sas_unregister_ha</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">);</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">to_shost</span><span class="p">(</span><span class="n">isci_host</span><span class="p">);</span>
	<span class="n">sas_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">isci_pci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">bar_num</span><span class="p">,</span> <span class="n">bar_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">iomap</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed enable PCI device %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bar_num</span> <span class="o">&lt;</span> <span class="n">SCI_PCI_BAR_COUNT</span><span class="p">;</span> <span class="n">bar_num</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bar_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bar_num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pcim_iomap_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar_mask</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">iomap</span> <span class="o">=</span> <span class="n">pcim_iomap_table</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iomap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">num_controllers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* bar size alone can tell us if we are running with a dual controller</span>
<span class="cm">	 * part, no need to trust revision ids that might be under broken firmware</span>
<span class="cm">	 * control</span>
<span class="cm">	 */</span>
	<span class="n">resource_size_t</span> <span class="n">scu_bar_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SCI_SCU_BAR</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">resource_size_t</span> <span class="n">smu_bar_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SCI_SMU_BAR</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scu_bar_size</span> <span class="o">&gt;=</span> <span class="n">SCI_SCU_BAR_SIZE</span><span class="o">*</span><span class="n">SCI_MAX_CONTROLLERS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">smu_bar_size</span> <span class="o">&gt;=</span> <span class="n">SCI_SMU_BAR_SIZE</span><span class="o">*</span><span class="n">SCI_MAX_CONTROLLERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCI_MAX_CONTROLLERS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isci_setup_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_pci_info</span> <span class="o">*</span><span class="n">pci_info</span> <span class="o">=</span> <span class="n">to_pci_info</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Determine the number of vectors associated with this</span>
<span class="cm">	 *  PCI function.</span>
<span class="cm">	 */</span>
	<span class="n">num_msix</span> <span class="o">=</span> <span class="n">num_controllers</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">*</span> <span class="n">SCI_NUM_MSI_X_INT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_msix</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">intx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_msix</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">SCI_NUM_MSI_X_INT</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">irq_handler_t</span> <span class="n">isr</span><span class="p">;</span>

		<span class="n">ihost</span> <span class="o">=</span> <span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">hosts</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="cm">/* odd numbered vectors are error interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">isr</span> <span class="o">=</span> <span class="n">isci_error_isr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">isr</span> <span class="o">=</span> <span class="n">isci_msix_isr</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">DRV_NAME</span><span class="s">&quot;-msix&quot;</span><span class="p">,</span> <span class="n">ihost</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;msix setup failed falling back to intx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">SCI_NUM_MSI_X_INT</span><span class="p">;</span>
			<span class="n">ihost</span> <span class="o">=</span> <span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">hosts</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
			<span class="n">msix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">devm_free_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ihost</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">intx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">intx:</span>
	<span class="n">for_each_isci_host</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ihost</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">isci_intx_isr</span><span class="p">,</span>
				       <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="s">&quot;-intx&quot;</span><span class="p">,</span> <span class="n">ihost</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_user_parameters_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_user_parameters</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sci_phy_user_params</span> <span class="o">*</span><span class="n">u_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">u_phy</span><span class="o">-&gt;</span><span class="n">max_speed_generation</span> <span class="o">=</span> <span class="n">phy_gen</span><span class="p">;</span>

		<span class="cm">/* we are not exporting these for now */</span>
		<span class="n">u_phy</span><span class="o">-&gt;</span><span class="n">align_insertion_frequency</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">u_phy</span><span class="o">-&gt;</span><span class="n">in_connection_align_insertion_frequency</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">u_phy</span><span class="o">-&gt;</span><span class="n">notify_enable_spin_up_insertion_frequency</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">u</span><span class="o">-&gt;</span><span class="n">stp_inactivity_timeout</span> <span class="o">=</span> <span class="n">stp_inactive_to</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">ssp_inactivity_timeout</span> <span class="o">=</span> <span class="n">ssp_inactive_to</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">stp_max_occupancy_timeout</span> <span class="o">=</span> <span class="n">stp_max_occ_to</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">ssp_max_occupancy_timeout</span> <span class="o">=</span> <span class="n">ssp_max_occ_to</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">no_outbound_task_timeout</span> <span class="o">=</span> <span class="n">no_outbound_task_to</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">max_concurr_spinup</span> <span class="o">=</span> <span class="n">max_concurr_spinup</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_user_parameters_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sci_user_parameters</span> <span class="o">*</span><span class="n">sci_parms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate the user parameters.  If they are not legal, then</span>
<span class="cm">	 * return a failure.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sci_phy_user_params</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>

		<span class="n">u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">max_speed_generation</span> <span class="o">&lt;=</span> <span class="n">SCIC_SDS_PARM_MAX_SPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">max_speed_generation</span> <span class="o">&gt;</span> <span class="n">SCIC_SDS_PARM_NO_SPEED</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_PARAMETER_VALUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">in_connection_align_insertion_frequency</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_PARAMETER_VALUE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">in_connection_align_insertion_frequency</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">align_insertion_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">notify_enable_spin_up_insertion_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_PARAMETER_VALUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">stp_inactivity_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">ssp_inactivity_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">stp_max_occupancy_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">ssp_max_occupancy_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sci_parms</span><span class="o">-&gt;</span><span class="n">no_outbound_task_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_PARAMETER_VALUE</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">user_parameters</span><span class="p">,</span> <span class="n">sci_parms</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sci_parms</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_oem_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* these defaults are overridden by the platform / firmware */</span>
	<span class="k">struct</span> <span class="n">sci_user_parameters</span> <span class="o">*</span><span class="n">user</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">user_parameters</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sci_oem_params</span> <span class="o">*</span><span class="n">oem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">oem_parameters</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Default to APC mode. */</span>
	<span class="n">oem</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">mode_type</span> <span class="o">=</span> <span class="n">SCIC_PORT_AUTOMATIC_CONFIGURATION_MODE</span><span class="p">;</span>

	<span class="cm">/* Default to APC mode. */</span>
	<span class="n">oem</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">max_concurr_spin_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Default to no SSC operation. */</span>
	<span class="n">oem</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">do_enable_ssc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Default to short cables on all phys. */</span>
	<span class="n">oem</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">.</span><span class="n">cable_selection_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize all of the port parameter information to narrow ports. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">oem</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize all of the phy parameter information. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Default to 3G (i.e. Gen 2). */</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_speed_generation</span> <span class="o">=</span> <span class="n">SCIC_SDS_PARM_GEN2_SPEED</span><span class="p">;</span>

		<span class="cm">/* the frequencies cannot be 0 */</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">align_insertion_frequency</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_connection_align_insertion_frequency</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">user</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">notify_enable_spin_up_insertion_frequency</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>

		<span class="cm">/* Previous Vitesse based expanders had a arbitration issue that</span>
<span class="cm">		 * is worked around by having the upper 32-bits of SAS address</span>
<span class="cm">		 * with a value greater then the Vitesse company identifier.</span>
<span class="cm">		 * Hence, usage of 0x5FCFFFFF.</span>
<span class="cm">		 */</span>
		<span class="n">oem</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sas_address</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">+</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">oem</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sas_address</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="mh">0x5FCFFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">user</span><span class="o">-&gt;</span><span class="n">stp_inactivity_timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">ssp_inactivity_timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">stp_max_occupancy_timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">ssp_max_occupancy_timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">user</span><span class="o">-&gt;</span><span class="n">no_outbound_task_timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="nf">isci_host_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_orom</span> <span class="o">*</span><span class="n">orom</span> <span class="o">=</span> <span class="n">to_pci_info</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">orom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sci_user_parameters</span> <span class="n">sci_user_params</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">oem_version</span> <span class="o">=</span> <span class="n">ISCI_ROM_VER_1_0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ihost</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ihost</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ihost</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">scic_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">eventq</span><span class="p">);</span>
	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">.</span><span class="n">lldd_ha</span> <span class="o">=</span> <span class="n">ihost</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">completion_tasklet</span><span class="p">,</span>
		     <span class="n">isci_host_completion_routine</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ihost</span><span class="p">);</span>

	<span class="cm">/* validate module parameters */</span>
	<span class="cm">/* TODO: kill struct sci_user_parameters and reference directly */</span>
	<span class="n">sci_oem_defaults</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
	<span class="n">isci_user_parameters_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sci_user_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sci_user_parameters_set</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sci_user_params</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: sci_user_parameters_set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity check platform (or &#39;firmware&#39;) oem parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">orom</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">SCI_MAX_CONTROLLERS</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="n">orom</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">num_elements</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;parsing firmware oem parameters failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">oem_parameters</span> <span class="o">=</span> <span class="n">orom</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="n">oem_version</span> <span class="o">=</span> <span class="n">orom</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* validate oem parameters (platform, firmware, or built-in defaults) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sci_oem_parameters_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">oem_parameters</span><span class="p">,</span> <span class="n">oem_version</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;oem parameter validation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isci_port</span> <span class="o">*</span><span class="n">iport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iport</span><span class="o">-&gt;</span><span class="n">remote_dev_list</span><span class="p">);</span>
		<span class="n">iport</span><span class="o">-&gt;</span><span class="n">isci_host</span> <span class="o">=</span> <span class="n">ihost</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_PHYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">isci_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ihost</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SCI_MAX_REMOTE_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">shost</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_sht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%sSCU controller %d: phy 3-0 cables: &quot;</span>
		 <span class="s">&quot;{%s, %s, %s, %s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">is_cable_select_overridden</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot;* &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		 <span class="n">lookup_cable_names</span><span class="p">(</span><span class="n">decode_cable_selection</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
		 <span class="n">lookup_cable_names</span><span class="p">(</span><span class="n">decode_cable_selection</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
		 <span class="n">lookup_cable_names</span><span class="p">(</span><span class="n">decode_cable_selection</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
		 <span class="n">lookup_cable_names</span><span class="p">(</span><span class="n">decode_cable_selection</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isci_host_init</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_shost</span><span class="p">;</span>

	<span class="n">SHOST_TO_SAS_HA</span><span class="p">(</span><span class="n">shost</span><span class="p">)</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">;</span>
	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">sas_ha</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">shost</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">isci_transport_template</span><span class="p">;</span>

	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">shost</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">MAX_COMMAND_SIZE</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_shost</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isci_register_sas_ha</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_shost_remove</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ihost</span><span class="p">;</span>

 <span class="nl">err_shost_remove:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
 <span class="nl">err_shost:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">isci_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_pci_info</span> <span class="o">*</span><span class="n">pci_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">isci_host</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_orom</span> <span class="o">*</span><span class="n">orom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;(platform)&quot;</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver configured for rev: %d silicon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>

	<span class="n">pci_info</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pci_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">efi_enabled</span><span class="p">)</span>
		<span class="n">orom</span> <span class="o">=</span> <span class="n">isci_get_efi_var</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orom</span><span class="p">)</span>
		<span class="n">orom</span> <span class="o">=</span> <span class="n">isci_request_oprom</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">orom</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_controllers</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sci_oem_parameters_validate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">orom</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">orom</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;[%d]: invalid oem parameters detected, falling back to firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">devm_kfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">orom</span><span class="p">);</span>
			<span class="n">orom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">source</span> <span class="o">=</span> <span class="s">&quot;(firmware)&quot;</span><span class="p">;</span>
		<span class="n">orom</span> <span class="o">=</span> <span class="n">isci_request_firmware</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orom</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO convert this to WARN_TAINT_ONCE once the</span>
<span class="cm">			 * orom/efi parameter support is widely available</span>
<span class="cm">			 */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Loading user firmware failed, using default &quot;</span>
				 <span class="s">&quot;values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Default OEM configuration being used: 4 &quot;</span>
				 <span class="s">&quot;narrow ports, and default SAS Addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orom</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;OEM SAS parameters (version: %u.%u) loaded %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">orom</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">orom</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">),</span> <span class="n">source</span><span class="p">);</span>

	<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">orom</span> <span class="o">=</span> <span class="n">orom</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isci_pci_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_controllers</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">isci_host_alloc</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_host_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">hosts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>

		<span class="cm">/* turn on DIF support */</span>
		<span class="n">scsi_host_set_prot</span><span class="p">(</span><span class="n">to_shost</span><span class="p">(</span><span class="n">h</span><span class="p">),</span>
				   <span class="n">SHOST_DIF_TYPE1_PROTECTION</span> <span class="o">|</span>
				   <span class="n">SHOST_DIF_TYPE2_PROTECTION</span> <span class="o">|</span>
				   <span class="n">SHOST_DIF_TYPE3_PROTECTION</span><span class="p">);</span>
		<span class="n">scsi_host_set_guard</span><span class="p">(</span><span class="n">to_shost</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="n">SHOST_DIX_GUARD_CRC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isci_setup_interrupts</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_host_alloc</span><span class="p">;</span>

	<span class="n">for_each_isci_host</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">isci_host</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span>
		<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">to_shost</span><span class="p">(</span><span class="n">isci_host</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_host_alloc:</span>
	<span class="n">for_each_isci_host</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">isci_host</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span>
		<span class="n">isci_unregister</span><span class="p">(</span><span class="n">isci_host</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">isci_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_isci_host</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ihost</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_start</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
		<span class="n">isci_unregister</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
		<span class="n">isci_host_deinit</span><span class="p">(</span><span class="n">ihost</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">isci_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">isci_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">isci_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">isci_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">isci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Intel(R) C600 SAS Controller Driver - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">isci_transport_template</span> <span class="o">=</span> <span class="n">sas_domain_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_transport_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isci_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">isci_transport_template</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">isci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isci_pci_driver</span><span class="p">);</span>
	<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">isci_transport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">ISCI_FW_NAME</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">isci_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">isci_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
