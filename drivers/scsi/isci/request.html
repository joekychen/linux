<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › isci › request.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>request.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is provided under a dual BSD/GPLv2 license.  When using or</span>
<span class="cm"> * redistributing this file, you may do so under either license.</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * BSD LICENSE</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *   * Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *   * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *     the documentation and/or other materials provided with the</span>
<span class="cm"> *     distribution.</span>
<span class="cm"> *   * Neither the name of Intel Corporation nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &quot;isci.h&quot;</span>
<span class="cp">#include &quot;task.h&quot;</span>
<span class="cp">#include &quot;request.h&quot;</span>
<span class="cp">#include &quot;scu_completion_codes.h&quot;</span>
<span class="cp">#include &quot;scu_event_codes.h&quot;</span>
<span class="cp">#include &quot;sas.h&quot;</span>

<span class="cp">#undef C</span>
<span class="cp">#define C(a) (#a)</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">req_state_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">strings</span><span class="p">[]</span> <span class="o">=</span> <span class="n">REQUEST_STATES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strings</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#undef C</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="nf">to_sgl_element_pair</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
							<span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sgl_pair_ab</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sgl_pair_cd</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">dma_addr_t</span> <span class="nf">to_sgl_element_pair_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sgl_pair_ab</span> <span class="o">-</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">task_context_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">tc_dma</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">sgl_pair_cd</span> <span class="o">-</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">task_context_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">tc_dma</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sci_io_request_get_dma_addr</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_sgl_element</span><span class="p">(</span><span class="k">struct</span> <span class="n">scu_sgl_element</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">address_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">address_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">address_modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_request_build_sgl</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="n">scu_sg</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="n">prev_sg</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scu_sg</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">sg_idx</span><span class="p">);</span>
			<span class="n">init_sgl_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">init_sgl_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
				<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">prev_sg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">to_sgl_element_pair_dma</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span>
								   <span class="n">ireq</span><span class="p">,</span>
								   <span class="n">sg_idx</span><span class="p">);</span>

				<span class="n">prev_sg</span><span class="o">-&gt;</span><span class="n">next_pair_upper</span> <span class="o">=</span>
					<span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
				<span class="n">prev_sg</span><span class="o">-&gt;</span><span class="n">next_pair_lower</span> <span class="o">=</span>
					<span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">prev_sg</span> <span class="o">=</span> <span class="n">scu_sg</span><span class="p">;</span>
			<span class="n">sg_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* handle when no sg */</span>
		<span class="n">scu_sg</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">sg_idx</span><span class="p">);</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span>
					  <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">,</span>
					  <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">);</span>

		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">zero_scatter_daddr</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">;</span>
		<span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">.</span><span class="n">address_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">.</span><span class="n">address_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scu_sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">next_pair_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scu_sg</span><span class="o">-&gt;</span><span class="n">next_pair_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_io_request_build_ssp_command_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_cmd_iu</span> <span class="o">*</span><span class="n">cmd_iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">cmd_iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">add_cdb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">_r_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">_r_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">en_fburst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unsupported */</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">task_prio</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">task_prio</span><span class="p">;</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">task_attr</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">task_attr</span><span class="p">;</span>
	<span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">_r_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_iu</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">cdb</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">cdb</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_task_request_build_ssp_task_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_task_iu</span> <span class="o">*</span><span class="n">task_iu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isci_tmf</span> <span class="o">*</span><span class="n">isci_tmf</span> <span class="o">=</span> <span class="n">isci_request_access_tmf</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">task_iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">tmf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">task_iu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_task_iu</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">task_iu</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ssp_task</span><span class="p">.</span><span class="n">LUN</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">task_iu</span><span class="o">-&gt;</span><span class="n">task_func</span> <span class="o">=</span> <span class="n">isci_tmf</span><span class="o">-&gt;</span><span class="n">tmf_code</span><span class="p">;</span>
	<span class="n">task_iu</span><span class="o">-&gt;</span><span class="n">task_tag</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">?</span>
		<span class="n">isci_tmf</span><span class="o">-&gt;</span><span class="n">io_tag</span> <span class="o">:</span>
		<span class="n">SCI_CONTROLLER_INVALID_IO_TAG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This method is will fill in the SCU Task Context for any type of SSP request.</span>
<span class="cm"> * @sci_req:</span>
<span class="cm"> * @task_context:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_ssp_reqeust_construct_task_context</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_port</span> <span class="o">*</span><span class="n">iport</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">;</span>
	<span class="n">iport</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">owning_port</span><span class="p">;</span>

	<span class="cm">/* Fill in the TC with the its required data */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">initiator_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">connection_rate</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">connection_rate</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_engine_index</span> <span class="o">=</span> <span class="n">ISCI_PEG</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">logical_port_index</span> <span class="o">=</span> <span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_VALID</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">context_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_TYPE</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">remote_node_index</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rnc</span><span class="p">.</span><span class="n">remote_node_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">link_layer_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">do_not_dma_ssp_good_response</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">strict_ordering</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">control_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">timeout_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">block_guard_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">address_modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* task_context-&gt;type.ssp.tag = ireq-&gt;io_tag; */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_phase</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">post_context</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">ISCI_PEG</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_CONTEXT_COMMAND_PROTOCOL_ENGINE_GROUP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span> <span class="o">&lt;&lt;</span>
			       <span class="n">SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the physical address for the command buffer to the</span>
<span class="cm">	 * SCU Task Context</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sci_io_request_get_dma_addr</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the physical address for the response buffer to the</span>
<span class="cm">	 * SCU Task Context</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sci_io_request_get_dma_addr</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">);</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">scu_bg_blk_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sdp</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">512</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1024</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4096</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">scu_dif_bytes</span><span class="p">(</span><span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sector_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">sector_size</span><span class="p">))</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_ssp_ireq_dif_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">io_task_ptr</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">blk_sz</span> <span class="o">=</span> <span class="n">scu_bg_blk_size</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">block_guard_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_prot_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_sz</span> <span class="o">=</span> <span class="n">blk_sz</span><span class="p">;</span>
	<span class="cm">/* DIF write insert */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_prot_func</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">+=</span> <span class="n">scu_dif_bytes</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span><span class="p">,</span>
						   <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

	<span class="cm">/* always init to 0, used by hw */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">interm_crc_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">init_crc_seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always init to same as bg_blk_sz */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">UD_bytes_immed_val</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_DC_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always init to 8 */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">DIF_bytes_immed_val</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_DC_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgc_blk_sz</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_E0_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_gen_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/** setup block guard control **/</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DIF write insert */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_verify_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* must init to 0 for hw */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_guard_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_E8_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE2</span><span class="p">))</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_gen</span> <span class="o">=</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE3</span><span class="p">)</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_ssp_ireq_dif_strip</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">io_task_ptr</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">blk_sz</span> <span class="o">=</span> <span class="n">scu_bg_blk_size</span><span class="p">(</span><span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">block_guard_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_prot_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_sz</span> <span class="o">=</span> <span class="n">blk_sz</span><span class="p">;</span>
	<span class="cm">/* DIF read strip */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_prot_func</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">+=</span> <span class="n">scu_dif_bytes</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span><span class="p">,</span>
						   <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">);</span>

	<span class="cm">/* always init to 0, used by hw */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">interm_crc_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">init_crc_seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE2</span><span class="p">))</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_verify</span> <span class="o">=</span> <span class="n">scsi_get_lba</span><span class="p">(</span><span class="n">scmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE3</span><span class="p">)</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_verify</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always init to same as bg_blk_sz */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">UD_bytes_immed_val</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_DC_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always init to 8 */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">DIF_bytes_immed_val</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_DC_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgc_blk_sz</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">sector_size</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_E0_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_gen_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/** setup block guard control **/</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DIF read strip */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">crc_verify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">ref_tag_chk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">app_f_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCSI_PROT_DIF_TYPE3</span><span class="p">)</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">bgctl_f</span><span class="p">.</span><span class="n">app_ref_f_detect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">app_tag_verify_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* must init to 0 for hw */</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">blk_guard_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">reserved_E8_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">ref_tag_seed_gen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This method is will fill in the SCU Task Context for a SSP IO request.</span>
<span class="cm"> * @sci_req:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_ssp_io_request_construct_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						      <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
						      <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">sas_task</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">io_task_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">sas_task</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prot_type</span> <span class="o">=</span> <span class="n">scsi_get_prot_type</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">prot_op</span> <span class="o">=</span> <span class="n">scsi_get_prot_op</span><span class="p">(</span><span class="n">scmd</span><span class="p">);</span>

	<span class="n">scu_ssp_reqeust_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">task_context</span><span class="p">);</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">ssp_command_iu_length</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_cmd_iu</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ssp</span><span class="p">.</span><span class="n">frame_type</span> <span class="o">=</span> <span class="n">SSP_COMMAND</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DMA_FROM_DEVICE</span>:
	<span class="k">case</span> <span class="n">DMA_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">SCU_TASK_TYPE_IOREAD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DMA_TO_DEVICE</span>:
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">SCU_TASK_TYPE_IOWRITE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sci_request_build_sgl</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prot_type</span> <span class="o">!=</span> <span class="n">SCSI_PROT_DIF_TYPE0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prot_op</span> <span class="o">==</span> <span class="n">SCSI_PROT_READ_STRIP</span><span class="p">)</span>
			<span class="n">scu_ssp_ireq_dif_strip</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">prot_type</span><span class="p">,</span> <span class="n">prot_op</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prot_op</span> <span class="o">==</span> <span class="n">SCSI_PROT_WRITE_INSERT</span><span class="p">)</span>
			<span class="n">scu_ssp_ireq_dif_insert</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">prot_type</span><span class="p">,</span> <span class="n">prot_op</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This method will fill in the SCU Task Context for a SSP Task request.  The</span>
<span class="cm"> *    following important settings are utilized: -# priority ==</span>
<span class="cm"> *    SCU_TASK_PRIORITY_HIGH.  This ensures that the task request is issued</span>
<span class="cm"> *    ahead of other task destined for the same Remote Node. -# task_type ==</span>
<span class="cm"> *    SCU_TASK_TYPE_IOREAD.  This simply indicates that a normal request type</span>
<span class="cm"> *    (i.e. non-raw frame) is being utilized to perform task management. -#</span>
<span class="cm"> *    control_frame == 1.  This ensures that the proper endianess is set so</span>
<span class="cm"> *    that the bytes are transmitted in the right order for a task frame.</span>
<span class="cm"> * @sci_req: This parameter specifies the task request object being</span>
<span class="cm"> *    constructed.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_ssp_task_request_construct_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>

	<span class="n">scu_ssp_reqeust_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">task_context</span><span class="p">);</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">control_frame</span>                <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">priority</span>                     <span class="o">=</span> <span class="n">SCU_TASK_PRIORITY_HIGH</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span>                    <span class="o">=</span> <span class="n">SCU_TASK_TYPE_RAW_FRAME</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ssp</span><span class="p">.</span><span class="n">frame_type</span>          <span class="o">=</span> <span class="n">SSP_TASK</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">ssp_command_iu_length</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_task_iu</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This method is will fill in the SCU Task Context for any type of SATA</span>
<span class="cm"> *    request.  This is called from the various SATA constructors.</span>
<span class="cm"> * @sci_req: The general IO request object which is to be used in</span>
<span class="cm"> *    constructing the SCU task context.</span>
<span class="cm"> * @task_context: The buffer pointer for the SCU task context which is being</span>
<span class="cm"> *    constructed.</span>
<span class="cm"> *</span>
<span class="cm"> * The general io request construction is complete. The buffer assignment for</span>
<span class="cm"> * the command buffer is complete. none Revisit task context construction to</span>
<span class="cm"> * determine what is common for SSP/SMP/STP task context structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_sata_reqeust_construct_task_context</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_port</span> <span class="o">*</span><span class="n">iport</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">;</span>
	<span class="n">iport</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">owning_port</span><span class="p">;</span>

	<span class="cm">/* Fill in the TC with the its required data */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">SCU_TASK_PRIORITY_NORMAL</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">initiator_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">connection_rate</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">connection_rate</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_engine_index</span> <span class="o">=</span> <span class="n">ISCI_PEG</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">logical_port_index</span> <span class="o">=</span> <span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_STP</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_VALID</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">context_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_TYPE</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">remote_node_index</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rnc</span><span class="p">.</span><span class="n">remote_node_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">link_layer_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">do_not_dma_ssp_good_response</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">strict_ordering</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">control_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">timeout_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">block_guard_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">address_modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_phase</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">ssp_command_iu_length</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_to_dev_fis</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* Set the first word of the H2D REG FIS */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">post_context</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">ISCI_PEG</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_CONTEXT_COMMAND_PROTOCOL_ENGINE_GROUP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span> <span class="o">&lt;&lt;</span>
			       <span class="n">SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy the physical address for the command buffer to the SCU Task</span>
<span class="cm">	 * Context. We must offset the command buffer by 4 bytes because the</span>
<span class="cm">	 * first 4 bytes are transfered in the body of the TC.</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sci_io_request_get_dma_addr</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="cm">/* SATA Requests do not have a response buffer */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_stp_raw_request_construct_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>

	<span class="n">scu_sata_reqeust_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">task_context</span><span class="p">);</span>

	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">control_frame</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">priority</span>              <span class="o">=</span> <span class="n">SCU_TASK_PRIORITY_NORMAL</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span>             <span class="o">=</span> <span class="n">SCU_TASK_TYPE_SATA_RAW_FRAME</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">.</span><span class="n">fis_type</span>     <span class="o">=</span> <span class="n">FIS_REGH2D</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_to_dev_fis</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_stp_pio_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
							  <span class="n">bool</span> <span class="n">copy_rx_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">;</span>

	<span class="n">scu_stp_raw_request_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">SCU_SGL_ELEMENT_PAIR_A</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_rx_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sci_request_build_sgl</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The user does not want the data copied to the SGL buffer location */</span>
		<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * @sci_req: This parameter specifies the request to be constructed as an</span>
<span class="cm"> *    optimized request.</span>
<span class="cm"> * @optimized_task_type: This parameter specifies whether the request is to be</span>
<span class="cm"> *    an UDMA request or a NCQ request. - A value of 0 indicates UDMA. - A</span>
<span class="cm"> *    value of 1 indicates NCQ.</span>
<span class="cm"> *</span>
<span class="cm"> * This method will perform request construction common to all types of STP</span>
<span class="cm"> * requests that are optimized by the silicon (i.e. UDMA, NCQ). This method</span>
<span class="cm"> * returns an indication as to whether the construction was successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_stp_optimized_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						     <span class="n">u8</span> <span class="n">optimized_task_type</span><span class="p">,</span>
						     <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
						     <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>

	<span class="cm">/* Build the STP task context structure */</span>
	<span class="n">scu_sata_reqeust_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">task_context</span><span class="p">);</span>

	<span class="cm">/* Copy over the SGL elements */</span>
	<span class="n">sci_request_build_sgl</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="cm">/* Copy over the number of bytes to be transfered */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The difference between the DMA IN and DMA OUT request task type</span>
<span class="cm">		 * values are consistent with the difference between FPDMA READ</span>
<span class="cm">		 * and FPDMA WRITE values.  Add the supplied task type parameter</span>
<span class="cm">		 * to this difference to set the task type properly for this</span>
<span class="cm">		 * DATA OUT (WRITE) case. */</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">optimized_task_type</span> <span class="o">+</span> <span class="p">(</span><span class="n">SCU_TASK_TYPE_DMA_OUT</span>
								 <span class="o">-</span> <span class="n">SCU_TASK_TYPE_DMA_IN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For the DATA IN (READ) case, simply save the supplied</span>
<span class="cm">		 * optimized task type. */</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">optimized_task_type</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_atapi_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_to_dev_fis</span> <span class="o">*</span><span class="n">h2d_fis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="cm">/* To simplify the implementation we take advantage of the</span>
<span class="cm">	 * silicon&#39;s partial acceleration of atapi protocol (dma data</span>
<span class="cm">	 * transfers), so we promote all commands to dma protocol.  This</span>
<span class="cm">	 * breaks compatibility with ATA_HORKAGE_ATAPI_MOD16_DMA drives.</span>
<span class="cm">	 */</span>
	<span class="n">h2d_fis</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ATAPI_PKT_DMA</span><span class="p">;</span>

	<span class="n">scu_stp_raw_request_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear the response so we can detect arrivial of an</span>
<span class="cm">	 * unsolicited h2d fis</span>
<span class="cm">	 */</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">fis_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_construct_sata</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">copy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">;</span>

	<span class="cm">/* check for management protocols */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isci_tmf</span> <span class="o">*</span><span class="n">tmf</span> <span class="o">=</span> <span class="n">isci_request_access_tmf</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Request 0x%p received un-handled SAT &quot;</span>
			<span class="s">&quot;management protocol 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span> <span class="n">tmf</span><span class="o">-&gt;</span><span class="n">tmf_code</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_protocol_ata</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Non-ATA protocol in SATA path: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* ATAPI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sata_dev</span><span class="p">.</span><span class="n">command_set</span> <span class="o">==</span> <span class="n">ATAPI_COMMAND_SET</span> <span class="o">&amp;&amp;</span>
	    <span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">fis</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sci_atapi_construct</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* non data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scu_stp_raw_request_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NCQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">use_ncq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sci_stp_optimized_request_construct</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
							 <span class="n">SCU_TASK_TYPE_FPDMAQ_READ</span><span class="p">,</span>
							 <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">dma_xfer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sci_stp_optimized_request_construct</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
							 <span class="n">SCU_TASK_TYPE_DMA_IN</span><span class="p">,</span>
							 <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* PIO */</span>
		<span class="k">return</span> <span class="n">sci_stp_pio_request_construct</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_io_request_construct_basic_ssp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>

	<span class="n">scu_ssp_io_request_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						  <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">,</span>
						  <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">);</span>

	<span class="n">sci_io_request_build_ssp_command_iu</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_task_request_construct_ssp</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Construct the SSP Task SCU Task Context */</span>
	<span class="n">scu_ssp_task_request_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="cm">/* Fill in the SSP Task IU */</span>
	<span class="n">sci_task_request_build_ssp_task_iu</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_io_request_construct_basic_sata</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">copy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>

	<span class="n">copy</span> <span class="o">=</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_io_request_construct_sata</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						<span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">,</span>
						<span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">,</span>
						<span class="n">copy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sci_req_tx_bytes - bytes transferred when reply underruns request</span>
<span class="cm"> * @ireq: request that was terminated early</span>
<span class="cm"> */</span>
<span class="cp">#define SCU_TASK_CONTEXT_SRAM 0x200000</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">sci_req_tx_bytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">smu_registers</span><span class="o">-&gt;</span><span class="n">address_modifier</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scu_reg_base</span> <span class="o">=</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">scu_registers</span><span class="p">;</span>

		<span class="cm">/* get the bytes of data from the Address == BAR1 + 20002Ch + (256*TCi) where</span>
<span class="cm">		 *   BAR1 is the scu_registers</span>
<span class="cm">		 *   0x20002C = 0x200000 + 0x2c</span>
<span class="cm">		 *            = start of task context SRAM + offset of (type.ssp.data_offset)</span>
<span class="cm">		 *   TCi is the io_tag of struct sci_request</span>
<span class="cm">		 */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">scu_reg_base</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">SCU_TASK_CONTEXT_SRAM</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scu_task_context</span><span class="p">,</span> <span class="n">type</span><span class="p">.</span><span class="n">ssp</span><span class="p">.</span><span class="n">data_offset</span><span class="p">))</span> <span class="o">+</span>
				<span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scu_task_context</span><span class="p">))</span> <span class="o">*</span> <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_request_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: SCIC IO Request requested to start while in wrong &quot;</span>
			 <span class="s">&quot;state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tc</span><span class="o">-&gt;</span><span class="n">task_index</span> <span class="o">=</span> <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">protocol_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_SMP</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_SSP</span>:
		<span class="cm">/* SSP/SMP Frame */</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ssp</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">ssp</span><span class="p">.</span><span class="n">target_port_transfer_tag</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_STP</span>:
		<span class="cm">/* STP/SATA Frame</span>
<span class="cm">		 * tc-&gt;type.stp.ncq_tag = ireq-&gt;ncq_tag;</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_NONE</span>:
		<span class="cm">/* / @todo When do we set no protocol type? */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* This should never happen since we build the IO</span>
<span class="cm">		 * requests */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add to the post_context the io tag value */</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">post_context</span> <span class="o">|=</span> <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">);</span>

	<span class="cm">/* Everything is good go ahead and change state */</span>
	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STARTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCI_REQ_CONSTRUCTED</span>:
		<span class="cm">/* Set to make sure no HW terminate posting is done: */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_TC_ABORT_POSTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_TASK_ABORT</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_TERMINATED</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCI_REQ_STARTED</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_TASK_WAIT_TC_COMP</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_SMP_WAIT_RESP</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_SMP_WAIT_TC_COMP</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_TC_COMP</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_D2H</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_H2D</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_D2H</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_WAIT_H2D</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_DATA_IN</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_DATA_OUT</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_H2D</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_PIO_SETUP</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span>:
	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_TC_COMP</span>:
		<span class="cm">/* Fall through and change state to ABORTING... */</span>
	<span class="k">case</span> <span class="n">SCI_REQ_TASK_WAIT_TC_RESP</span>:
		<span class="cm">/* The task frame was already confirmed to have been</span>
<span class="cm">		 * sent by the SCU HW.  Since the state machine is</span>
<span class="cm">		 * now only waiting for the task response itself,</span>
<span class="cm">		 * abort the request and complete it immediately</span>
<span class="cm">		 * and don&#39;t wait for the task response.</span>
<span class="cm">		 */</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_ABORTING</span><span class="p">);</span>
		<span class="cm">/* Fall through and handle like ABORTING... */</span>
	<span class="k">case</span> <span class="n">SCI_REQ_ABORTING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isci_remote_device_is_safe_to_abort</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_PENDING_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_PENDING_ABORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* If the request is only waiting on the remote device</span>
<span class="cm">		 * suspension, return SUCCESS so the caller will wait too.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCI_REQ_COMPLETED</span>:
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: SCIC IO Request requested to abort while in wrong &quot;</span>
			 <span class="s">&quot;state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_request_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">,</span>
		      <span class="s">&quot;isci: request completion from wrong state (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">req_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">saved_rx_frame_index</span> <span class="o">!=</span> <span class="n">SCU_INVALID_FRAME_INDEX</span><span class="p">)</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span>
						  <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">saved_rx_frame_index</span><span class="p">);</span>

	<span class="cm">/* XXX can we just stop the machine and remove the &#39;final&#39; state? */</span>
	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_FINAL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_io_request_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						  <span class="n">u32</span> <span class="n">event_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">SCI_REQ_STP_PIO_DATA_IN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: (%x) in wrong state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">event_code</span><span class="p">,</span> <span class="n">req_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scu_get_event_specifier</span><span class="p">(</span><span class="n">event_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_CRC_ERR</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_EVENT_SPECIFIC_CODE_SHIFT</span>:
		<span class="cm">/* We are waiting for data and the SCU has R_ERR the data frame.</span>
<span class="cm">		 * Go back to waiting for the D2H Register FIS</span>
<span class="cm">		 */</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: pio request unexpected event %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">event_code</span><span class="p">);</span>

		<span class="cm">/* TODO Should we fail the PIO request when we get an</span>
<span class="cm">		 * unexpected event?</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function copies response data for requests returning response data</span>
<span class="cm"> *    instead of sense data.</span>
<span class="cm"> * @sci_req: This parameter specifies the request object for which to copy</span>
<span class="cm"> *    the response data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_io_request_copy_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">resp_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">ssp_response</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_tmf</span> <span class="o">*</span><span class="n">isci_tmf</span> <span class="o">=</span> <span class="n">isci_request_access_tmf</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="n">ssp_response</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

	<span class="n">resp_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isci_tmf</span><span class="o">-&gt;</span><span class="n">resp</span><span class="p">.</span><span class="n">resp_iu</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span>
		    <span class="n">SSP_RESP_IU_MAX_SIZE</span><span class="p">,</span>
		    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ssp_response</span><span class="o">-&gt;</span><span class="n">response_data_len</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp_buf</span><span class="p">,</span> <span class="n">ssp_response</span><span class="o">-&gt;</span><span class="n">resp_data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">request_started_state_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">resp_iu</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">datapres</span><span class="p">;</span>

	<span class="cm">/* TODO: Any SDMA return code of other than 0 is bad decode 0x003C0000</span>
<span class="cm">	 * to determine SDMA status</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_EARLY_RESP</span><span class="p">)</span>: <span class="p">{</span>
		<span class="cm">/* There are times when the SCU hardware will return an early</span>
<span class="cm">		 * response because the io request specified more data than is</span>
<span class="cm">		 * returned by the target device (mode pages, inquiry data,</span>
<span class="cm">		 * etc.).  We must check the response stats to see if this is</span>
<span class="cm">		 * truly a failed request or a good request that just got</span>
<span class="cm">		 * completed early.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
		<span class="kt">ssize_t</span> <span class="n">word_cnt</span> <span class="o">=</span> <span class="n">SSP_RESP_IU_MAX_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
			       <span class="n">word_cnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS_IO_DONE_EARLY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">)</span>: <span class="p">{</span>
		<span class="kt">ssize_t</span> <span class="n">word_cnt</span> <span class="o">=</span> <span class="n">SSP_RESP_IU_MAX_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
			       <span class="n">word_cnt</span><span class="p">);</span>

		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_RESP_LEN_ERR</span><span class="p">)</span>:
		<span class="cm">/* TODO With TASK_DONE_RESP_LEN_ERR is the response frame</span>
<span class="cm">		 * guaranteed to be received before this completion status is</span>
<span class="cm">		 * posted?</span>
<span class="cm">		 */</span>
		<span class="n">resp_iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
		<span class="n">datapres</span> <span class="o">=</span> <span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">datapres</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">datapres</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">datapres</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* only stp device gets suspended. */</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_ACK_NAK_TO</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_LL_PERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_NAK_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_DATA_LEN_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_LL_ABORT_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_XR_WD_LEN</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_MAX_PLD_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_RESP</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_SDBFIS</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_REG_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SDB_ERR</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					   <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					   <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* both stp/ssp device gets suspended */</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_LF_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_WRONG_DESTINATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_1</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_3</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_BAD_DESTINATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_ZONE_VIOLATION</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_STP_RESOURCES_BUSY</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_PROTOCOL_NOT_SUPPORTED</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_OPEN_REJECT_CONNECTION_RATE_NOT_SUPPORTED</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* neither ssp nor stp gets suspended. */</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_NAK_CMD_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_XR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_XR_IU_LEN_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SDMA_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_OFFSET_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_EXCESS_DATA</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_RESP_TO_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_UFI_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_FRM_TYPE_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_LL_RX_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_DATA</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_OPEN_FAIL</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_VIIT_ENTRY_NV</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_IIT_ENTRY_NV</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_RNCNV_OUTBOUND</span><span class="p">)</span>:
	<span class="nl">default:</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: This is probably wrong for ACK/NAK timeout conditions</span>
<span class="cm">	 */</span>

	<span class="cm">/* In all cases we will treat this as the completion of the IO req. */</span>
	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">request_aborting_state_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">SCU_TASK_DONE_TASK_ABORT</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_TASK_ABORT</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_TERMINATED</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Unless we get some strange error wait for the task abort to complete</span>
<span class="cm">		 * TODO: Should there be a state change for this completion?</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">ssp_task_request_await_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						       <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_TASK_WAIT_TC_RESP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_ACK_NAK_TO</span><span class="p">)</span>:
		<span class="cm">/* Currently, the decision is to simply allow the task request</span>
<span class="cm">		 * to timeout if the task IU wasn&#39;t received successfully.</span>
<span class="cm">		 * There is a potential for receiving multiple task responses if</span>
<span class="cm">		 * we decide to send the task IU again.</span>
<span class="cm">		 */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: TaskRequest:0x%p CompletionCode:%x - &quot;</span>
			 <span class="s">&quot;ACK/NAK timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span>
			 <span class="n">completion_code</span><span class="p">);</span>

		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_TASK_WAIT_TC_RESP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * All other completion status cause the IO to be complete.</span>
<span class="cm">		 * If a NAK was received, then it is up to the user to retry</span>
<span class="cm">		 * the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">smp_request_await_response_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="cm">/* In the AWAIT RESPONSE state, any TC completion is</span>
<span class="cm">		 * unexpected.  but if the TC has success status, we</span>
<span class="cm">		 * complete the IO anyway.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_RESP_TO_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_UFI_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_FRM_TYPE_ERR</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_SMP_LL_RX_ERR</span><span class="p">)</span>:
		<span class="cm">/* These status has been seen in a specific LSI</span>
<span class="cm">		 * expander, which sometimes is not able to send smp</span>
<span class="cm">		 * response within 2 ms. This causes our hardware break</span>
<span class="cm">		 * the connection and set TC completion with one of</span>
<span class="cm">		 * these SMP_XXX_XX_ERR status. For these type of error,</span>
<span class="cm">		 * we ask ihost user to retry the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_SMP_RESP_TO_ERR</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_RETRY_REQUIRED</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be complete.  If a NAK</span>
<span class="cm">		 * was received, then it is up to the user to retry the request</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">smp_request_await_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be</span>
<span class="cm">		 * complete.  If a NAK was received, then it is up to</span>
<span class="cm">		 * the user to retry the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scu_sgl_element</span> <span class="o">*</span><span class="nf">pio_sgl_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="n">sgl_pair</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">to_ireq</span><span class="p">(</span><span class="n">stp_req</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isci_stp_pio_sgl</span> <span class="o">*</span><span class="n">pio_sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">;</span>

	<span class="n">sgl_pair</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sgl_pair</span><span class="p">)</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">==</span> <span class="n">SCU_SGL_ELEMENT_PAIR_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">.</span><span class="n">address_lower</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">.</span><span class="n">address_upper</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sgl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">SCU_SGL_ELEMENT_PAIR_B</span><span class="p">;</span>
			<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">next_pair_lower</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">next_pair_upper</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sgl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">SCU_SGL_ELEMENT_PAIR_A</span><span class="p">;</span>
			<span class="n">sgl_pair</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">pio_sgl</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sgl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">stp_request_non_data_await_h2d_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_D2H</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be</span>
<span class="cm">		 * complete.  If a NAK was received, then it is up to</span>
<span class="cm">		 * the user to retry the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCU_MAX_FRAME_BUFFER_SIZE  0x400  </span><span class="cm">/* 1K is the maximum SCU frame data payload */</span><span class="cp"></span>

<span class="cm">/* transmit DATA_FIS from (current sgl + offset) for input</span>
<span class="cm"> * parameter length. current sgl and offset is alreay stored in the IO request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_stp_request_pio_data_out_trasmit_data_frame</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="n">sgl_pair</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element</span> <span class="o">*</span><span class="n">current_sgl</span><span class="p">;</span>

	<span class="cm">/* Recycle the TC and reconstruct it for sending out DATA FIS containing</span>
<span class="cm">	 * for the data from current_sgl+offset for the input length</span>
<span class="cm">	 */</span>
	<span class="n">sgl_pair</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">set</span> <span class="o">==</span> <span class="n">SCU_SGL_ELEMENT_PAIR_A</span><span class="p">)</span>
		<span class="n">current_sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">current_sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">;</span>

	<span class="cm">/* update the TC */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_upper</span> <span class="o">=</span> <span class="n">current_sgl</span><span class="o">-&gt;</span><span class="n">address_upper</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_lower</span> <span class="o">=</span> <span class="n">current_sgl</span><span class="o">-&gt;</span><span class="n">address_lower</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">.</span><span class="n">fis_type</span> <span class="o">=</span> <span class="n">FIS_DATA</span><span class="p">;</span>

	<span class="cm">/* send the new TC out. */</span>
	<span class="k">return</span> <span class="n">sci_controller_continue_io</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_stp_request_pio_data_out_transmit_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element_pair</span> <span class="o">*</span><span class="n">sgl_pair</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_sgl_element</span> <span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">sgl_pair</span> <span class="o">=</span> <span class="n">to_sgl_element_pair</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">sgl_pair</span><span class="p">,</span> <span class="s">&quot;%s: null sgl element&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">set</span> <span class="o">==</span> <span class="n">SCU_SGL_ELEMENT_PAIR_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sgl_pair</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_out_trasmit_data_frame</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* update the current sgl, offset and save for future */</span>
		<span class="n">sgl</span> <span class="o">=</span> <span class="n">pio_sgl_next</span><span class="p">(</span><span class="n">stp_req</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sci_stp_request_pio_data_out_trasmit_data_frame</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span><span class="p">);</span>

		<span class="cm">/* Sgl offset will be adjusted and saved for future */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span><span class="p">;</span>
		<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">address_lower</span> <span class="o">+=</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span><span class="p">;</span>
		<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * @stp_request: The request that is used for the SGL processing.</span>
<span class="cm"> * @data_buffer: The buffer of data to be copied.</span>
<span class="cm"> * @length: The length of the data transfer.</span>
<span class="cm"> *</span>
<span class="cm"> * Copy the data from the buffer for the length specified to the IO reqeust SGL</span>
<span class="cm"> * specified data region. enum sci_status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_stp_request_pio_data_in_copy_data_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copy_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">ireq</span> <span class="o">=</span> <span class="n">to_ireq</span><span class="p">(</span><span class="n">stp_req</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="n">src_addr</span> <span class="o">=</span> <span class="n">data_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">total_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

			<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">kaddr</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
			<span class="n">total_len</span> <span class="o">-=</span> <span class="n">copy_len</span><span class="p">;</span>
			<span class="n">src_addr</span> <span class="o">+=</span> <span class="n">copy_len</span><span class="p">;</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span> <span class="o">&lt;</span> <span class="n">total_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * @sci_req: The PIO DATA IN request that is to receive the data.</span>
<span class="cm"> * @data_buffer: The buffer to copy from.</span>
<span class="cm"> *</span>
<span class="cm"> * Copy the data buffer to the io request data region. enum sci_status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_stp_request_pio_data_in_copy_data</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is less than 1K remaining in the transfer request</span>
<span class="cm">	 * copy just the data for the transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">&lt;</span> <span class="n">SCU_MAX_FRAME_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_in_copy_data_buffer</span><span class="p">(</span>
			<span class="n">stp_req</span><span class="p">,</span> <span class="n">data_buffer</span><span class="p">,</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
			<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We are transfering the whole frame so copy */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_in_copy_data_buffer</span><span class="p">(</span>
			<span class="n">stp_req</span><span class="p">,</span> <span class="n">data_buffer</span><span class="p">,</span> <span class="n">SCU_MAX_FRAME_BUFFER_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
			<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">-=</span> <span class="n">SCU_MAX_FRAME_BUFFER_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">stp_request_pio_await_h2d_completion_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be</span>
<span class="cm">		 * complete.  If a NAK was received, then it is up to</span>
<span class="cm">		 * the user to retry the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">pio_data_out_tx_done_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">all_frames_transferred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="cm">/* Transmit data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_out_transmit_data</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">all_frames_transferred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * this will happen if the all data is written at the</span>
<span class="cm">			 * first time after the pio setup fis is received</span>
<span class="cm">			 */</span>
			<span class="n">all_frames_transferred</span>  <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* all data transferred. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">all_frames_transferred</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Change the state to SCI_REQ_STP_PIO_DATA_IN</span>
<span class="cm">			 * and wait for PIO_SETUP fis / or D2H REg fis. */</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * All other completion status cause the IO to be complete.</span>
<span class="cm">		 * If a NAK was received, then it is up to the user to retry</span>
<span class="cm">		 * the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_stp_request_udma_general_frame_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
								       <span class="n">u32</span> <span class="n">frame_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">frame_buffer</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
							       <span class="n">frame_index</span><span class="p">,</span>
							       <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">==</span> <span class="n">FIS_REGD2H</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
							      <span class="n">frame_index</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

		<span class="n">sci_controller_copy_sata_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
						       <span class="n">frame_header</span><span class="p">,</span>
						       <span class="n">frame_buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">process_unsolicited_fis</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">frame_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">frame_buffer</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
							  <span class="n">frame_index</span><span class="p">,</span>
							  <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">!=</span> <span class="n">FIS_REGD2H</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s ERROR: invalid fis type 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
						 <span class="n">frame_index</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

	<span class="n">sci_controller_copy_sata_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">frame_header</span><span class="p">,</span>
					  <span class="n">frame_buffer</span><span class="p">);</span>

	<span class="cm">/* Frame has been decoded return it to the controller */</span>
	<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">atapi_d2h_reg_frame_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						   <span class="n">u32</span> <span class="n">frame_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">process_unsolicited_fis</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SCI_IO_FAILURE_RESPONSE_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCI_IO_FAILURE_RESPONSE_VALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the d2h ufi is the end of non-data commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_atapi_reconstruct_raw_frame_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sas_to_ata_dev</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">atapi_cdb</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">io_task_ptr</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">atapi_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>

	<span class="cm">/* fill in the SCU Task Context for a DATA fis containing CDB in Raw Frame</span>
<span class="cm">	 * type. The TC for previous Packet fis was already there, we only need to</span>
<span class="cm">	 * change the H2D fis content.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_to_dev_fis</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)),</span> <span class="n">atapi_cdb</span><span class="p">,</span> <span class="n">ATAPI_CDB_LEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stp_task_context</span><span class="p">));</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">.</span><span class="n">fis_type</span> <span class="o">=</span> <span class="n">FIS_DATA</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdb_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scu_atapi_construct_task_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sas_to_ata_dev</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cdb_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdb_len</span><span class="p">;</span>

	<span class="cm">/* reference: SSTL 1.13.4.2</span>
<span class="cm">	 * task_type, sata_direction</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">SCU_TASK_TYPE_PACKET_DMA_OUT</span><span class="p">;</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">sata_direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* todo: for NO_DATA command, we need to send out raw frame. */</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">SCU_TASK_TYPE_PACKET_DMA_IN</span><span class="p">;</span>
		<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">sata_direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">));</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">.</span><span class="n">fis_type</span> <span class="o">=</span> <span class="n">FIS_DATA</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">lbal</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">atapi_packet</span><span class="p">,</span> <span class="n">cdb_len</span><span class="p">);</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">ssp_command_iu_length</span> <span class="o">=</span> <span class="n">cdb_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* task phase is set to TX_CMD */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_phase</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* retry counter */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">stp_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* data transfer size. */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">;</span>

	<span class="cm">/* setup sgl */</span>
	<span class="n">sci_request_build_sgl</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_frame_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">frame_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_stp_request</span> <span class="o">*</span><span class="n">stp_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">word_cnt</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCI_REQ_STARTED</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ssp_frame_hdr</span> <span class="n">ssp_hdr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>

		<span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
							      <span class="n">frame_index</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

		<span class="n">word_cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssp_frame_hdr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssp_hdr</span><span class="p">,</span> <span class="n">frame_header</span><span class="p">,</span> <span class="n">word_cnt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssp_hdr</span><span class="p">.</span><span class="n">frame_type</span> <span class="o">==</span> <span class="n">SSP_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">resp_iu</span><span class="p">;</span>
			<span class="kt">ssize_t</span> <span class="n">word_cnt</span> <span class="o">=</span> <span class="n">SSP_RESP_IU_MAX_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								      <span class="n">frame_index</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">resp_iu</span><span class="p">);</span>

			<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span> <span class="n">resp_iu</span><span class="p">,</span> <span class="n">word_cnt</span><span class="p">);</span>

			<span class="n">resp_iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">datapres</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">||</span>
			    <span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">datapres</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
				<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
				<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* not a response frame, why did it get forwarded? */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC IO Request 0x%p received unexpected &quot;</span>
				<span class="s">&quot;frame %d type 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span>
				<span class="n">frame_index</span><span class="p">,</span> <span class="n">ssp_hdr</span><span class="p">.</span><span class="n">frame_type</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * In any case we are done with this frame buffer return it to</span>
<span class="cm">		 * the controller</span>
<span class="cm">		 */</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCI_REQ_TASK_WAIT_TC_RESP</span>:
		<span class="n">sci_io_request_copy_response</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_REQ_SMP_WAIT_RESP</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_resp</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">,</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">rsp</span><span class="p">;</span>

		<span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
							 <span class="n">frame_index</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>
		<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">rsp</span> <span class="o">=</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">frame_header</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SMP_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">smp_resp</span><span class="p">;</span>

			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								 <span class="n">frame_index</span><span class="p">,</span>
								 <span class="o">&amp;</span><span class="n">smp_resp</span><span class="p">);</span>

			<span class="n">word_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">word_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">word_cnt</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">word_cnt</span><span class="p">,</span>
						 <span class="n">SCU_UNSOLICITED_FRAME_BUFFER_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="n">rsp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">smp_resp</span><span class="p">,</span> <span class="n">word_cnt</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_SMP_WAIT_TC_COMP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This was not a response frame why did it get</span>
<span class="cm">			 * forwarded?</span>
<span class="cm">			 */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC SMP Request 0x%p received unexpected &quot;</span>
				<span class="s">&quot;frame %d type 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">ireq</span><span class="p">,</span>
				<span class="n">frame_index</span><span class="p">,</span>
				<span class="n">rsp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_SMP_FRM_TYPE_ERR</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>

		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_TC_COMP</span>:
		<span class="k">return</span> <span class="n">sci_stp_request_udma_general_frame_handler</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
								       <span class="n">frame_index</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_D2H</span>:
		<span class="cm">/* Use the general frame handler to copy the resposne data */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_udma_general_frame_handler</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_D2H</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">frame_buffer</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								       <span class="n">frame_index</span><span class="p">,</span>
								       <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC IO Request 0x%p could not get frame &quot;</span>
				<span class="s">&quot;header for frame index %d, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">stp_req</span><span class="p">,</span>
				<span class="n">frame_index</span><span class="p">,</span>
				<span class="n">status</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIS_REGD2H</span>:
			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								      <span class="n">frame_index</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

			<span class="n">sci_controller_copy_sata_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
							       <span class="n">frame_header</span><span class="p">,</span>
							       <span class="n">frame_buffer</span><span class="p">);</span>

			<span class="cm">/* The command has completed with error */</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;%s: IO Request:0x%p Frame Id:%d protocol &quot;</span>
				  <span class="s">&quot;violation occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">stp_req</span><span class="p">,</span>
				  <span class="n">frame_index</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_UNEXP_FIS</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_PROTOCOL_VIOLATION</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>

		<span class="cm">/* Frame has been decoded return it to the controller */</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">frame_buffer</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								       <span class="n">frame_index</span><span class="p">,</span>
								       <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC IO Request 0x%p could not get frame &quot;</span>
				<span class="s">&quot;header for frame index %d, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">stp_req</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIS_PIO_SETUP</span>:
			<span class="cm">/* Get from the frame buffer the PIO Setup Data */</span>
			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								      <span class="n">frame_index</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

			<span class="cm">/* Get the data from the PIO Setup The SCU Hardware</span>
<span class="cm">			 * returns first word in the frame_header and the rest</span>
<span class="cm">			 * of the data is in the frame buffer so we need to</span>
<span class="cm">			 * back up one dword</span>
<span class="cm">			 */</span>

			<span class="cm">/* transfer_count: first 16bits in the 4th dword */</span>
			<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">=</span> <span class="n">frame_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="cm">/* status: 4th byte in the 3rd dword */</span>
			<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="n">sci_controller_copy_sata_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span>
							       <span class="n">frame_header</span><span class="p">,</span>
							       <span class="n">frame_buffer</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

			<span class="cm">/* The next state is dependent on whether the</span>
<span class="cm">			 * request was PIO Data-in or Data out</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_DATA_IN</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Transmit data */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_out_transmit_data</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_DATA_OUT</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FIS_SETDEVBITS</span>:
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FIS_REGD2H</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Now why is the drive sending a D2H Register</span>
<span class="cm">				 * FIS when it is still busy?  Do nothing since</span>
<span class="cm">				 * we are still in the right state.</span>
<span class="cm">				 */</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: SCIC PIO Request 0x%p received &quot;</span>
					<span class="s">&quot;D2H Register FIS with BSY status &quot;</span>
					<span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span>
					<span class="n">stp_req</span><span class="p">,</span>
					<span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								      <span class="n">frame_index</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

			<span class="n">sci_controller_copy_sata_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">req</span><span class="p">,</span>
							       <span class="n">frame_header</span><span class="p">,</span>
							       <span class="n">frame_buffer</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* FIXME: what do we do here? */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Frame is decoded return it to the controller */</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_DATA_IN</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">frame_header</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sata_fis_data</span> <span class="o">*</span><span class="n">frame_buffer</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_unsolicited_frame_control_get_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								       <span class="n">frame_index</span><span class="p">,</span>
								       <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_header</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC IO Request 0x%p could not get frame &quot;</span>
				<span class="s">&quot;header for frame index %d, status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">stp_req</span><span class="p">,</span>
				<span class="n">frame_index</span><span class="p">,</span>
				<span class="n">status</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">!=</span> <span class="n">FIS_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCIC PIO Request 0x%p received frame %d &quot;</span>
				<span class="s">&quot;with fis type 0x%02x when expecting a data &quot;</span>
				<span class="s">&quot;fis.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">stp_req</span><span class="p">,</span>
				<span class="n">frame_index</span><span class="p">,</span>
				<span class="n">frame_header</span><span class="o">-&gt;</span><span class="n">fis_type</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_REQUIRES_SCSI_ABORT</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>

			<span class="cm">/* Frame is decoded return it to the controller */</span>
			<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">saved_rx_frame_index</span> <span class="o">=</span> <span class="n">frame_index</span><span class="p">;</span>
			<span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sci_unsolicited_frame_control_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">uf_control</span><span class="p">,</span>
								      <span class="n">frame_index</span><span class="p">,</span>
								      <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame_buffer</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">sci_stp_request_pio_data_in_copy_data</span><span class="p">(</span><span class="n">stp_req</span><span class="p">,</span>
									    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">frame_buffer</span><span class="p">);</span>

			<span class="cm">/* Frame is decoded return it to the controller */</span>
			<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Check for the end of the transfer, are there more</span>
<span class="cm">		 * bytes remaining for this data transfer</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span> <span class="o">||</span> <span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">pio_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stp_req</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_PIO_SETUP</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">working_request</span> <span class="o">=</span> <span class="n">ireq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_ATAPI_WAIT_TC_COMP</span><span class="p">);</span>
			<span class="n">scu_atapi_reconstruct_raw_frame_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span><span class="p">);</span>
			<span class="n">scu_atapi_construct_task_context</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sci_controller_continue_io</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span>:
		<span class="k">return</span> <span class="n">atapi_d2h_reg_frame_handler</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SCI_REQ_ABORTING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * TODO: Is it even possible to get an unsolicited frame in the</span>
<span class="cm">		 * aborting state?</span>
<span class="cm">		 */</span>
		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: SCIC IO Request given unexpected frame %x while &quot;</span>
			 <span class="s">&quot;in state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">frame_index</span><span class="p">,</span>
			 <span class="n">state</span><span class="p">);</span>

		<span class="n">sci_controller_release_frame</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">stp_request_udma_await_tc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
						       <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_FIS</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_REG_ERR</span><span class="p">)</span>:
		<span class="cm">/* We must check ther response buffer to see if the D2H</span>
<span class="cm">		 * Register FIS was received before we got the TC</span>
<span class="cm">		 * completion.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">fis_type</span> <span class="o">==</span> <span class="n">FIS_REGD2H</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sci_remote_device_suspend</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">,</span>
						  <span class="n">SCI_SW_SUSPEND_NORMAL</span><span class="p">);</span>

			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If we have an error completion status for the</span>
<span class="cm">			 * TC then we can expect a D2H register FIS from</span>
<span class="cm">			 * the device so we must change state to wait</span>
<span class="cm">			 * for it</span>
<span class="cm">			 */</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_D2H</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* TODO Check to see if any of these completion status need to</span>
<span class="cm">	 * wait for the device to host register fis.</span>
<span class="cm">	 */</span>
	<span class="cm">/* TODO We can retry the command for SCU_TASK_DONE_CMD_LL_R_ERR</span>
<span class="cm">	 * - this comes only for B0</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be complete. */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">atapi_raw_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">completion_code</span><span class="p">,</span>
						  <span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_MAKE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span><span class="p">)</span>:
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* All other completion status cause the IO to be complete.</span>
<span class="cm">		 * If a NAK was received, then it is up to the user to retry</span>
<span class="cm">		 * the request.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_NORMALIZE_COMPLETION_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">);</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span><span class="p">;</span>

		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">atapi_data_tc_completion_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">d2h</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">SCU_TASK_DONE_GOOD</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">)</span>:
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">SCU_TASK_DONE_UNEXP_FIS</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">)</span>: <span class="p">{</span>
		<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sci_req_tx_bytes</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

		<span class="cm">/* likely non-error data underrrun, workaround missing</span>
<span class="cm">		 * d2h frame from the controller</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d2h</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">!=</span> <span class="n">FIS_REGD2H</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">=</span> <span class="n">FIS_REGD2H</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">byte_count_low</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">byte_count_high</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">lbal_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">lbam_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">lbah_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">_r_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">sector_count_exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">_r_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">_r_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d2h</span><span class="o">-&gt;</span><span class="n">_r_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS_IO_DONE_EARLY</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span><span class="p">;</span>

		<span class="cm">/* the hw will have suspended the rnc, so complete the</span>
<span class="cm">		 * request upon pending resume</span>
<span class="cm">		 */</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_STP_DEV_ATAPI_ERROR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">SCU_TASK_DONE_EXCESS_DATA</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_COMPLETION_TL_STATUS_SHIFT</span><span class="p">)</span>:
		<span class="cm">/* In this case, there is no UF coming after.</span>
<span class="cm">		 * compelte the IO now.</span>
<span class="cm">		 */</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_GOOD</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
		<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_COMPLETED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d2h</span><span class="o">-&gt;</span><span class="n">fis_type</span> <span class="o">==</span> <span class="n">FIS_REGD2H</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* UF received change the device state to ATAPI_ERROR */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span><span class="p">;</span>
			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_STP_DEV_ATAPI_ERROR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If receiving any non-sucess TC status, no UF</span>
<span class="cm">			 * received yet, then an UF for the status fis</span>
<span class="cm">			 * is coming after (XXX: suspect this is</span>
<span class="cm">			 * actually a protocol error or a bug like the</span>
<span class="cm">			 * DONE_UNEXP_FIS case)</span>
<span class="cm">			 */</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span> <span class="o">=</span> <span class="n">SCU_TASK_DONE_CHECK_RESPONSE</span><span class="p">;</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_IO_RESPONSE_VALID</span><span class="p">;</span>

			<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_smp_completion_status_is_tx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_WRONG_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_1</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_2</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_3</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_BAD_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_ZONE_VIOLATION</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_smp_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* There are no Tx/Rx SMP suspend conditions. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_ssp_completion_status_is_tx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_TX_RAW_CMD_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LF_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_WRONG_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_1</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_2</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_3</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_BAD_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_ZONE_VIOLATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_STP_RESOURCES_BUSY</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_PROTOCOL_NOT_SUPPORTED</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_ssp_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* There are no Tx/Rx SSP suspend conditions. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_stpsata_completion_status_is_tx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_TX_RAW_CMD_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_R_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_PERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_REG_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SDB_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_WRONG_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_1</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_2</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_3</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_BAD_DESTINATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_ZONE_VIOLATION</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_STP_RESOURCES_BUSY</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_PROTOCOL_NOT_SUPPORTED</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_CONNECTION_RATE_NOT_SUPPORTED</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sci_request_stpsata_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LF_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_SY_TERM</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_LF_TERM</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_BREAK_RCVD</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_INV_FIS_LEN</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_UNEXP_FIS</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_UNEXP_SDBFIS</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_MAX_PLD_ERR</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_request_handle_suspending_completions</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_tx_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SMP</span>:
		<span class="n">is_tx</span> <span class="o">=</span> <span class="n">sci_request_smp_completion_status_is_tx_suspend</span><span class="p">(</span>
			<span class="n">completion_code</span><span class="p">);</span>
		<span class="n">is_tx_rx</span> <span class="o">=</span> <span class="n">sci_request_smp_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
			<span class="n">completion_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SSP</span>:
		<span class="n">is_tx</span> <span class="o">=</span> <span class="n">sci_request_ssp_completion_status_is_tx_suspend</span><span class="p">(</span>
			<span class="n">completion_code</span><span class="p">);</span>
		<span class="n">is_tx_rx</span> <span class="o">=</span> <span class="n">sci_request_ssp_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
			<span class="n">completion_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_STP</span>:
		<span class="n">is_tx</span> <span class="o">=</span> <span class="n">sci_request_stpsata_completion_status_is_tx_suspend</span><span class="p">(</span>
			<span class="n">completion_code</span><span class="p">);</span>
		<span class="n">is_tx_rx</span> <span class="o">=</span>
			<span class="n">sci_request_stpsata_completion_status_is_tx_rx_suspend</span><span class="p">(</span>
				<span class="n">completion_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: request %p has no valid protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ireq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_tx</span> <span class="o">||</span> <span class="n">is_tx_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">is_tx</span> <span class="o">&amp;&amp;</span> <span class="n">is_tx_rx</span><span class="p">);</span>

		<span class="n">sci_remote_node_context_suspend</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">rnc</span><span class="p">,</span>
			<span class="n">SCI_HW_SUSPEND</span><span class="p">,</span>
			<span class="p">(</span><span class="n">is_tx_rx</span><span class="p">)</span> <span class="o">?</span> <span class="n">SCU_EVENT_TL_RNC_SUSPEND_TX_RX</span>
				   <span class="o">:</span> <span class="n">SCU_EVENT_TL_RNC_SUSPEND_TX</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_tc_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">completion_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">current_state_id</span><span class="p">;</span>

	<span class="cm">/* Decode those completions that signal upcoming suspension events. */</span>
	<span class="n">sci_request_handle_suspending_completions</span><span class="p">(</span>
		<span class="n">ireq</span><span class="p">,</span> <span class="n">SCU_GET_COMPLETION_TL_STATUS</span><span class="p">(</span><span class="n">completion_code</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCI_REQ_STARTED</span>:
		<span class="k">return</span> <span class="n">request_started_state_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_TASK_WAIT_TC_COMP</span>:
		<span class="k">return</span> <span class="n">ssp_task_request_await_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						       <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_SMP_WAIT_RESP</span>:
		<span class="k">return</span> <span class="n">smp_request_await_response_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
							   <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_SMP_WAIT_TC_COMP</span>:
		<span class="k">return</span> <span class="n">smp_request_await_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_TC_COMP</span>:
		<span class="k">return</span> <span class="n">stp_request_udma_await_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						       <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_H2D</span>:
		<span class="k">return</span> <span class="n">stp_request_non_data_await_h2d_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
							       <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_WAIT_H2D</span>:
		<span class="k">return</span> <span class="n">stp_request_pio_await_h2d_completion_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
								     <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_STP_PIO_DATA_OUT</span>:
		<span class="k">return</span> <span class="n">pio_data_out_tx_done_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_ABORTING</span>:
		<span class="k">return</span> <span class="n">request_aborting_state_tc_event</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span>
						       <span class="n">completion_code</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_H2D</span>:
		<span class="k">return</span> <span class="n">atapi_raw_completion</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">,</span>
					    <span class="n">SCI_REQ_ATAPI_WAIT_PIO_SETUP</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_TC_COMP</span>:
		<span class="k">return</span> <span class="n">atapi_raw_completion</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">,</span>
					    <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SCI_REQ_ATAPI_WAIT_D2H</span>:
		<span class="k">return</span> <span class="n">atapi_data_tc_completion_handler</span><span class="p">(</span><span class="n">ireq</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %x in wrong state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">,</span> <span class="n">req_state_name</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_STATE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isci_request_process_response_iu() - This function sets the status and</span>
<span class="cm"> *    response iu, in the task struct, from the request object for the upper</span>
<span class="cm"> *    layer driver.</span>
<span class="cm"> * @sas_task: This parameter is the task struct from the upper layer driver.</span>
<span class="cm"> * @resp_iu: This parameter points to the response iu of the completed request.</span>
<span class="cm"> * @dev: This parameter specifies the linux device struct.</span>
<span class="cm"> *</span>
<span class="cm"> * none.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_request_process_response_iu</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">resp_iu</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: resp_iu = %p &quot;</span>
		<span class="s">&quot;resp_iu-&gt;status = 0x%x,</span><span class="se">\n</span><span class="s">resp_iu-&gt;datapres = %d &quot;</span>
		<span class="s">&quot;resp_iu-&gt;response_data_len = %x, &quot;</span>
		<span class="s">&quot;resp_iu-&gt;sense_data_len = %x</span><span class="se">\n</span><span class="s">repsonse data: &quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">resp_iu</span><span class="p">,</span>
		<span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
		<span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">datapres</span><span class="p">,</span>
		<span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">response_data_len</span><span class="p">,</span>
		<span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">sense_data_len</span><span class="p">);</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">resp_iu</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* libsas updates the task status fields based on the response iu. */</span>
	<span class="n">sas_ssp_task_response</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">resp_iu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isci_request_set_open_reject_status() - This function prepares the I/O</span>
<span class="cm"> *    completion for OPEN_REJECT conditions.</span>
<span class="cm"> * @request: This parameter is the completed isci_request object.</span>
<span class="cm"> * @response_ptr: This parameter specifies the service response for the I/O.</span>
<span class="cm"> * @status_ptr: This parameter specifies the exec status for the I/O.</span>
<span class="cm"> * @open_rej_reason: This parameter specifies the encoded reason for the</span>
<span class="cm"> *    abandon-class reject.</span>
<span class="cm"> *</span>
<span class="cm"> * none.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_request_set_open_reject_status</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">service_response</span> <span class="o">*</span><span class="n">response_ptr</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">exec_status</span> <span class="o">*</span><span class="n">status_ptr</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">sas_open_rej_reason</span> <span class="n">open_rej_reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Task in the target is done. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">response_ptr</span>                     <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
	<span class="o">*</span><span class="n">status_ptr</span>                       <span class="o">=</span> <span class="n">SAS_OPEN_REJECT</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">open_rej_reason</span> <span class="o">=</span> <span class="n">open_rej_reason</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isci_request_handle_controller_specific_errors() - This function decodes</span>
<span class="cm"> *    controller-specific I/O completion error conditions.</span>
<span class="cm"> * @request: This parameter is the completed isci_request object.</span>
<span class="cm"> * @response_ptr: This parameter specifies the service response for the I/O.</span>
<span class="cm"> * @status_ptr: This parameter specifies the exec status for the I/O.</span>
<span class="cm"> *</span>
<span class="cm"> * none.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_request_handle_controller_specific_errors</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">service_response</span> <span class="o">*</span><span class="n">response_ptr</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">exec_status</span> <span class="o">*</span><span class="n">status_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cstatus</span><span class="p">;</span>

	<span class="n">cstatus</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">scu_status</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: %p SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR &quot;</span>
		<span class="s">&quot;- controller status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">cstatus</span><span class="p">);</span>

	<span class="cm">/* Decode the controller-specific errors; most</span>
<span class="cm">	 * important is to recognize those conditions in which</span>
<span class="cm">	 * the target may still have a task outstanding that</span>
<span class="cm">	 * must be aborted.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that there are SCU completion codes being</span>
<span class="cm">	 * named in the decode below for which SCIC has already</span>
<span class="cm">	 * done work to handle them in a way other than as</span>
<span class="cm">	 * a controller-specific completion code; these are left</span>
<span class="cm">	 * in the decode below for completeness sake.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cstatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_DMASETUP_DIRERR</span>:
	<span class="cm">/* Also SCU_TASK_DONE_SMP_FRM_TYPE_ERR: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_XFERCNT_ERR</span>:
		<span class="cm">/* Also SCU_TASK_DONE_SMP_UFI_ERR: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span> <span class="o">==</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SCU_TASK_DONE_SMP_UFI_ERR == Task Done. */</span>
			<span class="o">*</span><span class="n">response_ptr</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>

			<span class="cm">/* See if the device has been/is being stopped. Note</span>
<span class="cm">			 * that we ignore the quiesce state, since we are</span>
<span class="cm">			 * concerned about the actual device state.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
				<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Task in the target is not done. */</span>
			<span class="o">*</span><span class="n">response_ptr</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
				<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAM_STAT_TASK_ABORTED</span><span class="p">;</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_DONE_CRC_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_NAK_CMD_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_EXCESS_DATA</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_UNEXP_FIS</span>:
	<span class="cm">/* Also SCU_TASK_DONE_UNEXP_RESP: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_VIIT_ENTRY_NV</span>:       <span class="cm">/* TODO - conditions? */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_IIT_ENTRY_NV</span>:        <span class="cm">/* TODO - conditions? */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_RNCNV_OUTBOUND</span>:      <span class="cm">/* TODO - conditions? */</span>
		<span class="cm">/* These are conditions in which the target</span>
<span class="cm">		 * has completed the task, so that no cleanup</span>
<span class="cm">		 * is necessary.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">response_ptr</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>

		<span class="cm">/* See if the device has been/is being stopped. Note</span>
<span class="cm">		 * that we ignore the quiesce state, since we are</span>
<span class="cm">		 * concerned about the actual device state.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
			<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="cm">/* Note that the only open reject completion codes seen here will be</span>
<span class="cm">	 * abandon-class codes; all others are automatically retried in the SCU.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_WRONG_DESTINATION</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_WRONG_DEST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_ZONE_VIOLATION</span>:

		<span class="cm">/* Note - the return of AB0 will change when</span>
<span class="cm">		 * libsas implements detection of zone violations.</span>
<span class="cm">		 */</span>
		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_RESV_AB0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_1</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_RESV_AB1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_2</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_RESV_AB2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_RESERVED_ABANDON_3</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_RESV_AB3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_BAD_DESTINATION</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_BAD_DEST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_STP_RESOURCES_BUSY</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_STP_NORES</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_PROTOCOL_NOT_SUPPORTED</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_EPROTO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_OPEN_REJECT_CONNECTION_RATE_NOT_SUPPORTED</span>:

		<span class="n">isci_request_set_open_reject_status</span><span class="p">(</span>
			<span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">response_ptr</span><span class="p">,</span> <span class="n">status_ptr</span><span class="p">,</span>
			<span class="n">SAS_OREJ_CONN_RATE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_R_ERR</span>:
	<span class="cm">/* Also SCU_TASK_DONE_ACK_NAK_TO: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_PERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_SY_TERM</span>:
	<span class="cm">/* Also SCU_TASK_DONE_NAK_ERR:*/</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_LF_TERM</span>:
	<span class="cm">/* Also SCU_TASK_DONE_DATA_LEN_ERR: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LL_ABORT_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SEQ_INV_TYPE</span>:
	<span class="cm">/* Also SCU_TASK_DONE_UNEXP_XR: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_XR_IU_LEN_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_INV_FIS_LEN</span>:
	<span class="cm">/* Also SCU_TASK_DONE_XR_WD_LEN: */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SDMA_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_OFFSET_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_MAX_PLD_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_LF_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SMP_RESP_TO_ERR</span>:  <span class="cm">/* Escalate to dev reset? */</span>
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SMP_LL_RX_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_UNEXP_DATA</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_UNEXP_SDBFIS</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_REG_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_SDB_ERR</span>:
	<span class="k">case</span> <span class="n">SCU_TASK_DONE_TASK_ABORT</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Task in the target is not done. */</span>
		<span class="o">*</span><span class="n">response_ptr</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status_ptr</span> <span class="o">=</span> <span class="n">SAM_STAT_TASK_ABORTED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span> <span class="o">==</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_process_stp_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dev_to_host_fis</span> <span class="o">*</span><span class="n">fis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_status_struct</span> <span class="o">*</span><span class="n">ts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_task_resp</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fis</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">ending_fis</span><span class="p">,</span> <span class="n">fis</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fis</span><span class="p">));</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">buf_valid_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp</span><span class="p">);</span>

	<span class="cm">/* If the device fault bit is set in the status register, then</span>
<span class="cm">	 * set the sense data and return.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATA_DF</span><span class="p">)</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAS_PROTO_RESPONSE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fis</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_CHECK_CONDITION</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ts</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>

	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">resp</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isci_request_io_request_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">sci_io_status</span> <span class="n">completion_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssp_response_iu</span> <span class="o">*</span><span class="n">resp_iu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">task_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">service_response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">exec_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: request = %p, task = %p, &quot;</span>
		<span class="s">&quot;task-&gt;data_dir = %d completion_status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">completion_status</span><span class="p">);</span>

	<span class="cm">/* The request is done from an SCU HW perspective. */</span>

	<span class="cm">/* This is an active request being completed from the core. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">completion_status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SCI_IO_FAILURE_RESPONSE_VALID</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: SCI_IO_FAILURE_RESPONSE_VALID (%p/%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sas_protocol_ata</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">isci_process_stp_response</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">rsp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_PROTOCOL_SSP</span> <span class="o">==</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* crack the iu response buffer. */</span>
			<span class="n">resp_iu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ssp</span><span class="p">.</span><span class="n">rsp</span><span class="p">;</span>
			<span class="n">isci_request_process_response_iu</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">resp_iu</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAS_PROTOCOL_SMP</span> <span class="o">==</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCI_IO_FAILURE_RESPONSE_VALID: &quot;</span>
					<span class="s">&quot;SAS_PROTOCOL_SMP protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: unknown protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* use the task status set in the task struct by the</span>
<span class="cm">		* isci_request_process_response_iu call.</span>
<span class="cm">		*/</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_IO_SUCCESS</span>:
	<span class="k">case</span> <span class="n">SCI_IO_SUCCESS_IO_DONE_EARLY</span>:

		<span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_COMPLETE</span><span class="p">;</span>
		<span class="n">status</span>   <span class="o">=</span> <span class="n">SAM_STAT_GOOD</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">completion_status</span> <span class="o">==</span> <span class="n">SCI_IO_SUCCESS_IO_DONE_EARLY</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* This was an SSP / STP / SATA transfer.</span>
<span class="cm">			* There is a possibility that less data than</span>
<span class="cm">			* the maximum was transferred.</span>
<span class="cm">			*/</span>
			<span class="n">u32</span> <span class="n">transferred_length</span> <span class="o">=</span> <span class="n">sci_req_tx_bytes</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

			<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">residual</span>
				<span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span> <span class="o">-</span> <span class="n">transferred_length</span><span class="p">;</span>

			<span class="cm">/* If there were residual bytes, call this an</span>
<span class="cm">			* underrun.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">residual</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_DATA_UNDERRUN</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: SCI_IO_SUCCESS_IO_DONE_EARLY %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: SCI_IO_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_IO_FAILURE_TERMINATED</span>:

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: SCI_IO_FAILURE_TERMINATED (%p/%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>

		<span class="cm">/* The request was terminated explicitly. */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>

		<span class="cm">/* See if the device has been/is being stopped. Note</span>
<span class="cm">		* that we ignore the quiesce state, since we are</span>
<span class="cm">		* concerned about the actual device state.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_FAILURE_CONTROLLER_SPECIFIC_IO_ERR</span>:

		<span class="n">isci_request_handle_controller_specific_errors</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
							       <span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_IO_FAILURE_REMOTE_DEVICE_RESET_REQUIRED</span>:
		<span class="cm">/* This is a special case, in that the I/O completion</span>
<span class="cm">		* is telling us that the device needs a reset.</span>
<span class="cm">		* In order for the device reset condition to be</span>
<span class="cm">		* noticed, the I/O has to be handled in the error</span>
<span class="cm">		* handler.  Set the reset flag and cause the</span>
<span class="cm">		* SCSI error thread to be scheduled.</span>
<span class="cm">		*/</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">task_flags</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_NEED_DEV_RESET</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">task_flags</span><span class="p">);</span>

		<span class="cm">/* Fail the I/O. */</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SAM_STAT_TASK_ABORTED</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCI_FAILURE_RETRY_REQUIRED</span>:

		<span class="cm">/* Fail the I/O so it can be retried. */</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="nl">default:</span>
		<span class="cm">/* Catch any otherwise unhandled error codes here. */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: invalid completion code: 0x%x - &quot;</span>
				<span class="s">&quot;isci_request = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">completion_status</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

		<span class="n">response</span> <span class="o">=</span> <span class="n">SAS_TASK_UNDELIVERED</span><span class="p">;</span>

		<span class="cm">/* See if the device has been/is being stopped. Note</span>
<span class="cm">		* that we ignore the quiesce state, since we are</span>
<span class="cm">		* concerned about the actual device state.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_DEVICE_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SAS_ABORTED_TASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SAS_PROTOCOL_SMP</span> <span class="o">==</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SSP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* 0 indicates a single dma address */</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">request</span><span class="o">-&gt;</span><span class="n">zero_scatter_daddr</span><span class="p">,</span>
					 <span class="n">task</span><span class="o">-&gt;</span><span class="n">total_xfer_len</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">);</span>
		<span class="k">else</span>  <span class="cm">/* unmap the sgl dma addresses */</span>
			<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span>
				     <span class="n">request</span><span class="o">-&gt;</span><span class="n">num_sg_entries</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SMP</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">smp_req</span> <span class="o">*</span><span class="n">smp_req</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>

		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="cm">/* need to swab it back in case the command buffer is re-used */</span>
		<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">smp_req</span> <span class="o">=</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="n">smp_req</span><span class="p">,</span> <span class="n">smp_req</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">task_flags</span><span class="p">);</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">resp</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_status</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IREQ_COMPLETE_IN_TARGET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Normal notification (task_done) */</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_STATE_DONE</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SAS_TASK_AT_INITIATOR</span> <span class="o">|</span>
					    <span class="n">SAS_TASK_STATE_PENDING</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">task_flags</span><span class="p">);</span>

	<span class="cm">/* complete the io request to the core. */</span>
	<span class="n">sci_controller_complete_io</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="cm">/* set terminated handle so it cannot be completed or</span>
<span class="cm">	 * terminated again, and to cause any calls into abort</span>
<span class="cm">	 * task to recognize the already completed case.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_TERMINATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ireq_done</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_request_started_state_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_base_state_machine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ireq</span><span class="p">),</span> <span class="n">sm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_base_request_states</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>

	<span class="cm">/* XXX as hch said always creating an internal sas_task for tmf</span>
<span class="cm">	 * requests would simplify the driver</span>
<span class="cm">	 */</span>
	<span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="cm">/* all unaccelerated request types (non ssp or ncq) handled with</span>
<span class="cm">	 * substates</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_TASK_WAIT_TC_COMP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span> <span class="o">==</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_SMP_WAIT_RESP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">&amp;&amp;</span> <span class="n">sas_protocol_ata</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">use_ncq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sata_dev</span><span class="p">.</span><span class="n">command_set</span> <span class="o">==</span> <span class="n">ATAPI_COMMAND_SET</span> <span class="o">&amp;&amp;</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">fis</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_PACKET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_ATAPI_WAIT_H2D</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_STP_NON_DATA_WAIT_H2D</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">dma_xfer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_STP_UDMA_WAIT_TC_COMP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* PIO */</span> <span class="p">{</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">SCI_REQ_STP_PIO_WAIT_H2D</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* SSP or NCQ are fully accelerated, no substates */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sci_change_state</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_request_completed_state_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_base_state_machine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ireq</span><span class="p">),</span> <span class="n">sm</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">owning_controller</span><span class="p">;</span>

	<span class="cm">/* Tell the SCI_USER that the IO request is complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">isci_request_io_request_complete</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span>
						 <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isci_task_request_complete</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_request_aborting_state_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_base_state_machine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ireq</span><span class="p">),</span> <span class="n">sm</span><span class="p">);</span>

	<span class="cm">/* Setting the abort bit in the Task Context is required by the silicon. */</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_stp_request_started_non_data_await_h2d_completion_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_base_state_machine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ireq</span><span class="p">),</span> <span class="n">sm</span><span class="p">);</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">working_request</span> <span class="o">=</span> <span class="n">ireq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sci_stp_request_started_pio_await_h2d_completion_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sci_base_state_machine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ireq</span><span class="p">),</span> <span class="n">sm</span><span class="p">);</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="o">-&gt;</span><span class="n">working_request</span> <span class="o">=</span> <span class="n">ireq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sci_base_state</span> <span class="n">sci_request_state_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SCI_REQ_INIT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STARTED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enter_state</span> <span class="o">=</span> <span class="n">sci_request_started_state_enter</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_NON_DATA_WAIT_H2D</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enter_state</span> <span class="o">=</span> <span class="n">sci_stp_request_started_non_data_await_h2d_completion_enter</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_NON_DATA_WAIT_D2H</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_PIO_WAIT_H2D</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enter_state</span> <span class="o">=</span> <span class="n">sci_stp_request_started_pio_await_h2d_completion_enter</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_PIO_WAIT_FRAME</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_PIO_DATA_IN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_PIO_DATA_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_UDMA_WAIT_TC_COMP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_STP_UDMA_WAIT_D2H</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_TASK_WAIT_TC_COMP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_TASK_WAIT_TC_RESP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_SMP_WAIT_RESP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_SMP_WAIT_TC_COMP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_ATAPI_WAIT_H2D</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_ATAPI_WAIT_PIO_SETUP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_ATAPI_WAIT_D2H</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_ATAPI_WAIT_TC_COMP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_COMPLETED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enter_state</span> <span class="o">=</span> <span class="n">sci_request_completed_state_enter</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_ABORTING</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">enter_state</span> <span class="o">=</span> <span class="n">sci_request_aborting_state_enter</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">SCI_REQ_FINAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sci_general_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sci_init_sm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">sci_request_state_table</span><span class="p">,</span> <span class="n">SCI_REQ_INIT</span><span class="p">);</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_NONE</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">saved_rx_frame_index</span> <span class="o">=</span> <span class="n">SCU_INVALID_FRAME_INDEX</span><span class="p">;</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sci_status</span>   <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">scu_status</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">post_context</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Build the common part of the request */</span>
	<span class="n">sci_general_request_construct</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ireq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rnc</span><span class="p">.</span><span class="n">remote_node_index</span> <span class="o">==</span> <span class="n">SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_INVALID_REMOTE_DEVICE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span><span class="p">)</span>
		<span class="cm">/* pass */</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_is_sata</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_is_expander</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="cm">/* pass */</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE_UNSUPPORTED_PROTOCOL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scu_task_context</span><span class="p">,</span> <span class="n">sgl_pair_ab</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">sci_task_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">io_tag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">domain_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">domain_dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Build the common part of the request */</span>
	<span class="n">sci_general_request_construct</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">ireq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SAS_END_DEV</span> <span class="o">||</span> <span class="n">dev_is_sata</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scu_task_context</span><span class="p">));</span>

		<span class="cm">/* Set the protocol indicator. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_is_sata</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_UNSUPPORTED_PROTOCOL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">isci_request_ssp_request_construct</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: request = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">request</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_io_request_construct_basic_ssp</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">isci_request_stp_request_construct</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">host_to_dev_fis</span> <span class="o">*</span><span class="n">fis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">stp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">uldd_task</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: ireq = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">ireq</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">fis</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">fis</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_to_dev_fis</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">ata_task</span><span class="p">.</span><span class="n">device_control_reg_update</span><span class="p">)</span>
		<span class="n">fis</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">fis</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0xF0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_io_request_construct_basic_sata</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_FPDMA_WRITE</span> <span class="o">||</span>
		   <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">ATA_CMD_FPDMA_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fis</span><span class="o">-&gt;</span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">stp</span><span class="p">.</span><span class="n">ncq_tag</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span>
<span class="nf">sci_io_request_construct_smp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">smp_task</span><span class="p">.</span><span class="n">smp_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scu_task_context</span> <span class="o">*</span><span class="n">task_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_port</span> <span class="o">*</span><span class="n">iport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smp_req</span> <span class="o">*</span><span class="n">smp_req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">kaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">sg_page</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="n">smp_req</span> <span class="o">=</span> <span class="n">kaddr</span> <span class="o">+</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Look at the SMP requests&#39; header fields; for certain SAS 1.x SMP</span>
<span class="cm">	 * functions under SAS 2.0, a zero request length really indicates</span>
<span class="cm">	 * a non-zero default length.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smp_req</span><span class="o">-&gt;</span><span class="n">req_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">smp_req</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMP_DISCOVER</span>:
		<span class="k">case</span> <span class="n">SMP_REPORT_PHY_ERR_LOG</span>:
		<span class="k">case</span> <span class="n">SMP_REPORT_PHY_SATA</span>:
		<span class="k">case</span> <span class="n">SMP_REPORT_ROUTE_INFO</span>:
			<span class="n">smp_req</span><span class="o">-&gt;</span><span class="n">req_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMP_CONF_ROUTE_INFO</span>:
		<span class="k">case</span> <span class="n">SMP_PHY_CONTROL</span>:
		<span class="k">case</span> <span class="n">SMP_PHY_TEST_FUNCTION</span>:
			<span class="n">smp_req</span><span class="o">-&gt;</span><span class="n">req_len</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Default - zero is a valid default for 2.0. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">req_len</span> <span class="o">=</span> <span class="n">smp_req</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">;</span>
	<span class="n">sci_swab32_cpy</span><span class="p">(</span><span class="n">smp_req</span><span class="p">,</span> <span class="n">smp_req</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">smp_req</span><span class="p">;</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">kaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_map_sg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>

	<span class="cm">/* byte swap the smp request. */</span>

	<span class="n">task_context</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">tc</span><span class="p">;</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">ireq</span><span class="o">-&gt;</span><span class="n">target_device</span><span class="p">;</span>
	<span class="n">iport</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">owning_port</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the TC with the its required data</span>
<span class="cm">	 * 00h</span>
<span class="cm">	 */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">initiator_request</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">connection_rate</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">connection_rate</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_engine_index</span> <span class="o">=</span> <span class="n">ISCI_PEG</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">logical_port_index</span> <span class="o">=</span> <span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">protocol_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_VALID</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">context_type</span> <span class="o">=</span> <span class="n">SCU_TASK_CONTEXT_TYPE</span><span class="p">;</span>

	<span class="cm">/* 04h */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">remote_node_index</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rnc</span><span class="p">.</span><span class="n">remote_node_index</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">SCU_TASK_TYPE_SMP_REQUEST</span><span class="p">;</span>

	<span class="cm">/* 08h */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">link_layer_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">do_not_dma_ssp_good_response</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">strict_ordering</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">control_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">timeout_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">block_guard_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 0ch */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">address_modifier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 10h */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">ssp_command_iu_length</span> <span class="o">=</span> <span class="n">req_len</span><span class="p">;</span>

	<span class="cm">/* 14h */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">transfer_length_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 18h ~ 30h, protocol specific</span>
<span class="cm">	 * since commandIU has been build by framework at this point, we just</span>
<span class="cm">	 * copy the frist DWord from command IU to this location. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_context</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">.</span><span class="n">smp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * 40h</span>
<span class="cm">	 * &quot;For SMP you could program it to zero. We would prefer that way</span>
<span class="cm">	 * so that done code will be consistent.&quot; - Venki</span>
<span class="cm">	 */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">task_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">post_context</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">ISCI_PEG</span> <span class="o">&lt;&lt;</span> <span class="n">SCU_CONTEXT_COMMAND_PROTOCOL_ENGINE_GROUP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">iport</span><span class="o">-&gt;</span><span class="n">physical_port_index</span> <span class="o">&lt;&lt;</span>
				<span class="n">SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Copy the physical address for the command buffer to the SCU Task</span>
<span class="cm">	 * Context command buffer should not contain command header.</span>
<span class="cm">	 */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_upper</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">command_iu_lower</span> <span class="o">=</span> <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/* SMP response comes as UF, so no need to set response IU address. */</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">task_context</span><span class="o">-&gt;</span><span class="n">response_iu_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sci_change_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">,</span> <span class="n">SCI_REQ_CONSTRUCTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isci_smp_request_build() - This function builds the smp request.</span>
<span class="cm"> * @ireq: This parameter points to the isci_request allocated in the</span>
<span class="cm"> *    request construct function.</span>
<span class="cm"> *</span>
<span class="cm"> * SCI_SUCCESS on successfull completion, or specific failure code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">isci_smp_request_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">ireq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_io_request_construct_smp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">isci_host</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: failed with status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isci_io_request_build() - This function builds the io request object.</span>
<span class="cm"> * @ihost: This parameter specifies the ISCI host object</span>
<span class="cm"> * @request: This parameter points to the isci_request object allocated in the</span>
<span class="cm"> *    request construct function.</span>
<span class="cm"> * @sci_device: This parameter is the handle for the sci core&#39;s remote device</span>
<span class="cm"> *    object that is the destination for this request.</span>
<span class="cm"> *</span>
<span class="cm"> * SCI_SUCCESS on successfull completion, or specific failure code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">sci_status</span> <span class="nf">isci_io_request_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">isci_request_access_task</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s: idev = 0x%p; request = %p, &quot;</span>
		<span class="s">&quot;num_scatter = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">idev</span><span class="p">,</span>
		<span class="n">request</span><span class="p">,</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span><span class="p">);</span>

	<span class="cm">/* map the sgl addresses, if present.</span>
<span class="cm">	 * libata does the mapping for sata devices</span>
<span class="cm">	 * before we get the request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">sas_protocol_ata</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">SAS_PROTOCOL_SMP</span> <span class="o">&amp;</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">request</span><span class="o">-&gt;</span><span class="n">num_sg_entries</span> <span class="o">=</span> <span class="n">dma_map_sg</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">scatter</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">num_scatter</span><span class="p">,</span>
			<span class="n">task</span><span class="o">-&gt;</span><span class="n">data_dir</span>
			<span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">num_sg_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SCI_FAILURE_INSUFFICIENT_RESOURCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sci_io_request_construct</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: failed request construct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SMP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">isci_smp_request_build</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SSP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">isci_request_ssp_request_construct</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SATA</span>:
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_STP</span>:
	<span class="k">case</span> <span class="n">SAS_PROTOCOL_SATA</span> <span class="o">|</span> <span class="n">SAS_PROTOCOL_STP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">isci_request_stp_request_construct</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: unknown protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="nf">isci_request_from_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>

	<span class="n">ireq</span> <span class="o">=</span> <span class="n">ihost</span><span class="o">-&gt;</span><span class="n">reqs</span><span class="p">[</span><span class="n">ISCI_TAG_TCI</span><span class="p">(</span><span class="n">tag</span><span class="p">)];</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">io_request_completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">num_sg_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ireq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="nf">isci_io_request_from_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
						     <span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
						     <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>

	<span class="n">ireq</span> <span class="o">=</span> <span class="n">isci_request_from_tag</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">io_task_ptr</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">task</span><span class="o">-&gt;</span><span class="n">lldd_task</span> <span class="o">=</span> <span class="n">ireq</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ireq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="nf">isci_tmf_request_from_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">isci_tmf</span> <span class="o">*</span><span class="n">isci_tmf</span><span class="p">,</span>
					       <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>

	<span class="n">ireq</span> <span class="o">=</span> <span class="n">isci_request_from_tag</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">ireq</span><span class="o">-&gt;</span><span class="n">ttype_ptr</span><span class="p">.</span><span class="n">tmf_task_ptr</span> <span class="o">=</span> <span class="n">isci_tmf</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_TMF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ireq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">isci_request_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">isci_host</span> <span class="o">*</span><span class="n">ihost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isci_remote_device</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sas_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">sci_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SCI_FAILURE_UNSUPPORTED_PROTOCOL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isci_request</span> <span class="o">*</span><span class="n">ireq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* do common allocation and init of request object. */</span>
	<span class="n">ireq</span> <span class="o">=</span> <span class="n">isci_io_request_from_tag</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">isci_io_request_build</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">ireq</span><span class="p">,</span> <span class="n">idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: request_construct failed - status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">scic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IDEV_IO_NCQERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isci_task_is_ncq_recovery</span><span class="p">(</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* The device is in an NCQ recovery state.  Issue the</span>
<span class="cm">			 * request on the task side.  Note that it will</span>
<span class="cm">			 * complete on the I/O request side because the</span>
<span class="cm">			 * request was built that way (ie.</span>
<span class="cm">			 * ireq-&gt;is_task_management_request is false).</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">sci_controller_start_task</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span>
							    <span class="n">idev</span><span class="p">,</span>
							    <span class="n">ireq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">SCI_FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* send the request, let the core assign the IO TAG.	*/</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">sci_controller_start_io</span><span class="p">(</span><span class="n">ihost</span><span class="p">,</span> <span class="n">idev</span><span class="p">,</span>
						  <span class="n">ireq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: failed request start (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">scic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Either I/O started OK, or the core has signaled that</span>
<span class="cm">	 * the device needs a target reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SCI_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The request did not really start in the</span>
<span class="cm">		 * hardware, so clear the request handle</span>
<span class="cm">		 * here so no terminations will be done.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IREQ_TERMINATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ireq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ihost</span><span class="o">-&gt;</span><span class="n">scic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span>
	    <span class="n">SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Signal libsas that we need the SCSI error</span>
<span class="cm">		 * handler thread to work on this I/O and that</span>
<span class="cm">		 * we want a device reset.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_flags</span> <span class="o">|=</span> <span class="n">SAS_TASK_NEED_DEV_RESET</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">task_state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Cause this task to be scheduled in the SCSI error</span>
<span class="cm">		 * handler thread.</span>
<span class="cm">		 */</span>
		<span class="n">sas_task_abort</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

		<span class="cm">/* Change the status, since we are holding</span>
<span class="cm">		 * the I/O until it is managed by the SCSI</span>
<span class="cm">		 * error handler.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SCI_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
