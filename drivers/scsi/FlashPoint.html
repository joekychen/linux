<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › FlashPoint.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>FlashPoint.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  FlashPoint.c -- FlashPoint SCCB Manager for Linux</span>

<span class="cm">  This file contains the FlashPoint SCCB Manager from BusLogic&#39;s FlashPoint</span>
<span class="cm">  Driver Developer&#39;s Kit, with minor modifications by Leonard N. Zubkoff for</span>
<span class="cm">  Linux compatibility.  It was provided by BusLogic in the form of 16 separate</span>
<span class="cm">  source files, which would have unnecessarily cluttered the scsi directory, so</span>
<span class="cm">  the individual files have been combined into this single file.</span>

<span class="cm">  Copyright 1995-1996 by Mylex Corporation.  All Rights Reserved</span>

<span class="cm">  This file is available under both the GNU General Public License</span>
<span class="cm">  and a BSD-style copyright; see LICENSE.FlashPoint for details.</span>

<span class="cm">*/</span>


<span class="cp">#ifdef CONFIG_SCSI_FLASHPOINT</span>

<span class="cp">#define MAX_CARDS	8</span>
<span class="cp">#undef BUSTYPE_PCI</span>

<span class="cp">#define CRCMASK	0xA001</span>

<span class="cp">#define FAILURE         0xFFFFFFFFL</span>

<span class="k">struct</span> <span class="n">sccb</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">CALL_BK_FN</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">sccb_mgr_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">si_baseaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_present</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_intvect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_fw_revision</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_per_targ_init_sync</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_per_targ_fast_nego</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_per_targ_ultra_nego</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_per_targ_no_disc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_per_targ_wide_nego</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">si_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_card_family</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_bustype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_card_model</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_relative_cardnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">si_OS_reserved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">si_XlatInfo</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">si_reserved2</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">si_secondary_range</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SCSI_PARITY_ENA		  0x0001</span>
<span class="cp">#define LOW_BYTE_TERM		  0x0010</span>
<span class="cp">#define HIGH_BYTE_TERM		  0x0020</span>
<span class="cp">#define BUSTYPE_PCI	  0x3</span>

<span class="cp">#define SUPPORT_16TAR_32LUN	  0x0002</span>
<span class="cp">#define SOFT_RESET		  0x0004</span>
<span class="cp">#define EXTENDED_TRANSLATION	  0x0008</span>
<span class="cp">#define POST_ALL_UNDERRRUNS	  0x0040</span>
<span class="cp">#define FLAG_SCAM_ENABLED	  0x0080</span>
<span class="cp">#define FLAG_SCAM_LEVEL2	  0x0100</span>

<span class="cp">#define HARPOON_FAMILY        0x02</span>

<span class="cm">/* SCCB struct used for both SCCB and UCB manager compiles! </span>
<span class="cm"> * The UCB Manager treats the SCCB as it&#39;s &#39;native hardware structure&#39; </span>
<span class="cm"> */</span>

<span class="cp">#pragma pack(1)</span>
<span class="k">struct</span> <span class="n">sccb</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">OperationCode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ControlByte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CdbLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">DataLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">DataPointer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CcbRes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">HostStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargetStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TargID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">CcbRes1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Reserved2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SensePointer</span><span class="p">;</span>

	<span class="n">CALL_BK_FN</span> <span class="n">SccbCallback</span><span class="p">;</span>	<span class="cm">/* VOID (*SccbCallback)(); */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SccbIOPort</span><span class="p">;</span>	<span class="cm">/* Identifies board base port */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SccbStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SCCBRes2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">SccbOSFlags</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Sccb_XferCnt</span><span class="p">;</span>	<span class="cm">/* actual transfer count */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Sccb_ATC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SccbVirtDataPtr</span><span class="p">;</span>	<span class="cm">/* virtual addr for OS/2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Sccb_res1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Sccb_MGRFlags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">Sccb_sgseg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sccb_scsimsg</span><span class="p">;</span>	<span class="cm">/* identify msg for selection */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sccb_tag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sccb_scsistat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sccb_idmsg</span><span class="p">;</span>	<span class="cm">/* image of last msg in */</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">Sccb_forwardlink</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">Sccb_backlink</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Sccb_savedATC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Save_Cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Save_CdbLen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Sccb_XferState</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Sccb_SGoffset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#pragma pack()</span>

<span class="cp">#define SCATTER_GATHER_COMMAND    0x02</span>
<span class="cp">#define RESIDUAL_COMMAND          0x03</span>
<span class="cp">#define RESIDUAL_SG_COMMAND       0x04</span>
<span class="cp">#define RESET_COMMAND             0x81</span>

<span class="cp">#define F_USE_CMD_Q              0x20	</span><span class="cm">/*Inidcates TAGGED command. */</span><span class="cp"></span>
<span class="cp">#define TAG_TYPE_MASK            0xC0	</span><span class="cm">/*Type of tag msg to send. */</span><span class="cp"></span>
<span class="cp">#define SCCB_DATA_XFER_OUT       0x10	</span><span class="cm">/* Write */</span><span class="cp"></span>
<span class="cp">#define SCCB_DATA_XFER_IN        0x08	</span><span class="cm">/* Read */</span><span class="cp"></span>

<span class="cp">#define NO_AUTO_REQUEST_SENSE    0x01	</span><span class="cm">/* No Request Sense Buffer */</span><span class="cp"></span>

<span class="cp">#define BUS_FREE_ST     0</span>
<span class="cp">#define SELECT_ST       1</span>
<span class="cp">#define SELECT_BDR_ST   2	</span><span class="cm">/* Select w\ Bus Device Reset */</span><span class="cp"></span>
<span class="cp">#define SELECT_SN_ST    3	</span><span class="cm">/* Select w\ Sync Nego */</span><span class="cp"></span>
<span class="cp">#define SELECT_WN_ST    4	</span><span class="cm">/* Select w\ Wide Data Nego */</span><span class="cp"></span>
<span class="cp">#define SELECT_Q_ST     5	</span><span class="cm">/* Select w\ Tagged Q&#39;ing */</span><span class="cp"></span>
<span class="cp">#define COMMAND_ST      6</span>
<span class="cp">#define DATA_OUT_ST     7</span>
<span class="cp">#define DATA_IN_ST      8</span>
<span class="cp">#define DISCONNECT_ST   9</span>
<span class="cp">#define ABORT_ST        11</span>

<span class="cp">#define F_HOST_XFER_DIR                0x01</span>
<span class="cp">#define F_ALL_XFERRED                  0x02</span>
<span class="cp">#define F_SG_XFER                      0x04</span>
<span class="cp">#define F_AUTO_SENSE                   0x08</span>
<span class="cp">#define F_ODD_BALL_CNT                 0x10</span>
<span class="cp">#define F_NO_DATA_YET                  0x80</span>

<span class="cp">#define F_STATUSLOADED                 0x01</span>
<span class="cp">#define F_DEV_SELECTED                 0x04</span>

<span class="cp">#define SCCB_COMPLETE               0x00	</span><span class="cm">/* SCCB completed without error */</span><span class="cp"></span>
<span class="cp">#define SCCB_DATA_UNDER_RUN         0x0C</span>
<span class="cp">#define SCCB_SELECTION_TIMEOUT      0x11	</span><span class="cm">/* Set SCSI selection timed out */</span><span class="cp"></span>
<span class="cp">#define SCCB_DATA_OVER_RUN          0x12</span>
<span class="cp">#define SCCB_PHASE_SEQUENCE_FAIL    0x14	</span><span class="cm">/* Target bus phase sequence failure */</span><span class="cp"></span>

<span class="cp">#define SCCB_GROSS_FW_ERR           0x27	</span><span class="cm">/* Major problem! */</span><span class="cp"></span>
<span class="cp">#define SCCB_BM_ERR                 0x30	</span><span class="cm">/* BusMaster error. */</span><span class="cp"></span>
<span class="cp">#define SCCB_PARITY_ERR             0x34	</span><span class="cm">/* SCSI parity error */</span><span class="cp"></span>

<span class="cp">#define SCCB_IN_PROCESS            0x00</span>
<span class="cp">#define SCCB_SUCCESS               0x01</span>
<span class="cp">#define SCCB_ABORT                 0x02</span>
<span class="cp">#define SCCB_ERROR                 0x04</span>

<span class="cp">#define  ORION_FW_REV      3110</span>

<span class="cp">#define QUEUE_DEPTH     254+1	</span><span class="cm">/*1 for Normal disconnect 32 for Q&#39;ing. */</span><span class="cp"></span>

<span class="cp">#define	MAX_MB_CARDS	4	</span><span class="cm">/* Max. no of cards suppoerted on Mother Board */</span><span class="cp"></span>

<span class="cp">#define MAX_SCSI_TAR    16</span>
<span class="cp">#define MAX_LUN         32</span>
<span class="cp">#define LUN_MASK			0x1f</span>

<span class="cp">#define SG_BUF_CNT      16	</span><span class="cm">/*Number of prefetched elements. */</span><span class="cp"></span>

<span class="cp">#define SG_ELEMENT_SIZE 8	</span><span class="cm">/*Eight byte per element. */</span><span class="cp"></span>

<span class="cp">#define RD_HARPOON(ioport)          inb((u32)ioport)</span>
<span class="cp">#define RDW_HARPOON(ioport)         inw((u32)ioport)</span>
<span class="cp">#define RD_HARP32(ioport,offset,data) (data = inl((u32)(ioport + offset)))</span>
<span class="cp">#define WR_HARPOON(ioport,val)      outb((u8) val, (u32)ioport)</span>
<span class="cp">#define WRW_HARPOON(ioport,val)       outw((u16)val, (u32)ioport)</span>
<span class="cp">#define WR_HARP32(ioport,offset,data)  outl(data, (u32)(ioport + offset))</span>

<span class="cp">#define  TAR_SYNC_MASK     (BIT(7)+BIT(6))</span>
<span class="cp">#define  SYNC_TRYING               BIT(6)</span>
<span class="cp">#define  SYNC_SUPPORTED    (BIT(7)+BIT(6))</span>

<span class="cp">#define  TAR_WIDE_MASK     (BIT(5)+BIT(4))</span>
<span class="cp">#define  WIDE_ENABLED              BIT(4)</span>
<span class="cp">#define  WIDE_NEGOCIATED   BIT(5)</span>

<span class="cp">#define  TAR_TAG_Q_MASK    (BIT(3)+BIT(2))</span>
<span class="cp">#define  TAG_Q_TRYING              BIT(2)</span>
<span class="cp">#define  TAG_Q_REJECT      BIT(3)</span>

<span class="cp">#define  TAR_ALLOW_DISC    BIT(0)</span>

<span class="cp">#define  EE_SYNC_MASK      (BIT(0)+BIT(1))</span>
<span class="cp">#define  EE_SYNC_5MB       BIT(0)</span>
<span class="cp">#define  EE_SYNC_10MB      BIT(1)</span>
<span class="cp">#define  EE_SYNC_20MB      (BIT(0)+BIT(1))</span>

<span class="cp">#define  EE_WIDE_SCSI      BIT(7)</span>

<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">TarSelQ_Head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">TarSelQ_Tail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarLUN_CA</span><span class="p">;</span>	<span class="cm">/*Contingent Allgiance */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarTagQ_Cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarSelQ_Cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarStatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarEEValue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarSyncCtrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarReserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* for alignment */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">MAX_LUN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">MAX_LUN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nvram_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niModel</span><span class="p">;</span>	<span class="cm">/* Model No. of card */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niCardNo</span><span class="p">;</span>	<span class="cm">/* Card no. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">niBaseAddr</span><span class="p">;</span>	<span class="cm">/* Port Address of card */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niSysConf</span><span class="p">;</span>	<span class="cm">/* Adapter Configuration byte - Byte 16 of eeprom map */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niScsiConf</span><span class="p">;</span>	<span class="cm">/* SCSI Configuration byte - Byte 17 of eeprom map */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niScamConf</span><span class="p">;</span>	<span class="cm">/* SCAM Configuration byte - Byte 20 of eeprom map */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niAdapId</span><span class="p">;</span>	<span class="cm">/* Host Adapter ID - Byte 24 of eerpom map */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niSyncTbl</span><span class="p">[</span><span class="n">MAX_SCSI_TAR</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Sync/Wide byte of targets */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">niScamTbl</span><span class="p">[</span><span class="n">MAX_SCSI_TAR</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Compressed Scam name string of Targets */</span>
<span class="p">};</span>

<span class="cp">#define	MODEL_LT		1</span>
<span class="cp">#define	MODEL_DL		2</span>
<span class="cp">#define	MODEL_LW		3</span>
<span class="cp">#define	MODEL_DW		4</span>

<span class="k">struct</span> <span class="n">sccb_card</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_info</span> <span class="o">*</span><span class="n">cardInfo</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioPort</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmdCounter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">discQCount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tagQ_Lst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cardIndex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scanIndex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">globalFlags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ourId</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pNvRamInfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">QUEUE_DEPTH</span><span class="p">];</span>

<span class="p">};</span>

<span class="cp">#define F_TAG_STARTED		0x01</span>
<span class="cp">#define F_CONLUN_IO			0x02</span>
<span class="cp">#define F_DO_RENEGO			0x04</span>
<span class="cp">#define F_NO_FILTER			0x08</span>
<span class="cp">#define F_GREEN_PC			0x10</span>
<span class="cp">#define F_HOST_XFER_ACT		0x20</span>
<span class="cp">#define F_NEW_SCCB_CMD		0x40</span>
<span class="cp">#define F_UPDATE_EEPROM		0x80</span>

<span class="cp">#define  ID_STRING_LENGTH  32</span>
<span class="cp">#define  TYPE_CODE0        0x63	</span><span class="cm">/*Level2 Mstr (bits 7-6),  */</span><span class="cp"></span>

<span class="cp">#define  SLV_TYPE_CODE0    0xA3	</span><span class="cm">/*Priority Bit set (bits 7-6),  */</span><span class="cp"></span>

<span class="cp">#define  ASSIGN_ID   0x00</span>
<span class="cp">#define  SET_P_FLAG  0x01</span>
<span class="cp">#define  CFG_CMPLT   0x03</span>
<span class="cp">#define  DOM_MSTR    0x0F</span>
<span class="cp">#define  SYNC_PTRN   0x1F</span>

<span class="cp">#define  ID_0_7      0x18</span>
<span class="cp">#define  ID_8_F      0x11</span>
<span class="cp">#define  MISC_CODE   0x14</span>
<span class="cp">#define  CLR_P_FLAG  0x18</span>

<span class="cp">#define  INIT_SELTD  0x01</span>
<span class="cp">#define  LEVEL2_TAR  0x02</span>

<span class="k">enum</span> <span class="n">scam_id_st</span> <span class="p">{</span> <span class="n">ID0</span><span class="p">,</span> <span class="n">ID1</span><span class="p">,</span> <span class="n">ID2</span><span class="p">,</span> <span class="n">ID3</span><span class="p">,</span> <span class="n">ID4</span><span class="p">,</span> <span class="n">ID5</span><span class="p">,</span> <span class="n">ID6</span><span class="p">,</span> <span class="n">ID7</span><span class="p">,</span> <span class="n">ID8</span><span class="p">,</span> <span class="n">ID9</span><span class="p">,</span> <span class="n">ID10</span><span class="p">,</span> <span class="n">ID11</span><span class="p">,</span>
	    <span class="n">ID12</span><span class="p">,</span>
	<span class="n">ID13</span><span class="p">,</span> <span class="n">ID14</span><span class="p">,</span> <span class="n">ID15</span><span class="p">,</span> <span class="n">ID_UNUSED</span><span class="p">,</span> <span class="n">ID_UNASSIGNED</span><span class="p">,</span> <span class="n">ID_ASSIGNED</span><span class="p">,</span> <span class="n">LEGACY</span><span class="p">,</span>
	<span class="n">CLR_PRIORITY</span><span class="p">,</span> <span class="n">NO_ID_AVAIL</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">SCCBscam_info</span> <span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id_string</span><span class="p">[</span><span class="n">ID_STRING_LENGTH</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">scam_id_st</span> <span class="n">state</span><span class="p">;</span>

<span class="p">}</span> <span class="n">SCCBSCAM_INFO</span><span class="p">;</span>

<span class="cp">#define  SCSI_REQUEST_SENSE      0x03</span>
<span class="cp">#define  SCSI_READ               0x08</span>
<span class="cp">#define  SCSI_WRITE              0x0A</span>
<span class="cp">#define  SCSI_START_STOP_UNIT    0x1B</span>
<span class="cp">#define  SCSI_READ_EXTENDED      0x28</span>
<span class="cp">#define  SCSI_WRITE_EXTENDED     0x2A</span>
<span class="cp">#define  SCSI_WRITE_AND_VERIFY   0x2E</span>

<span class="cp">#define  SSGOOD                  0x00</span>
<span class="cp">#define  SSCHECK                 0x02</span>
<span class="cp">#define  SSQ_FULL                0x28</span>

<span class="cp">#define  SMCMD_COMP              0x00</span>
<span class="cp">#define  SMEXT                   0x01</span>
<span class="cp">#define  SMSAVE_DATA_PTR         0x02</span>
<span class="cp">#define  SMREST_DATA_PTR         0x03</span>
<span class="cp">#define  SMDISC                  0x04</span>
<span class="cp">#define  SMABORT                 0x06</span>
<span class="cp">#define  SMREJECT                0x07</span>
<span class="cp">#define  SMNO_OP                 0x08</span>
<span class="cp">#define  SMPARITY                0x09</span>
<span class="cp">#define  SMDEV_RESET             0x0C</span>
<span class="cp">#define	SMABORT_TAG					0x0D</span>
<span class="cp">#define	SMINIT_RECOVERY			0x0F</span>
<span class="cp">#define	SMREL_RECOVERY				0x10</span>

<span class="cp">#define  SMIDENT                 0x80</span>
<span class="cp">#define  DISC_PRIV               0x40</span>

<span class="cp">#define  SMSYNC                  0x01</span>
<span class="cp">#define  SMWDTR                  0x03</span>
<span class="cp">#define  SM8BIT                  0x00</span>
<span class="cp">#define  SM16BIT                 0x01</span>
<span class="cp">#define  SMIGNORWR               0x23	</span><span class="cm">/* Ignore Wide Residue */</span><span class="cp"></span>

<span class="cp">#define  SIX_BYTE_CMD            0x06</span>
<span class="cp">#define  TWELVE_BYTE_CMD         0x0C</span>

<span class="cp">#define  ASYNC                   0x00</span>
<span class="cp">#define  MAX_OFFSET              0x0F	</span><span class="cm">/* Maxbyteoffset for Sync Xfers */</span><span class="cp"></span>

<span class="cp">#define  EEPROM_WD_CNT     256</span>

<span class="cp">#define  EEPROM_CHECK_SUM  0</span>
<span class="cp">#define  FW_SIGNATURE      2</span>
<span class="cp">#define  MODEL_NUMB_0      4</span>
<span class="cp">#define  MODEL_NUMB_2      6</span>
<span class="cp">#define  MODEL_NUMB_4      8</span>
<span class="cp">#define  SYSTEM_CONFIG     16</span>
<span class="cp">#define  SCSI_CONFIG       17</span>
<span class="cp">#define  BIOS_CONFIG       18</span>
<span class="cp">#define  SCAM_CONFIG       20</span>
<span class="cp">#define  ADAPTER_SCSI_ID   24</span>

<span class="cp">#define  IGNORE_B_SCAN     32</span>
<span class="cp">#define  SEND_START_ENA    34</span>
<span class="cp">#define  DEVICE_ENABLE     36</span>

<span class="cp">#define  SYNC_RATE_TBL     38</span>
<span class="cp">#define  SYNC_RATE_TBL01   38</span>
<span class="cp">#define  SYNC_RATE_TBL23   40</span>
<span class="cp">#define  SYNC_RATE_TBL45   42</span>
<span class="cp">#define  SYNC_RATE_TBL67   44</span>
<span class="cp">#define  SYNC_RATE_TBL89   46</span>
<span class="cp">#define  SYNC_RATE_TBLab   48</span>
<span class="cp">#define  SYNC_RATE_TBLcd   50</span>
<span class="cp">#define  SYNC_RATE_TBLef   52</span>

<span class="cp">#define  EE_SCAMBASE      256</span>

<span class="cp">#define  SCAM_ENABLED   BIT(2)</span>
<span class="cp">#define  SCAM_LEVEL2    BIT(3)</span>

<span class="cp">#define	RENEGO_ENA		BIT(10)</span>
<span class="cp">#define	CONNIO_ENA		BIT(11)</span>
<span class="cp">#define  GREEN_PC_ENA   BIT(12)</span>

<span class="cp">#define  AUTO_RATE_00   00</span>
<span class="cp">#define  AUTO_RATE_05   01</span>
<span class="cp">#define  AUTO_RATE_10   02</span>
<span class="cp">#define  AUTO_RATE_20   03</span>

<span class="cp">#define  WIDE_NEGO_BIT     BIT(7)</span>
<span class="cp">#define  DISC_ENABLE_BIT   BIT(6)</span>

<span class="cp">#define  hp_vendor_id_0       0x00	</span><span class="cm">/* LSB */</span><span class="cp"></span>
<span class="cp">#define  ORION_VEND_0   0x4B</span>

<span class="cp">#define  hp_vendor_id_1       0x01	</span><span class="cm">/* MSB */</span><span class="cp"></span>
<span class="cp">#define  ORION_VEND_1   0x10</span>

<span class="cp">#define  hp_device_id_0       0x02	</span><span class="cm">/* LSB */</span><span class="cp"></span>
<span class="cp">#define  ORION_DEV_0    0x30</span>

<span class="cp">#define  hp_device_id_1       0x03	</span><span class="cm">/* MSB */</span><span class="cp"></span>
<span class="cp">#define  ORION_DEV_1    0x81</span>

	<span class="cm">/* Sub Vendor ID and Sub Device ID only available in</span>
<span class="cm">	   Harpoon Version 2 and higher */</span>

<span class="cp">#define  hp_sub_device_id_0   0x06	</span><span class="cm">/* LSB */</span><span class="cp"></span>

<span class="cp">#define  hp_semaphore         0x0C</span>
<span class="cp">#define SCCB_MGR_ACTIVE    BIT(0)</span>
<span class="cp">#define TICKLE_ME          BIT(1)</span>
<span class="cp">#define SCCB_MGR_PRESENT   BIT(3)</span>
<span class="cp">#define BIOS_IN_USE        BIT(4)</span>

<span class="cp">#define  hp_sys_ctrl          0x0F</span>

<span class="cp">#define  STOP_CLK          BIT(0)	</span><span class="cm">/*Turn off BusMaster Clock */</span><span class="cp"></span>
<span class="cp">#define  DRVR_RST          BIT(1)	</span><span class="cm">/*Firmware Reset to 80C15 chip */</span><span class="cp"></span>
<span class="cp">#define  HALT_MACH         BIT(3)	</span><span class="cm">/*Halt State Machine      */</span><span class="cp"></span>
<span class="cp">#define  HARD_ABORT        BIT(4)	</span><span class="cm">/*Hard Abort              */</span><span class="cp"></span>

<span class="cp">#define  hp_host_blk_cnt      0x13</span>

<span class="cp">#define  XFER_BLK64        0x06	</span><span class="cm">/*     1 1 0 64 byte per block */</span><span class="cp"></span>

<span class="cp">#define  BM_THRESHOLD      0x40	</span><span class="cm">/* PCI mode can only xfer 16 bytes */</span><span class="cp"></span>

<span class="cp">#define  hp_int_mask          0x17</span>

<span class="cp">#define  INT_CMD_COMPL     BIT(0)	</span><span class="cm">/* DMA command complete   */</span><span class="cp"></span>
<span class="cp">#define  INT_EXT_STATUS    BIT(1)	</span><span class="cm">/* Extended Status Set    */</span><span class="cp"></span>

<span class="cp">#define  hp_xfer_cnt_lo       0x18</span>
<span class="cp">#define  hp_xfer_cnt_hi       0x1A</span>
<span class="cp">#define  hp_xfer_cmd          0x1B</span>

<span class="cp">#define  XFER_HOST_DMA     0x00	</span><span class="cm">/*     0 0 0 Transfer Host -&gt; DMA */</span><span class="cp"></span>
<span class="cp">#define  XFER_DMA_HOST     0x01	</span><span class="cm">/*     0 0 1 Transfer DMA  -&gt; Host */</span><span class="cp"></span>

<span class="cp">#define  XFER_HOST_AUTO    0x00	</span><span class="cm">/*     0 0 Auto Transfer Size   */</span><span class="cp"></span>

<span class="cp">#define  XFER_DMA_8BIT     0x20	</span><span class="cm">/*     0 1 8 BIT  Transfer Size */</span><span class="cp"></span>

<span class="cp">#define  DISABLE_INT       BIT(7)	</span><span class="cm">/*Do not interrupt at end of cmd. */</span><span class="cp"></span>

<span class="cp">#define  HOST_WRT_CMD      ((DISABLE_INT + XFER_HOST_DMA + XFER_HOST_AUTO + XFER_DMA_8BIT))</span>
<span class="cp">#define  HOST_RD_CMD       ((DISABLE_INT + XFER_DMA_HOST + XFER_HOST_AUTO + XFER_DMA_8BIT))</span>

<span class="cp">#define  hp_host_addr_lo      0x1C</span>
<span class="cp">#define  hp_host_addr_hmi     0x1E</span>

<span class="cp">#define  hp_ee_ctrl           0x22</span>

<span class="cp">#define  EXT_ARB_ACK       BIT(7)</span>
<span class="cp">#define  SCSI_TERM_ENA_H   BIT(6)	</span><span class="cm">/* SCSI high byte terminator */</span><span class="cp"></span>
<span class="cp">#define  SEE_MS            BIT(5)</span>
<span class="cp">#define  SEE_CS            BIT(3)</span>
<span class="cp">#define  SEE_CLK           BIT(2)</span>
<span class="cp">#define  SEE_DO            BIT(1)</span>
<span class="cp">#define  SEE_DI            BIT(0)</span>

<span class="cp">#define  EE_READ           0x06</span>
<span class="cp">#define  EE_WRITE          0x05</span>
<span class="cp">#define  EWEN              0x04</span>
<span class="cp">#define  EWEN_ADDR         0x03C0</span>
<span class="cp">#define  EWDS              0x04</span>
<span class="cp">#define  EWDS_ADDR         0x0000</span>

<span class="cp">#define  hp_bm_ctrl           0x26</span>

<span class="cp">#define  SCSI_TERM_ENA_L   BIT(0)	</span><span class="cm">/*Enable/Disable external terminators */</span><span class="cp"></span>
<span class="cp">#define  FLUSH_XFER_CNTR   BIT(1)	</span><span class="cm">/*Flush transfer counter */</span><span class="cp"></span>
<span class="cp">#define  FORCE1_XFER       BIT(5)	</span><span class="cm">/*Always xfer one byte in byte mode */</span><span class="cp"></span>
<span class="cp">#define  FAST_SINGLE       BIT(6)	</span><span class="cm">/*?? */</span><span class="cp"></span>

<span class="cp">#define  BMCTRL_DEFAULT    (FORCE1_XFER|FAST_SINGLE|SCSI_TERM_ENA_L)</span>

<span class="cp">#define  hp_sg_addr           0x28</span>
<span class="cp">#define  hp_page_ctrl         0x29</span>

<span class="cp">#define  SCATTER_EN        BIT(0)</span>
<span class="cp">#define  SGRAM_ARAM        BIT(1)</span>
<span class="cp">#define  G_INT_DISABLE     BIT(3)	</span><span class="cm">/* Enable/Disable all Interrupts */</span><span class="cp"></span>
<span class="cp">#define  NARROW_SCSI_CARD  BIT(4)	</span><span class="cm">/* NARROW/WIDE SCSI config pin */</span><span class="cp"></span>

<span class="cp">#define  hp_pci_stat_cfg      0x2D</span>

<span class="cp">#define  REC_MASTER_ABORT  BIT(5)	</span><span class="cm">/*received Master abort */</span><span class="cp"></span>

<span class="cp">#define  hp_rev_num           0x33</span>

<span class="cp">#define  hp_stack_data        0x34</span>
<span class="cp">#define  hp_stack_addr        0x35</span>

<span class="cp">#define  hp_ext_status        0x36</span>

<span class="cp">#define  BM_FORCE_OFF      BIT(0)	</span><span class="cm">/*Bus Master is forced to get off */</span><span class="cp"></span>
<span class="cp">#define  PCI_TGT_ABORT     BIT(0)	</span><span class="cm">/*PCI bus master transaction aborted */</span><span class="cp"></span>
<span class="cp">#define  PCI_DEV_TMOUT     BIT(1)	</span><span class="cm">/*PCI Device Time out */</span><span class="cp"></span>
<span class="cp">#define  CMD_ABORTED       BIT(4)	</span><span class="cm">/*Command aborted */</span><span class="cp"></span>
<span class="cp">#define  BM_PARITY_ERR     BIT(5)	</span><span class="cm">/*parity error on data received   */</span><span class="cp"></span>
<span class="cp">#define  PIO_OVERRUN       BIT(6)	</span><span class="cm">/*Slave data overrun */</span><span class="cp"></span>
<span class="cp">#define  BM_CMD_BUSY       BIT(7)	</span><span class="cm">/*Bus master transfer command busy */</span><span class="cp"></span>
<span class="cp">#define  BAD_EXT_STATUS    (BM_FORCE_OFF | PCI_DEV_TMOUT | CMD_ABORTED | \</span>
<span class="cp">                                  BM_PARITY_ERR | PIO_OVERRUN)</span>

<span class="cp">#define  hp_int_status        0x37</span>

<span class="cp">#define  EXT_STATUS_ON     BIT(1)	</span><span class="cm">/*Extended status is valid */</span><span class="cp"></span>
<span class="cp">#define  SCSI_INTERRUPT    BIT(2)	</span><span class="cm">/*Global indication of a SCSI int. */</span><span class="cp"></span>
<span class="cp">#define  INT_ASSERTED      BIT(5)	</span><span class="cm">/* */</span><span class="cp"></span>

<span class="cp">#define  hp_fifo_cnt          0x38</span>

<span class="cp">#define  hp_intena		 0x40</span>

<span class="cp">#define  RESET		 BIT(7)</span>
<span class="cp">#define  PROG_HLT		 BIT(6)</span>
<span class="cp">#define  PARITY		 BIT(5)</span>
<span class="cp">#define  FIFO		 BIT(4)</span>
<span class="cp">#define  SEL		 BIT(3)</span>
<span class="cp">#define  SCAM_SEL		 BIT(2)</span>
<span class="cp">#define  RSEL		 BIT(1)</span>
<span class="cp">#define  TIMEOUT		 BIT(0)</span>
<span class="cp">#define  BUS_FREE		 BIT(15)</span>
<span class="cp">#define  XFER_CNT_0	 BIT(14)</span>
<span class="cp">#define  PHASE		 BIT(13)</span>
<span class="cp">#define  IUNKWN		 BIT(12)</span>
<span class="cp">#define  ICMD_COMP	 BIT(11)</span>
<span class="cp">#define  ITICKLE		 BIT(10)</span>
<span class="cp">#define  IDO_STRT		 BIT(9)</span>
<span class="cp">#define  ITAR_DISC	 BIT(8)</span>
<span class="cp">#define  AUTO_INT		 (BIT(12)+BIT(11)+BIT(10)+BIT(9)+BIT(8))</span>
<span class="cp">#define  CLR_ALL_INT	 0xFFFF</span>
<span class="cp">#define  CLR_ALL_INT_1	 0xFF00</span>

<span class="cp">#define  hp_intstat		 0x42</span>

<span class="cp">#define  hp_scsisig           0x44</span>

<span class="cp">#define  SCSI_SEL          BIT(7)</span>
<span class="cp">#define  SCSI_BSY          BIT(6)</span>
<span class="cp">#define  SCSI_REQ          BIT(5)</span>
<span class="cp">#define  SCSI_ACK          BIT(4)</span>
<span class="cp">#define  SCSI_ATN          BIT(3)</span>
<span class="cp">#define  SCSI_CD           BIT(2)</span>
<span class="cp">#define  SCSI_MSG          BIT(1)</span>
<span class="cp">#define  SCSI_IOBIT        BIT(0)</span>

<span class="cp">#define  S_SCSI_PHZ        (BIT(2)+BIT(1)+BIT(0))</span>
<span class="cp">#define  S_MSGO_PH         (BIT(2)+BIT(1)       )</span>
<span class="cp">#define  S_MSGI_PH         (BIT(2)+BIT(1)+BIT(0))</span>
<span class="cp">#define  S_DATAI_PH        (              BIT(0))</span>
<span class="cp">#define  S_DATAO_PH        0x00</span>
<span class="cp">#define  S_ILL_PH          (       BIT(1)       )</span>

<span class="cp">#define  hp_scsictrl_0        0x45</span>

<span class="cp">#define  SEL_TAR           BIT(6)</span>
<span class="cp">#define  ENA_ATN           BIT(4)</span>
<span class="cp">#define  ENA_RESEL         BIT(2)</span>
<span class="cp">#define  SCSI_RST          BIT(1)</span>
<span class="cp">#define  ENA_SCAM_SEL      BIT(0)</span>

<span class="cp">#define  hp_portctrl_0        0x46</span>

<span class="cp">#define  SCSI_PORT         BIT(7)</span>
<span class="cp">#define  SCSI_INBIT        BIT(6)</span>
<span class="cp">#define  DMA_PORT          BIT(5)</span>
<span class="cp">#define  DMA_RD            BIT(4)</span>
<span class="cp">#define  HOST_PORT         BIT(3)</span>
<span class="cp">#define  HOST_WRT          BIT(2)</span>
<span class="cp">#define  SCSI_BUS_EN       BIT(1)</span>
<span class="cp">#define  START_TO          BIT(0)</span>

<span class="cp">#define  hp_scsireset         0x47</span>

<span class="cp">#define  SCSI_INI          BIT(6)</span>
<span class="cp">#define  SCAM_EN           BIT(5)</span>
<span class="cp">#define  DMA_RESET         BIT(3)</span>
<span class="cp">#define  HPSCSI_RESET      BIT(2)</span>
<span class="cp">#define  PROG_RESET        BIT(1)</span>
<span class="cp">#define  FIFO_CLR          BIT(0)</span>

<span class="cp">#define  hp_xfercnt_0         0x48</span>
<span class="cp">#define  hp_xfercnt_2         0x4A</span>

<span class="cp">#define  hp_fifodata_0        0x4C</span>
<span class="cp">#define  hp_addstat           0x4E</span>

<span class="cp">#define  SCAM_TIMER        BIT(7)</span>
<span class="cp">#define  SCSI_MODE8        BIT(3)</span>
<span class="cp">#define  SCSI_PAR_ERR      BIT(0)</span>

<span class="cp">#define  hp_prgmcnt_0         0x4F</span>

<span class="cp">#define  hp_selfid_0          0x50</span>
<span class="cp">#define  hp_selfid_1          0x51</span>
<span class="cp">#define  hp_arb_id            0x52</span>

<span class="cp">#define  hp_select_id         0x53</span>

<span class="cp">#define  hp_synctarg_base     0x54</span>
<span class="cp">#define  hp_synctarg_12       0x54</span>
<span class="cp">#define  hp_synctarg_13       0x55</span>
<span class="cp">#define  hp_synctarg_14       0x56</span>
<span class="cp">#define  hp_synctarg_15       0x57</span>

<span class="cp">#define  hp_synctarg_8        0x58</span>
<span class="cp">#define  hp_synctarg_9        0x59</span>
<span class="cp">#define  hp_synctarg_10       0x5A</span>
<span class="cp">#define  hp_synctarg_11       0x5B</span>

<span class="cp">#define  hp_synctarg_4        0x5C</span>
<span class="cp">#define  hp_synctarg_5        0x5D</span>
<span class="cp">#define  hp_synctarg_6        0x5E</span>
<span class="cp">#define  hp_synctarg_7        0x5F</span>

<span class="cp">#define  hp_synctarg_0        0x60</span>
<span class="cp">#define  hp_synctarg_1        0x61</span>
<span class="cp">#define  hp_synctarg_2        0x62</span>
<span class="cp">#define  hp_synctarg_3        0x63</span>

<span class="cp">#define  NARROW_SCSI       BIT(4)</span>
<span class="cp">#define  DEFAULT_OFFSET    0x0F</span>

<span class="cp">#define  hp_autostart_0       0x64</span>
<span class="cp">#define  hp_autostart_1       0x65</span>
<span class="cp">#define  hp_autostart_3       0x67</span>

<span class="cp">#define  AUTO_IMMED    BIT(5)</span>
<span class="cp">#define  SELECT   BIT(6)</span>
<span class="cp">#define  END_DATA (BIT(7)+BIT(6))</span>

<span class="cp">#define  hp_gp_reg_0          0x68</span>
<span class="cp">#define  hp_gp_reg_1          0x69</span>
<span class="cp">#define  hp_gp_reg_3          0x6B</span>

<span class="cp">#define  hp_seltimeout        0x6C</span>

<span class="cp">#define  TO_4ms            0x67	</span><span class="cm">/* 3.9959ms */</span><span class="cp"></span>

<span class="cp">#define  TO_5ms            0x03	</span><span class="cm">/* 4.9152ms */</span><span class="cp"></span>
<span class="cp">#define  TO_10ms           0x07	</span><span class="cm">/* 11.xxxms */</span><span class="cp"></span>
<span class="cp">#define  TO_250ms          0x99	</span><span class="cm">/* 250.68ms */</span><span class="cp"></span>
<span class="cp">#define  TO_290ms          0xB1	</span><span class="cm">/* 289.99ms */</span><span class="cp"></span>

<span class="cp">#define  hp_clkctrl_0         0x6D</span>

<span class="cp">#define  PWR_DWN           BIT(6)</span>
<span class="cp">#define  ACTdeassert       BIT(4)</span>
<span class="cp">#define  CLK_40MHZ         (BIT(1) + BIT(0))</span>

<span class="cp">#define  CLKCTRL_DEFAULT   (ACTdeassert | CLK_40MHZ)</span>

<span class="cp">#define  hp_fiforead          0x6E</span>
<span class="cp">#define  hp_fifowrite         0x6F</span>

<span class="cp">#define  hp_offsetctr         0x70</span>
<span class="cp">#define  hp_xferstat          0x71</span>

<span class="cp">#define  FIFO_EMPTY        BIT(6)</span>

<span class="cp">#define  hp_portctrl_1        0x72</span>

<span class="cp">#define  CHK_SCSI_P        BIT(3)</span>
<span class="cp">#define  HOST_MODE8        BIT(0)</span>

<span class="cp">#define  hp_xfer_pad          0x73</span>

<span class="cp">#define  ID_UNLOCK         BIT(3)</span>

<span class="cp">#define  hp_scsidata_0        0x74</span>
<span class="cp">#define  hp_scsidata_1        0x75</span>

<span class="cp">#define  hp_aramBase          0x80</span>
<span class="cp">#define  BIOS_DATA_OFFSET     0x60</span>
<span class="cp">#define  BIOS_RELATIVE_CARD   0x64</span>

<span class="cp">#define  AR3      (BIT(9) + BIT(8))</span>
<span class="cp">#define  SDATA    BIT(10)</span>

<span class="cp">#define  CRD_OP   BIT(11)	</span><span class="cm">/* Cmp Reg. w/ Data */</span><span class="cp"></span>

<span class="cp">#define  CRR_OP   BIT(12)	</span><span class="cm">/* Cmp Reg. w. Reg. */</span><span class="cp"></span>

<span class="cp">#define  CPE_OP   (BIT(14)+BIT(11))	</span><span class="cm">/* Cmp SCSI phs &amp; Branch EQ */</span><span class="cp"></span>

<span class="cp">#define  CPN_OP   (BIT(14)+BIT(12))	</span><span class="cm">/* Cmp SCSI phs &amp; Branch NOT EQ */</span><span class="cp"></span>

<span class="cp">#define  ADATA_OUT   0x00</span>
<span class="cp">#define  ADATA_IN    BIT(8)</span>
<span class="cp">#define  ACOMMAND    BIT(10)</span>
<span class="cp">#define  ASTATUS     (BIT(10)+BIT(8))</span>
<span class="cp">#define  AMSG_OUT    (BIT(10)+BIT(9))</span>
<span class="cp">#define  AMSG_IN     (BIT(10)+BIT(9)+BIT(8))</span>

<span class="cp">#define  BRH_OP   BIT(13)	</span><span class="cm">/* Branch */</span><span class="cp"></span>

<span class="cp">#define  ALWAYS   0x00</span>
<span class="cp">#define  EQUAL    BIT(8)</span>
<span class="cp">#define  NOT_EQ   BIT(9)</span>

<span class="cp">#define  TCB_OP   (BIT(13)+BIT(11))	</span><span class="cm">/* Test condition &amp; branch */</span><span class="cp"></span>

<span class="cp">#define  FIFO_0      BIT(10)</span>

<span class="cp">#define  MPM_OP   BIT(15)	</span><span class="cm">/* Match phase and move data */</span><span class="cp"></span>

<span class="cp">#define  MRR_OP   BIT(14)	</span><span class="cm">/* Move DReg. to Reg. */</span><span class="cp"></span>

<span class="cp">#define  S_IDREG  (BIT(2)+BIT(1)+BIT(0))</span>

<span class="cp">#define  D_AR0    0x00</span>
<span class="cp">#define  D_AR1    BIT(0)</span>
<span class="cp">#define  D_BUCKET (BIT(2) + BIT(1) + BIT(0))</span>

<span class="cp">#define  RAT_OP      (BIT(14)+BIT(13)+BIT(11))</span>

<span class="cp">#define  SSI_OP      (BIT(15)+BIT(11))</span>

<span class="cp">#define  SSI_ITAR_DISC	(ITAR_DISC &gt;&gt; 8)</span>
<span class="cp">#define  SSI_IDO_STRT	(IDO_STRT &gt;&gt; 8)</span>

<span class="cp">#define  SSI_ICMD_COMP	(ICMD_COMP &gt;&gt; 8)</span>
<span class="cp">#define  SSI_ITICKLE	(ITICKLE &gt;&gt; 8)</span>

<span class="cp">#define  SSI_IUNKWN	(IUNKWN &gt;&gt; 8)</span>
<span class="cp">#define  SSI_INO_CC	(IUNKWN &gt;&gt; 8)</span>
<span class="cp">#define  SSI_IRFAIL	(IUNKWN &gt;&gt; 8)</span>

<span class="cp">#define  NP    0x10		</span><span class="cm">/*Next Phase */</span><span class="cp"></span>
<span class="cp">#define  NTCMD 0x02		</span><span class="cm">/*Non- Tagged Command start */</span><span class="cp"></span>
<span class="cp">#define  CMDPZ 0x04		</span><span class="cm">/*Command phase */</span><span class="cp"></span>
<span class="cp">#define  DINT  0x12		</span><span class="cm">/*Data Out/In interrupt */</span><span class="cp"></span>
<span class="cp">#define  DI    0x13		</span><span class="cm">/*Data Out */</span><span class="cp"></span>
<span class="cp">#define  DC    0x19		</span><span class="cm">/*Disconnect Message */</span><span class="cp"></span>
<span class="cp">#define  ST    0x1D		</span><span class="cm">/*Status Phase */</span><span class="cp"></span>
<span class="cp">#define  UNKNWN 0x24		</span><span class="cm">/*Unknown bus action */</span><span class="cp"></span>
<span class="cp">#define  CC    0x25		</span><span class="cm">/*Command Completion failure */</span><span class="cp"></span>
<span class="cp">#define  TICK  0x26		</span><span class="cm">/*New target reselected us. */</span><span class="cp"></span>
<span class="cp">#define  SELCHK 0x28		</span><span class="cm">/*Select &amp; Check SCSI ID latch reg */</span><span class="cp"></span>

<span class="cp">#define  ID_MSG_STRT    hp_aramBase + 0x00</span>
<span class="cp">#define  NON_TAG_ID_MSG hp_aramBase + 0x06</span>
<span class="cp">#define  CMD_STRT       hp_aramBase + 0x08</span>
<span class="cp">#define  SYNC_MSGS      hp_aramBase + 0x08</span>

<span class="cp">#define  TAG_STRT          0x00</span>
<span class="cp">#define  DISCONNECT_START  0x10/2</span>
<span class="cp">#define  END_DATA_START    0x14/2</span>
<span class="cp">#define  CMD_ONLY_STRT     CMDPZ/2</span>
<span class="cp">#define  SELCHK_STRT     SELCHK/2</span>

<span class="cp">#define GET_XFER_CNT(port, xfercnt) {RD_HARP32(port,hp_xfercnt_0,xfercnt); xfercnt &amp;= 0xFFFFFF;}</span>
<span class="cm">/* #define GET_XFER_CNT(port, xfercnt) (xfercnt = RD_HARPOON(port+hp_xfercnt_2), \</span>
<span class="cm">                                 xfercnt &lt;&lt;= 16,\</span>
<span class="cm">                                 xfercnt |= RDW_HARPOON((unsigned short)(port+hp_xfercnt_0)))</span>
<span class="cm"> */</span>
<span class="cp">#define HP_SETUP_ADDR_CNT(port,addr,count) (WRW_HARPOON((port+hp_host_addr_lo), (unsigned short)(addr &amp; 0x0000FFFFL)),\</span>
<span class="cp">         addr &gt;&gt;= 16,\</span>
<span class="cp">         WRW_HARPOON((port+hp_host_addr_hmi), (unsigned short)(addr &amp; 0x0000FFFFL)),\</span>
<span class="cp">         WR_HARP32(port,hp_xfercnt_0,count),\</span>
<span class="cp">         WRW_HARPOON((port+hp_xfer_cnt_lo), (unsigned short)(count &amp; 0x0000FFFFL)),\</span>
<span class="cp">         count &gt;&gt;= 16,\</span>
<span class="cp">         WR_HARPOON(port+hp_xfer_cnt_hi, (count &amp; 0xFF)))</span>

<span class="cp">#define ACCEPT_MSG(port) {while(RD_HARPOON(port+hp_scsisig) &amp; SCSI_REQ){}\</span>
<span class="cp">                          WR_HARPOON(port+hp_scsisig, S_ILL_PH);}</span>

<span class="cp">#define ACCEPT_MSG_ATN(port) {while(RD_HARPOON(port+hp_scsisig) &amp; SCSI_REQ){}\</span>
<span class="cp">                          WR_HARPOON(port+hp_scsisig, (S_ILL_PH|SCSI_ATN));}</span>

<span class="cp">#define DISABLE_AUTO(port) (WR_HARPOON(port+hp_scsireset, PROG_RESET),\</span>
<span class="cp">                        WR_HARPOON(port+hp_scsireset, 0x00))</span>

<span class="cp">#define ARAM_ACCESS(p_port) (WR_HARPOON(p_port+hp_page_ctrl, \</span>
<span class="cp">                             (RD_HARPOON(p_port+hp_page_ctrl) | SGRAM_ARAM)))</span>

<span class="cp">#define SGRAM_ACCESS(p_port) (WR_HARPOON(p_port+hp_page_ctrl, \</span>
<span class="cp">                             (RD_HARPOON(p_port+hp_page_ctrl) &amp; ~SGRAM_ARAM)))</span>

<span class="cp">#define MDISABLE_INT(p_port) (WR_HARPOON(p_port+hp_page_ctrl, \</span>
<span class="cp">                             (RD_HARPOON(p_port+hp_page_ctrl) | G_INT_DISABLE)))</span>

<span class="cp">#define MENABLE_INT(p_port) (WR_HARPOON(p_port+hp_page_ctrl, \</span>
<span class="cp">                             (RD_HARPOON(p_port+hp_page_ctrl) &amp; ~G_INT_DISABLE)))</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_sisyncn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">syncFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_ssel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sres</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_shandem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_stsyncn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sisyncr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sync_pulse</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sssyncv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_sync_value</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sresb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sxfrp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_schkdd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_WrStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_ChkIfChipInitialized</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioPort</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_SendMsg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueFlushTargSccb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisTarg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">error_code</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_sinits</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_sccb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_RNVRamData</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pNvRamInfo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_siwidn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_stwidn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_siwidr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">width</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueDisconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueSearchSelect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueFlushSccb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">error_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_queueAddSccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_queueFindSccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_utilUpdateResidual</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FPT_CalcCrc16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_CalcLrc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[]);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_Wait1Second</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_Wait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_delay</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_data</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FPT_utilEEReadOrg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_cmd</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseDataOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseDataIn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseCommand</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseStatus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseMsgOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseMsgIn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseIllegal</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseChkFifo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_phaseBusFree</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_XbowInit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scamFlg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_BusMasterInit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_DiagEEPROM</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_dataXferProcessor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_busMstrSGDataXferStart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_busMstrDataXferStart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_hostDataXferRestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_SccbMgr_bad_isr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">p_int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_SccbMgrTableInitAll</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_SccbMgrTableInitCard</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scini</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_our_id</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_power_up</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">FPT_scarb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_sel_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scbusf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scsel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scasid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scsendi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_sciso</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scwirod</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data_bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scwiros</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data_bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scvalq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_quintet</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scsell</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">targ_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scwtsel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_inisci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_our_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_scsavdi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scmachid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[]);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_autoCmdCmplt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FPT_autoLoadDefaultMap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">][</span><span class="n">MAX_SCSI_TAR</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="p">{{</span><span class="mi">0</span><span class="p">}}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sccb_card</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">SCCBSCAM_INFO</span> <span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">MAX_SCSI_TAR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{{</span><span class="mi">0</span><span class="p">}}</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nvram_info</span> <span class="n">FPT_nvRamInfo</span><span class="p">[</span><span class="n">MAX_MB_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_mbCards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FPT_scamHAString</span><span class="p">[]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span>
	<span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FPT_default_intena</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">0</span><span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_ProbeHostAdapter</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup and/or Search for cards and return info to caller.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FlashPoint_ProbeHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_mgr_info</span> <span class="o">*</span><span class="n">pCardInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">first_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp2</span><span class="p">,</span> <span class="n">temp3</span><span class="p">,</span> <span class="n">temp4</span><span class="p">,</span> <span class="n">temp5</span><span class="p">,</span> <span class="n">temp6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>

	<span class="n">ioport</span> <span class="o">=</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_baseaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_vendor_id_0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ORION_VEND_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_vendor_id_1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ORION_VEND_1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_device_id_0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ORION_DEV_0</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_device_id_1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ORION_DEV_1</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_rev_num</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/* For new Harpoon then check for sub_device ID LSB</span>
<span class="cm">   the bits(0-3) must be all ZERO for compatible with</span>
<span class="cm">   current version of SCCBMgr, else skip this Harpoon</span>
<span class="cm">	device. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_sub_device_id_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_SccbMgrTableInitAll</span><span class="p">();</span>
		<span class="n">first_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FPT_mbCards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_ChkIfChipInitialized</span><span class="p">(</span><span class="n">ioport</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">FPT_XbowInit</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/*Must Init the SCSI before attempting */</span>
			<span class="n">FPT_DiagEEPROM</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_mbCards</span> <span class="o">&lt;</span> <span class="n">MAX_MB_CARDS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_nvRamInfo</span><span class="p">[</span><span class="n">FPT_mbCards</span><span class="p">];</span>
				<span class="n">FPT_mbCards</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span> <span class="o">=</span> <span class="n">ioport</span><span class="p">;</span>
				<span class="n">FPT_RNVRamData</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niAdapId</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span>
		     <span class="kt">char</span><span class="p">)(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">ADAPTER_SCSI_ID</span> <span class="o">/</span>
					   <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x0FF</span><span class="p">);</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_lun</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_fw_revision</span> <span class="o">=</span> <span class="n">ORION_FW_REV</span><span class="p">;</span>
	<span class="n">temp2</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">temp3</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">temp4</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">temp5</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">temp6</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSyncTbl</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">))</span> <span class="o">+</span>
			    <span class="p">(((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">SYNC_RATE_TBL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
							    <span class="o">+</span> <span class="n">id</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">temp2</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">temp3</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">temp4</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">temp5</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">temp6</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AUTO_RATE_20</span>:	<span class="cm">/* Synchronous, 20 mega-transfers/second */</span>
				<span class="n">temp6</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>	<span class="cm">/* Fall through */</span>
			<span class="k">case</span> <span class="n">AUTO_RATE_10</span>:	<span class="cm">/* Synchronous, 10 mega-transfers/second */</span>
				<span class="n">temp5</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>	<span class="cm">/* Fall through */</span>
			<span class="k">case</span> <span class="n">AUTO_RATE_05</span>:	<span class="cm">/* Synchronous, 5 mega-transfers/second */</span>
				<span class="n">temp2</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>	<span class="cm">/* Fall through */</span>
			<span class="k">case</span> <span class="n">AUTO_RATE_00</span>:	<span class="cm">/* Asynchronous */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISC_ENABLE_BIT</span><span class="p">)</span>
				<span class="n">temp3</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGO_BIT</span><span class="p">)</span>
				<span class="n">temp4</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_init_sync</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_no_disc</span> <span class="o">=</span> <span class="n">temp3</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_wide_nego</span> <span class="o">=</span> <span class="n">temp4</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_fast_nego</span> <span class="o">=</span> <span class="n">temp5</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_ultra_nego</span> <span class="o">=</span> <span class="n">temp6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSysConf</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span>
		     <span class="kt">char</span><span class="p">)(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">SYSTEM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span>
		<span class="n">ScamFlg</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamConf</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ScamFlg</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">SCAM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">SCSI_PARITY_ENA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">SOFT_RESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">EXTENDED_TRANSLATION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">)</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">FLAG_SCAM_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_LEVEL2</span><span class="p">)</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">FLAG_SCAM_LEVEL2</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_TERM_ENA_L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">|=</span> <span class="n">SCSI_TERM_ENA_L</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_TERM_ENA_H</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">|=</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI_CARD</span><span class="p">))</span>

		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">SUPPORT_16TAR_32LUN</span><span class="p">;</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_family</span> <span class="o">=</span> <span class="n">HARPOON_FAMILY</span><span class="p">;</span>
	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_bustype</span> <span class="o">=</span> <span class="n">BUSTYPE_PCI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niModel</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MODEL_LT</span>:
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;3&#39;</span><span class="p">;</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODEL_LW</span>:
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;5&#39;</span><span class="p">;</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODEL_DL</span>:
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;3&#39;</span><span class="p">;</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODEL_DW</span>:
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;5&#39;</span><span class="p">;</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">MODEL_NUMB_0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">MODEL_NUMB_2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;3&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">LOW_BYTE_TERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_card_model</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">LOW_BYTE_TERM</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">HIGH_BYTE_TERM</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">);</span>
		<span class="n">temp2</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">SEE_CS</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
		<span class="n">temp3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp3</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
				<span class="n">temp3</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="p">(</span><span class="n">temp2</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span> <span class="n">temp2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp3</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">LOW_BYTE_TERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp3</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span>
			<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">|=</span> <span class="n">HIGH_BYTE_TERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_XlatInfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_aramBase</span> <span class="o">+</span> <span class="n">BIOS_DATA_OFFSET</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* return with -1 if no sort, else return with</span>
<span class="cm">	   logical card number sorted by BIOS (zero-based) */</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_relative_cardnum</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span>
	     <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_aramBase</span> <span class="o">+</span> <span class="n">BIOS_RELATIVE_CARD</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseDataOut</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseDataIn</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseIllegal</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseIllegal</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseCommand</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseStatus</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseMsgOut</span><span class="p">;</span>
	<span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_phaseMsgIn</span><span class="p">;</span>

	<span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_present</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_HardwareResetHostAdapter</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup adapter for normal operation (hard reset).</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">FlashPoint_HardwareResetHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_mgr_info</span>
							 <span class="o">*</span><span class="n">pCardInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">CurrCard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">,</span> <span class="n">sync_bit_map</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>

	<span class="n">ioport</span> <span class="o">=</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_baseaddr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">thisCard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">thisCard</span> <span class="o">&lt;=</span> <span class="n">MAX_CARDS</span><span class="p">;</span> <span class="n">thisCard</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">thisCard</span> <span class="o">==</span> <span class="n">MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">ioPort</span> <span class="o">==</span> <span class="n">ioport</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">CurrCard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">];</span>
			<span class="n">FPT_SccbMgrTableInitCard</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">ioPort</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">ioPort</span> <span class="o">=</span> <span class="n">ioport</span><span class="p">;</span>
			<span class="n">CurrCard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_mbCards</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FPT_mbCards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">ioPort</span> <span class="o">==</span>
					    <span class="n">FPT_nvRamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">niBaseAddr</span><span class="p">)</span>
						<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">pNvRamInfo</span> <span class="o">=</span>
						    <span class="o">&amp;</span><span class="n">FPT_nvRamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="n">FPT_SccbMgrTableInitCard</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">cardIndex</span> <span class="o">=</span> <span class="n">thisCard</span><span class="p">;</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">cardInfo</span> <span class="o">=</span> <span class="n">pCardInfo</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">pNvRamInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ScamFlg</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamConf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ScamFlg</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">SCAM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FPT_BusMasterInit</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
	<span class="n">FPT_XbowInit</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">);</span>

	<span class="n">FPT_autoLoadDefaultMap</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">id</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_selfid_0</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_selfid_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_arb_id</span><span class="p">,</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span><span class="p">);</span>
	<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">ourId</span> <span class="o">=</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">SCSI_PARITY_ENA</span><span class="p">)</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_portctrl_1</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST_MODE8</span> <span class="o">|</span> <span class="n">CHK_SCSI_P</span><span class="p">));</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_TERM_ENA_L</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">LOW_BYTE_TERM</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">|=</span> <span class="n">SCSI_TERM_ENA_L</span><span class="p">;</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_TERM_ENA_H</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">HIGH_BYTE_TERM</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">|=</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">;</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">&amp;</span> <span class="n">SOFT_RESET</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">FPT_sresb</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="n">FPT_scini</span><span class="p">(</span><span class="n">thisCard</span><span class="p">,</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_flags</span> <span class="o">&amp;</span> <span class="n">POST_ALL_UNDERRRUNS</span><span class="p">)</span>
		<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NO_FILTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSysConf</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_GREEN_PC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">SYSTEM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">GREEN_PC_ENA</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_GREEN_PC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set global flag to indicate Re-Negotiation to be done on all</span>
<span class="cm">	   ckeck condition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScsiConf</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_DO_RENEGO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RENEGO_ENA</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_DO_RENEGO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScsiConf</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_CONLUN_IO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CONNIO_ENA</span><span class="p">)</span>
			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_CONLUN_IO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_no_disc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">id</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">id</span><span class="p">)</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="n">TAR_ALLOW_DISC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sync_bit_map</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_SCSI_TAR</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSyncTbl</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">))</span> <span class="o">+</span>
			    <span class="p">(((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc000</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">SYNC_RATE_TBL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
							    <span class="o">+</span> <span class="n">id</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_init_sync</span> <span class="o">&amp;</span> <span class="n">sync_bit_map</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
							 <span class="n">i</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
							 <span class="n">i</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">|=</span>
				    <span class="n">SYNC_SUPPORTED</span><span class="p">;</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
							 <span class="n">i</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EE_SYNC_MASK</span><span class="p">);</span>
			<span class="p">}</span>

<span class="cm">/*         if ((pCardInfo-&gt;si_per_targ_wide_nego &amp; sync_bit_map) ||</span>
<span class="cm">            (id*2+i &gt;= 8)){</span>
<span class="cm">*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCardInfo</span><span class="o">-&gt;</span><span class="n">si_per_targ_wide_nego</span> <span class="o">&amp;</span> <span class="n">sync_bit_map</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
							 <span class="n">i</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">|=</span>
				    <span class="n">EE_WIDE_SCSI</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* NARROW SCSI */</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
							 <span class="n">i</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">|=</span>
				    <span class="n">WIDE_NEGOCIATED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sync_bit_map</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">),</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">))</span> <span class="o">|</span>
				   <span class="n">SCCB_MGR_PRESENT</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">CurrCard</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FlashPoint_ReleaseHostAdapter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regOffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scamData</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pScamTbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>

	<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pNvRamInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niModel</span><span class="p">);</span>
		<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSysConf</span><span class="p">);</span>
		<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScsiConf</span><span class="p">);</span>
		<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamConf</span><span class="p">);</span>
		<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niAdapId</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">FPT_WrStack</span><span class="p">(</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span>
				    <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSyncTbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">portBase</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regOffset</span> <span class="o">=</span> <span class="n">hp_aramBase</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">pScamTbl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamTbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">scamData</span> <span class="o">=</span> <span class="o">*</span><span class="n">pScamTbl</span><span class="p">;</span>
			<span class="n">WR_HARP32</span><span class="p">(</span><span class="n">portBase</span><span class="p">,</span> <span class="n">regOffset</span><span class="p">,</span> <span class="n">scamData</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">FPT_WrStack</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_RNVRamData</span><span class="p">(</span><span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pNvRamInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regOffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scamData</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pScamTbl</span><span class="p">;</span>

	<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niModel</span> <span class="o">=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niSysConf</span> <span class="o">=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niScsiConf</span> <span class="o">=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niScamConf</span> <span class="o">=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niAdapId</span> <span class="o">=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niSyncTbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">));</span>

	<span class="n">portBase</span> <span class="o">=</span> <span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niBaseAddr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regOffset</span> <span class="o">=</span> <span class="n">hp_aramBase</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">RD_HARP32</span><span class="p">(</span><span class="n">portBase</span><span class="p">,</span> <span class="n">regOffset</span><span class="p">,</span> <span class="n">scamData</span><span class="p">);</span>
		<span class="n">pScamTbl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pNvRamInfo</span><span class="o">-&gt;</span><span class="n">niScamTbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">pScamTbl</span> <span class="o">=</span> <span class="n">scamData</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_RdStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">portBase</span> <span class="o">+</span> <span class="n">hp_stack_addr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">portBase</span> <span class="o">+</span> <span class="n">hp_stack_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_WrStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portBase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">portBase</span> <span class="o">+</span> <span class="n">hp_stack_addr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">portBase</span> <span class="o">+</span> <span class="n">hp_stack_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_ChkIfChipInitialized</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioPort</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_arb_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FPT_RdStack</span><span class="p">(</span><span class="n">ioPort</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">)</span> <span class="o">==</span> <span class="n">TO_250ms</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">)</span> <span class="o">==</span> <span class="n">TO_290ms</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_StartCCB</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Start a command pointed to by p_Sccb. When the</span>
<span class="cm"> *              command is completed it will be returned via the</span>
<span class="cm"> *              callback function.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FlashPoint_StartCCB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pCurrCard</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_Sccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisCard</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pSaveSccb</span><span class="p">;</span>
	<span class="n">CALL_BK_FN</span> <span class="n">callback</span><span class="p">;</span>

	<span class="n">thisCard</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cardIndex</span><span class="p">;</span>
	<span class="n">ioport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">TargID</span> <span class="o">&gt;=</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">&gt;=</span> <span class="n">MAX_LUN</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_COMPLETE</span><span class="p">;</span>
		<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ERROR</span><span class="p">;</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="n">CALL_BK_FN</span><span class="p">)</span> <span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbCallback</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FPT_sinits</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">SCCB_MGR_ACTIVE</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_GREEN_PC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">);</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIOS_IN_USE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">TICKLE_ME</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pSaveSccb</span> <span class="o">=</span>
			    <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="p">;</span>
			<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">],</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
			    <span class="n">pSaveSccb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPT_queueAddSccb</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">G_INT_DISABLE</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pSaveSccb</span> <span class="o">=</span>
			    <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="p">;</span>
			<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">],</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
			    <span class="n">pSaveSccb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPT_queueAddSccb</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">MDISABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
		      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarSelQ_Cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span>
			<span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="p">;</span>
			<span class="n">FPT_ssel</span><span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbIOPort</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pSaveSccb</span> <span class="o">=</span>
				    <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
				    <span class="n">currentSCCB</span><span class="p">;</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
				    <span class="n">p_Sccb</span><span class="p">;</span>
				<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">],</span>
						    <span class="n">thisCard</span><span class="p">);</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
				    <span class="n">pSaveSccb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_queueAddSccb</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">MENABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_AbortCCB</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Abort the command pointed to by p_Sccb.  When the</span>
<span class="cm"> *              command is completed it will be returned via the</span>
<span class="cm"> *              callback function.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">FlashPoint_AbortCCB</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pCurrCard</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_Sccb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisCard</span><span class="p">;</span>
	<span class="n">CALL_BK_FN</span> <span class="n">callback</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pSaveSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">ioport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">;</span>

	<span class="n">thisCard</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cardIndex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">G_INT_DISABLE</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_queueFindSccb</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">))</span> <span class="p">{</span>

			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="p">)</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span>
					       <span class="kt">char</span><span class="p">)(</span><span class="o">~</span><span class="p">(</span><span class="n">SCCB_MGR_ACTIVE</span> <span class="o">|</span>
						       <span class="n">TICKLE_ME</span><span class="p">))));</span>

			<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ABORT</span><span class="p">;</span>
			<span class="n">callback</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbCallback</span><span class="p">;</span>
			<span class="n">callback</span><span class="p">(</span><span class="n">p_Sccb</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">==</span>
			    <span class="n">p_Sccb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ABORT</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="n">TID</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">MDISABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
					    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">==</span>
					    <span class="n">p_Sccb</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ABORT</span><span class="p">;</span>
						<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span>
						    <span class="n">ABORT_ST</span><span class="p">;</span>
						<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span>
						    <span class="n">SMABORT_TAG</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span>
						     <span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">==</span>
						    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
							<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span>
							 <span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
					<span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="p">;</span>
							<span class="n">FPT_ssel</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span>
								 <span class="n">thisCard</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">pSaveSCCB</span> <span class="o">=</span>
							    <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span>
							      <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">currentSCCB</span><span class="p">;</span>
							<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span>
							 <span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
					<span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">p_Sccb</span><span class="p">;</span>
							<span class="n">FPT_queueSelectFail</span><span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
							<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span>
							 <span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
					<span class="n">currentSCCB</span> <span class="o">=</span> <span class="n">pSaveSCCB</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="n">MENABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">currTar_Info</span> <span class="o">=</span>
					    <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">thisCard</span><span class="p">][</span><span class="n">p_Sccb</span><span class="o">-&gt;</span>
								      <span class="n">TargID</span><span class="p">];</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span>
					    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
						      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span>
					    <span class="o">==</span> <span class="n">p_Sccb</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">p_Sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ABORT</span><span class="p">;</span>
						<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_InterruptPending</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Do a quick check to determine if there is a pending</span>
<span class="cm"> *              interrupt for this card and disable the IRQ Pin if so.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FlashPoint_InterruptPending</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>

	<span class="n">ioport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_ASSERTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FlashPoint_HandleInterrupt</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This is our entry point when an interrupt is generated</span>
<span class="cm"> *              by the card and the upper level driver passes it on to</span>
<span class="cm"> *              us.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">FlashPoint_HandleInterrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisCard</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">bm_status</span><span class="p">,</span> <span class="n">bm_int_st</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hp_int</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>

	<span class="n">thisCard</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cardIndex</span><span class="p">;</span>
	<span class="n">ioport</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">;</span>

	<span class="n">MDISABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bm_int_st</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">EXT_STATUS_ON</span><span class="p">)</span>
		<span class="n">bm_status</span> <span class="o">=</span>
		    <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span>
			       <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">BAD_EXT_STATUS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bm_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_int_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">INT_CMD_COMPL</span> <span class="o">|</span> <span class="n">SCSI_INTERRUPT</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">hp_int</span> <span class="o">=</span>
		<span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span>
			     <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FPT_default_intena</span><span class="p">)</span> <span class="o">|</span> <span class="n">bm_status</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIFO</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">RESET</span> <span class="o">|</span> <span class="n">SCAM_SEL</span><span class="p">)</span> <span class="o">||</span> <span class="n">bm_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span>
			    <span class="n">FPT_SccbMgr_bad_isr</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">,</span>
						<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">),</span>
						<span class="n">hp_int</span><span class="p">);</span>
			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">FIFO</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">RESET</span> <span class="o">|</span> <span class="n">SCAM_SEL</span><span class="p">));</span>
			<span class="n">bm_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">MENABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">ICMD_COMP</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Wait for the BusFree before starting a new command.  We</span>
<span class="cm">				   must also check for being reselected since the BusFree</span>
<span class="cm">				   may not show up if another device reselects us in 1.5us or</span>
<span class="cm">				   less.  SRR Wednesday, 3/8/1995.</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">!</span>
				       <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
					<span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RSEL</span><span class="p">)))</span> <span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
			    <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span>

				<span class="n">FPT_phaseChkFifo</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

<span class="cm">/*         WRW_HARPOON((ioport+hp_intstat),</span>
<span class="cm">            (BUS_FREE | ICMD_COMP | ITAR_DISC | XFER_CNT_0));</span>
<span class="cm">         */</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT_1</span><span class="p">);</span>

			<span class="n">FPT_autoCmdCmplt</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">ITAR_DISC</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
			    <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_phaseChkFifo</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_gp_reg_1</span><span class="p">)</span> <span class="o">==</span> <span class="n">SMSAVE_DATA_PTR</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_gp_reg_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_NO_DATA_YET</span><span class="p">;</span>

				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_savedATC</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">DISCONNECT_ST</span><span class="p">;</span>
			<span class="n">FPT_queueDisconnect</span><span class="p">(</span><span class="n">currSCCB</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

			<span class="cm">/* Wait for the BusFree before starting a new command.  We</span>
<span class="cm">			   must also check for being reselected since the BusFree</span>
<span class="cm">			   may not show up if another device reselects us in 1.5us or</span>
<span class="cm">			   less.  SRR Wednesday, 3/8/1995.</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span>
			       <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RSEL</span><span class="p">))</span>
			       <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PHASE</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">RD_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">))</span> <span class="o">==</span>
				    <span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">SCSI_REQ</span> <span class="o">|</span> <span class="n">SCSI_CD</span> <span class="o">|</span> <span class="n">SCSI_MSG</span> <span class="o">|</span>
				     <span class="n">SCSI_IOBIT</span><span class="p">)))</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			   The additional loop exit condition above detects a timing problem</span>
<span class="cm">			   with the revision D/E harpoon chips.  The caller should reset the</span>
<span class="cm">			   host adapter to recover when 0xFE is returned.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
			    <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RSEL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">MENABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>
				<span class="k">return</span> <span class="mh">0xFE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">ITAR_DISC</span><span class="p">));</span>

			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span>
			    <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">RSEL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">PROG_HLT</span> <span class="o">|</span> <span class="n">RSEL</span> <span class="o">|</span> <span class="n">PHASE</span> <span class="o">|</span> <span class="n">BUS_FREE</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ITAR_DISC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
				    <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">FPT_phaseChkFifo</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_gp_reg_1</span><span class="p">)</span> <span class="o">==</span>
				    <span class="n">SMSAVE_DATA_PTR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_gp_reg_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
					<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span>
					    <span class="n">F_NO_DATA_YET</span><span class="p">;</span>
					<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_savedATC</span> <span class="o">=</span>
					    <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">ITAR_DISC</span><span class="p">));</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">DISCONNECT_ST</span><span class="p">;</span>
				<span class="n">FPT_queueDisconnect</span><span class="p">(</span><span class="n">currSCCB</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">FPT_sres</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">,</span>
				 <span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">));</span>
			<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">IDO_STRT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">IDO_STRT</span> <span class="o">|</span> <span class="n">XFER_CNT_0</span><span class="p">));</span>
			<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">IUNKWN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">PROG_HLT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">PHASE</span> <span class="o">|</span> <span class="n">IUNKWN</span> <span class="o">|</span> <span class="n">PROG_HLT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_prgmcnt_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>
			     <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SELCHK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Harpoon problem some SCSI target device respond to selection</span>
<span class="cm">				   with short BUSY pulse (&lt;400ns) this will make the Harpoon is not able</span>
<span class="cm">				   to latch the correct Target ID into reg. x53.</span>
<span class="cm">				   The work around require to correct this reg. But when write to this</span>
<span class="cm">				   reg. (0x53) also increment the FIFO write addr reg (0x6f), thus we</span>
<span class="cm">				   need to read this reg first then restore it later. After update to 0x53 */</span>

				<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span>
				     <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_fifowrite</span><span class="p">));</span>
				<span class="n">target</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span>
				     <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_gp_reg_3</span><span class="p">));</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ID_UNLOCK</span><span class="p">);</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_select_id</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">target</span> <span class="o">|</span> <span class="n">target</span> <span class="o">&lt;&lt;</span>
							   <span class="mi">4</span><span class="p">));</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_xfer_pad</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">);</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_fifowrite</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">TAG_STRT</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">XFER_CNT_0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">XFER_CNT_0</span><span class="p">);</span>

			<span class="n">FPT_schkdd</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">BUS_FREE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
			    <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">,</span>
						      <span class="n">currSCCB</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">FPT_phaseBusFree</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hp_int</span> <span class="o">&amp;</span> <span class="n">ITICKLE</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">ioport</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">ITICKLE</span><span class="p">);</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span>
			    <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span>
		    <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">)</span> <span class="p">{</span>

			<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">==</span>
			    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_queueSearchSelect</span><span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span>
						       <span class="n">pCurrCard</span><span class="p">),</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span>
			    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrCard</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>
				<span class="n">FPT_ssel</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">thisCard</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

	<span class="p">}</span>			<span class="cm">/*end while */</span>

	<span class="n">MENABLE_INT</span><span class="p">(</span><span class="n">ioport</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Sccb_bad_isr</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Some type of interrupt has occurred which is slightly</span>
<span class="cm"> *              out of the ordinary.  We will now decode it fully, in</span>
<span class="cm"> *              this routine.  This is broken up in an attempt to save</span>
<span class="cm"> *              processing time.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_SccbMgr_bad_isr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">p_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">BM_FORCE_OFF</span> <span class="o">|</span> <span class="n">PCI_DEV_TMOUT</span> <span class="o">|</span> <span class="n">BM_PARITY_ERR</span> <span class="o">|</span> <span class="n">PIO_OVERRUN</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span>
					      <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_pci_stat_cfg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">REC_MASTER_ABORT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_pci_stat_cfg</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_pci_stat_cfg</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="n">REC_MASTER_ABORT</span><span class="p">));</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_host_blk_cnt</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span><span class="p">)</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
				    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>

			<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>

			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
					       <span class="p">(</span><span class="n">EXT_ARB_ACK</span> <span class="o">|</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">));</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span>
				   <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">temp</span> <span class="o">|</span> <span class="n">SEE_MS</span> <span class="o">|</span> <span class="n">SEE_CS</span><span class="p">));</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
			    <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_int</span> <span class="o">&amp;</span> <span class="n">RESET</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span>

				<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span>
						      <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="n">FPT_sresb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">pNvRamInfo</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ScamFlg</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamConf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ScamFlg</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
							  <span class="n">SCAM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">FPT_XbowInit</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">);</span>

		<span class="n">FPT_scini</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">ourId</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_int</span> <span class="o">&amp;</span> <span class="n">FIFO</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">FIFO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_int</span> <span class="o">&amp;</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">PROG_HLT</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">SEL</span> <span class="o">|</span> <span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span> <span class="o">|</span>
			     <span class="n">IUNKWN</span><span class="p">));</span>

		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_SELECTION_TIMEOUT</span><span class="p">;</span>

		<span class="n">currTar_Info</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
			<span class="n">TAG_Q_TRYING</span><span class="p">))</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span>
			    <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">,</span> <span class="n">NARROW_SCSI</span><span class="p">,</span>
			    <span class="n">currTar_Info</span><span class="p">);</span>

		<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="n">pCurrCard</span><span class="p">,</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_int</span> <span class="o">&amp;</span> <span class="n">SCAM_SEL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_scarb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">LEVEL2_TAR</span><span class="p">);</span>
		<span class="n">FPT_scsel</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
		<span class="n">FPT_scasid</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">p_port</span><span class="p">);</span>

		<span class="n">FPT_scbusf</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">SCAM_SEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: SccbMgrTableInit</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Initialize all Sccb manager data structures.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_SccbMgrTableInitAll</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisCard</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">thisCard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">thisCard</span> <span class="o">&lt;</span> <span class="n">MAX_CARDS</span><span class="p">;</span> <span class="n">thisCard</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_SccbMgrTableInitCard</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">],</span> <span class="n">thisCard</span><span class="p">);</span>

		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">ioPort</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">cardInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">cardIndex</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">ourId</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">thisCard</span><span class="p">].</span><span class="n">pNvRamInfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: SccbMgrTableInit</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Initialize all Sccb manager data structures.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_SccbMgrTableInitCard</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsiID</span><span class="p">,</span> <span class="n">qtag</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qtag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qtag</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">qtag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">scsiID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scsiID</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">scsiID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">scanIndex</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">cmdCounter</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">tagQ_Lst</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: SccbMgrTableInit</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Initialize all Sccb manager data structures.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lun</span><span class="p">,</span> <span class="n">qtag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">target</span><span class="p">];</span>

	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUN_CA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">MAX_LUN</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qtag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qtag</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">qtag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">TargID</span> <span class="o">==</span>
			    <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: sfetm</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Read in a message byte from the SCSI bus, and check</span>
<span class="cm"> *              for a parity error.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_sfm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">TimeOutLoop</span><span class="p">;</span>

	<span class="n">TimeOutLoop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">TimeOutLoop</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">))</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>

	<span class="n">message</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_MSGI_PH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TimeOutLoop</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">)</span>
		<span class="n">message</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* force message byte = 0 if Time Out on Req */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PARITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_PAR_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fifowrite</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMPARITY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">message</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">TimeOutLoop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="n">TimeOutLoop</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TimeOutLoop</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PARITY</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">message</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_SCSI_PHZ</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">S_MSGI_PH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PARITY</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">message</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>

			<span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">);</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fifowrite</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">message</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_ssel</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Load up automation and select target device.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_ssel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">auto_loaded</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">theCCB</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cdb_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">CurrCard</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastTag</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>

	<span class="n">CurrCard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">];</span>
	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">target</span><span class="p">];</span>
	<span class="n">lastTag</span> <span class="o">=</span> <span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">tagQ_Lst</span><span class="p">;</span>

	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TAG_Q_REJECT</span><span class="p">)</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_USE_CMD_Q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span>

		<span class="n">lun</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_TAG_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">F_USE_CMD_Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUN_CA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span>
				<span class="o">==</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
					<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">else</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span>
			<span class="cm">/*End non-tagged */</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="cm">/*!Use cmd Q Tagged */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUN_CA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
				<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span>		<span class="cm">/*else use cmd Q tagged */</span>

	<span class="p">}</span>
	<span class="cm">/*if glob tagged started */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((((</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
	     <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">F_USE_CMD_Q</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span> <span class="o">&gt;=</span> <span class="n">QUEUE_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lastTag</span> <span class="o">&gt;=</span> <span class="n">QUEUE_DEPTH</span><span class="p">)</span>
				<span class="n">lastTag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">lastTag</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">tagQ_Lst</span> <span class="o">=</span> <span class="n">lastTag</span><span class="p">;</span>
				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastTag</span><span class="p">;</span>
				<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">lastTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="p">;</span>
				<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">QUEUE_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">auto_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_select_id</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_gp_reg_3</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>	<span class="cm">/* Use by new automation logic */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
						   <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
						    <span class="n">Sccb_idmsg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISC_PRIV</span><span class="p">)));</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">);</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMDEV_RESET</span><span class="p">;</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>
		<span class="n">auto_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_BDR_ST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">NARROW_SCSI</span><span class="p">,</span> <span class="n">currTar_Info</span><span class="p">);</span>
		<span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
						   <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
						    <span class="n">Sccb_idmsg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISC_PRIV</span><span class="p">)));</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">CMDPZ</span><span class="p">);</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
						     <span class="p">(((</span><span class="kt">unsigned</span>
							<span class="kt">char</span><span class="p">)(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							      <span class="n">ControlByte</span> <span class="o">&amp;</span>
							      <span class="n">TAG_TYPE_MASK</span><span class="p">)</span>
						       <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>
						      <span class="mh">0x20</span><span class="p">)));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>
		<span class="n">auto_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">WIDE_NEGOCIATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">auto_loaded</span> <span class="o">=</span> <span class="n">FPT_siwidn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_WN_ST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_SYNC_MASK</span><span class="p">)</span>
		   <span class="o">==</span> <span class="n">SYNC_SUPPORTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">auto_loaded</span> <span class="o">=</span> <span class="n">FPT_sisyncn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_SN_ST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auto_loaded</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">F_USE_CMD_Q</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_TAG_STARTED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">TAG_Q_REJECT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_USE_CMD_Q</span><span class="p">;</span>

				<span class="cm">/* Fix up the start instruction with a jump to</span>
<span class="cm">				   Non-Tag-CMD handling */</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span>
					    <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NTCMD</span><span class="p">);</span>

				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">NON_TAG_ID_MSG</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
					     <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span><span class="p">));</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>

				<span class="cm">/* Setup our STATE so we know what happened when</span>
<span class="cm">				   the wheels fall off. */</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_ST</span><span class="p">;</span>

				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
					     <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span><span class="p">));</span>

				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
					    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
					     <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">ControlByte</span> <span class="o">&amp;</span>
							       <span class="n">TAG_TYPE_MASK</span><span class="p">)</span>
					       <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x20</span><span class="p">)));</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lastTag</span> <span class="o">&gt;=</span> <span class="n">QUEUE_DEPTH</span><span class="p">)</span>
						<span class="n">lastTag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">lastTag</span><span class="p">]</span> <span class="o">==</span>
					    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span>
							     <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
							    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
							     <span class="n">lastTag</span><span class="p">));</span>
						<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">tagQ_Lst</span> <span class="o">=</span> <span class="n">lastTag</span><span class="p">;</span>
						<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span> <span class="o">=</span> <span class="n">lastTag</span><span class="p">;</span>
						<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">lastTag</span><span class="p">]</span> <span class="o">=</span>
						    <span class="n">currSCCB</span><span class="p">;</span>
						<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">++</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">QUEUE_DEPTH</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="n">CurrCard</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
					<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_Q_ST</span><span class="p">;</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span>
				    <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NTCMD</span><span class="p">);</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">NON_TAG_ID_MSG</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span><span class="p">));</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_ST</span><span class="p">;</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">theCCB</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">cdb_reg</span> <span class="o">=</span> <span class="n">port</span> <span class="o">+</span> <span class="n">CMD_STRT</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">cdb_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="o">*</span><span class="n">theCCB</span><span class="p">));</span>
			<span class="n">cdb_reg</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">theCCB</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span> <span class="o">!=</span> <span class="n">TWELVE_BYTE_CMD</span><span class="p">)</span>
			<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">cdb_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="cm">/* auto_loaded */</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="p">(</span><span class="n">PROG_HLT</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">SEL</span> <span class="o">|</span> <span class="n">BUS_FREE</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_PORT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_MGRFlags</span> <span class="o">&amp;</span> <span class="n">F_DEV_SELECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">SEL_TAR</span> <span class="o">|</span> <span class="n">ENA_ATN</span> <span class="o">|</span> <span class="n">ENA_RESEL</span> <span class="o">|</span> <span class="n">ENA_SCAM_SEL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

<span class="cm">/*      auto_loaded =  (RD_HARPOON(port+hp_autostart_3) &amp; (unsigned char)0x1F);</span>
<span class="cm">      auto_loaded |= AUTO_IMMED; */</span>
		<span class="n">auto_loaded</span> <span class="o">=</span> <span class="n">AUTO_IMMED</span><span class="p">;</span>

		<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="n">auto_loaded</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sres</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Hookup the correct CCB and handle the incoming messages.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sres</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">our_target</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">msgRetryCount</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currTar_Info</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>
		<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">),</span> <span class="p">(</span><span class="n">ENA_RESEL</span> <span class="o">|</span> <span class="n">ENA_SCAM_SEL</span><span class="p">));</span>

		<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_WN_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">BUS_FREE_ST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">BUS_FREE_ST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
		      <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">!=</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
						     <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								  <span class="n">Lun</span><span class="p">]]</span>
				    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">!=</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							     <span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">!=</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
							     <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>
					    <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">p_card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="mh">0x00</span><span class="p">);</span>

	<span class="n">our_target</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_select_id</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">];</span>

	<span class="n">msgRetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>

		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">];</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PHASE</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PHASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_SCSI_PHZ</span><span class="p">)</span> <span class="o">==</span> <span class="n">S_MSGI_PH</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">message</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="n">LUN_MASK</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">lun</span> <span class="o">=</span> <span class="n">message</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">LUN_MASK</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					     <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">==</span>
					    <span class="n">TAG_Q_TRYING</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span> <span class="o">!=</span>
						    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

							<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
							    <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
							     <span class="n">TarLUN_CA</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>	<span class="cm">/*Release the ACK for ID msg. */</span>

								<span class="n">message</span> <span class="o">=</span>
								    <span class="n">FPT_sfm</span>
								    <span class="p">(</span><span class="n">port</span><span class="p">,</span>
								     <span class="n">pCurrCard</span><span class="o">-&gt;</span>
								     <span class="n">currentSCCB</span><span class="p">);</span>
								<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">ACCEPT_MSG</span>
									    <span class="p">(</span><span class="n">port</span><span class="p">);</span>
								<span class="p">}</span>

								<span class="k">else</span>
									<span class="n">message</span>
									    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

								<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">!=</span>
								    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
									<span class="n">tag</span> <span class="o">=</span>
									    <span class="n">FPT_sfm</span>
									    <span class="p">(</span><span class="n">port</span><span class="p">,</span>
									     <span class="n">pCurrCard</span><span class="o">-&gt;</span>
									     <span class="n">currentSCCB</span><span class="p">);</span>

									<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
									    <span class="p">(</span><span class="n">tag</span><span class="p">))</span>
										<span class="n">message</span>
										    <span class="o">=</span>
										    <span class="mi">0</span><span class="p">;</span>
								<span class="p">}</span>

							<span class="p">}</span>
							<span class="cm">/*C.A. exists! */</span>
						<span class="p">}</span>
						<span class="cm">/*End Q cnt != 0 */</span>
					<span class="p">}</span>
					<span class="cm">/*End Tag cmds supported! */</span>
				<span class="p">}</span>
				<span class="cm">/*End valid ID message.  */</span>
				<span class="k">else</span> <span class="p">{</span>

					<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span>
			<span class="cm">/* End good id message. */</span>
			<span class="k">else</span> <span class="p">{</span>

				<span class="n">message</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span>
			       <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">PHASE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">))</span>
			       <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="p">;</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msgRetryCount</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msgRetryCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_SendMsg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SMPARITY</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_SendMsg</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SMDEV_RESET</span><span class="p">);</span>

				<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">our_target</span><span class="p">,</span> <span class="n">NARROW_SCSI</span><span class="p">,</span>
					    <span class="n">currTar_Info</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">].</span>
				    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">].</span>
					    <span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">].</span>
				    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">our_target</span><span class="p">].</span>
					    <span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">FPT_queueFlushTargSccb</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">our_target</span><span class="p">,</span>
						       <span class="n">SCCB_COMPLETE</span><span class="p">);</span>
				<span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">our_target</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
		    <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">lun</span><span class="p">]];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
				    <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">tag</span><span class="p">];</span>
				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
			    <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* During Abort Tag command, the target could have got re-selected</span>
<span class="cm">			   and completed the command. Check the select Q and remove the CCB</span>
<span class="cm">			   if it is in the Select Q */</span>
			<span class="n">FPT_queueFindSccb</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PHASE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_SendMsg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PHASE</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PHASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_SCSI_PHZ</span><span class="p">)</span> <span class="o">==</span> <span class="n">S_MSGO_PH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span> <span class="o">|</span> <span class="n">XFER_CNT_0</span><span class="p">));</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_BUS_EN</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMABORT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMDEV_RESET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMABORT_TAG</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span>
			       <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">BUS_FREE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sdecm</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Determine the proper response to the message from the</span>
<span class="cm"> *              target device.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sdecm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">CurrCard</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">CurrCard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">];</span>
	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMREST_DATA_PTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_NO_DATA_YET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_savedATC</span><span class="p">;</span>

			<span class="n">FPT_hostDataXferRestart</span><span class="p">(</span><span class="n">currSCCB</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMCMD_COMP</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_Q_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_TAG_Q_MASK</span><span class="p">;</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAG_Q_REJECT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMNO_OP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">&gt;=</span> <span class="n">SMIDENT</span><span class="p">)</span>
		 <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMINIT_RECOVERY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMREL_RECOVERY</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMREJECT</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_WN_ST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SYNC_TRYING</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">TAG_Q_TRYING</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">BUS_FREE</span><span class="p">);</span>

			<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)))</span>
			<span class="p">{</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">))</span> <span class="p">{</span>

					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span>
					    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">;</span>

					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
					    <span class="o">~</span><span class="n">EE_SYNC_MASK</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span>
					  <span class="n">SELECT_WN_ST</span><span class="p">))</span> <span class="p">{</span>

					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					     <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WIDE_ENABLED</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">WIDE_NEGOCIATED</span><span class="p">;</span>

					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
					    <span class="o">~</span><span class="n">EE_WIDE_SCSI</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					  <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">==</span>
					 <span class="n">TAG_Q_TRYING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span>
					    <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					     <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>
					     <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TAG_Q_REJECT</span><span class="p">;</span>

					<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_USE_CMD_Q</span><span class="p">;</span>
					<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
						    <span class="n">BUS_FREE</span><span class="p">);</span>
					<span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">CurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
				      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
				     <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								 <span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">F_USE_CMD_Q</span><span class="p">;</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)))</span>
			<span class="p">{</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMEXT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">FPT_shandem</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMIGNORWR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>	<span class="cm">/* ACK the RESIDUE MSG */</span>

		<span class="n">message</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">!=</span> <span class="n">SMPARITY</span><span class="p">)</span>
			<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PHASE_SEQUENCE_FAIL</span><span class="p">;</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMREJECT</span><span class="p">;</span>

		<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_shandem</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Decide what to do with the extended message.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_shandem</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">length</span><span class="p">,</span> <span class="n">message</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">pCurrSCCB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">message</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">pCurrSCCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMSYNC</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="n">FPT_stsyncn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMREJECT</span><span class="p">;</span>
					<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMWDTR</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="n">FPT_stwidn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMREJECT</span><span class="p">;</span>
					<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

					<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span>
						    <span class="n">DISCONNECT_START</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMREJECT</span><span class="p">;</span>
				<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">!=</span> <span class="n">SMPARITY</span><span class="p">)</span>
				<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">==</span> <span class="n">SMPARITY</span><span class="p">)</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sisyncn</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Read in a message byte from the SCSI bus, and check</span>
<span class="cm"> *              for a parity error.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_sisyncn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">syncFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SYNC_TRYING</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
			     <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
			      <span class="n">Sccb_idmsg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">DISC_PRIV</span><span class="p">)));</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">CMDPZ</span><span class="p">);</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMEXT</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x03</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMSYNC</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">EE_SYNC_20MB</span><span class="p">)</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
			 <span class="n">EE_SYNC_10MB</span><span class="p">)</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mi">25</span><span class="p">));</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
			 <span class="n">EE_SYNC_5MB</span><span class="p">)</span>

			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mi">50</span><span class="p">));</span>

		<span class="k">else</span>
			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mo">00</span><span class="p">));</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">RAT_OP</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">DEFAULT_OFFSET</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">syncFlag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
			      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_TRYING</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">CMD_ONLY_STRT</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">;</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EE_SYNC_MASK</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_stsyncn</span>
<span class="cm"> *</span>
<span class="cm"> * Description: The has sent us a Sync Nego message so handle it as</span>
<span class="cm"> *              necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_stsyncn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sync_msg</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">sync_reg</span><span class="p">,</span> <span class="n">our_sync_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="n">sync_msg</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sync_msg</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">==</span> <span class="n">SMPARITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">==</span> <span class="n">SMPARITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">EE_SYNC_20MB</span><span class="p">)</span>

		<span class="n">our_sync_msg</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* Setup our Message to 20mb/s */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">EE_SYNC_10MB</span><span class="p">)</span>

		<span class="n">our_sync_msg</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>	<span class="cm">/* Setup our Message to 10mb/s */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">EE_SYNC_5MB</span><span class="p">)</span>

		<span class="n">our_sync_msg</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* Setup our Message to 5mb/s */</span>
	<span class="k">else</span>

		<span class="n">our_sync_msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Message = Async */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&lt;</span> <span class="n">our_sync_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sync_msg</span> <span class="o">=</span> <span class="n">our_sync_msg</span><span class="p">;</span>	<span class="cm">/*if faster, then set to max. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">ASYNC</span><span class="p">)</span>
		<span class="n">sync_msg</span> <span class="o">=</span> <span class="n">ASYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">MAX_OFFSET</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MAX_OFFSET</span><span class="p">;</span>

	<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* Use 10MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* Use 6.6MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">38</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>	<span class="cm">/* Use 5MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* Use 4MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">62</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>	<span class="cm">/* Use 3.33MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* Use 2.85MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">87</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0xE0</span><span class="p">;</span>	<span class="cm">/* Use 2.5MB/s */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_msg</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">sync_reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Use ASYNC */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">WIDE_ENABLED</span><span class="p">)</span>

		<span class="n">sync_reg</span> <span class="o">|=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">else</span>

		<span class="n">sync_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">|</span> <span class="n">NARROW_SCSI</span><span class="p">);</span>

	<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">,</span> <span class="n">sync_reg</span><span class="p">,</span> <span class="n">currTar_Info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">|</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="n">FPT_sisyncr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sync_msg</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">|</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sisyncr</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Answer the targets sync message.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sisyncr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sync_pulse</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMEXT</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x03</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMSYNC</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">sync_pulse</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">RAT_OP</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>
	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT_1</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">CMD_ONLY_STRT</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">)))</span> <span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_siwidn</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Read in a message byte from the SCSI bus, and check</span>
<span class="cm"> *              for a parity error.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_siwidn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_WIDE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">WIDE_NEGOCIATED</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span>
			     <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
			      <span class="n">Sccb_idmsg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">DISC_PRIV</span><span class="p">)));</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">ID_MSG_STRT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">CMDPZ</span><span class="p">);</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMEXT</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMWDTR</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="n">RAT_OP</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SM16BIT</span><span class="p">));</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="o">+</span> <span class="n">SELCHK_STRT</span><span class="p">));</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_WIDE_MASK</span><span class="p">)</span> <span class="o">|</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">WIDE_ENABLED</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">=</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">TAR_WIDE_MASK</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">WIDE_NEGOCIATED</span><span class="p">);</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EE_WIDE_SCSI</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_stwidn</span>
<span class="cm"> *</span>
<span class="cm"> * Description: The has sent us a Wide Nego message so handle it as</span>
<span class="cm"> *              necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_stwidn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">width</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">==</span> <span class="n">SMPARITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">))</span>
		<span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="n">WIDE_ENABLED</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">NARROW_SCSI</span><span class="p">;</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIDE_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">currTar_Info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_WN_ST</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="n">WIDE_NEGOCIATED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
		    <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">SYNC_SUPPORTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">FPT_sisyncn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">SELECT_SN_ST</span><span class="p">;</span>
			<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">SM16BIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">SM8BIT</span><span class="p">;</span>

		<span class="n">FPT_siwidr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WIDE_NEGOCIATED</span> <span class="o">|</span> <span class="n">WIDE_ENABLED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_siwidr</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Answer the targets Wide nego message.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_siwidr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMEXT</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">SMWDTR</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="n">RAT_OP</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="n">width</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">SYNC_MSGS</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>
	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT_1</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">CMD_ONLY_STRT</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">)))</span> <span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sssyncv</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Write the desired value to the Sync Register for the</span>
<span class="cm"> *              ID specified.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sssyncv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_sync_value</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">p_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_0 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_2 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_3 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_5 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_6 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_7 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_8 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_9 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_10 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_11 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_12 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_13 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_14 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* hp_synctarg_15 */</span>

	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_synctarg_base</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">p_sync_value</span><span class="p">);</span>

	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="n">p_sync_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sresb</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Reset the desired card&#39;s SCSI bus.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sresb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsiID</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">G_INT_DISABLE</span><span class="p">));</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">,</span> <span class="n">SCSI_RST</span><span class="p">);</span>

	<span class="n">scsiID</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">TO_5ms</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">TIMEOUT</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">START_TO</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">,</span> <span class="n">ENA_SCAM_SEL</span><span class="p">);</span>

	<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">TO_5ms</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_mask</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">scsiID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scsiID</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">scsiID</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">,</span> <span class="n">NARROW_SCSI</span><span class="p">,</span> <span class="n">currTar_Info</span><span class="p">);</span>

		<span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">scanIndex</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">F_TAG_STARTED</span> <span class="o">|</span> <span class="n">F_HOST_XFER_ACT</span>
					     <span class="o">|</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">);</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">cmdCounter</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">tagQ_Lst</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">G_INT_DISABLE</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_ssenss</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup for the Auto Sense command.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_ssenss</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Save_CdbLen</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Save_Cdb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span> <span class="o">=</span> <span class="n">SIX_BYTE_CMD</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCSI_REQUEST_SENSE</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0xE0</span><span class="p">;</span>	<span class="cm">/*Keep LUN. */</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_AUTO_SENSE</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_SG_XFER</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">DISC_PRIV</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_MGRFlags</span> <span class="o">&amp;=</span> <span class="n">F_STATUSLOADED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sxfrp</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Transfer data into the bit bucket until the device</span>
<span class="cm"> *              decides to switch phase.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sxfrp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curr_phz</span><span class="p">;</span>

	<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span>
				      <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* If the Automation handled the end of the transfer then do not</span>
<span class="cm">	   match the phase or we will get out of sync with the ISR.       */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">XFER_CNT_0</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xfercnt_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">curr_phz</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">S_SCSI_PHZ</span><span class="p">;</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">XFER_CNT_0</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">curr_phz</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">curr_phz</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">S_SCSI_PHZ</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_phz</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SCSI_IOBIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">HOST_PORT</span> <span class="o">|</span> <span class="n">SCSI_INBIT</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_fifodata_0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">HOST_PORT</span> <span class="o">|</span> <span class="n">HOST_WRT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_fifodata_0</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* End of While loop for padding data I/O phase */</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">HOST_PORT</span> <span class="o">|</span> <span class="n">SCSI_INBIT</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_fifodata_0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_autostart_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">AUTO_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">ICMD_COMP</span> <span class="o">|</span> <span class="n">ITAR_DISC</span><span class="p">))</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span>
			       <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RSEL</span><span class="p">)))</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_schkdd</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Make sure data has been flushed from both FIFOs and abort</span>
<span class="cm"> *              the operations if necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_schkdd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">TimeOutLoop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sPhase</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">!=</span> <span class="n">DATA_OUT_ST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">!=</span> <span class="n">DATA_IN_ST</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_ODD_BALL_CNT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">+=</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_ODD_BALL_CNT</span><span class="p">;</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="mh">0x00</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">+=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span><span class="p">;</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PARITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PARITY_ERR</span><span class="p">;</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PARITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_ACK</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="n">TimeOutLoop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_offsetctr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x1F</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">TimeOutLoop</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mh">0x3000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sPhase</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">S_SCSI_PHZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_offsetctr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sPhase</span> <span class="o">==</span> <span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">S_DATAO_PH</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sPhase</span> <span class="o">==</span> <span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">S_DATAI_PH</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_ALL_XFERRED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_phaseDataIn</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_phaseDataOut</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
			      <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">ICMD_COMP</span> <span class="o">|</span> <span class="n">ITAR_DISC</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">AUTO_INT</span><span class="p">);</span>
				<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sinits</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup SCCB manager fields in this SCCB.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_sinits</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_sccb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span> <span class="o">&gt;=</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Lun</span> <span class="o">&gt;=</span> <span class="n">MAX_LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">SCATTER_GATHER_COMMAND</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESIDUAL_SG_COMMAND</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">=</span> <span class="n">F_SG_XFER</span><span class="p">;</span>
		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>

		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_ALL_XFERRED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">F_USE_CMD_Q</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TAG_Q_REJECT</span><span class="p">)</span>
			<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_USE_CMD_Q</span><span class="p">;</span>

		<span class="k">else</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">|=</span> <span class="n">TAG_Q_TRYING</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*      For !single SCSI device in system  &amp; device allow Disconnect</span>
<span class="cm">	or command is tag_q type then send Cmd with Disconnect Enable</span>
<span class="cm">	else send Cmd with Disconnect Disable */</span>

<span class="cm">/*</span>
<span class="cm">   if (((!(FPT_BL_Card[p_card].globalFlags &amp; F_SINGLE_DEVICE)) &amp;&amp;</span>
<span class="cm">      (currTar_Info-&gt;TarStatus &amp; TAR_ALLOW_DISC)) ||</span>
<span class="cm">      (currTar_Info-&gt;TarStatus &amp; TAG_Q_TRYING)) {</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_ALLOW_DISC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">SMIDENT</span> <span class="o">|</span> <span class="n">DISC_PRIV</span><span class="p">)</span> <span class="o">|</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_idmsg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SMIDENT</span> <span class="o">|</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_MGRFlags</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_savedATC</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">   p_sccb-&gt;SccbVirtDataPtr    = 0x00;</span>
<span class="cm">   p_sccb-&gt;Sccb_forwardlink   = NULL;</span>
<span class="cm">   p_sccb-&gt;Sccb_backlink      = NULL;</span>
<span class="cm"> */</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">BUS_FREE_ST</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_IN_PROCESS</span><span class="p">;</span>
	<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMNO_OP</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Phase Decode</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Determine the phase and call the appropriate function.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseDecode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phase_ref</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>

	<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="n">phase_ref</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">S_SCSI_PHZ</span><span class="p">);</span>

	<span class="n">phase</span> <span class="o">=</span> <span class="n">FPT_s_PhaseTbl</span><span class="p">[</span><span class="n">phase_ref</span><span class="p">];</span>

	<span class="p">(</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span> <span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>	<span class="cm">/* Call the correct phase func */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Data Out Phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Start up both the BusMaster and Xbow.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseDataOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Exit if No SCCB record */</span>
	<span class="p">}</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">DATA_OUT_ST</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">F_HOST_XFER_DIR</span> <span class="o">|</span> <span class="n">F_NO_DATA_YET</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">XFER_CNT_0</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_0</span><span class="p">,</span> <span class="p">(</span><span class="n">END_DATA</span> <span class="o">+</span> <span class="n">END_DATA_START</span><span class="p">));</span>

	<span class="n">FPT_dataXferProcessor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">SCCB_DATA_XFER_OUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">))</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_DATA_OVER_RUN</span><span class="p">;</span>

		<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span>
			<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Data In Phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Startup the BusMaster and the XBOW.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseDataIn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Exit if No SCCB record */</span>
	<span class="p">}</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">DATA_IN_ST</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">;</span>
	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_NO_DATA_YET</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">XFER_CNT_0</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_0</span><span class="p">,</span> <span class="p">(</span><span class="n">END_DATA</span> <span class="o">+</span> <span class="n">END_DATA_START</span><span class="p">));</span>

	<span class="n">FPT_dataXferProcessor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="n">SCCB_DATA_XFER_IN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">))</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_DATA_OVER_RUN</span><span class="p">;</span>

		<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">RESET</span><span class="p">)))</span>
			<span class="n">FPT_phaseDecode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Command Phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Load the CDB into the automation and start it up.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseCommand</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cdb_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PHASE_SEQUENCE_FAIL</span><span class="p">;</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span> <span class="o">=</span> <span class="n">SIX_BYTE_CMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="n">cdb_reg</span> <span class="o">=</span> <span class="n">p_port</span> <span class="o">+</span> <span class="n">CMD_STRT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span>

			<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">cdb_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>

		<span class="k">else</span>
			<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">cdb_reg</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">cdb_reg</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">CdbLength</span> <span class="o">!=</span> <span class="n">TWELVE_BYTE_CMD</span><span class="p">)</span>
		<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">cdb_reg</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_PORT</span><span class="p">));</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">COMMAND_ST</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">|</span> <span class="n">CMD_ONLY_STRT</span><span class="p">));</span>
	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Status phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Bring in the status and command complete message bytes</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseStatus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Start-up the automation to finish off this command and let the</span>
<span class="cm">	   isr handle the interrupt for command complete when it comes in.</span>
<span class="cm">	   We could wait here for the interrupt to be generated?</span>
<span class="cm">	 */</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_0</span><span class="p">,</span> <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">END_DATA_START</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Phase Message Out</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Send out our message (if we have one) and handle whatever</span>
<span class="cm"> *              else is involed.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseMsgOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">message</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span><span class="p">;</span>
		<span class="n">scsiID</span> <span class="o">=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMDEV_RESET</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">];</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSyncCtrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">FPT_sssyncv</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">,</span> <span class="n">NARROW_SCSI</span><span class="p">,</span> <span class="n">currTar_Info</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span>
			    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span>
			    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">&amp;=</span>
				    <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">FPT_queueFlushSccb</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">SCCB_COMPLETE</span><span class="p">);</span>
			<span class="n">FPT_SccbMgrTableInitTarget</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">scsiID</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">ABORT_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_COMPLETE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">!=</span>
			    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							      <span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scsiID</span><span class="p">].</span><span class="n">TarTagQ_Cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">&lt;</span> <span class="n">COMMAND_ST</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMNO_OP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_MGRFlags</span> <span class="o">|=</span> <span class="n">F_DEV_SELECTED</span><span class="p">;</span>

				<span class="n">FPT_ssel</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMABORT</span><span class="p">)</span>

				<span class="n">FPT_queueFlushSccb</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">SCCB_COMPLETE</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">message</span> <span class="o">=</span> <span class="n">SMABORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span> <span class="o">|</span> <span class="n">XFER_CNT_0</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_BUS_EN</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>

	<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMABORT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMDEV_RESET</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMABORT_TAG</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">BUS_FREE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
				     <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span>
				    <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
				     <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">TargID</span><span class="p">].</span>
					    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">TargID</span><span class="p">].</span>
					    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span>
						     <span class="n">currSCCB</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span>
				    <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMPARITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMNO_OP</span><span class="p">;</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPT_sxfrp</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Message In phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Bring in the message and determine what to do with it.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseMsgIn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">message</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_phaseChkFifo</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">message</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMDISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">message</span> <span class="o">==</span> <span class="n">SMSAVE_DATA_PTR</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">END_DATA_START</span><span class="p">));</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">message</span> <span class="o">=</span> <span class="n">FPT_sfm</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">FPT_sdecm</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">!=</span> <span class="n">SMPARITY</span><span class="p">)</span>
				<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_autostart_1</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">AUTO_IMMED</span> <span class="o">+</span> <span class="n">DISCONNECT_START</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Illegal phase</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Target switched to some illegal phase, so all we can do</span>
<span class="cm"> *              is report an error back to the host (if that is possible)</span>
<span class="cm"> *              and send an ABORT message to the misbehaving target.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseIllegal</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PHASE_SEQUENCE_FAIL</span><span class="p">;</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">ABORT_ST</span><span class="p">;</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsimsg</span> <span class="o">=</span> <span class="n">SMABORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ACCEPT_MSG_ATN</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Phase Check FIFO</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Make sure data has been flushed from both FIFOs and abort</span>
<span class="cm"> *              the operations if necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseChkFifo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xfercnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">DATA_IN_ST</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">+=</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span><span class="p">;</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PARITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PARITY_ERR</span><span class="p">;</span>
				<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PARITY</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

			<span class="n">FPT_dataXferProcessor</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">]);</span>

			<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIFO_EMPTY</span><span class="p">))</span>
			       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="n">BM_CMD_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*End Data In specific code. */</span>
	<span class="n">GET_XFER_CNT</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">xfercnt</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xfercnt_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span> <span class="o">+=</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">-</span> <span class="n">xfercnt</span><span class="p">);</span>

	<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="n">xfercnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PARITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PARITY_ERR</span><span class="p">;</span>
		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">PARITY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FPT_hostDataXferAbort</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fifowrite</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fiforead</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_xferstat</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">XFER_CNT_0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Phase Bus Free</span>
<span class="cm"> *</span>
<span class="cm"> * Description: We just went bus free so figure out if it was</span>
<span class="cm"> *              because of command complete or from a disconnect.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_phaseBusFree</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESET_COMMAND</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">currSCCB</span><span class="p">,</span>
					     <span class="n">p_card</span><span class="p">);</span>

			<span class="n">FPT_queueSearchSelect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">p_card</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">;</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">EE_SYNC_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_WN_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			     <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WIDE_ENABLED</span><span class="p">)</span> <span class="o">|</span> <span class="n">WIDE_NEGOCIATED</span><span class="p">;</span>

			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">EE_WIDE_SCSI</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_Q_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Make sure this is not a phony BUS_FREE.  If we were</span>
<span class="cm">			   reselected or if BUSY is NOT on then this is a</span>
<span class="cm">			   valid BUS FREE.  SRR Wednesday, 5/10/1995.     */</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RSEL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_TAG_Q_MASK</span><span class="p">;</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarStatus</span> <span class="o">|=</span> <span class="n">TAG_Q_REJECT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">=</span> <span class="n">BUS_FREE_ST</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_PHASE_SEQUENCE_FAIL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">currSCCB</span><span class="p">,</span>
					     <span class="n">p_card</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

	<span class="p">}</span>			<span class="cm">/*end if !=null */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Auto Load Default Map</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Load the Automation RAM with the defualt map values.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_autoLoadDefaultMap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">map_addr</span><span class="p">;</span>

	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
	<span class="n">map_addr</span> <span class="o">=</span> <span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_aramBase</span><span class="p">;</span>

	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0xC0</span><span class="p">));</span>	<span class="cm">/*ID MESSAGE */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">));</span>	<span class="cm">/*SIMPLE TAG QUEUEING MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="n">RAT_OP</span><span class="p">);</span>	<span class="cm">/*RESET ATTENTION */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">AMSG_OUT</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*TAG ID MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 0 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 1 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 2 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 3 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 4 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 5 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 6 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 7 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 8 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 9 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 10 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CDB BYTE 11 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPE_OP</span> <span class="o">+</span> <span class="n">ADATA_OUT</span> <span class="o">+</span> <span class="n">DINT</span><span class="p">));</span>	<span class="cm">/*JUMP IF DATA OUT */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">TCB_OP</span> <span class="o">+</span> <span class="n">FIFO_0</span> <span class="o">+</span> <span class="n">DI</span><span class="p">));</span>	<span class="cm">/*JUMP IF NO DATA IN FIFO */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/*This means AYNC DATA IN */</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_IDO_STRT</span><span class="p">));</span>	<span class="cm">/*STOP AND INTERRUPT */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPE_OP</span> <span class="o">+</span> <span class="n">ADATA_IN</span> <span class="o">+</span> <span class="n">DINT</span><span class="p">));</span>	<span class="cm">/*JUMP IF NOT DATA IN PHZ */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPN_OP</span> <span class="o">+</span> <span class="n">AMSG_IN</span> <span class="o">+</span> <span class="n">ST</span><span class="p">));</span>	<span class="cm">/*IF NOT MSG IN CHECK 4 DATA IN */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CRD_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">));</span>	<span class="cm">/*SAVE DATA PTR MSG? */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">NOT_EQ</span> <span class="o">+</span> <span class="n">DC</span><span class="p">));</span>	<span class="cm">/*GO CHECK FOR DISCONNECT MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MRR_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="n">D_AR1</span><span class="p">));</span>	<span class="cm">/*SAVE DATA PTRS MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPN_OP</span> <span class="o">+</span> <span class="n">AMSG_IN</span> <span class="o">+</span> <span class="n">ST</span><span class="p">));</span>	<span class="cm">/*IF NOT MSG IN CHECK DATA IN */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CRD_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">));</span>	<span class="cm">/*DISCONNECT MSG? */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">NOT_EQ</span> <span class="o">+</span> <span class="n">UNKNWN</span><span class="p">));</span>	<span class="cm">/*UKNKNOWN MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MRR_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="n">D_BUCKET</span><span class="p">));</span>	<span class="cm">/*XFER DISCONNECT MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_ITAR_DISC</span><span class="p">));</span>	<span class="cm">/*STOP AND INTERRUPT */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPN_OP</span> <span class="o">+</span> <span class="n">ASTATUS</span> <span class="o">+</span> <span class="n">UNKNWN</span><span class="p">));</span>	<span class="cm">/*JUMP IF NOT STATUS PHZ. */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MRR_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="n">D_AR0</span><span class="p">));</span>	<span class="cm">/*GET STATUS BYTE */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CPN_OP</span> <span class="o">+</span> <span class="n">AMSG_IN</span> <span class="o">+</span> <span class="n">CC</span><span class="p">));</span>	<span class="cm">/*ERROR IF NOT MSG IN PHZ */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CRD_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*CHECK FOR CMD COMPLETE MSG. */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">NOT_EQ</span> <span class="o">+</span> <span class="n">CC</span><span class="p">));</span>	<span class="cm">/*ERROR IF NOT CMD COMPLETE MSG. */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">MRR_OP</span> <span class="o">+</span> <span class="n">SDATA</span> <span class="o">+</span> <span class="n">D_BUCKET</span><span class="p">));</span>	<span class="cm">/*GET CMD COMPLETE MSG */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_ICMD_COMP</span><span class="p">));</span>	<span class="cm">/*END OF COMMAND */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_IUNKWN</span><span class="p">));</span>	<span class="cm">/*RECEIVED UNKNOWN MSG BYTE */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_INO_CC</span><span class="p">));</span>	<span class="cm">/*NO COMMAND COMPLETE AFTER STATUS */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_ITICKLE</span><span class="p">));</span>	<span class="cm">/*BIOS Tickled the Mgr */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_IRFAIL</span><span class="p">));</span>	<span class="cm">/*EXPECTED ID/TAG MESSAGES AND */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* DIDN&#39;T GET ONE */</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">CRR_OP</span> <span class="o">+</span> <span class="n">AR3</span> <span class="o">+</span> <span class="n">S_IDREG</span><span class="p">));</span>	<span class="cm">/* comp SCSI SEL ID &amp; AR3 */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">EQUAL</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">));</span>	<span class="cm">/*SEL ID OK then Conti. */</span>
	<span class="n">map_addr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">SSI_OP</span> <span class="o">+</span> <span class="n">SSI_INO_CC</span><span class="p">));</span>	<span class="cm">/*NO COMMAND COMPLETE AFTER STATUS */</span>

	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Auto Command Complete</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Post command back to host and find another command</span>
<span class="cm"> *              to execute.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_autoCmdCmplt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status_byte</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="n">status_byte</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_gp_reg_0</span><span class="p">);</span>

	<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarLUN_CA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span> <span class="o">!=</span> <span class="n">SSGOOD</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span> <span class="o">==</span> <span class="n">SSQ_FULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			       <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
				    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
					      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
					      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span>
				    <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								      <span class="n">Sccb_tag</span><span class="p">]</span>
					    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
					    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
						      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
						      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_MGRFlags</span> <span class="o">|=</span> <span class="n">F_STATUSLOADED</span><span class="p">;</span>

			<span class="n">FPT_queueSelectFail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">p_card</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_SN_ST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SYNC_SUPPORTED</span><span class="p">;</span>

			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">EE_SYNC_MASK</span><span class="p">;</span>
			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			       <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
				    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
					      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
					      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span>
				    <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								      <span class="n">Sccb_tag</span><span class="p">]</span>
					    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
					    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
						      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
						      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_scsistat</span> <span class="o">==</span> <span class="n">SELECT_WN_ST</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarStatus</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			     <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WIDE_ENABLED</span><span class="p">)</span> <span class="o">|</span> <span class="n">WIDE_NEGOCIATED</span><span class="p">;</span>

			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarEEValue</span> <span class="o">&amp;=</span>
			    <span class="o">~</span><span class="n">EE_WIDE_SCSI</span><span class="p">;</span>
			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
			       <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
				    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
					      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
					      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span>
				    <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								      <span class="n">Sccb_tag</span><span class="p">]</span>
					    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
					    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
						      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
						      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span> <span class="o">==</span> <span class="n">SSCHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_DO_RENEGO</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_SYNC_MASK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">TargID</span><span class="p">].</span>
					    <span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_SYNC_MASK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarEEValue</span> <span class="o">&amp;</span> <span class="n">EE_WIDE_SCSI</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">TargID</span><span class="p">].</span>
					    <span class="n">TarStatus</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TAR_WIDE_MASK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_AUTO_SENSE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ERROR</span><span class="p">;</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">=</span> <span class="n">status_byte</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status_byte</span> <span class="o">==</span> <span class="n">SSCHECK</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
				    <span class="n">TarLUN_CA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span> <span class="o">!=</span>
				    <span class="n">NO_AUTO_REQUEST_SENSE</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span> <span class="o">=</span>
						    <span class="mi">14</span><span class="p">;</span>

					<span class="n">FPT_ssenss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">]);</span>
					<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span>
					    <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
					      <span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span>
					     <span class="o">&amp;&amp;</span>
					     <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
					       <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
					       <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
					      <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
						    <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
						    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]</span> <span class="o">=</span>
						    <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
							<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
							    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
						<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">FPT_sccbMgrTbl</span>
							      <span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
							      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
							       <span class="n">TargID</span><span class="p">].</span>
							      <span class="n">LunDiscQ_Idx</span>
							      <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span>
						    <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">]</span>
						    <span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
						    <span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
							    <span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">FPT_BL_Card</span>
								    <span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
								    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
							<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
							    <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								      <span class="n">Sccb_tag</span><span class="p">]</span>
							    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
							    <span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
								<span class="n">FPT_BL_Card</span>
								    <span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
								    <span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
							<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
							    <span class="n">discQ_Tbl</span>
							    <span class="p">[</span><span class="n">FPT_sccbMgrTbl</span>
							     <span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								      <span class="n">TargID</span><span class="p">].</span>
							     <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>
							    <span class="nb">NULL</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span>
	      <span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">))</span>
		<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">currSCCB</span><span class="o">-&gt;</span>
								    <span class="n">Lun</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span> <span class="n">currSCCB</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SHORT_WAIT   0x0000000F</span>
<span class="cp">#define LONG_WAIT    0x0000FFFFL</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Data Transfer Processor</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This routine performs two tasks.</span>
<span class="cm"> *              (1) Start data transfer by calling HOST_DATA_XFER_START</span>
<span class="cm"> *              function.  Once data transfer is started, (2) Depends</span>
<span class="cm"> *              on the type of data transfer mode Scatter/Gather mode</span>
<span class="cm"> *              or NON Scatter/Gather mode.  In NON Scatter/Gather mode,</span>
<span class="cm"> *              this routine checks Sccb_MGRFlag (F_HOST_XFER_ACT bit) for</span>
<span class="cm"> *              data transfer done.  In Scatter/Gather mode, this routine</span>
<span class="cm"> *              checks bus master command complete and dual rank busy</span>
<span class="cm"> *              bit to keep chaining SC transfer command.  Similarly,</span>
<span class="cm"> *              in Scatter/Gather mode, it checks Sccb_MGRFlag</span>
<span class="cm"> *              (F_HOST_XFER_ACT bit) for data transfer done.</span>
<span class="cm"> *              </span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_dataXferProcessor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_SG_XFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SG_BUF_CNT</span><span class="p">;</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">;</span>

		<span class="n">FPT_busMstrSGDataXferStart</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_HOST_XFER_ACT</span><span class="p">;</span>

			<span class="n">FPT_busMstrDataXferStart</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">currSCCB</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: BusMaster Scatter Gather Data Transfer Start</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_busMstrSGDataXferStart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pcurrSCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tmpSGCnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sg_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">HOST_RD_CMD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">HOST_WRT_CMD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmpSGCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sg_index</span> <span class="o">=</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span><span class="p">;</span>
	<span class="n">reg_offset</span> <span class="o">=</span> <span class="n">hp_aramBase</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">SGRAM_ARAM</span> <span class="o">|</span> <span class="n">SCATTER_EN</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">sg_count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">SG_BUF_CNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">SG_ELEMENT_SIZE</span><span class="p">)</span> <span class="o">&lt;</span>
		<span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">tmpSGCnt</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">count</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">)</span> <span class="o">+</span>
			   <span class="p">(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">)</span> <span class="o">+</span>
			 <span class="p">((</span><span class="n">sg_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">sg_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">addr</span> <span class="o">+=</span>
			    <span class="p">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFFL</span><span class="p">)</span> <span class="o">-</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0xFF000000L</span><span class="p">)</span> <span class="o">|</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span><span class="p">;</span>

			<span class="n">tmpSGCnt</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFFL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">WR_HARP32</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">reg_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">WR_HARP32</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">reg_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">&amp;=</span> <span class="mh">0xFF000000L</span><span class="p">;</span>
		<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sg_count</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>			<span class="cm">/*End While */</span>

	<span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="n">tmpSGCnt</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sg_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">sg_count</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WR_HARP32</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">hp_xfercnt_0</span><span class="p">,</span> <span class="n">tmpSGCnt</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">DMA_PORT</span> <span class="o">|</span> <span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">SCSI_INBIT</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">S_DATAI_PH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_synctarg_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmpSGCnt</span> <span class="o">&amp;</span> <span class="mh">0x000000001</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_ODD_BALL_CNT</span><span class="p">;</span>
			<span class="n">tmpSGCnt</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">WR_HARP32</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">hp_xfercnt_0</span><span class="p">,</span> <span class="n">tmpSGCnt</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">DMA_PORT</span> <span class="o">|</span> <span class="n">DMA_RD</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">S_DATAO_PH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">i</span> <span class="o">|</span> <span class="n">SCATTER_EN</span><span class="p">));</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: BusMaster Data Transfer Start</span>
<span class="cm"> *</span>
<span class="cm"> * Description: </span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_busMstrDataXferStart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pcurrSCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_AUTO_SENSE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span> <span class="o">+</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">SensePointer</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">RequestSenseLength</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">HP_SETUP_ADDR_CNT</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">DMA_PORT</span> <span class="o">|</span> <span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">SCSI_INBIT</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">S_DATAI_PH</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xfer_cmd</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">XFER_DMA_HOST</span> <span class="o">|</span> <span class="n">XFER_HOST_AUTO</span> <span class="o">|</span> <span class="n">XFER_DMA_8BIT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">SCSI_PORT</span> <span class="o">|</span> <span class="n">DMA_PORT</span> <span class="o">|</span> <span class="n">DMA_RD</span><span class="p">));</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">S_DATAO_PH</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_xfer_cmd</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">XFER_HOST_DMA</span> <span class="o">|</span> <span class="n">XFER_HOST_AUTO</span> <span class="o">|</span> <span class="n">XFER_DMA_8BIT</span><span class="p">));</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: BusMaster Timeout Handler</span>
<span class="cm"> *</span>
<span class="cm"> * Description: This function is called after a bus master command busy time</span>
<span class="cm"> *               out is detected.  This routines issue halt state machine</span>
<span class="cm"> *               with a software time out for command busy.  If command busy</span>
<span class="cm"> *               is still asserted at the end of the time out, it issues</span>
<span class="cm"> *               hard abort with another software time out.  It hard abort</span>
<span class="cm"> *               command busy is also time out, it&#39;ll just give up.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_busMstrTimeOut</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">LONG_WAIT</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="n">HALT_MACH</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMD_ABORTED</span><span class="p">))</span>
	       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="n">HARD_ABORT</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">LONG_WAIT</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span>
		       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">);</span>	<span class="cm">/*Clear command complete */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Host Data Transfer Abort</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Abort any in progress transfer.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_hostDataXferAbort</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pCurrSCCB</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remain_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_ptr</span><span class="p">;</span>

	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_HOST_XFER_ACT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_AUTO_SENSE</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_CMD_COMPL</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">FLUSH_XFER_CNTR</span><span class="p">));</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">LONG_WAIT</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="n">FLUSH_XFER_CNTR</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">FPT_busMstrTimeOut</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>

						<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
						    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">INT_EXT_STATUS</span><span class="p">)</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="n">BAD_EXT_STATUS</span><span class="p">)</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span>
						    <span class="mh">0x00</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
							    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
						<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_SG_XFER</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="n">SCATTER_EN</span><span class="p">));</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_sg_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

			<span class="n">sg_ptr</span> <span class="o">=</span> <span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">+</span> <span class="n">SG_BUF_CNT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sg_ptr</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">/</span>
					   <span class="n">SG_ELEMENT_SIZE</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">sg_ptr</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">/</span>
						   <span class="n">SG_ELEMENT_SIZE</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">remain_cnt</span> <span class="o">=</span> <span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">remain_cnt</span> <span class="o">&lt;</span> <span class="mh">0x01000000L</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">sg_ptr</span><span class="o">--</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">remain_cnt</span> <span class="o">&gt;</span>
				    <span class="p">(</span><span class="kt">unsigned</span>
				     <span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span>
					      <span class="n">DataPointer</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg_ptr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>

					<span class="n">remain_cnt</span> <span class="o">-=</span>
					    <span class="p">(</span><span class="kt">unsigned</span>
					     <span class="kt">long</span><span class="p">)(</span><span class="o">*</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
						      <span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">)</span> <span class="o">+</span>
						     <span class="p">(</span><span class="n">sg_ptr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
				<span class="p">}</span>

				<span class="k">else</span> <span class="p">{</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">remain_cnt</span> <span class="o">&lt;</span> <span class="mh">0x01000000L</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span> <span class="n">remain_cnt</span><span class="p">;</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">sg_ptr</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">sg_ptr</span> <span class="o">*</span> <span class="n">SG_ELEMENT_SIZE</span><span class="p">)</span> <span class="o">==</span>
				    <span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">remain_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span>
					    <span class="n">F_ALL_XFERRED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
					    <span class="n">SCCB_GROSS_FW_ERR</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_HOST_XFER_DIR</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">FPT_busMstrTimeOut</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">INT_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="n">BAD_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span>
						    <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

							<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
							    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fifo_cnt</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">BM_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">timeout</span> <span class="o">=</span> <span class="n">SHORT_WAIT</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">BM_CMD_BUSY</span><span class="p">)</span>
				       <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_fifo_cnt</span><span class="p">))</span> <span class="o">&gt;=</span>
					   <span class="n">BM_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">FLUSH_XFER_CNTR</span><span class="p">));</span>

				<span class="n">timeout</span> <span class="o">=</span> <span class="n">LONG_WAIT</span><span class="p">;</span>

				<span class="k">while</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">}</span>

				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="o">~</span><span class="n">FLUSH_XFER_CNTR</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
						    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">FPT_busMstrTimeOut</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">BAD_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
						    <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">timeout</span> <span class="o">=</span> <span class="n">LONG_WAIT</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span>
			       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BM_CMD_BUSY</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">FPT_busMstrTimeOut</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_ext_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BAD_EXT_STATUS</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_BM_ERR</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_SG_XFER</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="n">SCATTER_EN</span><span class="p">));</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_sg_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

			<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">+=</span> <span class="n">SG_BUF_CNT</span><span class="p">;</span>

			<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">*</span>
					    <span class="n">SG_ELEMENT_SIZE</span><span class="p">)</span> <span class="o">&gt;=</span>
			    <span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_ALL_XFERRED</span><span class="p">;</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">/</span>
						     <span class="n">SG_ELEMENT_SIZE</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_AUTO_SENSE</span><span class="p">))</span>

				<span class="n">pCurrSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">|=</span> <span class="n">F_ALL_XFERRED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_int_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">INT_CMD_COMPL</span> <span class="o">|</span> <span class="n">SCSI_INTERRUPT</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Host Data Transfer Restart</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Reset the available count due to a restore data</span>
<span class="cm"> *              pointers message.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_hostDataXferRestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sg_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_SG_XFER</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sg_index</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>	<span class="cm">/*Index by long words into sg list. */</span>
		<span class="n">data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*Running count of SG xfer counts. */</span>

		<span class="n">sg_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">&lt;</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data_count</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">sg_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_count</span> <span class="o">==</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span> <span class="o">=</span>
			    <span class="n">data_count</span> <span class="o">-</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">sg_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferCnt</span> <span class="o">=</span>
		    <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">-</span> <span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scini</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup all data structures necessary for SCAM selection.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scini</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_our_id</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_power_up</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">loser</span><span class="p">,</span> <span class="n">assigned_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ScamFlg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">currCard</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>

	<span class="n">currCard</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">];</span>
	<span class="n">p_port</span> <span class="o">=</span> <span class="n">currCard</span><span class="o">-&gt;</span><span class="n">ioPort</span><span class="p">;</span>
	<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="n">currCard</span><span class="o">-&gt;</span><span class="n">pNvRamInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ScamFlg</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamConf</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niSysConf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ScamFlg</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SCAM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span>
		     <span class="kt">char</span><span class="p">)(</span><span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="p">(</span><span class="n">SYSTEM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>	<span class="cm">/* check if reset bus in AutoSCSI parameter set */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">FPT_inisci</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">p_port</span><span class="p">,</span> <span class="n">p_our_id</span><span class="p">);</span>

	<span class="cm">/* Force to wait 1 sec after SCSI bus reset. Some SCAM device FW</span>
<span class="cm">	   too slow to return to SCAM selection */</span>

	<span class="cm">/* if (p_power_up)</span>
<span class="cm">	   FPT_Wait1Second(p_port);</span>
<span class="cm">	   else</span>
<span class="cm">	   FPT_Wait(p_port, TO_250ms); */</span>

	<span class="n">FPT_Wait1Second</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_LEVEL2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FPT_scarb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">INIT_SELTD</span><span class="p">)))</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="n">FPT_scsel</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SYNC_PTRN</span><span class="p">);</span>
			<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">DOM_MSTR</span><span class="p">);</span>
			<span class="n">loser</span> <span class="o">=</span>
			    <span class="n">FPT_scsendi</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loser</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">);</span>

		<span class="n">FPT_scbusf</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">p_power_up</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">loser</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">FPT_sresb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">TO_250ms</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FPT_scarb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">INIT_SELTD</span><span class="p">)))</span> <span class="p">{</span>
			<span class="p">}</span>

			<span class="n">FPT_scsel</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SYNC_PTRN</span><span class="p">);</span>
				<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">DOM_MSTR</span><span class="p">);</span>
				<span class="n">loser</span> <span class="o">=</span>
				    <span class="n">FPT_scsendi</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span>
						<span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loser</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">);</span>

			<span class="n">FPT_scbusf</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="n">loser</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loser</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_ASSIGNED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">ID_UNASSIGNED</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">ID_UNUSED</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scsell</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">LEGACY</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						     <span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
						    <span class="o">||</span> <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
							<span class="n">id_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xFA</span><span class="p">))</span> <span class="p">{</span>

							<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
							    <span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
							<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
							    <span class="n">id_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
								<span class="n">currCard</span><span class="o">-&gt;</span>
								    <span class="n">globalFlags</span>
								    <span class="o">|=</span>
								    <span class="n">F_UPDATE_EEPROM</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">FPT_sresb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">p_card</span><span class="p">);</span>
			<span class="n">FPT_Wait1Second</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FPT_scarb</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">INIT_SELTD</span><span class="p">)))</span> <span class="p">{</span>
			<span class="p">}</span>
			<span class="n">FPT_scsel</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
			<span class="n">FPT_scasid</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">p_port</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">loser</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SLV_TYPE_CODE0</span><span class="p">;</span>
		<span class="n">assigned_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">FPT_scwtsel</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SYNC_PTRN</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">}</span>

			<span class="n">i</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ASSIGN_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span>
				    <span class="p">(</span><span class="n">FPT_scsendi</span>
				     <span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scvalq</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">k</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scvalq</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">currCard</span><span class="o">-&gt;</span><span class="n">ourId</span> <span class="o">=</span>
							    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">i</span>
									     <span class="o">&lt;&lt;</span>
									     <span class="mi">3</span><span class="p">)</span>
							     <span class="o">+</span>
							     <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span>
							      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mi">7</span><span class="p">))</span>
							    <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>
							    <span class="mh">0x3F</span><span class="p">;</span>
							<span class="n">FPT_inisci</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span>
								   <span class="n">p_port</span><span class="p">,</span>
								   <span class="n">p_our_id</span><span class="p">);</span>
							<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">currCard</span><span class="o">-&gt;</span>
								     <span class="n">ourId</span><span class="p">].</span>
							    <span class="n">state</span> <span class="o">=</span> <span class="n">ID_ASSIGNED</span><span class="p">;</span>
							<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">currCard</span><span class="o">-&gt;</span>
								     <span class="n">ourId</span><span class="p">].</span>
							    <span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
							    <span class="o">=</span> <span class="n">SLV_TYPE_CODE0</span><span class="p">;</span>
							<span class="n">assigned_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">SET_P_FLAG</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FPT_scsendi</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span>
						  <span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
					<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span>
					    <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">assigned_id</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CFG_CMPLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FPT_scbusf</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">currCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_UPDATE_EEPROM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_scsavdi</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">p_port</span><span class="p">);</span>
			<span class="n">currCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">F_UPDATE_EEPROM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   for (i=0,k=0; i &lt; MAX_SCSI_TAR; i++)</span>
<span class="cm">      {</span>
<span class="cm">      if ((FPT_scamInfo[i].state == ID_ASSIGNED) ||</span>
<span class="cm">         (FPT_scamInfo[i].state == LEGACY))</span>
<span class="cm">         k++;</span>
<span class="cm">      }</span>

<span class="cm">   if (k==2)</span>
<span class="cm">      currCard-&gt;globalFlags |= F_SINGLE_DEVICE;</span>
<span class="cm">   else</span>
<span class="cm">      currCard-&gt;globalFlags &amp;= ~F_SINGLE_DEVICE;</span>
<span class="cm">*/</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scarb</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Gain control of the bus and wait SCAM select time (250ms)</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FPT_scarb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_sel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_sel_type</span> <span class="o">==</span> <span class="n">INIT_SELTD</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCSI_SEL</span> <span class="o">|</span> <span class="n">SCSI_BSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_SEL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">!=</span> <span class="mo">00</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCSI_BSY</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_SEL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="n">SCSI_BSY</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCSI_SEL</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">!=</span> <span class="mo">00</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="o">~</span><span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">SCSI_SEL</span><span class="p">)));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">)</span>
					   <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACTdeassert</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">,</span> <span class="n">SCAM_EN</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_BUS_EN</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCSI_MSG</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span>
					 <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_BSY</span><span class="p">));</span>

	<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">TO_250ms</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scbusf</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Release the SCSI bus and disable SCAM selection.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scbusf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">G_INT_DISABLE</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCSI_BUS_EN</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">)</span>
					   <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCAM_EN</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">)</span>
					   <span class="o">|</span> <span class="n">ACTdeassert</span><span class="p">));</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="p">(</span><span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">AUTO_INT</span> <span class="o">|</span> <span class="n">SCAM_SEL</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">G_INT_DISABLE</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scasid</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Assign an ID to all the SCAM devices.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scasid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp_id_string</span><span class="p">[</span><span class="n">ID_STRING_LENGTH</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">scam_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">crcBytes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pCrcBytes</span><span class="p">;</span>

	<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">pNvRamInfo</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp_id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SYNC_PTRN</span><span class="p">);</span>
		<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ASSIGN_ID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FPT_sciso</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pCrcBytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">crcBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="o">*</span><span class="n">pCrcBytes</span> <span class="o">=</span> <span class="n">FPT_CalcCrc16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">crcBytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_CalcLrc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">temp_id_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">crcBytes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">temp_id_string</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crcBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">temp_id_string</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">crcBytes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
					<span class="n">temp_id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">FPT_scmachid</span><span class="p">(</span><span class="n">p_card</span><span class="p">,</span> <span class="n">temp_id_string</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CLR_PRIORITY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">MISC_CODE</span><span class="p">);</span>
				<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">CLR_P_FLAG</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*Not the last ID yet. */</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">NO_ID_AVAIL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
					<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ID_0_7</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ID_8_F</span><span class="p">);</span>

				<span class="n">scam_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x07</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">))</span>
						<span class="n">scam_id</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/*Count number of zeros in DB0-3. */</span>

				<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">scam_id</span><span class="p">);</span>

				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*Not the last ID yet. */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>			<span class="cm">/*End while */</span>

	<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SYNC_PTRN</span><span class="p">);</span>
	<span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">CFG_CMPLT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scsel</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Select all the SCAM devices.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scsel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="n">SCSI_SEL</span><span class="p">);</span>
	<span class="n">FPT_scwiros</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SCSI_MSG</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_SEL</span> <span class="o">|</span> <span class="n">SCSI_BSY</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">SCSI_SEL</span> <span class="o">|</span> <span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">SCSI_IOBIT</span> <span class="o">|</span> <span class="n">SCSI_CD</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">))));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">SCSI_IOBIT</span> <span class="o">|</span> <span class="n">SCSI_CD</span><span class="p">));</span>
	<span class="n">FPT_scwiros</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">SCSI_SEL</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span>
	<span class="n">FPT_scwirod</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">SCSI_SEL</span> <span class="o">|</span> <span class="n">SCSI_BSY</span> <span class="o">|</span> <span class="n">SCSI_IOBIT</span> <span class="o">|</span> <span class="n">SCSI_CD</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scxferc</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Handshake the p_data (DB4-0) across the bus.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_scxferc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curr_data</span><span class="p">,</span> <span class="n">ret_data</span><span class="p">;</span>

	<span class="n">curr_data</span> <span class="o">=</span> <span class="n">p_data</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>	<span class="cm">/*Start with DB7 &amp; DB5 asserted. */</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">curr_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">FPT_scwirod</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>	<span class="cm">/*Wait for DB7 to be released. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span> <span class="p">;</span>

	<span class="n">ret_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x1F</span><span class="p">);</span>

	<span class="n">curr_data</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">curr_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">FPT_scwirod</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>	<span class="cm">/*Wait for DB5 to be released. */</span>

	<span class="n">curr_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>	<span class="cm">/*Release data bits */</span>
	<span class="n">curr_data</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">curr_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">,</span> <span class="n">curr_data</span><span class="p">);</span>

	<span class="n">FPT_scwirod</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">));</span>	<span class="cm">/*Wait for DB6 to be released. */</span>

	<span class="k">return</span> <span class="n">ret_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scsendi</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Transfer our Identification string to determine if we</span>
<span class="cm"> *              will be the dominant master.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_scsendi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ret_data</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">bit_cnt</span><span class="p">,</span> <span class="n">defer</span><span class="p">;</span>

	<span class="n">defer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte_cnt</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">byte_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bit_cnt</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">bit_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit_cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">defer</span><span class="p">)</span>
				<span class="n">ret_data</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mo">00</span><span class="p">);</span>

			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="n">byte_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bit_cnt</span><span class="p">)</span>

				<span class="n">ret_data</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mo">02</span><span class="p">);</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="n">ret_data</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mo">01</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mo">02</span><span class="p">)</span>
					<span class="n">defer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/*End of isolation stage, we won! */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mh">0x1C</span><span class="p">)</span>
				<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">defer</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)))</span>
				<span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/*End of isolation stage, we lost. */</span>

		<span class="p">}</span>		<span class="cm">/*bit loop */</span>

	<span class="p">}</span>			<span class="cm">/*byte loop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">defer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/*We lost */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*We WON! Yeeessss! */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_sciso</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Transfer the Identification string.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_sciso</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ret_data</span><span class="p">,</span> <span class="n">the_data</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">bit_cnt</span><span class="p">;</span>

	<span class="n">the_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte_cnt</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">byte_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bit_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit_cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">bit_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ret_data</span> <span class="o">=</span> <span class="n">FPT_scxferc</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span>
				<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="k">else</span> <span class="p">{</span>

				<span class="n">the_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">the_data</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ret_data</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">				if(bit_cnt != 0 || bit_cnt != 8)</span>
<span class="cm">				{</span>
<span class="cm">					byte_cnt = 0;</span>
<span class="cm">					bit_cnt = 0;</span>
<span class="cm">					FPT_scxferc(p_port, SYNC_PTRN);</span>
<span class="cm">					FPT_scxferc(p_port, ASSIGN_ID);</span>
<span class="cm">					continue;</span>
<span class="cm">				}</span>
<span class="cm">*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">byte_cnt</span><span class="p">)</span>
					<span class="k">return</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>		<span class="cm">/*bit loop */</span>

		<span class="n">p_id_string</span><span class="p">[</span><span class="n">byte_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_data</span><span class="p">;</span>

	<span class="p">}</span>			<span class="cm">/*byte loop */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scwirod</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Sample the SCSI data bus making sure the signal has been</span>
<span class="cm"> *              deasserted for the correct number of consecutive samples.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scwirod</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsidata_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">p_data_bit</span><span class="p">)</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">else</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scwiros</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Sample the SCSI Signal lines making sure the signal has been</span>
<span class="cm"> *              deasserted for the correct number of consecutive samples.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scwiros</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_data_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">p_data_bit</span><span class="p">)</span>

			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">else</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scvalq</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Make sure we received a valid data byte.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_scvalq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_quintet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mh">0x08</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_quintet</span> <span class="o">&amp;</span> <span class="n">count</span><span class="p">))</span>
			<span class="n">p_quintet</span> <span class="o">-=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_quintet</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scsell</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Select the specified device ID using a selection timeout</span>
<span class="cm"> *              less than 4ms.  If somebody responds then it is a legacy</span>
<span class="cm"> *              drive and this ID must be marked as such.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_scsell</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">targ_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">G_INT_DISABLE</span><span class="p">));</span>

	<span class="n">ARAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCAM_TIMER</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">TO_4ms</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">p_port</span> <span class="o">+</span> <span class="n">CMD_STRT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p_port</span> <span class="o">+</span> <span class="n">CMD_STRT</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">MPM_OP</span> <span class="o">+</span> <span class="n">ACOMMAND</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">WRW_HARPOON</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">BRH_OP</span> <span class="o">+</span> <span class="n">ALWAYS</span> <span class="o">+</span> <span class="n">NP</span><span class="p">));</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">RESET</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">SEL</span> <span class="o">|</span> <span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_select_id</span><span class="p">,</span> <span class="n">targ_id</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span> <span class="n">SCSI_PORT</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_autostart_3</span><span class="p">,</span> <span class="p">(</span><span class="n">SELECT</span> <span class="o">|</span> <span class="n">CMD_ONLY_STRT</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">,</span> <span class="p">(</span><span class="n">SEL_TAR</span> <span class="o">|</span> <span class="n">ENA_RESEL</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="p">(</span><span class="n">RESET</span> <span class="o">|</span> <span class="n">PROG_HLT</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">)))</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RESET</span><span class="p">)</span>
		<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">TO_250ms</span><span class="p">);</span>

	<span class="n">DISABLE_AUTO</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCAM_TIMER</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">TO_290ms</span><span class="p">);</span>

	<span class="n">SGRAM_ACCESS</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RESET</span> <span class="o">|</span> <span class="n">TIMEOUT</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">RESET</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span> <span class="n">SEL</span> <span class="o">|</span> <span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">PHASE</span><span class="p">));</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="n">G_INT_DISABLE</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*No legacy device */</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">BUS_FREE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_REQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">SCSI_ACK</span> <span class="o">+</span> <span class="n">S_ILL_PH</span><span class="p">));</span>
				<span class="n">ACCEPT_MSG</span><span class="p">(</span><span class="n">p_port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT_1</span><span class="p">);</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="n">G_INT_DISABLE</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*Found one of them oldies! */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scwtsel</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Wait to be selected by another SCAM initiator.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scwtsel</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SCAM_SEL</span><span class="p">))</span> <span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_inisci</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup the data Structure with the info from the EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_inisci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_our_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvram_info</span> <span class="o">*</span><span class="n">pCurrNvRam</span><span class="p">;</span>

	<span class="n">pCurrNvRam</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">pNvRamInfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI_CARD</span><span class="p">)</span>
		<span class="n">max_id</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">else</span>
		<span class="n">max_id</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrNvRam</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">pCurrNvRam</span><span class="o">-&gt;</span><span class="n">niScamTbl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x00</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_UNUSED</span><span class="p">;</span>	<span class="cm">/*Default to unused ID. */</span>
			<span class="k">else</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_UNASSIGNED</span><span class="p">;</span>	<span class="cm">/*Default to unassigned ID. */</span>

		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ee_data</span> <span class="o">=</span>
				    <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span>
						   <span class="p">(</span><span class="kt">unsigned</span>
						    <span class="kt">short</span><span class="p">)((</span><span class="n">EE_SCAMBASE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
							   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">i</span> <span class="o">*</span>
									    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">ID_STRING_LENGTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">k</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)));</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ee_data</span><span class="p">;</span>
				<span class="n">ee_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ee_data</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span>

				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_UNUSED</span><span class="p">;</span>	<span class="cm">/*Default to unused ID. */</span>

			<span class="k">else</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_UNASSIGNED</span><span class="p">;</span>	<span class="cm">/*Default to unassigned ID. */</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">p_our_id</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">FPT_scamHAString</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scmachid</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Match the Device ID string with our values stored in</span>
<span class="cm"> *              the EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_scmachid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_id_string</span><span class="p">[])</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">match</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
				<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_ASSIGNED</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">p_id_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x1F</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">match</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">ID_UNUSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">p_id_string</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_ASSIGNED</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">pNvRamInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span>
				    <span class="n">F_UPDATE_EEPROM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">match</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">match</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
				<span class="n">match</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">match</span> <span class="o">=</span> <span class="n">MAX_SCSI_TAR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">CLR_PRIORITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_SCSI_TAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">p_id_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mh">0x1F</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">match</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">ID_UNASSIGNED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">p_id_string</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
			<span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">match</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">ID_ASSIGNED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">pNvRamInfo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">|=</span>
				    <span class="n">F_UPDATE_EEPROM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">match</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">match</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_id_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
				<span class="n">match</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">match</span> <span class="o">=</span> <span class="n">MAX_SCSI_TAR</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NO_ID_AVAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_scsavdi</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Save off the device SCAM ID strings.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_scsavdi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_data</span><span class="p">,</span> <span class="n">sum_data</span><span class="p">;</span>

	<span class="n">sum_data</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EE_SCAMBASE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum_data</span> <span class="o">+=</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Enable write access to the EEPROM */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI_CARD</span><span class="p">)</span>
		<span class="n">max_id</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="k">else</span>
		<span class="n">max_id</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ee_data</span> <span class="o">=</span> <span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">ee_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">ee_data</span> <span class="o">|=</span> <span class="n">FPT_scamInfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_string</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">sum_data</span> <span class="o">+=</span> <span class="n">ee_data</span><span class="p">;</span>
			<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ee_data</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">EE_SCAMBASE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
							 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">i</span> <span class="o">*</span>
									  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">ID_STRING_LENGTH</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">k</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">sum_data</span><span class="p">,</span> <span class="n">EEPROM_CHECK_SUM</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Turn off write access */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_XbowInit</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Setup the Xbow for normal operation.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_XbowInit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ScamFlg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">i</span> <span class="o">|</span> <span class="n">G_INT_DISABLE</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_portctrl_1</span><span class="p">,</span> <span class="n">HOST_MODE8</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">,</span> <span class="p">(</span><span class="n">DMA_RESET</span> <span class="o">|</span> <span class="n">HPSCSI_RESET</span> <span class="o">|</span> <span class="n">PROG_RESET</span> <span class="o">|</span>
					 <span class="n">FIFO_CLR</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsireset</span><span class="p">,</span> <span class="n">SCSI_INI</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsisig</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/*  Clear any signals we might */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">,</span> <span class="n">ENA_SCAM_SEL</span><span class="p">);</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">CLR_ALL_INT</span><span class="p">);</span>

	<span class="n">FPT_default_intena</span> <span class="o">=</span> <span class="n">RESET</span> <span class="o">|</span> <span class="n">RSEL</span> <span class="o">|</span> <span class="n">PROG_HLT</span> <span class="o">|</span> <span class="n">TIMEOUT</span> <span class="o">|</span>
	    <span class="n">BUS_FREE</span> <span class="o">|</span> <span class="n">XFER_CNT_0</span> <span class="o">|</span> <span class="n">AUTO_INT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ScamFlg</span> <span class="o">&amp;</span> <span class="n">SCAM_LEVEL2</span><span class="p">))</span>
		<span class="n">FPT_default_intena</span> <span class="o">|=</span> <span class="n">SCAM_SEL</span><span class="p">;</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_intena</span><span class="p">),</span> <span class="n">FPT_default_intena</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">TO_290ms</span><span class="p">);</span>

	<span class="cm">/* Turn on SCSI_MODE8 for narrow cards to fix the</span>
<span class="cm">	   strapping issue with the DUAL CHANNEL card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI_CARD</span><span class="p">)</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_addstat</span><span class="p">,</span> <span class="n">SCSI_MODE8</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_BusMasterInit</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Initialize the BusMaster for normal operations.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_BusMasterInit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="n">DRVR_RST</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_host_blk_cnt</span><span class="p">,</span> <span class="n">XFER_BLK64</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_bm_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">BMCTRL_DEFAULT</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">SCSI_TERM_ENA_H</span><span class="p">));</span>

	<span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_int_status</span><span class="p">);</span>	<span class="cm">/*Clear interrupts. */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_int_mask</span><span class="p">,</span> <span class="p">(</span><span class="n">INT_CMD_COMPL</span> <span class="o">|</span> <span class="n">SCSI_INTERRUPT</span><span class="p">));</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
					   <span class="o">~</span><span class="n">SCATTER_EN</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_DiagEEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Verfiy checksum and &#39;Key&#39; and initialize the EEPROM if</span>
<span class="cm"> *              necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_DiagEEPROM</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">max_wd_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NARROW_SCSI_CARD</span><span class="p">)</span>
		<span class="n">max_wd_cnt</span> <span class="o">=</span> <span class="n">EEPROM_WD_CNT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_wd_cnt</span> <span class="o">=</span> <span class="n">EEPROM_WD_CNT</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">FW_SIGNATURE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="mh">0x4641</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">max_wd_cnt</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">temp</span> <span class="o">+=</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">FPT_utilEERead</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">EEPROM_CHECK_SUM</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">return</span><span class="p">;</span>	<span class="cm">/*EEPROM is Okay so return now! */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">max_wd_cnt</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4641</span><span class="p">,</span> <span class="n">FW_SIGNATURE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4641</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x3920</span><span class="p">,</span> <span class="n">MODEL_NUMB_0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x3920</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x3033</span><span class="p">,</span> <span class="n">MODEL_NUMB_2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x3033</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x2020</span><span class="p">,</span> <span class="n">MODEL_NUMB_4</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x2020</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x70D3</span><span class="p">,</span> <span class="n">SYSTEM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x70D3</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="n">BIOS_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0010</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">SCAM_CONFIG</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0003</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">ADAPTER_SCSI_ID</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0007</span><span class="p">;</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">IGNORE_B_SCAN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">SEND_START_ENA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DEVICE_ENABLE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBL01</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBL23</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBL45</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBL67</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBL89</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBLab</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBLcd</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="n">SYNC_RATE_TBLef</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4242</span><span class="p">;</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x6C46</span><span class="p">,</span> <span class="mi">64</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/*PRODUCT ID */</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x6C46</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x7361</span><span class="p">,</span> <span class="mi">66</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* FlashPoint LT   */</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x7361</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x5068</span><span class="p">,</span> <span class="mi">68</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x5068</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x696F</span><span class="p">,</span> <span class="mi">70</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x696F</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x746E</span><span class="p">,</span> <span class="mi">72</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x746E</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4C20</span><span class="p">,</span> <span class="mi">74</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4C20</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x2054</span><span class="p">,</span> <span class="mi">76</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x2054</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x2020</span><span class="p">,</span> <span class="mi">78</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x2020</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="n">EE_SCAMBASE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x0700</span> <span class="o">+</span> <span class="n">TYPE_CODE0</span><span class="p">),</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x0700</span> <span class="o">+</span> <span class="n">TYPE_CODE0</span><span class="p">);</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x5542</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>	<span class="cm">/*Vendor ID code */</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x5542</span><span class="p">;</span>		<span class="cm">/* BUSLOGIC      */</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4C53</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4C53</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x474F</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x474F</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4349</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4349</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x5442</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>	<span class="cm">/*Vendor unique code */</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x5442</span><span class="p">;</span>		<span class="cm">/* BT- 930           */</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x202D</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x202D</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x3339</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x3339</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/*Serial #          */</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x2030</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>	<span class="cm">/* 01234567         */</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x2030</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x5453</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x5453</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x5645</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x5645</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x2045</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x2045</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x202F</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x202F</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x4F4A</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x4F4A</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x204E</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x204E</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="mh">0x3539</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="mh">0x3539</span><span class="p">;</span>

	<span class="n">FPT_utilEEWrite</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">EEPROM_CHECK_SUM</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Search Select</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Try to find a new command to execute.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueSearchSelect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scan_ptr</span><span class="p">,</span> <span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">pOldSccb</span><span class="p">;</span>

	<span class="n">scan_ptr</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">scanIndex</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">scan_ptr</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">TAG_Q_TRYING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">scan_ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scan_ptr</span> <span class="o">==</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span>
					<span class="n">scan_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lun</span> <span class="o">&lt;</span> <span class="n">MAX_LUN</span><span class="p">;</span> <span class="n">lun</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
						    <span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="p">;</span>
						<span class="n">pOldSccb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span>
							<span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
						       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lun</span> <span class="o">!=</span>
							   <span class="n">pCurrCard</span><span class="o">-&gt;</span>
							   <span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">pOldSccb</span> <span class="o">=</span>
							    <span class="n">pCurrCard</span><span class="o">-&gt;</span>
							    <span class="n">currentSCCB</span><span class="p">;</span>
							<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
							    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span>
							     <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span>
								<span class="n">currentSCCB</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_forwardlink</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">==</span>
						    <span class="nb">NULL</span><span class="p">)</span>
							<span class="k">continue</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">pOldSccb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">pOldSccb</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_forwardlink</span> <span class="o">=</span>
							    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span>
							     <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span>
								<span class="n">currentSCCB</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_forwardlink</span><span class="p">;</span>
							<span class="n">pOldSccb</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_backlink</span> <span class="o">=</span>
							    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span>
							     <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span>
								<span class="n">currentSCCB</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_backlink</span><span class="p">;</span>
							<span class="n">currTar_Info</span><span class="o">-&gt;</span>
							    <span class="n">TarSelQ_Cnt</span><span class="o">--</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">currTar_Info</span><span class="o">-&gt;</span>
							    <span class="n">TarSelQ_Head</span> <span class="o">=</span>
							    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span>
							     <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span>
								<span class="n">currentSCCB</span><span class="p">)</span><span class="o">-&gt;</span>
							    <span class="n">Sccb_forwardlink</span><span class="p">;</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
							    <span class="n">TarSelQ_Head</span> <span class="o">==</span>
							    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">currTar_Info</span><span class="o">-&gt;</span>
								    <span class="n">TarSelQ_Tail</span>
								    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
								<span class="n">currTar_Info</span><span class="o">-&gt;</span>
								    <span class="n">TarSelQ_Cnt</span>
								    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">currTar_Info</span><span class="o">-&gt;</span>
								    <span class="n">TarSelQ_Cnt</span><span class="o">--</span><span class="p">;</span>
								<span class="n">currTar_Info</span><span class="o">-&gt;</span>
								    <span class="n">TarSelQ_Head</span><span class="o">-&gt;</span>
								    <span class="n">Sccb_backlink</span>
								    <span class="o">=</span>
								    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span>
								     <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">scanIndex</span> <span class="o">=</span> <span class="n">scan_ptr</span><span class="p">;</span>

						<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span>
						    <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">scan_ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scan_ptr</span> <span class="o">==</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scan_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span>
				    <span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="p">;</span>

				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">=</span>
				    <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">)</span><span class="o">-&gt;</span>
				    <span class="n">Sccb_forwardlink</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span><span class="o">--</span><span class="p">;</span>
					<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="o">-&gt;</span>
					    <span class="n">Sccb_backlink</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">scan_ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scan_ptr</span> <span class="o">==</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span>
					<span class="n">scan_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">scanIndex</span> <span class="o">=</span> <span class="n">scan_ptr</span><span class="p">;</span>

				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">else</span> <span class="p">{</span>
				<span class="n">scan_ptr</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scan_ptr</span> <span class="o">==</span> <span class="n">MAX_SCSI_TAR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scan_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">scan_ptr</span> <span class="o">!=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">scanIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Select Fail</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Add the current SCCB to the head of the Queue.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueSelectFail</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisTarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thisTarg</span> <span class="o">=</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(((</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">))</span><span class="o">-&gt;</span>
				    <span class="n">TargID</span><span class="p">);</span>
		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">thisTarg</span><span class="p">];</span>

		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span> <span class="o">=</span>
		    <span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span> <span class="o">=</span>
			    <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">=</span> <span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span><span class="p">;</span>

		<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Command Complete</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Call the callback function with the current SCCB.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueCmdComplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb_card</span> <span class="o">*</span><span class="n">pCurrCard</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_sccb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">,</span> <span class="n">SCSIcmd</span><span class="p">;</span>
	<span class="n">CALL_BK_FN</span> <span class="n">callback</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">SCSIcmd</span> <span class="o">=</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_ALL_XFERRED</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">p_sccb</span><span class="o">-&gt;</span>
		     <span class="n">ControlByte</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCCB_DATA_XFER_OUT</span> <span class="o">|</span> <span class="n">SCCB_DATA_XFER_IN</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">==</span> <span class="n">SCCB_COMPLETE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargetStatus</span> <span class="o">!=</span> <span class="n">SSCHECK</span><span class="p">))</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_READ</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_WRITE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_READ_EXTENDED</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_WRITE_EXTENDED</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_WRITE_AND_VERIFY</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">SCSIcmd</span> <span class="o">==</span> <span class="n">SCSI_START_STOP_UNIT</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_NO_FILTER</span><span class="p">)</span>
			    <span class="p">)</span>
				<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span> <span class="n">SCCB_DATA_UNDER_RUN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">==</span> <span class="n">SCCB_IN_PROCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">||</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargetStatus</span><span class="p">)</span>
			<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_ERROR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">SccbStatus</span> <span class="o">=</span> <span class="n">SCCB_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_AUTO_SENSE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">CdbLength</span> <span class="o">=</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Save_CdbLen</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Cdb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Save_Cdb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESIDUAL_SG_COMMAND</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">OperationCode</span> <span class="o">==</span> <span class="n">RESIDUAL_COMMAND</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">FPT_utilUpdateResidual</span><span class="p">(</span><span class="n">p_sccb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">cmdCounter</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_GREEN_PC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">PWR_DWN</span> <span class="o">|</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">));</span>
			<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_sys_ctrl</span><span class="p">,</span> <span class="n">STOP_CLK</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">ioPort</span> <span class="o">+</span> <span class="n">hp_semaphore</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="n">SCCB_MGR_ACTIVE</span><span class="p">));</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span>
		      <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
			<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					     <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
						     <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="n">CALL_BK_FN</span><span class="p">)</span> <span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">SccbCallback</span><span class="p">;</span>
	<span class="n">callback</span><span class="p">(</span><span class="n">p_sccb</span><span class="p">);</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">globalFlags</span> <span class="o">|=</span> <span class="n">F_NEW_SCCB_CMD</span><span class="p">;</span>
	<span class="n">pCurrCard</span><span class="o">-&gt;</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Disconnect</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Add SCCB to our disconnect array.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueDisconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_sccb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">globalFlags</span> <span class="o">&amp;</span> <span class="n">F_CONLUN_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarStatus</span> <span class="o">&amp;</span> <span class="n">TAR_TAG_Q_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TAG_Q_TRYING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
					      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Lun</span><span class="p">]]</span> <span class="o">=</span>
		    <span class="n">p_sccb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">Sccb_tag</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">p_sccb</span><span class="p">;</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarLUNBusy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="mi">0</span><span class="p">;</span>
			<span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_sccb</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">].</span><span class="n">TarTagQ_Cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">currTar_Info</span><span class="o">-&gt;</span>
						      <span class="n">LunDiscQ_Idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_sccb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Flush SCCB</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Flush all SCCB&#39;s back to the host driver for this target.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueFlushSccb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qtag</span><span class="p">,</span> <span class="n">thisTarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">currSCCB</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currSCCB</span> <span class="o">=</span> <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">currentSCCB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currSCCB</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thisTarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">currSCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">;</span>
		<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">thisTarg</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">qtag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qtag</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">qtag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">TargID</span> <span class="o">==</span>
			     <span class="n">thisTarg</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span><span class="o">-&gt;</span>
				    <span class="n">HostStatus</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">error_code</span><span class="p">;</span>

				<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span>
						     <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
						     <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">],</span> <span class="n">p_card</span><span class="p">);</span>

				<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span><span class="o">--</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Flush Target SCCB</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Flush all SCCB&#39;s back to the host driver for this target.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueFlushTargSccb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">thisTarg</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qtag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">thisTarg</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qtag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qtag</span> <span class="o">&lt;</span> <span class="n">QUEUE_DEPTH</span><span class="p">;</span> <span class="n">qtag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">TargID</span> <span class="o">==</span> <span class="n">thisTarg</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">HostStatus</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">error_code</span><span class="p">;</span>

			<span class="n">FPT_queueCmdComplete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">],</span>
					     <span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span>
					     <span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">],</span> <span class="n">p_card</span><span class="p">);</span>

			<span class="n">FPT_BL_Card</span><span class="p">[</span><span class="n">p_card</span><span class="p">].</span><span class="n">discQ_Tbl</span><span class="p">[</span><span class="n">qtag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarTagQ_Cnt</span><span class="o">--</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_queueAddSccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>
	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span> <span class="o">=</span> <span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">=</span> <span class="n">p_SCCB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span> <span class="o">=</span> <span class="n">p_SCCB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">=</span> <span class="n">p_SCCB</span><span class="p">;</span>
	<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Queue Find SCCB</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Search the target select Queue for this SCCB, and</span>
<span class="cm"> *              remove it if found.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_queueFindSccb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">q_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sccb_mgr_tar_info</span> <span class="o">*</span><span class="n">currTar_Info</span><span class="p">;</span>

	<span class="n">currTar_Info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">FPT_sccbMgrTbl</span><span class="p">[</span><span class="n">p_card</span><span class="p">][</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">TargID</span><span class="p">];</span>

	<span class="n">q_ptr</span> <span class="o">=</span> <span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">q_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">q_ptr</span> <span class="o">==</span> <span class="n">p_SCCB</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">==</span> <span class="n">q_ptr</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Head</span> <span class="o">=</span>
				    <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">==</span> <span class="n">q_ptr</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Tail</span> <span class="o">=</span>
				    <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span> <span class="o">=</span>
				    <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_backlink</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span> <span class="o">=</span>
				    <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">currTar_Info</span><span class="o">-&gt;</span><span class="n">TarSelQ_Cnt</span><span class="o">--</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">else</span> <span class="p">{</span>
			<span class="n">q_ptr</span> <span class="o">=</span> <span class="n">q_ptr</span><span class="o">-&gt;</span><span class="n">Sccb_forwardlink</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Utility Update Residual Count</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Update the XferCnt to the remaining byte count.</span>
<span class="cm"> *              If we transferred all the data then just write zero.</span>
<span class="cm"> *              If Non-SG transfer then report Total Cnt - Actual Transfer</span>
<span class="cm"> *              Cnt.  For SG transfers add the count fields of all</span>
<span class="cm"> *              remaining SG elements, as well as any partial remaining</span>
<span class="cm"> *              element.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_utilUpdateResidual</span><span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="n">p_SCCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">partial_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sg_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sg_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_ALL_XFERRED</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_XferState</span> <span class="o">&amp;</span> <span class="n">F_SG_XFER</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">partial_cnt</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

		<span class="n">sg_index</span> <span class="o">=</span> <span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_sgseg</span><span class="p">;</span>

		<span class="n">sg_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">DataPointer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">partial_cnt</span> <span class="o">=</span> <span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_SGoffset</span><span class="p">;</span>
			<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sg_index</span> <span class="o">*</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SG_ELEMENT_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">partial_cnt</span> <span class="o">+=</span> <span class="o">*</span><span class="p">(</span><span class="n">sg_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sg_index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">sg_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">partial_cnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>

		<span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">-=</span> <span class="n">p_SCCB</span><span class="o">-&gt;</span><span class="n">Sccb_ATC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Wait 1 Second</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Wait for 1 second.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_Wait1Second</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">TO_250ms</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_RST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SCAM_SEL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: FPT_Wait</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Wait the desired delay.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_Wait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">green_flag</span><span class="p">;</span>

	<span class="n">old_timer</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">);</span>

	<span class="n">green_flag</span> <span class="o">=</span> <span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">CLKCTRL_DEFAULT</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">p_delay</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">TIMEOUT</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intena</span><span class="p">),</span> <span class="p">(</span><span class="n">FPT_default_intena</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIMEOUT</span><span class="p">));</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">)</span> <span class="o">|</span> <span class="n">START_TO</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TIMEOUT</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_scsictrl_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCSI_RST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">RDW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SCAM_SEL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_portctrl_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">START_TO</span><span class="p">));</span>

	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intstat</span><span class="p">),</span> <span class="n">TIMEOUT</span><span class="p">);</span>
	<span class="n">WRW_HARPOON</span><span class="p">((</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_intena</span><span class="p">),</span> <span class="n">FPT_default_intena</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_clkctrl_0</span><span class="p">,</span> <span class="n">green_flag</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_seltimeout</span><span class="p">,</span> <span class="n">old_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Enable/Disable Write to EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Description: The EEPROM must first be enabled for writes</span>
<span class="cm"> *              A total of 9 clocks are needed.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_utilEEWriteOnOff</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_value</span><span class="p">;</span>

	<span class="n">ee_value</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">EXT_ARB_ACK</span> <span class="o">|</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_mode</span><span class="p">)</span>

		<span class="n">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">EWEN</span><span class="p">,</span> <span class="n">EWEN_ADDR</span><span class="p">);</span>

	<span class="k">else</span>

		<span class="n">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">EWDS</span><span class="p">,</span> <span class="n">EWDS_ADDR</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ee_value</span> <span class="o">|</span> <span class="n">SEE_MS</span><span class="p">));</span>	<span class="cm">/*Turn off CS */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>	<span class="cm">/*Turn off Master Select */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Write EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Write a word to the EEPROM at the specified</span>
<span class="cm"> *              address.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_utilEEWrite</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_data</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ee_value</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span>
	     <span class="kt">char</span><span class="p">)((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">EXT_ARB_ACK</span> <span class="o">|</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">SEE_MS</span> <span class="o">|</span> <span class="n">SEE_CS</span><span class="p">));</span>

	<span class="n">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">EE_WRITE</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

	<span class="n">ee_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SEE_MS</span> <span class="o">+</span> <span class="n">SEE_CS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">ee_data</span><span class="p">)</span>
			<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_DO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_DO</span><span class="p">;</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_CLK</span><span class="p">;</span>	<span class="cm">/* Clock  data! */</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_CLK</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">EXT_ARB_ACK</span> <span class="o">|</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ee_value</span> <span class="o">|</span> <span class="n">SEE_MS</span><span class="p">));</span>

	<span class="n">FPT_Wait</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">TO_10ms</span><span class="p">);</span>

	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ee_value</span> <span class="o">|</span> <span class="n">SEE_MS</span> <span class="o">|</span> <span class="n">SEE_CS</span><span class="p">));</span>	<span class="cm">/* Set CS to EEPROM */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ee_value</span> <span class="o">|</span> <span class="n">SEE_MS</span><span class="p">));</span>	<span class="cm">/* Turn off CS */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>	<span class="cm">/* Turn off Master Select */</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Read EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Read a word from the EEPROM at the desired</span>
<span class="cm"> *              address.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">FPT_utilEERead</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">ee_data1</span><span class="p">,</span> <span class="n">ee_data2</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ee_data1</span> <span class="o">=</span> <span class="n">FPT_utilEEReadOrg</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ee_data2</span> <span class="o">=</span> <span class="n">FPT_utilEEReadOrg</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ee_data1</span> <span class="o">==</span> <span class="n">ee_data2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ee_data1</span><span class="p">;</span>

		<span class="n">ee_data1</span> <span class="o">=</span> <span class="n">ee_data2</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ee_data1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Read EEPROM Original </span>
<span class="cm"> *</span>
<span class="cm"> * Description: Read a word from the EEPROM at the desired</span>
<span class="cm"> *              address.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">FPT_utilEEReadOrg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">,</span> <span class="n">ee_data</span><span class="p">;</span>

	<span class="n">ee_value</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span>
	     <span class="kt">char</span><span class="p">)((</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">EXT_ARB_ACK</span> <span class="o">|</span> <span class="n">SCSI_TERM_ENA_H</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">SEE_MS</span> <span class="o">|</span> <span class="n">SEE_CS</span><span class="p">));</span>

	<span class="n">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="n">p_port</span><span class="p">,</span> <span class="n">EE_READ</span><span class="p">,</span> <span class="n">ee_addr</span><span class="p">);</span>

	<span class="n">ee_value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SEE_MS</span> <span class="o">+</span> <span class="n">SEE_CS</span><span class="p">);</span>
	<span class="n">ee_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_CLK</span><span class="p">;</span>	<span class="cm">/* Clock  data! */</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_CLK</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>

		<span class="n">ee_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SEE_DI</span><span class="p">)</span>
			<span class="n">ee_data</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SEE_MS</span> <span class="o">+</span> <span class="n">SEE_CS</span><span class="p">);</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="p">(</span><span class="n">ee_value</span> <span class="o">|</span> <span class="n">SEE_MS</span><span class="p">));</span>	<span class="cm">/*Turn off CS */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>	<span class="cm">/*Turn off Master Select */</span>

	<span class="k">return</span> <span class="n">ee_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Function: Send EE command and Address to the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Transfers the correct command and sends the address</span>
<span class="cm"> *              to the eeprom.</span>
<span class="cm"> *</span>
<span class="cm"> *---------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FPT_utilEESendCmdAddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_cmd</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ee_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ee_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">narrow_flg</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">narrow_flg</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">RD_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_page_ctrl</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">NARROW_SCSI_CARD</span><span class="p">);</span>

	<span class="n">ee_value</span> <span class="o">=</span> <span class="n">SEE_MS</span><span class="p">;</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>

	<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_CS</span><span class="p">;</span>	<span class="cm">/* Set CS to EEPROM */</span>
	<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">ee_cmd</span><span class="p">)</span>
			<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_DO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_DO</span><span class="p">;</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_CLK</span><span class="p">;</span>	<span class="cm">/* Clock  data! */</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_CLK</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">narrow_flg</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">;</span>

	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">ee_addr</span><span class="p">)</span>
			<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_DO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_DO</span><span class="p">;</span>

		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">|=</span> <span class="n">SEE_CLK</span><span class="p">;</span>	<span class="cm">/* Clock  data! */</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">ee_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEE_CLK</span><span class="p">;</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>
		<span class="n">WR_HARPOON</span><span class="p">(</span><span class="n">p_port</span> <span class="o">+</span> <span class="n">hp_ee_ctrl</span><span class="p">,</span> <span class="n">ee_value</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">FPT_CalcCrc16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">^</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">CRCMASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">FPT_CalcLrc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lrc</span><span class="p">;</span>
	<span class="n">lrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ID_STRING_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lrc</span> <span class="o">^=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">lrc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  The following inline definitions avoid type conflicts.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">FlashPoint__ProbeHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="n">FlashPointInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FlashPoint_ProbeHostAdapter</span><span class="p">((</span><span class="k">struct</span> <span class="n">sccb_mgr_info</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">FlashPointInfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">FlashPoint_CardHandle_T</span>
<span class="nf">FlashPoint__HardwareResetHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="n">FlashPointInfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FlashPoint_HardwareResetHostAdapter</span><span class="p">((</span><span class="k">struct</span> <span class="n">sccb_mgr_info</span> <span class="o">*</span><span class="p">)</span>
						   <span class="n">FlashPointInfo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">FlashPoint__ReleaseHostAdapter</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span> <span class="n">CardHandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FlashPoint_ReleaseHostAdapter</span><span class="p">(</span><span class="n">CardHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">FlashPoint__StartCCB</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span> <span class="n">CardHandle</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FlashPoint_StartCCB</span><span class="p">(</span><span class="n">CardHandle</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)</span><span class="n">CCB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">FlashPoint__AbortCCB</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span> <span class="n">CardHandle</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="n">CCB</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FlashPoint_AbortCCB</span><span class="p">(</span><span class="n">CardHandle</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sccb</span> <span class="o">*</span><span class="p">)</span><span class="n">CCB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span>
<span class="nf">FlashPoint__InterruptPending</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span> <span class="n">CardHandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FlashPoint_InterruptPending</span><span class="p">(</span><span class="n">CardHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">FlashPoint__HandleInterrupt</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span> <span class="n">CardHandle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FlashPoint_HandleInterrupt</span><span class="p">(</span><span class="n">CardHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define FlashPoint_ProbeHostAdapter	    FlashPoint__ProbeHostAdapter</span>
<span class="cp">#define FlashPoint_HardwareResetHostAdapter FlashPoint__HardwareResetHostAdapter</span>
<span class="cp">#define FlashPoint_ReleaseHostAdapter	    FlashPoint__ReleaseHostAdapter</span>
<span class="cp">#define FlashPoint_StartCCB		    FlashPoint__StartCCB</span>
<span class="cp">#define FlashPoint_AbortCCB		    FlashPoint__AbortCCB</span>
<span class="cp">#define FlashPoint_InterruptPending	    FlashPoint__InterruptPending</span>
<span class="cp">#define FlashPoint_HandleInterrupt	    FlashPoint__HandleInterrupt</span>

<span class="cp">#else				</span><span class="cm">/* !CONFIG_SCSI_FLASHPOINT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">  Define prototypes for the FlashPoint SCCB Manager Functions.</span>
<span class="cm">*/</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FlashPoint_ProbeHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">FlashPoint_CardHandle_T</span>
<span class="n">FlashPoint_HardwareResetHostAdapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">FlashPoint_Info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">FlashPoint_StartCCB</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">FlashPoint_AbortCCB</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BusLogic_CCB</span> <span class="o">*</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span> <span class="n">FlashPoint_InterruptPending</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">FlashPoint_HandleInterrupt</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">FlashPoint_ReleaseHostAdapter</span><span class="p">(</span><span class="n">FlashPoint_CardHandle_T</span><span class="p">);</span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_SCSI_FLASHPOINT */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
