<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_nx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_nx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &quot;ql4_def.h&quot;</span>
<span class="cp">#include &quot;ql4_glbl.h&quot;</span>

<span class="cp">#include &lt;asm-generic/io-64-nonatomic-lo-hi.h&gt;</span>

<span class="cp">#define MASK(n)		DMA_BIT_MASK(n)</span>
<span class="cp">#define MN_WIN(addr)	(((addr &amp; 0x1fc0000) &gt;&gt; 1) | ((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define OCM_WIN(addr)	(((addr &amp; 0x1ff0000) &gt;&gt; 1) | ((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define MS_WIN(addr)	(addr &amp; 0x0ffc0000)</span>
<span class="cp">#define QLA82XX_PCI_MN_2M	(0)</span>
<span class="cp">#define QLA82XX_PCI_MS_2M	(0x80000)</span>
<span class="cp">#define QLA82XX_PCI_OCM0_2M	(0xc0000)</span>
<span class="cp">#define VALID_OCM_ADDR(addr)	(((addr) &amp; 0x3f800) != 0x3f800)</span>
<span class="cp">#define GET_MEM_OFFS_2M(addr)	(addr &amp; MASK(18))</span>

<span class="cm">/* CRB window related */</span>
<span class="cp">#define CRB_BLK(off)	((off &gt;&gt; 20) &amp; 0x3f)</span>
<span class="cp">#define CRB_SUBBLK(off)	((off &gt;&gt; 16) &amp; 0xf)</span>
<span class="cp">#define CRB_WINDOW_2M	(0x130060)</span>
<span class="cp">#define CRB_HI(off)	((qla4_8xxx_crb_hub_agt[CRB_BLK(off)] &lt;&lt; 20) | \</span>
<span class="cp">			((off) &amp; 0xf0000))</span>
<span class="cp">#define QLA82XX_PCI_CAMQM_2M_END	(0x04800800UL)</span>
<span class="cp">#define QLA82XX_PCI_CAMQM_2M_BASE	(0x000ff800UL)</span>
<span class="cp">#define CRB_INDIRECT_2M			(0x1e0000UL)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">qla4_8xxx_pci_base_offsetfset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">first_page_group_end</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">first_page_group_start</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_CRB_XFORM 60</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crb_addr_xform</span><span class="p">[</span><span class="n">MAX_CRB_XFORM</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4_8xxx_crb_table_initialized</span><span class="p">;</span>

<span class="cp">#define qla4_8xxx_crb_addr_transform(name) \</span>
<span class="cp">	(crb_addr_xform[QLA82XX_HW_PX_MAP_CRB_##name] = \</span>
<span class="cp">	 QLA82XX_HW_CRB_HUB_AGT_ADR_##name &lt;&lt; 20)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_crb_addr_transform_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">XDMA</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">TIMR</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SRE</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQN0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SQS0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX7</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX6</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX5</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX4</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">RPMX0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">ROMUSB</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SN</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">QMN</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">QMS</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGNI</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGND</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGN0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGSI</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGSD</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PGS0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PS</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">PH</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">NIU</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">I2Q</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">EG</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">MN</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">MS</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS2</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">CAS0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">CAM</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">C2C1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">C2C0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">SMB</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">OCM0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_crb_addr_transform</span><span class="p">(</span><span class="n">I2C0</span><span class="p">);</span>

	<span class="n">qla4_8xxx_crb_table_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crb_128M_2M_block_map</span> <span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>		<span class="cm">/* 0: PCI */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0100000</span><span class="p">,</span> <span class="mh">0x0102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>	<span class="cm">/* 1: PCIE */</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0110000</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x0122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0130000</span><span class="p">,</span> <span class="mh">0x0132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0140000</span><span class="p">,</span> <span class="mh">0x0142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0150000</span><span class="p">,</span> <span class="mh">0x0152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0160000</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x0172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x01e0000</span><span class="p">,</span> <span class="mh">0x01e0800</span><span class="p">,</span> <span class="mh">0x122000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0200000</span><span class="p">,</span> <span class="mh">0x0210000</span><span class="p">,</span> <span class="mh">0x180000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 2: MN */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	    <span class="cm">/* 3: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0400000</span><span class="p">,</span> <span class="mh">0x0401000</span><span class="p">,</span> <span class="mh">0x169000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 4: P2NR1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0500000</span><span class="p">,</span> <span class="mh">0x0510000</span><span class="p">,</span> <span class="mh">0x140000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 5: SRE   */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0600000</span><span class="p">,</span> <span class="mh">0x0610000</span><span class="p">,</span> <span class="mh">0x1c0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 6: NIU   */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0700000</span><span class="p">,</span> <span class="mh">0x0704000</span><span class="p">,</span> <span class="mh">0x1b8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 7: QM    */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0802000</span><span class="p">,</span> <span class="mh">0x170000</span><span class="p">},</span>  <span class="cm">/* 8: SQM0  */</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x08f0000</span><span class="p">,</span> <span class="mh">0x08f2000</span><span class="p">,</span> <span class="mh">0x172000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0900000</span><span class="p">,</span> <span class="mh">0x0902000</span><span class="p">,</span> <span class="mh">0x174000</span><span class="p">},</span>	<span class="cm">/* 9: SQM1*/</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x09f0000</span><span class="p">,</span> <span class="mh">0x09f2000</span><span class="p">,</span> <span class="mh">0x176000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0a00000</span><span class="p">,</span> <span class="mh">0x0a02000</span><span class="p">,</span> <span class="mh">0x178000</span><span class="p">},</span>	<span class="cm">/* 10: SQM2*/</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0af0000</span><span class="p">,</span> <span class="mh">0x0af2000</span><span class="p">,</span> <span class="mh">0x17a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0b00000</span><span class="p">,</span> <span class="mh">0x0b02000</span><span class="p">,</span> <span class="mh">0x17c000</span><span class="p">},</span>	<span class="cm">/* 11: SQM3*/</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0bf0000</span><span class="p">,</span> <span class="mh">0x0bf2000</span><span class="p">,</span> <span class="mh">0x17e000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0c00000</span><span class="p">,</span> <span class="mh">0x0c04000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 12: I2Q */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0d00000</span><span class="p">,</span> <span class="mh">0x0d04000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 13: TMR */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0e00000</span><span class="p">,</span> <span class="mh">0x0e04000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 14: ROMUSB */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0f00000</span><span class="p">,</span> <span class="mh">0x0f01000</span><span class="p">,</span> <span class="mh">0x164000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 15: PEG4 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x1004000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 16: XDMA */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1100000</span><span class="p">,</span> <span class="mh">0x1101000</span><span class="p">,</span> <span class="mh">0x160000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 17: PEG0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1200000</span><span class="p">,</span> <span class="mh">0x1201000</span><span class="p">,</span> <span class="mh">0x161000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 18: PEG1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1300000</span><span class="p">,</span> <span class="mh">0x1301000</span><span class="p">,</span> <span class="mh">0x162000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 19: PEG2 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1400000</span><span class="p">,</span> <span class="mh">0x1401000</span><span class="p">,</span> <span class="mh">0x163000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 20: PEG3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1500000</span><span class="p">,</span> <span class="mh">0x1501000</span><span class="p">,</span> <span class="mh">0x165000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 21: P2ND */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1600000</span><span class="p">,</span> <span class="mh">0x1601000</span><span class="p">,</span> <span class="mh">0x166000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 22: P2NI */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 23: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 24: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 25: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 26: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 27: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 28: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1d00000</span><span class="p">,</span> <span class="mh">0x1d10000</span><span class="p">,</span> <span class="mh">0x190000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 29: MS */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1e00000</span><span class="p">,</span> <span class="mh">0x1e01000</span><span class="p">,</span> <span class="mh">0x16a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 30: P2NR2 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1f00000</span><span class="p">,</span> <span class="mh">0x1f10000</span><span class="p">,</span> <span class="mh">0x150000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 31: EPG */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 32: PCI */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2100000</span><span class="p">,</span> <span class="mh">0x2102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>	<span class="cm">/* 33: PCIE */</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2110000</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x2122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2130000</span><span class="p">,</span> <span class="mh">0x2132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2140000</span><span class="p">,</span> <span class="mh">0x2142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2150000</span><span class="p">,</span> <span class="mh">0x2152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2160000</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x2172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2200000</span><span class="p">,</span> <span class="mh">0x2204000</span><span class="p">,</span> <span class="mh">0x1b0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 34: CAM */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 35: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 36: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 37: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 38: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 39: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2800000</span><span class="p">,</span> <span class="mh">0x2804000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 40: TMR */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2900000</span><span class="p">,</span> <span class="mh">0x2901000</span><span class="p">,</span> <span class="mh">0x16b000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 41: P2NR3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2a00000</span><span class="p">,</span> <span class="mh">0x2a00400</span><span class="p">,</span> <span class="mh">0x1ac400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 42: RPMX1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2b00000</span><span class="p">,</span> <span class="mh">0x2b00400</span><span class="p">,</span> <span class="mh">0x1ac800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 43: RPMX2 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2c00000</span><span class="p">,</span> <span class="mh">0x2c00400</span><span class="p">,</span> <span class="mh">0x1acc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 44: RPMX3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2d00000</span><span class="p">,</span> <span class="mh">0x2d00400</span><span class="p">,</span> <span class="mh">0x1ad000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 45: RPMX4 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2e00000</span><span class="p">,</span> <span class="mh">0x2e00400</span><span class="p">,</span> <span class="mh">0x1ad400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 46: RPMX5 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2f00000</span><span class="p">,</span> <span class="mh">0x2f00400</span><span class="p">,</span> <span class="mh">0x1ad800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 47: RPMX6 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="mh">0x3000400</span><span class="p">,</span> <span class="mh">0x1adc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 48: RPMX7 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x3100000</span><span class="p">,</span> <span class="mh">0x3104000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 49: XDMA */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3200000</span><span class="p">,</span> <span class="mh">0x3204000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 50: I2Q */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3300000</span><span class="p">,</span> <span class="mh">0x3304000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 51: ROMUSB */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 52: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3500000</span><span class="p">,</span> <span class="mh">0x3500400</span><span class="p">,</span> <span class="mh">0x1ac000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 53: RPMX0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3600000</span><span class="p">,</span> <span class="mh">0x3600400</span><span class="p">,</span> <span class="mh">0x1ae000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 54: RPMX8 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3700000</span><span class="p">,</span> <span class="mh">0x3700400</span><span class="p">,</span> <span class="mh">0x1ae400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 55: RPMX9 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3800000</span><span class="p">,</span> <span class="mh">0x3804000</span><span class="p">,</span> <span class="mh">0x1d0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 56: OCM0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3900000</span><span class="p">,</span> <span class="mh">0x3904000</span><span class="p">,</span> <span class="mh">0x1b4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 57: CRYPTO */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3a00000</span><span class="p">,</span> <span class="mh">0x3a04000</span><span class="p">,</span> <span class="mh">0x1d8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 58: SMB */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 59: I2C0 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 60: I2C1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3d00000</span><span class="p">,</span> <span class="mh">0x3d04000</span><span class="p">,</span> <span class="mh">0x1dc000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 61: LPC */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3e00000</span><span class="p">,</span> <span class="mh">0x3e01000</span><span class="p">,</span> <span class="mh">0x167000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 62: P2NC */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3f00000</span><span class="p">,</span> <span class="mh">0x3f01000</span><span class="p">,</span> <span class="mh">0x168000</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span>	<span class="cm">/* 63: P2NR0 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * top 12 bits of crb internal address (hub, agent)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">qla4_8xxx_crb_hub_agt</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_MN</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_MS</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SRE</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_NIU</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_QMN</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SQN3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN4</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGN3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGND</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGNI</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGS3</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGSI</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SN</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_EG</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_CAM</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX1</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX2</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX3</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX4</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX5</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX6</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX7</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX8</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_RPMX9</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_OCM0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_SMB</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2C0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_I2C1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">QLA82XX_HW_CRB_HUB_AGT_ADR_PGNC</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Device states */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">qdev_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Cold&quot;</span><span class="p">,</span>
	<span class="s">&quot;Initializing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Ready&quot;</span><span class="p">,</span>
	<span class="s">&quot;Need Reset&quot;</span><span class="p">,</span>
	<span class="s">&quot;Need Quiescent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Quiescent&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In: &#39;off&#39; is offset from CRB space in 128M pci map</span>
<span class="cm"> * Out: &#39;off&#39; is 2M pci map addr</span>
<span class="cm"> * side effect: lock crb window</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">win_read</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span> <span class="o">=</span> <span class="n">CRB_HI</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>

	<span class="cm">/* Read back value to make sure write has gone through before trying</span>
<span class="cm">	* to use it. */</span>
	<span class="n">win_read</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s: Written crbwin (0x%x) != Read crbwin (0x%x),&quot;</span>
		    <span class="s">&quot; off=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">crb_win</span><span class="p">,</span> <span class="n">win_read</span><span class="p">,</span> <span class="o">*</span><span class="n">off</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_wr_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qla4_8xxx_crb_win_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_crb_win_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_rd_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">qla4_8xxx_crb_win_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_crb_win_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Minidump related functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">off</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">win_read</span><span class="p">,</span> <span class="n">off_value</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">off_value</span>  <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">off_value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>

	<span class="cm">/* Read back value to make sure write has gone through before trying</span>
<span class="cm">	 * to use it.</span>
<span class="cm">	 */</span>
	<span class="n">win_read</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">CRB_WINDOW_2M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">off_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: Written (0x%x) != Read (0x%x), off=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">off_value</span><span class="p">,</span> <span class="n">win_read</span><span class="p">,</span> <span class="n">off</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off_value</span>  <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">off_value</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">off_value</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CRB_WIN_LOCK_TIMEOUT 100000000</span>

<span class="kt">int</span> <span class="nf">qla4_8xxx_crb_win_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore3 from PCI HW block */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM7_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">CRB_WIN_LOCK_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Yield CPU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cpu_relax</span><span class="p">();</span>    <span class="cm">/*This a nop instr on i386*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_WIN_LOCK_ID</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4_8xxx_crb_win_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM7_UNLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define IDC_LOCK_TIMEOUT 100000000</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_idc_lock - hw_lock</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * General purpose lock used to synchronize access to</span>
<span class="cm"> * CRB_DEV_STATE, CRB_DEV_REF_COUNT, etc.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore5 from PCI HW block */</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM5_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">IDC_LOCK_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Yield CPU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cpu_relax</span><span class="p">();</span>    <span class="cm">/*This a nop instr on i386*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM5_UNLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_pci_get_crb_addr_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crb_128M_2M_sub_block_map</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_CRB_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_PCI_CAMQM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_PCI_CAMQM_2M_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">-</span> <span class="n">QLA82XX_PCI_CAMQM</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">QLA82XX_PCI_CAMQM_2M_BASE</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">off</span> <span class="o">-=</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Try direct map</span>
<span class="cm">	 */</span>

	<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="n">CRB_BLK</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)].</span><span class="n">sub_block</span><span class="p">[</span><span class="n">CRB_SUBBLK</span><span class="p">(</span><span class="o">*</span><span class="n">off</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">end_128M</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">off</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span> <span class="o">+</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_2M</span> <span class="o">-</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not in direct map, use crb window</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  PCI Windowing for DDR regions.  */</span>
<span class="cp">#define QLA82XX_ADDR_IN_RANGE(addr, low, high)            \</span>
<span class="cp">	(((addr) &lt;= (high)) &amp;&amp; ((addr) &gt;= (low)))</span>

<span class="cm">/*</span>
<span class="cm">* check memory access boundary.</span>
<span class="cm">* used by test agent. support ddr access only for now</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla4_8xxx_pci_mem_bound_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
	    <span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	    <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4_8xxx_pci_set_window_warning_count</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla4_8xxx_pci_set_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">window</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">win_read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
	    <span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">MN_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">win_read</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">!=</span> <span class="n">window</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			<span class="s">&quot;%s: Written MNwin (0x%x) != Read MNwin (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_DDR_NET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM0</span><span class="p">,</span>
				<span class="n">QLA82XX_ADDR_OCM0_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp1</span><span class="p">;</span>
		<span class="cm">/* if bits 19:18&amp;17:11 are on */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x00ff800</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: QM access not handled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">window</span> <span class="o">=</span> <span class="n">OCM_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mn_win_crb</span> <span class="o">|</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="p">((</span><span class="n">window</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">window</span> <span class="o">&amp;</span> <span class="mh">0x0FFFE0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">temp1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Written OCMwin (0x%x) != Read&quot;</span>
			    <span class="s">&quot; OCMwin (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_OCM0_2M</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">,</span>
				<span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* QDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">MS_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_win_crb</span> <span class="o">|</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">win_read</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ms_win_crb</span> <span class="o">|</span> <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win_read</span> <span class="o">!=</span> <span class="n">window</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Written MSwin (0x%x) != Read &quot;</span>
			    <span class="s">&quot;MSwin (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">win_read</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">QLA82XX_PCI_QDR_NET</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * peg gdb frequently accesses memory that doesn&#39;t exist,</span>
<span class="cm">		 * this limits the chit chat so debugging isn&#39;t slowed down.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla4_8xxx_pci_set_window_warning_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">qla4_8xxx_pci_set_window_warning_count</span><span class="o">%</span><span class="mi">64</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Warning:%s Unknown address range!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check if address is in the same windows as the previous access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_pci_is_same_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">window</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">qdr_max</span><span class="p">;</span>

	<span class="n">qdr_max</span> <span class="o">=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_DDR_NET</span><span class="p">,</span>
	    <span class="n">QLA82XX_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DDR network side */</span>
		<span class="n">BUG</span><span class="p">();</span>	<span class="cm">/* MN access can not come here */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM0</span><span class="p">,</span>
	     <span class="n">QLA82XX_ADDR_OCM0_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_OCM1</span><span class="p">,</span>
	     <span class="n">QLA82XX_ADDR_OCM1_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">,</span>
	    <span class="n">qdr_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* QDR network side */</span>
		<span class="n">window</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">-</span> <span class="n">QLA82XX_ADDR_QDR_NET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">==</span> <span class="n">window</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_pci_mem_read_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_page</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If attempting to access unknown address or straddle hw windows,</span>
<span class="cm">	 * do not access.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_set_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">qla4_8xxx_pci_is_same_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s out of bound pci memory access. &quot;</span>
				<span class="s">&quot;offset is 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_base_offsetfset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mem_page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="cm">/* Map two pages whenever user tries to access addresses in two</span>
<span class="cm">		   consecutive pages.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_page</span> <span class="o">!=</span> <span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
			<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">mem_ptr</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_pci_mem_write_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u64</span> <span class="n">off</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_page</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If attempting to access unknown address or straddle hw windows,</span>
<span class="cm">	 * do not access.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_set_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">qla4_8xxx_pci_is_same_window</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s out of bound pci memory access. &quot;</span>
				<span class="s">&quot;offset is 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_base_offsetfset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mem_page</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="cm">/* Map two pages whenever user tries to access addresses in two</span>
<span class="cm">		   consecutive pages.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_page</span> <span class="o">!=</span> <span class="p">((</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span>
			<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">mem_page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">mem_ptr</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">writew</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MTU_FUDGE_FACTOR 100</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">qla4_8xxx_decode_crb_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pci_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4_8xxx_crb_table_initialized</span><span class="p">)</span>
		<span class="n">qla4_8xxx_crb_addr_transform_setup</span><span class="p">();</span>

	<span class="n">pci_base</span> <span class="o">=</span> <span class="n">ADDR_ERROR</span><span class="p">;</span>
	<span class="n">base_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x000fffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CRB_XFORM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crb_addr_xform</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_base</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_base</span> <span class="o">==</span> <span class="n">ADDR_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">pci_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">rom_max_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">qla4_8xxx_rom_lock_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_rom_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* acquire semaphore2 from PCI HW block */</span>

		<span class="n">done</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM2_LOCK</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">qla4_8xxx_rom_lock_timeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Yield CPU */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cpu_relax</span><span class="p">();</span>    <span class="cm">/*This a nop instr on i386*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROM_LOCK_ID</span><span class="p">,</span> <span class="n">ROM_LOCK_DRIVER</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_rom_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM2_UNLOCK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_wait_rom_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_STATUS</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">&amp;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">rom_max_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Timeout reached  waiting for rom done&quot;</span><span class="p">,</span>
					<span class="n">DRIVER_NAME</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_do_rom_fast_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_DUMMY_BYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_INSTR_OPCODE</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_wait_rom_done</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error waiting for rom done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* reset abyte_cnt and dummy_byte_cnt */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_DUMMY_BYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_ABYTE_CNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_ROM_RDATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">qla4_8xxx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: qla4_8xxx_rom_lock failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4_8xxx_do_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">valp</span><span class="p">);</span>
	<span class="n">qla4_8xxx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This routine does CRB initialize sequence</span>
<span class="cm"> * to put the ISP into operational state</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_pinit_from_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">verbose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">crb_addr_pair</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">crb_addr_pair</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Halt all the indiviual PEGs and other blocks of the ISP */</span>
	<span class="n">qla4_8xxx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* disable all I2Q */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_I2Q</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* disable all niu interrupts */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* disable xge rx/tx */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x70000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable xg1 rx/tx */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x80000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable sideband mac */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x90000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable ap0 mac */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0xa0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* disable ap1 mac */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0xb0000</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* halt sre */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_SRE</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_SRE</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)));</span>

	<span class="cm">/* halt epg */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_EPG</span> <span class="o">+</span> <span class="mh">0x1300</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* halt timers */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_TIMER</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* halt pegs */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_4</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* big hammer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="cm">/* don&#39;t reset CAM block on reset */</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0xfeffffff</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">qla4_8xxx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Read the signature value from the flash.</span>
<span class="cm">	 * Offset 0: Contain signature (0xcafecafe)</span>
<span class="cm">	 * Offset 4: Offset and number of addr/value pairs</span>
<span class="cm">	 * that present in CRB initialize sequence</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">!=</span> <span class="mh">0xcafecafeUL</span> <span class="o">||</span>
	    <span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			<span class="s">&quot;[ERROR] Reading crb_init area: n: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Offset in flash = lower 16 bits</span>
<span class="cm">	 * Number of enteries = upper 16 bits</span>
<span class="cm">	 */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>

	<span class="cm">/* number of addr/value pair should not exceed 1024 enteries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span>  <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s: %s:n=0x%x [ERROR] Card flash not initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		<span class="s">&quot;%s: %d CRB init values found in ROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crb_addr_pair</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s: [ERROR] Unable to malloc memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Translate internal CRB initialization</span>
<span class="cm">		 * address to PCI bus address</span>
<span class="cm">		 */</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">qla4_8xxx_decode_crb_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">QLA82XX_PCI_CRBSPACE</span><span class="p">;</span>
		<span class="cm">/* Not all CRB  addr/value pair to be written,</span>
<span class="cm">		 * some of them are skipped</span>
<span class="cm">		 */</span>

		<span class="cm">/* skip if LS bit is set*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;Skip CRB init replay for offset = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* skipping cold reboot MAGIC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* do not reset PCI */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">ROMUSB_GLB</span> <span class="o">+</span> <span class="mh">0xbc</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* skip core clock, so that firmware can increase the clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">ROMUSB_GLB</span> <span class="o">+</span> <span class="mh">0xc8</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* skip the function enable register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SETUP_FUNCTION</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SETUP_FUNCTION2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0ff00000</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA82XX_CRB_SMB</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x0ff00000</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">ADDR_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;%s: [ERROR] Unknown addr: 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>

		<span class="cm">/* ISP requires much bigger delay to settle down,</span>
<span class="cm">		 * else crb_window returns 0xffffffff</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="cm">/* ISP requires millisec delay between</span>
<span class="cm">		 * successive CRB register updation</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* Resetting the data and instruction cache */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_D</span><span class="o">+</span><span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_D</span><span class="o">+</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_I</span><span class="o">+</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Clear all protocol processing engines */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_load_from_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">image_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="n">memaddr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">;</span>

	<span class="n">flashaddr</span> <span class="o">=</span> <span class="n">memaddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_region_bootload</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_start</span> <span class="o">-</span> <span class="n">flashaddr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: bootldr=0x%lx, fw_image=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="n">image_start</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">low</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">qla4_8xxx_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flashaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">high</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_load_from_flash</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span> <span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_pci_mem_write_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">memaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_load_from_flash</span><span class="p">;</span>

		<span class="n">flashaddr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">memaddr</span>   <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mh">0x1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="mh">0x80001e</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

<span class="nl">exit_load_from_flash:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">image_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rst</span><span class="p">;</span>

	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_pinit_from_rom</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Error during CRB Initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* at this point, QM is in reset. This could be a problem if there are</span>
<span class="cm">	 * incoming d* transition queue messages. QM/PCIE could wedge.</span>
<span class="cm">	 * To get around this, QM is brought out of reset.</span>
<span class="cm">	 */</span>

	<span class="n">rst</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">);</span>
	<span class="cm">/* unreset qm */</span>
	<span class="n">rst</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_ROMUSB_GLB_SW_RESET</span><span class="p">,</span> <span class="n">rst</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_load_from_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">image_start</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error trying to load fw from flash!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_pci_mem_read_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">off0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">shift_amount</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">off8</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mem_crb</span><span class="p">,</span> <span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * If not MN, go check for MS or invalid.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_ADDR_QDR_NET</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">)</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_QDR_NET</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_pci_mem_bound_check</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qla4_8xxx_pci_mem_read_direct</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">shift_amount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">loop</span> <span class="o">=</span> <span class="p">((</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift_amount</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">off0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">off8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span>
					   <span class="s">&quot;%s: failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">off0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">end</span>   <span class="o">=</span> <span class="p">(</span><span class="n">off0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				<span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_RDDATA</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
			<span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">off0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))))</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_pci_mem_write_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">off0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shift_amount</span><span class="p">,</span> <span class="n">startword</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">off8</span><span class="p">,</span> <span class="n">mem_crb</span><span class="p">,</span> <span class="n">tmpw</span><span class="p">,</span> <span class="n">word</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * If not MN, go check for MS or invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">QLA82XX_ADDR_QDR_NET</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;=</span> <span class="n">QLA82XX_P3_ADDR_QDR_NET_MAX</span><span class="p">)</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_QDR_NET</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">QLA82XX_CRB_DDR_NET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_pci_mem_bound_check</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qla4_8xxx_pci_mem_write_direct</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">off0</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">off0</span><span class="p">))</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">off0</span><span class="p">);</span>
	<span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">loop</span> <span class="o">=</span> <span class="p">(((</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">shift_amount</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">startword</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_pci_mem_read_2M</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">off8</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">],</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="n">tmpw</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpw</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">((</span><span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmpw</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">off0</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">word</span><span class="p">[</span><span class="n">startword</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">tmpw</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">off8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift_amount</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_WRDATA_LO</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">scale</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_WRDATA_HI</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_WRDATA_UPPER_LO</span><span class="p">,</span>
		    <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_WRDATA_UPPER_HI</span><span class="p">,</span>
		    <span class="n">temp</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_WRITE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_WRITE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span><span class="o">+</span><span class="n">MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_CTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					   <span class="s">&quot;%s: failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_cmdpeg_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pegtune_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pegtune_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHAN_INITIALIZE_COMPLETE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHAN_INITIALIZE_ACK</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pegtune_val</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				<span class="n">QLA82XX_ROMUSB_GLB_PEGTUNE_DONE</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: init failed, &quot;</span>
				<span class="s">&quot;pegtune_val = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pegtune_val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_rcvpeg_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Window 1 call */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">state</span> <span class="o">!=</span> <span class="n">PHAN_PEG_RCV_INITIALIZED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* Window 1 call */</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="mi">30000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;Receive Peg initialization not complete: 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_set_drv_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_active</span><span class="p">;</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s(%ld): drv_active: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_clear_drv_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_active</span><span class="p">;</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s(%ld): drv_active: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_need_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">drv_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">drv_active</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_set_rst_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">;</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s(%ld): drv_state: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_clear_rst_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">drv_state</span><span class="p">;</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s(%ld): drv_state: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_set_qsnt_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">qsnt_state</span><span class="p">;</span>

	<span class="n">qsnt_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">qsnt_state</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">qsnt_state</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">image_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcie_cap</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">lnk</span><span class="p">;</span>

	<span class="cm">/* scrub dma mask expansion register */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_DMA_SHIFT</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>

	<span class="cm">/* Overwrite stale initialization register values */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_RCVPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_HALT_STATUS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_HALT_STATUS2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_load_fw</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">image_start</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error trying to start fw!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handshake with the card before we register the devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_cmdpeg_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error during card handshake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Negotiated Link width */</span>
	<span class="n">pcie_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_EXP</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pcie_cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lnk</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">link_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">lnk</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="cm">/* Synchronize with Receive peg */</span>
	<span class="k">return</span> <span class="n">qla4_8xxx_rcvpeg_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_try_start_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FW Load priority:</span>
<span class="cm">	 * 1) Operational firmware residing in flash.</span>
<span class="cm">	 * 2) Fail</span>
<span class="cm">	 */</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;FW: Retrieving flash offsets from FLT/FDT ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_get_flash_info</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;FW: Attempting to load firmware from flash...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_start_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_region_fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FW: Load firmware from flash&quot;</span>
		    <span class="s">&quot; FAILED...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_rom_lock_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Someone else is holding the lock. */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resetting rom_lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either we got the lock, or someone</span>
<span class="cm">	 * else died while holding it.</span>
<span class="cm">	 * In either case, unlock.</span>
<span class="cm">	 */</span>
	<span class="n">qla4_8xxx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_rdcrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_crb</span> <span class="o">*</span><span class="n">crb_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">crb_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_crb</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">crb_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_minidump_process_l2tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_count</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p_wait</span><span class="p">,</span> <span class="n">w_time</span><span class="p">,</span> <span class="n">p_mask</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="n">c_value_r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_cache</span> <span class="o">*</span><span class="n">cache_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">cache_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_cache</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>

	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">c_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">c_value_w</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">write_value</span><span class="p">;</span>

	<span class="n">t_r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">t_value</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>
	<span class="n">p_wait</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">poll_wait</span><span class="p">;</span>
	<span class="n">p_mask</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">poll_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c_value_w</span><span class="p">)</span>
			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">p_wait</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">c_value_r</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">c_value_r</span> <span class="o">&amp;</span> <span class="n">p_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">w_time</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* capturing dump failed */</span>
					<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">r_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">t_value</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_minidump_process_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_crb</span> <span class="o">*</span><span class="n">crb_entry</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">poll_time</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crb_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla4_8xxx_minidump_template_hdr</span> <span class="o">*</span><span class="n">tmplt_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">tmplt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla4_8xxx_minidump_template_hdr</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_hdr</span><span class="p">;</span>
	<span class="n">crb_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_crb</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>

	<span class="n">crb_addr</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_WR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span>
					   <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_WR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_RW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_RW</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_AND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">read_value</span> <span class="o">&amp;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_AND</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
				<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_OR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_POLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poll_time</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">poll_timeout</span><span class="p">;</span>
			<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">poll_time</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">read_value</span> <span class="o">&amp;</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span> <span class="o">==</span>
				    <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wtime</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* capturing dump failed */</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
								<span class="n">crb_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_POLL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_RDSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">crb_addr</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">read_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
			<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_RDSTATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_WRSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">state_index_a</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">crb_addr</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
				<span class="n">read_value</span> <span class="o">=</span>
					<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">read_value</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_WRSTATE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="n">QLA82XX_DBG_OPCODE_MDSTATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">state_index_v</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">read_value</span> <span class="o">&lt;&lt;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">shl</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">&gt;&gt;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_ctrl</span><span class="p">.</span><span class="n">shr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span>
				<span class="n">read_value</span> <span class="o">&amp;=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
			<span class="n">read_value</span> <span class="o">+=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>
			<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">opcode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLA82XX_DBG_OPCODE_MDSTATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">crb_addr</span> <span class="o">+=</span> <span class="n">crb_entry</span><span class="o">-&gt;</span><span class="n">crb_strd</span><span class="p">.</span><span class="n">addr_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Leaving fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_rdocm</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdocm</span> <span class="o">*</span><span class="n">ocm_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">ocm_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdocm</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">ocm_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;[%s]: r_addr: 0x%x, r_stride: 0x%x, loop_cnt: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">r_addr</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">));</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Leaving fn: %s datacount: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))));</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_rdmux</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">s_stride</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">s_value</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_mux</span> <span class="o">*</span><span class="n">mux_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">mux_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_mux</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">s_addr</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>
	<span class="n">s_stride</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_value_stride</span><span class="p">;</span>
	<span class="n">s_value</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">select_value</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">mux_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">s_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s_value</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">s_value</span> <span class="o">+=</span> <span class="n">s_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_l1cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_count</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">c_value_w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_cache</span> <span class="o">*</span><span class="n">cache_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">cache_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_cache</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">loop_count</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">c_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">c_value_w</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">cache_ctrl</span><span class="p">.</span><span class="n">write_value</span><span class="p">;</span>

	<span class="n">t_r_addr</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">t_value</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">t_r_addr</span><span class="p">,</span> <span class="n">t_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">c_addr</span><span class="p">,</span> <span class="n">c_value_w</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">r_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">read_ctrl</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">t_value</span> <span class="o">+=</span> <span class="n">cache_hdr</span><span class="o">-&gt;</span><span class="n">addr_ctrl</span><span class="p">.</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_stride</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">r_cnt</span><span class="p">,</span> <span class="n">qid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_queue</span> <span class="o">*</span><span class="n">q_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">q_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_queue</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">s_addr</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>
	<span class="n">r_cnt</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">rd_strd</span><span class="p">.</span><span class="n">read_addr_cnt</span><span class="p">;</span>
	<span class="n">r_stride</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">rd_strd</span><span class="p">.</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">s_addr</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">r_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
			<span class="n">r_addr</span> <span class="o">+=</span> <span class="n">r_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qid</span> <span class="o">+=</span> <span class="n">q_hdr</span><span class="o">-&gt;</span><span class="n">q_strd</span><span class="p">.</span><span class="n">queue_id_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MD_DIRECT_ROM_WINDOW		0x42110030</span>
<span class="cp">#define MD_DIRECT_ROM_READ_BASE		0x42150000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_minidump_process_rdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_value</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdrom</span> <span class="o">*</span><span class="n">rom_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">rom_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdrom</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">rom_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">rom_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;[%s]: flash_addr: 0x%x, read_data_size: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_DIRECT_ROM_WINDOW</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					     <span class="n">MD_DIRECT_ROM_READ_BASE</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_value</span><span class="p">);</span>
		<span class="n">r_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MD_MIU_TEST_AGT_CTRL		0x41000090</span>
<span class="cp">#define MD_MIU_TEST_AGT_ADDR_LO		0x41000094</span>
<span class="cp">#define MD_MIU_TEST_AGT_ADDR_HI		0x41000098</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_minidump_process_rdmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="o">**</span><span class="n">d_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">r_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdmem</span> <span class="o">*</span><span class="n">m_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">d_ptr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Entering fn: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">m_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_rdmem</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="n">r_addr</span> <span class="o">=</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;[%s]: Read addr: 0x%x, read_data_size: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_addr</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;[%s]: Read addr 0x%x not 16 bytes alligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;[%s]: Read data[0x%x] not multiple of 16 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;[%s]: rdmem_addr: 0x%x, read_data_size: 0x%x, loop_cnt: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="n">m_hdr</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">));</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_ADDR_LO</span><span class="p">,</span> <span class="n">r_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_ADDR_HI</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">r_value</span> <span class="o">=</span> <span class="n">MIU_TA_CTL_START</span> <span class="o">|</span> <span class="n">MIU_TA_CTL_ENABLE</span><span class="p">;</span>
		<span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_value</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MD_MIU_TEST_AGT_CTRL</span><span class="p">,</span>
						     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r_value</span> <span class="o">&amp;</span> <span class="n">MIU_TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span>
					   <span class="s">&quot;%s: failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">__func__</span><span class="p">);</span>
			<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r_data</span> <span class="o">=</span> <span class="n">qla4_8xxx_md_rw_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						    <span class="n">MD_MIU_TEST_AGT_RDDATA</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r_data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">r_addr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Leaving fn: %s datacount: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="o">*</span><span class="n">d_ptr</span> <span class="o">=</span> <span class="n">data_ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">QLA82XX_DBG_SKIPPED_FLAG</span><span class="p">;</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;scsi(%ld): Skipping entry[%d]: ETYPE[0x%x]-ELEVEL[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">,</span>
			  <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla82xx_collect_md_data - Retrieve firmware minidump data.</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_collect_md_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_entry_hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla4_8xxx_minidump_template_hdr</span> <span class="o">*</span><span class="n">tmplt_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">data_collected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timestamp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s(%ld) No buffer to dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmplt_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla4_8xxx_minidump_template_hdr</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_hdr</span><span class="p">;</span>
	<span class="n">data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span> <span class="o">+</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span><span class="p">);</span>
	<span class="n">data_collected</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span><span class="p">;</span>

	<span class="n">num_entry_hdr</span> <span class="o">=</span> <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">num_of_entries</span><span class="p">;</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;[%s]: starting data ptr: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">);</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		   <span class="s">&quot;[%s]: no of entry headers in Template: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">num_entry_hdr</span><span class="p">);</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;[%s]: Capture Mask obtained: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_capture_mask</span><span class="p">);</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;[%s]: Total_data_size 0x%x, %d obtained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">);</span>

	<span class="cm">/* Update current timestamp before taking dump */</span>
	<span class="n">now</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
	<span class="n">timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">driver_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>

	<span class="n">entry_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_hdr</span><span class="p">)</span> <span class="o">+</span>
					 <span class="n">tmplt_hdr</span><span class="o">-&gt;</span><span class="n">first_entry_offset</span><span class="p">);</span>

	<span class="cm">/* Walk through the entry headers - validate/perform required action */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_entry_hdr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_collected</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;Data collected: [0x%x], Total Dump size: [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">data_collected</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">entry_capture_mask</span> <span class="o">&amp;</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_capture_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">d_ctrl</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span>
						<span class="n">QLA82XX_DBG_SKIPPED_FLAG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">skip_nxt_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Data collected: [0x%x], Dump size left:[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">data_collected</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span> <span class="o">-</span> <span class="n">data_collected</span><span class="p">)));</span>

		<span class="cm">/* Decode the entry type and take required action to capture</span>
<span class="cm">		 * debug data</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDEND</span>:
			<span class="n">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_CNTRL</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_minidump_process_control</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
								  <span class="n">entry_hdr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDCRB</span>:
			<span class="n">qla4_8xxx_minidump_process_rdcrb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDMEM</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_minidump_process_rdmem</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_BOARD</span>:
		<span class="k">case</span> <span class="n">QLA82XX_RDROM</span>:
			<span class="n">qla4_8xxx_minidump_process_rdrom</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_L2DTG</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2ITG</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2DAT</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L2INS</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_minidump_process_l2tag</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_L1DAT</span>:
		<span class="k">case</span> <span class="n">QLA82XX_L1INS</span>:
			<span class="n">qla4_8xxx_minidump_process_l1cache</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDOCM</span>:
			<span class="n">qla4_8xxx_minidump_process_rdocm</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDMUX</span>:
			<span class="n">qla4_8xxx_minidump_process_rdmux</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_QUEUE</span>:
			<span class="n">qla4_8xxx_minidump_process_queue</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">data_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_RDNOP</span>:
		<span class="nl">default:</span>
			<span class="n">ql4_8xxx_mark_entry_skipped</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">entry_hdr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data_collected</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span> <span class="o">-</span>
				 <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span> <span class="o">+</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span><span class="p">));</span>
<span class="nl">skip_nxt_entry:</span>
		<span class="cm">/*  next entry in the template */</span>
		<span class="n">entry_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla82xx_minidump_entry_hdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">(((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">entry_hdr</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data_collected</span> <span class="o">+</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;Dump data mismatch: Data collected: [0x%x], total_data_size:[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">data_collected</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">md_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Leaving fn: %s Last entry: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
<span class="nl">md_failed:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_uevent_emit - Send uevent when the firmware dump is ready.</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_uevent_emit</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">event_string</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">event_string</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QL4_UEVENT_CODE_FW_DUMP</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">event_string</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event_string</span><span class="p">),</span> <span class="s">&quot;FW_DUMP=%ld&quot;</span><span class="p">,</span>
			 <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*do nothing*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_device_bootstrap - Initialize device, set DEV_READY, start fw</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Note: IDC lock must be held upon entry</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_device_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_count</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">peg_stuck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">need_reset</span> <span class="o">=</span> <span class="n">qla4_8xxx_need_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">old_count</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			   <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">old_count</span><span class="p">)</span>
			<span class="n">peg_stuck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are trying to perform a recovery here. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peg_stuck</span><span class="p">)</span>
			<span class="n">qla4_8xxx_rom_lock_recovery</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">dev_initialize</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* Start of day for this ha context. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peg_stuck</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Either we are the first or recovery in progress. */</span>
			<span class="n">qla4_8xxx_rom_lock_recovery</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">dev_initialize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Firmware already running. */</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">dev_ready</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">dev_initialize:</span>
	<span class="cm">/* set to DEV_INITIALIZING */</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: INITIALIZING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_INITIALIZING</span><span class="p">);</span>

	<span class="cm">/* Driver that sets device state to initializating sets IDC version */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_IDC_VERSION</span><span class="p">,</span> <span class="n">QLA82XX_IDC_VERSION</span><span class="p">);</span>

	<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xenablemd</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">AF_82XX_FW_DUMPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4_8xxx_collect_md_data</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_uevent_emit</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QL4_UEVENT_CODE_FW_DUMP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unable to collect minidump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_82XX_FW_DUMPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_try_start_fw</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla4_8xxx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">dev_ready:</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_READY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_need_reset_handler - Code to start reset sequence</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Note: IDC lock must be held upon entry</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_need_reset_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">active_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reset_timeout</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		<span class="s">&quot;Performing ISP error recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_82XX_RST_OWNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s(%ld): reset acknowledged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">));</span>
		<span class="n">qla4_8xxx_set_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">active_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/* wait for 10 seconds for reset ack from all functions */</span>
	<span class="n">reset_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		<span class="s">&quot;%s(%ld): drv_state = 0x%x, drv_active = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">drv_state</span> <span class="o">!=</span> <span class="p">(</span><span class="n">drv_active</span> <span class="o">&amp;</span> <span class="n">active_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">reset_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;%s: RESET TIMEOUT! drv_state: 0x%08x, drv_active: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span> <span class="n">drv_active</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * When reset_owner times out, check which functions</span>
<span class="cm">		 * acked/did not ack</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_82XX_RST_OWNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;%s(%ld): drv_state = 0x%x, drv_active = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">drv_state</span><span class="p">,</span>
				   <span class="n">drv_active</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="n">drv_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">drv_active</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear RESET OWNER as we are not going to use it any further */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_82XX_RST_OWNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device state is 0x%x = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_state</span><span class="p">,</span>
		   <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span> <span class="n">qdev_state</span><span class="p">[</span><span class="n">dev_state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>

	<span class="cm">/* Force to DEV_COLD unless someone else is starting a reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">!=</span> <span class="n">QLA82XX_DEV_INITIALIZING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: COLD/RE-INIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLA82XX_DEV_COLD</span><span class="p">);</span>
		<span class="n">qla4_8xxx_set_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_need_qsnt_handler - Code to start qsnt</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">qla4_8xxx_need_qsnt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_set_qsnt_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_device_state_handler - Adapter state machine</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: IDC lock must be UNLOCKED upon entry</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4_8xxx_device_state_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_init_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_set_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device state is 0x%x = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_state</span><span class="p">,</span> <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span>
			  <span class="n">qdev_state</span><span class="p">[</span><span class="n">dev_state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">));</span>

	<span class="cm">/* wait for 30 seconds for device to go ready */</span>
	<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_init_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;%s: Device Init Failed 0x%x = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">DRIVER_NAME</span><span class="p">,</span>
				   <span class="n">dev_state</span><span class="p">,</span> <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span>
				   <span class="n">qdev_state</span><span class="p">[</span><span class="n">dev_state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
				<span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device state is 0x%x = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev_state</span><span class="p">,</span> <span class="n">dev_state</span> <span class="o">&lt;</span> <span class="n">MAX_STATES</span> <span class="o">?</span>
			   <span class="n">qdev_state</span><span class="p">[</span><span class="n">dev_state</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>

		<span class="cm">/* NOTE: Make sure idc unlocked upon exit of switch statement */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_READY</span>:
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_COLD</span>:
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_device_bootstrap</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_INITIALIZING</span>:
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_NEED_RESET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla4_8xxx_need_reset_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="cm">/* Update timeout value after need</span>
<span class="cm">				 * reset handler */</span>
				<span class="n">dev_init_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_NEED_QUIESCENT</span>:
			<span class="cm">/* idc locked/unlocked in handler */</span>
			<span class="n">qla4_8xxx_need_qsnt_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_QUIESCENT</span>:
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA82XX_DEV_FAILED</span>:
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4xxx_dead_adapter_cleanup</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4xxx_dead_adapter_cleanup</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4_8xxx_load_risc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* clear the interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">qla4_8xxx_device_state_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">qla4xxx_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* Flash Manipulation Routines                                               */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="cp">#define OPTROM_BURST_SIZE       0x1000</span>
<span class="cp">#define OPTROM_BURST_DWORDS     (OPTROM_BURST_SIZE / 4)</span>

<span class="cp">#define FARX_DATA_FLAG	BIT_31</span>
<span class="cp">#define FARX_ACCESS_FLASH_CONF	0x7FFD0000</span>
<span class="cp">#define FARX_ACCESS_FLASH_DATA	0x7FF00000</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">flash_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span>
<span class="nf">flash_data_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">|</span> <span class="n">faddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="o">*</span>
<span class="nf">qla4_8xxx_read_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dwptr</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">faddr</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">qla4_8xxx_rom_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">loops</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;ROM lock failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dwptr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Dword reads to flash. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">faddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_do_rom_fast_read</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">faddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;Do ROM fast read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_read</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dwptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done_read:</span>
	<span class="n">qla4_8xxx_rom_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dwptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Address and length are byte address</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span>
<span class="nf">qla4_8xxx_read_optrom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_read_flash_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_find_flt_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;DEF&quot;</span><span class="p">,</span> <span class="s">&quot;PCI&quot;</span> <span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * FLT-location structure resides after the last PCI region.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Begin with sane defaults. */</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">FA_FLASH_LAYOUT_ADDR_82</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FLTL[%s] = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_get_flt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flt_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;DEF&quot;</span><span class="p">,</span> <span class="s">&quot;FLT&quot;</span> <span class="p">};</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_flt_header</span> <span class="o">*</span><span class="n">flt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_flt_region</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_flt</span> <span class="o">=</span> <span class="n">flt_addr</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">flt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">region</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_region</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">qla4_8xxx_read_optrom_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">,</span>
			<span class="n">flt_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unsupported FLT detected: &quot;</span>
			<span class="s">&quot;version=0x%x length=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">)));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Inconsistent FLT detected: &quot;</span>
			<span class="s">&quot;version=0x%x length=0x%x checksum=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
			<span class="n">chksum</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">flt</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_flt_region</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">,</span> <span class="n">region</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Store addresses as DWORD offsets. */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">DEBUG3</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FLT[%02x]: start=0x%x &quot;</span>
		    <span class="s">&quot;end=0x%x size=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLT_REG_FDT</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_BOOT_CODE_82</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_FW_82</span>:
		<span class="k">case</span> <span class="n">FLT_REG_FW_82_1</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_BOOTLOAD_82</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_bootload</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_ISCSI_PARAM</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_iscsi_param</span> <span class="o">=</span>  <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLT_REG_ISCSI_CHAP</span>:
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_chap</span> <span class="o">=</span>  <span class="n">start</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_chap_size</span> <span class="o">=</span>  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">no_flash_data:</span>
	<span class="cm">/* Use hardcoded defaults. */</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span>      <span class="o">=</span> <span class="n">FA_FLASH_DESCR_ADDR_82</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span>     <span class="o">=</span> <span class="n">FA_BOOT_CODE_ADDR_82</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_bootload</span> <span class="o">=</span> <span class="n">FA_BOOT_LOAD_ADDR_82</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span>       <span class="o">=</span> <span class="n">FA_RISC_CODE_ADDR_82</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_chap</span>	<span class="o">=</span> <span class="n">FA_FLASH_ISCSI_CHAP</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_chap_size</span>	<span class="o">=</span> <span class="n">FA_FLASH_CHAP_SIZE</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FLT[%s]: flt=0x%x fdt=0x%x &quot;</span>
	    <span class="s">&quot;boot=0x%x bootload=0x%x fw=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_flt</span><span class="p">,</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span><span class="p">,</span>	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_boot</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_bootload</span><span class="p">,</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fw</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_get_fdt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define FLASH_BLK_SIZE_4K       0x1000</span>
<span class="cp">#define FLASH_BLK_SIZE_32K      0x8000</span>
<span class="cp">#define FLASH_BLK_SIZE_64K      0x10000</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;MID&quot;</span><span class="p">,</span> <span class="s">&quot;FDT&quot;</span> <span class="p">};</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">chksum</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_fdt_layout</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">mid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_conf_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_CONF</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_data_off</span> <span class="o">=</span> <span class="n">FARX_ACCESS_FLASH_DATA</span><span class="p">;</span>

	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">fdt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qla_fdt_layout</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">qla4_8xxx_read_optrom_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">,</span>
	    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flt_region_fdt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">OPTROM_BURST_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;Q&#39;</span> <span class="o">||</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;I&#39;</span> <span class="o">||</span>
	    <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;D&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_fdt_layout</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chksum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Inconsistent FDT detected: &quot;</span>
		    <span class="s">&quot;checksum=0x%x id=%c version=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chksum</span><span class="p">,</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)));</span>
		<span class="k">goto</span> <span class="n">no_flash_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">man_id</span><span class="p">);</span>
	<span class="n">fid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">wrt_disable_bits</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">erase_cmd</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fdt</span><span class="o">-&gt;</span><span class="n">unprotect_sec_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span> <span class="o">=</span> <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span>
		    <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">unprotect_sec_cmd</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span> <span class="o">=</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">protect_sec_cmd</span> <span class="o">?</span>
		    <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0300</span> <span class="o">|</span> <span class="n">fdt</span><span class="o">-&gt;</span><span class="n">protect_sec_cmd</span><span class="p">)</span> <span class="o">:</span>
		    <span class="n">flash_conf_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x0336</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">no_flash_data:</span>
	<span class="n">loc</span> <span class="o">=</span> <span class="n">locations</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span> <span class="o">=</span> <span class="n">FLASH_BLK_SIZE_64K</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;FDT[%s]: (0x%x/0x%x) erase=0x%x &quot;</span>
		<span class="s">&quot;pro=%x upro=%x wrtd=0x%x blk=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_erase_cmd</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_protect_sec_cmd</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_unprotect_sec_cmd</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_wrt_disable</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fdt_block_size</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4_8xxx_get_idc_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define QLA82XX_IDC_PARAM_ADDR      0x003e885c</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">wptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">wptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="n">qla4_8xxx_read_optrom_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">,</span>
			<span class="n">QLA82XX_IDC_PARAM_ADDR</span> <span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wptr</span> <span class="o">==</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">=</span> <span class="n">ROM_DEV_INIT_TIMEOUT</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">=</span> <span class="n">ROM_DRV_RESET_ACK_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">wptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		<span class="s">&quot;ha-&gt;nx_dev_init_timeout = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_dev_init_timeout</span><span class="p">));</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		<span class="s">&quot;ha-&gt;nx_reset_timeout = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_reset_timeout</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_get_flash_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_addr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4_8xxx_find_flt_start</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flt_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">qla4_8xxx_get_flt_info</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">flt_addr</span><span class="p">);</span>
	<span class="n">qla4_8xxx_get_fdt_info</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_get_idc_param</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_stop_firmware - stops firmware on specified adapter instance</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> * For iSCSI, throws away all I/O and AENs into bit bucket, so they will</span>
<span class="cm"> * not be available after successful return.  Driver must cleanup potential</span>
<span class="cm"> * outstanding I/O&#39;s after calling this funcion.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">qla4_8xxx_stop_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_STOP_FW</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_isp_reset - Resets ISP and aborts all outstanding commands.</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">qla4_8xxx_isp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>

	<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: NEED RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
		    <span class="n">QLA82XX_DEV_NEED_RESET</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_82XX_RST_OWNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: DEVICE INITIALIZING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4_8xxx_device_state_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_clear_rst_ready</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Clearing AF_RECOVERY in qla4_8xxx_isp_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_get_sys_info - get adapter MAC address(es) and serial number</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4_8xxx_get_sys_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mbx_sys_info</span> <span class="o">*</span><span class="n">sys_info</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">sys_info_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">sys_info</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sys_info</span><span class="p">),</span>
				      <span class="o">&amp;</span><span class="n">sys_info_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sys_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Unable to allocate dma buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sys_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sys_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_SYS_INFO</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">sys_info_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">sys_info_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sys_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: GET_SYS_INFO failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_validate_mac82</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we receive the minimum required data to cache internally */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbx_sys_info</span><span class="p">,</span> <span class="n">reserved</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: GET_SYS_INFO data receive&quot;</span>
		    <span class="s">&quot; error (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
		<span class="k">goto</span> <span class="n">exit_validate_mac82</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Save M.A.C. address &amp; serial_number */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">)));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">,</span>
	    <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">)));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">board_id_str</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">board_id_str</span><span class="p">)));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_port_cnt</span> <span class="o">=</span> <span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">phys_port_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">phy_port_num</span> <span class="o">=</span> <span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">port_num</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iscsi_pci_func_cnt</span> <span class="o">=</span> <span class="n">sys_info</span><span class="o">-&gt;</span><span class="n">iscsi_pci_func_cnt</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: &quot;</span>
	    <span class="s">&quot;mac %02x:%02x:%02x:%02x:%02x:%02x &quot;</span>
	    <span class="s">&quot;serial %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_validate_mac82:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sys_info</span><span class="p">),</span> <span class="n">sys_info</span><span class="p">,</span>
			  <span class="n">sys_info_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handling helpers. */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_mbx_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_ENABLE_INTRS</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">INTR_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s: MBOX_CMD_ENABLE_INTRS failed (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4_8xxx_mbx_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_ENABLE_INTRS</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">INTR_DISABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			<span class="s">&quot;%s: MBOX_CMD_ENABLE_INTRS failed (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_enable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4_8xxx_mbx_intr_enable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="cm">/* BIT 10 - reset */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_INTERRUPTS_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_disable_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_INTERRUPTS_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">qla4_8xxx_mbx_intr_disable</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
	<span class="cm">/* BIT 10 - set */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ql4_init_msix_entry</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ql4_init_msix_entry</span> <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">QLA_MSIX_ENTRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">QLA_MSIX_DEFAULT</span><span class="p">,</span> <span class="n">QLA_MIDX_DEFAULT</span><span class="p">,</span>
	    <span class="s">&quot;qla4xxx (default)&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">irq_handler_t</span><span class="p">)</span><span class="n">qla4_8xxx_default_intr_handler</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">QLA_MSIX_RSP_Q</span><span class="p">,</span> <span class="n">QLA_MIDX_RSP_Q</span><span class="p">,</span>
	    <span class="s">&quot;qla4xxx (rsp_q)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">irq_handler_t</span><span class="p">)</span><span class="n">qla4_8xxx_msix_rsp_q</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">qla4_8xxx_disable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_msix_entry</span> <span class="o">*</span><span class="n">qentry</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLA_MSIX_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">msix_vector</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qla4_8xxx_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">entries</span><span class="p">[</span><span class="n">QLA_MSIX_ENTRIES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ql4_msix_entry</span> <span class="o">*</span><span class="n">qentry</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLA_MSIX_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">entries</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Failed to enable support -- %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">QLA_MSIX_ENTRIES</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">msix_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLA_MSIX_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qentry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">];</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">msix_vector</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">msix_entry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">qentry</span><span class="o">-&gt;</span><span class="n">msix_vector</span><span class="p">,</span>
		    <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;MSI-X: Unable to register handler -- %x/%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">qla4_8xxx_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">msix_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qentry</span><span class="o">-&gt;</span><span class="n">have_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">qla4_8xxx_msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">msix_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
