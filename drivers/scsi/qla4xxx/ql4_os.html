<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_os.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_os.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/iscsi_boot_sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsicam.h&gt;</span>

<span class="cp">#include &quot;ql4_def.h&quot;</span>
<span class="cp">#include &quot;ql4_version.h&quot;</span>
<span class="cp">#include &quot;ql4_glbl.h&quot;</span>
<span class="cp">#include &quot;ql4_dbg.h&quot;</span>
<span class="cp">#include &quot;ql4_inline.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Driver version</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">qla4xxx_version_str</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * SRB allocation cache</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">srb_cachep</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Module parameter information and variables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ql4xdisablesysfsboot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xdisablesysfsboot</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xdisablesysfsboot</span><span class="p">,</span>
		 <span class="s">&quot; Set to disable exporting boot targets to sysfs.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 - Export boot targets</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  1 - Do not export boot targets (Default)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql4xdontresethba</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">,</span>
		 <span class="s">&quot; Don&#39;t reset the HBA for driver recovery.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 - It will reset HBA (Default)</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  1 - It will NOT reset HBA&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql4xextended_error_logging</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xextended_error_logging</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xextended_error_logging</span><span class="p">,</span>
		 <span class="s">&quot; Option to enable extended error logging.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 - no logging (Default)</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  2 - debug logging&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql4xenablemsix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xenablemsix</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xenablemsix</span><span class="p">,</span>
		 <span class="s">&quot; Set to enable MSI or MSI-X interrupt mechanism.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 = enable INTx interrupt mechanism.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  1 = enable MSI-X interrupt mechanism (Default).</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  2 = enable MSI interrupt mechanism.&quot;</span><span class="p">);</span>

<span class="cp">#define QL4_DEF_QDEPTH 32</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ql4xmaxqdepth</span> <span class="o">=</span> <span class="n">QL4_DEF_QDEPTH</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xmaxqdepth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xmaxqdepth</span><span class="p">,</span>
		 <span class="s">&quot; Maximum queue depth to report for target devices.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  Default: 32.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ql4xqfulltracking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xqfulltracking</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xqfulltracking</span><span class="p">,</span>
		 <span class="s">&quot; Enable or disable dynamic tracking and adjustment of</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> scsi device queue depth.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 - Disable.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  1 - Enable. (Default)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ql4xsess_recovery_tmo</span> <span class="o">=</span> <span class="n">QL4_SESS_RECOVERY_TMO</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xsess_recovery_tmo</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xsess_recovery_tmo</span><span class="p">,</span>
		<span class="s">&quot; Target Session Recovery Timeout.</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  Default: 120 sec.&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql4xmdcapmask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xmdcapmask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xmdcapmask</span><span class="p">,</span>
		 <span class="s">&quot; Set the Minidump driver capture mask level.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  Default is 0x1F.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  Can be set to 0x3, 0x7, 0xF, 0x1F, 0x3F, 0x7F&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ql4xenablemd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ql4xenablemd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ql4xenablemd</span><span class="p">,</span>
		 <span class="s">&quot; Set to enable minidump.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  0 - disable minidump</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">  1 - enable minidump (Default)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_wait_for_hba_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm"> * SCSI host template entry points</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_config_dma_addressing</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * iSCSI template entry points</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_session_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_conn_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_host_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_iface_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_get_iface_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iscsi_param_type</span> <span class="n">param_type</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">qla4xxx_eh_cmd_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">qla4xxx_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_get_ep_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span>
<span class="n">qla4xxx_conn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">conn_idx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			     <span class="kt">uint64_t</span> <span class="n">transport_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span>
<span class="n">qla4xxx_session_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmds_max</span><span class="p">,</span>
			<span class="kt">uint16_t</span> <span class="n">qdepth</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">initial_cmdsn</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_session_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_task_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">wdata</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_alloc_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_task_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_task_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_fail_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_conn_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_send_ping</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">iface_num</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">iface_type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">payload_size</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_get_chap_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_delete_chap</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SCSI host template entry points</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_eh_target_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qla4xxx_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">umode_t</span> <span class="n">ql4_attr_is_visible</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qla4xxx_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">reason</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla4_8xxx_legacy_intr_set</span> <span class="n">legacy_intr</span><span class="p">[]</span> <span class="o">=</span>
    <span class="n">QLA82XX_LEGACY_INTR_CONFIG</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">qla4xxx_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>		<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>		<span class="o">=</span> <span class="n">qla4xxx_queuecommand</span><span class="p">,</span>

	<span class="p">.</span><span class="n">eh_abort_handler</span>	<span class="o">=</span> <span class="n">qla4xxx_eh_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">qla4xxx_eh_device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_target_reset_handler</span> <span class="o">=</span> <span class="n">qla4xxx_eh_target_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>	<span class="o">=</span> <span class="n">qla4xxx_eh_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_timed_out</span>		<span class="o">=</span> <span class="n">qla4xxx_eh_cmd_timed_out</span><span class="p">,</span>

	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">qla4xxx_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>		<span class="o">=</span> <span class="n">qla4xxx_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>		<span class="o">=</span> <span class="n">qla4xxx_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span>	<span class="o">=</span> <span class="n">qla4xxx_change_queue_depth</span><span class="p">,</span>

	<span class="p">.</span><span class="n">this_id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>		<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>

	<span class="p">.</span><span class="n">max_sectors</span>		<span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">qla4xxx_host_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">host_reset</span>		<span class="o">=</span> <span class="n">qla4xxx_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vendor_id</span>		<span class="o">=</span> <span class="n">SCSI_NL_VID_TYPE_PCI</span> <span class="o">|</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_transport</span> <span class="n">qla4xxx_iscsi_transport</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">caps</span>			<span class="o">=</span> <span class="n">CAP_TEXT_NEGO</span> <span class="o">|</span>
				  <span class="n">CAP_DATA_PATH_OFFLOAD</span> <span class="o">|</span> <span class="n">CAP_HDRDGST</span> <span class="o">|</span>
				  <span class="n">CAP_DATADGST</span> <span class="o">|</span> <span class="n">CAP_LOGIN_OFFLOAD</span> <span class="o">|</span>
				  <span class="n">CAP_MULTI_R2T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attr_is_visible</span>	<span class="o">=</span> <span class="n">ql4_attr_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_session</span>         <span class="o">=</span> <span class="n">qla4xxx_session_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_session</span>        <span class="o">=</span> <span class="n">qla4xxx_session_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_conn</span>             <span class="o">=</span> <span class="n">qla4xxx_conn_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_conn</span>            <span class="o">=</span> <span class="n">qla4xxx_conn_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind_conn</span>              <span class="o">=</span> <span class="n">qla4xxx_conn_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_conn</span>              <span class="o">=</span> <span class="n">iscsi_conn_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_conn</span>           <span class="o">=</span> <span class="n">qla4xxx_conn_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_param</span>              <span class="o">=</span> <span class="n">iscsi_set_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_conn_param</span>		<span class="o">=</span> <span class="n">qla4xxx_conn_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_session_param</span>	<span class="o">=</span> <span class="n">qla4xxx_session_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ep_param</span>           <span class="o">=</span> <span class="n">qla4xxx_get_ep_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_connect</span>		<span class="o">=</span> <span class="n">qla4xxx_ep_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_poll</span>		<span class="o">=</span> <span class="n">qla4xxx_ep_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ep_disconnect</span>		<span class="o">=</span> <span class="n">qla4xxx_ep_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">qla4xxx_conn_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_pdu</span>		<span class="o">=</span> <span class="n">iscsi_conn_send_pdu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xmit_task</span>		<span class="o">=</span> <span class="n">qla4xxx_task_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup_task</span>		<span class="o">=</span> <span class="n">qla4xxx_task_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_pdu</span>		<span class="o">=</span> <span class="n">qla4xxx_alloc_pdu</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_host_param</span>		<span class="o">=</span> <span class="n">qla4xxx_host_get_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_iface_param</span>	<span class="o">=</span> <span class="n">qla4xxx_iface_set_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_iface_param</span>	<span class="o">=</span> <span class="n">qla4xxx_get_iface_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bsg_request</span>		<span class="o">=</span> <span class="n">qla4xxx_bsg_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_ping</span>		<span class="o">=</span> <span class="n">qla4xxx_send_ping</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_chap</span>		<span class="o">=</span> <span class="n">qla4xxx_get_chap_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">delete_chap</span>		<span class="o">=</span> <span class="n">qla4xxx_delete_chap</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">qla4xxx_scsi_transport</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_send_ping</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">iface_num</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">iface_type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">payload_size</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipaddr</span><span class="p">[</span><span class="n">IPv6_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IPv6_ADDR_LEN</span><span class="p">);</span>
	<span class="cm">/* IPv4 to IPv4 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">IP_ADDR_LEN</span><span class="p">);</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: IPv4 Ping src: %pI4 &quot;</span>
				  <span class="s">&quot;dest: %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_ping_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
					 <span class="n">ipaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* IPv6 to IPv6 */</span>
		<span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">.</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">,</span> <span class="n">IPv6_ADDR_LEN</span><span class="p">);</span>

		<span class="n">options</span> <span class="o">|=</span> <span class="n">PING_IPV6_PROTOCOL_ENABLE</span><span class="p">;</span>

		<span class="cm">/* Ping using LinkLocal address */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: LinkLocal Ping &quot;</span>
					  <span class="s">&quot;src: %pI6 dest: %pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">,</span>
					  <span class="n">ipaddr</span><span class="p">));</span>
			<span class="n">options</span> <span class="o">|=</span> <span class="n">PING_IPV6_LINKLOCAL_ADDR</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_ping_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span>
						 <span class="n">pid</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: iface num = %d &quot;</span>
				   <span class="s">&quot;not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">iface_num</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_send_ping</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If ping using LinkLocal address fails, try ping using</span>
<span class="cm">		 * IPv6 address</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PING_IPV6_LINKLOCAL_ADDR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">options</span> <span class="o">|=</span> <span class="n">PING_IPV6_ADDR0</span><span class="p">;</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: IPv6 &quot;</span>
						  <span class="s">&quot;Ping src: %pI6 &quot;</span>
						  <span class="s">&quot;dest: %pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr0</span><span class="p">,</span>
						  <span class="n">ipaddr</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">options</span> <span class="o">|=</span> <span class="n">PING_IPV6_ADDR1</span><span class="p">;</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: IPv6 &quot;</span>
						  <span class="s">&quot;Ping src: %pI6 &quot;</span>
						  <span class="s">&quot;dest: %pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr1</span><span class="p">,</span>
						  <span class="n">ipaddr</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_ping_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span>
						 <span class="n">pid</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="nl">exit_send_ping:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">ql4_attr_is_visible</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_INITIATOR_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_STATE</span>:
		<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_SPEED</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PERSISTENT_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TARGET_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TPGT</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_TARGET_ALIAS</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_R2T</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_FIRST_BURST</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_RECV_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_MAX_XMIT_DLENGTH</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_IFACE_NAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CHAP_OUT_IDX</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_CHAP_IN_IDX</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_USERNAME_IN</span>:
		<span class="k">case</span> <span class="n">ISCSI_PARAM_PASSWORD_IN</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ROUTER</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR_AUTOCFG</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL_AUTOCFG</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ID</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_PRIORITY</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ENABLED</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_MTU</span>:
		<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_PORT</span>:
			<span class="k">return</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_chap_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_chap_rec</span> <span class="o">*</span><span class="n">chap_rec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_chap_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid_chap_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="n">MAX_CHAP_ENTRIES_40XX</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: num_entries = %d, CHAP idx = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">,</span> <span class="n">chap_tbl_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_get_chap_list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chap_rec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_chap_rec</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">chap_tbl_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chap_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chap_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CHAP_VALID_COOKIE</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ISCSI_CHAP_AUTH_NAME_MAX_LEN</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span>
			<span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">);</span>
		<span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">password_length</span> <span class="o">=</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="cm">/* local */</span>
			<span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">chap_type</span> <span class="o">=</span> <span class="n">CHAP_TYPE_OUT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">)</span> <span class="cm">/* peer */</span>
			<span class="n">chap_rec</span><span class="o">-&gt;</span><span class="n">chap_type</span> <span class="o">=</span> <span class="n">CHAP_TYPE_IN</span><span class="p">;</span>

		<span class="n">chap_rec</span><span class="o">++</span><span class="p">;</span>

		<span class="n">valid_chap_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_chap_entries</span> <span class="o">==</span> <span class="o">*</span><span class="n">num_entries</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>

<span class="nl">exit_get_chap_list:</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Valid CHAP Entries = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>  <span class="n">valid_chap_entries</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">valid_chap_entries</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qla4xxx_is_chap_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">chap_tbl_idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscsi_is_session_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_is_chap_active</span><span class="p">;</span>

	<span class="n">cls_session</span> <span class="o">=</span> <span class="n">iscsi_dev_to_session</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_session_chkready</span><span class="p">(</span><span class="n">cls_session</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_is_chap_active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span> <span class="o">==</span> <span class="o">*</span><span class="n">chap_tbl_idx</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">exit_is_chap_active:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_is_chap_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				  <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_for_each_child</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chap_tbl_idx</span><span class="p">,</span>
				    <span class="n">__qla4xxx_is_chap_active</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_delete_chap</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">chap_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_chap_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">chap_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chap_table</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">chap_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="n">MAX_CHAP_ENTRIES_40XX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chap_tbl_idx</span> <span class="o">&gt;</span> <span class="n">max_chap_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_delete_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if chap index is in use.</span>
<span class="cm">	 * If chap is in use don&#39;t delet chap entry */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_is_chap_active</span><span class="p">(</span><span class="n">shost</span><span class="p">,</span> <span class="n">chap_tbl_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;CHAP entry %d is in use, cannot &quot;</span>
			   <span class="s">&quot;delete from flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chap_tbl_idx</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_delete_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chap_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_CHAP_OFFSET</span> <span class="o">|</span> <span class="p">(</span><span class="n">chap_tbl_idx</span> <span class="o">*</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_RAW_ACCESS_ADDR</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_region_chap</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* flt_chap_size is CHAP table size for both ports</span>
<span class="cm">		 * so divide it by 2 to calculate the offset for second port</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chap_tbl_idx</span> <span class="o">*</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_delete_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Chap Cookie: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHAP_VALID_COOKIE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;No valid chap entry found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_delete_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_CHAP_OFFSET</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">chap_tbl_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_set_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">,</span>
				<span class="n">FLASH_OPT_RMW_COMMIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
		<span class="cm">/* Update ha chap_list cache */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">+</span> <span class="n">chap_tbl_idx</span><span class="p">,</span>
			<span class="n">chap_table</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">exit_delete_chap:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">chap_table</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_iface_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iscsi_param_type</span> <span class="n">param_type</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">iscsi_iface_to_shost</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_type</span> <span class="o">!=</span> <span class="n">ISCSI_NET_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ip_address</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">subnet_mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">gateway</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_options</span> <span class="o">&amp;</span>
				       <span class="n">IPOPT_IPV4_PROTOCOL_ENABLE</span><span class="p">)</span> <span class="o">?</span>
				      <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_options</span> <span class="o">&amp;</span>
				       <span class="n">IPV6_OPT_IPV6_PROTOCOL_ENABLE</span><span class="p">)</span> <span class="o">?</span>
				       <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">tcp_options</span> <span class="o">&amp;</span> <span class="n">TCPOPT_DHCP_ENABLE</span><span class="p">)</span> <span class="o">?</span>
			      <span class="s">&quot;dhcp&quot;</span> <span class="o">:</span> <span class="s">&quot;static&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ROUTER</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_default_router_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR_AUTOCFG</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addl_options</span> <span class="o">&amp;</span>
			       <span class="n">IPV6_ADDOPT_NEIGHBOR_DISCOVERY_ADDR_ENABLE</span><span class="p">)</span> <span class="o">?</span>
			       <span class="s">&quot;nd&quot;</span> <span class="o">:</span> <span class="s">&quot;static&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL_AUTOCFG</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addl_options</span> <span class="o">&amp;</span>
			       <span class="n">IPV6_ADDOPT_AUTOCONFIG_LINK_LOCAL_ADDR</span><span class="p">)</span> <span class="o">?</span>
			       <span class="s">&quot;auto&quot;</span> <span class="o">:</span> <span class="s">&quot;static&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_vlan_tag</span> <span class="o">&amp;</span>
				       <span class="n">ISCSI_MAX_VLAN_ID</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_vlan_tag</span> <span class="o">&amp;</span>
				       <span class="n">ISCSI_MAX_VLAN_ID</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_PRIORITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_vlan_tag</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">ISCSI_MAX_VLAN_PRIORITY</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_vlan_tag</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">ISCSI_MAX_VLAN_PRIORITY</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_options</span> <span class="o">&amp;</span>
				       <span class="n">IPOPT_VLAN_TAGGING_ENABLE</span><span class="p">)</span> <span class="o">?</span>
				       <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_options</span> <span class="o">&amp;</span>
				       <span class="n">IPV6_OPT_VLAN_TAGGING_ENABLE</span><span class="p">)</span> <span class="o">?</span>
				       <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_MTU</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">eth_mtu_size</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_PORT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_port</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span>
<span class="nf">qla4xxx_ep_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">non_blocking</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="o">*</span><span class="n">qla_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: shost is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_create_endpoint</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_endpoint</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qla_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qla_ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_endpoint</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span><span class="p">));</span>
		<span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: %pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">shost</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="o">*</span><span class="n">qla_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">qla_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_up</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_BUILD_DDB_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_ep_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_ep_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="o">*</span><span class="n">qla_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla_ep</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

		<span class="n">dst_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst_addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">iscsi_conn_get_addr_param</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="p">)</span>
						 <span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_conn_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iscsi_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_iscsi_stats</span> <span class="o">*</span><span class="n">ql_iscsi_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stats_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">iscsi_stats_dma</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_conn_to_session</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">stats_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_iscsi_stats</span><span class="p">));</span>
	<span class="cm">/* Allocate memory */</span>
	<span class="n">ql_iscsi_stats</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">iscsi_stats_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql_iscsi_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate memory for iscsi stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_get_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">qla4xxx_get_mgmt_data</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span>
				     <span class="n">iscsi_stats_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;Unable to retreive iscsi stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_stats</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* octets */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">txdata_octets</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_data_octets</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxdata_octets</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_data_octets</span><span class="p">);</span>
	<span class="cm">/* xmit pdus */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">noptx_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_nopout_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsicmd_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_scsi_cmd_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfcmd_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_tmf_cmd_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">login_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_login_cmd_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">text_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_text_cmd_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dataout_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_scsi_write_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">logout_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_logout_cmd_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">snack_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">tx_snack_req_pdus</span><span class="p">);</span>
	<span class="cm">/* recv pdus */</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">noprx_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_nopin_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">scsirsp_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_scsi_resp_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmfrsp_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_tmf_resp_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">textrsp_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_text_resp_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">datain_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_scsi_read_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">logoutrsp_pdus</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_logout_resp_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">r2t_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_r2t_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">async_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_async_pdus</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rjt_pdus</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ql_iscsi_stats</span><span class="o">-&gt;</span><span class="n">rx_reject_pdus</span><span class="p">);</span>

<span class="nl">free_stats:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span> <span class="n">ql_iscsi_stats</span><span class="p">,</span>
			  <span class="n">iscsi_stats_dma</span><span class="p">);</span>
<span class="nl">exit_get_stats:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="nf">qla4xxx_eh_cmd_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">BLK_EH_NOT_HANDLED</span><span class="p">;</span>

	<span class="n">session</span> <span class="o">=</span> <span class="n">starget_to_session</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISCSI_SESSION_FAILED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BLK_EH_RESET_TIMER</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_set_port_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_UNKNOWN</span><span class="p">;</span>

	<span class="n">qla4xxx_get_firmware_state</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addl_fw_state</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_ADDSTATE_LINK_SPEED_10MBPS</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_10MBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_ADDSTATE_LINK_SPEED_100MBPS</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_100MBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_ADDSTATE_LINK_SPEED_1GBPS</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_1GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FW_ADDSTATE_LINK_SPEED_10GBPS</span>:
		<span class="n">speed</span> <span class="o">=</span> <span class="n">ISCSI_PORT_SPEED_10GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_set_port_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_host</span> <span class="o">*</span><span class="n">ihost</span> <span class="o">=</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">state</span> <span class="o">=</span> <span class="n">ISCSI_PORT_STATE_DOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">ISCSI_PORT_STATE_UP</span><span class="p">;</span>

	<span class="n">ihost</span><span class="o">-&gt;</span><span class="n">port_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_host_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_host_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_HWADDRESS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">,</span> <span class="n">MAC_ADDR_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_IPADDRESS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ip_address</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_INITIATOR_NAME</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_STATE</span>:
		<span class="n">qla4xxx_set_port_state</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_get_port_state_name</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_HOST_PARAM_PORT_SPEED</span>:
		<span class="n">qla4xxx_set_port_speed</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iscsi_get_port_speed_name</span><span class="p">(</span><span class="n">shost</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_create_ipv4_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* IPv4 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span> <span class="o">=</span> <span class="n">iscsi_create_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span>
					    <span class="n">ISCSI_IFACE_TYPE_IPV4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span><span class="p">)</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Could not create IPv4 iSCSI &quot;</span>
			   <span class="s">&quot;iface0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_create_ipv6_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span><span class="p">)</span>
		<span class="cm">/* IPv6 iface-0 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span> <span class="o">=</span> <span class="n">iscsi_create_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span>
						      <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span><span class="p">)</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Could not create IPv6 iSCSI &quot;</span>
			   <span class="s">&quot;iface0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span><span class="p">)</span>
		<span class="cm">/* IPv6 iface-1 */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span> <span class="o">=</span> <span class="n">iscsi_create_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span>
						      <span class="n">ISCSI_IFACE_TYPE_IPV6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span><span class="p">)</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Could not create IPv6 iSCSI &quot;</span>
			   <span class="s">&quot;iface1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_create_ifaces</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_options</span> <span class="o">&amp;</span> <span class="n">IPOPT_IPV4_PROTOCOL_ENABLE</span><span class="p">)</span>
		<span class="n">qla4xxx_create_ipv4_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_options</span> <span class="o">&amp;</span> <span class="n">IPV6_OPT_IPV6_PROTOCOL_ENABLE</span><span class="p">)</span>
		<span class="n">qla4xxx_create_ipv6_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_destroy_ipv4_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_destroy_ipv6_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_destroy_iface</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iface_ipv6_1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_destroy_ifaces</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4xxx_destroy_ipv4_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4xxx_destroy_ipv6_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_set_ipv6</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * iface_num 0 is valid for IPv6 Addr, linklocal, router, autocfg.</span>
<span class="cm">	 * iface_num 1 is valid only for IPv6 Addr.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="cm">/* IPv6 Addr 1 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr1</span><span class="p">,</span> <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="cm">/* IPv6 Addr 0 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr0</span><span class="p">,</span> <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_if_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_if_id</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ROUTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">,</span> <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ADDR_AUTOCFG</span>:
		<span class="cm">/* Autocfg applies to even interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IPV6_AUTOCFG_DISABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addtl_opts</span> <span class="o">&amp;=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span>
				  <span class="o">~</span><span class="n">IPV6_ADDOPT_NEIGHBOR_DISCOVERY_ADDR_ENABLE</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IPV6_AUTOCFG_ND_ENABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addtl_opts</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span>
				  <span class="n">IPV6_ADDOPT_NEIGHBOR_DISCOVERY_ADDR_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid autocfg setting for &quot;</span>
				   <span class="s">&quot;IPv6 addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_LINKLOCAL_AUTOCFG</span>:
		<span class="cm">/* Autocfg applies to even interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
		    <span class="n">ISCSI_IPV6_LINKLOCAL_AUTOCFG_ENABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addtl_opts</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
					<span class="n">IPV6_ADDOPT_AUTOCONFIG_LINK_LOCAL_ADDR</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
			 <span class="n">ISCSI_IPV6_LINKLOCAL_AUTOCFG_DISABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addtl_opts</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				       <span class="o">~</span><span class="n">IPV6_ADDOPT_AUTOCONFIG_LINK_LOCAL_ADDR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid autocfg setting for &quot;</span>
				   <span class="s">&quot;IPv6 linklocal addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV6_ROUTER_AUTOCFG</span>:
		<span class="cm">/* Autocfg applies to even interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IPV6_ROUTER_AUTOCFG_ENABLE</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_opts</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IPV6_OPT_IPV6_PROTOCOL_ENABLE</span><span class="p">);</span>
			<span class="n">qla4xxx_create_ipv6_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_opts</span> <span class="o">&amp;=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">IPV6_OPT_IPV6_PROTOCOL_ENABLE</span> <span class="o">&amp;</span>
					    <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">qla4xxx_destroy_ipv6_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_TAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_vlan_tag</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_vlan_tag</span> <span class="o">=</span>
				<span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_VLAN_ENABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_opts</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IPV6_OPT_VLAN_TAGGING_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_opts</span> <span class="o">&amp;=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">IPV6_OPT_VLAN_TAGGING_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_MTU</span>:
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">eth_mtu_size</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_PORT</span>:
		<span class="cm">/* Autocfg applies to even interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_port</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unknown IPv6 param = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_set_ipv4</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_ADDR</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_addr</span><span class="p">,</span> <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_addr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_SUBNET</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_subnet</span><span class="p">,</span>	<span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_subnet</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_GW</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_gw_addr</span><span class="p">,</span> <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_gw_addr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IPV4_BOOTPROTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_BOOTPROTO_DHCP</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_tcp_opts</span> <span class="o">|=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TCPOPT_DHCP_ENABLE</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_BOOTPROTO_STATIC</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_tcp_opts</span> <span class="o">&amp;=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">TCPOPT_DHCP_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid IPv4 bootproto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_IFACE_ENABLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_IFACE_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_ip_opts</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IPOPT_IPV4_PROTOCOL_ENABLE</span><span class="p">);</span>
			<span class="n">qla4xxx_create_ipv4_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_ip_opts</span> <span class="o">&amp;=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">IPOPT_IPV4_PROTOCOL_ENABLE</span> <span class="o">&amp;</span>
					    <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">qla4xxx_destroy_ipv4_iface</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_TAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_vlan_tag</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_vlan_tag</span> <span class="o">=</span>
				<span class="n">cpu_to_be16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_VLAN_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISCSI_VLAN_ENABLE</span><span class="p">)</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_ip_opts</span> <span class="o">|=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IPOPT_VLAN_TAGGING_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_ip_opts</span> <span class="o">&amp;=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">IPOPT_VLAN_TAGGING_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_MTU</span>:
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">eth_mtu_size</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_NET_PARAM_PORT</span>:
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_port</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unknown IPv4 param = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4xxx_initcb_to_acb</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span> <span class="o">*</span><span class="n">acb</span><span class="p">;</span>
	<span class="n">acb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span> <span class="o">*</span><span class="p">)</span><span class="n">init_fw_cb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved1</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved2</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved3</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved4</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved5</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved6</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved7</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved8</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved9</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved10</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved11</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved12</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved13</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved14</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acb</span><span class="o">-&gt;</span><span class="n">reserved15</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4xxx_iface_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iface_param_info</span> <span class="o">*</span><span class="n">iface_param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nlattr</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>

	<span class="n">init_fw_cb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">init_fw_cb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_fw_cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Unable to alloc init_cb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb_dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: get ifcb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nla_for_each_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iface_param</span> <span class="o">=</span> <span class="n">nla_data</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">param_type</span> <span class="o">!=</span> <span class="n">ISCSI_NET_PARAM</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISCSI_IFACE_TYPE_IPV4</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">qla4xxx_set_ipv4</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* Cannot have more than one IPv4 interface */</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid IPv4 iface &quot;</span>
					   <span class="s">&quot;number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISCSI_IFACE_TYPE_IPV6</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">qla4xxx_set_ipv6</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">iface_param</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* Cannot have more than two IPv6 interface */</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid IPv6 iface &quot;</span>
					   <span class="s">&quot;number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">iface_param</span><span class="o">-&gt;</span><span class="n">iface_num</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Invalid iface type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x11BEAD5A</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_set_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">,</span> <span class="n">FLASH_SEGMENT_IFCB</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
				 <span class="n">FLASH_OPT_RMW_COMMIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: set flash mbx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_disable_acb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: disable acb mbx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">disable_acb_comp</span><span class="p">,</span>
				    <span class="n">DISABLE_ACB_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">qla4xxx_initcb_to_acb</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_set_acb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: set acb mbx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">));</span>
	<span class="n">qla4xxx_update_local_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb</span><span class="p">,</span>
				  <span class="n">init_fw_cb_dma</span><span class="p">);</span>

<span class="nl">exit_init_fw_cb:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
			  <span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_session_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CHAP_IN_IDX</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_chap_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">username_in</span><span class="p">,</span>
					      <span class="n">sess</span><span class="o">-&gt;</span><span class="n">password_in</span><span class="p">,</span> <span class="n">BIDI_CHAP</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CHAP_OUT_IDX</span>:
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_chap_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span>
					      <span class="n">sess</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span> <span class="n">LOCAL_CHAP</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_session_get_param</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_conn_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">iscsi_param</span> <span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_conn</span> <span class="o">*</span><span class="n">qla_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">qla_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_conn</span><span class="o">-&gt;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_PORT</span>:
	<span class="k">case</span> <span class="n">ISCSI_PARAM_CONN_ADDRESS</span>:
		<span class="k">return</span> <span class="n">iscsi_conn_get_addr_param</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="p">)</span>
						 <span class="n">dst_addr</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">iscsi_conn_get_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_ddb_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">ddb_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbx_sts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tmp_ddb_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">get_ddb_index:</span>
	<span class="n">tmp_ddb_index</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddb_idx_map</span><span class="p">,</span> <span class="n">MAX_DDB_ENTRIES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ddb_index</span> <span class="o">&gt;=</span> <span class="n">MAX_DDB_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Free DDB index not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_get_ddb_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">tmp_ddb_index</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddb_idx_map</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">get_ddb_index</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;Found a free DDB index at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp_ddb_index</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_req_ddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">tmp_ddb_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbx_sts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbx_sts</span> <span class="o">==</span> <span class="n">MBOX_STS_COMMAND_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;DDB index = %d not available trying next</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">tmp_ddb_index</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">get_ddb_index</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Free FW DDB not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ddb_index</span> <span class="o">=</span> <span class="n">tmp_ddb_index</span><span class="p">;</span>

<span class="nl">exit_get_ddb_index:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_match_ipaddress</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">existing_ipaddr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">user_ipaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">dst_ipaddr</span><span class="p">[</span><span class="n">IPv6_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">formatted_ipaddr</span><span class="p">[</span><span class="n">DDB_IPADDR_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_entry</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">in6_pton</span><span class="p">(</span><span class="n">user_ipaddr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_ipaddr</span><span class="p">),</span> <span class="n">dst_ipaddr</span><span class="p">,</span>
			       <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_match</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">formatted_ipaddr</span><span class="p">,</span> <span class="s">&quot;%pI6&quot;</span><span class="p">,</span> <span class="n">dst_ipaddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">in4_pton</span><span class="p">(</span><span class="n">user_ipaddr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">user_ipaddr</span><span class="p">),</span> <span class="n">dst_ipaddr</span><span class="p">,</span>
			       <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_match</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">formatted_ipaddr</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="n">dst_ipaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">existing_ipaddr</span><span class="p">,</span> <span class="n">formatted_ipaddr</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

<span class="nl">out_match:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_match_fwdb_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_ddbs</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_conn_to_session</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span> <span class="o">*</span><span class="n">existing_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="o">*</span><span class="n">existing_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">max_ddbs</span> <span class="o">=</span>  <span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAX_DEV_DB_ENTRIES_40XX</span> <span class="o">:</span>
				     <span class="n">MAX_DEV_DB_ENTRIES</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">max_ddbs</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">qla4xxx_lookup_ddb_by_fw_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">!=</span> <span class="n">FLASH_DDB</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">existing_sess</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
		<span class="n">existing_conn</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">existing_sess</span><span class="o">-&gt;</span><span class="n">targetname</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;IQN = %s User IQN = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">existing_sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">,</span>
				  <span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">));</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;IP = %s User IP = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span><span class="p">,</span>
				  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span><span class="p">));</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Port = %d User Port = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span><span class="p">,</span>
				  <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">existing_sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_match_ipaddress</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span>
					<span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span><span class="p">,</span>
					<span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">existing_conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span> <span class="o">!=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">max_ddbs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;Match found in fwdb sessions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span>
<span class="nf">qla4xxx_session_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			<span class="kt">uint16_t</span> <span class="n">cmds_max</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">qdepth</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">initial_cmdsn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="o">*</span><span class="n">qla_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ddb_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;qla4xxx: missing ep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_ddb_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_session_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span> <span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				       <span class="n">cmds_max</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ddb_entry</span><span class="p">),</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_task_data</span><span class="p">),</span>
				       <span class="n">initial_cmdsn</span><span class="p">,</span> <span class="n">ddb_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_sess</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span> <span class="o">=</span> <span class="n">ddb_index</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">=</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">unblock_sess</span> <span class="o">=</span> <span class="n">qla4xxx_unblock_ddb</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_change</span> <span class="o">=</span> <span class="n">qla4xxx_ddb_change</span><span class="p">;</span>
	<span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">recovery_tmo</span> <span class="o">=</span> <span class="n">ql4xsess_recovery_tmo</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_index_map</span><span class="p">[</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">tot_ddbs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cls_sess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_session_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">wtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ddb_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Unable to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">destroy_session</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">LOGOUT_TOV</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span>
					      <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">destroy_session</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ddb_state</span> <span class="o">==</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ddb_state</span> <span class="o">==</span> <span class="n">DDB_DS_SESSION_FAILED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">destroy_session</span><span class="p">;</span>

		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">time_after</span><span class="p">(</span><span class="n">wtime</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">)));</span>

<span class="nl">destroy_session:</span>
	<span class="n">qla4xxx_clear_ddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qla4xxx_free_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
				  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span>
<span class="nf">qla4xxx_conn_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">conn_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_setup</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_conn</span><span class="p">),</span>
				    <span class="n">conn_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_conn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cls_conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_conn_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			     <span class="kt">uint64_t</span> <span class="n">transport_fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_conn</span> <span class="o">*</span><span class="n">qla_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_conn_bind</span><span class="p">(</span><span class="n">cls_session</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="n">is_leading</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">iscsi_lookup_endpoint</span><span class="p">(</span><span class="n">transport_fd</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">qla_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">qla_conn</span><span class="o">-&gt;</span><span class="n">qla_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_conn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_conn_to_session</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbx_sts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="cm">/* Check if we have  matching FW DDB, if yes then do not</span>
<span class="cm">	 * login to this target. This could cause target to logout previous</span>
<span class="cm">	 * connection</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_match_fwdb_session</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;Session already exist in FW.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_conn_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Unable to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_conn_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_set_param_ddbentry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbx_sts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If iscsid is stopped and started then no need to do</span>
<span class="cm">		* set param again since ddb state will be already</span>
<span class="cm">		* active and FW does not allow set ddb to an</span>
<span class="cm">		* active session.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbx_sts</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">==</span>
						<span class="n">DDB_DS_SESSION_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">unblock_sess</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit_set_param</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Failed set param for index[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_conn_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_conn_open</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Login failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_conn_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">==</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span><span class="p">)</span>
		<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">=</span> <span class="n">DDB_DS_LOGIN_IN_PROCESS</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: DDB state [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		      <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span><span class="p">));</span>

<span class="nl">exit_set_param:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_conn_start:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
				  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_conn_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_conn_to_session</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">options</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">LOGOUT_OPTION_CLOSE_SESSION</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_session_logout_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Logout failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_task_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="o">*</span><span class="n">task_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">passthru_status</span> <span class="o">*</span><span class="n">sts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">itt_t</span> <span class="n">itt</span><span class="p">;</span>

	<span class="n">task_data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">wdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql4_task_data</span><span class="p">,</span> <span class="n">task_work</span><span class="p">);</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">;</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">);</span>

	<span class="n">DEBUG3</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Status returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">DEBUG3</span><span class="p">(</span><span class="n">qla4xxx_dump_buffer</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="mi">64</span><span class="p">));</span>
	<span class="n">DEBUG3</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Response buffer&quot;</span><span class="p">));</span>
	<span class="n">DEBUG3</span><span class="p">(</span><span class="n">qla4xxx_dump_buffer</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">,</span> <span class="mi">64</span><span class="p">));</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sts</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PASSTHRU_STATUS_COMPLETE</span>:
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">;</span>
		<span class="cm">/* Assign back the itt in hdr, until we use the PREASSIGN_TAG */</span>
		<span class="n">itt</span> <span class="o">=</span> <span class="n">sts</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">itt</span> <span class="o">=</span> <span class="n">itt</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">iscsi_complete_pdu</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Passthru failed status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">sts</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_alloc_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="o">*</span><span class="n">task_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">task_data</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">task_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_task_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: SCSI Commands not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">);</span>
	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">data_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">,</span>
						     <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MaxRecvLen %u, iscsi hrd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">));</span>

	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_dma</span><span class="p">,</span>
						    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_alloc_pdu</span><span class="p">;</span>

	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_len</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_dma</span><span class="p">,</span>
						   <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_alloc_pdu</span><span class="p">;</span>

	<span class="n">task</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">task_work</span><span class="p">,</span> <span class="n">qla4xxx_task_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_alloc_pdu:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">,</span>
				  <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">,</span>
				  <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_task_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="o">*</span><span class="n">task_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">;</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">task_data</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">,</span>
				 <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MaxRecvLen %u, iscsi hrd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">__func__</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">));</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">,</span>
			  <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_dma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">,</span>
			  <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_dma</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_task_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">qla4xxx_send_passthru0</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: scsi cmd xmit not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_copy_fwddb_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ip_addr</span><span class="p">[</span><span class="n">DDB_IPADDR_LEN</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_rcv_data_seg_len</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_snd_data_seg_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">initial_r2t_en</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">BIT_10</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">));</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_r2t</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_outsnd_r2t</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">imm_data_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">BIT_11</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">));</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">first_burst</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_first_burst_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
				 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_burst_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2wait</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2wait</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2retain</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2retain</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tpgt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">tgt_portal_grp</span><span class="p">);</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="s">&quot;%pI6&quot;</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>

	<span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">ISCSI_PARAM_TARGET_NAME</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">ISCSI_PARAM_INITIATOR_NAME</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">ISCSI_PARAM_PERSISTENT_ADDRESS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">ISCSI_PARAM_TARGET_ALIAS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_alias</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_update_session_conn_fwddb_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ddb_state</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Unable to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_session_conn_fwddb_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span>
				    <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_state</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: failed &quot;</span>
				  <span class="s">&quot;get_ddb_entry for fw_ddb_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_session_conn_fwddb_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">;</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>

	<span class="cm">/* Update params */</span>
	<span class="n">qla4xxx_copy_fwddb_param</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">cls_sess</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">);</span>

<span class="nl">exit_session_conn_fwddb_param:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
				  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_update_session_conn_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ddb_state</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Unable to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_session_conn_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span>
				    <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_state</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: failed &quot;</span>
				  <span class="s">&quot;get_ddb_entry for fw_ddb_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_session_conn_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="cm">/* Update timers after login */</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_relogin_timeout</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">def_timeout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOGIN_TOV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">def_timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LOGIN_TOV</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">def_timeout</span><span class="p">)</span> <span class="o">:</span> <span class="n">LOGIN_TOV</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_time2wait</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2wait</span><span class="p">);</span>

	<span class="cm">/* Update params */</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span><span class="p">);</span>
	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_rcv_data_seg_len</span><span class="p">);</span>

	<span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_xmit_dlength</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_snd_data_seg_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">initial_r2t_en</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">BIT_10</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">));</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_r2t</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_outsnd_r2t</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">imm_data_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">BIT_11</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">));</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">first_burst</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_first_burst_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">=</span> <span class="n">BYTE_UNITS</span> <span class="o">*</span>
				 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_burst_len</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2wait</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2wait</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2retain</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2retain</span><span class="p">);</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tpgt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">tgt_portal_grp</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">)));</span>

	<span class="n">iscsi_set_param</span><span class="p">(</span><span class="n">cls_conn</span><span class="p">,</span> <span class="n">ISCSI_PARAM_TARGET_ALIAS</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_alias</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">exit_session_conn_param:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
				  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Timer routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_start_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: %s: Starting timer thread for adapter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">));</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">func</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_stop_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***</span>
<span class="cm"> * qla4xxx_mark_device_missing - blocks the session</span>
<span class="cm"> * @cls_session: Pointer to the session to be blocked</span>
<span class="cm"> * @ddb_entry: Pointer to device database entry</span>
<span class="cm"> *</span>
<span class="cm"> * This routine marks a device missing and close connection.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_mark_device_missing</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_block_session</span><span class="p">(</span><span class="n">cls_session</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_mark_all_devices_missing - mark all devices as missing.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine marks a device missing and resets the relogin retry count.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_mark_all_devices_missing</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_mark_device_missing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">srb</span><span class="o">*</span> <span class="nf">qla4xxx_get_new_srb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">mempool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">ddb</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">srb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_srb_free_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SRB_DMA_VALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_srb_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span><span class="p">,</span> <span class="n">srb_ref</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">qla4xxx_srb_free_dma</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">mempool_free</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_queuecommand - scsi layer issues scsi command to driver.</span>
<span class="cm"> * @host: scsi host</span>
<span class="cm"> * @cmd: Pointer to Linux&#39;s SCSI command structure</span>
<span class="cm"> *</span>
<span class="cm"> * Remarks:</span>
<span class="cm"> * This routine is invoked by Linux to send a SCSI command to the driver.</span>
<span class="cm"> * The mid-level driver tries to ensure that queuecommand never gets</span>
<span class="cm"> * invoked concurrently with itself or the interrupt handler (although</span>
<span class="cm"> * the interrupt handler may call this routine as part of request-</span>
<span class="cm"> * completion handling).   Unfortunely, it sometimes calls the scheduler</span>
<span class="cm"> * in interrupt context which is a big NO! NO!.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_queuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_PCI_CHANNEL_IO_PERM_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_REQUEUE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qc_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_IMM_RETRY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qc_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">iscsi_session_chkready</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">qc_fail_command</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_NEED_QUIESCENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">qc_host_busy</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">qla4xxx_get_new_srb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">qc_host_busy</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_send_command_to_isp</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">qc_host_busy_free_sp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">qc_host_busy_free_sp:</span>
	<span class="n">qla4xxx_srb_free_dma</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">mempool_free</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>

<span class="nl">qc_host_busy:</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

<span class="nl">qc_fail_command:</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_mem_free - frees memory allocated to adapter</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Frees memory previously allocated by qla4xxx_mem_alloc</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_len</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">,</span>
				  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span><span class="p">);</span>

	 <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Free srb pool. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">)</span>
		<span class="n">mempool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">)</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">)</span>
		<span class="n">dma_pool_destroy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">);</span>

	<span class="cm">/* release io space registers  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg_82xx</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_mem_alloc - allocates memory for use by adapter.</span>
<span class="cm"> * @ha: Pointer to host adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates DMA memory for request and response queues. Also allocates memory</span>
<span class="cm"> * for srbs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_mem_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">;</span>

	<span class="cm">/* Allocate contiguous block of DMA memory for queues. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">*</span> <span class="n">QUEUE_SIZE</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">RESPONSE_QUEUE_DEPTH</span> <span class="o">*</span> <span class="n">QUEUE_SIZE</span><span class="p">)</span> <span class="o">+</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shadow_regs</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">MEM_ALIGN_VALUE</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_len</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;Memory Allocation failed - queues.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">mem_alloc_error_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As per RISC alignment requirements -- the bus-address must be a</span>
<span class="cm">	 * multiple of the request-ring size (in bytes).</span>
<span class="cm">	 */</span>
	<span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MEM_ALIGN_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">align</span> <span class="o">=</span> <span class="n">MEM_ALIGN_VALUE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">&amp;</span>
					   <span class="p">(</span><span class="n">MEM_ALIGN_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Update request and response queue pointers. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">+</span> <span class="n">align</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">+</span> <span class="n">align</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">*</span> <span class="n">QUEUE_SIZE</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">+</span> <span class="n">align</span> <span class="o">+</span>
						    <span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">*</span>
						     <span class="n">QUEUE_SIZE</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs_dma</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues_dma</span> <span class="o">+</span> <span class="n">align</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">*</span> <span class="n">QUEUE_SIZE</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">RESPONSE_QUEUE_DEPTH</span> <span class="o">*</span> <span class="n">QUEUE_SIZE</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shadow_regs</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">+</span> <span class="n">align</span> <span class="o">+</span>
						  <span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">*</span>
						   <span class="n">QUEUE_SIZE</span><span class="p">)</span> <span class="o">+</span>
						  <span class="p">(</span><span class="n">RESPONSE_QUEUE_DEPTH</span> <span class="o">*</span>
						   <span class="n">QUEUE_SIZE</span><span class="p">));</span>

	<span class="cm">/* Allocate memory for srb pool. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">=</span> <span class="n">mempool_create</span><span class="p">(</span><span class="n">SRB_MIN_REQ</span><span class="p">,</span> <span class="n">mempool_alloc_slab</span><span class="p">,</span>
					 <span class="n">mempool_free_slab</span><span class="p">,</span> <span class="n">srb_cachep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">srb_mempool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;Memory Allocation failed - SRB Pool.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">mem_alloc_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;ql4_chap&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">CHAP_DMA_BLOCK_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s: chap_dma_pool allocation failed..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span> <span class="o">=</span> <span class="n">dma_pool_create</span><span class="p">(</span><span class="s">&quot;ql4_fw_ddb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">DDB_DMA_BLOCK_SIZE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: fw_ddb_dma_pool allocation failed..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mem_alloc_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">mem_alloc_error_exit:</span>
	<span class="n">qla4xxx_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_check_temp - Check the ISP82XX temperature.</span>
<span class="cm"> * @ha: adapter block pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The caller should not hold the idc lock.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_check_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">CRB_TEMP_STATE</span><span class="p">);</span>

	<span class="n">temp_state</span> <span class="o">=</span> <span class="n">qla82xx_get_temp_state</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp_val</span> <span class="o">=</span> <span class="n">qla82xx_get_temp_val</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_PANIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device temperature %d degrees C&quot;</span>
			   <span class="s">&quot; exceeds maximum allowed. Hardware has been shut&quot;</span>
			   <span class="s">&quot; down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_NORMAL</span><span class="p">)</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device temperature %d&quot;</span>
				   <span class="s">&quot; degrees C exceeds operating range.&quot;</span>
				   <span class="s">&quot; Immediate action needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">==</span> <span class="n">QLA82XX_TEMP_WARN</span><span class="p">)</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Device temperature is&quot;</span>
				   <span class="s">&quot; now %d degrees C in normal range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">temp_val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temp_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_check_fw_alive  - Check firmware health</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Context: Interrupt</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4_8xxx_check_fw_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">fw_heartbeat_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">fw_heartbeat_counter</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_PEG_ALIVE_COUNTER</span><span class="p">);</span>
	<span class="cm">/* If PEG_ALIVE_COUNTER is 0xffffffff, AER/EEH is in progress, ignore */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_heartbeat_counter</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%ld: %s: Device in frozen &quot;</span>
		    <span class="s">&quot;state, QLA82XX_PEG_ALIVE_COUNTER is 0xffffffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_heartbeat_counter</span> <span class="o">==</span> <span class="n">fw_heartbeat_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* FW not alive after 2 seconds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;scsi(%ld): %s, Dumping hw/fw registers:</span><span class="se">\n</span><span class="s"> &quot;</span>
				   <span class="s">&quot; PEG_HALT_STATUS1: 0x%x, PEG_HALT_STATUS2:&quot;</span>
				   <span class="s">&quot; 0x%x,</span><span class="se">\n</span><span class="s"> PEG_NET_0_PC: 0x%x, PEG_NET_1_PC:&quot;</span>
				   <span class="s">&quot; 0x%x,</span><span class="se">\n</span><span class="s"> PEG_NET_2_PC: 0x%x, PEG_NET_3_PC:&quot;</span>
				   <span class="s">&quot; 0x%x,</span><span class="se">\n</span><span class="s"> PEG_NET_4_PC: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						   <span class="n">QLA82XX_PEG_HALT_STATUS1</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						   <span class="n">QLA82XX_PEG_HALT_STATUS2</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_0</span> <span class="o">+</span>
						   <span class="mh">0x3c</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_1</span> <span class="o">+</span>
						   <span class="mh">0x3c</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_2</span> <span class="o">+</span>
						   <span class="mh">0x3c</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_3</span> <span class="o">+</span>
						   <span class="mh">0x3c</span><span class="p">),</span>
				   <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_PEG_NET_4</span> <span class="o">+</span>
						   <span class="mh">0x3c</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_heartbeat_counter</span> <span class="o">=</span> <span class="n">fw_heartbeat_counter</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_watchdog - Poll dev state</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Context: Interrupt</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4_8xxx_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">halt_status</span><span class="p">;</span>

	<span class="cm">/* don&#39;t poll if reset is going on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_check_temp</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;disabling pause&quot;</span>
				   <span class="s">&quot; transmit on port 0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
					<span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span> <span class="o">|</span>
					<span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_NEED_RESET</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: HW State: &quot;</span>
				    <span class="s">&quot;NEED RESET!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_NEED_QUIESCENT</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_NEED_QUIESCENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: HW State: NEED QUIES!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_HA_NEED_QUIESCENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="cm">/* Check firmware health */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_check_fw_alive</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;disabling pause&quot;</span>
					   <span class="s">&quot; transmit on port 0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
						<span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span> <span class="o">|</span>
						<span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
				<span class="n">halt_status</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						<span class="n">QLA82XX_PEG_HALT_STATUS1</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">QLA82XX_FWERROR_CODE</span><span class="p">(</span><span class="n">halt_status</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">)</span>
					<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s:&quot;</span>
						   <span class="s">&quot; Firmware aborted with&quot;</span>
						   <span class="s">&quot; error code 0x00006700.&quot;</span>
						   <span class="s">&quot; Device is being reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">__func__</span><span class="p">);</span>

				<span class="cm">/* Since we cannot change dev_state in interrupt</span>
<span class="cm">				 * context, set appropriate DPC flag then wakeup</span>
<span class="cm">				 * DPC */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">halt_status</span> <span class="o">&amp;</span> <span class="n">HALT_STATUS_UNRECOVERABLE</span><span class="p">)</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: detect &quot;</span>
						   <span class="s">&quot;abort needed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">qla4xxx_mailbox_premature_completion</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_check_relogin_flash_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">==</span> <span class="n">FLASH_DDB</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_up</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DF_RELOGIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">INVALID_ENTRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">)</span> <span class="o">==</span>
					<span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">,</span>
					   <span class="n">INVALID_ENTRY</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RELOGIN_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DF_RELOGIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				       <span class="s">&quot;%s: index [%d] login device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for relogin to timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_timer</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_timer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the relogin times out and the device is</span>
<span class="cm">		 * still NOT ONLINE then try and relogin again.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Reset retry relogin timer */</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_retry_count</span><span class="p">);</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				<span class="s">&quot;%s: index[%d] relogin timed out-retrying&quot;</span>
				<span class="s">&quot; relogin (%d), retry (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span>
				<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_retry_count</span><span class="p">),</span>
				<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_time2wait</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RELOGIN_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">,</span>
				   <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_time2wait</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_timer - checks every second for work to do.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">start_dpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_check_relogin_flash_ddb</span><span class="p">);</span>

	<span class="cm">/* If we are in the middle of AER/EEH processing</span>
<span class="cm">	 * skip any processing and reschedule the timer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware read to trigger an EEH error during mailbox waits. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_watchdog</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for heartbeat interval. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_options</span> <span class="o">&amp;</span> <span class="n">FWOPT_HEARTBEAT_ENABLE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">heartbeat_interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">&gt;</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">heartbeat_interval</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Process any deferred work. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">))</span>
		<span class="n">start_dpc</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Wakeup the dpc routine for this adapter, if needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_dpc</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RELOGIN_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_GET_DHCP_IP_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_LINK_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_NEED_QUIESCENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_AEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: scheduling dpc routine&quot;</span>
			      <span class="s">&quot; - dpc flags = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">));</span>
		<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reschedule timer thread to call us back in one second */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_intr</span><span class="o">++</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_cmd_wait - waits for all outstanding commands to complete</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine stalls the driver until all outstanding commands are returned.</span>
<span class="cm"> * Caller must release the Hardware Lock prior to calling this routine.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_cmd_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">WAIT_CMD_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Wait up to %d seconds for cmds to &quot;</span>
	    <span class="s">&quot;complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WAIT_CMD_TOV</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wtime</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Find a command that hasn&#39;t completed. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">scsi_host_find_tag</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We cannot just check if the index is valid,</span>
<span class="cm">			 * becase if we are run from the scsi eh, then</span>
<span class="cm">			 * the scsi/block layer is going to prevent</span>
<span class="cm">			 * the tag from being released.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* If No Commands are pending, wait is complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* If we timed out on waiting for commands to come back</span>
<span class="cm">	 * return ERROR. */</span>
	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ctrl_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;scsi%ld: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xxx_lock_drvr_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the SCSI Reset Interrupt bit is set, clear it.</span>
<span class="cm">	 * Otherwise, the Soft Reset won&#39;t work.</span>
<span class="cm">	 */</span>
	<span class="n">ctrl_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_SCSI_RESET_INTR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SCSI_RESET_INTR</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

	<span class="cm">/* Issue Soft Reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SOFT_RESET</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_soft_reset - performs soft reset.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">max_wait_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ctrl_status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_hw_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="cm">/* Wait until the Network Reset Intr bit is cleared */</span>
	<span class="n">max_wait_time</span> <span class="o">=</span> <span class="n">RESET_INTR_TOV</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ctrl_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_NET_RESET_INTR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_NET_RESET_INTR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			      <span class="s">&quot;scsi%ld: Network Reset Intr not cleared by &quot;</span>
			      <span class="s">&quot;Network function, clearing it now!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_NET_RESET_INTR</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait until the firmware tells us the Soft Reset is done */</span>
	<span class="n">max_wait_time</span> <span class="o">=</span> <span class="n">SOFT_RESET_TOV</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ctrl_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_SOFT_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Also, make sure that the SCSI Reset Interrupt bit has been cleared</span>
<span class="cm">	 * after the soft reset has taken place.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ctrl_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_SCSI_RESET_INTR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SCSI_RESET_INTR</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* If soft reset fails then most probably the bios on other</span>
<span class="cm">	 * function is also enabled.</span>
<span class="cm">	 * Since the initialization is sequential the other fn</span>
<span class="cm">	 * wont be able to acknowledge the soft reset.</span>
<span class="cm">	 * Issue a force soft reset to workaround this scenario.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue Force Soft Reset */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_FORCE_SOFT_RESET</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Wait until the firmware tells us the Soft Reset is done */</span>
		<span class="n">max_wait_time</span> <span class="o">=</span> <span class="n">SOFT_RESET_TOV</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ctrl_status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ctrl_status</span> <span class="o">&amp;</span> <span class="n">CSR_FORCE_SOFT_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_abort_active_cmds - returns all outstanding i/o requests to O.S.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @res: returned scsi status</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called just prior to a HARD RESET to return all</span>
<span class="cm"> * outstanding commands back to the Operating System.</span>
<span class="cm"> * Caller should make sure that the following locks are released</span>
<span class="cm"> * before this calling routine: Hardware lock, and io_request_lock.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srb</span> <span class="o">=</span> <span class="n">qla4xxx_del_from_active_array</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">,</span> <span class="n">qla4xxx_srb_compl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_dead_adapter_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Disable the board */</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Disabling the board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">qla4xxx_mark_all_devices_missing</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_fail_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">=</span> <span class="n">DDB_DS_SESSION_FAILED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">==</span> <span class="n">FLASH_DDB</span><span class="p">)</span>
		<span class="n">iscsi_block_session</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iscsi_session_failure</span><span class="p">(</span><span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
				      <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_recover_adapter - recovers adapter after a fatal error</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_recover_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reset_chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait</span><span class="p">;</span>

	<span class="cm">/* Stall incoming I/O until we are done */</span>
	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: adapter OFFLINE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_fail_session</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">reset_chip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* For the DPC_RESET_HA_INTR case (ISP-4xxx specific)</span>
<span class="cm">	 * do not reset adapter, jump to initialize_adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">recover_ha_init_adapter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For the ISP-82xx adapter, issue a stop_firmware if invoked</span>
<span class="cm">	 * from eh_host_reset or ioctl module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reset_chip</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;scsi%ld: %s - Performing stop_firmware...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">qla4xxx_cmd_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span><span class="p">);</span>
			<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If the stop_firmware fails then</span>
<span class="cm">			 * reset the entire chip */</span>
			<span class="n">reset_chip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Issue full chip reset if recovering from a catastrophic error,</span>
<span class="cm">	 * or if stop_firmware fails for ISP-82xx.</span>
<span class="cm">	 * This is the default case for ISP-4xxx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">reset_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">chip_reset</span><span class="p">;</span>

		<span class="cm">/* Check if 82XX firmware is alive or not</span>
<span class="cm">		 * We may have arrived here from NEED_RESET</span>
<span class="cm">		 * detection only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">chip_reset</span><span class="p">;</span>

		<span class="n">wait</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">FW_ALIVE_WAIT_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_check_fw_alive</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qla4xxx_mailbox_premature_completion</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">qla4xxx_cmd_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="nl">chip_reset:</span>
		<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span><span class="p">);</span>
		<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;scsi%ld: %s - Performing chip reset..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_chip</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Flush any pending ddb changed AENs */</span>
	<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span><span class="p">);</span>

<span class="nl">recover_ha_init_adapter:</span>
	<span class="cm">/* Upon successful firmware/chip reset, re-initialize the adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For ISP-4xxx, force function 1 to always initialize</span>
<span class="cm">		 * before function 3 to prevent both funcions from</span>
<span class="cm">		 * stepping on top of the other */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

		<span class="cm">/* NOTE: AF_ONLINE flag set upon successful completion of</span>
<span class="cm">		 *       qla4xxx_initialize_adapter */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">RESET_ADAPTER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Retry failed adapter initialization, if necessary</span>
<span class="cm">	 * Do not retry initialize_adapter for RESET_HA_INTR (ISP-4xxx specific)</span>
<span class="cm">	 * case to prevent ping-pong resets between functions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Adapter initialization failed, see if we can retry</span>
<span class="cm">		 * resetting the ha.</span>
<span class="cm">		 * Since we don&#39;t want to block the DPC for too long</span>
<span class="cm">		 * with multiple resets in the same thread,</span>
<span class="cm">		 * utilize DPC to retry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: don&#39;t retry &quot;</span>
					   <span class="s">&quot;recover adapter. H/W is in Failed &quot;</span>
					   <span class="s">&quot;state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">qla4xxx_dead_adapter_cleanup</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">exit_recover</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span> <span class="o">=</span> <span class="n">MAX_RESET_HA_RETRIES</span><span class="p">;</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: recover adapter - retrying &quot;</span>
				      <span class="s">&quot;(%d) more times</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span><span class="p">));</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Schedule another Reset HA--DPC will retry */</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span><span class="o">--</span><span class="p">;</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: recover adapter - &quot;</span>
					      <span class="s">&quot;retry remaining %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span><span class="p">));</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">retry_reset_ha_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Recover adapter retries have been exhausted.</span>
<span class="cm">				 * Adapter DEAD */</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: recover adapter &quot;</span>
					      <span class="s">&quot;failed - board disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">));</span>
				<span class="n">qla4xxx_dead_adapter_cleanup</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit_recover:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">adapter_error_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: recover adapter: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
	    <span class="n">status</span> <span class="o">==</span> <span class="n">QLA_ERROR</span> <span class="o">?</span> <span class="s">&quot;FAILED&quot;</span> <span class="o">:</span> <span class="s">&quot;SUCCEEDED&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_relogin_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">cls_session</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">==</span> <span class="n">DDB_DS_SESSION_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: ddb[%d]&quot;</span>
				   <span class="s">&quot; unblock session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				   <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
			<span class="n">iscsi_unblock_session</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Trigger relogin */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">==</span> <span class="n">FLASH_DDB</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DF_RELOGIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
					<span class="n">qla4xxx_arm_relogin_timer</span><span class="p">(</span><span class="n">ddb_entry</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">iscsi_session_failure</span><span class="p">(</span><span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">,</span>
						      <span class="n">ISCSI_ERR_CONN_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_unblock_flash_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: ddb[%d]&quot;</span>
		   <span class="s">&quot; unblock session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>

	<span class="n">iscsi_unblock_session</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>

	<span class="cm">/* Start scan target */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: ddb[%d]&quot;</span>
			   <span class="s">&quot; start scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
		<span class="n">scsi_queue_work</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_unblock_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_session</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: ddb[%d]&quot;</span>
		   <span class="s">&quot; unblock user space session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
	<span class="n">iscsi_conn_start</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
	<span class="n">iscsi_conn_login_event</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span>
			       <span class="n">ISCSI_CONN_STATE_LOGGED_IN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_relogin_all_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_relogin_devices</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_relogin_flash_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">relogin_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">relogin_timer</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_relogin_timeout</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">RELOGIN_TOV</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_timer</span><span class="p">,</span> <span class="n">relogin_timer</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;scsi%ld: Relogin index [%d]. TOV=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			  <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span> <span class="n">relogin_timer</span><span class="p">));</span>

	<span class="n">qla4xxx_login_flash_ddb</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_dpc_relogin</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">==</span> <span class="n">FLASH_DDB</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DF_RELOGIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;relogin issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">qla4xxx_relogin_flash_ddb</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_wake_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span>
<span class="nf">qla4xxx_alloc_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">qla4_work_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla4_work_evt</span><span class="p">)</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_post_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qla4xxx_wake_dpc</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_post_aen_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">iscsi_host_event_code</span> <span class="n">aen_code</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">qla4xxx_alloc_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">QLA4_EVENT_AEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">aen_code</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="n">qla4xxx_post_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_post_ping_evt_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">qla4xxx_alloc_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">QLA4_EVENT_PING_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="n">qla4xxx_post_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_do_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLA4_EVENT_AEN</span>:
			<span class="n">iscsi_post_host_event</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aen</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLA4_EVENT_PING_STATUS</span>:
			<span class="n">iscsi_ping_comp_event</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">data_size</span><span class="p">,</span>
					      <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;event type: 0x%x not &quot;</span>
				   <span class="s">&quot;supported&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_do_dpc - dpc routine</span>
<span class="cm"> * @data: in our case pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is a task that is schedule by the interrupt handler</span>
<span class="cm"> * to perform the background processing for interrupts.  We put it</span>
<span class="cm"> * on a task queue that is consumed whenever the scheduler runs; that&#39;s</span>
<span class="cm"> * so you can do anything (i.e. put the process to sleep etc).  In fact,</span>
<span class="cm"> * the mid-level tries to sleep when it reaches the driver threshold</span>
<span class="cm"> * &quot;host-&gt;can_queue&quot;. This can cause a panic if we were in our interrupt code.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_do_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_qla_host</span><span class="p">,</span> <span class="n">dpc_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: DPC handler waking up.&quot;</span>
	    <span class="s">&quot;flags = 0x%08lx, dpc_flags = 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>

	<span class="cm">/* Initialization not yet finished. Don&#39;t do anything yet. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld: %s: flags = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* post events to application */</span>
	<span class="n">qla4xxx_do_work</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HW State: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla4_8xxx_device_state_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DPC_HA_NEED_QUIESCENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_need_qsnt_handler</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Don&#39;t Reset HBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">dpc_post_reset_ha</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
			<span class="n">qla4xxx_recover_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">wait_time</span> <span class="o">=</span> <span class="n">RESET_INTR_TOV</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">CSR_SOFT_RESET</span> <span class="o">|</span> <span class="n">CSR_FORCE_SOFT_RESET</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: SR|FSR &quot;</span>
					      <span class="s">&quot;bit not cleared-- resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql4xxx_lock_drvr_wait</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_recover_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">dpc_post_reset_ha:</span>
	<span class="cm">/* ---- process AEN? --- */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DPC_AEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">PROCESS_ALL_AENS</span><span class="p">);</span>

	<span class="cm">/* ---- Get DHCP IP Address? --- */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DPC_GET_DHCP_IP_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="n">qla4xxx_get_dhcp_ip_address</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* ---- relogin device? --- */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter_up</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DPC_RELOGIN_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_dpc_relogin</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ---- link change? --- */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DPC_LINK_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* ---- link down? --- */</span>
			<span class="n">qla4xxx_mark_all_devices_missing</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ---- link up? --- *</span>
<span class="cm">			 * F/W will auto login to all devices ONLY ONCE after</span>
<span class="cm">			 * link up during driver initialization and runtime</span>
<span class="cm">			 * fatal error recovery.  Therefore, the driver must</span>
<span class="cm">			 * manually relogin to devices when recovering from</span>
<span class="cm">			 * connection failures, logouts, expired KATO, etc. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_BUILD_DDB_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">qla4xxx_build_ddb_list</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">is_reset</span><span class="p">);</span>
				<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
						<span class="n">qla4xxx_login_flash_ddb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">qla4xxx_relogin_all_devices</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_free_adapter - release the adapter</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_free_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INTERRUPTS_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Turn-off interrupts on the card. */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Remove timer thread, if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span>
		<span class="n">qla4xxx_stop_timer</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Kill the kernel thread for this host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">);</span>

	<span class="cm">/* Kill the kernel thread for this host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">task_wq</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">task_wq</span><span class="p">);</span>

	<span class="cm">/* Put firmware in known state */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_firmware</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Detach interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_IRQ_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">qla4xxx_free_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* free extra memory */</span>
	<span class="n">qla4xxx_mem_free</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4_8xxx_iospace_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_base</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">db_base</span><span class="p">,</span> <span class="n">db_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		    <span class="s">&quot;scsi(%ld) Failed to reserve PIO regions (%s) &quot;</span>
		    <span class="s">&quot;status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: revision-id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>

	<span class="cm">/* remap phys address */</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* 0 is for BAR 0 */</span>
	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ioremap from %lx a size of %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">mem_base</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">));</span>

	<span class="cm">/* mapping of pcibase pointer */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		    <span class="s">&quot;cannot remap MMIO (%s), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mapping of IO base pointer, door bell read and write pointer */</span>

	<span class="cm">/* mapping of IO base pointer */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">device_reg_82xx</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_pcibase</span> <span class="o">+</span>
	    <span class="mh">0xbc000</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>

	<span class="n">db_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>  <span class="cm">/* doorbell is on bar 4 */</span>
	<span class="n">db_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_db_wr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">QLA82XX_CAM_RAM_DB1</span> <span class="o">:</span>
	    <span class="n">QLA82XX_CAM_RAM_DB2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">iospace_error_exit:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***</span>
<span class="cm"> * qla4xxx_iospace_config - maps registers</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routines maps HBA&#39;s registers from the pci address space</span>
<span class="cm"> * into the kernel virtual address space for memory mapped i/o.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_iospace_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pio</span><span class="p">,</span> <span class="n">pio_len</span><span class="p">,</span> <span class="n">pio_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">,</span> <span class="n">mmio_flags</span><span class="p">;</span>

	<span class="n">pio</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pio_flags</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio_flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pio_len</span> <span class="o">&lt;</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				<span class="s">&quot;Invalid PCI I/O region size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;region #0 not a PIO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use MMIO operations for all accesses. */</span>
	<span class="n">mmio</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mmio_flags</span> <span class="o">=</span> <span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmio_flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;region #0 not an MMIO resource, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmio_len</span> <span class="o">&lt;</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;Invalid PCI mem region size, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;Failed to reserve PIO/MMIO regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_address</span> <span class="o">=</span> <span class="n">pio</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pio_length</span> <span class="o">=</span> <span class="n">pio_len</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">MIN_IOBASE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;cannot remap MMIO, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">iospace_error_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">iospace_error_exit:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla4xxx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iospace_config</span>         <span class="o">=</span> <span class="n">qla4xxx_iospace_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_config</span>             <span class="o">=</span> <span class="n">qla4xxx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>          <span class="o">=</span> <span class="n">qla4xxx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>           <span class="o">=</span> <span class="n">qla4xxx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_firmware</span>         <span class="o">=</span> <span class="n">qla4xxx_start_firmware</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>           <span class="o">=</span> <span class="n">qla4xxx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_service_routine</span> <span class="o">=</span> <span class="n">qla4xxx_interrupt_service_routine</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>             <span class="o">=</span> <span class="n">qla4xxx_soft_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_firmware</span>         <span class="o">=</span> <span class="n">qla4xxx_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_iocb</span>             <span class="o">=</span> <span class="n">qla4xxx_queue_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete_iocb</span>          <span class="o">=</span> <span class="n">qla4xxx_complete_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rd_shdw_req_q_out</span>      <span class="o">=</span> <span class="n">qla4xxx_rd_shdw_req_q_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rd_shdw_rsp_q_in</span>       <span class="o">=</span> <span class="n">qla4xxx_rd_shdw_rsp_q_in</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sys_info</span>           <span class="o">=</span> <span class="n">qla4xxx_get_sys_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_operations</span> <span class="n">qla4_8xxx_isp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iospace_config</span>         <span class="o">=</span> <span class="n">qla4_8xxx_iospace_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pci_config</span>             <span class="o">=</span> <span class="n">qla4_8xxx_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_intrs</span>          <span class="o">=</span> <span class="n">qla4_8xxx_disable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_intrs</span>           <span class="o">=</span> <span class="n">qla4_8xxx_enable_intrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_firmware</span>         <span class="o">=</span> <span class="n">qla4_8xxx_load_risc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intr_handler</span>           <span class="o">=</span> <span class="n">qla4_8xxx_intr_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt_service_routine</span> <span class="o">=</span> <span class="n">qla4_8xxx_interrupt_service_routine</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_chip</span>             <span class="o">=</span> <span class="n">qla4_8xxx_isp_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_firmware</span>         <span class="o">=</span> <span class="n">qla4_8xxx_stop_firmware</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queue_iocb</span>             <span class="o">=</span> <span class="n">qla4_8xxx_queue_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete_iocb</span>          <span class="o">=</span> <span class="n">qla4_8xxx_complete_iocb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rd_shdw_req_q_out</span>      <span class="o">=</span> <span class="n">qla4_8xxx_rd_shdw_req_q_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rd_shdw_rsp_q_in</span>       <span class="o">=</span> <span class="n">qla4_8xxx_rd_shdw_rsp_q_in</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sys_info</span>           <span class="o">=</span> <span class="n">qla4_8xxx_get_sys_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">uint16_t</span> <span class="nf">qla4xxx_rd_shdw_req_q_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint16_t</span> <span class="nf">qla4_8xxx_rd_shdw_req_q_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">req_q_out</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">uint16_t</span> <span class="nf">qla4xxx_rd_shdw_rsp_q_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint16_t</span> <span class="nf">qla4_8xxx_rd_shdw_rsp_q_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">rsp_q_in</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qla4xxx_show_boot_eth_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SYSFS_FLAG_FW_SEL_BOOT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_INDEX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_MAC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_format_mac</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">my_mac</span><span class="p">,</span>
				      <span class="n">MAC_ADDR_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">qla4xxx_eth_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_FLAGS</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_MAC</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_ETH_INDEX</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qla4xxx_show_boot_ini_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_INI_INITIATOR_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">qla4xxx_ini_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_INI_INITIATOR_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qla4xxx_show_boot_tgt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="o">*</span><span class="n">boot_sess</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_conn_info</span> <span class="o">*</span><span class="n">boot_conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">conn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_IP_ADDR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">conn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_type</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_address</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%pI6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_address</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_PORT</span>:
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_chap_name_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_chap_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_SECRET</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_secret_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_secret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_NAME</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_chap_name_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_chap_name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_SECRET</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span>  <span class="s">&quot;%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_secret_length</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_secret</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SYSFS_FLAG_FW_SEL_BOOT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NIC_ASSOC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qla4xxx_show_boot_tgt_pri_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="o">*</span><span class="n">boot_sess</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_tgt</span><span class="p">.</span><span class="n">boot_pri_sess</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">qla4xxx_show_boot_tgt_info</span><span class="p">(</span><span class="n">boot_sess</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">qla4xxx_show_boot_tgt_sec_info</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="o">*</span><span class="n">boot_sess</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_tgt</span><span class="p">.</span><span class="n">boot_sec_sess</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">qla4xxx_show_boot_tgt_info</span><span class="p">(</span><span class="n">boot_sess</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">qla4xxx_tgt_get_attr_visibility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_IP_ADDR</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_PORT</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_CHAP_SECRET</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_NAME</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_REV_CHAP_SECRET</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_NIC_ASSOC</span>:
	<span class="k">case</span> <span class="n">ISCSI_BOOT_TGT_FLAGS</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_boot_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_fw_boot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">ddb_index</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pri_addr</span><span class="p">,</span> <span class="n">sec_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">func_num</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">func_num</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Get FW boot info for 0x%x func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">func_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT0_BOOT_MODE</span><span class="p">;</span>
			<span class="n">pri_addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT0_BOOT_PRI_TGT</span><span class="p">;</span>
			<span class="n">sec_addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT0_BOOT_SEC_TGT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_num</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT1_BOOT_MODE</span><span class="p">;</span>
			<span class="n">pri_addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT1_BOOT_PRI_TGT</span><span class="p">;</span>
			<span class="n">sec_addr</span> <span class="o">=</span> <span class="n">NVRAM_PORT1_BOOT_SEC_TGT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check Boot Mode */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rd_nvram_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Adapter boot &quot;</span>
					  <span class="s">&quot;options : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get primary valid target index */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rd_nvram_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">pri_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

		<span class="cm">/* get secondary valid target index */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rd_nvram_byte</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sec_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					  <span class="s">&quot;%s: Unable to allocate dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">BOOT_PARAM_OFFSET_PORT0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">BOOT_PARAM_OFFSET_PORT1</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">FLASH_RAW_ACCESS_ADDR</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_iscsi_param</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
				      <span class="mi">13</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Get Flash&quot;</span>
					  <span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check Boot Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Firmware boot options&quot;</span>
					  <span class="s">&quot; : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_info_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get primary valid target index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="cm">/* get secondary valid target index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
			<span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_boot_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Primary target ID %d, Secondary&quot;</span>
			  <span class="s">&quot; target ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

<span class="nl">exit_boot_info_free:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
<span class="nl">exit_boot_info:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pri_ddb_idx</span> <span class="o">=</span> <span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">sec_ddb_idx</span> <span class="o">=</span> <span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_bidi_chap - Get a BIDI CHAP user and password</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> * @username: CHAP username to be returned</span>
<span class="cm"> * @password: CHAP password to be returned</span>
<span class="cm"> *</span>
<span class="cm"> * If a boot entry has BIDI CHAP enabled then we need to set the BIDI CHAP</span>
<span class="cm"> * user and password in the sysfs entry in /sys/firmware/iscsi_boot#/.</span>
<span class="cm"> * So from the CHAP cache find the first BIDI CHAP entry and set it</span>
<span class="cm"> * to the boot record in sysfs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_bidi_chap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_chap_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="n">MAX_CHAP_ENTRIES_40XX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Do not have CHAP table cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chap_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chap_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CHAP_VALID_COOKIE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span> <span class="cm">/* local */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">))</span> <span class="cm">/* Not BIDI */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">strncpy</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span> <span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_boot_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="o">*</span><span class="n">boot_sess</span><span class="p">,</span>
				   <span class="kt">uint16_t</span> <span class="n">ddb_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_conn_info</span> <span class="o">*</span><span class="n">boot_conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">conn_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: Unable to allocate dma buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_bootdb_by_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span>
				   <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">ddb_index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: No Flash DDB found at &quot;</span>
				  <span class="s">&quot;index [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ddb_index</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_boot_target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update target name and IP from DDB */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">boot_sess</span><span class="o">-&gt;</span><span class="n">target_name</span><span class="p">),</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)));</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">IPv6_ADDR_LEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_type</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_ipaddr</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">IP_ADDR_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">dest_port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* update chap information */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BIT_7</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">))</span>	<span class="p">{</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Setting chap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_chap</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span>
				       <span class="n">target_chap_name</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_secret</span><span class="p">,</span>
				       <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to set chap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_target</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_chap_name_length</span> <span class="o">=</span> <span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">;</span>
		<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">target_secret_length</span> <span class="o">=</span> <span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BIT_4</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Setting BIDI chap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_bidi_chap</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_chap_name</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_secret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to set BIDI chap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_boot_target</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_chap_name_length</span> <span class="o">=</span> <span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">;</span>
		<span class="n">boot_conn</span><span class="o">-&gt;</span><span class="n">chap</span><span class="p">.</span><span class="n">intr_secret_length</span> <span class="o">=</span> <span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_boot_target:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
			  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_boot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">ddb_index</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ddb_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ddb_index</span><span class="p">));</span>
	<span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_fw_boot_info</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				<span class="s">&quot;%s: No boot target configured.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdisablesysfsboot</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sec_target</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_boot_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_tgt</span><span class="p">.</span><span class="n">boot_pri_sess</span><span class="p">),</span>
				      <span class="n">ddb_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Primary boot target not &quot;</span>
				  <span class="s">&quot;configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">sec_target:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_boot_info</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_boot_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_tgt</span><span class="p">.</span><span class="n">boot_sec_sess</span><span class="p">),</span>
				      <span class="n">ddb_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Secondary boot target not&quot;</span>
				  <span class="s">&quot; configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_get_boot_info:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_setup_boot_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_boot_kobj</span> <span class="o">*</span><span class="n">boot_kobj</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_boot_info</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdisablesysfsboot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: syfsboot disabled - driver will trigger login &quot;</span>
			   <span class="s">&quot;and publish session for discovery .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span> <span class="o">=</span> <span class="n">iscsi_boot_create_host_kset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">kset_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">kset_free</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_target</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					     <span class="n">qla4xxx_show_boot_tgt_pri_info</span><span class="p">,</span>
					     <span class="n">qla4xxx_tgt_get_attr_visibility</span><span class="p">,</span>
					     <span class="n">qla4xxx_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">kset_free</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_target</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					     <span class="n">qla4xxx_show_boot_tgt_sec_info</span><span class="p">,</span>
					     <span class="n">qla4xxx_tgt_get_attr_visibility</span><span class="p">,</span>
					     <span class="n">qla4xxx_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">kset_free</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_initiator</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					       <span class="n">qla4xxx_show_boot_ini_info</span><span class="p">,</span>
					       <span class="n">qla4xxx_ini_get_attr_visibility</span><span class="p">,</span>
					       <span class="n">qla4xxx_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_host</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_host_get</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">kset_free</span><span class="p">;</span>
	<span class="n">boot_kobj</span> <span class="o">=</span> <span class="n">iscsi_boot_create_ethernet</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					       <span class="n">qla4xxx_show_boot_eth_info</span><span class="p">,</span>
					       <span class="n">qla4xxx_eth_get_attr_visibility</span><span class="p">,</span>
					       <span class="n">qla4xxx_boot_release</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boot_kobj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_host</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">put_host:</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
<span class="nl">kset_free:</span>
	<span class="n">iscsi_boot_destroy_kset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * qla4xxx_create chap_list - Create CHAP list from FLASH</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Read flash and make a list of CHAP entries, during login when a CHAP entry</span>
<span class="cm"> * is received, it will be checked in this list. If entry exist then the CHAP</span>
<span class="cm"> * entry index is set in the DDB. If CHAP entry does not exist in this list</span>
<span class="cm"> * then a new entry is added in FLASH in CHAP table and the index obtained is</span>
<span class="cm"> * used in the DDB.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_create_chap_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">chap_flash_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">chap_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">chap_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">chap_size</span> <span class="o">=</span> <span class="n">MAX_CHAP_ENTRIES_40XX</span>  <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">else</span>	<span class="cm">/* Single region contains CHAP info for both</span>
<span class="cm">		 * ports which is divided into half for each port.</span>
<span class="cm">		 */</span>
		<span class="n">chap_size</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">chap_flash_data</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">chap_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chap_flash_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;No memory for chap_flash_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_CHAP_OFFSET</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_RAW_ACCESS_ADDR</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_region_chap</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">chap_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_chap_list</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">chap_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;No memory for ha-&gt;chap_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_chap_list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">,</span> <span class="n">chap_flash_data</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">);</span>

<span class="nl">exit_chap_list:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">,</span>
			<span class="n">chap_flash_data</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_get_param_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">tddb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Func: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">tddb</span><span class="o">-&gt;</span><span class="n">tpgt</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">tpgt</span><span class="p">;</span>
	<span class="n">tddb</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_port</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">,</span> <span class="n">ISCSI_NAME_SIZE</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">persistent_address</span><span class="p">,</span> <span class="n">DDB_IPADDR_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_convert_param_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">tddb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tddb</span><span class="o">-&gt;</span><span class="n">tpgt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">tgt_portal_grp</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)));</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="s">&quot;%pI6&quot;</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="s">&quot;%pI4&quot;</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">);</span>

	<span class="n">tddb</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_compare_tuple_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">old_tddb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">new_tddb</span><span class="p">,</span>
				     <span class="kt">uint8_t</span> <span class="n">is_isid_compare</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="cm">/* For multi sessions, driver generates the ISID, so do not compare</span>
<span class="cm">	 * ISID in reset path since it would be a comparision between the</span>
<span class="cm">	 * driver generated ISID and firmware generated ISID. This could</span>
<span class="cm">	 * lead to adding duplicated DDBs in the list as driver generated</span>
<span class="cm">	 * ISID would not match firmware generated ISID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_isid_compare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: old ISID [%02x%02x%02x&quot;</span>
			<span class="s">&quot;%02x%02x%02x] New ISID [%02x%02x%02x%02x%02x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			<span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			<span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;Match Found, fw[%d,%d,%s,%s], [%d,%d,%s,%s]&quot;</span><span class="p">,</span>
			  <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">tpgt</span><span class="p">,</span> <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
			  <span class="n">old_tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">tpgt</span><span class="p">,</span>
			  <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">new_tddb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_is_session_exists</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">fw_tddb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">tmp_tddb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">fw_tddb</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_tddb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_tddb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Memory Allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp_tddb</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_tddb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_tddb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Memory Allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla4xxx_convert_param_ddb</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_tddb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_DDB_ENTRIES</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">qla4xxx_lookup_ddb_by_fw_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">qla4xxx_get_param_ddb</span><span class="p">(</span><span class="n">ddb_entry</span><span class="p">,</span> <span class="n">tmp_tddb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_compare_tuple_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_tddb</span><span class="p">,</span> <span class="n">tmp_tddb</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="cm">/* found */</span>
			<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit_check:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_tddb</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">fw_tddb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_tddb</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">tmp_tddb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_is_flash_ddb_exists</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_nt</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">nt_ddb_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">nt_ddb_idx_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">fw_tddb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="o">*</span><span class="n">tmp_tddb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">fw_tddb</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_tddb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_tddb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Memory Allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp_tddb</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_tddb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_tddb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Memory Allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qla4xxx_convert_param_ddb</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_tddb</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">nt_ddb_idx</span><span class="p">,</span> <span class="n">nt_ddb_idx_tmp</span><span class="p">,</span> <span class="n">list_nt</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4xxx_convert_param_ddb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nt_ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb</span><span class="p">,</span> <span class="n">tmp_tddb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_compare_tuple_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_tddb</span><span class="p">,</span> <span class="n">tmp_tddb</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span> <span class="cm">/* found */</span>
			<span class="k">goto</span> <span class="n">exit_check</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit_check:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_tddb</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">fw_tddb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_tddb</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">tmp_tddb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_free_ddb_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_ddb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">ddb_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">ddb_idx_tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ddb_idx</span><span class="p">,</span> <span class="n">ddb_idx_tmp</span><span class="p">,</span> <span class="n">list_ddb</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_idx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">ddb_idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="nf">qla4xxx_get_ep_fwdb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="cm">/* TODO: need to destroy on unload iscsi_endpoint*/</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dst_addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dst_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">IPv6_ADDR_LEN</span><span class="p">);</span>
		<span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">IP_ADDR_LEN</span><span class="p">);</span>
		<span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ep</span> <span class="o">=</span> <span class="n">qla4xxx_ep_connect</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_verify_boot_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdisablesysfsboot</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pri_ddb_idx</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">sec_ddb_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_setup_flash_ddb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">def_timeout</span><span class="p">;</span>

	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">=</span> <span class="n">FLASH_DDB</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span> <span class="o">=</span> <span class="n">INVALID_ENTRY</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_device_state</span> <span class="o">=</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">unblock_sess</span> <span class="o">=</span> <span class="n">qla4xxx_unblock_flash_ddb</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_change</span> <span class="o">=</span> <span class="n">qla4xxx_flash_ddb_change</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">retry_relogin_timer</span><span class="p">,</span> <span class="n">INVALID_ENTRY</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">relogin_retry_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">def_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_entry</span><span class="p">.</span><span class="n">def_timeout</span><span class="p">);</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_relogin_timeout</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">def_timeout</span> <span class="o">&gt;</span> <span class="n">LOGIN_TOV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">def_timeout</span> <span class="o">&lt;</span> <span class="n">LOGIN_TOV</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">def_timeout</span> <span class="o">:</span> <span class="n">LOGIN_TOV</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">default_time2wait</span> <span class="o">=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_entry</span><span class="p">.</span><span class="n">iscsi_def_time2wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_wait_for_ip_configuration</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ip_idx</span><span class="p">[</span><span class="n">IP_ADDR_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span> <span class="cm">/* 4 IP interfaces */</span>
	<span class="kt">uint32_t</span> <span class="n">sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">ip_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">IP_CONFIG_TOV</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">IP_ADDR_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_ip_state</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ip_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sts</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ip_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ip_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IP_STATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IP_STATE_SHIFT</span><span class="p">;</span>

			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					  <span class="s">&quot;Waiting for IP state for idx = %d, state = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ip_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ip_state</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ip_state</span> <span class="o">==</span> <span class="n">IP_ADDRSTATE_UNCONFIGURED</span> <span class="o">||</span>
			    <span class="n">ip_state</span> <span class="o">==</span> <span class="n">IP_ADDRSTATE_INVALID</span> <span class="o">||</span>
			    <span class="n">ip_state</span> <span class="o">==</span> <span class="n">IP_ADDRSTATE_PREFERRED</span> <span class="o">||</span>
			    <span class="n">ip_state</span> <span class="o">==</span> <span class="n">IP_ADDRSTATE_DEPRICATED</span> <span class="o">||</span>
			    <span class="n">ip_state</span> <span class="o">==</span> <span class="n">IP_ADDRSTATE_DISABLING</span><span class="p">)</span>
				<span class="n">ip_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Break if all IP states checked */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ip_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ip_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ip_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ip_idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">wtime</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_build_st_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">st_ddb_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_ddbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_idx_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conn_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">conn_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">fw_ddb_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_st_list</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_ddbs</span> <span class="o">=</span>  <span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAX_DEV_DB_ENTRIES_40XX</span> <span class="o">:</span>
				     <span class="n">MAX_DEV_DB_ENTRIES</span><span class="p">;</span>
	<span class="n">fw_idx_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_ddb_index</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">max_ddbs</span><span class="p">;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">next_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_dma</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">conn_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Ignore DDB if invalid state (unassigned) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">DDB_DS_UNASSIGNED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">continue_next_st</span><span class="p">;</span>

		<span class="cm">/* Check if ST, add to the list_st */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">continue_next_st</span><span class="p">;</span>

		<span class="n">st_ddb_idx</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">fw_idx_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">st_ddb_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">st_ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ddb_idx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list_st</span><span class="p">);</span>
<span class="nl">continue_next_st:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_st_list:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_remove_failed_ddb - Remove inactive or failed ddb from list</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> * @list_ddb: List from which failed ddb to be removed</span>
<span class="cm"> *</span>
<span class="cm"> * Iterate over the list of DDBs and find and remove DDBs that are either in</span>
<span class="cm"> * no connection active state or failed state</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_remove_failed_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_ddb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">ddb_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">ddb_idx_tmp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conn_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ddb_idx</span><span class="p">,</span> <span class="n">ddb_idx_tmp</span><span class="p">,</span> <span class="n">list_ddb</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb_idx</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">conn_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span> <span class="o">||</span>
		    <span class="n">state</span> <span class="o">==</span> <span class="n">DDB_DS_SESSION_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_idx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">ddb_idx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_sess_conn_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">is_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmds_max</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">conn_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">initial_cmdsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Create session object, with INVALID_ENTRY,</span>
<span class="cm">	 * the targer_id would get set when we issue the login</span>
<span class="cm">	 */</span>
	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">iscsi_session_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span>
				       <span class="n">cmds_max</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ddb_entry</span><span class="p">),</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_task_data</span><span class="p">),</span>
				       <span class="n">initial_cmdsn</span><span class="p">,</span> <span class="n">INVALID_ENTRY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * so calling module_put function to decrement the</span>
<span class="cm">	 * reference count.</span>
<span class="cm">	 **/</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="p">;</span>

	<span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">recovery_tmo</span> <span class="o">=</span> <span class="n">ql4xsess_recovery_tmo</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span><span class="p">));</span>

	<span class="n">qla4xxx_setup_flash_ddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">);</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">iscsi_conn_setup</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_conn</span><span class="p">),</span> <span class="n">conn_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls_conn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="p">;</span>

	<span class="cm">/* Setup ep, for displaying attributes in sysfs */</span>
	<span class="n">ep</span> <span class="o">=</span> <span class="n">qla4xxx_get_ep_fwdb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="p">;</span>
		<span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unable to get ep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update sess/conn params */</span>
	<span class="n">qla4xxx_copy_fwddb_param</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">cls_sess</span><span class="p">,</span> <span class="n">cls_conn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_reset</span> <span class="o">==</span> <span class="n">RESET_ADAPTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iscsi_block_session</span><span class="p">(</span><span class="n">cls_sess</span><span class="p">);</span>
		<span class="cm">/* Use the relogin path to discover new devices</span>
<span class="cm">		 *  by short-circuting the logic of setting</span>
<span class="cm">		 *  timer to relogin - instead set the flags</span>
<span class="cm">		 *  to initiate login right away.</span>
<span class="cm">		 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RELOGIN_DEVICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DF_RELOGIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit_setup:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_build_nt_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_nt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_ddbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_idx_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">conn_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">conn_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">nt_ddb_idx</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">fw_ddb_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_nt_list</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max_ddbs</span> <span class="o">=</span>  <span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span> <span class="n">MAX_DEV_DB_ENTRIES_40XX</span> <span class="o">:</span>
				     <span class="n">MAX_DEV_DB_ENTRIES</span><span class="p">;</span>
	<span class="n">fw_idx_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qla_ddb_index</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">max_ddbs</span><span class="p">;</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">next_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_dma</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">conn_err</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conn_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_verify_boot_idx</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">continue_next_nt</span><span class="p">;</span>

		<span class="cm">/* Check if NT, then add to list it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">continue_next_nt</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">DDB_DS_NO_CONNECTION_ACTIVE</span> <span class="o">||</span>
		    <span class="n">state</span> <span class="o">==</span> <span class="n">DDB_DS_SESSION_FAILED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">continue_next_nt</span><span class="p">;</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;Adding  DDB to session = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_reset</span> <span class="o">==</span> <span class="n">INIT_ADAPTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nt_ddb_idx</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">fw_idx_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nt_ddb_idx</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">nt_ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nt_ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_is_flash_ddb_exists</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">list_nt</span><span class="p">,</span>
					<span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">nt_ddb_idx</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">continue_next_nt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nt_ddb_idx</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">list_nt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_reset</span> <span class="o">==</span> <span class="n">RESET_ADAPTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_is_session_exists</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="o">==</span>
								<span class="n">QLA_SUCCESS</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">continue_next_nt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_sess_conn_setup</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">is_reset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_nt_list</span><span class="p">;</span>

<span class="nl">continue_next_nt:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_nt_list:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_ddb_dma_pool</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_build_ddb_list - Build ddb list and setup sessions</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> * @is_reset: Is this init path or reset path</span>
<span class="cm"> *</span>
<span class="cm"> * Create a list of sendtargets (st) from firmware DDBs, issue send targets</span>
<span class="cm"> * using connection open, then create the list of normal targets (nt)</span>
<span class="cm"> * from firmware DDBs. Based on the list of nt setup session and connection</span>
<span class="cm"> * objects.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_build_ddb_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">tmo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_st</span><span class="p">,</span> <span class="n">list_nt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_ddb_index</span>  <span class="o">*</span><span class="n">st_ddb_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">st_ddb_idx_tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_BUILD_DDB_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">is_reset</span> <span class="o">=</span> <span class="n">is_reset</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_st</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_nt</span><span class="p">);</span>

	<span class="n">qla4xxx_build_st_list</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_st</span><span class="p">);</span>

	<span class="cm">/* Before issuing conn open mbox, ensure all IPs states are configured</span>
<span class="cm">	 * Note, conn open fails if IPs are not configured</span>
<span class="cm">	 */</span>
	<span class="n">qla4xxx_wait_for_ip_configuration</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Go thru the STs and fire the sendtargets by issuing conn open mbx */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">st_ddb_idx</span><span class="p">,</span> <span class="n">st_ddb_idx_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_st</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4xxx_conn_open</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">st_ddb_idx</span><span class="o">-&gt;</span><span class="n">fw_ddb_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wait to ensure all sendtargets are done for min 12 sec wait */</span>
	<span class="n">tmo</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">def_timeout</span> <span class="o">&gt;</span> <span class="n">LOGIN_TOV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">def_timeout</span> <span class="o">&lt;</span> <span class="n">LOGIN_TOV</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">def_timeout</span> <span class="o">:</span> <span class="n">LOGIN_TOV</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;Default time to wait for build ddb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmo</span><span class="p">));</span>

	<span class="n">wtime</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">tmo</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_st</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">qla4xxx_remove_failed_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_st</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">wtime</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="cm">/* Free up the sendtargets list */</span>
	<span class="n">qla4xxx_free_ddb_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_st</span><span class="p">);</span>

	<span class="n">qla4xxx_build_nt_list</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_nt</span><span class="p">,</span> <span class="n">is_reset</span><span class="p">);</span>

	<span class="n">qla4xxx_free_ddb_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list_nt</span><span class="p">);</span>

	<span class="n">qla4xxx_free_ddb_index</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_probe_adapter - callback function to probe HBA</span>
<span class="cm"> * @pdev: pointer to pci_dev structure</span>
<span class="cm"> * @pci_device_id: pointer to pci_device entry</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will probe for Qlogic 4xxx iSCSI host adapters.</span>
<span class="cm"> * It returns zero if successful. It also initializes all data necessary for</span>
<span class="cm"> * the driver.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qla4xxx_probe_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">init_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qla4_8xxx_legacy_intr_set</span> <span class="o">*</span><span class="n">nx_legacy_intr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">iscsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;qla4xxx: Couldn&#39;t allocate host from scsi layer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear our data area */</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ha</span><span class="p">));</span>

	<span class="cm">/* Save the information from PCI BIOS.	*/</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>

	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Setup Runtime configurable options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla4_8xxx_isp_ops</span><span class="p">;</span>
		<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">qdr_sn_window</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ddr_mn_window</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">curr_window</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">nx_legacy_intr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">legacy_intr</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span><span class="p">];</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">int_vec_bit</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_status_reg</span> <span class="o">=</span>
			<span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">pci_int_reg</span> <span class="o">=</span> <span class="n">nx_legacy_intr</span><span class="o">-&gt;</span><span class="n">pci_int_reg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla4xxx_isp_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set EEH reset type to fundamental if required by hba */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">needs_freset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Configure PCI I/O space. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">iospace_config</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_failed_ioconfig</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Found an ISP%04x, irq %d, iobase 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">qla4xxx_config_dma_addressing</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Initialize lists and spinlocks. */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">free_srb_q</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">disable_acb_comp</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">);</span>

	<span class="cm">/* Initialize work list */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">work_list</span><span class="p">);</span>

	<span class="cm">/* Allocate dma buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mem_alloc</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;[ERROR] Failed to allocate memory for adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">MAX_LUNS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">MAX_TARGETS</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="n">IOCB_MAX_CDB_LEN</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">MAX_SRBS</span> <span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">qla4xxx_scsi_transport</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_init_shared_tag_map</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">MAX_SRBS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: scsi_init_shared_tag_map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">probe_failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">qla4_8xxx_get_flash_info</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the Host adapter request/response queues and</span>
<span class="cm">	 * firmware</span>
<span class="cm">	 * NOTE: interrupts enabled upon successful completion</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">INIT_ADAPTER</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">init_retry_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_INIT_RETRIES</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: don&#39;t retry &quot;</span>
				    <span class="s">&quot;initialize adapter. H/W is in failed state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: %s: retrying adapter initialization &quot;</span>
			      <span class="s">&quot;(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">init_retry_count</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">reset_chip</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">INIT_ADAPTER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to initialize adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Put the device in failed state. */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HW STATE: FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remove_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Startup the kernel thread for this host adapter. */</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi: %s: Starting kernel thread for &quot;</span>
		      <span class="s">&quot;qla4xxx_dpc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;qla4xxx_%lu_dpc&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unable to start DPC thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remove_host</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_work</span><span class="p">,</span> <span class="n">qla4xxx_do_dpc</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;qla4xxx_%lu_task&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">task_wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">WQ_MEM_RECLAIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">task_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Unable to start task thread!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">remove_host</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For ISP-82XX, request_irqs is called in qla4_8xxx_load_risc</span>
<span class="cm">	 * (which is called indirectly by qla4xxx_initialize_adapter),</span>
<span class="cm">	 * so that irqs will be registered after crbinit but before</span>
<span class="cm">	 * mbx_intr_enable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to reserve &quot;</span>
			    <span class="s">&quot;interrupt %d already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">remove_host</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Start timer thread. */</span>
	<span class="n">qla4xxx_start_timer</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">qla4xxx_timer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">qla4_8xxx_alloc_sysfs_attr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot; QLogic iSCSI HBA Driver version: %s</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;  QLogic ISP%04x @ %s, host#=%ld, fw=%02d.%02d.%02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">qla4xxx_version_str</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">patch_number</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">build_number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_setup_boot_info</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: No iSCSI boot target configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Perform the build ddb list and login to each */</span>
	<span class="n">qla4xxx_build_ddb_list</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">INIT_ADAPTER</span><span class="p">);</span>
	<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_login_flash_ddb</span><span class="p">);</span>

	<span class="n">qla4xxx_create_chap_list</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">qla4xxx_create_ifaces</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">remove_host:</span>
	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

<span class="nl">probe_failed:</span>
	<span class="n">qla4xxx_free_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

<span class="nl">probe_failed_ioconfig:</span>
	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

<span class="nl">probe_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_prevent_other_port_reinit - prevent other port from re-initialize</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * Mark the other ISP-4xxx port to indicate that the driver is being removed,</span>
<span class="cm"> * so that the other port will not re-initialize while in the process of</span>
<span class="cm"> * removing the ha due to driver unload or hba hotplug.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_prevent_other_port_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">other_ha</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">other_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">ISP4XXX_PCI_FN_2</span><span class="p">;</span>

	<span class="cm">/*iscsi function numbers for ISP4xxx is 1 and 3*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">)</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">ISP4XXX_PCI_FN_1</span><span class="p">;</span>

	<span class="n">other_pdev</span> <span class="o">=</span>
		<span class="n">pci_get_domain_bus_and_slot</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">fn</span><span class="p">));</span>

	<span class="cm">/* Get other_ha if other_pdev is valid and state is enable*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other_pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">other_ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">other_ha</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_HA_REMOVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: &quot;</span>
				    <span class="s">&quot;Prevent %s reinit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_destroy_fw_ddb_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MAX_DDB_ENTRIES</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">qla4xxx_lookup_ddb_by_fw_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ddb_entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ddb_type</span> <span class="o">==</span> <span class="n">FLASH_DDB</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">options</span> <span class="o">=</span> <span class="n">LOGOUT_OPTION_CLOSE_SESSION</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_session_logout_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
			    <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Logout failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>

			<span class="n">qla4xxx_clear_ddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * we have decremented the reference count of the driver</span>
<span class="cm">			 * when we setup the session to have the driver unload</span>
<span class="cm">			 * to be seamless without actually destroying the</span>
<span class="cm">			 * session</span>
<span class="cm">			 **/</span>
			<span class="n">try_module_get</span><span class="p">(</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
			<span class="n">iscsi_destroy_endpoint</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">);</span>
			<span class="n">qla4xxx_free_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">);</span>
			<span class="n">iscsi_session_teardown</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * qla4xxx_remove_adapter - calback function to remove adapter.</span>
<span class="cm"> * @pci_dev: PCI device pointer</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">qla4xxx_remove_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">qla4xxx_prevent_other_port_reinit</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* destroy iface from sysfs */</span>
	<span class="n">qla4xxx_destroy_ifaces</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ql4xdisablesysfsboot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">)</span>
		<span class="n">iscsi_boot_destroy_kset</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">boot_kset</span><span class="p">);</span>

	<span class="n">qla4xxx_destroy_fw_ddb_session</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4_8xxx_free_sysfs_attr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">qla4xxx_free_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_config_dma_addressing() - Configure OS DMA addressing method.</span>
<span class="cm"> * @ha: HA context</span>
<span class="cm"> *</span>
<span class="cm"> * At exit, the @ha&#39;s flags.enable_64bit_addressing set to indicated</span>
<span class="cm"> * supported addressing method.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_config_dma_addressing</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Update our PCI device dma_mask for full 64 bit mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to set 64 bit PCI consistent mask; &quot;</span>
				   <span class="s">&quot;using 32 bit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							     <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_depth</span> <span class="o">=</span> <span class="n">QL4_DEF_QDEPTH</span><span class="p">;</span>

	<span class="n">cls_sess</span> <span class="o">=</span> <span class="n">starget_to_session</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cls_sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">ddb</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">ddb</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xmaxqdepth</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ql4xmaxqdepth</span> <span class="o">&lt;=</span> <span class="mh">0xffffU</span><span class="p">)</span>
		<span class="n">queue_depth</span> <span class="o">=</span> <span class="n">ql4xmaxqdepth</span><span class="p">;</span>

	<span class="n">scsi_activate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_deactivate_tcq</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql4xqfulltracking</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iscsi_change_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_del_from_active_array - returns an active srb</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @index: index into the active_array</span>
<span class="cm"> *</span>
<span class="cm"> * This routine removes and returns the srb at the specified index</span>
<span class="cm"> **/</span>
<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="nf">qla4xxx_del_from_active_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">scsi_host_find_tag</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span><span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>

	<span class="cm">/* update counters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SRB_DMA_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">+=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">-=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">MAX_SRBS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">srb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_wait_on_command - waits for command to be returned by firmware</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @cmd: Scsi Command to wait on.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine waits for the command to be returned by the Firmware</span>
<span class="cm"> * for some max time.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_wait_on_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">max_wait_time</span> <span class="o">=</span> <span class="n">EH_WAIT_CMD_TOV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Dont wait on command if PCI error is being handled</span>
<span class="cm">	 * by PCI AER driver</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: Return from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Checking to see if its returned to OS */</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">max_wait_time</span><span class="o">--</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_wait_for_hba_online - waits for HBA to come online</span>
<span class="cm"> * @ha: Pointer to host adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_wait_for_hba_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait_online</span><span class="p">;</span>

	<span class="n">wait_online</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HBA_ONLINE_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_online</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter_up</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_wait_for_commands - wait for active cmds to finish.</span>
<span class="cm"> * @ha: pointer to HBA</span>
<span class="cm"> * @t: target id</span>
<span class="cm"> * @l: lun id</span>
<span class="cm"> *</span>
<span class="cm"> * This function waits for all outstanding commands to a lun to complete. It</span>
<span class="cm"> * returns 0 if all pending commands are returned and 1 otherwise.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_wait_for_commands</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">stgt</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Waiting for all commands for the designated target or dev</span>
<span class="cm">	 * in the active array</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">scsi_host_find_tag</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">stgt</span> <span class="o">==</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">sdev</span> <span class="o">||</span> <span class="n">sdev</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_eh_wait_on_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_abort - callback for abort task.</span>
<span class="cm"> * @cmd: Pointer to Linux&#39;s SCSI command structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the Linux OS to abort the specified</span>
<span class="cm"> * command.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;scsi%ld:%d:%d: Abort command issued cmd=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">srb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMD_SP</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_abort_task</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">srb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG3</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d: Abort_task mbx failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG3</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d: Abort_task mbx success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
		<span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">,</span> <span class="n">qla4xxx_srb_compl</span><span class="p">);</span>

	<span class="cm">/* Wait for command to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_eh_wait_on_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d: Abort handler timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;scsi%ld:%d:%d: Abort command - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;succeeded&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_device_reset - callback for target reset.</span>
<span class="cm"> * @cmd: Pointer to Linux&#39;s SCSI command structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the Linux OS to reset all luns on the</span>
<span class="cm"> * specified target.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddb_entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iscsi_block_scsi_eh</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		   <span class="s">&quot;scsi%ld:%d:%d:%d: DEVICE RESET ISSUED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		      <span class="s">&quot;scsi%ld: DEVICE_RESET cmd=%p jiffies = 0x%lx, to=%x,&quot;</span>
		      <span class="s">&quot;dpc_flags=%lx, status=%x allowed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		      <span class="n">cmd</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">));</span>

	<span class="cm">/* FIXME: wait for hba to go online */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">qla4xxx_reset_lun</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;DEVICE RESET FAILED. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_dev_reset_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_eh_wait_for_commands</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
					 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;DEVICE RESET FAILED - waiting for &quot;</span>
			   <span class="s">&quot;commands.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eh_dev_reset_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send marker. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_send_marker_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		<span class="n">MM_LUN_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eh_dev_reset_done</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		   <span class="s">&quot;scsi(%ld:%d:%d:%d): DEVICE RESET SUCCEEDED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">eh_dev_reset_done:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_target_reset - callback for target reset.</span>
<span class="cm"> * @cmd: Pointer to Linux&#39;s SCSI command structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the Linux OS to reset the target.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_target_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ddb_entry</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iscsi_block_scsi_eh</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
		       <span class="s">&quot;WARM TARGET RESET ISSUED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		      <span class="s">&quot;scsi%ld: TARGET_DEVICE_RESET cmd=%p jiffies = 0x%lx, &quot;</span>
		      <span class="s">&quot;to=%x,dpc_flags=%lx, status=%x allowed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">));</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">qla4xxx_reset_target</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
			       <span class="s">&quot;WARM TARGET RESET FAILED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_eh_wait_for_commands</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
					 <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
			       <span class="s">&quot;WARM TARGET DEVICE RESET FAILED - &quot;</span>
			       <span class="s">&quot;waiting for commands.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send marker. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_send_marker_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
		<span class="n">MM_TGT_WARM_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
			       <span class="s">&quot;WARM TARGET DEVICE RESET FAILED - &quot;</span>
			       <span class="s">&quot;marker iocb failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span>
		       <span class="s">&quot;WARM TARGET RESET SUCCEEDED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_is_eh_active - check if error handler is running</span>
<span class="cm"> * @shost: Pointer to SCSI Host struct</span>
<span class="cm"> *</span>
<span class="cm"> * This routine finds that if reset host is called in EH</span>
<span class="cm"> * scenario or from some application like sg_reset</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_is_eh_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">shost_state</span> <span class="o">==</span> <span class="n">SHOST_RECOVERY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_eh_host_reset - kernel callback</span>
<span class="cm"> * @cmd: Pointer to Linux&#39;s SCSI command structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is invoked by the Linux kernel to perform fatal error</span>
<span class="cm"> * recovery on the specified adapter.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">return_status</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Don&#39;t Reset HBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

		<span class="cm">/* Clear outstanding srb in queues */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_is_eh_active</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span>
			<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_ABORT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		   <span class="s">&quot;scsi(%ld:%d:%d:%d): HOST RESET ISSUED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_wait_for_hba_online</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d: %s: Unable to reset host.  Adapter &quot;</span>
			      <span class="s">&quot;DEAD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			      <span class="n">__func__</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_recover_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">return_status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;HOST RESET %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">return_status</span> <span class="o">==</span> <span class="n">FAILED</span> <span class="o">?</span> <span class="s">&quot;FAILED&quot;</span> <span class="o">:</span> <span class="s">&quot;SUCCEEDED&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">return_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_context_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span> <span class="o">*</span><span class="n">acb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">acb_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">acb_dma</span><span class="p">;</span>

	<span class="n">acb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">acb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Unable to alloc acb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_port_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">acb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acb_len</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_acb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">acb_dma</span><span class="p">,</span> <span class="n">PRIMARI_ACB</span><span class="p">,</span> <span class="n">acb_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_free_acb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_disable_acb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_free_acb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">disable_acb_comp</span><span class="p">,</span>
				    <span class="n">DISABLE_ACB_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_set_acb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acb_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_free_acb</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_free_acb:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk_def</span><span class="p">),</span>
			  <span class="n">acb</span><span class="p">,</span> <span class="n">acb_dma</span><span class="p">);</span>
<span class="nl">exit_port_reset:</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			  <span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">?</span> <span class="s">&quot;SUCCEEDED&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">to_qla_host</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Don&#39;t Reset HBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_wait_for_hba_online</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Unable to reset host &quot;</span>
				  <span class="s">&quot;adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_host_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">recover_adapter</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCSI_ADAPTER_RESET</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCSI_FIRMWARE_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="cm">/* set firmware context reset */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_context_reset</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit_host_reset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">recover_adapter:</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_recover_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: recover adapter fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_host_reset:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PCI AER driver recovers from all correctable errors w/o</span>
<span class="cm"> * driver intervention. For uncorrectable errors PCI AER</span>
<span class="cm"> * driver calls the following device driver&#39;s callbacks</span>
<span class="cm"> *</span>
<span class="cm"> * - Fatal Errors - link_reset</span>
<span class="cm"> * - Non-Fatal Errors - driver&#39;s pci_error_detected() which</span>
<span class="cm"> * returns CAN_RECOVER, NEED_RESET or DISCONNECT.</span>
<span class="cm"> *</span>
<span class="cm"> * PCI AER driver calls</span>
<span class="cm"> * CAN_RECOVER - driver&#39;s pci_mmio_enabled(), mmio_enabled</span>
<span class="cm"> *               returns RECOVERED or NEED_RESET if fw_hung</span>
<span class="cm"> * NEED_RESET - driver&#39;s slot_reset()</span>
<span class="cm"> * DISCONNECT - device is dead &amp; cannot recover</span>
<span class="cm"> * RECOVERED - driver&#39;s pci_resume()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla4xxx_pci_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: error detected:state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_aer_supported</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_normal</span>:
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">qla4xxx_mailbox_premature_completion</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4xxx_free_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="cm">/* Return back all IOs */</span>
		<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_PCI_CHANNEL_IO_PERM_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">qla4xxx_abort_active_cmds</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_pci_mmio_enabled() gets called if</span>
<span class="cm"> * qla4xxx_pci_error_detected() returns PCI_ERS_RESULT_CAN_RECOVER</span>
<span class="cm"> * and read/write to the device still works.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla4xxx_pci_mmio_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_aer_supported</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">qla4_8xxx_error_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">other_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: In %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">iscsi_host_for_each_session</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">qla4xxx_fail_session</span><span class="p">);</span>
		<span class="n">qla4xxx_process_aen</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fn</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fn</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Finding PCI device at &quot;</span>
		    <span class="s">&quot;func %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
		<span class="cm">/* Get the pci device given the domain, bus,</span>
<span class="cm">		 * slot/function number */</span>
		<span class="n">other_pdev</span> <span class="o">=</span>
		    <span class="n">pci_get_domain_bus_and_slot</span><span class="p">(</span><span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span>
		    <span class="n">fn</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">other_pdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other_pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Found PCI &quot;</span>
			    <span class="s">&quot;func in enabled state%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">fn</span><span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">other_pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The first function on the card, the reset owner will</span>
<span class="cm">	 * start &amp; initialize the firmware. The other functions</span>
<span class="cm">	 * on the card will reset the firmware context</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: devfn being reset &quot;</span>
		    <span class="s">&quot;0x%x is the owner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
		    <span class="n">QLA82XX_DEV_COLD</span><span class="p">);</span>

		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_IDC_VERSION</span><span class="p">,</span>
		    <span class="n">QLA82XX_IDC_VERSION</span><span class="p">);</span>

		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">RESET_ADAPTER</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: HW State: &quot;</span>
			    <span class="s">&quot;FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">qla4_8xxx_clear_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: HW State: &quot;</span>
			    <span class="s">&quot;READY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">,</span>
			    <span class="n">QLA82XX_DEV_READY</span><span class="p">);</span>
			<span class="cm">/* Clear driver state register */</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DRV_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">qla4_8xxx_set_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to &quot;</span>
				    <span class="s">&quot;reserve interrupt %d already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: devfn 0x%x is not &quot;</span>
		    <span class="s">&quot;the reset owner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">QLA82XX_DEV_READY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_initialize_adapter</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">RESET_ADAPTER</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_request_irqs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Failed to&quot;</span>
					    <span class="s">&quot; reserve interrupt %d already in&quot;</span>
					    <span class="s">&quot; use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">enable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
					<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4_8xxx_set_drv_active</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span>
<span class="nf">qla4xxx_pci_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_ers_result_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: slot_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_aer_supported</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NONE</span><span class="p">;</span>

	<span class="cm">/* Restore the saved state of PCIe device -</span>
<span class="cm">	 * BAR registers, PCI Config space, PCIX, MSI,</span>
<span class="cm">	 * IOV states</span>
<span class="cm">	 */</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* pci_restore_state() clears the saved_state flag of the device</span>
<span class="cm">	 * save restored state which resets saved_state flag</span>
<span class="cm">	 */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Initialize device or resume if in suspended state */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Can&#39;t re-enable &quot;</span>
		    <span class="s">&quot;device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qla4_8xxx_error_recovery</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">exit_slot_reset</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit_slot_reset:</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Return=%x</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4xxx_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: pci_resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4xxx_wait_for_hba_online</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: the device failed to &quot;</span>
		    <span class="s">&quot;resume I/O from slot/link_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		     <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_EEH_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">qla4xxx_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">qla4xxx_pci_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmio_enabled</span> <span class="o">=</span> <span class="n">qla4xxx_pci_mmio_enabled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">qla4xxx_pci_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qla4xxx_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">qla4xxx_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4010</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4022</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>		<span class="o">=</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>		<span class="o">=</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4032</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>	<span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>         <span class="o">=</span> <span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>         <span class="o">=</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8022</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>      <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">qla4xxx_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">qla4xxx_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">qla4xxx_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">qla4xxx_probe_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">qla4xxx_remove_adapter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla4xxx_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qla4xxx_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Allocate cache for SRBs. */</span>
	<span class="n">srb_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;qla4xxx_srbs&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">srb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s: Unable to allocate SRB cache...&quot;</span>
		       <span class="s">&quot;Failing load!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_srp_cache</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Derive version string. */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">qla4xxx_version_str</span><span class="p">,</span> <span class="n">QLA4XXX_DRIVER_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xextended_error_logging</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">qla4xxx_version_str</span><span class="p">,</span> <span class="s">&quot;-debug&quot;</span><span class="p">);</span>

	<span class="n">qla4xxx_scsi_transport</span> <span class="o">=</span>
		<span class="n">iscsi_register_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_scsi_transport</span><span class="p">){</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_srb_cache</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unregister_transport</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;QLogic iSCSI HBA Driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unregister_transport:</span>
	<span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">);</span>
<span class="nl">release_srb_cache:</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
<span class="nl">no_srp_cache:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qla4xxx_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_pci_driver</span><span class="p">);</span>
	<span class="n">iscsi_unregister_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qla4xxx_iscsi_transport</span><span class="p">);</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">srb_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qla4xxx_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qla4xxx_module_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;QLogic Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QLogic iSCSI HBA Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">QLA4XXX_DRIVER_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
