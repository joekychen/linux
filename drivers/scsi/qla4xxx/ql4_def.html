<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_def.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_def.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __QL4_DEF_H</span>
<span class="cp">#define __QL4_DEF_H</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;linux/bsg-lib.h&gt;</span>

<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_iscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_bsg_iscsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_netlink.h&gt;</span>
<span class="cp">#include &lt;scsi/libiscsi.h&gt;</span>

<span class="cp">#include &quot;ql4_dbg.h&quot;</span>
<span class="cp">#include &quot;ql4_nx.h&quot;</span>
<span class="cp">#include &quot;ql4_fw.h&quot;</span>
<span class="cp">#include &quot;ql4_nvram.h&quot;</span>

<span class="cp">#ifndef PCI_DEVICE_ID_QLOGIC_ISP4010</span>
<span class="cp">#define PCI_DEVICE_ID_QLOGIC_ISP4010	0x4010</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCI_DEVICE_ID_QLOGIC_ISP4022</span>
<span class="cp">#define PCI_DEVICE_ID_QLOGIC_ISP4022	0x4022</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCI_DEVICE_ID_QLOGIC_ISP4032</span>
<span class="cp">#define PCI_DEVICE_ID_QLOGIC_ISP4032	0x4032</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef PCI_DEVICE_ID_QLOGIC_ISP8022</span>
<span class="cp">#define PCI_DEVICE_ID_QLOGIC_ISP8022	0x8022</span>
<span class="cp">#endif</span>

<span class="cp">#define ISP4XXX_PCI_FN_1	0x1</span>
<span class="cp">#define ISP4XXX_PCI_FN_2	0x3</span>

<span class="cp">#define QLA_SUCCESS			0</span>
<span class="cp">#define QLA_ERROR			1</span>

<span class="cm">/*</span>
<span class="cm"> * Data bit definitions</span>
<span class="cm"> */</span>
<span class="cp">#define BIT_0	0x1</span>
<span class="cp">#define BIT_1	0x2</span>
<span class="cp">#define BIT_2	0x4</span>
<span class="cp">#define BIT_3	0x8</span>
<span class="cp">#define BIT_4	0x10</span>
<span class="cp">#define BIT_5	0x20</span>
<span class="cp">#define BIT_6	0x40</span>
<span class="cp">#define BIT_7	0x80</span>
<span class="cp">#define BIT_8	0x100</span>
<span class="cp">#define BIT_9	0x200</span>
<span class="cp">#define BIT_10	0x400</span>
<span class="cp">#define BIT_11	0x800</span>
<span class="cp">#define BIT_12	0x1000</span>
<span class="cp">#define BIT_13	0x2000</span>
<span class="cp">#define BIT_14	0x4000</span>
<span class="cp">#define BIT_15	0x8000</span>
<span class="cp">#define BIT_16	0x10000</span>
<span class="cp">#define BIT_17	0x20000</span>
<span class="cp">#define BIT_18	0x40000</span>
<span class="cp">#define BIT_19	0x80000</span>
<span class="cp">#define BIT_20	0x100000</span>
<span class="cp">#define BIT_21	0x200000</span>
<span class="cp">#define BIT_22	0x400000</span>
<span class="cp">#define BIT_23	0x800000</span>
<span class="cp">#define BIT_24	0x1000000</span>
<span class="cp">#define BIT_25	0x2000000</span>
<span class="cp">#define BIT_26	0x4000000</span>
<span class="cp">#define BIT_27	0x8000000</span>
<span class="cp">#define BIT_28	0x10000000</span>
<span class="cp">#define BIT_29	0x20000000</span>
<span class="cp">#define BIT_30	0x40000000</span>
<span class="cp">#define BIT_31	0x80000000</span>

<span class="cm">/**</span>
<span class="cm"> * Macros to help code, maintain, etc.</span>
<span class="cm"> **/</span>
<span class="cp">#define ql4_printk(level, ha, format, arg...) \</span>
<span class="cp">	dev_printk(level , &amp;((ha)-&gt;pdev-&gt;dev) , format , ## arg)</span>


<span class="cm">/*</span>
<span class="cm"> * Host adapter default definitions</span>
<span class="cm"> ***********************************/</span>
<span class="cp">#define MAX_HBAS		16</span>
<span class="cp">#define MAX_BUSES		1</span>
<span class="cp">#define MAX_TARGETS		MAX_DEV_DB_ENTRIES</span>
<span class="cp">#define MAX_LUNS		0xffff</span>
<span class="cp">#define MAX_AEN_ENTRIES		MAX_DEV_DB_ENTRIES</span>
<span class="cp">#define MAX_DDB_ENTRIES		MAX_DEV_DB_ENTRIES</span>
<span class="cp">#define MAX_PDU_ENTRIES		32</span>
<span class="cp">#define INVALID_ENTRY		0xFFFF</span>
<span class="cp">#define MAX_CMDS_TO_RISC	1024</span>
<span class="cp">#define MAX_SRBS		MAX_CMDS_TO_RISC</span>
<span class="cp">#define MBOX_AEN_REG_COUNT	8</span>
<span class="cp">#define MAX_INIT_RETRIES	5</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer sizes</span>
<span class="cm"> */</span>
<span class="cp">#define REQUEST_QUEUE_DEPTH		MAX_CMDS_TO_RISC</span>
<span class="cp">#define RESPONSE_QUEUE_DEPTH		64</span>
<span class="cp">#define QUEUE_SIZE			64</span>
<span class="cp">#define DMA_BUFFER_SIZE			512</span>

<span class="cm">/*</span>
<span class="cm"> * Misc</span>
<span class="cm"> */</span>
<span class="cp">#define MAC_ADDR_LEN			6	</span><span class="cm">/* in bytes */</span><span class="cp"></span>
<span class="cp">#define IP_ADDR_LEN			4	</span><span class="cm">/* in bytes */</span><span class="cp"></span>
<span class="cp">#define IPv6_ADDR_LEN			16	</span><span class="cm">/* IPv6 address size */</span><span class="cp"></span>
<span class="cp">#define DRIVER_NAME			&quot;qla4xxx&quot;</span>

<span class="cp">#define MAX_LINKED_CMDS_PER_LUN		3</span>
<span class="cp">#define MAX_REQS_SERVICED_PER_INTR	1</span>

<span class="cp">#define ISCSI_IPADDR_SIZE		4	</span><span class="cm">/* IP address size */</span><span class="cp"></span>
<span class="cp">#define ISCSI_ALIAS_SIZE		32	</span><span class="cm">/* ISCSI Alias name size */</span><span class="cp"></span>
<span class="cp">#define ISCSI_NAME_SIZE			0xE0	</span><span class="cm">/* ISCSI Name size */</span><span class="cp"></span>

<span class="cp">#define QL4_SESS_RECOVERY_TMO		120	</span><span class="cm">/* iSCSI session */</span><span class="cp"></span>
						<span class="cm">/* recovery timeout */</span>

<span class="cp">#define LSDW(x) ((u32)((u64)(x)))</span>
<span class="cp">#define MSDW(x) ((u32)((((u64)(x)) &gt;&gt; 16) &gt;&gt; 16))</span>

<span class="cm">/*</span>
<span class="cm"> * Retry &amp; Timeout Values</span>
<span class="cm"> */</span>
<span class="cp">#define MBOX_TOV			60</span>
<span class="cp">#define SOFT_RESET_TOV			30</span>
<span class="cp">#define RESET_INTR_TOV			3</span>
<span class="cp">#define SEMAPHORE_TOV			10</span>
<span class="cp">#define ADAPTER_INIT_TOV		30</span>
<span class="cp">#define ADAPTER_RESET_TOV		180</span>
<span class="cp">#define EXTEND_CMD_TOV			60</span>
<span class="cp">#define WAIT_CMD_TOV			30</span>
<span class="cp">#define EH_WAIT_CMD_TOV			120</span>
<span class="cp">#define FIRMWARE_UP_TOV			60</span>
<span class="cp">#define RESET_FIRMWARE_TOV		30</span>
<span class="cp">#define LOGOUT_TOV			10</span>
<span class="cp">#define IOCB_TOV_MARGIN			10</span>
<span class="cp">#define RELOGIN_TOV			18</span>
<span class="cp">#define ISNS_DEREG_TOV			5</span>
<span class="cp">#define HBA_ONLINE_TOV			30</span>
<span class="cp">#define DISABLE_ACB_TOV			30</span>
<span class="cp">#define IP_CONFIG_TOV			30</span>
<span class="cp">#define LOGIN_TOV			12</span>

<span class="cp">#define MAX_RESET_HA_RETRIES		2</span>
<span class="cp">#define FW_ALIVE_WAIT_TOV		3</span>

<span class="cp">#define CMD_SP(Cmnd)			((Cmnd)-&gt;SCp.ptr)</span>

<span class="cm">/*</span>
<span class="cm"> * SCSI Request Block structure	 (srb)	that is placed</span>
<span class="cm"> * on cmd-&gt;SCp location of every I/O	 [We have 22 bytes available]</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">srb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>	<span class="cm">/* (8)	 */</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>	<span class="cm">/* HA the SP is queued on */</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* (1) Status flags. */</span>

<span class="cp">#define SRB_DMA_VALID		BIT_3	</span><span class="cm">/* DMA Buffer mapped. */</span><span class="cp"></span>
<span class="cp">#define SRB_GOT_SENSE		BIT_4	</span><span class="cm">/* sense data received. */</span><span class="cp"></span>
	<span class="kt">uint8_t</span> <span class="n">state</span><span class="p">;</span>		<span class="cm">/* (1) Status flags. */</span>

<span class="cp">#define SRB_NO_QUEUE_STATE	 0	</span><span class="cm">/* Request is in between states */</span><span class="cp"></span>
<span class="cp">#define SRB_FREE_STATE		 1</span>
<span class="cp">#define SRB_ACTIVE_STATE	 3</span>
<span class="cp">#define SRB_ACTIVE_TIMEOUT_STATE 4</span>
<span class="cp">#define SRB_SUSPENDED_STATE	 7	</span><span class="cm">/* Request in suspended state */</span><span class="cp"></span>

	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>	<span class="cm">/* (4) SCSI command block */</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>	<span class="cm">/* (4) for unmap of single transfers */</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">srb_ref</span><span class="p">;</span>	<span class="cm">/* reference count for this srb */</span>
	<span class="kt">uint8_t</span> <span class="n">err_id</span><span class="p">;</span>		<span class="cm">/* error id */</span>
<span class="cp">#define SRB_ERR_PORT	   1	</span><span class="cm">/* Request failed because &quot;port down&quot; */</span><span class="cp"></span>
<span class="cp">#define SRB_ERR_LOOP	   2	</span><span class="cm">/* Request failed because &quot;loop down&quot; */</span><span class="cp"></span>
<span class="cp">#define SRB_ERR_DEVICE	   3	</span><span class="cm">/* Request failed because &quot;device error&quot; */</span><span class="cp"></span>
<span class="cp">#define SRB_ERR_OTHER	   4</span>

	<span class="kt">uint16_t</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iocb_tov</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iocb_cnt</span><span class="p">;</span>	<span class="cm">/* Number of used iocbs */</span>
	<span class="kt">uint16_t</span> <span class="n">cc_stat</span><span class="p">;</span>

	<span class="cm">/* Used for extended sense / status continuation */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">req_sense_ptr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">req_sense_len</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Mailbox request block structure */</span>
<span class="k">struct</span> <span class="n">mrb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mbox_cmd_iocb</span> <span class="o">*</span><span class="n">mbox</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iocb_cnt</span><span class="p">;</span>		<span class="cm">/* Number of used iocbs */</span>
	<span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Asynchronous Event Queue structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">aen</span> <span class="p">{</span>
        <span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_AEN_REG_COUNT</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql4_aen_log</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">aen</span> <span class="n">entry</span><span class="p">[</span><span class="n">MAX_AEN_ENTRIES</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Device Database (DDB) structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>

	<span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">;</span>	<span class="cm">/* DDB firmware index */</span>
	<span class="kt">uint32_t</span> <span class="n">fw_ddb_device_state</span><span class="p">;</span> <span class="cm">/* F/W Device State  -- see ql4_fw.h */</span>
	<span class="kt">uint16_t</span> <span class="n">ddb_type</span><span class="p">;</span>
<span class="cp">#define FLASH_DDB 0x01</span>

	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="n">fw_ddb_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">unblock_sess</span><span class="p">)(</span><span class="k">struct</span> <span class="n">iscsi_cls_session</span> <span class="o">*</span><span class="n">cls_session</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ddb_change</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Driver Re-login  */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>		  <span class="cm">/* DDB Flags */</span>
	<span class="kt">uint16_t</span> <span class="n">default_relogin_timeout</span><span class="p">;</span> <span class="cm">/*  Max time to wait for</span>
<span class="cm">					   *  relogin to complete */</span>
	<span class="n">atomic_t</span> <span class="n">retry_relogin_timer</span><span class="p">;</span>	  <span class="cm">/* Min Time between relogins</span>
<span class="cm">					   * (4000 only) */</span>
	<span class="n">atomic_t</span> <span class="n">relogin_timer</span><span class="p">;</span>		  <span class="cm">/* Max Time to wait for</span>
<span class="cm">					   * relogin to complete */</span>
	<span class="n">atomic_t</span> <span class="n">relogin_retry_count</span><span class="p">;</span>	  <span class="cm">/* Num of times relogin has been</span>
<span class="cm">					   * retried */</span>
	<span class="kt">uint32_t</span> <span class="n">default_time2wait</span><span class="p">;</span>	  <span class="cm">/* Default Min time between</span>
<span class="cm">					   * relogins (+aens) */</span>
	<span class="kt">uint16_t</span> <span class="n">chap_tbl_idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qla_ddb_index</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">fw_ddb_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="n">fw_ddb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DDB_IPADDR_LEN 64</span>

<span class="k">struct</span> <span class="n">ql4_tuple_ddb</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tpgt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ip_addr</span><span class="p">[</span><span class="n">DDB_IPADDR_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">iscsi_name</span><span class="p">[</span><span class="n">ISCSI_NAME_SIZE</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">options</span><span class="p">;</span>
<span class="cp">#define DDB_OPT_IPV6 0x0e0e</span>
<span class="cp">#define DDB_OPT_IPV4 0x0f0f</span>
	<span class="kt">uint8_t</span> <span class="n">isid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DDB states.</span>
<span class="cm"> */</span>
<span class="cp">#define DDB_STATE_DEAD		0	</span><span class="cm">/* We can no longer talk to</span>
<span class="cm">					 * this device */</span><span class="cp"></span>
<span class="cp">#define DDB_STATE_ONLINE	1	</span><span class="cm">/* Device ready to accept</span>
<span class="cm">					 * commands */</span><span class="cp"></span>
<span class="cp">#define DDB_STATE_MISSING	2	</span><span class="cm">/* Device logged off, trying</span>
<span class="cm">					 * to re-login */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * DDB flags.</span>
<span class="cm"> */</span>
<span class="cp">#define DF_RELOGIN		0	</span><span class="cm">/* Relogin to device */</span><span class="cp"></span>
<span class="cp">#define DF_ISNS_DISCOVERED	2	</span><span class="cm">/* Device was discovered via iSNS */</span><span class="cp"></span>
<span class="cp">#define DF_FO_MASKED		3</span>

<span class="k">enum</span> <span class="n">qla4_work_type</span> <span class="p">{</span>
	<span class="n">QLA4_EVENT_AEN</span><span class="p">,</span>
	<span class="n">QLA4_EVENT_PING_STATUS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qla4_work_evt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">qla4_work_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">enum</span> <span class="n">iscsi_host_event_code</span> <span class="n">code</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">aen</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">;</span>
			<span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">ping</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="p">{</span>
	<span class="cm">/* Offsets for flash/nvram access (set to ~0 if not used). */</span>
	<span class="kt">uint32_t</span> <span class="n">flash_conf_off</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flash_data_off</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">fdt_wrt_disable</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdt_erase_cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdt_block_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdt_unprotect_sec_cmd</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fdt_protect_sec_cmd</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">flt_region_flt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_region_fdt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_region_boot</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_region_bootload</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_region_fw</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">flt_iscsi_param</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_region_chap</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">flt_chap_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qla4_8xxx_legacy_intr_set</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">int_vec_bit</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tgt_status_reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tgt_mask_reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pci_int_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* MSI-X Support */</span>

<span class="cp">#define QLA_MSIX_DEFAULT	0x00</span>
<span class="cp">#define QLA_MSIX_RSP_Q		0x01</span>

<span class="cp">#define QLA_MSIX_ENTRIES	2</span>
<span class="cp">#define QLA_MIDX_DEFAULT	0</span>
<span class="cp">#define QLA_MIDX_RSP_Q		1</span>

<span class="k">struct</span> <span class="n">ql4_msix_entry</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">have_irq</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">msix_vector</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">msix_entry</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ISP Operations</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">isp_operations</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">iospace_config</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pci_config</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">disable_intrs</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">enable_intrs</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">start_firmware</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">intr_handler</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span> <span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">interrupt_service_routine</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reset_chip</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">reset_firmware</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">queue_iocb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">complete_iocb</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="p">(</span><span class="o">*</span><span class="n">rd_shdw_req_q_out</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="p">(</span><span class="o">*</span><span class="n">rd_shdw_rsp_q_in</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_sys_info</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql4_mdump_size_table</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size_cmask_02</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size_cmask_04</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size_cmask_08</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size_cmask_10</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size_cmask_FF</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">version</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*qla4xxx ipaddress configuration details */</span>
<span class="k">struct</span> <span class="n">ipaddress_config</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">ipv4_options</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tcp_options</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ipv4_vlan_tag</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipv4_addr_state</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ip_address</span><span class="p">[</span><span class="n">IP_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">subnet_mask</span><span class="p">[</span><span class="n">IP_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">gateway</span><span class="p">[</span><span class="n">IP_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">ipv6_options</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ipv6_addl_options</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipv6_link_local_state</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipv6_addr0_state</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipv6_addr1_state</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ipv6_default_router_state</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ipv6_vlan_tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">ipv6_link_local_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">ipv6_addr0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">ipv6_addr1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">ipv6_default_router_addr</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">eth_mtu_size</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ipv4_port</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ipv6_port</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define QL4_CHAP_MAX_NAME_LEN 256</span>
<span class="cp">#define QL4_CHAP_MAX_SECRET_LEN 100</span>
<span class="cp">#define LOCAL_CHAP	0</span>
<span class="cp">#define BIDI_CHAP	1</span>

<span class="k">struct</span> <span class="n">ql4_chap_format</span> <span class="p">{</span>
	<span class="n">u8</span>  <span class="n">intr_chap_name</span><span class="p">[</span><span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">intr_secret</span><span class="p">[</span><span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">target_chap_name</span><span class="p">[</span><span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">target_secret</span><span class="p">[</span><span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">intr_chap_name_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">intr_secret_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">target_chap_name_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">target_secret_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ip_address_format</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ip_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_address</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span>	<span class="n">ql4_conn_info</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">dest_port</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ip_address_format</span> <span class="n">dest_ipaddr</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ql4_chap_format</span> <span class="n">chap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">target_name</span><span class="p">[</span><span class="mi">224</span><span class="p">];</span>
	<span class="k">struct</span>	<span class="n">ql4_conn_info</span> <span class="n">conn_list</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql4_boot_tgt_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="n">boot_pri_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_boot_session_info</span> <span class="n">boot_sec_sess</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Linux Host Adapter structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="p">{</span>
	<span class="cm">/* Linux adapter configuration data */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#define AF_ONLINE			0 </span><span class="cm">/* 0x00000001 */</span><span class="cp"></span>
<span class="cp">#define AF_INIT_DONE			1 </span><span class="cm">/* 0x00000002 */</span><span class="cp"></span>
<span class="cp">#define AF_MBOX_COMMAND			2 </span><span class="cm">/* 0x00000004 */</span><span class="cp"></span>
<span class="cp">#define AF_MBOX_COMMAND_DONE		3 </span><span class="cm">/* 0x00000008 */</span><span class="cp"></span>
<span class="cp">#define AF_INTERRUPTS_ON		6 </span><span class="cm">/* 0x00000040 */</span><span class="cp"></span>
<span class="cp">#define AF_GET_CRASH_RECORD		7 </span><span class="cm">/* 0x00000080 */</span><span class="cp"></span>
<span class="cp">#define AF_LINK_UP			8 </span><span class="cm">/* 0x00000100 */</span><span class="cp"></span>
<span class="cp">#define AF_IRQ_ATTACHED			10 </span><span class="cm">/* 0x00000400 */</span><span class="cp"></span>
<span class="cp">#define AF_DISABLE_ACB_COMPLETE		11 </span><span class="cm">/* 0x00000800 */</span><span class="cp"></span>
<span class="cp">#define AF_HA_REMOVAL			12 </span><span class="cm">/* 0x00001000 */</span><span class="cp"></span>
<span class="cp">#define AF_INTx_ENABLED			15 </span><span class="cm">/* 0x00008000 */</span><span class="cp"></span>
<span class="cp">#define AF_MSI_ENABLED			16 </span><span class="cm">/* 0x00010000 */</span><span class="cp"></span>
<span class="cp">#define AF_MSIX_ENABLED			17 </span><span class="cm">/* 0x00020000 */</span><span class="cp"></span>
<span class="cp">#define AF_MBOX_COMMAND_NOPOLL		18 </span><span class="cm">/* 0x00040000 */</span><span class="cp"></span>
<span class="cp">#define AF_FW_RECOVERY			19 </span><span class="cm">/* 0x00080000 */</span><span class="cp"></span>
<span class="cp">#define AF_EEH_BUSY			20 </span><span class="cm">/* 0x00100000 */</span><span class="cp"></span>
<span class="cp">#define AF_PCI_CHANNEL_IO_PERM_FAILURE	21 </span><span class="cm">/* 0x00200000 */</span><span class="cp"></span>
<span class="cp">#define AF_BUILD_DDB_LIST		22 </span><span class="cm">/* 0x00400000 */</span><span class="cp"></span>
<span class="cp">#define AF_82XX_FW_DUMPED		24 </span><span class="cm">/* 0x01000000 */</span><span class="cp"></span>
<span class="cp">#define AF_82XX_RST_OWNER		25 </span><span class="cm">/* 0x02000000 */</span><span class="cp"></span>
<span class="cp">#define AF_82XX_DUMP_READING		26 </span><span class="cm">/* 0x04000000 */</span><span class="cp"></span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dpc_flags</span><span class="p">;</span>

<span class="cp">#define DPC_RESET_HA			1 </span><span class="cm">/* 0x00000002 */</span><span class="cp"></span>
<span class="cp">#define DPC_RETRY_RESET_HA		2 </span><span class="cm">/* 0x00000004 */</span><span class="cp"></span>
<span class="cp">#define DPC_RELOGIN_DEVICE		3 </span><span class="cm">/* 0x00000008 */</span><span class="cp"></span>
<span class="cp">#define DPC_RESET_HA_FW_CONTEXT		4 </span><span class="cm">/* 0x00000010 */</span><span class="cp"></span>
<span class="cp">#define DPC_RESET_HA_INTR		5 </span><span class="cm">/* 0x00000020 */</span><span class="cp"></span>
<span class="cp">#define DPC_ISNS_RESTART		7 </span><span class="cm">/* 0x00000080 */</span><span class="cp"></span>
<span class="cp">#define DPC_AEN				9 </span><span class="cm">/* 0x00000200 */</span><span class="cp"></span>
<span class="cp">#define DPC_GET_DHCP_IP_ADDR		15 </span><span class="cm">/* 0x00008000 */</span><span class="cp"></span>
<span class="cp">#define DPC_LINK_CHANGED		18 </span><span class="cm">/* 0x00040000 */</span><span class="cp"></span>
<span class="cp">#define DPC_RESET_ACTIVE		20 </span><span class="cm">/* 0x00040000 */</span><span class="cp"></span>
<span class="cp">#define DPC_HA_UNRECOVERABLE		21 </span><span class="cm">/* 0x00080000 ISP-82xx only*/</span><span class="cp"></span>
<span class="cp">#define DPC_HA_NEED_QUIESCENT		22 </span><span class="cm">/* 0x00100000 ISP-82xx only*/</span><span class="cp"></span>


	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span> <span class="cm">/* pointer to host data */</span>
	<span class="kt">uint32_t</span> <span class="n">tot_ddbs</span><span class="p">;</span>

	<span class="kt">uint16_t</span> <span class="n">iocb_cnt</span><span class="p">;</span>

	<span class="cm">/* SRB cache. */</span>
<span class="cp">#define SRB_MIN_REQ	128</span>
	<span class="n">mempool_t</span> <span class="o">*</span><span class="n">srb_mempool</span><span class="p">;</span>

	<span class="cm">/* pci information */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">isp_reg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span> <span class="cm">/* Base I/O address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pio_address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pio_length</span><span class="p">;</span>
<span class="cp">#define MIN_IOBASE_LEN		0x100</span>

	<span class="kt">uint16_t</span> <span class="n">req_q_count</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">host_no</span><span class="p">;</span>

	<span class="cm">/* NVRAM registers */</span>
	<span class="k">struct</span> <span class="n">eeprom_data</span> <span class="o">*</span><span class="n">nvram</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">hardware_lock</span> <span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">eeprom_cmd_data</span><span class="p">;</span>

	<span class="cm">/* Counters for general statistics */</span>
	<span class="kt">uint64_t</span> <span class="n">isr_count</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">adapter_error_count</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">device_error_count</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">total_io_count</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">total_mbytes_xferred</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">link_failure_count</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">invalid_crc_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bytes_xfered</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">spurious_int_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">aborted_io_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">io_timeout_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mailbox_timeout_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">seconds_since_last_intr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">seconds_since_last_heartbeat</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mac_index</span><span class="p">;</span>

	<span class="cm">/* Info Needed for Management App */</span>
	<span class="cm">/* --- From GetFwVersion --- */</span>
	<span class="kt">uint32_t</span> <span class="n">firmware_version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">patch_number</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">build_number</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">board_id</span><span class="p">;</span>

	<span class="cm">/* --- From Init_FW --- */</span>
	<span class="cm">/* init_cb_t *init_cb; */</span>
	<span class="kt">uint16_t</span> <span class="n">firmware_options</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">alias</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">heartbeat_interval</span><span class="p">;</span>

	<span class="cm">/* --- From FlashSysInfo --- */</span>
	<span class="kt">uint8_t</span> <span class="n">my_mac</span><span class="p">[</span><span class="n">MAC_ADDR_LEN</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">serial_number</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">uint16_t</span> <span class="n">port_num</span><span class="p">;</span>
	<span class="cm">/* --- From GetFwState --- */</span>
	<span class="kt">uint32_t</span> <span class="n">firmware_state</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addl_fw_state</span><span class="p">;</span>

	<span class="cm">/* Linux kernel thread */</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">dpc_thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">dpc_work</span><span class="p">;</span>

	<span class="cm">/* Linux timer thread */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timer_active</span><span class="p">;</span>

	<span class="cm">/* Recovery Timers */</span>
	<span class="n">atomic_t</span> <span class="n">check_relogin_timeouts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">retry_reset_ha_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">isp_reset_timer</span><span class="p">;</span>	<span class="cm">/* reset test timer */</span>
	<span class="kt">uint32_t</span> <span class="n">nic_reset_timer</span><span class="p">;</span>	<span class="cm">/* simulated nic reset test timer */</span>
	<span class="kt">int</span> <span class="n">eh_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">free_srb_q</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">free_srb_q_count</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">num_srbs_allocated</span><span class="p">;</span>

	<span class="cm">/* DMA Memory Block */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">queues</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">queues_dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">queues_len</span><span class="p">;</span>

<span class="cp">#define MEM_ALIGN_VALUE \</span>
<span class="cp">	    ((max(REQUEST_QUEUE_DEPTH, RESPONSE_QUEUE_DEPTH)) * \</span>
<span class="cp">	     sizeof(struct queue_entry))</span>
	<span class="cm">/* request and response queue variables */</span>
	<span class="n">dma_addr_t</span> <span class="n">request_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">request_ptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">response_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">response_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">response_ptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">shadow_regs_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">shadow_regs</span> <span class="o">*</span><span class="n">shadow_regs</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">request_in</span><span class="p">;</span>	<span class="cm">/* Current indexes. */</span>
	<span class="kt">uint16_t</span> <span class="n">request_out</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">response_in</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">response_out</span><span class="p">;</span>

	<span class="cm">/* aen queue variables */</span>
	<span class="kt">uint16_t</span> <span class="n">aen_q_count</span><span class="p">;</span>	<span class="cm">/* Number of available aen_q entries */</span>
	<span class="kt">uint16_t</span> <span class="n">aen_in</span><span class="p">;</span>	<span class="cm">/* Current indexes */</span>
	<span class="kt">uint16_t</span> <span class="n">aen_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aen</span> <span class="n">aen_q</span><span class="p">[</span><span class="n">MAX_AEN_ENTRIES</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">ql4_aen_log</span> <span class="n">aen_log</span><span class="p">;</span><span class="cm">/* tracks all aens */</span>

	<span class="cm">/* This mutex protects several threads to do mailbox commands</span>
<span class="cm">	 * concurrently.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">mutex</span>  <span class="n">mbox_sem</span><span class="p">;</span>

	<span class="cm">/* temporary mailbox status registers */</span>
	<span class="k">volatile</span> <span class="kt">uint8_t</span> <span class="n">mbox_status_count</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">mbox_status</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="cm">/* FW ddb index map */</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">fw_ddb_index_map</span><span class="p">[</span><span class="n">MAX_DDB_ENTRIES</span><span class="p">];</span>

	<span class="cm">/* Saved srb for status continuation entry processing */</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">status_srb</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="n">acb_version</span><span class="p">;</span>

	<span class="cm">/* qla82xx specific fields */</span>
	<span class="k">struct</span> <span class="n">device_reg_82xx</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">qla4_8xxx_reg</span><span class="p">;</span> <span class="cm">/* Base I/O address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nx_pcibase</span><span class="p">;</span>	<span class="cm">/* Base I/O address */</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">nx_db_rd_ptr</span><span class="p">;</span>		<span class="cm">/* Doorbell read pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nx_db_wr_ptr</span><span class="p">;</span>	<span class="cm">/* Door bell write pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first_page_group_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first_page_group_end</span><span class="p">;</span>

	<span class="kt">uint32_t</span> <span class="n">crb_win</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">curr_window</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ddr_mn_window</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mn_win_crb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ms_win_crb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qdr_sn_window</span><span class="p">;</span>
	<span class="n">rwlock_t</span> <span class="n">hw_lock</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">func_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_width</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">qla4_8xxx_legacy_intr_set</span> <span class="n">nx_legacy_intr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nx_crb_mask</span><span class="p">;</span>

	<span class="kt">uint8_t</span> <span class="n">revision_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_heartbeat_counter</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">isp_operations</span> <span class="o">*</span><span class="n">isp_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql82xx_hw_data</span> <span class="n">hw</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ql4_msix_entry</span> <span class="n">msix_entries</span><span class="p">[</span><span class="n">QLA_MSIX_ENTRIES</span><span class="p">];</span>

	<span class="kt">uint32_t</span> <span class="n">nx_dev_init_timeout</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">nx_reset_timeout</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fw_dump</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_dump_size</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_dump_capture_mask</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fw_dump_tmplt_hdr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_dump_tmplt_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">completion</span> <span class="n">mbx_intr_comp</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ipaddress_config</span> <span class="n">ip_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface_ipv4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface_ipv6_0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_iface</span> <span class="o">*</span><span class="n">iface_ipv6_1</span><span class="p">;</span>

	<span class="cm">/* --- From About Firmware --- */</span>
	<span class="kt">uint16_t</span> <span class="n">iscsi_major</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iscsi_minor</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bootload_major</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bootload_minor</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bootload_patch</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">bootload_build</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">def_timeout</span><span class="p">;</span> <span class="cm">/* Default login timeout */</span>

	<span class="kt">uint32_t</span> <span class="n">flash_state</span><span class="p">;</span>
<span class="cp">#define	QLFLASH_WAITING		0</span>
<span class="cp">#define	QLFLASH_READING		1</span>
<span class="cp">#define	QLFLASH_WRITING		2</span>
	<span class="k">struct</span> <span class="n">dma_pool</span> <span class="o">*</span><span class="n">chap_dma_pool</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">chap_list</span><span class="p">;</span> <span class="cm">/* CHAP table cache */</span>
	<span class="k">struct</span> <span class="n">mutex</span>  <span class="n">chap_sem</span><span class="p">;</span>

<span class="cp">#define CHAP_DMA_BLOCK_SIZE    512</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">task_wq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddb_idx_map</span><span class="p">[</span><span class="n">MAX_DDB_ENTRIES</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">];</span>
<span class="cp">#define SYSFS_FLAG_FW_SEL_BOOT 2</span>
	<span class="k">struct</span> <span class="n">iscsi_boot_kset</span> <span class="o">*</span><span class="n">boot_kset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_boot_tgt_info</span> <span class="n">boot_tgt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">phy_port_num</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">phy_port_cnt</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iscsi_pci_func_cnt</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">model_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">disable_acb_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_pool</span> <span class="o">*</span><span class="n">fw_ddb_dma_pool</span><span class="p">;</span>
<span class="cp">#define DDB_DMA_BLOCK_SIZE 512</span>
	<span class="kt">uint16_t</span> <span class="n">pri_ddb_idx</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">sec_ddb_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_reset</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">temperature</span><span class="p">;</span>

	<span class="cm">/* event work list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">work_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">work_lock</span><span class="p">;</span>

	<span class="cm">/* mbox iocb */</span>
<span class="cp">#define MAX_MRB		128</span>
	<span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">active_mrb_array</span><span class="p">[</span><span class="n">MAX_MRB</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mrb_index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">req_buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">req_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">req_len</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">resp_buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">resp_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">resp_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">passthru_status</span> <span class="n">sts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">task_work</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">dst_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qla_conn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla_endpoint</span> <span class="o">*</span><span class="n">qla_ep</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ipv4_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_options</span> <span class="o">&amp;</span> <span class="n">IPOPT_IPV4_PROTOCOL_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_ipv6_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_options</span> <span class="o">&amp;</span>
		<span class="n">IPV6_OPT_IPV6_PROTOCOL_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_qla4010</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4010</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_qla4022</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4022</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_qla4032</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP4032</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_qla40XX</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_qla4032</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_qla4022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_qla8022</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8022</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note: Currently AER/EEH is now supported only for 8022 cards</span>
<span class="cm"> * This function needs to be updated when AER/EEH is enabled</span>
<span class="cm"> * for other cards.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_aer_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_QLOGIC_ISP8022</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">adapter_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scsi_qla_host</span><span class="o">*</span> <span class="nf">to_qla_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span><span class="n">iscsi_host_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">nvram</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">nvram</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">nvram</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_ext_hw_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">ext_hw_conf</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">ext_hw_conf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_port_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">port_status</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">port_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_port_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">port_ctrl</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">port_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span><span class="o">*</span> <span class="nf">isp_port_error_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">port_err_status</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">port_err_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="nf">isp_gp_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4010</span><span class="p">.</span><span class="n">gp_out</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">isp4022</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">gp_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">eeprom_ext_hw_conf_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_data</span><span class="p">,</span> <span class="n">isp4010</span><span class="p">.</span><span class="n">ext_hw_conf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">:</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom_data</span><span class="p">,</span> <span class="n">isp4022</span><span class="p">.</span><span class="n">ext_hw_conf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">ql4xxx_sem_spinlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_bits</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ql4xxx_sem_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_bits</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ql4xxx_lock_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_spinlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_FLASH_SEM_MASK</span><span class="p">,</span>
					   <span class="n">QL4010_FLASH_SEM_BITS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_spinlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_FLASH_SEM_MASK</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">QL4022_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ql4xxx_unlock_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_FLASH_SEM_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_FLASH_SEM_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ql4xxx_lock_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_spinlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_NVRAM_SEM_MASK</span><span class="p">,</span>
					   <span class="n">QL4010_NVRAM_SEM_BITS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_spinlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_NVRAM_SEM_MASK</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">QL4022_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ql4xxx_unlock_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_NVRAM_SEM_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_NVRAM_SEM_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ql4xxx_lock_drvr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_lock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_DRVR_SEM_MASK</span><span class="p">,</span>
				       <span class="n">QL4010_DRVR_SEM_BITS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql4xxx_sem_lock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_DRVR_SEM_MASK</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">QL4022_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ql4xxx_unlock_drvr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla4010</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4010_DRVR_SEM_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql4xxx_sem_unlock</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">QL4022_DRVR_SEM_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ql4xxx_reset_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RETRY_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">DPC_HA_UNRECOVERABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

<span class="p">}</span>
<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="cm">/* Defines for qla4xxx_initialize_adapter() and qla4xxx_recover_adapter() */</span>

<span class="cp">#define INIT_ADAPTER    0</span>
<span class="cp">#define RESET_ADAPTER   1</span>

<span class="cp">#define PRESERVE_DDB_LIST	0</span>
<span class="cp">#define REBUILD_DDB_LIST	1</span>

<span class="cm">/* Defines for process_aen() */</span>
<span class="cp">#define PROCESS_ALL_AENS	 0</span>
<span class="cp">#define FLUSH_DDB_CHANGED_AENS	 1</span>

<span class="cm">/* Defines for udev events */</span>
<span class="cp">#define QL4_UEVENT_CODE_FW_DUMP		0</span>

<span class="cp">#endif	</span><span class="cm">/*_QLA4XXX_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
