<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_isr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_isr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ql4_def.h&quot;</span>
<span class="cp">#include &quot;ql4_glbl.h&quot;</span>
<span class="cp">#include &quot;ql4_dbg.h&quot;</span>
<span class="cp">#include &quot;ql4_inline.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_copy_sense - copy sense data	into cmd sense buffer</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @sts_entry: Pointer to status entry structure.</span>
<span class="cm"> * @srb: Pointer to srb structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_copy_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">status_entry</span> <span class="o">*</span><span class="n">sts_entry</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseDataByteCnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sense_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld:%d:%d:%d: %s:&quot;</span>
				  <span class="s">&quot; sense len 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				  <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Save total available sense length,</span>
<span class="cm">	 * not to exceed cmd&#39;s sense buffer size */</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_ptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span> <span class="o">=</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="cm">/* Copy sense from sts_entry pkt */</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">,</span> <span class="n">IOCB_MAX_SENSEDATA_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseData</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld:%d:%d:%d: %s: sense key = %x, &quot;</span>
		<span class="s">&quot;ASL= %02x, ASC/ASCQ = %02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseData</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		<span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseData</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
		<span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">senseData</span><span class="p">[</span><span class="mi">13</span><span class="p">]));</span>

	<span class="n">DEBUG5</span><span class="p">(</span><span class="n">qla4xxx_dump_buffer</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">));</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_GOT_SENSE</span><span class="p">;</span>

	<span class="cm">/* Update srb, in case a sts_cont pkt follows */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_ptr</span> <span class="o">+=</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span> <span class="o">-=</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_status_cont_entry - Process a Status Continuations entry.</span>
<span class="cm"> * @ha: SCSI driver HA context</span>
<span class="cm"> * @sts_cont: Entry pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Extended sense data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4xxx_status_cont_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">status_cont_entry</span> <span class="o">*</span><span class="n">sts_cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld: %s: Cmd already returned &quot;</span>
			<span class="s">&quot;back to OS srb=%p srb-&gt;state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy sense data. */</span>
	<span class="n">sense_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span><span class="p">,</span>
			  <span class="n">IOCB_MAX_EXT_SENSEDATA_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_ptr</span><span class="p">,</span> <span class="n">sts_cont</span><span class="o">-&gt;</span><span class="n">ext_sense_data</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">);</span>
	<span class="n">DEBUG5</span><span class="p">(</span><span class="n">qla4xxx_dump_buffer</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_ptr</span><span class="p">,</span> <span class="n">sense_len</span><span class="p">));</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_ptr</span> <span class="o">+=</span> <span class="n">sense_len</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span> <span class="o">-=</span> <span class="n">sense_len</span><span class="p">;</span>

	<span class="cm">/* Place command on done queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">req_sense_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">,</span> <span class="n">qla4xxx_srb_compl</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_status_entry - processes status IOCBs</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @sts_entry: Pointer to status entry structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_status_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">status_entry</span> <span class="o">*</span><span class="n">sts_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">scsi_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">residual</span><span class="p">;</span>

	<span class="n">srb</span> <span class="o">=</span> <span class="n">qla4xxx_del_from_active_array</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s invalid status entry: &quot;</span>
			   <span class="s">&quot;handle=0x%0x, srb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Command already returned back to &quot;</span>
			      <span class="s">&quot;OS pkt-&gt;handle=%d srb=%p srb-&gt;state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			      <span class="n">srb</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Command is NULL:&quot;</span>
		    <span class="s">&quot; already returned to OS (srb=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">ddb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">status_entry_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">residual</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">residualByteCnt</span><span class="p">);</span>

	<span class="cm">/* Translate ISP error to a Linux SCSI error. */</span>
	<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">scsiStatus</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCS_COMPLETE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiFlags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_RESIDUAL_OVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiFlags</span> <span class="o">&amp;</span><span class="n">ISCSI_FLAG_RESIDUAL_UNDER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_status</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">residual</span><span class="p">)</span> <span class="o">&lt;</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d:%d: %s: &quot;</span>
					<span class="s">&quot;Mid-layer Data underrun0, &quot;</span>
					<span class="s">&quot;xferlen = 0x%x, &quot;</span>
					<span class="s">&quot;residual = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">residual</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="n">SCSI_CHECK_CONDITION</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Copy Sense Data into sense buffer. */</span>
		<span class="n">qla4xxx_copy_sense</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sts_entry</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_INCOMPLETE</span>:
		<span class="cm">/* Always set the status to DID_ERROR, since</span>
<span class="cm">		 * all conditions result in that status anyway */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_RESET_OCCURRED</span>:
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d:%d: %s: Device RESET occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_ABORTED</span>:
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d:%d: %s: Abort occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_TIMEOUT</span>:
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld:%d:%d:%d: Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TRANSPORT_DISRUPTED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Mark device missing so that we won&#39;t continue to send</span>
<span class="cm">		 * I/O to this device.	We should get a ddb state change</span>
<span class="cm">		 * AEN soon.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">))</span>
			<span class="n">qla4xxx_mark_device_missing</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_DATA_UNDERRUN</span>:
	<span class="k">case</span> <span class="n">SCS_DATA_OVERRUN</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiFlags</span> <span class="o">&amp;</span> <span class="n">ISCSI_FLAG_RESIDUAL_OVER</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span> <span class="o">==</span> <span class="n">SCS_DATA_OVERRUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d:%d: %s: &quot;</span> <span class="s">&quot;Data overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">residual</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If there is scsi_status, it takes precedense over</span>
<span class="cm">		 * underflow condition.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">!=</span> <span class="n">SCSI_CHECK_CONDITION</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Copy Sense Data into sense buffer. */</span>
			<span class="n">qla4xxx_copy_sense</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sts_entry</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If RISC reports underrun and target does not</span>
<span class="cm">			 * report it then we must have a lost frame, so</span>
<span class="cm">			 * tell upper layer to retry it by reporting a</span>
<span class="cm">			 * bus busy.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiFlags</span> <span class="o">&amp;</span>
			     <span class="n">ISCSI_FLAG_RESIDUAL_UNDER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="n">residual</span><span class="p">)</span> <span class="o">&lt;</span>
				   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Handle mid-layer underflow???</span>
<span class="cm">				 *</span>
<span class="cm">				 * For kernels less than 2.4, the driver must</span>
<span class="cm">				 * return an error if an underflow is detected.</span>
<span class="cm">				 * For kernels equal-to and above 2.4, the</span>
<span class="cm">				 * mid-layer will appearantly handle the</span>
<span class="cm">				 * underflow by detecting the residual count --</span>
<span class="cm">				 * unfortunately, we do not see where this is</span>
<span class="cm">				 * actually being done.	 In the interim, we</span>
<span class="cm">				 * will return DID_ERROR.</span>
<span class="cm">				 */</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d:%d: %s: &quot;</span>
					<span class="s">&quot;Mid-layer Data underrun1, &quot;</span>
					<span class="s">&quot;xferlen = 0x%x, &quot;</span>
					<span class="s">&quot;residual = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">residual</span><span class="p">));</span>

				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_DEVICE_LOGGED_OUT</span>:
	<span class="k">case</span> <span class="n">SCS_DEVICE_UNAVAILABLE</span>:
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld:%d:%d:%d: SCS_DEVICE &quot;</span>
		    <span class="s">&quot;state: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Mark device missing so that we won&#39;t continue to</span>
<span class="cm">		 * send I/O to this device.  We should get a ddb</span>
<span class="cm">		 * state change AEN soon.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iscsi_is_session_online</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">))</span>
			<span class="n">qla4xxx_mark_device_missing</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_TRANSPORT_DISRUPTED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCS_QUEUE_FULL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * SCSI Mid-Layer handles device queue full</span>
<span class="cm">		 */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">scsiStatus</span><span class="p">;</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d: %s: QUEUE FULL detected &quot;</span>
			      <span class="s">&quot;compl=%02x, scsi=%02x, state=%02x, iFlags=%02x,&quot;</span>
			      <span class="s">&quot; iResp=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">,</span>
			      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">scsiStatus</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">state_flags</span><span class="p">,</span>
			      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiFlags</span><span class="p">,</span>
			      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">iscsiResponse</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">status_entry_exit:</span>

	<span class="cm">/* complete the request, if not waiting for status_continuation pkt */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cc_stat</span> <span class="o">=</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">status_srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">,</span> <span class="n">qla4xxx_srb_compl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_passthru_status_entry - processes passthru status IOCBs (0x3C)</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @sts_entry: Pointer to status entry structure.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_passthru_status_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">passthru_status</span> <span class="o">*</span><span class="n">sts_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="o">*</span><span class="n">task_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">itt_t</span> <span class="n">itt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_ddb_index</span><span class="p">;</span>

	<span class="n">itt</span> <span class="o">=</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">fw_ddb_index</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>

	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">qla4xxx_lookup_ddb_by_fw_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ddb_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Invalid target index = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cls_conn</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">;</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">task</span> <span class="o">=</span> <span class="n">iscsi_itt_to_task</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">itt</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Task is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task_data</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">sts</span><span class="p">,</span> <span class="n">sts_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">passthru_status</span><span class="p">));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">+=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">-=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">task_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">task_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="nf">qla4xxx_del_mrb_from_active_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
						     <span class="kt">uint32_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">mrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* validate handle and remove from active array */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">MAX_MRB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mrb</span><span class="p">;</span>

	<span class="n">mrb</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">active_mrb_array</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active_mrb_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mrb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mrb</span><span class="p">;</span>

	<span class="cm">/* update counters */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">+=</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">-=</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mrb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_mbox_status_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">mbox_status_iocb</span> <span class="o">*</span><span class="n">mbox_sts_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">mrb</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="n">mrb</span> <span class="o">=</span> <span class="n">qla4xxx_del_mrb_from_active_array</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mrb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: mrb[%d] is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox_cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBOX_CMD_PING</span>:
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: mbox_cmd = 0x%x, &quot;</span>
				  <span class="s">&quot;mbox_sts[0] = 0x%x, mbox_sts[6] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox_cmd</span><span class="p">,</span>
				  <span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">[</span><span class="mi">6</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MBOX_STS_COMMAND_COMPLETE</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ISCSI_PING_SUCCESS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">);</span>

		<span class="n">qla4xxx_post_ping_evt_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mbox_sts_entry</span><span class="o">-&gt;</span><span class="n">out_mbox</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: invalid mbox_cmd = &quot;</span>
				  <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mrb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_process_response_queue - process response queue completions</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine process response queue completions in interrupt context.</span>
<span class="cm"> * Hardware_lock locked upon entry</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_process_response_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">status_entry</span> <span class="o">*</span><span class="n">sts_entry</span><span class="p">;</span>

	<span class="cm">/* Process all responses from response queue */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ptr</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sts_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">status_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ptr</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Advance pointers for next entry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span> <span class="o">==</span> <span class="p">(</span><span class="n">RESPONSE_QUEUE_DEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ring</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* process entry */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ET_STATUS</span>:
			<span class="cm">/* Common status */</span>
			<span class="n">qla4xxx_status_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sts_entry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ET_PASSTHRU_STATUS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">systemDefined</span> <span class="o">==</span> <span class="n">SD_ISCSI_PDU</span><span class="p">)</span>
				<span class="n">qla4xxx_passthru_status_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">passthru_status</span> <span class="o">*</span><span class="p">)</span><span class="n">sts_entry</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					   <span class="s">&quot;%s: Invalid status received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ET_STATUS_CONTINUATION</span>:
			<span class="n">qla4xxx_status_cont_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">status_cont_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">sts_entry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ET_COMMAND</span>:
			<span class="cm">/* ISP device queue is full. Command not</span>
<span class="cm">			 * accepted by ISP.  Queue command for</span>
<span class="cm">			 * later */</span>

			<span class="n">srb</span> <span class="o">=</span> <span class="n">qla4xxx_del_from_active_array</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sts_entry</span><span class="o">-&gt;</span>
								<span class="n">handle</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">srb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_prq_invalid_handle</span><span class="p">;</span>

			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: FW device queue full, &quot;</span>
				      <span class="s">&quot;srb %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">srb</span><span class="p">));</span>

			<span class="cm">/* ETRY normally by sending it back with</span>
<span class="cm">			 * DID_BUS_BUSY */</span>
			<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BUS_BUSY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">srb_ref</span><span class="p">,</span> <span class="n">qla4xxx_srb_compl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ET_CONTINUE</span>:
			<span class="cm">/* Just throw away the continuation entries */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Continuation entry - &quot;</span>
				      <span class="s">&quot;ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ET_MBOX_STATUS</span>:
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					  <span class="s">&quot;%s: mbox status IOCB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="n">qla4xxx_mbox_status_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">mbox_status_iocb</span> <span class="o">*</span><span class="p">)</span><span class="n">sts_entry</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Invalid entry in response queue, reset RISC</span>
<span class="cm">			 * firmware.</span>
<span class="cm">			 */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Invalid entry %x in &quot;</span>
				      <span class="s">&quot;response queue </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				      <span class="n">__func__</span><span class="p">,</span>
				      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">exit_prq_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">response</span> <span class="o">*</span><span class="p">)</span><span class="n">sts_entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">signature</span> <span class="o">=</span> <span class="n">RESPONSE_PROCESSED</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell ISP we&#39;re done with response(s). This also clears the interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">complete_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">exit_prq_invalid_handle:</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Invalid handle(srb)=%p type=%x IOCS=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">srb</span><span class="p">,</span> <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span><span class="p">,</span>
		      <span class="n">sts_entry</span><span class="o">-&gt;</span><span class="n">completionStatus</span><span class="p">));</span>

<span class="nl">exit_prq_error:</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">complete_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_isr_decode_mailbox - decodes mailbox status</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @mailbox_status: Mailbox status.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine decodes the mailbox status during the ISR.</span>
<span class="cm"> * Hardware_lock locked upon entry. runs in interrupt context.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_isr_decode_mailbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span>
				       <span class="kt">uint32_t</span> <span class="n">mbox_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_AEN_REG_COUNT</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mbox_status</span> <span class="o">==</span> <span class="n">MBOX_STS_BUSY</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mbox_status</span> <span class="o">==</span> <span class="n">MBOX_STS_INTERMEDIATE_COMPLETION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">mbox_status</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">==</span> <span class="n">MBOX_COMPLETION_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbox_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Copy all mailbox registers to a temporary</span>
<span class="cm">			 * location and set mailbox command done flag</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span>
				    <span class="o">?</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				    <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_NOPOLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mbox_status</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">==</span> <span class="n">MBOX_ASYNC_EVENT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MBOX_AEN_REG_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span>
			    <span class="o">?</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			    <span class="o">:</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Immediately process the AENs that don&#39;t require much work.</span>
<span class="cm">		 * Only queue the database_changed AENs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_log</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_AEN_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MBOX_AEN_REG_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_log</span><span class="p">.</span><span class="n">entry</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_log</span><span class="p">.</span><span class="n">count</span><span class="p">].</span><span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_log</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MBOX_ASTS_SYSTEM_ERROR</span>:
			<span class="cm">/* Log Mailbox registers */</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: System Err</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">qla4xxx_dump_registers</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ql4xdontresethba</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s:Don&#39;t Reset HBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_GET_CRASH_RECORD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_REQUEST_TRANSFER_ERROR</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_RESPONSE_TRANSFER_ERROR</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_NVRAM_INVALID</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_IP_ADDRESS_CHANGED</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_DHCP_LEASE_EXPIRED</span>:
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN %04x, ERROR Status, &quot;</span>
				      <span class="s">&quot;Reset HA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_status</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_LINK_UP</span>:
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_LINK_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: LINK UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">qla4xxx_post_aen_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISCSI_EVENT_LINKUP</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">),</span>
					      <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mbox_sts</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_LINK_DOWN</span>:
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INIT_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_LINK_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: LINK DOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">qla4xxx_post_aen_work</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISCSI_EVENT_LINKDOWN</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">),</span>
					      <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mbox_sts</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_HEARTBEAT</span>:
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">seconds_since_last_heartbeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_DHCP_LEASE_ACQUIRED</span>:
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN %04x DHCP LEASE &quot;</span>
				      <span class="s">&quot;ACQUIRED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_status</span><span class="p">));</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_GET_DHCP_IP_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_PROTOCOL_STATISTIC_ALARM</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_SCSI_COMMAND_PDU_REJECTED</span>: <span class="cm">/* Target</span>
<span class="cm">							   * mode</span>
<span class="cm">							   * only */</span>
		<span class="k">case</span> <span class="n">MBOX_ASTS_UNSOLICITED_PDU_RECEIVED</span>:  <span class="cm">/* Connection mode */</span>
		<span class="k">case</span> <span class="n">MBOX_ASTS_IPSEC_SYSTEM_FATAL_ERROR</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_SUBNET_STATE_CHANGE</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_DUPLICATE_IP</span>:
			<span class="cm">/* No action */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				      <span class="n">mbox_status</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_IP_ADDR_STATE_CHANGED</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN %04x, mbox_sts[2]=%04x, &quot;</span>
			    <span class="s">&quot;mbox_sts[3]=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			    <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

			<span class="cm">/* mbox_sts[2] = Old ACB state</span>
<span class="cm">			 * mbox_sts[3] = new ACB state */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_TENTATIVE</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_ACQUIRING</span><span class="p">)))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_GET_DHCP_IP_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_ACQUIRING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				 <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_VALID</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_FW_CONTEXT</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">ACB_STATE_UNCONFIGURED</span><span class="p">))</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">disable_acb_comp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_MAC_ADDRESS_CHANGED</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_DNS</span>:
			<span class="cm">/* No action */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld: AEN %04x, &quot;</span>
				      <span class="s">&quot;mbox_sts[1]=%04x, mbox_sts[2]=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_SELF_TEST_FAILED</span>:
		<span class="k">case</span> <span class="n">MBOX_ASTS_LOGIN_FAILED</span>:
			<span class="cm">/* No action */</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN %04x, mbox_sts[1]=%04x, &quot;</span>
				      <span class="s">&quot;mbox_sts[2]=%04x, mbox_sts[3]=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_DATABASE_CHANGED</span>:
			<span class="cm">/* Queue AEN information and process it in the DPC</span>
<span class="cm">			 * routine */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_q_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* decrement available counter */</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_q_count</span><span class="o">--</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MBOX_AEN_REG_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_q</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span><span class="p">].</span><span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="cm">/* print debug message */</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN[%d] %04x queued &quot;</span>
					      <span class="s">&quot;mb1:0x%x mb2:0x%x mb3:0x%x &quot;</span>
					      <span class="s">&quot;mb4:0x%x mb5:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span><span class="p">,</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

				<span class="cm">/* advance pointer */</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span> <span class="o">==</span> <span class="n">MAX_AEN_ENTRIES</span><span class="p">)</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* The DPC routine will process the aen */</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_AEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: aen %04x, queue &quot;</span>
					      <span class="s">&quot;overflowed!  AEN LOST!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: DUMP AEN QUEUE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">));</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_AEN_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;AEN[%d] %04x %04x %04x &quot;</span>
						      <span class="s">&quot;%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
						      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_TXSCVR_INSERTED</span>:
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			    <span class="s">&quot;scsi%ld: AEN %04x Transceiver&quot;</span>
			    <span class="s">&quot; inserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MBOX_ASTS_TXSCVR_REMOVED</span>:
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			    <span class="s">&quot;scsi%ld: AEN %04x Transceiver&quot;</span>
			    <span class="s">&quot; removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				      <span class="s">&quot;scsi%ld: AEN %04x UNKNOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: Unknown mailbox status %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_status</span><span class="p">));</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbox_status</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_interrupt_service_routine - isr</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main interrupt service routine.</span>
<span class="cm"> * hardware_lock locked upon entry. runs in interrupt context.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4_8xxx_interrupt_service_routine</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Process response queue interrupt. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_IOCB_INT</span><span class="p">)</span>
		<span class="n">qla4xxx_process_response_queue</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Process mailbox/asynch event interrupt.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">HSRX_RISC_MB_INT</span><span class="p">)</span>
		<span class="n">qla4xxx_isr_decode_mailbox</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
		    <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="cm">/* clear the interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_interrupt_service_routine - isr</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main interrupt service routine.</span>
<span class="cm"> * hardware_lock locked upon entry. runs in interrupt context.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_interrupt_service_routine</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span>
				       <span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Process response queue interrupt. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">CSR_SCSI_COMPLETION_INTR</span><span class="p">)</span>
		<span class="n">qla4xxx_process_response_queue</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Process mailbox/asynch event	 interrupt.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">CSR_SCSI_PROCESSOR_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qla4xxx_isr_decode_mailbox</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
					   <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

		<span class="cm">/* Clear Mailbox Interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SCSI_PROCESSOR_INTR</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_spurious_interrupt - processes spurious interrupt</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> * @reqs_count: .</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4_8xxx_spurious_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
    <span class="kt">uint8_t</span> <span class="n">reqs_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqs_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Spurious Interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INTx_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span>
			    <span class="mh">0xfbff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">spurious_int_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_intr_handler - hardware interrupt handler.</span>
<span class="cm"> * @irq: Unused</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> **/</span>
<span class="n">irqreturn_t</span> <span class="nf">qla4xxx_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reqs_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			      <span class="s">&quot;qla4xxx: Interrupt with NULL host ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Repeatedly service interrupts up to a maximum of</span>
<span class="cm">	 * MAX_REQS_SERVICED_PER_INTR</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read interrupt status</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">rd_shdw_rsp_q_in</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span><span class="p">)</span>
			<span class="n">intr_status</span> <span class="o">=</span> <span class="n">CSR_SCSI_COMPLETION_INTR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">intr_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intr_status</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">CSR_SCSI_RESET_INTR</span><span class="o">|</span><span class="n">CSR_FATAL_ERROR</span><span class="o">|</span><span class="n">INTR_PENDING</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reqs_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">spurious_int_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">CSR_FATAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;scsi%ld: Fatal Error, &quot;</span>
				      <span class="s">&quot;Status 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				      <span class="n">readl</span><span class="p">(</span><span class="n">isp_port_error_status</span> <span class="p">(</span><span class="n">ha</span><span class="p">))));</span>

			<span class="cm">/* Issue Soft Reset to clear this error condition.</span>
<span class="cm">			 * This will prevent the RISC from repeatedly</span>
<span class="cm">			 * interrupting the driver; thus, allowing the DPC to</span>
<span class="cm">			 * get scheduled to continue error recovery.</span>
<span class="cm">			 * NOTE: Disabling RISC interrupts does not work in</span>
<span class="cm">			 * this case, as CSR_FATAL_ERROR overrides</span>
<span class="cm">			 * CSR_SCSI_INTR_ENABLE */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">CSR_SCSI_RESET_INTR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SOFT_RESET</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_FATAL_ERROR</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

			<span class="n">__qla4xxx_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">CSR_SCSI_RESET_INTR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">__qla4xxx_disable_intrs</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_SCSI_RESET_INTR</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_HA_REMOVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA_INTR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">INTR_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">interrupt_service_routine</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">total_io_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">reqs_count</span> <span class="o">==</span> <span class="n">MAX_REQS_SERVICED_PER_INTR</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_intr_handler - hardware interrupt handler.</span>
<span class="cm"> * @irq: Unused</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> **/</span>
<span class="n">irqreturn_t</span> <span class="nf">qla4_8xxx_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reqs_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">int_vec_bit</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_STATE_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISR_IS_LEGACY_INTR_TRIGGERED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;%s legacy Int not triggered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear the interrupt */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_status_reg</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* read twice to ensure write is flushed */</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">ISRX_82XX_RISC_INT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_spurious_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reqs_count</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">intr_status</span> <span class="o">=</span>  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intr_status</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">HSRX_RISC_MB_INT</span> <span class="o">|</span> <span class="n">HSRX_RISC_IOCB_INT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">qla4_8xxx_spurious_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reqs_count</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">interrupt_service_routine</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="cm">/* Enable Interrupt */</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">reqs_count</span> <span class="o">==</span> <span class="n">MAX_REQS_SERVICED_PER_INTR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span>
<span class="nf">qla4_8xxx_msi_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ha</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		    <span class="s">&quot;qla4xxx: MSIX: Interrupt with NULL host ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* clear the interrupt */</span>
	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_status_reg</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* read twice to ensure write is flushed */</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>
	<span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">qla4_8xxx_default_intr_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_default_intr_handler - hardware interrupt handler.</span>
<span class="cm"> * @irq: Unused</span>
<span class="cm"> * @dev_id: Pointer to host adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> * This interrupt handler is called directly for MSI-X, and</span>
<span class="cm"> * called indirectly for MSI.</span>
<span class="cm"> **/</span>
<span class="n">irqreturn_t</span>
<span class="nf">qla4_8xxx_default_intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reqs_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">ISRX_82XX_RISC_INT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_spurious_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reqs_count</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">intr_status</span> <span class="o">=</span>  <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intr_status</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">HSRX_RISC_MB_INT</span> <span class="o">|</span> <span class="n">HSRX_RISC_IOCB_INT</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qla4_8xxx_spurious_interrupt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">reqs_count</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">interrupt_service_routine</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">reqs_count</span> <span class="o">==</span> <span class="n">MAX_REQS_SERVICED_PER_INTR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span>
<span class="nf">qla4_8xxx_msix_rsp_q</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qla4xxx_process_response_queue</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_process_aen - processes AENs generated by firmware</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> * @process_aen: type of AENs to process</span>
<span class="cm"> *</span>
<span class="cm"> * Processes specific types of Asynchronous Events generated by firmware.</span>
<span class="cm"> * The type of AENs to process is specified by process_aen and can be</span>
<span class="cm"> *	PROCESS_ALL_AENS	 0</span>
<span class="cm"> *	FLUSH_DDB_CHANGED_AENS	 1</span>
<span class="cm"> *	RELOGIN_DDB_CHANGED_AENS 2</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_process_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">process_aen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_AEN_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">aen</span> <span class="o">*</span><span class="n">aen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span> <span class="o">!=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aen</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_q</span><span class="p">[</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span><span class="p">];</span>
		<span class="cm">/* copy aen information to local structure */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MBOX_AEN_REG_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aen</span><span class="o">-&gt;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_q_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span> <span class="o">==</span> <span class="n">MAX_AEN_ENTRIES</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;qla4xxx(%ld): AEN[%d]=0x%08x, mbx1=0x%08x mbx2=0x%08x&quot;</span>
			<span class="s">&quot; mbx3=0x%08x mbx4=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span> <span class="o">?</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="p">(</span><span class="n">MAX_AEN_ENTRIES</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
			<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MBOX_ASTS_DATABASE_CHANGED</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">process_aen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FLUSH_DDB_CHANGED_AENS</span>:
				<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: AEN[%d] %04x, index &quot;</span>
					      <span class="s">&quot;[%d] state=%04x FLUSHED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">aen_out</span><span class="p">,</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PROCESS_ALL_AENS</span>:
			<span class="nl">default:</span>
				<span class="cm">/* Specific device. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">qla4xxx_process_ddb_changed</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
						<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_request_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">try_intx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xenablemsix</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_msi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xenablemsix</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ql4xenablemsix</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_intx</span><span class="p">;</span>

	<span class="cm">/* Trying MSI-X */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qla4_8xxx_enable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;MSI-X: Enabled (0x%X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">revision_id</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">irq_attached</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;MSI-X: Falling back-to MSI mode -- %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">try_msi:</span>
	<span class="cm">/* Trying MSI */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qla4_8xxx_msi_handler</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;MSI: Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">irq_attached</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;MSI: Failed to reserve interrupt %d &quot;</span>
			    <span class="s">&quot;already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
	    <span class="s">&quot;MSI: Falling back-to INTx mode -- %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">try_intx:</span>
	<span class="cm">/* Trying INTx */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">intr_handler</span><span class="p">,</span>
	    <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;INTx: Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_INTx_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">irq_attached</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
		    <span class="s">&quot;INTx: Failed to reserve interrupt %d already in&quot;</span>
		    <span class="s">&quot; use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">irq_attached:</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_IRQ_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: irq %d attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_free_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">qla4_8xxx_disable_msix</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AF_INTx_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ha</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
