<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_iocb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_iocb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ql4_def.h&quot;</span>
<span class="cp">#include &quot;ql4_glbl.h&quot;</span>
<span class="cp">#include &quot;ql4_dbg.h&quot;</span>
<span class="cp">#include &quot;ql4_inline.h&quot;</span>

<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qla4xxx_space_in_req_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">req_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* Calculate number of free request entries. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">rd_shdw_req_q_out</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">-</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">=</span> <span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">-</span>
						<span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check if room for request in request ring. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_advance_req_ring_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Advance request queue pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span> <span class="o">==</span> <span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ring</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_req_pkt - returns a valid entry in request queue.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @queue_entry: Pointer to pointer to queue entry structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs the following tasks:</span>
<span class="cm"> *	- returns the current request_in pointer (if queue not full)</span>
<span class="cm"> *	- advances the request_in pointer</span>
<span class="cm"> *	- checks for queue full</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_req_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">**</span><span class="n">queue_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_space_in_req_ring</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">queue_entry</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="n">queue_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">**</span><span class="n">queue_entry</span><span class="p">));</span>

		<span class="n">qla4xxx_advance_req_ring_ptr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_send_marker_iocb - issues marker iocb to HBA</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @ddb_entry: Pointer to device database entry</span>
<span class="cm"> * @lun: SCSI LUN</span>
<span class="cm"> * @marker_type: marker identifier</span>
<span class="cm"> *</span>
<span class="cm"> * This routine issues a marker IOCB.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_send_marker_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">mrkr_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qla4_marker_entry</span> <span class="o">*</span><span class="n">marker_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Acquire hardware specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Get pointer to the queue entry for the marker */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_req_pkt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">marker_entry</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_send_marker</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Put the marker in the request queue */</span>
	<span class="n">marker_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span> <span class="o">=</span> <span class="n">ET_MARKER</span><span class="p">;</span>
	<span class="n">marker_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">marker_entry</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
	<span class="n">marker_entry</span><span class="o">-&gt;</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mrkr_mod</span><span class="p">);</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">marker_entry</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Tell ISP it&#39;s got a new I/O request */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">queue_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

<span class="nl">exit_send_marker:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">continuation_t1_entry</span> <span class="o">*</span>
<span class="nf">qla4xxx_alloc_cont_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">continuation_t1_entry</span> <span class="o">*</span><span class="n">cont_entry</span><span class="p">;</span>

	<span class="n">cont_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">continuation_t1_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span><span class="p">;</span>

	<span class="n">qla4xxx_advance_req_ring_ptr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Load packet defaults */</span>
	<span class="n">cont_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span> <span class="o">=</span> <span class="n">ET_CONTINUE</span><span class="p">;</span>
	<span class="n">cont_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cont_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">systemDefined</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cont_entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">qla4xxx_calc_request_entries</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">iocbs</span><span class="p">;</span>

	<span class="n">iocbs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">&gt;</span> <span class="n">COMMAND_SEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iocbs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dsds</span> <span class="o">-</span> <span class="n">COMMAND_SEG</span><span class="p">)</span> <span class="o">/</span> <span class="n">CONTINUE_SEG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dsds</span> <span class="o">-</span> <span class="n">COMMAND_SEG</span><span class="p">)</span> <span class="o">%</span> <span class="n">CONTINUE_SEG</span><span class="p">)</span>
			<span class="n">iocbs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">iocbs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qla4xxx_build_scsi_iocbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">command_t3_entry</span> <span class="o">*</span><span class="n">cmd_entry</span><span class="p">,</span>
				     <span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">avail_dsds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_seg_a64</span> <span class="o">*</span><span class="n">cur_dsd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">ha</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No data being transferred */</span>
		<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">ttlByteCnt</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">avail_dsds</span> <span class="o">=</span> <span class="n">COMMAND_SEG</span><span class="p">;</span>
	<span class="n">cur_dsd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">data_seg_a64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">scsi_for_each_sg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">sle_dma</span><span class="p">;</span>

		<span class="cm">/* Allocate additional continuation packets? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avail_dsds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">continuation_t1_entry</span> <span class="o">*</span><span class="n">cont_entry</span><span class="p">;</span>

			<span class="n">cont_entry</span> <span class="o">=</span> <span class="n">qla4xxx_alloc_cont_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
			<span class="n">cur_dsd</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">data_seg_a64</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">&amp;</span><span class="n">cont_entry</span><span class="o">-&gt;</span><span class="n">dataseg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">avail_dsds</span> <span class="o">=</span> <span class="n">CONTINUE_SEG</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sle_dma</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">cur_dsd</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="n">cur_dsd</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">sle_dma</span><span class="p">));</span>
		<span class="n">cur_dsd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">avail_dsds</span><span class="o">--</span><span class="p">;</span>

		<span class="n">cur_dsd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_queue_iocb - Tell ISP it&#39;s got new request(s)</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine notifies the ISP that one or more new request</span>
<span class="cm"> * queue entries have been placed on the request queue.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4_8xxx_queue_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dbval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbval</span> <span class="o">=</span> <span class="mh">0x14</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">func_num</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">dbval</span> <span class="o">=</span> <span class="n">dbval</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_db_wr_ptr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4_8xxx_complete_iocb - Tell ISP we&#39;re done with response(s)</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine notifies the ISP that one or more response/completion</span>
<span class="cm"> * queue entries have been processed by the driver.</span>
<span class="cm"> * This also clears the interrupt.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4_8xxx_complete_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_queue_iocb - Tell ISP it&#39;s got new request(s)</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is notifies the ISP that one or more new request</span>
<span class="cm"> * queue entries have been placed on the request queue.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_queue_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">req_q_in</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_complete_iocb - Tell ISP we&#39;re done with response(s)</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is notifies the ISP that one or more response/completion</span>
<span class="cm"> * queue entries have been processed by the driver.</span>
<span class="cm"> * This also clears the interrupt.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_complete_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">rsp_q_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_send_command_to_isp - issues command to HBA</span>
<span class="cm"> * @ha: pointer to host adapter structure.</span>
<span class="cm"> * @srb: pointer to SCSI Request Block to be sent to ISP</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by qla4xxx_queuecommand to build an ISP</span>
<span class="cm"> * command and pass it to the ISP for execution.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_send_command_to_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span> <span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">command_t3_entry</span> <span class="o">*</span><span class="n">cmd_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nseg</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">tot_dsds</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Get real lun and adapter */</span>
	<span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">ddb</span><span class="p">;</span>

	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Acquire hardware specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if adapter is online before placing request on</span>
<span class="cm">	 * request queue.  If a reset occurs and a request is in the queue,</span>
<span class="cm">	 * the firmware will still attempt to process the request, retrieving</span>
<span class="cm">	 * garbage for pointers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Adapter OFFLINE! &quot;</span>
			      <span class="s">&quot;Do not issue command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the number of request entries needed. */</span>
	<span class="n">nseg</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>
	<span class="n">tot_dsds</span> <span class="o">=</span> <span class="n">nseg</span><span class="p">;</span>

	<span class="n">req_cnt</span> <span class="o">=</span> <span class="n">qla4xxx_calc_request_entries</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_space_in_req_ring</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">req_cnt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* total iocbs active */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">+</span> <span class="n">req_cnt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">REQUEST_QUEUE_DEPTH</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="cm">/* Build command packet */</span>
	<span class="n">cmd_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">command_t3_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmd_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">command_t3_entry</span><span class="p">));</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span> <span class="o">=</span> <span class="n">ET_COMMAND</span><span class="p">;</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">ttlByteCnt</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">dataSegCnt</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tot_dsds</span><span class="p">);</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryCount</span> <span class="o">=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="cm">/* Set data transfer direction control flags</span>
<span class="cm">	 * NOTE: Look at data_direction bits iff there is data to be</span>
<span class="cm">	 *	 transferred, as the data direction bit is sometimed filled</span>
<span class="cm">	 *	 in when there is no data to be transferred */</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">CF_NO_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
			<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">CF_WRITE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
			<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">CF_READ</span><span class="p">;</span>

		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">+=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFFF</span><span class="p">){</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">total_mbytes_xferred</span> <span class="o">+=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bytes_xfered</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set tagged queueing control flags */</span>
	<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CF_SIMPLE_TAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_populate_tag_msg</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MSG_HEAD_TAG</span>:
			<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CF_HEAD_TAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MSG_ORDERED_TAG</span>:
			<span class="n">cmd_entry</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">|=</span> <span class="n">CF_ORDERED_TAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">qla4xxx_advance_req_ring_ptr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">qla4xxx_build_scsi_iocbs</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">cmd_entry</span><span class="p">,</span> <span class="n">tot_dsds</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/* update counters */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SRB_ACTIVE_STATE</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SRB_DMA_VALID</span><span class="p">;</span>

	<span class="cm">/* Track IOCB used */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">+=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">=</span> <span class="n">req_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">-=</span> <span class="n">req_cnt</span><span class="p">;</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">queue_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">queuing_error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tot_dsds</span><span class="p">)</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_send_passthru0</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_task</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">passthru0</span> <span class="o">*</span><span class="n">passthru_iocb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_task_data</span> <span class="o">*</span><span class="n">task_data</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">ctrl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Put the IOCB on the request queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qla4xxx_space_in_req_ring</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">queuing_error</span><span class="p">;</span>

	<span class="n">passthru_iocb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">passthru0</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_ptr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">passthru_iocb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">passthru0</span><span class="p">));</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span> <span class="o">=</span> <span class="n">ET_PASSTHRU0</span><span class="p">;</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">systemDefined</span> <span class="o">=</span> <span class="n">SD_ISCSI_PDU</span><span class="p">;</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryCount</span> <span class="o">=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">itt</span><span class="p">;</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">);</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PT_DEFAULT_TIMEOUT</span><span class="p">);</span>

	<span class="cm">/* Setup the out &amp; in DSDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_buffer</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">),</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span><span class="p">);</span>
		<span class="n">ctrl_flags</span> <span class="o">|=</span> <span class="n">PT_FLAG_SEND_BUFFER</span><span class="p">;</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">out_dsd</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_dma</span><span class="p">));</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">out_dsd</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">req_dma</span><span class="p">));</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">out_dsd</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">data_count</span> <span class="o">+</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iscsi_hdr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">in_dsd</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">addrLow</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_dma</span><span class="p">));</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">in_dsd</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">addrHigh</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_dma</span><span class="p">));</span>
		<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">in_dsd</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">task_data</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctrl_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PT_FLAG_ISCSI_PDU</span> <span class="o">|</span> <span class="n">PT_FLAG_WAIT_4_RESPONSE</span><span class="p">);</span>
	<span class="n">passthru_iocb</span><span class="o">-&gt;</span><span class="n">control_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ctrl_flags</span><span class="p">);</span>

	<span class="cm">/* Update the request pointer */</span>
	<span class="n">qla4xxx_advance_req_ring_ptr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Track IOCB used */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">+=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">req_q_count</span> <span class="o">-=</span> <span class="n">task_data</span><span class="o">-&gt;</span><span class="n">iocb_req_cnt</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">queue_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">queuing_error:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="nf">qla4xxx_get_new_mrb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">mrb</span><span class="p">;</span>

	<span class="n">mrb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mrb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mrb</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mrb</span><span class="p">;</span>

	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">ha</span> <span class="o">=</span> <span class="n">ha</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mrb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_send_mbox_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">mrb</span><span class="p">,</span>
				  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">in_mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Acquire hardware specific lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Get pointer to the queue entry for the marker */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_req_pkt</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_mbox_iocb</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mrb_index</span><span class="p">;</span>
	<span class="cm">/* get valid mrb index*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MRB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_MRB</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">active_mrb_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mrb_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">active_mrb_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrb</span><span class="p">;</span>
	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryType</span> <span class="o">=</span> <span class="n">ET_MBOX_CMD</span><span class="p">;</span>
	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entryCount</span> <span class="o">=</span> <span class="n">mrb</span><span class="o">-&gt;</span><span class="n">iocb_cnt</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="o">-&gt;</span><span class="n">in_mbox</span><span class="p">,</span> <span class="n">in_mbox</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">mbox_cmd</span> <span class="o">=</span> <span class="n">in_mbox</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">queue_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
<span class="nl">exit_mbox_iocb:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_ping_iocb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">options</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">payload_size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">in_mbox</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mrb</span> <span class="o">*</span><span class="n">mrb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">in_mbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_mbox</span><span class="p">));</span>

	<span class="n">mrb</span> <span class="o">=</span> <span class="n">qla4xxx_get_new_mrb</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mrb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: fail to get new mrb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_ping</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">in_mbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_PING</span><span class="p">;</span>
	<span class="n">in_mbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_mbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ipaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_mbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ipaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_mbox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ipaddr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in_mbox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ipaddr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">in_mbox</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload_size</span><span class="p">;</span>

	<span class="n">mrb</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_send_mbox_iocb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mrb</span><span class="p">,</span> <span class="n">in_mbox</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_ping</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="nl">exit_ping:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mrb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
