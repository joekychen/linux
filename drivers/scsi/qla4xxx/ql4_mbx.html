<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › qla4xxx › ql4_mbx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ql4_mbx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic iSCSI HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla4xxx for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ql4_def.h&quot;</span>
<span class="cp">#include &quot;ql4_glbl.h&quot;</span>
<span class="cp">#include &quot;ql4_dbg.h&quot;</span>
<span class="cp">#include &quot;ql4_inline.h&quot;</span>


<span class="cm">/**</span>
<span class="cm"> * qla4xxx_mailbox_command - issues mailbox commands</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @inCount: number of mailbox registers to load.</span>
<span class="cm"> * @outCount: number of mailbox registers to return.</span>
<span class="cm"> * @mbx_cmd: data pointer for mailbox in registers.</span>
<span class="cm"> * @mbx_sts: data pointer for mailbox out registers.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine issue mailbox commands and waits for completion.</span>
<span class="cm"> * If outCount is 0, this routine completes successfully WITHOUT waiting</span>
<span class="cm"> * for the mailbox command to complete.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_mailbox_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">inCount</span><span class="p">,</span>
			    <span class="kt">uint8_t</span> <span class="n">outCount</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_cmd</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">wait_count</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">intr_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_state</span><span class="p">;</span>

	<span class="cm">/* Make sure that pointers are valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mbx_cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbx_sts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Invalid mbx_cmd or mbx_sts &quot;</span>
			      <span class="s">&quot;pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_HA_REMOVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: &quot;</span>
					  <span class="s">&quot;prematurely completing mbx cmd as &quot;</span>
					  <span class="s">&quot;adapter removal detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">is_aer_supported</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_PCI_CHANNEL_IO_PERM_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%ld: %s: Perm failure on EEH, &quot;</span>
		    <span class="s">&quot;timeout MBX Exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mailbox code active */</span>
	<span class="n">wait_count</span> <span class="o">=</span> <span class="n">MBOX_TOV</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wait_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: mbox_sem failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
					  <span class="s">&quot;scsi%ld: %s: prematurely completing mbx cmd as firmware recovery detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">mbox_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Do not send any mbx cmd if h/w is in failed state*/</span>
		<span class="n">qla4_8xxx_idc_lock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">qla4_8xxx_rd_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_DEV_STATE</span><span class="p">);</span>
		<span class="n">qla4_8xxx_idc_unlock</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLA82XX_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;scsi%ld: %s: H/W is in failed state, do not send any mailbox commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">mbox_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status_count</span> <span class="o">=</span> <span class="n">outCount</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Load all mailbox registers, except mailbox 0. */</span>
		<span class="n">DEBUG5</span><span class="p">(</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Cmd &quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mb%d=%04x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mbx_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mbx_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mbx_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">mailbox_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">HINT_MBX_INT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">hint</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Load all mailbox registers, except mailbox 0. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">mbx_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* Wakeup firmware  */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mbx_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">set_rmask</span><span class="p">(</span><span class="n">CSR_INTR_RISC</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Wait for completion */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t want status, don&#39;t wait for the mailbox command to</span>
<span class="cm">	 * complete.  For example, MBOX_CMD_RESET_FW doesn&#39;t return status,</span>
<span class="cm">	 * you must poll the inbound Interrupt Mask for completion.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mbox_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for completion: Poll or completion queue</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_IRQ_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INTERRUPTS_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">AF_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_HA_REMOVAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do not poll for completion. Use completion queue */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_NOPOLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">,</span> <span class="n">MBOX_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_NOPOLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Poll for command to complete */</span>
		<span class="n">wait_count</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MBOX_TOV</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">wait_count</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Service the interrupt.</span>
<span class="cm">			 * The ISR will save the mailbox status registers</span>
<span class="cm">			 * to a temporary storage location in the adapter</span>
<span class="cm">			 * structure.</span>
<span class="cm">			 */</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">intr_status</span> <span class="o">=</span>
				    <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_int</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">ISRX_82XX_RISC_INT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status_count</span> <span class="o">=</span> <span class="n">outCount</span><span class="p">;</span>
					<span class="n">intr_status</span> <span class="o">=</span>
					 <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">qla4_8xxx_reg</span><span class="o">-&gt;</span><span class="n">host_status</span><span class="p">);</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">interrupt_service_routine</span><span class="p">(</span>
					    <span class="n">ha</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INTERRUPTS_ON</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="n">test_bit</span><span class="p">(</span><span class="n">AF_INTx_ENABLED</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
						<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span>
						<span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_legacy_intr</span><span class="p">.</span><span class="n">tgt_mask_reg</span><span class="p">,</span>
						<span class="mh">0xfbff</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">intr_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">ctrl_status</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">INTR_PENDING</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Service the interrupt.</span>
<span class="cm">					 * The ISR will save the mailbox status</span>
<span class="cm">					 * registers to a temporary storage</span>
<span class="cm">					 * location in the adapter structure.</span>
<span class="cm">					 */</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status_count</span> <span class="o">=</span> <span class="n">outCount</span><span class="p">;</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">isp_ops</span><span class="o">-&gt;</span><span class="n">interrupt_service_routine</span><span class="p">(</span>
					    <span class="n">ha</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check for mailbox timeout. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			    <span class="s">&quot;scsi%ld: %s: prematurely completing mbx cmd as &quot;</span>
			    <span class="s">&quot;firmware recovery detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">mbox_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: Mailbox Cmd 0x%08X timed out ...,&quot;</span>
			      <span class="s">&quot; Scheduling Adapter Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			      <span class="n">mbx_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_timeout_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mbx_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">DPC_RESET_HA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">dpc_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				   <span class="s">&quot;disabling pause transmit on port 0 &amp; 1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">QLA82XX_CRB_NIU</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">,</span>
					<span class="n">CRB_NIU_XG_PAUSE_CTL_P0</span> <span class="o">|</span>
					<span class="n">CRB_NIU_XG_PAUSE_CTL_P1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">mbox_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the mailbox out registers to the caller&#39;s mailbox in/out</span>
<span class="cm">	 * structure.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mbx_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Set return status and error flags (if applicable). */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_status</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MBOX_STS_COMMAND_COMPLETE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBOX_STS_INTERMEDIATE_COMPLETION</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MBOX_STS_BUSY</span>:
		<span class="n">DEBUG2</span><span class="p">(</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Cmd = %08X, ISP BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbx_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">mailbox_timeout_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: **** FAILED, cmd = %08X, &quot;</span>
			      <span class="s">&quot;sts = %08X ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			      <span class="n">mbx_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbx_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">mbox_exit:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbox_sem</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_minidump_template - Get the firmware template</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @phys_addr: dma address for template</span>
<span class="cm"> *</span>
<span class="cm"> * Obtain the minidump template from firmware during initialization</span>
<span class="cm"> * as it may not be available when minidump is desired.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_minidump_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				  <span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_MINIDUMP</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIDUMP_GET_TMPLT_SUBCOMMAND</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;scsi%ld: %s: Cmd = %08X, mbx[0] = 0x%04x, mbx[1] = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_req_template_size - Get minidump template size from firmware.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_req_template_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_MINIDUMP</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIDUMP_GET_SIZE_SUBCOMMAND</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: sts[0]=0x%04x, template  size=0x%04x, size_cm_02=0x%04x, size_cm_04=0x%04x, size_cm_08=0x%04x, size_cm_10=0x%04x, size_cm_FF=0x%04x, version=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">fw_dump_tmplt_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Error sts[0]=0x%04x, mbx[1]=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qla4xxx_mailbox_premature_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: set FW RECOVERY!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_NOPOLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">mbx_intr_comp</span><span class="p">);</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Due to fw &quot;</span>
			    <span class="s">&quot;recovery, doing premature completion of &quot;</span>
			    <span class="s">&quot;mbx cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AF_MBOX_COMMAND_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Due to fw &quot;</span>
			    <span class="s">&quot;recovery, doing premature completion of &quot;</span>
			    <span class="s">&quot;polling mbx cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">qla4xxx_set_ifcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_cmd</span><span class="p">,</span>
		 <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">qla4_8xxx_wr_32</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">nx_db_wr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_INITIALIZE_FIRMWARE</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">init_fw_cb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">init_fw_cb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IFCB_VER_MAX</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">IFCB_VER_MIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">mbox_cmd</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%ld: %s: &quot;</span>
			      <span class="s">&quot;MBOX_CMD_INITIALIZE_FIRMWARE&quot;</span>
			      <span class="s">&quot; failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span>
<span class="nf">qla4xxx_get_ifcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_cmd</span><span class="p">,</span>
		 <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_INIT_FW_CTRL_BLOCK</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">init_fw_cb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">init_fw_cb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">mbox_cmd</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%ld: %s: &quot;</span>
			      <span class="s">&quot;MBOX_CMD_GET_INIT_FW_CTRL_BLOCK&quot;</span>
			      <span class="s">&quot; failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qla4xxx_update_local_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">tcp_options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_tcp_opts</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_ip_opts</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_addr_state</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_addr_state</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">eth_mtu_size</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">eth_mtu_size</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">acb_version</span> <span class="o">==</span> <span class="n">ACB_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_opts</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addl_options</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addtl_opts</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Save IPv4 Address Info */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_addr</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ip_address</span><span class="p">),</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_addr</span><span class="p">)));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">subnet_mask</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_subnet</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">subnet_mask</span><span class="p">),</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_subnet</span><span class="p">)));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">gateway</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_gw_addr</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">gateway</span><span class="p">),</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_gw_addr</span><span class="p">)));</span>

	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv4_vlan_tag</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv4_vlan_tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ipv6_enabled</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Save IPv6 Address */</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_state</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_lnk_lcl_addr_state</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr0_state</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr0_state</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr1_state</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr1_state</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_default_router_state</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_state</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">.</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFE</span><span class="p">;</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">.</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">.</span><span class="n">in6_u</span><span class="p">.</span><span class="n">u6_addr8</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
		       <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_if_id</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_link_local_addr</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_if_id</span><span class="p">)));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr0</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr0</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr0</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr0</span><span class="p">)));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr1</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr1</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_addr1</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_addr1</span><span class="p">)));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_default_router_addr</span><span class="p">,</span>
		       <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_default_router_addr</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_dflt_rtr_addr</span><span class="p">)));</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_vlan_tag</span> <span class="o">=</span>
				<span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_vlan_tag</span><span class="p">);</span>
		<span class="n">ha</span><span class="o">-&gt;</span><span class="n">ip_config</span><span class="p">.</span><span class="n">ipv6_port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">ipv6_port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">uint8_t</span>
<span class="nf">qla4xxx_update_local_ifcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_cmd</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_sts</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">addr_ctrl_blk</span>  <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">,</span>
			  <span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mbox_cmd</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span>
	    <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			      <span class="s">&quot;scsi%ld: %s: Failed to get init_fw_ctrl_blk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">qla4xxx_dump_buffer</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">)));</span>

	<span class="cm">/* Save some info in adapter structure. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">acb_version</span> <span class="o">=</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">acb_version</span><span class="p">;</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">fw_options</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">heartbeat_interval</span> <span class="o">=</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">hb_interval</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span>
		<span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">name_string</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)));</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">def_timeout</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">def_timeout</span><span class="p">);</span>
	<span class="cm">/*memcpy(ha-&gt;alias, init_fw_cb-&gt;Alias,</span>
<span class="cm">	       min(sizeof(ha-&gt;alias), sizeof(init_fw_cb-&gt;Alias)));*/</span>

	<span class="n">qla4xxx_update_local_ip</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_initialize_fw_cb - initializes firmware control block.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_initialize_fw_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">init_fw_cb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">init_fw_cb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_fw_cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Unable to alloc init_cb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb_no_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">));</span>

	<span class="cm">/* Get Initialize Firmware Control Block. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
				  <span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize request and response queues. */</span>
	<span class="n">qla4xxx_init_rings</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>

	<span class="cm">/* Fill in the request and response queue information. */</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">rqq_consumer_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_out</span><span class="p">);</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">compq_producer_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_in</span><span class="p">);</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">rqq_len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">REQUEST_QUEUE_DEPTH</span><span class="p">);</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">compq_len</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">RESPONSE_QUEUE_DEPTH</span><span class="p">);</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">rqq_addr_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">));</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">rqq_addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">request_dma</span><span class="p">));</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">compq_addr_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">));</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">compq_addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">response_dma</span><span class="p">));</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">shdwreg_addr_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs_dma</span><span class="p">));</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">shdwreg_addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MSDW</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">shadow_regs_dma</span><span class="p">));</span>

	<span class="cm">/* Set up required options. */</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">fw_options</span> <span class="o">|=</span>
		<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">FWOPT_SESSION_MODE</span> <span class="o">|</span>
				       <span class="n">FWOPT_INITIATOR_MODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">fw_options</span> <span class="o">|=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">FWOPT_ENABLE_CRBDB</span><span class="p">);</span>

	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">fw_options</span> <span class="o">&amp;=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">FWOPT_TARGET_MODE</span><span class="p">);</span>

	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">add_fw_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">add_fw_options</span> <span class="o">|=</span>
			<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ADFWOPT_SERIALIZE_TASK_MGMT</span><span class="p">);</span>
	<span class="n">init_fw_cb</span><span class="o">-&gt;</span><span class="n">add_fw_options</span> <span class="o">|=</span>
			<span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">ADFWOPT_AUTOCONN_DISABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_set_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span>
		<span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			      <span class="s">&quot;scsi%ld: %s: Failed to set init_fw_ctrl_blk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_update_local_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Failed to update local ifcb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_init_fw_cb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_init_fw_cb:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
				<span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>
<span class="nl">exit_init_fw_cb_no_free:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_dhcp_ip_address - gets HBA ip address via DHCP</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_dhcp_ip_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">addr_ctrl_blk</span> <span class="o">*</span><span class="n">init_fw_cb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">init_fw_cb_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">init_fw_cb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">init_fw_cb_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_fw_cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Unable to alloc init_cb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get Initialize Firmware Control Block. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">init_fw_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_ifcb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_fw_cb_dma</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: Failed to get init_fw_ctrl_blk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
				  <span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save IP Address. */</span>
	<span class="n">qla4xxx_update_local_ip</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">init_fw_cb</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">),</span>
				<span class="n">init_fw_cb</span><span class="p">,</span> <span class="n">init_fw_cb_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_firmware_state - gets firmware state of HBA</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_firmware_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="cm">/* Get firmware version */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_FW_STATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: MBOX_CMD_GET_FW_STATE failed w/ &quot;</span>
			      <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_state</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">board_id</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addl_fw_state</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s firmware_state=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_state</span><span class="p">);)</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_firmware_status - retrieves firmware status</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_firmware_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="cm">/* Get firmware version */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_FW_STATUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: MBOX_CMD_GET_FW_STATUS failed w/ &quot;</span>
			      <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%ld firmware IOCBs available (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_fwddb_entry - retrieves firmware ddb entry</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @fw_ddb_index: Firmware&#39;s device database index</span>
<span class="cm"> * @fw_ddb_entry: Pointer to firmware&#39;s device database entry structure</span>
<span class="cm"> * @num_valid_ddb_entries: Pointer to number of valid ddb entries</span>
<span class="cm"> * @next_ddb_index: Pointer to next valid device database index</span>
<span class="cm"> * @fw_ddb_device_state: Pointer to device state</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_fwddb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">,</span>
			    <span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">num_valid_ddb_entries</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">next_ddb_index</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fw_ddb_device_state</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">conn_err_detail</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">tcp_source_port_num</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">connection_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">options</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="cm">/* Make sure the device index is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_index</span> <span class="o">&gt;=</span> <span class="n">MAX_DDB_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: ddb [%d] out of range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_index</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_get_fwddb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_DATABASE_ENTRY</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span>
	    <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: MBOX_CMD_GET_DATABASE_ENTRY failed&quot;</span>
			      <span class="s">&quot; with status 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">goto</span> <span class="n">exit_get_fwddb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_index</span> <span class="o">!=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: ddb mismatch [%d] != [%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
			      <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
		<span class="k">goto</span> <span class="n">exit_get_fwddb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">options</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: DDB[%d] MB0 %04x Tot %d &quot;</span>
				<span class="s">&quot;Next %d State %04x ConnErr %08x %pI6 &quot;</span>
				<span class="s">&quot;:%04d </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
				<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: DDB[%d] MB0 %04x Tot %d &quot;</span>
				<span class="s">&quot;Next %d State %04x ConnErr %08x %pI4 &quot;</span>
				<span class="s">&quot;:%04d </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
				<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">),</span>
				<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_valid_ddb_entries</span><span class="p">)</span>
		<span class="o">*</span><span class="n">num_valid_ddb_entries</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_ddb_index</span><span class="p">)</span>
		<span class="o">*</span><span class="n">next_ddb_index</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_device_state</span><span class="p">)</span>
		<span class="o">*</span><span class="n">fw_ddb_device_state</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * RA: This mailbox has been changed to pass connection error and</span>
<span class="cm">	 * details.  Its true for ISP4010 as per Version E - Not sure when it</span>
<span class="cm">	 * was changed.	 Get the time2wait from the fw_dd_entry field :</span>
<span class="cm">	 * default_time2wait which we call it as minTime2Wait DEV_DB_ENTRY</span>
<span class="cm">	 * struct.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn_err_detail</span><span class="p">)</span>
		<span class="o">*</span><span class="n">conn_err_detail</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp_source_port_num</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tcp_source_port_num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connection_id</span><span class="p">)</span>
		<span class="o">*</span><span class="n">connection_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_get_fwddb:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_conn_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_CONN_OPEN</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_ddb_index</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			  <span class="s">&quot;%s: status = %d mbx0 = 0x%x mbx1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_set_fwddb_entry - sets a ddb entry.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @fw_ddb_index: Firmware&#39;s device database index</span>
<span class="cm"> * @fw_ddb_entry_dma: dma address of ddb entry</span>
<span class="cm"> * @mbx_sts: mailbox 0 to be returned or NULL</span>
<span class="cm"> *</span>
<span class="cm"> * This routine initializes or updates the adapter&#39;s device database</span>
<span class="cm"> * entry for the specified device.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_set_ddb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
			  <span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Do not wait for completion. The firmware will send us an</span>
<span class="cm">	 * ASTS_DATABASE_CHANGED (0x8014) to notify us of the login status.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_SET_DATABASE_ENTRY</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dev_db_entry</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbx_sts</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mbx_sts</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: status=%d mbx0=0x%x mbx4=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]);)</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_session_logout_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_CONN_CLOSE_SESS_LOGOUT</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: MBOX_CMD_CONN_CLOSE_SESS_LOGOUT &quot;</span>
				  <span class="s">&quot;failed sts %04X %04X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_crash_record - retrieves crash record.</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine retrieves a crash record from the QLA4010 after an 8002h aen.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_get_crash_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">crash_record</span> <span class="o">*</span><span class="n">crash_record</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">crash_record_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">crash_record_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>

	<span class="cm">/* Get size of crash record. */</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_CRASH_RECORD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: ERROR: Unable to retrieve size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_get_crash_record</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crash_record_size</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crash_record_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: ERROR: Crash record size is 0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_get_crash_record</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc Memory for Crash Record. */</span>
	<span class="n">crash_record</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">crash_record_size</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">crash_record_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crash_record</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_crash_record</span><span class="p">;</span>

	<span class="cm">/* Get Crash Record. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_CRASH_RECORD</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">crash_record_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">crash_record_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">crash_record_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_crash_record</span><span class="p">;</span>

	<span class="cm">/* Dump Crash Record. */</span>

<span class="nl">exit_get_crash_record:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crash_record</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">crash_record_size</span><span class="p">,</span>
				  <span class="n">crash_record</span><span class="p">,</span> <span class="n">crash_record_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_conn_event_log - retrieves connection event log</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">qla4xxx_get_conn_event_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">conn_event_log_entry</span> <span class="o">*</span><span class="n">event_log</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">event_log_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">event_log_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">num_valid_entries</span><span class="p">;</span>
	<span class="kt">uint32_t</span>      <span class="n">oldest_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">max_event_log_entries</span><span class="p">;</span>
	<span class="kt">uint8_t</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>

	<span class="cm">/* Get size of crash record. */</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_CONN_EVENT_LOG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_event_log</span><span class="p">;</span>

	<span class="n">event_log_size</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_log_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_event_log</span><span class="p">;</span>

	<span class="cm">/* Alloc Memory for Crash Record. */</span>
	<span class="n">event_log</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">event_log_size</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">event_log_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_log</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_get_event_log</span><span class="p">;</span>

	<span class="cm">/* Get Crash Record. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_CONN_EVENT_LOG</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">event_log_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">event_log_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: ERROR: Unable to retrieve event &quot;</span>
			      <span class="s">&quot;log!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_get_event_log</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Dump Event Log. */</span>
	<span class="n">num_valid_entries</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">max_event_log_entries</span> <span class="o">=</span> <span class="n">event_log_size</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">conn_event_log_entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_valid_entries</span> <span class="o">&gt;</span> <span class="n">max_event_log_entries</span><span class="p">)</span>
		<span class="n">oldest_entry</span> <span class="o">=</span> <span class="n">num_valid_entries</span> <span class="o">%</span> <span class="n">max_event_log_entries</span><span class="p">;</span>

	<span class="n">DEBUG3</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: Connection Event Log Dump (%d entries):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">num_valid_entries</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql4xextended_error_logging</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldest_entry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Circular Buffer has not wrapped around */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_valid_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla4xxx_dump_buffer</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">event_log</span><span class="o">+</span>
						    <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">)),</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Circular Buffer has wrapped around -</span>
<span class="cm">			 * display accordingly*/</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">oldest_entry</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_event_log_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla4xxx_dump_buffer</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">event_log</span><span class="o">+</span>
						    <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">)),</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">oldest_entry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qla4xxx_dump_buffer</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">event_log</span><span class="o">+</span>
						    <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">)),</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event_log</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">exit_get_event_log:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_log</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">event_log_size</span><span class="p">,</span> <span class="n">event_log</span><span class="p">,</span>
				  <span class="n">event_log_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_abort_task - issues Abort Task</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @srb: Pointer to srb entry</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs a LUN RESET on the specified target/lun.</span>
<span class="cm"> * The caller must ensure that the ddb_entry and lun_entry pointers</span>
<span class="cm"> * are valid before calling this routine.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_abort_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srb</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send abort task command to ISP, so that the ISP will return</span>
<span class="cm">	 * request with ABORT status</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hardware_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Firmware already posted completion on response queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">MAX_SRBS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_ABORT_TASK</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">ddb</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="cm">/* Immediate Command Enable */</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	    <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_STS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;scsi%ld:%d:%d: abort task FAILED: &quot;</span>
		    <span class="s">&quot;mbx0=%04X, mb1=%04X, mb2=%04X, mb3=%04X, mb4=%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_reset_lun - issues LUN Reset</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @ddb_entry: Pointer to device database entry</span>
<span class="cm"> * @lun: lun number</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs a LUN RESET on the specified target/lun.</span>
<span class="cm"> * The caller must ensure that the ddb_entry and lun_entry pointers</span>
<span class="cm"> * are valid before calling this routine.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_reset_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span> <span class="n">ddb_entry</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d:%d: lun reset issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		      <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span> <span class="n">lun</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send lun reset command to ISP, so that the ISP will return all</span>
<span class="cm">	 * outstanding requests with RESET status</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_LUN_RESET</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Immediate Command Enable */</span>

	<span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_STS_COMMAND_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_STS_COMMAND_ERROR</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_reset_target - issues target Reset</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> * @db_entry: Pointer to device database entry</span>
<span class="cm"> * @un_entry: Pointer to lun entry structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine performs a TARGET RESET on the specified target.</span>
<span class="cm"> * The caller must ensure that the ddb_entry pointers</span>
<span class="cm"> * are valid before calling this routine.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_reset_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld:%d: target reset issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		      <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send target reset command to ISP, so that the ISP will return all</span>
<span class="cm">	 * outstanding requests with RESET status</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_TARGET_WARM_RESET</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* Immediate Command Enable */</span>

	<span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_STS_COMMAND_COMPLETE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MBOX_STS_COMMAND_ERROR</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span> <span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_READ_FLASH</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: MBOX_CMD_READ_FLASH, failed w/ &quot;</span>
		    <span class="s">&quot;status %04X %04X, offset %08x, len %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_about_firmware - gets FW, iscsi draft and boot loader version</span>
<span class="cm"> * @ha: Pointer to host adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Retrieves the FW version, iSCSI draft version &amp; bootloader version of HBA.</span>
<span class="cm"> * Mailboxes 2 &amp; 3 may hold an address for data. Make sure that we write 0 to</span>
<span class="cm"> * those mailboxes, if unused.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_about_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">about_fw_info</span> <span class="o">*</span><span class="n">about_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">about_fw_dma</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">about_fw</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">about_fw_info</span><span class="p">),</span>
				      <span class="o">&amp;</span><span class="n">about_fw_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">about_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: Unable to alloc memory &quot;</span>
				  <span class="s">&quot;for about_fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">about_fw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">about_fw_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_ABOUT_FW</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">about_fw_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">about_fw_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">about_fw_info</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MBOX_CMD_ABOUT_FW &quot;</span>
				  <span class="s">&quot;failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">goto</span> <span class="n">exit_about_fw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save version information. */</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">fw_major</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">fw_minor</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">patch_number</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">fw_patch</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">build_number</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">fw_build</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iscsi_major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">iscsi_major</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">iscsi_minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">iscsi_minor</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bootload_major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">bootload_major</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bootload_minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">bootload_minor</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bootload_patch</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">bootload_patch</span><span class="p">);</span>
	<span class="n">ha</span><span class="o">-&gt;</span><span class="n">bootload_build</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">about_fw</span><span class="o">-&gt;</span><span class="n">bootload_build</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_about_fw:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">about_fw_info</span><span class="p">),</span>
			  <span class="n">about_fw</span><span class="p">,</span> <span class="n">about_fw_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_get_default_ddb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">options</span><span class="p">,</span>
				   <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_DATABASE_ENTRY_DEFAULTS</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span>
	    <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;scsi%ld: %s: failed status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_req_ddb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ddb_index</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_REQUEST_DATABASE_ENTRY</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_index</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: failed status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">mbx_sts</span> <span class="o">=</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_clear_ddb_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ddb_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_CLEAR_DATABASE_ENTRY</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_index</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: failed status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_set_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_WRITE_FLASH</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MBOX_CMD_WRITE_FLASH &quot;</span>
				  <span class="s">&quot;failed w/ status %04X, mbx1 %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_bootdb_by_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">,</span>
			    <span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">ddb_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dev_db_start_offset</span> <span class="o">=</span> <span class="n">FLASH_OFFSET_DB_INFO</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dev_db_end_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">));</span>

	<span class="n">dev_db_start_offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ddb_index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">));</span>
	<span class="n">dev_db_end_offset</span> <span class="o">=</span> <span class="n">FLASH_OFFSET_DB_END</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_db_start_offset</span> <span class="o">&gt;</span> <span class="n">dev_db_end_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s:Invalid DDB index %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">ddb_index</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">exit_bootdb_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qla4xxx_get_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">dev_db_start_offset</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">))</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: Get Flash&quot;</span>
			   <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_bootdb_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">==</span> <span class="n">DDB_VALID_COOKIE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

<span class="nl">exit_bootdb_failed:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_chap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span>
		     <span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">chap_dma</span><span class="p">;</span>

	<span class="n">chap_table</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_get_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chap_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">chap_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla40XX</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_CHAP_OFFSET</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_RAW_ACCESS_ADDR</span> <span class="o">+</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_region_chap</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* flt_chap_size is CHAP table size for both ports</span>
<span class="cm">		 * so divide it by 2 to calculate the offset for second port</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">port_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chap_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_get_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Chap Cookie: x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHAP_VALID_COOKIE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;No valid chap entry found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_get_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span> <span class="n">QL4_CHAP_MAX_SECRET_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">QL4_CHAP_MAX_NAME_LEN</span><span class="p">);</span>
	<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CHAP_VALID_COOKIE</span><span class="p">);</span>

<span class="nl">exit_get_chap:</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">chap_table</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qla4xxx_set_chap</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">chap_dma</span><span class="p">;</span>

	<span class="n">chap_table</span> <span class="o">=</span> <span class="n">dma_pool_alloc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_set_chap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">chap_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bidi</span><span class="p">)</span>
		<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT_6</span><span class="p">;</span> <span class="cm">/* peer */</span>
	<span class="k">else</span>
		<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT_7</span><span class="p">;</span> <span class="cm">/* local */</span>
	<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">MAX_CHAP_SECRET_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">MAX_CHAP_NAME_LEN</span><span class="p">);</span>
	<span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CHAP_VALID_COOKIE</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">FLASH_CHAP_OFFSET</span> <span class="o">|</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_set_flash</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">),</span>
				<span class="n">FLASH_OPT_RMW_COMMIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="n">QLA_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update ha chap_list cache */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
		       <span class="n">chap_table</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dma_pool_free</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_dma_pool</span><span class="p">,</span> <span class="n">chap_table</span><span class="p">,</span> <span class="n">chap_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">exit_set_chap:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * qla4xxx_get_chap_index - Get chap index given username and secret</span>
<span class="cm"> * @ha: pointer to adapter structure</span>
<span class="cm"> * @username: CHAP username to be searched</span>
<span class="cm"> * @password: CHAP password to be searched</span>
<span class="cm"> * @bidi: Is this a BIDI CHAP</span>
<span class="cm"> * @chap_index: CHAP index to be returned</span>
<span class="cm"> *</span>
<span class="cm"> * Match the username and password in the chap_list, return the index if a</span>
<span class="cm"> * match is found. If a match is not found then add the entry in FLASH and</span>
<span class="cm"> * return the index at which entry is written in the FLASH.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">qla4xxx_get_chap_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bidi</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">chap_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_chap_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="n">chap_table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_qla8022</span><span class="p">(</span><span class="n">ha</span><span class="p">))</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">flt_chap_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">max_chap_entries</span> <span class="o">=</span> <span class="n">MAX_CHAP_ENTRIES_40XX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Do not have CHAP table cache</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">username</span> <span class="o">||</span> <span class="o">!</span><span class="n">password</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;Do not have username and psw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chap_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chap_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ql4_chap_table</span> <span class="o">*</span><span class="p">)</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_list</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span>
		    <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">CHAP_VALID_COOKIE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_RESRV_CHAP_IDX</span> <span class="o">&amp;&amp;</span> <span class="n">free_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">free_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bidi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
			     <span class="n">MAX_CHAP_SECRET_LEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">chap_table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span>
			     <span class="n">MAX_CHAP_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">chap_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">found_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If chap entry is not present and a free index is available then</span>
<span class="cm">	 * write the entry in flash</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_index</span> <span class="o">&amp;&amp;</span> <span class="n">free_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_set_chap</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
					<span class="n">free_index</span><span class="p">,</span> <span class="n">bidi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">chap_index</span> <span class="o">=</span> <span class="n">free_index</span><span class="p">;</span>
			<span class="n">found_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">chap_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">QLA_ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_conn_close_sess_logout</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				   <span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
				   <span class="kt">uint16_t</span> <span class="n">connection_id</span><span class="p">,</span>
				   <span class="kt">uint16_t</span> <span class="n">option</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_CONN_CLOSE_SESS_LOGOUT</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_id</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MBOX_CMD_CONN_CLOSE &quot;</span>
				  <span class="s">&quot;option %04x failed w/ status %04X %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_disable_acb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_DISABLE_ACB</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MBOX_CMD_DISABLE_ACB &quot;</span>
				  <span class="s">&quot;failed w/ status %04X %04X %04X&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_acb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">acb_dma</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="n">acb_type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_ACB</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">acb_type</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">acb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">acb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;%s: MBOX_CMD_GET_ACB &quot;</span>
				  <span class="s">&quot;failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_set_acb</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_cmd</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">acb_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_SET_ACB</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Primary ACB */</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">acb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">acb_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">addr_ctrl_blk</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>  <span class="s">&quot;%s: MBOX_CMD_SET_ACB &quot;</span>
				  <span class="s">&quot;failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_set_param_ddbentry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ddb_entry</span> <span class="o">*</span><span class="n">ddb_entry</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iscsi_cls_conn</span> <span class="o">*</span><span class="n">cls_conn</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">mbx_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_db_entry</span> <span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_conn</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qla_conn</span> <span class="o">*</span><span class="n">qla_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">fw_ddb_entry_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="n">addr6</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">iscsi_opts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">idx</span><span class="p">,</span> <span class="o">*</span><span class="n">ptid</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ddb_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: Unable to allocate dma buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">));</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_set_param_no_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">cls_conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">qla_conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">;</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">session</span><span class="p">;</span>
	<span class="n">dst_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla_conn</span><span class="o">-&gt;</span><span class="n">qla_ep</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span>
		<span class="n">options</span> <span class="o">|=</span> <span class="n">IPV6_DEFAULT_DDB_ENTRY</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_get_default_ddb</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">QLA_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_set_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="o">*</span><span class="n">ptid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">target_id</span><span class="p">);</span>

	<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;ISID [%02x%02x%02x%02x%02x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			  <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			  <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">isid</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">iscsi_opts</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_alias</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_alias</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">,</span>
		       <span class="n">min</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">targetname</span><span class="p">),</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_name</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">tgt_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">tgt_addr</span><span class="p">));</span>

	<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span>  <span class="n">DDB_OPT_TARGET</span> <span class="o">|</span> <span class="n">DDB_OPT_AUTO_SENDTGTS_DISABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">IP_ADDR_LEN</span><span class="p">);</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: Destination Address [%pI4]: index [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
				  <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dst_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr6</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="o">*</span><span class="p">)</span><span class="n">dst_addr</span><span class="p">;</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">IPv6_ADDR_LEN</span><span class="p">);</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">addr6</span><span class="o">-&gt;</span><span class="n">sin6_port</span><span class="p">));</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">DDB_OPT_IPV6_DEVICE</span><span class="p">;</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: Destination Address [%pI6]: index [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span>
				  <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
			   <span class="s">&quot;%s: Failed to get IP Address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_set_param</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CHAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iscsi_opts</span> <span class="o">|=</span> <span class="n">BIT_7</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_chap_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span>
						<span class="n">sess</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">,</span>
						<span class="n">LOCAL_CHAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_set_param</span><span class="p">;</span>

			<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">chap_tbl_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">username_in</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">password_in</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if BIDI CHAP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">username_in</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">password_in</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iscsi_opts</span> <span class="o">|=</span> <span class="n">BIT_4</span><span class="p">;</span>

			<span class="n">rval</span> <span class="o">=</span> <span class="n">qla4xxx_get_chap_index</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">username_in</span><span class="p">,</span>
						      <span class="n">sess</span><span class="o">-&gt;</span><span class="n">password_in</span><span class="p">,</span>
						      <span class="n">BIDI_CHAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_set_param</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">initial_r2t_en</span><span class="p">)</span>
		<span class="n">iscsi_opts</span> <span class="o">|=</span> <span class="n">BIT_10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">imm_data_en</span><span class="p">)</span>
		<span class="n">iscsi_opts</span> <span class="o">|=</span> <span class="n">BIT_11</span><span class="p">;</span>

	<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_options</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">iscsi_opts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_rcv_data_seg_len</span> <span class="o">=</span>
		  <span class="n">__constant_cpu_to_le16</span><span class="p">((</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">max_recv_dlength</span> <span class="o">/</span> <span class="n">BYTE_UNITS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_r2t</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_outsnd_r2t</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_r2t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">first_burst</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_first_burst_len</span> <span class="o">=</span>
		       <span class="n">__constant_cpu_to_le16</span><span class="p">((</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">first_burst</span> <span class="o">/</span> <span class="n">BYTE_UNITS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_burst</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_max_burst_len</span> <span class="o">=</span>
			<span class="n">__constant_cpu_to_le16</span><span class="p">((</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">max_burst</span> <span class="o">/</span> <span class="n">BYTE_UNITS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2wait</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2wait</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2retain</span><span class="p">)</span>
		<span class="n">fw_ddb_entry</span><span class="o">-&gt;</span><span class="n">iscsi_def_time2retain</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">time2retain</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_set_ddb_entry</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ddb_entry</span><span class="o">-&gt;</span><span class="n">fw_ddb_index</span><span class="p">,</span>
				       <span class="n">fw_ddb_entry_dma</span><span class="p">,</span> <span class="n">mbx_sts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="nl">exit_set_param:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_ddb_entry</span><span class="p">),</span>
			  <span class="n">fw_ddb_entry</span><span class="p">,</span> <span class="n">fw_ddb_entry_dma</span><span class="p">);</span>
<span class="nl">exit_set_param_no_free:</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_mgmt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">fw_ddb_index</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">stats_size</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">stats_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">MBOX_REG_COUNT</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_MANAGEMENT_DATA</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_ddb_index</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">stats_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_size</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>
				  <span class="s">&quot;%s: MBOX_CMD_GET_MANAGEMENT_DATA &quot;</span>
				  <span class="s">&quot;failed w/ status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_ip_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">acb_idx</span><span class="p">,</span>
			 <span class="kt">uint32_t</span> <span class="n">ip_idx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_IP_ADDR_STATE</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">acb_idx</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip_idx</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span>  <span class="s">&quot;%s: &quot;</span>
				  <span class="s">&quot;MBOX_CMD_GET_IP_ADDR_STATE failed w/ &quot;</span>
				  <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">mbox_sts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_get_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">nvram_dma</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_GET_NVRAM</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">nvram_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">nvram_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: failed &quot;</span>
				  <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_set_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">nvram_dma</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_SET_NVRAM</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LSDW</span><span class="p">(</span><span class="n">nvram_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSDW</span><span class="p">(</span><span class="n">nvram_dma</span><span class="p">);</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: failed &quot;</span>
				  <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qla4xxx_restore_factory_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_qla_host</span> <span class="o">*</span><span class="n">ha</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">region</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">field0</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">field1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">QLA_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_cmd</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">mbox_sts</span><span class="p">[</span><span class="n">MBOX_REG_COUNT</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_cmd</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mbox_sts</span><span class="p">));</span>

	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MBOX_CMD_RESTORE_FACTORY_DEFAULTS</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">field0</span><span class="p">;</span>
	<span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">field1</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">qla4xxx_mailbox_command</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">MBOX_REG_COUNT</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbox_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="o">&amp;</span><span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">QLA_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG2</span><span class="p">(</span><span class="n">ql4_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="s">&quot;scsi%ld: %s: failed &quot;</span>
				  <span class="s">&quot;status %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				  <span class="n">mbox_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
