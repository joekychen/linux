<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › scsi › arm › fas216.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fas216.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/acorn/scsi/fas216.h</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1997-2000 Russell King</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  FAS216 generic driver</span>
<span class="cm"> */</span>
<span class="cp">#ifndef FAS216_H</span>
<span class="cp">#define FAS216_H</span>

<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>

<span class="cp">#include &quot;queue.h&quot;</span>
<span class="cp">#include &quot;msgqueue.h&quot;</span>

<span class="cm">/* FAS register definitions */</span>

<span class="cm">/* transfer count low */</span>
<span class="cp">#define REG_CTCL		(0)</span>
<span class="cp">#define REG_STCL		(0)</span>

<span class="cm">/* transfer count medium */</span>
<span class="cp">#define REG_CTCM		(1)</span>
<span class="cp">#define REG_STCM		(1)</span>

<span class="cm">/* fifo data */</span>
<span class="cp">#define REG_FF			(2)</span>

<span class="cm">/* command */</span>
<span class="cp">#define REG_CMD			(3)</span>
<span class="cp">#define CMD_NOP			0x00</span>
<span class="cp">#define CMD_FLUSHFIFO		0x01</span>
<span class="cp">#define CMD_RESETCHIP		0x02</span>
<span class="cp">#define CMD_RESETSCSI		0x03</span>

<span class="cp">#define CMD_TRANSFERINFO	0x10</span>
<span class="cp">#define CMD_INITCMDCOMPLETE	0x11</span>
<span class="cp">#define CMD_MSGACCEPTED		0x12</span>
<span class="cp">#define CMD_PADBYTES		0x18</span>
<span class="cp">#define CMD_SETATN		0x1a</span>
<span class="cp">#define CMD_RSETATN		0x1b</span>

<span class="cp">#define CMD_SELECTWOATN		0x41</span>
<span class="cp">#define CMD_SELECTATN		0x42</span>
<span class="cp">#define CMD_SELECTATNSTOP	0x43</span>
<span class="cp">#define CMD_ENABLESEL		0x44</span>
<span class="cp">#define CMD_DISABLESEL		0x45</span>
<span class="cp">#define CMD_SELECTATN3		0x46</span>
<span class="cp">#define CMD_RESEL3		0x47</span>

<span class="cp">#define CMD_WITHDMA		0x80</span>

<span class="cm">/* status register (read) */</span>
<span class="cp">#define REG_STAT		(4)</span>
<span class="cp">#define STAT_IO			(1 &lt;&lt; 0)			</span><span class="cm">/* IO phase		*/</span><span class="cp"></span>
<span class="cp">#define STAT_CD			(1 &lt;&lt; 1)			</span><span class="cm">/* CD phase		*/</span><span class="cp"></span>
<span class="cp">#define STAT_MSG		(1 &lt;&lt; 2)			</span><span class="cm">/* MSG phase		*/</span><span class="cp"></span>
<span class="cp">#define STAT_TRANSFERDONE	(1 &lt;&lt; 3)			</span><span class="cm">/* Transfer completed	*/</span><span class="cp"></span>
<span class="cp">#define STAT_TRANSFERCNTZ	(1 &lt;&lt; 4)			</span><span class="cm">/* Transfer counter is zero */</span><span class="cp"></span>
<span class="cp">#define STAT_PARITYERROR	(1 &lt;&lt; 5)			</span><span class="cm">/* Parity error		*/</span><span class="cp"></span>
<span class="cp">#define STAT_REALBAD		(1 &lt;&lt; 6)			</span><span class="cm">/* Something bad	*/</span><span class="cp"></span>
<span class="cp">#define STAT_INT		(1 &lt;&lt; 7)			</span><span class="cm">/* Interrupt		*/</span><span class="cp"></span>

<span class="cp">#define STAT_BUSMASK		(STAT_MSG|STAT_CD|STAT_IO)</span>
<span class="cp">#define STAT_DATAOUT		(0)				</span><span class="cm">/* Data out		*/</span><span class="cp"></span>
<span class="cp">#define STAT_DATAIN		(STAT_IO)			</span><span class="cm">/* Data in		*/</span><span class="cp"></span>
<span class="cp">#define STAT_COMMAND		(STAT_CD)			</span><span class="cm">/* Command out		*/</span><span class="cp"></span>
<span class="cp">#define STAT_STATUS		(STAT_CD|STAT_IO)		</span><span class="cm">/* Status In		*/</span><span class="cp"></span>
<span class="cp">#define STAT_MESGOUT		(STAT_MSG|STAT_CD)		</span><span class="cm">/* Message out		*/</span><span class="cp"></span>
<span class="cp">#define STAT_MESGIN		(STAT_MSG|STAT_CD|STAT_IO)	</span><span class="cm">/* Message In		*/</span><span class="cp"></span>

<span class="cm">/* bus ID for select / reselect */</span>
<span class="cp">#define REG_SDID		(4)</span>
<span class="cp">#define BUSID(target)		((target) &amp; 7)</span>

<span class="cm">/* Interrupt status register (read) */</span>
<span class="cp">#define REG_INST		(5)</span>
<span class="cp">#define INST_SELWOATN		(1 &lt;&lt; 0)			</span><span class="cm">/* Select w/o ATN	*/</span><span class="cp"></span>
<span class="cp">#define INST_SELATN		(1 &lt;&lt; 1)			</span><span class="cm">/* Select w/ATN		*/</span><span class="cp"></span>
<span class="cp">#define INST_RESELECTED		(1 &lt;&lt; 2)			</span><span class="cm">/* Reselected		*/</span><span class="cp"></span>
<span class="cp">#define INST_FUNCDONE		(1 &lt;&lt; 3)			</span><span class="cm">/* Function done	*/</span><span class="cp"></span>
<span class="cp">#define INST_BUSSERVICE		(1 &lt;&lt; 4)			</span><span class="cm">/* Bus service		*/</span><span class="cp"></span>
<span class="cp">#define INST_DISCONNECT		(1 &lt;&lt; 5)			</span><span class="cm">/* Disconnect		*/</span><span class="cp"></span>
<span class="cp">#define INST_ILLEGALCMD		(1 &lt;&lt; 6)			</span><span class="cm">/* Illegal command	*/</span><span class="cp"></span>
<span class="cp">#define INST_BUSRESET		(1 &lt;&lt; 7)			</span><span class="cm">/* SCSI Bus reset	*/</span><span class="cp"></span>

<span class="cm">/* Timeout register (write) */</span>
<span class="cp">#define REG_STIM		(5)</span>

<span class="cm">/* Sequence step register (read) */</span>
<span class="cp">#define REG_IS			(6)</span>
<span class="cp">#define IS_BITS			0x07</span>
<span class="cp">#define IS_SELARB		0x00				</span><span class="cm">/* Select &amp; Arb ok	*/</span><span class="cp"></span>
<span class="cp">#define IS_MSGBYTESENT		0x01				</span><span class="cm">/* One byte message sent*/</span><span class="cp"></span>
<span class="cp">#define IS_NOTCOMMAND		0x02				</span><span class="cm">/* Not in command state	*/</span><span class="cp"></span>
<span class="cp">#define IS_EARLYPHASE		0x03				</span><span class="cm">/* Early phase change	*/</span><span class="cp"></span>
<span class="cp">#define IS_COMPLETE		0x04				</span><span class="cm">/* Command ok		*/</span><span class="cp"></span>
<span class="cp">#define IS_SOF			0x08				</span><span class="cm">/* Sync off flag	*/</span><span class="cp"></span>

<span class="cm">/* Transfer period step (write) */</span>
<span class="cp">#define REG_STP			(6)</span>

<span class="cm">/* Synchronous Offset (write) */</span>
<span class="cp">#define REG_SOF			(7)</span>

<span class="cm">/* Fifo state register (read) */</span>
<span class="cp">#define REG_CFIS		(7)</span>
<span class="cp">#define CFIS_CF			0x1f				</span><span class="cm">/* Num bytes in FIFO	*/</span><span class="cp"></span>
<span class="cp">#define CFIS_IS			0xe0				</span><span class="cm">/* Step			*/</span><span class="cp"></span>

<span class="cm">/* config register 1 */</span>
<span class="cp">#define REG_CNTL1		(8)</span>
<span class="cp">#define CNTL1_CID		(7 &lt;&lt; 0)			</span><span class="cm">/* Chip ID			*/</span><span class="cp"></span>
<span class="cp">#define CNTL1_STE		(1 &lt;&lt; 3)			</span><span class="cm">/* Self test enable		*/</span><span class="cp"></span>
<span class="cp">#define CNTL1_PERE		(1 &lt;&lt; 4)			</span><span class="cm">/* Parity enable reporting en.	*/</span><span class="cp"></span>
<span class="cp">#define CNTL1_PTE		(1 &lt;&lt; 5)			</span><span class="cm">/* Parity test enable		*/</span><span class="cp"></span>
<span class="cp">#define CNTL1_DISR		(1 &lt;&lt; 6)			</span><span class="cm">/* Disable Irq on SCSI reset	*/</span><span class="cp"></span>
<span class="cp">#define CNTL1_ETM		(1 &lt;&lt; 7)			</span><span class="cm">/* Extended Timing Mode		*/</span><span class="cp"></span>

<span class="cm">/* Clock conversion factor (read) */</span>
<span class="cp">#define REG_CLKF		(9)</span>
<span class="cp">#define CLKF_F37MHZ		0x00				</span><span class="cm">/* 35.01 - 40 MHz		*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F10MHZ		0x02				</span><span class="cm">/* 10 MHz			*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F12MHZ		0x03				</span><span class="cm">/* 10.01 - 15 MHz		*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F17MHZ		0x04				</span><span class="cm">/* 15.01 - 20 MHz		*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F22MHZ		0x05				</span><span class="cm">/* 20.01 - 25 MHz		*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F27MHZ		0x06				</span><span class="cm">/* 25.01 - 30 MHz		*/</span><span class="cp"></span>
<span class="cp">#define CLKF_F32MHZ		0x07				</span><span class="cm">/* 30.01 - 35 MHz		*/</span><span class="cp"></span>

<span class="cm">/* Chip test register (write) */</span>
<span class="cp">#define REG_FTM			(10)</span>
<span class="cp">#define TEST_FTM		0x01				</span><span class="cm">/* Force target mode		*/</span><span class="cp"></span>
<span class="cp">#define TEST_FIM		0x02				</span><span class="cm">/* Force initiator mode		*/</span><span class="cp"></span>
<span class="cp">#define TEST_FHI		0x04				</span><span class="cm">/* Force high impedance mode	*/</span><span class="cp"></span>

<span class="cm">/* Configuration register 2 (read/write) */</span>
<span class="cp">#define REG_CNTL2		(11)</span>
<span class="cp">#define CNTL2_PGDP		(1 &lt;&lt; 0)			</span><span class="cm">/* Pass Th/Generate Data Parity	*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_PGRP		(1 &lt;&lt; 1)			</span><span class="cm">/* Pass Th/Generate Reg Parity	*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_ACDPE		(1 &lt;&lt; 2)			</span><span class="cm">/* Abort on Cmd/Data Parity Err	*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_S2FE		(1 &lt;&lt; 3)			</span><span class="cm">/* SCSI2 Features Enable	*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_TSDR		(1 &lt;&lt; 4)			</span><span class="cm">/* Tristate DREQ		*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_SBO		(1 &lt;&lt; 5)			</span><span class="cm">/* Select Byte Order		*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_ENF		(1 &lt;&lt; 6)			</span><span class="cm">/* Enable features		*/</span><span class="cp"></span>
<span class="cp">#define CNTL2_DAE		(1 &lt;&lt; 7)			</span><span class="cm">/* Data Alignment Enable	*/</span><span class="cp"></span>

<span class="cm">/* Configuration register 3 (read/write) */</span>
<span class="cp">#define REG_CNTL3		(12)</span>
<span class="cp">#define CNTL3_BS8		(1 &lt;&lt; 0)			</span><span class="cm">/* Burst size 8			*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_MDM		(1 &lt;&lt; 1)			</span><span class="cm">/* Modify DMA mode		*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_LBTM		(1 &lt;&lt; 2)			</span><span class="cm">/* Last Byte Transfer mode	*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_FASTCLK		(1 &lt;&lt; 3)			</span><span class="cm">/* Fast SCSI clocking		*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_FASTSCSI		(1 &lt;&lt; 4)			</span><span class="cm">/* Fast SCSI			*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_G2CB		(1 &lt;&lt; 5)			</span><span class="cm">/* Group2 SCSI support		*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_QTAG		(1 &lt;&lt; 6)			</span><span class="cm">/* Enable 3 byte msgs		*/</span><span class="cp"></span>
<span class="cp">#define CNTL3_ADIDCHK		(1 &lt;&lt; 7)			</span><span class="cm">/* Additional ID check		*/</span><span class="cp"></span>

<span class="cm">/* High transfer count (read/write) */</span>
<span class="cp">#define REG_CTCH		(14)</span>
<span class="cp">#define REG_STCH		(14)</span>

<span class="cm">/* ID register (read only) */</span>
<span class="cp">#define REG_ID			(14)</span>

<span class="cm">/* Data alignment */</span>
<span class="cp">#define REG_DAL			(15)</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">PHASE_IDLE</span><span class="p">,</span>					<span class="cm">/* we&#39;re not planning on doing anything	*/</span>
	<span class="n">PHASE_SELECTION</span><span class="p">,</span>				<span class="cm">/* selecting a device			*/</span>
	<span class="n">PHASE_SELSTEPS</span><span class="p">,</span>					<span class="cm">/* selection with command steps		*/</span>
	<span class="n">PHASE_COMMAND</span><span class="p">,</span>					<span class="cm">/* command sent				*/</span>
	<span class="n">PHASE_MESSAGESENT</span><span class="p">,</span>				<span class="cm">/* selected, and we&#39;re sending cmd	*/</span>
	<span class="n">PHASE_DATAOUT</span><span class="p">,</span>					<span class="cm">/* data out to device			*/</span>
	<span class="n">PHASE_DATAIN</span><span class="p">,</span>					<span class="cm">/* data in from device			*/</span>
	<span class="n">PHASE_MSGIN</span><span class="p">,</span>					<span class="cm">/* message in from device		*/</span>
	<span class="n">PHASE_MSGIN_DISCONNECT</span><span class="p">,</span>				<span class="cm">/* disconnecting from bus		*/</span>
	<span class="n">PHASE_MSGOUT</span><span class="p">,</span>					<span class="cm">/* after message out phase		*/</span>
	<span class="n">PHASE_MSGOUT_EXPECT</span><span class="p">,</span>				<span class="cm">/* expecting message out		*/</span>
	<span class="n">PHASE_STATUS</span><span class="p">,</span>					<span class="cm">/* status from device			*/</span>
	<span class="n">PHASE_DONE</span>					<span class="cm">/* Command complete			*/</span>
<span class="p">}</span> <span class="n">phase_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">DMA_OUT</span><span class="p">,</span>					<span class="cm">/* DMA from memory to chip		*/</span>
	<span class="n">DMA_IN</span>						<span class="cm">/* DMA from chip to memory		*/</span>
<span class="p">}</span> <span class="n">fasdmadir_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">fasdma_none</span><span class="p">,</span>					<span class="cm">/* No dma				*/</span>
	<span class="n">fasdma_pio</span><span class="p">,</span>					<span class="cm">/* PIO mode				*/</span>
	<span class="n">fasdma_pseudo</span><span class="p">,</span>					<span class="cm">/* Pseudo DMA				*/</span>
	<span class="n">fasdma_real_block</span><span class="p">,</span>				<span class="cm">/* Real DMA, on block by block basis	*/</span>
	<span class="n">fasdma_real_all</span>					<span class="cm">/* Real DMA, on request by request	*/</span>
<span class="p">}</span> <span class="n">fasdmatype_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">neg_wait</span><span class="p">,</span>					<span class="cm">/* Negotiate with device		*/</span>
	<span class="n">neg_inprogress</span><span class="p">,</span>					<span class="cm">/* Negotiation sent			*/</span>
	<span class="n">neg_complete</span><span class="p">,</span>					<span class="cm">/* Negotiation complete			*/</span>
	<span class="n">neg_targcomplete</span><span class="p">,</span>				<span class="cm">/* Target completed negotiation		*/</span>
	<span class="n">neg_invalid</span>					<span class="cm">/* Negotiation not supported		*/</span>
<span class="p">}</span> <span class="n">neg_t</span><span class="p">;</span>

<span class="cp">#define MAGIC	0x441296bdUL</span>
<span class="cp">#define NR_MSGS	8</span>

<span class="cp">#define FASCAP_DMA		(1 &lt;&lt; 0)</span>
<span class="cp">#define FASCAP_PSEUDODMA	(1 &lt;&lt; 1)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">magic_start</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">host_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span><span class="p">;</span>			<span class="cm">/* host					*/</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">SCpnt</span><span class="p">;</span>			<span class="cm">/* currently processing command		*/</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">origSCpnt</span><span class="p">;</span>		<span class="cm">/* original connecting command		*/</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">reqSCpnt</span><span class="p">;</span>		<span class="cm">/* request sense command		*/</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">rstSCpnt</span><span class="p">;</span>		<span class="cm">/* reset command			*/</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">pending_SCpnt</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* per-device pending commands		*/</span>
	<span class="kt">int</span>			<span class="n">next_pending</span><span class="p">;</span>		<span class="cm">/* next pending device			*/</span>

	<span class="cm">/*</span>
<span class="cm">	 * Error recovery</span>
<span class="cm">	 */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">eh_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">eh_timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rst_dev_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rst_bus_status</span><span class="p">;</span>

	<span class="cm">/* driver information */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">phase_t</span>		<span class="n">phase</span><span class="p">;</span>			<span class="cm">/* current phase			*/</span>
		<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">io_base</span><span class="p">;</span>		<span class="cm">/* iomem base of FAS216			*/</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">io_shift</span><span class="p">;</span>		<span class="cm">/* shift to adjust reg offsets by	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">cfg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>			<span class="cm">/* configuration registers		*/</span>
		<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">type</span><span class="p">;</span>			<span class="cm">/* chip type				*/</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">;</span>			<span class="cm">/* interrupt				*/</span>
		<span class="kt">int</span>		<span class="n">dma</span><span class="p">;</span>			<span class="cm">/* dma channel				*/</span>

		<span class="k">struct</span> <span class="n">scsi_pointer</span>	<span class="n">SCp</span><span class="p">;</span>			<span class="cm">/* current commands data pointer	*/</span>

		<span class="n">MsgQueue_t</span>	<span class="n">msgs</span><span class="p">;</span>			<span class="cm">/* message queue for connected device	*/</span>

		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">async_stp</span><span class="p">;</span>		<span class="cm">/* Async transfer STP value		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">msgin_fifo</span><span class="p">;</span>		<span class="cm">/* bytes in fifo at time of message in	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">message</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>		<span class="cm">/* last message received from device	*/</span>

		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">disconnectable</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* this command can be disconnected	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">aborting</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* aborting command			*/</span>
	<span class="p">}</span> <span class="n">scsi</span><span class="p">;</span>

	<span class="cm">/* statistics information */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">queues</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">removes</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">fins</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">reads</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">writes</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">miscs</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">disconnects</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">aborts</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">bus_resets</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">host_resets</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">stats</span><span class="p">;</span>

	<span class="cm">/* configuration information */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">clockrate</span><span class="p">;</span>		<span class="cm">/* clock rate of FAS device (MHz)	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">select_timeout</span><span class="p">;</span>		<span class="cm">/* timeout (R5)				*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">sync_max_depth</span><span class="p">;</span>		<span class="cm">/* Synchronous xfer max fifo depth	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">wide_max_size</span><span class="p">;</span>		<span class="cm">/* Maximum wide transfer size		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">cntl3</span><span class="p">;</span>			<span class="cm">/* Control Reg 3			*/</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">asyncperiod</span><span class="p">;</span>		<span class="cm">/* Async transfer period (ns)		*/</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">capabilities</span><span class="p">;</span>		<span class="cm">/* driver capabilities			*/</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">disconnect_ok</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Disconnects allowed?			*/</span>
	<span class="p">}</span> <span class="n">ifcfg</span><span class="p">;</span>

	<span class="cm">/* queue handling */</span>
	<span class="k">struct</span> <span class="p">{</span>
	    	<span class="n">Queue_t</span>		<span class="n">issue</span><span class="p">;</span>			<span class="cm">/* issue queue				*/</span>
    		<span class="n">Queue_t</span>		<span class="n">disconnected</span><span class="p">;</span>		<span class="cm">/* disconnected command queue		*/</span>
	<span class="p">}</span> <span class="n">queues</span><span class="p">;</span>

	<span class="cm">/* per-device info */</span>
	<span class="k">struct</span> <span class="n">fas216_device</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">disconnect_ok</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* device can disconnect		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">parity_enabled</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* parity checking enabled		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">parity_check</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* need to check parity checking	*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">period</span><span class="p">;</span>			<span class="cm">/* sync xfer period in (*4ns)		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">stp</span><span class="p">;</span>			<span class="cm">/* synchronous transfer period		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">sof</span><span class="p">;</span>			<span class="cm">/* synchronous offset register		*/</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">wide_xfer</span><span class="p">;</span>		<span class="cm">/* currently negociated wide transfer	*/</span>
		<span class="n">neg_t</span>		<span class="n">sync_state</span><span class="p">;</span>		<span class="cm">/* synchronous transfer mode		*/</span>
		<span class="n">neg_t</span>		<span class="n">wide_state</span><span class="p">;</span>		<span class="cm">/* wide transfer mode			*/</span>
	<span class="p">}</span> <span class="n">device</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">busyluns</span><span class="p">[</span><span class="mi">64</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span><span class="cm">/* array of bits indicating LUNs busy	*/</span>

	<span class="cm">/* dma */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">fasdmatype_t</span>	<span class="n">transfer_type</span><span class="p">;</span>		<span class="cm">/* current type of DMA transfer		*/</span>
		<span class="n">fasdmatype_t</span>	<span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_pointer</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="n">fasdmadir_t</span> <span class="n">direction</span><span class="p">,</span> <span class="n">fasdmatype_t</span> <span class="n">min_dma</span><span class="p">);</span>
		<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">pseudo</span><span class="p">)(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_pointer</span> <span class="o">*</span><span class="n">SCp</span><span class="p">,</span> <span class="n">fasdmadir_t</span> <span class="n">direction</span><span class="p">,</span> <span class="kt">int</span> <span class="n">transfer</span><span class="p">);</span>
		<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">stop</span><span class="p">)</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_pointer</span> <span class="o">*</span><span class="n">SCp</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* miscellaneous */</span>
	<span class="kt">int</span>			<span class="n">internal_done</span><span class="p">;</span>		<span class="cm">/* flag to indicate request done */</span>
	<span class="k">struct</span> <span class="n">scsi_eh_save</span>	<span class="n">ses</span><span class="p">;</span>		<span class="cm">/* holds request sense restore info */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">magic_end</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FAS216_Info</span><span class="p">;</span>

<span class="cm">/* Function: int fas216_init (struct Scsi_Host *instance)</span>
<span class="cm"> * Purpose : initialise FAS/NCR/AMD SCSI structures.</span>
<span class="cm"> * Params  : instance - a driver-specific filled-out structure</span>
<span class="cm"> * Returns : 0 on success</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_add (struct Scsi_Host *instance, struct device *dev)</span>
<span class="cm"> * Purpose : initialise FAS/NCR/AMD SCSI ic.</span>
<span class="cm"> * Params  : instance - a driver-specific filled-out structure</span>
<span class="cm"> * Returns : 0 on success</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_add</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_queue_command(struct Scsi_Host *h, struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : queue a command for adapter to process.</span>
<span class="cm"> * Params  : h - host adapter</span>
<span class="cm"> *	   : SCpnt - Command to queue</span>
<span class="cm"> * Returns : 0 - success, else error</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_queue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_noqueue_command(struct Scsi_Host *h, struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : queue a command for adapter to process, and process it to completion.</span>
<span class="cm"> * Params  : h - host adapter</span>
<span class="cm"> *	   : SCpnt - Command to queue</span>
<span class="cm"> * Returns : 0 - success, else error</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_noqueue_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Function: irqreturn_t fas216_intr (FAS216_Info *info)</span>
<span class="cm"> * Purpose : handle interrupts from the interface to progress a command</span>
<span class="cm"> * Params  : info - interface to service</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="n">irqreturn_t</span> <span class="n">fas216_intr</span> <span class="p">(</span><span class="n">FAS216_Info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">fas216_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="cm">/* Function: void fas216_release (struct Scsi_Host *instance)</span>
<span class="cm"> * Purpose : release all resources and put everything to bed for FAS/NCR/AMD SCSI ic.</span>
<span class="cm"> * Params  : instance - a driver-specific filled-out structure</span>
<span class="cm"> * Returns : 0 on success</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">fas216_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">instance</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_print_host</span><span class="p">(</span><span class="n">FAS216_Info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_print_stats</span><span class="p">(</span><span class="n">FAS216_Info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_print_devices</span><span class="p">(</span><span class="n">FAS216_Info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_eh_abort(struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : abort this command</span>
<span class="cm"> * Params  : SCpnt - command to abort</span>
<span class="cm"> * Returns : FAILED if unable to abort</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_eh_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_eh_device_reset(struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : Reset the device associated with this command</span>
<span class="cm"> * Params  : SCpnt - command specifing device to reset</span>
<span class="cm"> * Returns : FAILED if unable to reset</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_eh_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_eh_bus_reset(struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : Reset the complete bus associated with this command</span>
<span class="cm"> * Params  : SCpnt - command specifing bus to reset</span>
<span class="cm"> * Returns : FAILED if unable to reset</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_eh_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cm">/* Function: int fas216_eh_host_reset(struct scsi_cmnd *SCpnt)</span>
<span class="cm"> * Purpose : Reset the host associated with this command</span>
<span class="cm"> * Params  : SCpnt - command specifing host to reset</span>
<span class="cm"> * Returns : FAILED if unable to reset</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">fas216_eh_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* FAS216_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
